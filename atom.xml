<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>rex note</title>
  <subtitle>é›¨è¿‡ï¼Œäº‘è¿‡</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://bestlixiang.site/"/>
  <updated>2019-06-08T07:38:45.257Z</updated>
  <id>http://bestlixiang.site/</id>
  
  <author>
    <name>rex</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>RocketMQæºç åˆ†æâ€”â€”ç¯å¢ƒæ­å»º</title>
    <link href="http://bestlixiang.site/2019/06/08/RocketMQ%E6%BA%90%E7%A0%81/RocketMQ%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E2%80%94%E2%80%94%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"/>
    <id>http://bestlixiang.site/2019/06/08/RocketMQæºç /RocketMQæºç åˆ†æâ€”â€”ç¯å¢ƒæ­å»º/</id>
    <published>2019-06-08T07:32:37.000Z</published>
    <updated>2019-06-08T07:38:45.257Z</updated>
    
    <content type="html"><![CDATA[<p>å¼•ï¼šç»ˆäºè¦å¼€å§‹äº†å—ï¼Œä¸€ç›´æƒ³å¥½å¥½å¼„æ¸…æ¥šä¸€æ¬¾MQï¼Œä½œä¸ºä¸€åJavaerï¼Œè‚¯å®šé€‰æ‹©RocketMQï¼Œå¸Œæœ›ä»Šå¤©æ˜¯ä¸€ä¸ªå¥½å¼€å§‹ï¼<a id="more"></a></p>
<h1 id="å‰ç½®"><a href="#å‰ç½®" class="headerlink" title="å‰ç½®"></a>å‰ç½®</h1><p>åœ¨çœ‹æºç å‰å¤§å®¶éƒ½è‡³å°‘åº”è¯¥ä½¿ç”¨è¿‡RocketMQï¼Œå¹¶ä¸”äº†è§£å®ƒçš„ç›¸å…³åŸç†ï¼Œæ‰€ä»¥è¿™é‡Œä¸¢å‡ºä¸¤ä¸ªé“¾æ¥ï¼Œè™½ç„¶æœ‰ç‚¹è€~</p>
<ol>
<li><a href="[http://gd-rus-public.cn-hangzhou.oss-pub.aliyun-inc.com/attachment/201604/08/20160408164726/RocketMQ_userguide.pdf](http://gd-rus-public.cn-hangzhou.oss-pub.aliyun-inc.com/attachment/201604/08/20160408164726/RocketMQ_userguide.pdf">RocketMQ ç”¨æˆ·æŒ‡å—</a></li>
<li><a href="[http://gd-rus-public.cn-hangzhou.oss-pub.aliyun-inc.com/attachment/201604/08/20160408165024/RocketMQ_design.pdf](http://gd-rus-public.cn-hangzhou.oss-pub.aliyun-inc.com/attachment/201604/08/20160408165024/RocketMQ_design.pdf">RocketMQ åŸç†ç®€ä»‹</a></li>
</ol>
<h1 id="ä¾èµ–å·¥å…·"><a href="#ä¾èµ–å·¥å…·" class="headerlink" title="ä¾èµ–å·¥å…·"></a>ä¾èµ–å·¥å…·</h1><ol>
<li>Git</li>
<li>Maven</li>
<li>JDK1.8</li>
<li>IntelliJ IDEA</li>
</ol>
<h1 id="æºç æ‹‰å–"><a href="#æºç æ‹‰å–" class="headerlink" title="æºç æ‹‰å–"></a>æºç æ‹‰å–</h1><p>ä»å®˜æ–¹ä»“åº“ <a href="https://github.com/apache/rocketmq" target="_blank" rel="noopener">https://github.com/apache/rocketmq</a> é€šè¿‡Gitæ‹‰å–ä»£ç åˆ°æœ¬åœ°ï¼Œåœ¨2019.6.8çœ‹åˆ°æœ€æ–°çš„releaseç‰ˆæœ¬æ˜¯4.5.1ï¼Œä½†æ˜¯ä¸ºäº†å’ŒèŠ‹è‰¿å¤§ä½¬ä¿æŒä¸€è‡´ï¼Œæˆ‘ä¹Ÿé€‰æ‹©äº†4.4.0ç‰ˆæœ¬ï¼Œæ‰€ä»¥å°†ä»£ç æ‹‰å–åˆ°æœ¬åœ°ä¹‹åï¼Œæˆ‘ä»¬åˆ‡æ¢åˆ°4.4.0åˆ†æ”¯ã€‚</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/apache/rocketmq.git</span><br><span class="line">git checkout -b release-4.4.0 origin/release-4.4.0</span><br></pre></td></tr></table></figure>
<p>ç„¶åæˆ‘ä»¬å°±å¯ä»¥çœ‹æ˜¯æ­å»ºè°ƒè¯•ç¯å¢ƒå•¦~</p>
<h1 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h1><h2 id="å¯åŠ¨-RocketMQ-Namesrv"><a href="#å¯åŠ¨-RocketMQ-Namesrv" class="headerlink" title="å¯åŠ¨ RocketMQ Namesrv"></a>å¯åŠ¨ RocketMQ Namesrv</h2><p>æ‰“å¼€ <code>org.apache.rocketmq.namesrv.NameServerInstanceTest</code> å•å…ƒæµ‹è¯•ç±»ï¼Œå‚è€ƒ <code>#startup()</code> æ–¹æ³•ï¼Œæˆ‘ä»¬ç¼–å†™ <code>#main(String[] args)</code> é™æ€æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    NamesrvConfig namesrvConfig1 = <span class="keyword">new</span> NamesrvConfig();</span><br><span class="line">    NettyServerConfig nettyServerConfig1 = <span class="keyword">new</span> NettyServerConfig();</span><br><span class="line">    nettyServerConfig1.setListenPort(<span class="number">9876</span>);</span><br><span class="line">    NamesrvController nameSrvController1 = <span class="keyword">new</span> NamesrvController(namesrvConfig1, nettyServerConfig1);</span><br><span class="line">    nameSrvController1.initialize();</span><br><span class="line">    nameSrvController1.start();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸è®©ä¸»æ–¹æ³•ç»“æŸ</span></span><br><span class="line">    Thread.sleep(DateUtils.MILLIS_PER_DAY);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œä¹‹åï¼Œè¾“å‡ºå¦‚ä¸‹æ—¥å¿—å°±ä»£è¡¨OKå•¦~</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">14:41:41.202 [NettyEventExecutor] INFO  RocketmqRemoting - NettyEventExecutor service started</span><br><span class="line">14:41:41.203 [FileWatchService] INFO  RocketmqCommon - FileWatchService service started</span><br></pre></td></tr></table></figure>
<h2 id="å¯åŠ¨-RocketMQ-Broker"><a href="#å¯åŠ¨-RocketMQ-Broker" class="headerlink" title="å¯åŠ¨ RocketMQ Broker"></a>å¯åŠ¨ RocketMQ Broker</h2><p>æ‰“å¼€ <code>org.apache.rocketmq.broker.BrokerControllerTest</code> å•å…ƒæµ‹è¯•ç±»ï¼Œå‚è€ƒ <code>#testBrokerRestart()</code> æ–¹æ³•ï¼Œæˆ‘ä»¬ç¼–å†™ <code>#main(String[] args)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      <span class="comment">// è®¾ç½®ç‰ˆæœ¬å·ï¼Œå¾ˆå…³é”®ï¼Œä¸ç„¶topicåˆ›å»ºä¸æˆåŠŸ</span></span><br><span class="line">      System.setProperty(RemotingCommand.REMOTING_VERSION_KEY, Integer.toString(MQVersion.CURRENT_VERSION));</span><br><span class="line">      <span class="keyword">final</span> BrokerConfig brokerConfig = <span class="keyword">new</span> BrokerConfig();</span><br><span class="line">      brokerConfig.setBrokerName(<span class="string">"broker-a"</span>);</span><br><span class="line">      brokerConfig.setNamesrvAddr(<span class="string">"127.0.0.1:9876"</span>);</span><br><span class="line"></span><br><span class="line">      BrokerController brokerController = <span class="keyword">new</span> BrokerController(</span><br><span class="line">              brokerConfig,</span><br><span class="line">              <span class="keyword">new</span> NettyServerConfig(),</span><br><span class="line">              <span class="keyword">new</span> NettyClientConfig(),</span><br><span class="line">              <span class="keyword">new</span> MessageStoreConfig());</span><br><span class="line">      assertThat(brokerController.initialize());</span><br><span class="line">      brokerController.start();</span><br><span class="line">      <span class="comment">// ä¸è®©ä¸»æ–¹æ³•ç»“æŸ</span></span><br><span class="line">      Thread.sleep(DateUtils.MILLIS_PER_DAY);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œä¹‹åï¼Œè™½ç„¶åœ¨brokerä¸‹é¢ä»€ä¹ˆæ—¥å¿—éƒ½æ²¡æœ‰ï¼Œä½†æ˜¯åœ¨Namesrvå·²ç»çœ‹åˆ°äº†brokerçš„æ³¨å†Œæ—¥å¿—ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">15:19:21.437 [NettyServerCodecThread_4] INFO  RocketmqRemoting - NETTY SERVER PIPELINE: channelRegistered 127.0.0.1:58887</span><br><span class="line">15:19:21.437 [NettyServerCodecThread_4] INFO  RocketmqRemoting - NETTY SERVER PIPELINE: channelActive, the channel[127.0.0.1:58887]</span><br><span class="line">15:19:21.460 [RemotingExecutorThread_7] DEBUG RocketmqNamesrv - receive request, 103 127.0.0.1:58887 RemotingCommand [code=103, language=JAVA, version=293, opaque=0, flag(B)=0, remark=null, extFields=&#123;brokerId=0, bodyCrc32=2135245619, clusterName=DefaultCluster, brokerAddr=192.168.1.28:8888, haServerAddr=192.168.1.28:10912, compressed=<span class="literal">false</span>, brokerName=broker<span class="_">-a</span>&#125;, serializeTypeCurrentRPC=JSON]</span><br><span class="line">15:19:21.461 [RemotingExecutorThread_7] INFO  RocketmqNamesrv - new topic registered, RMQ_SYS_TRANS_HALF_TOPIC QueueData [brokerName=broker<span class="_">-a</span>, <span class="built_in">read</span>QueueNums=1, writeQueueNums=1, perm=6, topicSynFlag=0]</span><br><span class="line">15:19:21.461 [RemotingExecutorThread_7] INFO  RocketmqNamesrv - new broker registered, 192.168.1.28:8888 HAServer: 192.168.1.28:10912</span><br></pre></td></tr></table></figure>
<h2 id="å¯åŠ¨-RocketMQ-Producer"><a href="#å¯åŠ¨-RocketMQ-Producer" class="headerlink" title="å¯åŠ¨ RocketMQ Producer"></a>å¯åŠ¨ RocketMQ Producer</h2><p>æ‰“å¼€ <code>org.apache.rocketmq.example.quickstart.Producer</code> ç¤ºä¾‹ç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> MQClientException, InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Instantiate with a producer group name.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        DefaultMQProducer producer = <span class="keyword">new</span> DefaultMQProducer(<span class="string">"please_rename_unique_group_name"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Specify name server addresses.</span></span><br><span class="line"><span class="comment">         * &lt;p/&gt;</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Alternatively, you may specify name server addresses via exporting environmental variable: NAMESRV_ADDR</span></span><br><span class="line"><span class="comment">         * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">         * &#123;@code</span></span><br><span class="line"><span class="comment">         * producer.setNamesrvAddr("name-server1-ip:9876;name-server2-ip:9876");</span></span><br><span class="line"><span class="comment">         * &#125;</span></span><br><span class="line"><span class="comment">         * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Launch the instance.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// æŒ‡æ˜Namesrv</span></span><br><span class="line">        producer.setNamesrvAddr(<span class="string">"127.0.0.1:9876"</span>);</span><br><span class="line">        producer.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * Create a message instance, specifying topic, tag and message body.</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                Message msg = <span class="keyword">new</span> Message(<span class="string">"TopicTest"</span> <span class="comment">/* Topic */</span>,</span><br><span class="line">                    <span class="string">"TagA"</span> <span class="comment">/* Tag */</span>,</span><br><span class="line">                    (<span class="string">"Hello RocketMQ "</span> + i).getBytes(RemotingHelper.DEFAULT_CHARSET) <span class="comment">/* Message body */</span></span><br><span class="line">                );</span><br><span class="line"></span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * Call send message to deliver message to one of brokers.</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                SendResult sendResult = producer.send(msg);</span><br><span class="line"></span><br><span class="line">                System.out.printf(<span class="string">"%s%n"</span>, sendResult);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Shut down once the producer instance is not longer in use.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        producer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ ¹æ®æ³¨é‡Šï¼Œæˆ‘ä»¬éœ€è¦æŒ‡æ˜Namesrvåœ°å€:<code>producer.setNamesrvAddr(&quot;127.0.0.1:9876&quot;);</code></p>
<p>è¿è¡Œä¹‹åå°±ä¼šå‘é€1000æ¡æ¶ˆæ¯å•¦ï¼Œç„¶åå°±ä¼šæ–­å¼€ä¸Namesrvï¼Œbrokerçš„è¿æ¥ï¼Œæ—¥å¿—å¦‚ä¸‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SendResult [sendStatus=SEND_OK, msgId=C0A8011C69E618B4AAC22757459803E7, offsetMsgId=C0A8011C000022B80000000000057CB0, messageQueue=MessageQueue [topic=TopicTest, brokerName=broker<span class="_">-a</span>, queueId=0], queueOffset=499]</span><br><span class="line">15:20:30.889 [NettyClientSelector_1] INFO  RocketmqRemoting - closeChannel: close the connection to remote address[192.168.1.28:8888] result: <span class="literal">true</span></span><br><span class="line">15:20:30.890 [NettyClientSelector_1] INFO  RocketmqRemoting - closeChannel: close the connection to remote address[192.168.1.28:8886] result: <span class="literal">true</span></span><br><span class="line">15:20:30.891 [NettyClientSelector_1] INFO  RocketmqRemoting - closeChannel: close the connection to remote address[127.0.0.1:9876] result: <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h2 id="å¯åŠ¨-RocketMQ-Producer-1"><a href="#å¯åŠ¨-RocketMQ-Producer-1" class="headerlink" title="å¯åŠ¨ RocketMQ Producer"></a>å¯åŠ¨ RocketMQ Producer</h2><p>æ‰“å¼€ <code>org.apache.rocketmq.example.quickstart.Consumer</code> ç¤ºä¾‹ç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Consumer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException, MQClientException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Instantiate with specified consumer group name.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        DefaultMQPushConsumer consumer = <span class="keyword">new</span> DefaultMQPushConsumer(<span class="string">"please_rename_unique_group_name_4"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Specify name server addresses.</span></span><br><span class="line"><span class="comment">         * &lt;p/&gt;</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Alternatively, you may specify name server addresses via exporting environmental variable: NAMESRV_ADDR</span></span><br><span class="line"><span class="comment">         * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">         * &#123;@code</span></span><br><span class="line"><span class="comment">         * consumer.setNamesrvAddr("name-server1-ip:9876;name-server2-ip:9876");</span></span><br><span class="line"><span class="comment">         * &#125;</span></span><br><span class="line"><span class="comment">         * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">// æŒ‡æ˜Namesrv</span></span><br><span class="line">        consumer.setNamesrvAddr(<span class="string">"127.0.0.1:9876"</span>);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Specify where to start in case the specified consumer group is a brand new one.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        consumer.setConsumeFromWhere(ConsumeFromWhere.CONSUME_FROM_FIRST_OFFSET);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Subscribe one more more topics to consume.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        consumer.subscribe(<span class="string">"TopicTest"</span>, <span class="string">"*"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         *  Register callback to execute on arrival of messages fetched from brokers.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        consumer.registerMessageListener(<span class="keyword">new</span> MessageListenerConcurrently() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> ConsumeConcurrentlyStatus <span class="title">consumeMessage</span><span class="params">(List&lt;MessageExt&gt; msgs,</span></span></span><br><span class="line"><span class="function"><span class="params">                ConsumeConcurrentlyContext context)</span> </span>&#123;</span><br><span class="line">                System.out.printf(<span class="string">"%s Receive New Messages: %s %n"</span>, Thread.currentThread().getName(), msgs);</span><br><span class="line">                <span class="keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         *  Launch the consumer instance.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        consumer.start();</span><br><span class="line"></span><br><span class="line">        System.out.printf(<span class="string">"Consumer Started.%n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ ¹æ®æ³¨é‡Šï¼Œæˆ‘ä»¬è¿™é‡Œä¹Ÿéœ€è¦æŒ‡æ˜Namesrvåœ°å€:<code>consumer.setNamesrvAddr(&quot;127.0.0.1:9876&quot;);</code></p>
<p>ç–¯ç‹‚æ¶ˆè´¹çš„æ—¥å¿—å¦‚ä¸‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Consumer Started.</span><br><span class="line">ConsumeMessageThread_3 Receive New Messages: [MessageExt [queueId=1, storeSize=178, queueOffset=250, sysFlag=0, bornTimestamp=1559978428786, bornHost=/192.168.1.28:58898, storeTimestamp=1559978428830, storeHost=/192.168.1.28:8888, msgId=C0A8011C000022B8000000000002BEB2, commitLogOffset=179890, bodyCRC=613185359, reconsumeTimes=0, preparedTransactionOffset=0, toString()=Message&#123;topic=<span class="string">'TopicTest'</span>, flag=0, properties=&#123;MIN_OFFSET=0, MAX_OFFSET=500, CONSUME_START_TIME=1559978752764, UNIQ_KEY=C0A8011C69E618B4AAC227573D700000, WAIT=<span class="literal">true</span>, TAGS=TagA&#125;, body=[72, 101, 108, 108, 111, 32, 82, 111, 99, 107, 101, 116, 77, 81, 32, 48], transactionId=<span class="string">'null'</span>&#125;]] </span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>It`s over !!</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>å¾ˆå–œæ¬¢ä¸‹é¢çš„è¯ï¼š</p>
<p><strong>æºç ï¼Œæ˜¯åŸç†çš„å…·è±¡åŒ–</strong><br><strong>åŸç†ï¼Œæ˜¯ä»£ç çš„æŠ½è±¡åŒ–</strong></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¼•ï¼šç»ˆäºè¦å¼€å§‹äº†å—ï¼Œä¸€ç›´æƒ³å¥½å¥½å¼„æ¸…æ¥šä¸€æ¬¾MQï¼Œä½œä¸ºä¸€åJavaerï¼Œè‚¯å®šé€‰æ‹©RocketMQï¼Œå¸Œæœ›ä»Šå¤©æ˜¯ä¸€ä¸ªå¥½å¼€å§‹ï¼
    
    </summary>
    
      <category term="RocketMQæºç " scheme="http://bestlixiang.site/categories/RocketMQ%E6%BA%90%E7%A0%81/"/>
    
    
      <category term="RocketMQ" scheme="http://bestlixiang.site/tags/RocketMQ/"/>
    
  </entry>
  
  <entry>
    <title>CSAPPè¯»åæ„Ÿ</title>
    <link href="http://bestlixiang.site/2019/05/26/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/CSAPP%E8%AF%BB%E5%90%8E%E6%84%9F/"/>
    <id>http://bestlixiang.site/2019/05/26/è®¡ç®—æœºåŸºç¡€/CSAPPè¯»åæ„Ÿ/</id>
    <published>2019-05-26T13:57:48.000Z</published>
    <updated>2019-05-26T14:31:29.356Z</updated>
    
    <content type="html"><![CDATA[<p>å¼•ï¼šå¯¹äºä¸€ä¸ªéç§‘ç­çš„ç¨‹åºå‘˜ï¼Œè®¡ç®—æœºåŸºç¡€å¯èƒ½æ°¸è¿œéƒ½æ˜¯ä»–çš„æ¢¦é­‡ã€‚æˆ‘ä¹Ÿä¸ä¾‹å¤–ï¼Œè™½ç„¶ä¹‹å‰ä¹Ÿçœ‹è¿‡è®¡ç®—æœºç»„æˆï¼Œæ“ä½œç³»ç»Ÿï¼Œè®¡ç®—æœºç½‘ç»œï¼Œæ•°æ®ç»“æ„ä¸ç®—æ³•ï¼Œä½†æ˜¯å¯èƒ½éƒ½æ˜¯è‡ªå­¦ï¼Œç„¶åæœ‰ç‚¹æµ®äºè¡¨é¢ï¼Œè®©è‡ªå·±çš„å¿ƒé‡Œä¸€ç›´éƒ½ä¸å¤ªè¸å®ã€‚CSAPPæ˜¯è‡ªå·±ä¸€ç›´æƒ³è¯»çš„ä¹¦ï¼Œä½†æ˜¯å¾ˆå¤šæ—¶å€™çœ‹äº†ä¸¤ç« å°±æ”¾å¼ƒäº†ï¼Œè¿™æ¬¡ç®—æ˜¯åšæŒäº†3ä¸ªæ˜ŸæœŸçœ‹å®Œäº†å®ƒï¼Œç„¶åå‘è¡¨æ°´æ–‡ä¸€ç¯‡ï¼è¯æ˜è‡ªå·±æ¥è¿‡ğŸ¤£<a id="more"></a></p>
<h1 id="å†…å®¹ä»‹ç»"><a href="#å†…å®¹ä»‹ç»" class="headerlink" title="å†…å®¹ä»‹ç»"></a>å†…å®¹ä»‹ç»</h1><p>åœ¨ç¨‹åºçš„ä¸–ç•Œï¼Œä¸‡äº‹ç¦»ä¸å¼€HelloWorldï¼Œæœ¬ä¹¦ä¹Ÿè¿˜æ˜¯ä»ä¸€ä¸ªhelloworldå‘æˆ‘ä»¬ä»‹ç»äº†ä¸€ä¸ªhelloworldç¨‹åºæ˜¯æ€ä¹ˆè¿è¡Œçš„ï¼Œä»ç¼–è¯‘åˆ°æ¶‰åŠçš„ç¡¬ä»¶ä»¥åŠæ“ä½œç³»ç»Ÿï¼Œç½‘ç»œé€šä¿¡ï¼Œå…ˆæŠŠå¤§æ¦‚çš„æ¦‚å¿µæ¥äº†ä¸€å¥—ï¼Œç„¶åå°±å¼€å§‹æ­£æ–‡å•¦ï¼ï¼å…ˆä»æ•°æ®çš„è¡¨ç¤ºå¼€å§‹ï¼ˆç‰›é€¼ï¼‰ï¼Œè‡ªç„¶è€Œç„¶å¼•å‡ºç¨‹åºçš„è¡¨ç¤ºï¼ˆé‡ç‚¹åœ¨äºæ±‡ç¼–ï¼‰ï¼Œæ¥ç€è®²è§£äº†å¤„ç†å™¨æ˜¯å¦‚ä½•æ‰§è¡Œæ±‡ç¼–æŒ‡ä»¤çš„ï¼ˆå¤„ç†å™¨æ˜¯æ€ä¹ˆå·¥ä½œçš„ï¼‰ï¼Œè¿™é‡Œåˆæ¶‰åŠåˆ°äº†å­˜å‚¨å™¨ç›¸å…³å†…å®¹ï¼ˆå­˜å‚¨å™¨å±±ï¼‰ï¼›æ¥ç€ä»‹ç»æ§åˆ¶æµï¼ˆæ¶‰åŠåˆ°è¿›ç¨‹ï¼Œä¿¡å·ï¼‰ã€è™šæ‹Ÿå†…å­˜ï¼ˆåŠ¨æ€åˆ†é…ï¼Œåƒåœ¾æœé›†ï¼‰ç­‰é«˜çº§è¯é¢˜ï¼Œè¿™ä¹‹åå¼€å§‹æ¶‰åŠè¯¸å¦‚I/Oã€ç½‘ç»œç¼–ç¨‹ã€å¹¶å‘ç¼–ç¨‹ç­‰çŸ¥è¯†ã€‚æ€»ä¹‹ï¼Œå¹²è´§æ»¡æ»¡ï¼Œä½†æ˜¯éœ€è¦æŒºèŠ±æ—¶é—´çš„ï¼Œå“ï¼Œæ‡’äº†æ‡’äº†ï¼ï¼ï¼</p>
<h1 id="æ•´ä½“æ„Ÿå—"><a href="#æ•´ä½“æ„Ÿå—" class="headerlink" title="æ•´ä½“æ„Ÿå—"></a>æ•´ä½“æ„Ÿå—</h1><p>è¿™æœ¬ä¹¦æ¶‰åŠçš„ç‚¹è¿˜æ˜¯è›®å¤šçš„ï¼Œåƒæ˜¯ä¸€æœ¬è®¡ç®—æœºç»„æˆå’Œæ“ä½œç³»ç»Ÿçš„ç»„åˆä¹¦ç±ï¼Œä½†æ˜¯å¯èƒ½ä¹Ÿæ˜¯å› ä¸ºç»„åˆï¼Œæœ‰äº›ç‚¹å°±è®²å¾—æ²¡æœ‰é‚£ä¹ˆç»†äº†ï¼Œä½†æ˜¯åœ¨ä¹¦é‡Œéƒ½å¯ä»¥ç»™å‡ºç›¸åº”çš„å­¦ä¹ å»ºè®®å’Œå‚è€ƒæ–‡çŒ®ï¼Œæˆ‘è§‰å¾—å¾ˆä¸é”™ã€‚å…¶å®è¿™æœ¬ä¹¦è¿˜é…å¥—äº†ç›¸åº”çš„<a href="http://csapp.cs.cmu.edu/3e/labs.html" target="_blank" rel="noopener">å®éªŒ</a>ï¼Œè¿™ä¸ªå®éªŒè¿˜æ˜¯æœ‰ä¸€å®šéš¾åº¦çš„ï¼Œæ‰€ä»¥è‡ªå·±å°±ä¸äº†äº†ä¹‹äº†ï¼Œå¸Œæœ›ä»¥åæœ‰æœºä¼šå†æ¥æä¸€éï¼Œç›¸ä¿¡æ”¶è·ä¸€å®šæŒºå¤§ã€‚æ€»çš„æ¥è¯´ï¼Œè¿™æœ¬ä¹¦è¿˜æ˜¯ç»™æˆ‘è§£ç­”äº†ä¸€äº›ç–‘æƒ‘å’ŒåŠ æ·±ä¸€äº›å°è±¡ï¼Œå°¤å…¶æ˜¯åœ¨æ“ä½œç³»ç»Ÿæ–¹é¢ã€‚åˆšå¥½å€Ÿç”¨ä¹‹å‰åŒäº‹è¯´çš„ä¸€å¥è¯ï¼š<strong>ä¸åŒçš„æ—¶å€™ï¼Œè¯»ç›¸åŒçš„ä¸œè¥¿ï¼Œä»–çš„æ„Ÿå—å’Œæ”¶è·ä¸€å®šæ˜¯ä¸åŒçš„</strong>ã€‚</p>
<h1 id="ç–‘é—®"><a href="#ç–‘é—®" class="headerlink" title="ç–‘é—®"></a>ç–‘é—®</h1><p>è™½è¯´çœ‹å®Œäº†è¿™æœ¬ä¹¦ï¼Œä½†æ˜¯è‡ªå·±è¿˜æ˜¯æœ‰å¾ˆå¤šåœ°æ–¹æ²¡æœ‰ç†è§£ï¼Œä»¥åä¸€å®šä¼šå†çœ‹ä¸€æ¬¡çš„ã€‚è¿™é‡Œæƒ³ç•™ç»™è‡ªå·±ä¸€ä¸ªé—®é¢˜ï¼Œè®©è‡ªå·±è¶Šæ¥è¶Šè¿·ç³Šçš„é—®é¢˜ï¼ˆå¸Œæœ›æ¸…æ¥šçš„äººä¹Ÿèƒ½å‘Šè¯‰æˆ‘è¿™ä¸ªå°èœé¸¡ï¼Œå“ˆå“ˆï¼‰ï¼š<strong>è®¡ç®—æœºä»æ‰“å¼€ç”µæºåæ˜¯æ€ä¹ˆè¿è¡Œçš„ï¼Ÿï¼ˆä»ç¡¬ä»¶åˆ°è½¯ä»¶ï¼‰</strong></p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol>
<li><a href="https://wdxtub.com/work/" target="_blank" rel="noopener">ä¸å‘¨å±±ä½œå“é›†</a></li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¼•ï¼šå¯¹äºä¸€ä¸ªéç§‘ç­çš„ç¨‹åºå‘˜ï¼Œè®¡ç®—æœºåŸºç¡€å¯èƒ½æ°¸è¿œéƒ½æ˜¯ä»–çš„æ¢¦é­‡ã€‚æˆ‘ä¹Ÿä¸ä¾‹å¤–ï¼Œè™½ç„¶ä¹‹å‰ä¹Ÿçœ‹è¿‡è®¡ç®—æœºç»„æˆï¼Œæ“ä½œç³»ç»Ÿï¼Œè®¡ç®—æœºç½‘ç»œï¼Œæ•°æ®ç»“æ„ä¸ç®—æ³•ï¼Œä½†æ˜¯å¯èƒ½éƒ½æ˜¯è‡ªå­¦ï¼Œç„¶åæœ‰ç‚¹æµ®äºè¡¨é¢ï¼Œè®©è‡ªå·±çš„å¿ƒé‡Œä¸€ç›´éƒ½ä¸å¤ªè¸å®ã€‚CSAPPæ˜¯è‡ªå·±ä¸€ç›´æƒ³è¯»çš„ä¹¦ï¼Œä½†æ˜¯å¾ˆå¤šæ—¶å€™çœ‹äº†ä¸¤ç« å°±æ”¾å¼ƒäº†ï¼Œè¿™æ¬¡ç®—æ˜¯åšæŒäº†3ä¸ªæ˜ŸæœŸçœ‹å®Œäº†å®ƒï¼Œç„¶åå‘è¡¨æ°´æ–‡ä¸€ç¯‡ï¼è¯æ˜è‡ªå·±æ¥è¿‡ğŸ¤£
    
    </summary>
    
      <category term="è®¡ç®—æœºåŸºç¡€" scheme="http://bestlixiang.site/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="è®¡ç®—æœºç»„æˆ" scheme="http://bestlixiang.site/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90/"/>
    
      <category term="æ“ä½œç³»ç»Ÿ" scheme="http://bestlixiang.site/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
  </entry>
  
  <entry>
    <title>JVMæºç â€”â€”åŠé€€å¾…èµ·èˆª</title>
    <link href="http://bestlixiang.site/2019/04/26/JVM%E6%BA%90%E7%A0%81/JVM%E6%BA%90%E7%A0%81%E2%80%94%E2%80%94%E5%8A%9D%E9%80%80%E5%BE%85%E8%B5%B7%E8%88%AA/"/>
    <id>http://bestlixiang.site/2019/04/26/JVMæºç /JVMæºç â€”â€”åŠé€€å¾…èµ·èˆª/</id>
    <published>2019-04-26T12:15:14.000Z</published>
    <updated>2019-04-26T12:25:06.543Z</updated>
    
    <content type="html"><![CDATA[<p>åŸä»¥ä¸ºå¯ä»¥å¹³ç»“è‡ªå·±ç•¥æ‡‚çš„C++å»çœ‹JVMæºç ï¼Œä½†æ˜¯ç­‰åˆ°è‡ªå·±çœŸæ­£å»æ‰“å¼€æºç ï¼Œå°±ç®—æ˜¯å¯¹ç€åšå®¢çœ‹ï¼Œä¹Ÿæ˜¯ååˆ†åƒåŠ›ï¼Œè¿˜çœ‹äº†çŸ¥ä¹Rå¤§å¯¹çœ‹JVMæºç çš„çœ‹æ³•ã€‚SOï¼Œæˆ‘è¢«è‡ªå·±å’ŒRå¤§åŠé€€äº†ï¼Œå¯èƒ½ç›®å‰çš„è‡ªå·±è¿˜ä¸é€‚åˆå»çœ‹ï¼Œå¸Œæœ›è‡ªå·±ä»¥å<strong>æœ‰éœ€è¦æœ‰æ¢¦æƒ³</strong>å†æ¥çœ‹ï¼<a id="more"></a><br><img src="https://upload-images.jianshu.io/upload_images/10354196-a3eeb7ecd08d51cf.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="åŠé€€.jpeg"></p>
<h1 id="åŠé€€"><a href="#åŠé€€" class="headerlink" title="åŠé€€"></a>åŠé€€</h1><p><a href="https://www.zhihu.com/question/20097631" target="_blank" rel="noopener">Rå¤§å…³äº <strong>Java JVMæ€ä¹ˆå­¦ä¹ å•Šï¼Ÿä»å“ªæ–¹é¢å…¥æ‰‹ï¼Ÿ</strong>çš„å›ç­”</a></p>
<p>è¿™å®Œå…¨å–å†³äºé¢˜ä¸»æ˜¯ä¸ºä»€ä¹ˆè¦å­¦ä¹ JVMï¼Œæƒ³å­¦åˆ°å¤šæ·±ã€‚å‰é¢ <a href="//www.zhihu.com/people/05f661615136170935175f54719ff0a0">@æ›¹æ—­ä¸œ</a> å’Œ <a href="//www.zhihu.com/people/7a082a33732215bdd02df94467fe6b1f">@Scott</a> è¯´å¾—å¾ˆå¯¹ã€‚<br>å¦‚æœæ„Ÿè§‰æ‘¸ä¸æ¸…ä¸œå—è¥¿åŒ—çš„è¯è¯·è¯•è¯•ä»æˆ‘åœ¨è±†ç“£ä¸Šå‘çš„è±†å•å¼€å§‹å§ï¼š<a href="https://link.zhihu.com/?target=http%3A//book.douban.com/doulist/2545443/" target="_blank" rel="noopener">ä»è¡¨åˆ°é‡Œå­¦ä¹ JVMå®ç°</a><br>å¦‚æœä¸€ä¸Šæ¥å°±æƒ³é€šè¿‡é˜…è¯»OpenJDKé‡Œçš„HotSpot VMçš„æºç æ¥å…¥æ‰‹å­¦ä¹ JVMï¼Œé‚£ä¹ˆæˆ‘æ¨èå…ˆè¯»è¯»æˆ‘ä¹‹å‰å†™çš„ä¸€ä¸ªæ¼”ç¤ºç¨¿ï¼š<a href="https://link.zhihu.com/?target=http%3A//rednaxelafx.iteye.com/blog/1426530" target="_blank" rel="noopener">ä¸ºå•¥åˆ«è¯»HotSpot VMçš„æºç </a></p>
<p>è™½ç„¶è¯´ç°åœ¨ä¸çœ‹äº†ï¼Œä½†æ˜¯è‡ªå·±è¿˜æ˜¯ç•™åœ¨å‡ ä¸ªJVMè§£æç›¸å…³åšå®¢ï¼š</p>
<ol>
<li><a href="https://www.jianshu.com/nb/12554212" target="_blank" rel="noopener">JVMæºç åˆ†æ</a></li>
<li><a href="https://hunterzhao.io/categories/#" target="_blank" rel="noopener">JVMæºç æ­ç§˜</a></li>
</ol>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ä½†è¡Œå¥½äº‹ï¼Œè«é—®å‰ç¨‹</p>
<p>çŠ¶æ€ï¼šæ„Ÿè§‰ä»€ä¹ˆéƒ½æ‡‚ä¸€ç‚¹ï¼Œåˆæ„Ÿè§‰ä»€ä¹ˆéƒ½ä¸æ‡‚ â€”â€” ä¸å¤Ÿæ·±å…¥</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åŸä»¥ä¸ºå¯ä»¥å¹³ç»“è‡ªå·±ç•¥æ‡‚çš„C++å»çœ‹JVMæºç ï¼Œä½†æ˜¯ç­‰åˆ°è‡ªå·±çœŸæ­£å»æ‰“å¼€æºç ï¼Œå°±ç®—æ˜¯å¯¹ç€åšå®¢çœ‹ï¼Œä¹Ÿæ˜¯ååˆ†åƒåŠ›ï¼Œè¿˜çœ‹äº†çŸ¥ä¹Rå¤§å¯¹çœ‹JVMæºç çš„çœ‹æ³•ã€‚SOï¼Œæˆ‘è¢«è‡ªå·±å’ŒRå¤§åŠé€€äº†ï¼Œå¯èƒ½ç›®å‰çš„è‡ªå·±è¿˜ä¸é€‚åˆå»çœ‹ï¼Œå¸Œæœ›è‡ªå·±ä»¥å&lt;strong&gt;æœ‰éœ€è¦æœ‰æ¢¦æƒ³&lt;/strong&gt;å†æ¥çœ‹ï¼
    
    </summary>
    
      <category term="JVMæºç " scheme="http://bestlixiang.site/categories/JVM%E6%BA%90%E7%A0%81/"/>
    
    
      <category term="JVM" scheme="http://bestlixiang.site/tags/JVM/"/>
    
  </entry>
  
  <entry>
    <title>JVMæºç â€”â€”Macä¸‹ç¼–è¯‘JDK</title>
    <link href="http://bestlixiang.site/2019/04/25/JVM%E6%BA%90%E7%A0%81/JVM%E6%BA%90%E7%A0%81%E2%80%94%E2%80%94Mac%E4%B8%8B%E7%BC%96%E8%AF%91JDK/"/>
    <id>http://bestlixiang.site/2019/04/25/JVMæºç /JVMæºç â€”â€”Macä¸‹ç¼–è¯‘JDK/</id>
    <published>2019-04-25T13:07:14.000Z</published>
    <updated>2019-04-25T12:57:43.140Z</updated>
    
    <content type="html"><![CDATA[<p>å¼•ï¼šå¥½åƒæ˜¯åœ¨å¤§å››çš„æ—¶å€™ï¼Œè‡ªå·±æŒ‰ç…§ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹å»ç¼–è¯‘JDKæ²¡æœ‰æˆåŠŸï¼ä½†æ˜¯åœ¨æœ€è¿‘ç»å†ä¸€äº›é¢è¯•ä¹‹åï¼Œæ„Ÿåˆ°JVMç»å¯¹æ˜¯é¢è¯•çš„ä¸€å—é‡ç‚¹ï¼Œè€Œçœ‹æºç ç»å¯¹æ˜¯ä½ æ·±å…¥ç†è§£JVMçš„ä¸€ä¸ªå¾ˆé‡è¦çš„ç‚¹ï¼åœ¨çœ‹æºç ï¼Œå°±éœ€è¦è°ƒè¯•ï¼Œé‚£ä¹ˆç¼–è¯‘è‡ªå·±JDKè¶Šæ˜¯å¿…ç„¶çš„ã€‚è¿™æ¬¡æˆ‘ä»¬åœ¨Macä¸‹å»ç¼–è¯‘OpenJDK9ï¼ï¼ï¼<a id="more"></a><br><img src="https://upload-images.jianshu.io/upload_images/10354196-14707d615dd58eed.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="å¤è”4.jpeg"></p>
<p>4.24çœ‹å®Œå¤è”4ï¼Œè„‘å­å¤ªå¤šçš„ç‚¹åŒ–ä¸º<strong>çˆ±ä½ ä¸‰åƒé</strong>ï¼</p>
<p>è¿›å…¥ä»Šå¤©çš„æ­£é¢˜ï¼ï¼ï¼</p>
<h1 id="å‡†å¤‡"><a href="#å‡†å¤‡" class="headerlink" title="å‡†å¤‡"></a>å‡†å¤‡</h1><p>å…³äºç¼–è¯‘JDKï¼Œå…¶å®åœ¨å®˜æ–¹çš„æºç åŒ…ä¸‹æœ‰ä¸ªå¸®åŠ©æ–‡ä»¶ï¼ˆopenjdk/common/building.html/mdï¼‰ã€‚è¿™ä¸ªæ–‡ä»¶ä¼šå‘Šè¯‰æˆ‘ä»¬åœ¨ç¼–è¯‘JDKä¹‹å‰éœ€è¦åšçš„å‡†å¤‡ä»¥åŠç¼–è¯‘çš„æ­¥éª¤ã€‚å…·ä½“çš„å¤§å®¶å¯ä»¥ä»”ç»†é˜…è¯»çœ‹çœ‹ã€‚ä¸‹æ¬¡åªè®²è¿°è‡ªå·±è¿™æ¬¡æ‰€ç¼–è¯‘çš„è¿‡ç¨‹ï¼</p>
<p>æˆ‘ä»¬éœ€è¦å‡†å¤‡ä¸€äº›ä¸œè¥¿ï¼Œé¦–å…ˆä½ éœ€è¦å‡†å¤‡ homebrewï¼Œhomwbrewæ˜¯macä¸‹çš„åŒ…ç®¡ç†å™¨ï¼Œå¦‚æœä½ çš„macä¸Šæ²¡æœ‰å®‰è£…ï¼Œå¯ä»¥æŒ‰ç…§ä¸‹é¢çš„æ–¹å¼æ¥å®‰è£…ï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/ruby <span class="_">-e</span> <span class="string">"<span class="variable">$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)</span>"</span></span><br></pre></td></tr></table></figure></p>
<p>homwbrewä¸‹è½½å®Œæˆä¹‹åï¼Œæ¥ä¸‹æ¥å‡†å¤‡ç¼–è¯‘ç¯å¢ƒï¼š</p>
<ul>
<li>å®‰è£…openjdkçš„ç‰ˆæœ¬ç®¡ç†å·¥å…·mercurialï¼ˆhgï¼‰</li>
<li>å®‰è£…ccacheå’Œfreetypeï¼Œccacheç”¨æ¥åŠ é€Ÿç¼–è¯‘ï¼Œfreetypeåœ¨ç¼–è¯‘è¿‡ç¨‹ä¹Ÿä¼šä¾èµ–åˆ°</li>
</ul>
<p>å®‰è£…è„šæœ¬ä¸ºï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">brew install mercurial</span><br><span class="line">brew install ccache</span><br><span class="line">brew install freetype</span><br></pre></td></tr></table></figure></p>
<p>å‡†å¤‡å¥½ä¹‹åå°±å¯ä»¥å¼€å§‹å…·ä½“çš„æ“ä½œäº†ï¼</p>
<h1 id="ä¸‹è½½æºç "><a href="#ä¸‹è½½æºç " class="headerlink" title="ä¸‹è½½æºç "></a>ä¸‹è½½æºç </h1><h2 id="å®˜æ–¹æ¨èhg"><a href="#å®˜æ–¹æ¨èhg" class="headerlink" title="å®˜æ–¹æ¨èhg"></a>å®˜æ–¹æ¨èhg</h2><p>hgï¼šMercurial source code management system<br>æˆ‘ä¸ºæºç ä¸“é—¨åˆ›å»ºäº†ä¸€ä¸ªç›®å½• <code>~/jvm</code> ï¼Œç„¶åè¿è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/jvm</span><br><span class="line">hg <span class="built_in">clone</span> http://hg.openjdk.java.net/jdk9/jdk9 jdk9</span><br></pre></td></tr></table></figure></p>
<p>è¿™æ¡å‘½ä»¤è¿è¡Œä¹‹åï¼Œopenjdkçš„æºç å¹¶æ²¡æœ‰ä¸‹è½½ä¸‹æ¥ï¼Œæˆ‘ä»¬éšåè¿›å…¥åˆ°<code>~/jvm/jdk9</code>ç›®å½•ï¼Œä¼šå‘ç°æœ‰ä¸€ä¸ª <code>get_source.sh</code> çš„æ–‡ä»¶ï¼Œè°ƒç”¨è¿™ä¸ªè„šæœ¬ä¸‹è½½å®Œæ•´çš„æºç ä¹‹å‰ï¼Œéœ€è¦åšä¸€ä¸‹ç®€å•çš„ä¿®æ”¹ï¼Œä¸ç„¶å¯èƒ½ä½ åœ¨ä¸‹è½½æºç çš„è¿‡ç¨‹ä¸­ä¼šæ•°æ¬¡ä¸­æ–­ã€‚<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Get clones of all absent nested repositories (harmless if already exist)</span></span><br><span class="line">sh ./common/bin/hgforest.sh <span class="built_in">clone</span> <span class="string">"<span class="variable">$@</span>"</span> || <span class="built_in">exit</span> $?</span><br><span class="line"></span><br><span class="line"><span class="comment"># Update all existing repositories to the latest sources</span></span><br><span class="line">sh ./common/bin/hgforest.sh pull -u</span><br></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬æŠŠä¸Šé¢å‡ è¡Œçš„è„šæœ¬åˆ æ‰ï¼Œæ›¿æ¢æˆä¸‹é¢çš„è„šæœ¬ï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Get clones of all absent nested repositories (harmless if already exist)</span></span><br><span class="line">sh ./common/bin/hgforest.sh <span class="built_in">clone</span> <span class="string">"<span class="variable">$@</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> [ $? <span class="_">-ne</span> 0 ]</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    sh ./common/bin/hgforest.sh <span class="built_in">clone</span> <span class="string">"<span class="variable">$@</span>"</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Update all existing repositories to the latest sources</span></span><br><span class="line">sh ./common/bin/hgforest.sh pull -u</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> [ $? <span class="_">-ne</span> 0 ]</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    sh ./common/bin/hgforest.sh pull -u</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure></p>
<p>ç„¶åï¼Œæ„‰å¿«åœ°è°ƒç”¨ï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash ./get_source.sh</span><br></pre></td></tr></table></figure></p>
<p>æœ¬äººè¡¨ç¤ºè¿™ä¸ªè¿™ä¸ªæ–¹æ³•æˆ‘æ²¡æœ‰æˆåŠŸï¼Œhhhã€‚æˆ‘åœ¨æ‰§è¡Œ<code>hg clone</code> çš„æ—¶å€™å°±ä¸€ç›´æŠ¥ç½‘ç»œé”™è¯¯ï¼Œå¯èƒ½æ˜¯ç”±äºthe great wallå§ï¼Œè¿˜å¥½æœ‰ä¸‹é¢çš„æ–¹æ³•ã€‚</p>
<h2 id="github"><a href="#github" class="headerlink" title="github"></a>github</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. https://github.com/unofficial-openjdk/openjdk/</span><br><span class="line">2. https://github.com/dmlloyd/openjdk</span><br></pre></td></tr></table></figure>
<p>æˆ‘é€‰æ‹©äº†ç¬¬äºŒä¸ªï¼Œåˆ‡æ¢åˆ°äº†jdk/jdk9åˆ†æ”¯ï¼Œå› ä¸ºæˆ‘ä»¬è¿™æ¬¡è¦ç¼–è¯‘jdk9ã€‚æ“ä½œå¦‚ä¸‹ï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/jvm</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/dmlloyd/openjdk.git</span><br><span class="line"><span class="built_in">cd</span> openjdk</span><br><span class="line">git checkout -b jdk9 origin/jdk9/jdk9</span><br></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªè¿˜æ˜¯æŒºé¡ºåˆ©çš„ï¼Œå“ˆå“ˆï¼</p>
<h1 id="configure"><a href="#configure" class="headerlink" title="configure"></a>configure</h1><p>æˆ‘ä»¬å…ˆè¿›è¡Œç¼–è¯‘å‰çš„é…ç½®ï¼ˆæ£€æŸ¥ï¼‰ï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --with-target-bits=64 --with-freetype=/usr/<span class="built_in">local</span>/Cellar/freetype/2.8.1 --enable-ccache --with-jvm-variants=server,client --with-boot-jdk-jvmargs=<span class="string">"-Xlint:deprecation -Xlint:unchecked"</span> --disable-zip-debug-info --disable-warnings-as-errors --with-debug-level=slowdebug 2&gt;&amp;1 | tee configure_mac_x64.log</span><br></pre></td></tr></table></figure></p>
<p>æœ‰æ—¥å¿—ï¼Œå‡ºé—®é¢˜æŸ¥é—®é¢˜ä¹Ÿå¾ˆæ–¹ä¾¿ï¼<br><strong>æ³¨æ„</strong>ï¼Œä¸Šé¢çš„freetypeï¼Œéœ€è¦æ›¿æ¢æˆæœ¬æœºå®é™…å®‰è£…çš„ç‰ˆæœ¬</p>
<p>å¦‚æœå‡ºç°å¦‚ä¸‹çš„æç¤ºï¼Œé‚£ä¹ˆæ­å–œä½ ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥æ‰§è¡Œç¼–è¯‘äº†ï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">====================================================</span><br><span class="line">The existing configuration has been successfully updated <span class="keyword">in</span></span><br><span class="line">/Users/rex/jvm/openjdk/build/macosx-x86_64-normal-serverANDclient-slowdebug</span><br><span class="line">using configure arguments <span class="string">'--with-target-bits=64 --with-freetype=/usr/local/Cellar/freetype/2.10.0 --enable-ccache --with-jvm-variants=server,client --with-boot-jdk-jvmargs='</span>-Xlint:deprecation -Xlint:unchecked<span class="string">' --disable-warnings-as-errors --with-debug-level=slowdebug'</span>.</span><br><span class="line"></span><br><span class="line">Configuration summary:</span><br><span class="line">* Debug level:    slowdebug</span><br><span class="line">* HS debug level: debug</span><br><span class="line">* JDK variant:    normal</span><br><span class="line">* JVM variants:   server client</span><br><span class="line">* OpenJDK target: OS: macosx, CPU architecture: x86, address length: 64</span><br><span class="line">* Version string: 9-internal+0-adhoc.rex.openjdk (9-internal)</span><br><span class="line"></span><br><span class="line">Tools summary:</span><br><span class="line">* Boot JDK:       java version <span class="string">"9"</span> Java(TM) SE Runtime Environment (build 9+181) Java HotSpot(TM) 64-Bit Server VM (build 9+181, mixed mode)  (at /Library/Java/JavaVirtualMachines/jdk-9.jdk/Contents/Home)</span><br><span class="line">* Toolchain:      clang (clang/LLVM from Xcode 9.4.1)</span><br><span class="line">* C Compiler:     Version 9.1.0 (at /usr/bin/clang)</span><br><span class="line">* C++ Compiler:   Version 9.1.0 (at /usr/bin/clang++)</span><br><span class="line"></span><br><span class="line">Build performance summary:</span><br><span class="line">* Cores to use:   4</span><br><span class="line">* Memory <span class="built_in">limit</span>:   8192 MB</span><br><span class="line">* ccache status:  Active (3.6)</span><br><span class="line"></span><br><span class="line">NOTE: You have requested to build more than one version of the JVM, <span class="built_in">which</span></span><br><span class="line">will result <span class="keyword">in</span> longer build times.</span><br><span class="line"></span><br><span class="line">WARNING: The result of this configuration has overridden an older</span><br><span class="line">configuration. You *should* run <span class="string">'make clean'</span> to make sure you get a</span><br><span class="line">proper build. Failure to <span class="keyword">do</span> so might result <span class="keyword">in</span> strange build problems.</span><br></pre></td></tr></table></figure></p>
<h1 id="make"><a href="#make" class="headerlink" title="make"></a>make</h1><p>æˆ‘ä»¬æ‰§è¡Œä¸‹é¢çš„æ“ä½œï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> LANG=C</span><br><span class="line">make all LOG=debug  2&gt;&amp;1 | tee make_mac_x64.log</span><br></pre></td></tr></table></figure></p>
<p>å¦‚æœå‡ºç°å¦‚ä¸‹çš„æç¤ºï¼Œé‚£ä¹ˆæ­å–œä½ ï¼Œä½ çš„è¿æ°”å¤ªå¥½äº†ï¼ï¼ï¼<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">----- Build <span class="built_in">times</span> -------</span><br><span class="line">Start 2019-04-25 18:55:19</span><br><span class="line">End   2019-04-25 19:00:57</span><br><span class="line"></span><br><span class="line">00:05:38 TOTAL</span><br><span class="line">-------------------------</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> <span class="_">-f</span> /Users/rex/jvm/openjdk/build/macosx-x86_64-normal-serverANDclient-slowdebug/make-support/<span class="built_in">exit</span>-with-error ; <span class="keyword">then</span> \</span><br><span class="line">	    <span class="built_in">exit</span> 1 ; \</span><br><span class="line">	  <span class="keyword">fi</span></span><br><span class="line">/usr/bin/<span class="built_in">printf</span> <span class="string">"Finished building target 'all' in configuration 'macosx-x86_64-normal-serverANDclient-slowdebug'\n"</span> &gt; &gt;(/usr/bin/tee <span class="_">-a</span> /Users/rex/jvm/openjdk/build/macosx-x86_64-normal-serverANDclient-slowdebug/build.log) 2&gt; &gt;(/usr/bin/tee <span class="_">-a</span> /Users/rex/jvm/openjdk/build/macosx-x86_64-normal-serverANDclient-slowdebug/build.log &gt;&amp;2) &amp;&amp; <span class="built_in">wait</span></span><br><span class="line">Finished building target <span class="string">'all'</span> <span class="keyword">in</span> configuration <span class="string">'macosx-x86_64-normal-serverANDclient-slowdebug'</span></span><br></pre></td></tr></table></figure></p>
<p>æœ€åï¼ŒéªŒè¯ä¸€ä¸‹<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> build/macosx-x86_64-normal-serverANDclient-slowdebug/jdk/bin</span><br><span class="line">./java -version</span><br></pre></td></tr></table></figure></p>
<p>å‡ºç°ä¸‹é¢çš„æç¤ºå°±å®Œç¾äº†ï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openjdk version <span class="string">"9-internal"</span></span><br><span class="line">OpenJDK Runtime Environment (slowdebug build 9-internal+0-adhoc.rex.openjdk)</span><br><span class="line">OpenJDK 64-Bit Server VM (slowdebug build 9-internal+0-adhoc.rex.openjdk, mixed mode)</span><br></pre></td></tr></table></figure></p>
<h1 id="ç¼–è¯‘è¿‡ç¨‹ä¸­çš„é—®é¢˜"><a href="#ç¼–è¯‘è¿‡ç¨‹ä¸­çš„é—®é¢˜" class="headerlink" title="ç¼–è¯‘è¿‡ç¨‹ä¸­çš„é—®é¢˜"></a>ç¼–è¯‘è¿‡ç¨‹ä¸­çš„é—®é¢˜</h1><p>æ ¹æ®<strong>å¢¨è²å®šå¾‹</strong>ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ä¸€ã€ä»»ä½•äº‹éƒ½æ²¡æœ‰è¡¨é¢çœ‹èµ·æ¥é‚£ä¹ˆç®€å•ï¼›</span><br><span class="line">äºŒã€æ‰€æœ‰çš„äº‹éƒ½ä¼šæ¯”ä½ é¢„è®¡çš„æ—¶é—´é•¿ï¼›</span><br><span class="line">ä¸‰ã€ä¼šå‡ºé”™çš„äº‹æ€»ä¼šå‡ºé”™ï¼›</span><br><span class="line">å››ã€å¦‚æœä½ æ‹…å¿ƒæŸç§æƒ…å†µå‘ç”Ÿï¼Œé‚£ä¹ˆå®ƒå°±æ›´æœ‰å¯èƒ½å‘ç”Ÿã€‚</span><br></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªæ—¶é—´ä¼šæ¯”è¾ƒé•¿ï¼Œå‡ºé”™æ˜¯å¤§æ¦‚ç‡äº‹ä»¶ï¼Œè€Œæˆ‘å°±ç¢°åˆ°ç½‘ä¸Šè¯¥æœ‰çš„æ‰€æœ‰é”™ï¼ï¼ï¼ï¼</p>
<h2 id="Xcodeç‰ˆæœ¬é—®é¢˜"><a href="#Xcodeç‰ˆæœ¬é—®é¢˜" class="headerlink" title="Xcodeç‰ˆæœ¬é—®é¢˜"></a>Xcodeç‰ˆæœ¬é—®é¢˜</h2><p>æˆ‘çš„Xcodeç‰ˆæœ¬åŸæ¥ä¸º10+ï¼ŒXCodeå‡çº§åˆ°10ä¹‹å, åˆ é™¤äº†åº•å±‚ç›®å½•ä¸‹çš„libstdc++æ–‡ä»¶ã€‚å¯¼è‡´åœ¨JDKçš„Makeæ—¶ä¼šæŠ¥é”™, æ— æ³•è¯†åˆ«<new>ç±»ä¼¼è¿™æ ·çš„C++è¯­æ³•ã€‚è€Œåœ¨XCode9æ—¶å¯¹åº”æ–‡ä»¶è¿˜æ˜¯å­˜åœ¨çš„ã€‚å®˜æ–¹ç»™å‡ºçš„æ„æ€æ˜¯libstdc++å·²ç»è¢«æ ‡è®°ä¸ºè¿‡æœŸ5å¹´äº†, ç°åœ¨ç»Ÿä¸€ä½¿ç”¨è‡ªå·±libc++ã€‚è¿™ä¸ªé—®é¢˜æœ€ç®€å•çš„é—®é¢˜å°±æ˜¯XCodeç‰ˆæœ¬å›é€€åˆ°9ä¹‹å‰å³å¯ã€‚<a href="https://developer.apple.com/download/more/" target="_blank" rel="noopener">é‡æ–°ä¸‹è½½åœ°å€</a></new></p>
<h2 id="ä¸‰ä¸ªç©ºæŒ‡é’ˆè½¬æ¢"><a href="#ä¸‰ä¸ªç©ºæŒ‡é’ˆè½¬æ¢" class="headerlink" title="ä¸‰ä¸ªç©ºæŒ‡é’ˆè½¬æ¢"></a>ä¸‰ä¸ªç©ºæŒ‡é’ˆè½¬æ¢</h2><p>æ—¥å¿—è¢«è¦†ç›–äº†ï¼Œå¿˜è®°å­˜äº†ï¼Œä½†æ˜¯å¯èƒ½ä¼šå‡ºç°è¿™æ ·çš„é—®é¢˜ï¼Œä¸‹é¢çš„æ›´æ”¹çš„ç­”æ¡ˆï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1\. src/hotspot/share/memory/virtualspace.cpp # l585</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (base() != NULL) &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">#2\. src/hotspot/share/opto/lcm.cpp # l42</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (Universe::narrow_oop_base() != NULL) &#123; // Implies UseCompressedOops.</span><br><span class="line"></span><br><span class="line"><span class="comment">#3\. src/hotspot/share/opto/loopPredicate.cpp # l915</span></span><br><span class="line"></span><br><span class="line">assert(rng-&gt;Opcode() == Op_LoadRange || iff-&gt;is_RangeCheck() || _igvn.type(rng)-&gt;is_int()-&gt;_lo &gt;= 0, <span class="string">"must be"</span>);</span><br></pre></td></tr></table></figure></p>
<h2 id="JVM-crash"><a href="#JVM-crash" class="headerlink" title="JVM crash"></a>JVM crash</h2><p>  è‡ªå·±ä¹Ÿå¿˜è®°æˆªå›¾ï¼Œæ‰€ä»¥ä¹Ÿç›—å›¾äº†ï¼š<br>  <img src="https://upload-images.jianshu.io/upload_images/10354196-b5e7dae0682e7541.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="jvm crash.png"></p>
<p>è§£å†³æ–¹æ³•ï¼š<a href="https://stackoverflow.com/questions/50678467/building-openjdk-9-on-mac-os" target="_blank" rel="noopener">Building OpenJDK 9 on Mac os</a></p>
<p>ä¸Šé¢ä¸‰ä¸ªé—®é¢˜å…¨è¢«è‡ªå·±é‡åˆ°äº†ï¼Œè¿æ°”çœŸå¥½ï¼Œä¸è¿‡èµ°åˆ°è¿™é‡Œï¼Œç»ˆäºæ˜¯æŠŠJDKç¼–è¯‘å¥½äº†ï¼</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ä½†è¡Œå¥½äº‹ï¼Œè«é—®å‰ç¨‹</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol>
<li><a href="https://www.jianshu.com/p/ee7e9176632c" target="_blank" rel="noopener">macä¸‹ç¼–è¯‘openjdk1.9åŠé›†æˆclionåŠ¨æ€è°ƒè¯•</a></li>
<li><a href="https://www.jianshu.com/p/38e697dcbaa5" target="_blank" rel="noopener">MacOS Mojave(10.14)ç¼–è¯‘openjdk9</a></li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¼•ï¼šå¥½åƒæ˜¯åœ¨å¤§å››çš„æ—¶å€™ï¼Œè‡ªå·±æŒ‰ç…§ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹å»ç¼–è¯‘JDKæ²¡æœ‰æˆåŠŸï¼ä½†æ˜¯åœ¨æœ€è¿‘ç»å†ä¸€äº›é¢è¯•ä¹‹åï¼Œæ„Ÿåˆ°JVMç»å¯¹æ˜¯é¢è¯•çš„ä¸€å—é‡ç‚¹ï¼Œè€Œçœ‹æºç ç»å¯¹æ˜¯ä½ æ·±å…¥ç†è§£JVMçš„ä¸€ä¸ªå¾ˆé‡è¦çš„ç‚¹ï¼åœ¨çœ‹æºç ï¼Œå°±éœ€è¦è°ƒè¯•ï¼Œé‚£ä¹ˆç¼–è¯‘è‡ªå·±JDKè¶Šæ˜¯å¿…ç„¶çš„ã€‚è¿™æ¬¡æˆ‘ä»¬åœ¨Macä¸‹å»ç¼–è¯‘OpenJDK9ï¼ï¼ï¼
    
    </summary>
    
      <category term="JVMæºç " scheme="http://bestlixiang.site/categories/JVM%E6%BA%90%E7%A0%81/"/>
    
    
      <category term="JVM" scheme="http://bestlixiang.site/tags/JVM/"/>
    
  </entry>
  
  <entry>
    <title>åˆ†å¸ƒå¼äº‹åŠ¡</title>
    <link href="http://bestlixiang.site/2018/12/28/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/"/>
    <id>http://bestlixiang.site/2018/12/28/åˆ†å¸ƒå¼/åˆ†å¸ƒå¼äº‹åŠ¡/</id>
    <published>2018-12-28T01:15:43.000Z</published>
    <updated>2018-12-27T11:59:10.751Z</updated>
    
    <content type="html"><![CDATA[<p>ä¼—æ‰€å‘¨çŸ¥ï¼Œäº‹åŠ¡å¯ä»¥ä¿è¯ä¸€ç»„æ“ä½œè¦ä¹ˆå…¨éƒ½æ­£ç¡®æ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ½ä¸æ‰§è¡Œã€‚ç›®å‰çš„æ•°æ®åº“åªèƒ½æ”¯æŒåŒä¸€ä¸ªæ•°æ®åº“ä¸­çš„äº‹åŠ¡ã€‚ä½†ç°åœ¨çš„ç³»ç»Ÿå¾€å¾€é‡‡ç”¨å¾®æœåŠ¡æ¶æ„ï¼Œä¸šåŠ¡ç³»ç»Ÿæ‹¥æœ‰ç‹¬ç«‹çš„æ•°æ®åº“ï¼Œå› æ­¤å°±å‡ºç°äº†è·¨å¤šä¸ªæ•°æ®åº“çš„äº‹åŠ¡éœ€æ±‚ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼äº‹åŠ¡å•¦ï¼<a id="more"></a></p>
<p><img src="https://res.cloudinary.com/cytim/image/upload/v1501433754/simcept/transaction.jpg" alt="tranaction"></p>
<h1 id="ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼äº‹åŠ¡ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼äº‹åŠ¡ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼äº‹åŠ¡ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼äº‹åŠ¡ï¼Ÿ</h1><p>éšç€å¾®æœåŠ¡æ¶æ„çš„æ™®åŠï¼Œä¸€ä¸ªå¤§å‹ä¸šåŠ¡ç³»ç»Ÿå¾€å¾€ç”±è‹¥å¹²ä¸ªå­ç³»ç»Ÿæ„æˆï¼Œè¿™äº›å­ç³»ç»Ÿåˆæ‹¥æœ‰å„è‡ªç‹¬ç«‹çš„æ•°æ®åº“ã€‚å¾€å¾€ä¸€ä¸ªä¸šåŠ¡æµç¨‹éœ€è¦ç”±å¤šä¸ªå­ç³»ç»Ÿå…±åŒå®Œæˆï¼Œè€Œä¸”è¿™äº›æ“ä½œå¯èƒ½éœ€è¦åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­å®Œæˆã€‚åœ¨å¾®æœåŠ¡ç³»ç»Ÿä¸­ï¼Œè¿™äº›ä¸šåŠ¡åœºæ™¯æ˜¯æ™®éå­˜åœ¨çš„ã€‚æ­¤æ—¶ï¼Œæˆ‘ä»¬å°±éœ€è¦åœ¨æ•°æ®åº“ä¹‹ä¸Šé€šè¿‡æŸç§æ‰‹æ®µï¼Œå®ç°æ”¯æŒè·¨æ•°æ®åº“çš„äº‹åŠ¡æ”¯æŒï¼Œè¿™å°±æ˜¯<strong>åˆ†å¸ƒå¼äº‹åŠ¡</strong>ã€‚</p>
<p>æœ€å…¸å‹çš„åˆ†å¸ƒå¼äº‹åŠ¡ä¾‹å­å°±æ˜¯ç”¨æˆ·ä¸‹å•è¿‡ç¨‹ï¼Œæˆ‘ä»¬æŒ‰æœ€ç®€å•çš„æ¥è¯´ï¼Œè‚¯å®šä¼šæœ‰ä¸‹é¢ä¸¤ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>ç”¨æˆ·ä¸‹å•ï¼Œè®¢å•ç³»ç»Ÿä¼šç”Ÿæˆä¸€æ¡è®¢å•</li>
<li>è®¢å•åˆ›å»ºæˆåŠŸåï¼Œæ”¯ä»˜ç³»ç»Ÿè¿›è¡Œæ”¯ä»˜</li>
</ol>
<p>ä¸Šé¢ä¸¤ä¸ªæ­¥éª¤åˆ†åˆ«æ˜¯åœ¨è®¢å•ç³»ç»Ÿå’Œæ”¯ä»˜ç³»ç»Ÿä¸­å®Œæˆã€‚ä»¥å‰æˆ‘ä»¬åœ¨å•æœºè¿è¡Œçš„æƒ…å†µä¸‹å¾ˆå®¹æ˜“å°±è§£å†³ã€‚ä½†æ˜¯åœ¨ç°åœ¨è¿™ä¸ªå¾®æœåŠ¡æ¶æ„ä¸­ï¼Œè¿™ä¸¤ä¸ªæ­¥éª¤æ¶‰åŠä¸¤ä¸ªç³»ç»Ÿï¼Œæ¶‰åŠä¸¤ä¸ªæ•°æ®åº“ï¼Œæ­¤æ—¶æˆ‘ä»¬å¿…é¡»åœ¨æ•°æ®åº“å’Œåº”ç”¨ç³»ç»Ÿä¹‹é—´ï¼Œé€šè¿‡æŸé¡¹æ‰‹æ®µï¼Œå®ç°åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œè¦ä¹ˆå…¨éƒ½æ­£ç¡®æ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ½ä¸æ‰§è¡Œã€‚</p>
<h1 id="åˆ†å¸ƒå¼äº‹åŠ¡åè®®"><a href="#åˆ†å¸ƒå¼äº‹åŠ¡åè®®" class="headerlink" title="åˆ†å¸ƒå¼äº‹åŠ¡åè®®"></a>åˆ†å¸ƒå¼äº‹åŠ¡åè®®</h1><h2 id="ä¸¤é˜¶æ®µæäº¤åè®®-2PC"><a href="#ä¸¤é˜¶æ®µæäº¤åè®®-2PC" class="headerlink" title="ä¸¤é˜¶æ®µæäº¤åè®® 2PC"></a>ä¸¤é˜¶æ®µæäº¤åè®® 2PC</h2><p>åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹è™½ç„¶å¯ä»¥çŸ¥æ™“è‡ªå·±çš„æ“ä½œæ—¶æˆåŠŸæˆ–è€…å¤±è´¥ï¼Œå´æ— æ³•çŸ¥é“å…¶ä»–èŠ‚ç‚¹çš„æ“ä½œçš„æˆåŠŸæˆ–å¤±è´¥ã€‚å½“ä¸€ä¸ªäº‹åŠ¡è·¨è¶Šå¤šä¸ªèŠ‚ç‚¹æ—¶ï¼Œä¸ºäº†ä¿æŒäº‹åŠ¡çš„ACIDç‰¹æ€§ï¼Œéœ€è¦å¼•å…¥ä¸€ä¸ªä½œä¸ºåè°ƒè€…çš„ç»„ä»¶æ¥ç»Ÿä¸€æŒæ§æ‰€æœ‰èŠ‚ç‚¹(ç§°ä½œå‚ä¸è€…)çš„æ“ä½œç»“æœå¹¶æœ€ç»ˆæŒ‡ç¤ºè¿™äº›èŠ‚ç‚¹æ˜¯å¦è¦æŠŠæ“ä½œç»“æœè¿›è¡ŒçœŸæ­£çš„æäº¤(æ¯”å¦‚å°†æ›´æ–°åçš„æ•°æ®å†™å…¥ç£ç›˜ç­‰ç­‰)ã€‚å› æ­¤ï¼ŒäºŒé˜¶æ®µæäº¤çš„ç®—æ³•æ€è·¯å¯ä»¥æ¦‚æ‹¬ä¸ºï¼šå‚ä¸è€…å°†æ“ä½œæˆè´¥é€šçŸ¥åè°ƒè€…ï¼Œå†ç”±åè°ƒè€…æ ¹æ®æ‰€æœ‰å‚ä¸è€…çš„åé¦ˆæƒ…æŠ¥å†³å®šå„å‚ä¸è€…æ˜¯å¦è¦æäº¤æ“ä½œè¿˜æ˜¯ä¸­æ­¢æ“ä½œã€‚</p>
<h3 id="ä¸¤é˜¶æ®µ"><a href="#ä¸¤é˜¶æ®µ" class="headerlink" title="ä¸¤é˜¶æ®µ"></a>ä¸¤é˜¶æ®µ</h3><h4 id="å‡†å¤‡é˜¶æ®µï¼ˆæŠ•ç¥¨é˜¶æ®µï¼‰"><a href="#å‡†å¤‡é˜¶æ®µï¼ˆæŠ•ç¥¨é˜¶æ®µï¼‰" class="headerlink" title="å‡†å¤‡é˜¶æ®µï¼ˆæŠ•ç¥¨é˜¶æ®µï¼‰"></a>å‡†å¤‡é˜¶æ®µï¼ˆæŠ•ç¥¨é˜¶æ®µï¼‰</h4><p>äº‹åŠ¡åè°ƒè€…(äº‹åŠ¡ç®¡ç†å™¨)ç»™æ¯ä¸ªå‚ä¸è€…(èµ„æºç®¡ç†å™¨)å‘é€Prepareæ¶ˆæ¯ï¼Œæ¯ä¸ªå‚ä¸è€…è¦ä¹ˆç›´æ¥è¿”å›å¤±è´¥(å¦‚æƒé™éªŒè¯å¤±è´¥)ï¼Œè¦ä¹ˆåœ¨æœ¬åœ°æ‰§è¡Œäº‹åŠ¡ï¼Œå†™æœ¬åœ°çš„redoå’Œundoæ—¥å¿—ï¼Œä½†ä¸æäº¤ï¼Œåˆ°è¾¾ä¸€ç§â€œä¸‡äº‹ä¿±å¤‡ï¼Œåªæ¬ ä¸œé£â€çš„çŠ¶æ€ã€‚</p>
<h4 id="æäº¤é˜¶æ®µï¼ˆæ‰§è¡Œé˜¶æ®µï¼‰"><a href="#æäº¤é˜¶æ®µï¼ˆæ‰§è¡Œé˜¶æ®µï¼‰" class="headerlink" title="æäº¤é˜¶æ®µï¼ˆæ‰§è¡Œé˜¶æ®µï¼‰"></a>æäº¤é˜¶æ®µï¼ˆæ‰§è¡Œé˜¶æ®µï¼‰</h4><p>å¦‚æœåè°ƒè€…æ”¶åˆ°äº†å‚ä¸è€…çš„å¤±è´¥æ¶ˆæ¯æˆ–è€…è¶…æ—¶ï¼Œç›´æ¥ç»™æ¯ä¸ªå‚ä¸è€…å‘é€å›æ»š(Rollback)æ¶ˆæ¯ï¼›å¦åˆ™ï¼Œå‘é€æäº¤(Commit)æ¶ˆæ¯ï¼›å‚ä¸è€…æ ¹æ®åè°ƒè€…çš„æŒ‡ä»¤æ‰§è¡Œæäº¤æˆ–è€…å›æ»šæ“ä½œï¼Œé‡Šæ”¾æ‰€æœ‰äº‹åŠ¡å¤„ç†è¿‡ç¨‹ä¸­ä½¿ç”¨çš„é”èµ„æºã€‚(æ³¨æ„:å¿…é¡»åœ¨æœ€åé˜¶æ®µé‡Šæ”¾é”èµ„æº)</p>
<h3 id="ç¼ºç‚¹"><a href="#ç¼ºç‚¹" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h3><ol>
<li>åŒæ­¥é˜»å¡é—®é¢˜ã€‚æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæ‰€æœ‰å‚ä¸èŠ‚ç‚¹éƒ½æ˜¯äº‹åŠ¡é˜»å¡å‹çš„ã€‚å½“å‚ä¸è€…å æœ‰å…¬å…±èµ„æºæ—¶ï¼Œå…¶ä»–ç¬¬ä¸‰æ–¹èŠ‚ç‚¹è®¿é—®å…¬å…±èµ„æºä¸å¾—ä¸å¤„äºé˜»å¡çŠ¶æ€ã€‚</li>
<li>å•ç‚¹æ•…éšœã€‚ç”±äºåè°ƒè€…çš„é‡è¦æ€§ï¼Œä¸€æ—¦åè°ƒè€…å‘ç”Ÿæ•…éšœã€‚å‚ä¸è€…ä¼šä¸€ç›´é˜»å¡ä¸‹å»ã€‚å°¤å…¶åœ¨ç¬¬äºŒé˜¶æ®µï¼Œåè°ƒè€…å‘ç”Ÿæ•…éšœï¼Œé‚£ä¹ˆæ‰€æœ‰çš„å‚ä¸è€…è¿˜éƒ½å¤„äºé”å®šäº‹åŠ¡èµ„æºçš„çŠ¶æ€ä¸­ï¼Œè€Œæ— æ³•ç»§ç»­å®Œæˆäº‹åŠ¡æ“ä½œã€‚ï¼ˆå¦‚æœæ˜¯åè°ƒè€…æŒ‚æ‰ï¼Œå¯ä»¥é‡æ–°é€‰ä¸¾ä¸€ä¸ªåè°ƒè€…ï¼Œä½†æ˜¯æ— æ³•è§£å†³å› ä¸ºåè°ƒè€…å®•æœºå¯¼è‡´çš„å‚ä¸è€…å¤„äºé˜»å¡çŠ¶æ€çš„é—®é¢˜ï¼‰</li>
<li>æ•°æ®ä¸ä¸€è‡´ã€‚åœ¨äºŒé˜¶æ®µæäº¤çš„é˜¶æ®µäºŒä¸­ï¼Œå½“åè°ƒè€…å‘å‚ä¸è€…å‘é€commitè¯·æ±‚ä¹‹åï¼Œå‘ç”Ÿäº†å±€éƒ¨ç½‘ç»œå¼‚å¸¸æˆ–è€…åœ¨å‘é€commitè¯·æ±‚è¿‡ç¨‹ä¸­åè°ƒè€…å‘ç”Ÿäº†æ•…éšœï¼Œè¿™å›å¯¼è‡´åªæœ‰ä¸€éƒ¨åˆ†å‚ä¸è€…æ¥å—åˆ°äº†commitè¯·æ±‚ã€‚è€Œåœ¨è¿™éƒ¨åˆ†å‚ä¸è€…æ¥åˆ°commitè¯·æ±‚ä¹‹åå°±ä¼šæ‰§è¡Œcommitæ“ä½œã€‚ä½†æ˜¯å…¶ä»–éƒ¨åˆ†æœªæ¥åˆ°commitè¯·æ±‚çš„æœºå™¨åˆ™æ— æ³•æ‰§è¡Œäº‹åŠ¡æäº¤ã€‚äºæ˜¯æ•´ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¾¿å‡ºç°äº†æ•°æ®éƒ¨ä¸€è‡´æ€§çš„ç°è±¡ã€‚</li>
<li>äºŒé˜¶æ®µæ— æ³•è§£å†³çš„é—®é¢˜ï¼šåè°ƒè€…å†å‘å‡ºcommitæ¶ˆæ¯ä¹‹åå®•æœºï¼Œè€Œå”¯ä¸€æ¥æ”¶åˆ°è¿™æ¡æ¶ˆæ¯çš„å‚ä¸è€…åŒæ—¶ä¹Ÿå®•æœºäº†ã€‚é‚£ä¹ˆå³ä½¿åè°ƒè€…é€šè¿‡é€‰ä¸¾</li>
</ol>
<p>ç”±äºäºŒé˜¶æ®µæäº¤å­˜åœ¨ç€è¯¸å¦‚åŒæ­¥é˜»å¡ã€å•ç‚¹é—®é¢˜ã€è„‘è£‚ç­‰ç¼ºé™·ï¼Œæ‰€ä»¥ï¼Œç ”ç©¶è€…ä»¬åœ¨äºŒé˜¶æ®µæäº¤çš„åŸºç¡€ä¸Šåšäº†æ”¹è¿›ï¼Œæå‡ºäº†ä¸‰é˜¶æ®µæäº¤ã€‚</p>
<h2 id="ä¸‰é˜¶æ®µæäº¤åè®®-3PC"><a href="#ä¸‰é˜¶æ®µæäº¤åè®®-3PC" class="headerlink" title="ä¸‰é˜¶æ®µæäº¤åè®® 3PC"></a>ä¸‰é˜¶æ®µæäº¤åè®® 3PC</h2><p>ä¸ä¸¤é˜¶æ®µæäº¤ä¸åŒçš„æ˜¯ï¼Œä¸‰é˜¶æ®µæäº¤æœ‰ä¸¤ä¸ªæ”¹åŠ¨ç‚¹ï¼š</p>
<ol>
<li>å¼•å…¥è¶…æ—¶æœºåˆ¶ã€‚åŒæ—¶åœ¨åè°ƒè€…å’Œå‚ä¸è€…ä¸­éƒ½å¼•å…¥è¶…æ—¶æœºåˆ¶ã€‚</li>
<li>åœ¨ç¬¬ä¸€é˜¶æ®µå’Œç¬¬äºŒé˜¶æ®µä¸­æ’å…¥ä¸€ä¸ªå‡†å¤‡é˜¶æ®µã€‚ä¿è¯äº†åœ¨æœ€åæäº¤é˜¶æ®µä¹‹å‰å„å‚ä¸èŠ‚ç‚¹çš„çŠ¶æ€æ˜¯ä¸€è‡´çš„ã€‚</li>
</ol>
<h3 id="ä¸‰é˜¶æ®µ"><a href="#ä¸‰é˜¶æ®µ" class="headerlink" title="ä¸‰é˜¶æ®µ"></a>ä¸‰é˜¶æ®µ</h3><h4 id="CanCommité˜¶æ®µ"><a href="#CanCommité˜¶æ®µ" class="headerlink" title="CanCommité˜¶æ®µ"></a>CanCommité˜¶æ®µ</h4><ol>
<li>äº‹åŠ¡è¯¢é—® åè°ƒè€…å‘å‚ä¸è€…å‘é€CanCommitè¯·æ±‚ã€‚è¯¢é—®æ˜¯å¦å¯ä»¥æ‰§è¡Œäº‹åŠ¡æäº¤æ“ä½œã€‚ç„¶åå¼€å§‹ç­‰å¾…å‚ä¸è€…çš„å“åº”ã€‚</li>
<li>å“åº”åé¦ˆ å‚ä¸è€…æ¥åˆ°CanCommitè¯·æ±‚ä¹‹åï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼Œå¦‚æœå…¶è‡ªèº«è®¤ä¸ºå¯ä»¥é¡ºåˆ©æ‰§è¡Œäº‹åŠ¡ï¼Œåˆ™è¿”å›Yeså“åº”ï¼Œå¹¶è¿›å…¥é¢„å¤‡çŠ¶æ€ã€‚å¦åˆ™åé¦ˆNo</li>
</ol>
<h4 id="PreCommité˜¶æ®µ"><a href="#PreCommité˜¶æ®µ" class="headerlink" title="PreCommité˜¶æ®µ"></a>PreCommité˜¶æ®µ</h4><p>ä¸¤ç§æƒ…å†µï¼š<br><strong>å‡å¦‚åè°ƒè€…ä»æ‰€æœ‰çš„å‚ä¸è€…è·å¾—çš„åé¦ˆéƒ½æ˜¯Yeså“åº”ï¼š</strong></p>
<ol>
<li>å‘é€é¢„æäº¤è¯·æ±‚ åè°ƒè€…å‘å‚ä¸è€…å‘é€PreCommitè¯·æ±‚ï¼Œå¹¶è¿›å…¥Preparedé˜¶æ®µã€‚</li>
<li>äº‹åŠ¡é¢„æäº¤ å‚ä¸è€…æ¥æ”¶åˆ°PreCommitè¯·æ±‚åï¼Œä¼šæ‰§è¡Œäº‹åŠ¡æ“ä½œï¼Œå¹¶å°†undoå’Œredoä¿¡æ¯è®°å½•åˆ°äº‹åŠ¡æ—¥å¿—ä¸­ã€‚</li>
<li>å“åº”åé¦ˆ å¦‚æœå‚ä¸è€…æˆåŠŸçš„æ‰§è¡Œäº†äº‹åŠ¡æ“ä½œï¼Œåˆ™è¿”å›ACKå“åº”ï¼ŒåŒæ—¶å¼€å§‹ç­‰å¾…æœ€ç»ˆæŒ‡ä»¤ã€‚</li>
</ol>
<p><strong>å‡å¦‚æœ‰ä»»ä½•ä¸€ä¸ªå‚ä¸è€…å‘åè°ƒè€…å‘é€äº†Noå“åº”ï¼Œæˆ–è€…ç­‰å¾…è¶…æ—¶ä¹‹åï¼š</strong></p>
<ol>
<li>å‘é€ä¸­æ–­è¯·æ±‚ åè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘é€abortè¯·æ±‚ã€‚</li>
<li>ä¸­æ–­äº‹åŠ¡ å‚ä¸è€…æ”¶åˆ°æ¥è‡ªåè°ƒè€…çš„abortè¯·æ±‚ä¹‹åï¼ˆæˆ–è¶…æ—¶ä¹‹åï¼Œä»æœªæ”¶åˆ°åè°ƒè€…çš„è¯·æ±‚ï¼‰ï¼Œæ‰§è¡Œäº‹åŠ¡çš„ä¸­æ–­ã€‚</li>
</ol>
<h4 id="doCommité˜¶æ®µ"><a href="#doCommité˜¶æ®µ" class="headerlink" title="doCommité˜¶æ®µ"></a>doCommité˜¶æ®µ</h4><p>ä¸¤ç§æƒ…å†µï¼š<br><strong>åè°ƒè€…æ¥æ”¶åˆ°å‚ä¸è€…å‘é€çš„ACKå“åº”ï¼š</strong></p>
<ol>
<li>å‘é€æäº¤è¯·æ±‚ åè°ƒæ¥æ”¶åˆ°å‚ä¸è€…å‘é€çš„ACKå“åº”ï¼Œé‚£ä¹ˆä»–å°†ä»é¢„æäº¤çŠ¶æ€è¿›å…¥åˆ°æäº¤çŠ¶æ€ã€‚å¹¶å‘æ‰€æœ‰å‚ä¸è€…å‘é€doCommitè¯·æ±‚ã€‚</li>
<li>äº‹åŠ¡æäº¤ å‚ä¸è€…æ¥æ”¶åˆ°doCommitè¯·æ±‚ä¹‹åï¼Œæ‰§è¡Œæ­£å¼çš„äº‹åŠ¡æäº¤ã€‚å¹¶åœ¨å®Œæˆäº‹åŠ¡æäº¤ä¹‹åé‡Šæ”¾æ‰€æœ‰äº‹åŠ¡èµ„æºã€‚</li>
<li>å“åº”åé¦ˆ äº‹åŠ¡æäº¤å®Œä¹‹åï¼Œå‘åè°ƒè€…å‘é€Ackå“åº”ã€‚</li>
<li>å®Œæˆäº‹åŠ¡ åè°ƒè€…æ¥æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…çš„ackå“åº”ä¹‹åï¼Œå®Œæˆäº‹åŠ¡ã€‚</li>
</ol>
<p><strong>åè°ƒè€…æ²¡æœ‰æ¥æ”¶åˆ°å‚ä¸è€…å‘é€çš„ACKå“åº”ï¼Œæˆ–è€…å“åº”è¶…æ—¶ï¼š</strong></p>
<ol>
<li>å‘é€ä¸­æ–­è¯·æ±‚ åè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘é€abortè¯·æ±‚</li>
<li>äº‹åŠ¡å›æ»š å‚ä¸è€…æ¥æ”¶åˆ°abortè¯·æ±‚ä¹‹åï¼Œåˆ©ç”¨å…¶åœ¨é˜¶æ®µäºŒè®°å½•çš„undoä¿¡æ¯æ¥æ‰§è¡Œäº‹åŠ¡çš„å›æ»šæ“ä½œï¼Œå¹¶åœ¨å®Œæˆå›æ»šä¹‹åé‡Šæ”¾æ‰€æœ‰çš„äº‹åŠ¡èµ„æºã€‚</li>
<li>åé¦ˆç»“æœ å‚ä¸è€…å®Œæˆäº‹åŠ¡å›æ»šä¹‹åï¼Œå‘åè°ƒè€…å‘é€ACKæ¶ˆæ¯</li>
<li>ä¸­æ–­äº‹åŠ¡ åè°ƒè€…æ¥æ”¶åˆ°å‚ä¸è€…åé¦ˆçš„ACKæ¶ˆæ¯ä¹‹åï¼Œæ‰§è¡Œäº‹åŠ¡çš„ä¸­æ–­ã€‚</li>
</ol>
<h2 id="2PCä¸3PCçš„åŒºåˆ«"><a href="#2PCä¸3PCçš„åŒºåˆ«" class="headerlink" title="2PCä¸3PCçš„åŒºåˆ«"></a>2PCä¸3PCçš„åŒºåˆ«</h2><p>ç›¸å¯¹äº2PCï¼Œ3PCä¸»è¦è§£å†³çš„å•ç‚¹æ•…éšœé—®é¢˜ï¼Œå¹¶å‡å°‘é˜»å¡ï¼Œ<strong>å› ä¸ºä¸€æ—¦å‚ä¸è€…æ— æ³•åŠæ—¶æ”¶åˆ°æ¥è‡ªåè°ƒè€…çš„ä¿¡æ¯ä¹‹åï¼Œä»–ä¼šé»˜è®¤æ‰§è¡Œcommitã€‚</strong> è€Œä¸ä¼šä¸€ç›´æŒæœ‰äº‹åŠ¡èµ„æºå¹¶å¤„äºé˜»å¡çŠ¶æ€ã€‚ä½†æ˜¯è¿™ç§æœºåˆ¶ä¹Ÿä¼šå¯¼è‡´æ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼Œå› ä¸ºï¼Œç”±äºç½‘ç»œåŸå› ï¼Œåè°ƒè€…å‘é€çš„abortå“åº”æ²¡æœ‰åŠæ—¶è¢«å‚ä¸è€…æ¥æ”¶åˆ°ï¼Œé‚£ä¹ˆå‚ä¸è€…åœ¨ç­‰å¾…è¶…æ—¶ä¹‹åæ‰§è¡Œäº†commitæ“ä½œã€‚è¿™æ ·å°±å’Œå…¶ä»–æ¥åˆ°abortå‘½ä»¤å¹¶æ‰§è¡Œå›æ»šçš„å‚ä¸è€…ä¹‹é—´å­˜åœ¨æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µã€‚</p>
<h1 id="åˆ†å¸ƒå¼è§£å†³æ–¹æ¡ˆ"><a href="#åˆ†å¸ƒå¼è§£å†³æ–¹æ¡ˆ" class="headerlink" title="åˆ†å¸ƒå¼è§£å†³æ–¹æ¡ˆ"></a>åˆ†å¸ƒå¼è§£å†³æ–¹æ¡ˆ</h1><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å½“ä½ è§‰å¾—ä½ çš„ç³»ç»Ÿä¸­ä½¿ç”¨<strong>åˆ†å¸ƒå¼äº‹åŠ¡</strong>çš„æ—¶å€™ï¼Œ<strong>ä½ ä¸€å®šè¦é—®é—®è‡ªå·±çœŸçš„éœ€è¦å—</strong>?å¾ˆå¤šæ—¶å€™æˆ‘ä»¬å¹¶ä¸éœ€è¦ï¼Œä¹Ÿè®¸æˆ‘ä»¬åªè¦å°†ä¸¤ä¸ªå¾®æœåŠ¡èšåˆæˆä¸€ä¸ªå•æœºæœåŠ¡ï¼Œä»è€Œå¯ä»¥ä½¿ç”¨æ•°æ®åº“çš„æœ¬åœ°äº‹åŠ¡ã€‚<strong>å› ä¸ºä½ åªè¦ä½¿ç”¨äº†åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œå¿…ç„¶ä¼šå¢åŠ ç³»ç»Ÿçš„å¤æ‚åº¦ã€‚</strong> å½“ç„¶æœ‰æ—¶å€™æˆ‘ä»¬æ˜¯çœŸçš„éœ€è¦ï¼Œä¸‹é¢æˆ‘ä»¬ä»‹ç»å‡ ç§å¸¸è§çš„æ–¹æ¡ˆï¼</p>
<h2 id="åŸºäºXAçš„åˆ†å¸ƒå¼äº‹åŠ¡"><a href="#åŸºäºXAçš„åˆ†å¸ƒå¼äº‹åŠ¡" class="headerlink" title="åŸºäºXAçš„åˆ†å¸ƒå¼äº‹åŠ¡"></a>åŸºäºXAçš„åˆ†å¸ƒå¼äº‹åŠ¡</h2><p><img src="https://pic1.zhimg.com/80/v2-1eb94800ac7dbaa86f103dc9bc7f93a8_hd.jpg" alt="xa"></p>
<p>åŸºäºXAçš„åˆ†å¸ƒå¼äº‹åŠ¡å…¶å®å°±æ˜¯2PCåè®®çš„å®ç°ã€‚æ‰€ä»¥å®ƒæ¯”è¾ƒç®€å•ï¼Œæˆæœ¬è¾ƒä½ï¼Œä½†æ˜¯å…¶å•ç‚¹é—®é¢˜ï¼Œä»¥åŠä¸èƒ½æ”¯æŒé«˜å¹¶å‘(ç”±äºåŒæ­¥é˜»å¡)ä¾ç„¶æ˜¯å…¶æœ€å¤§çš„å¼±ç‚¹ã€‚ä½†æ˜¯Mysqlã€Oracleéƒ½åœ¨ä½¿ç”¨è¿™ç§æ–¹æ¡ˆã€‚</p>
<h2 id="åŸºäºæ¶ˆæ¯çš„æœ€ç»ˆä¸€è‡´æ€§æ–¹æ¡ˆ"><a href="#åŸºäºæ¶ˆæ¯çš„æœ€ç»ˆä¸€è‡´æ€§æ–¹æ¡ˆ" class="headerlink" title="åŸºäºæ¶ˆæ¯çš„æœ€ç»ˆä¸€è‡´æ€§æ–¹æ¡ˆ"></a>åŸºäºæ¶ˆæ¯çš„æœ€ç»ˆä¸€è‡´æ€§æ–¹æ¡ˆ</h2><p>è¿™ç§å®ç°åˆ†å¸ƒå¼äº‹åŠ¡çš„æ–¹å¼éœ€è¦é€šè¿‡æ¶ˆæ¯ä¸­é—´ä»¶æ¥å®ç°ã€‚å‡è®¾æœ‰Aå’ŒBä¸¤ä¸ªç³»ç»Ÿï¼Œåˆ†åˆ«å¯ä»¥å¤„ç†ä»»åŠ¡Aå’Œä»»åŠ¡Bã€‚æ­¤æ—¶ç³»ç»ŸAä¸­å­˜åœ¨ä¸€ä¸ªä¸šåŠ¡æµç¨‹ï¼Œéœ€è¦å°†ä»»åŠ¡Aå’Œä»»åŠ¡Båœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­å¤„ç†ã€‚ä¸‹é¢æ¥ä»‹ç»åŸºäºæ¶ˆæ¯ä¸­é—´ä»¶æ¥å®ç°è¿™ç§åˆ†å¸ƒå¼äº‹åŠ¡ã€‚</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/3/10/1620fc30782107d1?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="message-commit"></p>
<ol>
<li>åœ¨ç³»ç»ŸAå¤„ç†ä»»åŠ¡Aå‰ï¼Œé¦–å…ˆå‘æ¶ˆæ¯ä¸­é—´ä»¶å‘é€ä¸€æ¡æ¶ˆæ¯</li>
<li>æ¶ˆæ¯ä¸­é—´ä»¶æ”¶åˆ°åå°†è¯¥æ¡æ¶ˆæ¯æŒä¹…åŒ–ï¼Œä½†å¹¶ä¸æŠ•é€’ã€‚æ­¤æ—¶ä¸‹æ¸¸ç³»ç»ŸBä»ç„¶ä¸çŸ¥é“è¯¥æ¡æ¶ˆæ¯çš„å­˜åœ¨ã€‚</li>
<li>æ¶ˆæ¯ä¸­é—´ä»¶æŒä¹…åŒ–æˆåŠŸåï¼Œä¾¿å‘ç³»ç»ŸAè¿”å›ä¸€ä¸ªç¡®è®¤åº”ç­”ï¼›</li>
<li>ç³»ç»ŸAæ”¶åˆ°ç¡®è®¤åº”ç­”åï¼Œåˆ™å¯ä»¥å¼€å§‹å¤„ç†ä»»åŠ¡Aï¼›</li>
<li>ä»»åŠ¡Aå¤„ç†å®Œæˆåï¼Œå‘æ¶ˆæ¯ä¸­é—´ä»¶å‘é€Commitè¯·æ±‚ã€‚è¯¥è¯·æ±‚å‘é€å®Œæˆåï¼Œå¯¹ç³»ç»ŸAè€Œè¨€ï¼Œè¯¥äº‹åŠ¡çš„å¤„ç†è¿‡ç¨‹å°±ç»“æŸäº†ï¼Œæ­¤æ—¶å®ƒå¯ä»¥å¤„ç†åˆ«çš„ä»»åŠ¡äº†ã€‚</li>
<li>ä½†commitæ¶ˆæ¯å¯èƒ½ä¼šåœ¨ä¼ è¾“é€”ä¸­ä¸¢å¤±ï¼Œä»è€Œæ¶ˆæ¯ä¸­é—´ä»¶å¹¶ä¸ä¼šå‘ç³»ç»ŸBæŠ•é€’è¿™æ¡æ¶ˆæ¯ï¼Œä»è€Œç³»ç»Ÿå°±ä¼šå‡ºç°ä¸ä¸€è‡´æ€§ã€‚è¿™ä¸ªé—®é¢˜ç”±æ¶ˆæ¯ä¸­é—´ä»¶çš„äº‹åŠ¡å›æŸ¥æœºåˆ¶å®Œæˆï¼Œä¸‹æ–‡ä¼šä»‹ç»ã€‚</li>
<li>æ¶ˆæ¯ä¸­é—´ä»¶æ”¶åˆ°CommitæŒ‡ä»¤åï¼Œä¾¿å‘ç³»ç»ŸBæŠ•é€’è¯¥æ¶ˆæ¯ï¼Œä»è€Œè§¦å‘ä»»åŠ¡Bçš„æ‰§è¡Œï¼›</li>
<li>å½“ä»»åŠ¡Bæ‰§è¡Œå®Œæˆåï¼Œç³»ç»ŸBå‘æ¶ˆæ¯ä¸­é—´ä»¶è¿”å›ä¸€ä¸ªç¡®è®¤åº”ç­”ï¼Œå‘Šè¯‰æ¶ˆæ¯ä¸­é—´ä»¶è¯¥æ¶ˆæ¯å·²ç»æˆåŠŸæ¶ˆè´¹ï¼Œæ­¤æ—¶ï¼Œè¿™ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡å®Œæˆã€‚</li>
</ol>
<p>ä»ä¸Šé¢çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼š</p>
<ol>
<li>æ¶ˆæ¯ä¸­é—´ä»¶æ‰®æ¼”è€…åˆ†å¸ƒå¼äº‹åŠ¡åè°ƒè€…çš„è§’è‰²ã€‚</li>
<li>ç³»ç»ŸAå®Œæˆä»»åŠ¡Aåï¼Œåˆ°ä»»åŠ¡Bæ‰§è¡Œå®Œæˆä¹‹é—´ï¼Œä¼šå­˜åœ¨ä¸€å®šçš„æ—¶é—´å·®ã€‚åœ¨è¿™ä¸ªæ—¶é—´å·®å†…ï¼Œæ•´ä¸ªç³»ç»Ÿå¤„äºæ•°æ®ä¸ä¸€è‡´çš„çŠ¶æ€ï¼Œä½†è¿™çŸ­æš‚çš„ä¸ä¸€è‡´æ€§æ˜¯å¯ä»¥æ¥å—çš„ï¼Œå› ä¸ºç»è¿‡çŸ­æš‚çš„æ—¶é—´åï¼Œç³»ç»Ÿåˆå¯ä»¥ä¿æŒæ•°æ®ä¸€è‡´æ€§ï¼Œ<strong>æ»¡è¶³BASEç†è®º</strong>ã€‚</li>
</ol>
<p>ä¸Šè¿°è¿‡ç¨‹ä¸­ï¼Œå¦‚æœä»»åŠ¡Aå¤„ç†å¤±è´¥ï¼Œé‚£ä¹ˆéœ€è¦è¿›å…¥å›æ»šæµç¨‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="https://user-gold-cdn.xitu.io/2018/3/10/1620fc307be6c55d?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="message-a-rollback"></p>
<ol>
<li>è‹¥ç³»ç»ŸAåœ¨å¤„ç†ä»»åŠ¡Aæ—¶å¤±è´¥ï¼Œé‚£ä¹ˆå°±ä¼šå‘æ¶ˆæ¯ä¸­é—´ä»¶å‘é€Rollbackè¯·æ±‚ã€‚å’Œå‘é€Commitè¯·æ±‚ä¸€æ ·ï¼Œç³»ç»ŸAå‘å®Œä¹‹åä¾¿å¯ä»¥è®¤ä¸ºå›æ»šå·²ç»å®Œæˆï¼Œå®ƒä¾¿å¯ä»¥å»åšå…¶ä»–çš„äº‹æƒ…ã€‚</li>
<li>æ¶ˆæ¯ä¸­é—´ä»¶æ”¶åˆ°å›æ»šè¯·æ±‚åï¼Œç›´æ¥å°†è¯¥æ¶ˆæ¯ä¸¢å¼ƒï¼Œè€Œä¸æŠ•é€’ç»™ç³»ç»ŸBï¼Œä»è€Œä¸ä¼šè§¦å‘ç³»ç»ŸBçš„ä»»åŠ¡Bã€‚</li>
</ol>
<p>ä¸Šé¢æ‰€ä»‹ç»çš„Commitå’ŒRollbackéƒ½å±äºç†æƒ³æƒ…å†µï¼Œä½†åœ¨å®é™…ç³»ç»Ÿä¸­ï¼ŒCommitå’ŒRollbackæŒ‡ä»¤éƒ½æœ‰å¯èƒ½åœ¨ä¼ è¾“é€”ä¸­ä¸¢å¤±ã€‚é‚£ä¹ˆå½“å‡ºç°è¿™ç§æƒ…å†µçš„æ—¶å€™ï¼Œæ¶ˆæ¯ä¸­é—´ä»¶æ˜¯å¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§å‘¢ï¼Ÿâ€”â€”ç­”æ¡ˆå°±æ˜¯è¶…æ—¶è¯¢é—®æœºåˆ¶ã€‚<br><img src="https://user-gold-cdn.xitu.io/2018/3/10/1620fc307c2d185e?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="message-b-rollback"></p>
<p>æ‰€ä»¥ç³»ç»ŸAé™¤äº†å®ç°æ­£å¸¸çš„ä¸šåŠ¡æµç¨‹å¤–ï¼Œè¿˜éœ€æä¾›ä¸€ä¸ªäº‹åŠ¡è¯¢é—®çš„æ¥å£ï¼Œä¾›æ¶ˆæ¯ä¸­é—´ä»¶è°ƒç”¨ã€‚å½“æ¶ˆæ¯ä¸­é—´ä»¶æ”¶åˆ°ä¸€æ¡äº‹åŠ¡å‹æ¶ˆæ¯åä¾¿å¼€å§‹è®¡æ—¶ï¼Œå¦‚æœåˆ°äº†è¶…æ—¶æ—¶é—´ä¹Ÿæ²¡æ”¶åˆ°ç³»ç»ŸAå‘æ¥çš„Commitæˆ–RollbackæŒ‡ä»¤çš„è¯ï¼Œå°±ä¼šä¸»åŠ¨è°ƒç”¨ç³»ç»ŸAæä¾›çš„äº‹åŠ¡è¯¢é—®æ¥å£è¯¢é—®è¯¥ç³»ç»Ÿç›®å‰çš„çŠ¶æ€ã€‚è¯¥æ¥å£ä¼šè¿”å›ä¸‰ç§ç»“æœï¼š</p>
<ul>
<li>æäº¤ è‹¥è·å¾—çš„çŠ¶æ€æ˜¯â€œæäº¤â€ï¼Œåˆ™å°†è¯¥æ¶ˆæ¯æŠ•é€’ç»™ç³»ç»ŸBã€‚</li>
<li>å›æ»š è‹¥è·å¾—çš„çŠ¶æ€æ˜¯â€œå›æ»šâ€ï¼Œåˆ™ç›´æ¥å°†æ¡æ¶ˆæ¯ä¸¢å¼ƒã€‚</li>
<li>å¤„ç†ä¸­ è‹¥è·å¾—çš„çŠ¶æ€æ˜¯â€œå¤„ç†ä¸­â€ï¼Œåˆ™ç»§ç»­ç­‰å¾…ã€‚</li>
</ul>
<p>ä¸Šæ¸¸çš„çš„æ¶ˆæ¯æŠ•é€’ä¿è¯äº†ï¼Œé‚£ä¹ˆä¸‹æ¸¸çš„æ¶ˆæ¯æŠ•é€’çš„å¯é æ€§ä¿è¯æ€ä¹ˆè§£å†³å‘¢ï¼Ÿ</p>
<p>å½“ä¸Šæ¸¸ç³»ç»Ÿæ‰§è¡Œå®Œä»»åŠ¡å¹¶å‘æ¶ˆæ¯ä¸­é—´ä»¶æäº¤äº†CommitæŒ‡ä»¤åï¼Œä¾¿å¯ä»¥å¤„ç†å…¶ä»–ä»»åŠ¡äº†ï¼Œæ­¤æ—¶å®ƒå¯ä»¥è®¤ä¸ºäº‹åŠ¡å·²ç»å®Œæˆï¼Œæ¥ä¸‹æ¥æ¶ˆæ¯ä¸­é—´ä»¶<strong>ä¸€å®šä¼šä¿è¯æ¶ˆæ¯è¢«ä¸‹æ¸¸ç³»ç»ŸæˆåŠŸæ¶ˆè´¹æ‰ï¼</strong>é‚£ä¹ˆè¿™æ˜¯æ€ä¹ˆåšåˆ°çš„å‘¢ï¼Ÿè¿™ç”±æ¶ˆæ¯ä¸­é—´ä»¶çš„æŠ•é€’æµç¨‹æ¥ä¿è¯ã€‚<br>æ¶ˆæ¯ä¸­é—´ä»¶å‘ä¸‹æ¸¸ç³»ç»ŸæŠ•é€’å®Œæ¶ˆæ¯åä¾¿è¿›å…¥é˜»å¡ç­‰å¾…çŠ¶æ€ï¼Œä¸‹æ¸¸ç³»ç»Ÿä¾¿ç«‹å³è¿›è¡Œä»»åŠ¡çš„å¤„ç†ï¼Œä»»åŠ¡å¤„ç†å®Œæˆåä¾¿å‘æ¶ˆæ¯ä¸­é—´ä»¶è¿”å›åº”ç­”ã€‚æ¶ˆæ¯ä¸­é—´ä»¶æ”¶åˆ°ç¡®è®¤åº”ç­”åä¾¿è®¤ä¸ºè¯¥äº‹åŠ¡å¤„ç†å®Œæ¯•ï¼<br>å¦‚æœæ¶ˆæ¯åœ¨æŠ•é€’è¿‡ç¨‹ä¸­ä¸¢å¤±ï¼Œæˆ–æ¶ˆæ¯çš„ç¡®è®¤åº”ç­”åœ¨è¿”å›é€”ä¸­ä¸¢å¤±ï¼Œé‚£ä¹ˆæ¶ˆæ¯ä¸­é—´ä»¶åœ¨ç­‰å¾…ç¡®è®¤åº”ç­”è¶…æ—¶ä¹‹åå°±ä¼šé‡æ–°æŠ•é€’ï¼Œç›´åˆ°ä¸‹æ¸¸æ¶ˆè´¹è€…è¿”å›æ¶ˆè´¹æˆåŠŸå“åº”ä¸ºæ­¢ã€‚å½“ç„¶ï¼Œä¸€èˆ¬æ¶ˆæ¯ä¸­é—´ä»¶å¯ä»¥è®¾ç½®æ¶ˆæ¯é‡è¯•çš„æ¬¡æ•°å’Œæ—¶é—´é—´éš”ï¼Œå¦‚æœé‡è¯•å¤šæ¬¡ä¹‹åä»ç„¶æŠ•é€’å¤±è´¥ï¼Œé‚£ä¹ˆè¿™æ¡æ¶ˆæ¯å°±éœ€è¦äººå·¥å¹²é¢„ã€‚<br><img src="https://user-gold-cdn.xitu.io/2018/3/10/1620fc3078194980?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="message-0-rollback"><br><img src="https://user-gold-cdn.xitu.io/2018/3/10/1620fc308ece8d2a?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="message-1-rollback"></p>
<p>å¦‚æœæ¶ˆè´¹è¶…æ—¶ï¼Œåˆ™éœ€è¦ä¸€ç›´é‡è¯•ï¼Œè¿™é‡Œå°±ä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜ï¼š<strong>æ¶ˆæ¯æ¥æ”¶ç«¯éœ€è¦ä¿è¯å¹‚ç­‰</strong>ã€‚è¿™åˆæ˜¯å¦å¤–ä¸€ä¸ªé—®é¢˜ï¼Œæ¯”å¦‚ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶ã€‚</p>
<p>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œä¸Šæ¸¸ç³»ç»ŸAå‘æ¶ˆæ¯ä¸­é—´ä»¶æäº¤Commit/Rollbackæ¶ˆæ¯é‡‡ç”¨çš„æ˜¯å¼‚æ­¥æ–¹å¼ï¼Œæ¶ˆæ¯ä¸­é—´ä»¶å’Œä¸‹æ¸¸ç³»ç»Ÿä¹‹é—´ä¸ºä»€ä¹ˆè¦é‡‡ç”¨åŒæ­¥é€šä¿¡å‘¢ï¼Ÿ</p>
<ol>
<li>æ¸¸ç³»ç»Ÿå’Œæ¶ˆæ¯ä¸­é—´ä»¶ä¹‹é—´é‡‡ç”¨å¼‚æ­¥é€šä¿¡æ˜¯ä¸ºäº†æé«˜ç³»ç»Ÿå¹¶å‘åº¦ã€‚ä¸šåŠ¡ç³»ç»Ÿç›´æ¥å’Œç”¨æˆ·æ‰“äº¤é“ï¼Œç”¨æˆ·ä½“éªŒå°¤ä¸ºé‡è¦ï¼Œå› æ­¤è¿™ç§å¼‚æ­¥é€šä¿¡æ–¹å¼èƒ½å¤Ÿæå¤§ç¨‹åº¦åœ°é™ä½ç”¨æˆ·ç­‰å¾…æ—¶é—´ã€‚æ­¤å¤–ï¼Œå¼‚æ­¥é€šä¿¡ç›¸å¯¹äºåŒæ­¥é€šä¿¡è€Œè¨€ï¼Œæ²¡æœ‰äº†é•¿æ—¶é—´çš„é˜»å¡ç­‰å¾…ï¼Œå› æ­¤ç³»ç»Ÿçš„å¹¶å‘æ€§ä¹Ÿå¤§å¤§å¢åŠ ã€‚ä½†å¼‚æ­¥é€šä¿¡å¯èƒ½ä¼šå¼•èµ·Commit/RollbackæŒ‡ä»¤ä¸¢å¤±çš„é—®é¢˜ï¼Œè¿™å°±ç”±æ¶ˆæ¯ä¸­é—´ä»¶çš„è¶…æ—¶è¯¢é—®æœºåˆ¶æ¥å¼¥è¡¥ã€‚</li>
<li>æ¶ˆæ¯æ¯ä¸­é—´ä»¶å’Œä¸‹æ¸¸ç³»ç»Ÿä¹‹é—´é‡‡ç”¨åŒæ­¥é€šä¿¡æ˜¯å› ä¸ºåŒæ­¥è™½ç„¶é™ä½ç³»ç»Ÿå¹¶å‘åº¦ï¼Œä½†å®ç°æˆæœ¬è¾ƒä½ã€‚å› æ­¤ï¼Œåœ¨å¯¹å¹¶å‘åº¦è¦æ±‚ä¸æ˜¯å¾ˆé«˜çš„æƒ…å†µä¸‹ï¼Œæˆ–è€…æœåŠ¡å™¨èµ„æºè¾ƒä¸ºå……è£•çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©åŒæ­¥æ¥é™ä½ç³»ç»Ÿçš„å¤æ‚åº¦ã€‚</li>
</ol>
<h2 id="TCCç¼–ç¨‹å¼è¡¥å¿æ€§äº‹åŠ¡"><a href="#TCCç¼–ç¨‹å¼è¡¥å¿æ€§äº‹åŠ¡" class="headerlink" title="TCCç¼–ç¨‹å¼è¡¥å¿æ€§äº‹åŠ¡"></a>TCCç¼–ç¨‹å¼è¡¥å¿æ€§äº‹åŠ¡</h2><p><img src="https://img.alicdn.com/tfs/TB1CdK1dKOSBuNjy0FdXXbDnVXa-856-417.png" alt="tcc"></p>
<p>TCCå³ä¸º<strong>Try Confirm Cancel</strong>ï¼Œå®ƒå±äºè¡¥å¿å‹åˆ†å¸ƒå¼äº‹åŠ¡ã€‚é¡¾åæ€ä¹‰ï¼ŒTCCå®ç°åˆ†å¸ƒå¼äº‹åŠ¡ä¸€å…±æœ‰ä¸‰ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>Tryï¼šå°è¯•å¾…æ‰§è¡Œçš„ä¸šåŠ¡<br> è¿™ä¸ªè¿‡ç¨‹å¹¶æœªæ‰§è¡Œä¸šåŠ¡ï¼Œåªæ˜¯å®Œæˆæ‰€æœ‰ä¸šåŠ¡çš„ä¸€è‡´æ€§æ£€æŸ¥ï¼Œå¹¶<strong>é¢„ç•™å¥½æ‰§è¡Œæ‰€éœ€çš„å…¨éƒ¨èµ„æº</strong></li>
<li>Confirmï¼šæ‰§è¡Œä¸šåŠ¡<br> è¿™ä¸ªè¿‡ç¨‹çœŸæ­£å¼€å§‹æ‰§è¡Œä¸šåŠ¡ï¼Œç”±äºTryé˜¶æ®µå·²ç»å®Œæˆäº†ä¸€è‡´æ€§æ£€æŸ¥ï¼Œå› æ­¤æœ¬è¿‡ç¨‹ç›´æ¥æ‰§è¡Œï¼Œè€Œä¸åšä»»ä½•æ£€æŸ¥ã€‚å¹¶ä¸”åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œä¼šä½¿ç”¨åˆ°Tryé˜¶æ®µé¢„ç•™çš„ä¸šåŠ¡èµ„æºã€‚</li>
<li>Cancelï¼šå–æ¶ˆæ‰§è¡Œçš„ä¸šåŠ¡<br> è‹¥ä¸šåŠ¡æ‰§è¡Œå¤±è´¥ï¼Œåˆ™è¿›å…¥Cancelé˜¶æ®µï¼Œå®ƒä¼šé‡Šæ”¾æ‰€æœ‰å ç”¨çš„ä¸šåŠ¡èµ„æºï¼Œå¹¶å›æ»šConfirmé˜¶æ®µæ‰§è¡Œçš„æ“ä½œã€‚</li>
</ol>
<p>å°±ä¸¾ä¸‹å•æ”¯ä»˜çš„ä¾‹å­ï¼š<br>Tryï¼š</p>
<ul>
<li>ä»ç”¨æˆ·è´¦æˆ·æ‰£é™¤100å…ƒï¼ˆé¢„ç•™ä¸šåŠ¡èµ„æºï¼‰</li>
</ul>
<p>Confirmï¼š</p>
<ul>
<li>è®¢å•ç”Ÿæˆ</li>
<li>å•†æˆ·è´¦æˆ·å¢åŠ 100å…ƒ</li>
</ul>
<p>Concelï¼š</p>
<ul>
<li>å°†ç”¨æˆ·è´¦æˆ·å¢åŠ 100å…ƒ</li>
<li>å°†å•†æˆ·è´¦æˆ·å‡å»100å…ƒ</li>
<li>å‡ºç°ä»»ä½•å¼‚å¸¸ï¼Œé‡Šæ”¾æ‰€æœ‰å ç”¨çš„ä¸šåŠ¡èµ„æºï¼Œå¹¶å›æ»šConfirmé˜¶æ®µæ‰§è¡Œçš„æ“ä½œã€‚</li>
</ul>
<p>å¯¹äºTCCæ¥è¯´é€‚åˆä¸€äº›:</p>
<ul>
<li>å¼ºéš”ç¦»æ€§ï¼Œä¸¥æ ¼ä¸€è‡´æ€§è¦æ±‚çš„æ´»åŠ¨ä¸šåŠ¡ã€‚</li>
<li>æ‰§è¡Œæ—¶é—´è¾ƒçŸ­çš„ä¸šåŠ¡</li>
</ul>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol>
<li><a href="https://juejin.im/post/5aa3c7736fb9a028bb189bca" target="_blank" rel="noopener">å¸¸ç”¨çš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ</a></li>
<li><a href="https://juejin.im/post/5b5a0bf9f265da0f6523913b" target="_blank" rel="noopener">å†æœ‰äººé—®ä½ åˆ†å¸ƒå¼äº‹åŠ¡ï¼ŒæŠŠè¿™ç¯‡æ‰”ç»™ä»–</a></li>
<li><a href="http://www.hollischuang.com/archives/681" target="_blank" rel="noopener">å…³äºåˆ†å¸ƒå¼äº‹åŠ¡ã€ä¸¤é˜¶æ®µæäº¤åè®®ã€ä¸‰é˜¶æäº¤åè®®</a></li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä¼—æ‰€å‘¨çŸ¥ï¼Œäº‹åŠ¡å¯ä»¥ä¿è¯ä¸€ç»„æ“ä½œè¦ä¹ˆå…¨éƒ½æ­£ç¡®æ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ½ä¸æ‰§è¡Œã€‚ç›®å‰çš„æ•°æ®åº“åªèƒ½æ”¯æŒåŒä¸€ä¸ªæ•°æ®åº“ä¸­çš„äº‹åŠ¡ã€‚ä½†ç°åœ¨çš„ç³»ç»Ÿå¾€å¾€é‡‡ç”¨å¾®æœåŠ¡æ¶æ„ï¼Œä¸šåŠ¡ç³»ç»Ÿæ‹¥æœ‰ç‹¬ç«‹çš„æ•°æ®åº“ï¼Œå› æ­¤å°±å‡ºç°äº†è·¨å¤šä¸ªæ•°æ®åº“çš„äº‹åŠ¡éœ€æ±‚ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼äº‹åŠ¡å•¦ï¼
    
    </summary>
    
      <category term="åˆ†å¸ƒå¼" scheme="http://bestlixiang.site/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
    
      <category term="åˆ†å¸ƒå¼äº‹åŠ¡" scheme="http://bestlixiang.site/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/"/>
    
  </entry>
  
  <entry>
    <title>åˆ†å¸ƒå¼é”</title>
    <link href="http://bestlixiang.site/2018/12/27/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/"/>
    <id>http://bestlixiang.site/2018/12/27/åˆ†å¸ƒå¼/åˆ†å¸ƒå¼é”/</id>
    <published>2018-12-27T05:15:43.000Z</published>
    <updated>2018-12-27T05:16:46.141Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨å•æœºåœºæ™¯ä¸‹ï¼Œå¯ä»¥ä½¿ç”¨è¯­è¨€çš„å†…ç½®é”ï¼ˆå¦‚JDKä¸­çš„ReentrantLcokæˆ–è€…synchronizedï¼‰æ¥å®ç°è¿›ç¨‹åŒæ­¥ã€‚ä½†æ˜¯åœ¨åˆ†å¸ƒå¼åœºæ™¯ä¸‹ï¼Œéœ€è¦åŒæ­¥çš„è¿›ç¨‹å¯èƒ½ä½äºä¸åŒçš„èŠ‚ç‚¹ä¸Šï¼Œé‚£ä¹ˆå°±éœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼é”ã€‚<a id="more"></a></p>
<p><img src="https://cdn.masterlock.com/masterlock/resources/img/home-sliders/1588D-combinationlock.jpg" alt="lock"></p>
<h1 id="åˆ†å¸ƒå¼é”æ€§è´¨"><a href="#åˆ†å¸ƒå¼é”æ€§è´¨" class="headerlink" title="åˆ†å¸ƒå¼é”æ€§è´¨"></a>åˆ†å¸ƒå¼é”æ€§è´¨</h1><ol>
<li>è·å–é”å’Œé‡Šæ”¾é”çš„æ€§èƒ½è¦å¥½</li>
<li>åˆ¤æ–­æ˜¯å¦è·å¾—é”å¿…é¡»æ˜¯åŸå­æ€§çš„ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´å¤šä¸ªè¯·æ±‚éƒ½è·å–åˆ°é”</li>
<li>ç½‘ç»œä¸­æ–­æˆ–å®•æœºæ— æ³•é‡Šæ”¾é”æ—¶ï¼Œé”å¿…é¡»è¢«æ¸…é™¤ï¼Œä¸ç„¶ä¼šå‘ç”Ÿæ­»é”</li>
<li>å¯é‡å…¥è·å–é”</li>
<li>å¯ä»¥ä¸ºé˜»å¡é”å’Œéé˜»å¡é”ï¼Œé˜»å¡é”å³æ²¡æœ‰è·å–åˆ°é”ï¼Œåˆ™ç»§ç»­ç­‰å¾…è·å–é”ï¼›éé˜»å¡é”å³æ²¡æœ‰è·å–åˆ°é”åï¼Œä¸ç»§ç»­ç­‰å¾…ï¼Œç›´æ¥è¿”å›é”å¤±è´¥ã€‚</li>
</ol>
<h1 id="åˆ†å¸ƒå¼é”å®ç°æ–¹å¼"><a href="#åˆ†å¸ƒå¼é”å®ç°æ–¹å¼" class="headerlink" title="åˆ†å¸ƒå¼é”å®ç°æ–¹å¼"></a>åˆ†å¸ƒå¼é”å®ç°æ–¹å¼</h1><h2 id="æ•°æ®åº“é”"><a href="#æ•°æ®åº“é”" class="headerlink" title="æ•°æ®åº“é”"></a>æ•°æ®åº“é”</h2><h3 id="åŸºäºMySQLé”è¡¨"><a href="#åŸºäºMySQLé”è¡¨" class="headerlink" title="åŸºäºMySQLé”è¡¨"></a>åŸºäºMySQLé”è¡¨</h3><p>è¯¥å®ç°æ–¹å¼å®Œå…¨ä¾é <strong>æ•°æ®åº“å”¯ä¸€ç´¢å¼•</strong>æ¥å®ç°ã€‚å½“æƒ³è¦è·å¾—é”æ—¶ï¼Œå³å‘æ•°æ®åº“ä¸­æ’å…¥ä¸€æ¡è®°å½•ï¼Œé‡Šæ”¾é”æ—¶å°±åˆ é™¤è¿™æ¡è®°å½•ã€‚è¿™ç§æ–¹å¼å­˜åœ¨ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š</p>
<ol>
<li>é”æ²¡æœ‰å¤±æ•ˆæ—¶é—´ï¼Œè§£é”å¤±è´¥ä¼šå¯¼è‡´æ­»é”ï¼Œå…¶ä»–çº¿ç¨‹æ— æ³•å†è·å–åˆ°é”ï¼Œå› ä¸ºå”¯ä¸€ç´¢å¼•insertéƒ½ä¼šè¿”å›å¤±è´¥ã€‚</li>
<li>åªèƒ½æ˜¯éé˜»å¡é”ï¼Œinsertå¤±è´¥ç›´æ¥å°±æŠ¥é”™äº†ï¼Œæ— æ³•è¿›å…¥é˜Ÿåˆ—è¿›è¡Œé‡è¯•ã€‚</li>
<li>ä¸å¯é‡å…¥ï¼ŒåŒä¸€çº¿ç¨‹åœ¨æ²¡æœ‰é‡Šæ”¾é”ä¹‹å‰æ— æ³•å†è·å–åˆ°é”ã€‚</li>
</ol>
<h3 id="é‡‡ç”¨ä¹è§‚é”å¢åŠ ç‰ˆæœ¬å·"><a href="#é‡‡ç”¨ä¹è§‚é”å¢åŠ ç‰ˆæœ¬å·" class="headerlink" title="é‡‡ç”¨ä¹è§‚é”å¢åŠ ç‰ˆæœ¬å·"></a>é‡‡ç”¨ä¹è§‚é”å¢åŠ ç‰ˆæœ¬å·</h3><p>æ ¹æ®<strong>ç‰ˆæœ¬å·å­—æ®µ</strong>æ¥åˆ¤æ–­æ›´æ–°ä¹‹å‰æœ‰æ²¡æœ‰å…¶ä»–çº¿ç¨‹æ›´æ–°è¿‡ï¼Œå¦‚æœè¢«æ›´æ–°è¿‡ï¼Œåˆ™è·å–é”å¤±è´¥ã€‚</p>
<h2 id="ç¼“å­˜é”"><a href="#ç¼“å­˜é”" class="headerlink" title="ç¼“å­˜é”"></a>ç¼“å­˜é”</h2><p>å¹³æ—¶ä½¿ç”¨çš„æœ€å¤šçš„å°±æ˜¯redisï¼Œè¿™é‡Œä»‹ç»ä¸¤ç§redisçš„åˆ†å¸ƒå¼é”ã€‚</p>
<h3 id="åŸºäºsetnxã€expireä¸¤ä¸ªå‘½ä»¤æ¥å®ç°"><a href="#åŸºäºsetnxã€expireä¸¤ä¸ªå‘½ä»¤æ¥å®ç°" class="headerlink" title="åŸºäºsetnxã€expireä¸¤ä¸ªå‘½ä»¤æ¥å®ç°"></a>åŸºäºsetnxã€expireä¸¤ä¸ªå‘½ä»¤æ¥å®ç°</h3><p>åŸºäºsetnxï¼ˆset if not existï¼‰çš„ç‰¹ç‚¹ï¼Œå½“ç¼“å­˜é‡Œkeyä¸å­˜åœ¨æ—¶ï¼Œæ‰ä¼šå»setï¼Œå¦åˆ™ç›´æ¥è¿”å›falseã€‚å¦‚æœè¿”å›trueåˆ™è·å–åˆ°é”ï¼Œå¦åˆ™è·å–é”å¤±è´¥ï¼Œä¸ºäº†é˜²æ­¢æ­»é”ï¼Œæˆ‘ä»¬å†ç”¨expireå‘½ä»¤å¯¹è¿™ä¸ªkeyè®¾ç½®ä¸€ä¸ªè¶…æ—¶æ—¶é—´æ¥é¿å…ã€‚</p>
<p>ä½†æ˜¯è¿™é‡Œçœ‹ä¼¼å®Œç¾ï¼Œå®åˆ™æœ‰ç¼ºé™·ï¼Œå½“æˆ‘ä»¬setnxæˆåŠŸåï¼Œçº¿ç¨‹å‘ç”Ÿå¼‚å¸¸ä¸­æ–­ï¼Œexpireè¿˜æ²¡æ¥çš„åŠè®¾ç½®ï¼Œé‚£ä¹ˆå°±ä¼šäº§ç”Ÿæ­»é”ã€‚</p>
<p>ä¸ºäº†è§£å†³ä¸Šè¯‰é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨redis2.6.12ç‰ˆæœ¬ä»¥åçš„setï¼Œå®ƒæä¾›äº†ä¸€ç³»åˆ—é€‰é¡¹ï¼š</p>
<ul>
<li>EX seconds â€“ è®¾ç½®é”®keyçš„è¿‡æœŸæ—¶é—´ï¼Œå•ä½æ—¶ç§’</li>
<li>PX milliseconds â€“ è®¾ç½®é”®keyçš„è¿‡æœŸæ—¶é—´ï¼Œå•ä½æ—¶æ¯«ç§’</li>
<li>NX â€“ åªæœ‰é”®keyä¸å­˜åœ¨çš„æ—¶å€™æ‰ä¼šè®¾ç½®keyçš„å€¼</li>
<li>XX â€“ åªæœ‰é”®keyå­˜åœ¨çš„æ—¶å€™æ‰ä¼šè®¾ç½®keyçš„å€¼</li>
</ul>
<h3 id="RedLockç®—æ³•"><a href="#RedLockç®—æ³•" class="headerlink" title="RedLockç®—æ³•"></a>RedLockç®—æ³•</h3><p>redlockç®—æ³•æ˜¯<strong>redisä½œè€…æ¨è</strong>çš„ä¸€ç§åˆ†å¸ƒå¼é”å®ç°æ–¹å¼ï¼Œç®—æ³•çš„å†…å®¹å¦‚ä¸‹ï¼š</p>
<ol>
<li>è·å–å½“å‰æ—¶é—´ï¼›</li>
<li>å°è¯•ä»Nä¸ªç›¸äº’ç‹¬ç«‹rediså®¢æˆ·ç«¯è·å–é”ï¼›</li>
<li>è®¡ç®—è·å–æ‰€æœ‰é”æ¶ˆè€—çš„æ—¶é—´ï¼Œå½“ä¸”ä»…å½“å®¢æˆ·ç«¯ä»å¤šæ•°èŠ‚ç‚¹(N/2+1)è·å–é”ï¼Œå¹¶ä¸”è·å–é”çš„æ—¶é—´å°äºé”çš„æœ‰æ•ˆæ—¶é—´ï¼Œè®¤ä¸ºè·å¾—é”ï¼›</li>
<li>é‡æ–°è®¡ç®—æœ‰æ•ˆæœŸæ—¶é—´ï¼ŒåŸæœ‰æ•ˆæ—¶é—´å‡å»è·å–é”æ¶ˆè€—çš„æ—¶é—´ï¼›</li>
<li>åˆ é™¤æ‰€æœ‰å®ä¾‹çš„é”</li>
</ol>
<p>redlockç®—æ³•ç›¸å¯¹äºå•èŠ‚ç‚¹redisé”å¯é æ€§è¦æ›´é«˜ï¼Œä½†æ˜¯å®ç°èµ·æ¥æ¡ä»¶ä¹Ÿè¾ƒä¸ºè‹›åˆ»ã€‚</p>
<ol>
<li>å¿…é¡»éƒ¨ç½²5ä¸ªèŠ‚ç‚¹æ‰èƒ½è®©Redlockçš„å¯é æ€§æ›´å¼ºã€‚</li>
<li>éœ€è¦è¯·æ±‚5ä¸ªèŠ‚ç‚¹æ‰èƒ½è·å–åˆ°é”ï¼Œé€šè¿‡Futureçš„æ–¹å¼ï¼Œå…ˆå¹¶å‘å‘5ä¸ªèŠ‚ç‚¹è¯·æ±‚ï¼Œå†ä¸€èµ·è·å¾—å“åº”ç»“æœï¼Œèƒ½ç¼©çŸ­å“åº”æ—¶é—´ï¼Œä¸è¿‡è¿˜æ˜¯æ¯”å•èŠ‚ç‚¹redisé”è¦è€—è´¹æ›´å¤šæ—¶é—´ã€‚</li>
</ol>
<p>ç„¶åç”±äºå¿…é¡»è·å–åˆ°5ä¸ªèŠ‚ç‚¹ä¸­çš„3ä¸ªä»¥ä¸Šï¼Œæ‰€ä»¥å¯èƒ½å‡ºç°è·å–é”å†²çªï¼Œå³å¤§å®¶éƒ½è·å¾—äº†1-2æŠŠé”ï¼Œç»“æœè°ä¹Ÿä¸èƒ½è·å–åˆ°é”ï¼Œè¿™ä¸ªé—®é¢˜ï¼Œredisä½œè€…å€Ÿé‰´äº†raftç®—æ³•çš„ç²¾é«“ï¼Œé€šè¿‡å†²çªååœ¨éšæœºæ—¶é—´å¼€å§‹ï¼Œå¯ä»¥å¤§å¤§é™ä½å†²çªæ—¶é—´ï¼Œä½†æ˜¯è¿™é—®é¢˜å¹¶ä¸èƒ½å¾ˆå¥½çš„é¿å…ï¼Œç‰¹åˆ«æ˜¯åœ¨ç¬¬ä¸€æ¬¡è·å–é”çš„æ—¶å€™ï¼Œæ‰€ä»¥è·å–é”çš„æ—¶é—´æˆæœ¬å¢åŠ äº†ã€‚</p>
<p>å¦‚æœ5ä¸ªèŠ‚ç‚¹æœ‰2ä¸ªå®•æœºï¼Œæ­¤æ—¶é”çš„å¯ç”¨æ€§ä¼šæå¤§é™ä½ï¼Œé¦–å…ˆå¿…é¡»ç­‰å¾…è¿™ä¸¤ä¸ªå®•æœºèŠ‚ç‚¹çš„ç»“æœè¶…æ—¶æ‰èƒ½è¿”å›ï¼Œå¦å¤–åªæœ‰3ä¸ªèŠ‚ç‚¹ï¼Œå®¢æˆ·ç«¯å¿…é¡»è·å–åˆ°è¿™å…¨éƒ¨3ä¸ªèŠ‚ç‚¹çš„é”æ‰èƒ½æ‹¥æœ‰é”ï¼Œéš¾åº¦ä¹ŸåŠ å¤§äº†ã€‚</p>
<p>å¦‚æœå‡ºç°ç½‘ç»œåˆ†åŒºï¼Œé‚£ä¹ˆå¯èƒ½å‡ºç°å®¢æˆ·ç«¯æ°¸è¿œä¹Ÿæ— æ³•è·å–é”çš„æƒ…å†µï¼Œä»‹äºè¿™ç§æƒ…å†µï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ç§æ›´å¯é çš„åˆ†å¸ƒå¼é”zookeeperé”ã€‚</p>
<h2 id="zookeeperé”"><a href="#zookeeperé”" class="headerlink" title="zookeeperé”"></a>zookeeperé”</h2><h3 id="ZookeeperæŠ½è±¡æ¨¡å‹"><a href="#ZookeeperæŠ½è±¡æ¨¡å‹" class="headerlink" title="ZookeeperæŠ½è±¡æ¨¡å‹"></a>ZookeeperæŠ½è±¡æ¨¡å‹</h3><p>Zookeeper æä¾›äº†ä¸€ç§æ ‘å½¢ç»“æ„çº§çš„å‘½åç©ºé—´ï¼Œ/app1/p_1 èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ä¸º /app1ã€‚<br><img src="http://s1.51cto.com/oss/201809/12/08308a2ed38371a6fef72f281598b3df.jpg" alt="zookeeper"></p>
<h3 id="èŠ‚ç‚¹ç±»å‹"><a href="#èŠ‚ç‚¹ç±»å‹" class="headerlink" title="èŠ‚ç‚¹ç±»å‹"></a>èŠ‚ç‚¹ç±»å‹</h3><ul>
<li>æ°¸ä¹…èŠ‚ç‚¹ï¼šä¸ä¼šå› ä¸ºä¼šè¯ç»“æŸæˆ–è€…è¶…æ—¶è€Œæ¶ˆå¤±;</li>
<li>ä¸´æ—¶èŠ‚ç‚¹ï¼šå¦‚ä½•ä¼šè¯ç»“æŸæˆ–è€…è¶…æ—¶å°±ä¼šæ¶ˆå¤±;</li>
<li>æœ‰åºèŠ‚ç‚¹ï¼šä¼šåœ¨èŠ‚ç‚¹åçš„åé¢åŠ ä¸€ä¸ªæ•°å­—åç¼€ï¼Œå¹¶ä¸”æ˜¯æœ‰åºçš„ï¼Œä¾‹å¦‚ç”Ÿæˆçš„æœ‰åºèŠ‚ç‚¹ä¸º /lock/node-0000000000ï¼Œå®ƒçš„ä¸‹ä¸€ä¸ªæœ‰åºèŠ‚ç‚¹åˆ™ä¸º /lock/node-0000000001ï¼Œä»¥æ­¤ç±»æ¨ã€‚</li>
</ul>
<h3 id="ç›‘å¬å™¨"><a href="#ç›‘å¬å™¨" class="headerlink" title="ç›‘å¬å™¨"></a>ç›‘å¬å™¨</h3><p>ä¸ºä¸€ä¸ªèŠ‚ç‚¹æ³¨å†Œç›‘å¬å™¨ï¼Œåœ¨èŠ‚ç‚¹çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼Œä¼šç»™å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ã€‚å½“å‰zookeeperæœ‰å¦‚ä¸‹å››ç§äº‹ä»¶ï¼š1ï¼‰èŠ‚ç‚¹åˆ›å»ºï¼›2ï¼‰èŠ‚ç‚¹åˆ é™¤ï¼›3ï¼‰èŠ‚ç‚¹æ•°æ®ä¿®æ”¹ï¼›4ï¼‰å­èŠ‚ç‚¹å˜æ›´ã€‚</p>
<h3 id="åˆ†å¸ƒå¼é”å®ç°"><a href="#åˆ†å¸ƒå¼é”å®ç°" class="headerlink" title="åˆ†å¸ƒå¼é”å®ç°"></a>åˆ†å¸ƒå¼é”å®ç°</h3><ol>
<li>åˆ›å»ºä¸€ä¸ªé”ç›®å½• /lockï¼›</li>
<li>å½“ä¸€ä¸ªå®¢æˆ·ç«¯éœ€è¦è·å–é”æ—¶ï¼Œåœ¨ /lock ä¸‹åˆ›å»º<strong>ä¸´æ—¶çš„ä¸”æœ‰åºçš„</strong>å­èŠ‚ç‚¹ï¼›<br>å®¢æˆ·ç«¯è·å– /lock ä¸‹çš„å­èŠ‚ç‚¹åˆ—è¡¨ï¼Œåˆ¤æ–­è‡ªå·±åˆ›å»ºçš„å­èŠ‚ç‚¹æ˜¯å¦ä¸ºå½“å‰å­èŠ‚ç‚¹åˆ—è¡¨ä¸­åºå·æœ€å°çš„å­èŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯åˆ™è®¤ä¸ºè·å¾—é”ï¼›å¦åˆ™ç›‘å¬è‡ªå·±çš„å‰ä¸€ä¸ªå­èŠ‚ç‚¹ï¼Œè·å¾—å­èŠ‚ç‚¹çš„å˜æ›´é€šçŸ¥åé‡å¤æ­¤æ­¥éª¤ç›´è‡³è·å¾—é”ï¼›</li>
<li>æ‰§è¡Œä¸šåŠ¡ä»£ç </li>
<li>ä¸šåŠ¡ä»£ç æ‰§è¡Œå®Œæˆåï¼Œåˆ é™¤å¯¹åº”çš„å­èŠ‚ç‚¹ã€‚</li>
</ol>
<p>æœ‰äº›äººä¼šåœ¨<strong>æ­¥éª¤2ä¸­è·å–å­èŠ‚ç‚¹åˆ—è¡¨ä¸è®¾ç½®ç›‘å¬è¿™ä¸¤æ­¥æ“ä½œçš„å­˜åœ¨åŸå­æ€§é—®é¢˜</strong>ï¼Œè€ƒè™‘è¿™ä¹ˆä¸ªåœºæ™¯ï¼šå®¢æˆ·ç«¯aå¯¹åº”å­èŠ‚ç‚¹ä¸º/lock/lock-0000000000ï¼Œå®¢æˆ·ç«¯bå¯¹åº”å­èŠ‚ç‚¹ä¸º/lock/lock-0000000001ï¼Œå®¢æˆ·ç«¯bè·å–å­èŠ‚ç‚¹åˆ—è¡¨æ—¶å‘ç°è‡ªå·±ä¸æ˜¯åºå·æœ€å°çš„ï¼Œä½†æ˜¯åœ¨è®¾ç½®ç›‘å¬å™¨å‰å®¢æˆ·ç«¯aå®Œæˆä¸šåŠ¡æµç¨‹åˆ é™¤äº†å­èŠ‚ç‚¹/lock/lock-0000000000ï¼Œå®¢æˆ·ç«¯bè®¾ç½®çš„ç›‘å¬å™¨å²‚ä¸æ˜¯ä¸¢å¤±äº†è¿™ä¸ªäº‹ä»¶ä»è€Œå¯¼è‡´æ°¸è¿œç­‰å¾…äº†ï¼Ÿè¿™ä¸ªé—®é¢˜ä¸å­˜åœ¨çš„ã€‚<strong>å› ä¸ºzookeeperæä¾›çš„APIä¸­è®¾ç½®ç›‘å¬å™¨çš„æ“ä½œä¸è¯»æ“ä½œæ˜¯åŸå­æ‰§è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨è¯»å­èŠ‚ç‚¹åˆ—è¡¨æ—¶åŒæ—¶è®¾ç½®ç›‘å¬å™¨ï¼Œä¿è¯ä¸ä¼šä¸¢å¤±äº‹ä»¶ã€‚</strong></p>
<h3 id="ç¾Šç¾¤æ•ˆåº”"><a href="#ç¾Šç¾¤æ•ˆåº”" class="headerlink" title="ç¾Šç¾¤æ•ˆåº”"></a>ç¾Šç¾¤æ•ˆåº”</h3><p>ä¸€ä¸ªèŠ‚ç‚¹æœªè·å¾—é”ï¼Œåªéœ€è¦ç›‘å¬è‡ªå·±çš„å‰ä¸€ä¸ªå­èŠ‚ç‚¹ï¼Œè¿™æ˜¯å› ä¸ºå¦‚æœç›‘å¬æ‰€æœ‰çš„å­èŠ‚ç‚¹ï¼Œé‚£ä¹ˆä»»æ„ä¸€ä¸ªå­èŠ‚ç‚¹çŠ¶æ€æ”¹å˜ï¼Œå…¶å®ƒæ‰€æœ‰å­èŠ‚ç‚¹éƒ½ä¼šæ”¶åˆ°é€šçŸ¥ï¼ˆç¾Šç¾¤æ•ˆåº”ï¼‰ï¼Œè€Œæˆ‘ä»¬åªå¸Œæœ›å®ƒçš„åä¸€ä¸ªå­èŠ‚ç‚¹æ”¶åˆ°é€šçŸ¥ã€‚</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol>
<li><a href="http://www.linkedkeeper.com/detail/blog.action?bid=1023" target="_blank" rel="noopener">æµ…è°ˆåˆ†å¸ƒå¼é”</a></li>
<li><a href="http://www.dengshenyu.com/java/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/2017/10/23/zookeeper-distributed-lock.html" target="_blank" rel="noopener">åŸºäºZookeeperçš„åˆ†å¸ƒå¼é”</a></li>
<li><a href="https://segmentfault.com/a/1190000012919740#articleHeader5" target="_blank" rel="noopener">åŸºäºredisçš„åˆ†å¸ƒå¼é”å®ç°</a></li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨å•æœºåœºæ™¯ä¸‹ï¼Œå¯ä»¥ä½¿ç”¨è¯­è¨€çš„å†…ç½®é”ï¼ˆå¦‚JDKä¸­çš„ReentrantLcokæˆ–è€…synchronizedï¼‰æ¥å®ç°è¿›ç¨‹åŒæ­¥ã€‚ä½†æ˜¯åœ¨åˆ†å¸ƒå¼åœºæ™¯ä¸‹ï¼Œéœ€è¦åŒæ­¥çš„è¿›ç¨‹å¯èƒ½ä½äºä¸åŒçš„èŠ‚ç‚¹ä¸Šï¼Œé‚£ä¹ˆå°±éœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼é”ã€‚
    
    </summary>
    
      <category term="åˆ†å¸ƒå¼" scheme="http://bestlixiang.site/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
    
      <category term="åˆ†å¸ƒå¼é”" scheme="http://bestlixiang.site/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/"/>
    
  </entry>
  
  <entry>
    <title>consistent hashing algorithm</title>
    <link href="http://bestlixiang.site/2018/12/27/%E5%88%86%E5%B8%83%E5%BC%8F/consistent%20hashing%20algorithm%20/"/>
    <id>http://bestlixiang.site/2018/12/27/åˆ†å¸ƒå¼/consistent hashing algorithm /</id>
    <published>2018-12-26T23:14:13.000Z</published>
    <updated>2018-12-26T12:04:02.312Z</updated>
    
    <content type="html"><![CDATA[<p>å¼•ï¼šåœ¨åˆ†å¸ƒå¼é›†ç¾¤ä¸­ï¼Œå¯¹æœºå™¨çš„æ·»åŠ åˆ é™¤ï¼Œæˆ–è€…æœºå™¨æ•…éšœåè‡ªåŠ¨è„±ç¦»é›†ç¾¤è¿™äº›æ“ä½œæ˜¯åˆ†å¸ƒå¼é›†ç¾¤ç®¡ç†æœ€åŸºæœ¬çš„åŠŸèƒ½ã€‚å¦‚æœé‡‡ç”¨å¸¸ç”¨çš„hash(object)%Nç®—æ³•ï¼Œé‚£ä¹ˆåœ¨æœ‰æœºå™¨æ·»åŠ æˆ–è€…åˆ é™¤åï¼Œå¾ˆå¤šåŸæœ‰çš„æ•°æ®å°±æ— æ³•æ‰¾åˆ°äº†ï¼Œè¿™æ—¶å€™ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•å°±ç«™å‡ºæ¥äº†ï¼<a id="more"></a></p>
<p><img src="https://ss0.bdstatic.com/94oJfD_bAAcT8t7mm9GUKT-xh_/timg?image&amp;quality=100&amp;size=b4000_4000&amp;sec=1545823709&amp;di=7aa416e5d990fbc2bf752ec187f3932a&amp;src=http://b-ssl.duitang.com/uploads/item/201702/26/20170226001149_Jxmeh.jpeg" alt="curry"></p>
<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>ä¸€è‡´æ€§hashç®—æ³•åœ¨1997å¹´ç”±éº»çœç†å·¥å­¦é™¢æå‡ºçš„ä¸€ç§åˆ†å¸ƒå¼å“ˆå¸Œï¼ˆDHTï¼‰å®ç°ç®—æ³•ï¼Œè®¾è®¡ç›®æ ‡æ˜¯ä¸ºäº†è§£å†³å› ç‰¹ç½‘ä¸­çš„çƒ­ç‚¹(Hot spot)é—®é¢˜ï¼Œåˆè¡·å’ŒCARPååˆ†ç±»ä¼¼ã€‚ä¸€è‡´æ€§hashä¿®æ­£äº†CARPä½¿ç”¨çš„ç®€ å•å“ˆå¸Œç®—æ³•å¸¦æ¥çš„é—®é¢˜ï¼Œä½¿å¾—åˆ†å¸ƒå¼å“ˆå¸Œï¼ˆDHTï¼‰å¯ä»¥åœ¨P2Pç¯å¢ƒä¸­çœŸæ­£å¾—åˆ°åº”ç”¨ã€‚ </p>
<h1 id="å››ä¸ªå®šä¹‰"><a href="#å››ä¸ªå®šä¹‰" class="headerlink" title="å››ä¸ªå®šä¹‰"></a>å››ä¸ªå®šä¹‰</h1><p>äº†åœ¨åŠ¨æ€å˜åŒ–çš„Cacheç¯å¢ƒä¸­ï¼Œåˆ¤å®šå“ˆå¸Œç®—æ³•å¥½åçš„å››ä¸ªå®šä¹‰ï¼š</p>
<h2 id="å¹³è¡¡æ€§-Balance"><a href="#å¹³è¡¡æ€§-Balance" class="headerlink" title="å¹³è¡¡æ€§(Balance)"></a>å¹³è¡¡æ€§(Balance)</h2><p>å¹³è¡¡æ€§æ˜¯æŒ‡å“ˆå¸Œçš„ç»“æœèƒ½å¤Ÿå°½å¯èƒ½åˆ†å¸ƒåˆ°æ‰€æœ‰çš„ç¼“å†²ä¸­å»ï¼Œè¿™æ ·å¯ä»¥ä½¿å¾—æ‰€æœ‰çš„ç¼“å†²ç©ºé—´éƒ½å¾—åˆ°åˆ©ç”¨ã€‚å¾ˆå¤šå“ˆå¸Œç®—æ³•éƒ½èƒ½å¤Ÿæ»¡è¶³è¿™ä¸€æ¡ä»¶ã€‚</p>
<h2 id="å•è°ƒæ€§-Monotonicity"><a href="#å•è°ƒæ€§-Monotonicity" class="headerlink" title="å•è°ƒæ€§(Monotonicity)"></a>å•è°ƒæ€§(Monotonicity)</h2><p><strong>å•è°ƒæ€§æ˜¯æŒ‡å¦‚æœå·²ç»æœ‰ä¸€äº›å†…å®¹é€šè¿‡å“ˆå¸Œåˆ†æ´¾åˆ°äº†ç›¸åº”çš„ç¼“å†²ä¸­ï¼Œåˆæœ‰æ–°çš„ç¼“å†²åŠ å…¥åˆ°ç³»ç»Ÿä¸­ï¼Œå“ˆå¸Œçš„ç»“æœåº”èƒ½å¤Ÿä¿è¯åŸæœ‰å·²åˆ†é…çš„å†…å®¹å¯ä»¥è¢«æ˜ å°„åˆ°åŸæœ‰çš„æˆ–è€…æ–°çš„ç¼“å†²ä¸­å»ï¼Œè€Œä¸ä¼šè¢«æ˜ å°„åˆ°æ—§çš„ç¼“å†²é›†åˆä¸­çš„å…¶ä»–ç¼“å†²åŒºã€‚</strong></p>
<h2 id="åˆ†æ•£æ€§-Spread"><a href="#åˆ†æ•£æ€§-Spread" class="headerlink" title="åˆ†æ•£æ€§(Spread)"></a>åˆ†æ•£æ€§(Spread)</h2><p>åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼Œå½“ç»ˆç«¯å¸Œæœ›é€šè¿‡å“ˆå¸Œè¿‡ç¨‹å°†å†…å®¹æ˜ å°„åˆ°ç¼“å†²ä¸Šæ—¶ï¼Œç”±äºä¸åŒç»ˆç«¯æ‰€è§çš„ç¼“å†²èŒƒå›´æœ‰å¯èƒ½ä¸åŒï¼Œä»è€Œå¯¼è‡´å“ˆå¸Œçš„ç»“æœä¸ä¸€è‡´ï¼Œæœ€ç»ˆçš„ç»“æœæ˜¯ç›¸åŒçš„å†…å®¹è¢«ä¸åŒçš„ç»ˆç«¯æ˜ å°„åˆ°ä¸åŒçš„ç¼“å†²åŒºä¸­ã€‚è¿™ç§æƒ…å†µæ˜¾ç„¶æ˜¯åº”è¯¥é¿å…çš„ã€‚</p>
<h2 id="è´Ÿè½½å‡è¡¡-Load"><a href="#è´Ÿè½½å‡è¡¡-Load" class="headerlink" title="è´Ÿè½½å‡è¡¡(Load)"></a>è´Ÿè½½å‡è¡¡(Load)</h2><p>è´Ÿè½½å‡è¡¡å®é™…ä¸Šæ˜¯ä»å¦ä¸€ä¸ªè§’åº¦çœ‹å¾…åˆ†æ•£æ€§é—®é¢˜ã€‚æ—¢ç„¶ä¸åŒçš„ç»ˆç«¯å¯èƒ½å°†ç›¸åŒçš„å†…å®¹æ˜ å°„åˆ°ä¸åŒçš„ç¼“å†²åŒºä¸­ï¼Œé‚£ä¹ˆå¯¹äºä¸€ä¸ªç‰¹å®šçš„ç¼“å†²åŒºè€Œè¨€ï¼Œä¹Ÿå¯èƒ½è¢«ä¸åŒçš„ç”¨æˆ·æ˜ å°„ä¸ºä¸åŒ çš„å†…å®¹ã€‚ä¸åˆ†æ•£æ€§ä¸€æ ·ï¼Œè¿™ç§æƒ…å†µä¹Ÿæ˜¯åº”å½“é¿å…çš„ã€‚</p>
<h1 id="ç»“æ„è®¾è®¡"><a href="#ç»“æ„è®¾è®¡" class="headerlink" title="ç»“æ„è®¾è®¡"></a>ç»“æ„è®¾è®¡</h1><h2 id="ç¯å½¢Hashç©ºé—´"><a href="#ç¯å½¢Hashç©ºé—´" class="headerlink" title="ç¯å½¢Hashç©ºé—´"></a>ç¯å½¢Hashç©ºé—´</h2><p>æŒ‰ç…§å¸¸ç”¨çš„hashç®—æ³•æ¥å°†å¯¹åº”çš„keyå“ˆå¸Œåˆ°ä¸€ä¸ªå…·æœ‰2^32æ¬¡æ–¹ä¸ªæ¡¶çš„ç©ºé—´ä¸­ï¼Œå³0~(2\^32)-1çš„æ•°å­—ç©ºé—´ä¸­ã€‚ç°åœ¨æˆ‘ä»¬å¯ä»¥å°†è¿™äº›æ•°å­—å¤´å°¾ç›¸è¿ï¼Œæƒ³è±¡æˆä¸€ä¸ªé—­åˆçš„ç¯å½¢ã€‚å¦‚ä¸‹å›¾ï¼š<br><img src="https://img-blog.csdn.net/20140411000507734?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvY3l3b3Nw/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="ring"></p>
<h2 id="æ•°æ®æ˜ å°„åˆ°ç¯ä¸Š"><a href="#æ•°æ®æ˜ å°„åˆ°ç¯ä¸Š" class="headerlink" title="æ•°æ®æ˜ å°„åˆ°ç¯ä¸Š"></a>æ•°æ®æ˜ å°„åˆ°ç¯ä¸Š</h2><p>ç°åœ¨æˆ‘ä»¬å°†object1ã€object2ã€object3ã€object4å››ä¸ªå¯¹è±¡é€šè¿‡ç‰¹å®šçš„Hashå‡½æ•°è®¡ç®—å‡ºå¯¹åº”çš„keyå€¼ï¼Œç„¶åæ•£åˆ—åˆ°Hashç¯ä¸Šã€‚å¦‚ä¸‹å›¾:<br><img src="https://img-blog.csdn.net/20140411000620656?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvY3l3b3Nw/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="data-ring"></p>
<h2 id="æœºå™¨æ˜ å°„åˆ°ç¯ä¸Š"><a href="#æœºå™¨æ˜ å°„åˆ°ç¯ä¸Š" class="headerlink" title="æœºå™¨æ˜ å°„åˆ°ç¯ä¸Š"></a>æœºå™¨æ˜ å°„åˆ°ç¯ä¸Š</h2><p>ç°åœ¨æˆ‘ä»¬å°†NODE1ï¼ŒNODE2ï¼ŒNODE3ä¸‰å°æœºå™¨ï¼Œé€šè¿‡Hashç®—æ³•å¾—åˆ°å¯¹åº”çš„KEYå€¼ï¼Œæ˜ å°„åˆ°ç¯ä¸­ï¼Œå¦‚ä¸‹å›¾ï¼š<br><img src="https://img-blog.csdn.net/20140411000853609?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvY3l3b3Nw/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="mechine-ring"></p>
<h1 id="æ€§è´¨ç»´æŠ¤"><a href="#æ€§è´¨ç»´æŠ¤" class="headerlink" title="æ€§è´¨ç»´æŠ¤"></a>æ€§è´¨ç»´æŠ¤</h1><p>é€šè¿‡hashå‡½æ•°æ»¡è¶³åˆ†æ•£æ€§å’Œè´Ÿè½½å‡è¡¡æ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œä¸‹é¢æˆ‘ä»¬é‡ç‚¹åˆ†æå•è°ƒæ€§å’Œå¹³è¡¡æ€§ã€‚</p>
<h2 id="å•è°ƒæ€§"><a href="#å•è°ƒæ€§" class="headerlink" title="å•è°ƒæ€§"></a>å•è°ƒæ€§</h2><p>æˆ‘ä»¬çœ‹ä¸‹é¢ä¸¤ç§æƒ…å†µï¼š</p>
<h3 id="æœºå™¨çš„æ·»åŠ "><a href="#æœºå™¨çš„æ·»åŠ " class="headerlink" title="æœºå™¨çš„æ·»åŠ "></a>æœºå™¨çš„æ·»åŠ </h3><p>å¦‚æœå¾€é›†ç¾¤ä¸­æ·»åŠ ä¸€ä¸ªæ–°çš„èŠ‚ç‚¹NODE4ï¼Œé€šè¿‡å¯¹åº”çš„å“ˆå¸Œç®—æ³•å¾—åˆ°KEY4ï¼Œå¹¶æ˜ å°„åˆ°ç¯ä¸­ï¼Œå¦‚ä¸‹å›¾<br><img src="https://img-blog.csdn.net/20140411001211062?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvY3l3b3Nw/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="machine-add"><br>æŒ‰ç…§å¾€é¡ºæ—¶é’ˆè¿ç§»çš„è§„åˆ™ï¼Œé‚£ä¹ˆobject2å°†è¢«è¿ç§»åˆ°äº†NODE4ä¸­ï¼Œå…¶å®ƒå¯¹è±¡è¿˜ä¿æŒè¿™åŸæœ‰çš„å­˜å‚¨ä½ç½®ã€‚</p>
<h3 id="æœºå™¨çš„åˆ é™¤"><a href="#æœºå™¨çš„åˆ é™¤" class="headerlink" title="æœºå™¨çš„åˆ é™¤"></a>æœºå™¨çš„åˆ é™¤</h3><p>å¦‚æœNODE2å› ä¸ºæ•…éšœè¢«åˆ é™¤äº†ï¼Œå¦‚ä¸‹å›¾ï¼š<br><img src="https://img-blog.csdn.net/20140411001033656?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvY3l3b3Nw/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="machine-remove"><br>æŒ‰ç…§å¾€é¡ºæ—¶é’ˆè¿ç§»çš„è§„åˆ™ï¼Œobject3å°†ä¼šè¢«è¿ç§»åˆ°NODE3ä¸­ï¼Œè¿™æ ·ä»…ä»…æ˜¯object3çš„æ˜ å°„ä½ç½®å‘ç”Ÿäº†å˜åŒ–ï¼Œå…¶å®ƒçš„å¯¹è±¡æ²¡æœ‰ä»»ä½•çš„æ”¹åŠ¨ã€‚</p>
<p>é€šè¿‡å¯¹èŠ‚ç‚¹çš„æ·»åŠ å’Œåˆ é™¤çš„åˆ†æï¼Œä¸€è‡´æ€§å“ˆå¸Œç®—æ³•åœ¨ä¿æŒäº†å•è°ƒæ€§çš„åŒæ—¶ï¼Œæ•°æ®çš„è¿ç§»é‡è¾¾åˆ°äº†æœ€å°ï¼Œè¿™æ ·çš„ç®—æ³•å¯¹åˆ†å¸ƒå¼é›†ç¾¤æ¥è¯´æ˜¯éå¸¸åˆé€‚çš„ï¼Œé¿å…äº†å¤§é‡æ•°æ®è¿ç§»ï¼Œå‡å°äº†æœåŠ¡å™¨çš„çš„å‹åŠ›ã€‚</p>
<h2 id="å¹³è¡¡æ€§"><a href="#å¹³è¡¡æ€§" class="headerlink" title="å¹³è¡¡æ€§"></a>å¹³è¡¡æ€§</h2><p>å¦‚æœä¸Šé¢åªéƒ¨ç½²äº†NODE1å’ŒNODE3ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œobject1å­˜å‚¨åˆ°äº†NODE1ä¸­ï¼Œè€Œobject2ã€object3ã€object4éƒ½å­˜å‚¨åˆ°äº†NODE3ä¸­ï¼Œè¿™æ ·å°±ç…§æˆäº†<strong>éå¸¸ä¸å¹³è¡¡</strong>çš„çŠ¶æ€ã€‚åœ¨ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ä¸­ï¼Œä¸ºäº†å°½å¯èƒ½çš„æ»¡è¶³å¹³è¡¡æ€§ï¼Œå…¶å¼•å…¥äº†è™šæ‹ŸèŠ‚ç‚¹ã€‚</p>
<p><strong>è™šæ‹ŸèŠ‚ç‚¹ï¼š</strong> æ˜¯å®é™…èŠ‚ç‚¹ï¼ˆæœºå™¨ï¼‰åœ¨ hash ç©ºé—´çš„å¤åˆ¶å“ï¼ˆ replica ï¼‰ï¼Œä¸€å®é™…ä¸ªèŠ‚ç‚¹ï¼ˆæœºå™¨ï¼‰å¯¹åº”äº†è‹¥å¹²ä¸ªâ€œè™šæ‹ŸèŠ‚ç‚¹â€ï¼Œè¿™ä¸ªå¯¹åº”ä¸ªæ•°ä¹Ÿæˆä¸ºâ€œå¤åˆ¶ä¸ªæ•°â€ï¼Œâ€œè™šæ‹ŸèŠ‚ç‚¹â€åœ¨ hash ç©ºé—´ä¸­ä»¥hashå€¼å‡åŒ€æ’åˆ—ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬ä»¥2ä¸ªå‰¯æœ¬ï¼ˆå¤åˆ¶ä¸ªæ•°ï¼‰ä¸ºä¾‹ï¼Œè¿™æ ·æ•´ä¸ªhashç¯ä¸­å°±å­˜åœ¨äº†4ä¸ªè™šæ‹ŸèŠ‚ç‚¹ï¼Œæœ€åå¯¹è±¡æ˜ å°„çš„å…³ç³»å›¾å¦‚ä¸‹ï¼š<br><img src="https://img-blog.csdn.net/20140411001433375?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvY3l3b3Nw/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="machine-replica"></p>
<p>æ ¹æ®ä¸Šå›¾å¯çŸ¥å¯¹è±¡çš„æ˜ å°„å…³ç³»ï¼šobject1-&gt;NODE1-1ï¼Œobject2-&gt;NODE1-2ï¼Œobject3-&gt;NODE3-2ï¼Œobject4-&gt;NODE3-1ã€‚é€šè¿‡è™šæ‹ŸèŠ‚ç‚¹çš„å¼•å…¥ï¼Œå¯¹è±¡çš„åˆ†å¸ƒå°±æ¯”è¾ƒå‡è¡¡äº†ã€‚é‚£ä¹ˆåœ¨å®é™…æ“ä½œä¸­ï¼Œæ­£çœŸçš„å¯¹è±¡æŸ¥è¯¢æ˜¯å¦‚ä½•å·¥ä½œçš„å‘¢ï¼Ÿå¯¹è±¡ä»hashåˆ°è™šæ‹ŸèŠ‚ç‚¹åˆ°å®é™…èŠ‚ç‚¹çš„è½¬æ¢å¦‚ä¸‹å›¾ï¼š<br><img src="https://img-blog.csdn.net/20140411001540656?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvY3l3b3Nw/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="vitualNode-mapping"></p>
<h1 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h1><p>å¯ä»¥çœ‹ä¸€ä¸‹å‚è€ƒ2ã€‚</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol>
<li><a href="https://blog.csdn.net/cywosp/article/details/23397179" target="_blank" rel="noopener">æ¯å¤©è¿›æ­¥ä¸€ç‚¹ç‚¹â€”â€”äº”åˆ†é’Ÿç†è§£ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•(consistent hashing)</a> åŸå›¾æˆ³ç€ï¼ï¼ï¼</li>
<li><a href="https://www.cnblogs.com/xrq730/p/5186728.html" target="_blank" rel="noopener">å¯¹ä¸€è‡´æ€§Hashç®—æ³•ï¼ŒJavaä»£ç å®ç°çš„æ·±å…¥ç ”ç©¶</a></li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¼•ï¼šåœ¨åˆ†å¸ƒå¼é›†ç¾¤ä¸­ï¼Œå¯¹æœºå™¨çš„æ·»åŠ åˆ é™¤ï¼Œæˆ–è€…æœºå™¨æ•…éšœåè‡ªåŠ¨è„±ç¦»é›†ç¾¤è¿™äº›æ“ä½œæ˜¯åˆ†å¸ƒå¼é›†ç¾¤ç®¡ç†æœ€åŸºæœ¬çš„åŠŸèƒ½ã€‚å¦‚æœé‡‡ç”¨å¸¸ç”¨çš„hash(object)%Nç®—æ³•ï¼Œé‚£ä¹ˆåœ¨æœ‰æœºå™¨æ·»åŠ æˆ–è€…åˆ é™¤åï¼Œå¾ˆå¤šåŸæœ‰çš„æ•°æ®å°±æ— æ³•æ‰¾åˆ°äº†ï¼Œè¿™æ—¶å€™ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•å°±ç«™å‡ºæ¥äº†ï¼
    
    </summary>
    
      <category term="åˆ†å¸ƒå¼" scheme="http://bestlixiang.site/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
    
      <category term="consistent hashing algorithm" scheme="http://bestlixiang.site/tags/consistent-hashing-algorithm/"/>
    
  </entry>
  
  <entry>
    <title>Raftç®—æ³•</title>
    <link href="http://bestlixiang.site/2018/12/26/%E5%88%86%E5%B8%83%E5%BC%8F/Raft%E7%AE%97%E6%B3%95/"/>
    <id>http://bestlixiang.site/2018/12/26/åˆ†å¸ƒå¼/Raftç®—æ³•/</id>
    <published>2018-12-26T13:14:13.000Z</published>
    <updated>2018-12-26T11:31:52.151Z</updated>
    
    <content type="html"><![CDATA[<p>å¼•ï¼šå å‘ï¼ï¼ï¼ï¼ ä¸åŒäºPaxosç®—æ³•ç›´æ¥ä»åˆ†å¸ƒå¼ä¸€è‡´æ€§é—®é¢˜å‡ºå‘æ¨å¯¼å‡ºæ¥ï¼ŒRaftç®—æ³•åˆ™æ˜¯ä»å¤šå‰¯æœ¬çŠ¶æ€æœºçš„è§’åº¦æå‡ºï¼Œç”¨äºç®¡ç†å¤šå‰¯æœ¬çŠ¶æ€æœºçš„æ—¥å¿—å¤åˆ¶ã€‚è‡ªå·±ç›®å‰ä¹Ÿç†è§£å¾—è¿˜ä¸é€å½»ï¼Œæ‰€ä»¥ç•™ä¸‹é“¾æ¥ï¼Œå¾…åç»­åŠ æ·±ç†è§£ä¹‹åå†åšæ•´ç†ã€‚<a id="more"></a></p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol>
<li><a href="http://thesecretlivesofdata.com/raft/" target="_blank" rel="noopener">Raft: Understandable Distributed Consensus</a></li>
<li><a href="https://www.jianshu.com/p/096ae57d1fe0" target="_blank" rel="noopener">Raftä¸€è‡´æ€§ç®—æ³•ç¬”è®°</a></li>
<li><a href="https://www.jianshu.com/p/1f5cb602dc71" target="_blank" rel="noopener">åˆ†å¸ƒå¼ç³»ç»Ÿå­¦ä¹ 2-Raftç®—æ³•åˆ†æä¸å®ç°</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/32052223" target="_blank" rel="noopener">Raftç®—æ³•è¯¦è§£</a> [å¯ä»¥ç»§ç»­çœ‹ä»–çš„ç›¸å…³åšå®¢]</li>
<li><a href="https://github.com/wenweihu86/raft-java" target="_blank" rel="noopener">raft-java</a></li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¼•ï¼šå å‘ï¼ï¼ï¼ï¼ ä¸åŒäºPaxosç®—æ³•ç›´æ¥ä»åˆ†å¸ƒå¼ä¸€è‡´æ€§é—®é¢˜å‡ºå‘æ¨å¯¼å‡ºæ¥ï¼ŒRaftç®—æ³•åˆ™æ˜¯ä»å¤šå‰¯æœ¬çŠ¶æ€æœºçš„è§’åº¦æå‡ºï¼Œç”¨äºç®¡ç†å¤šå‰¯æœ¬çŠ¶æ€æœºçš„æ—¥å¿—å¤åˆ¶ã€‚è‡ªå·±ç›®å‰ä¹Ÿç†è§£å¾—è¿˜ä¸é€å½»ï¼Œæ‰€ä»¥ç•™ä¸‹é“¾æ¥ï¼Œå¾…åç»­åŠ æ·±ç†è§£ä¹‹åå†åšæ•´ç†ã€‚
    
    </summary>
    
      <category term="åˆ†å¸ƒå¼" scheme="http://bestlixiang.site/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
    
      <category term="Raft" scheme="http://bestlixiang.site/tags/Raft/"/>
    
  </entry>
  
  <entry>
    <title>Paxosç®—æ³•</title>
    <link href="http://bestlixiang.site/2018/12/26/%E5%88%86%E5%B8%83%E5%BC%8F/Paxos%E7%AE%97%E6%B3%95/"/>
    <id>http://bestlixiang.site/2018/12/26/åˆ†å¸ƒå¼/Paxosç®—æ³•/</id>
    <published>2018-12-26T10:14:13.000Z</published>
    <updated>2018-12-26T10:17:51.929Z</updated>
    
    <content type="html"><![CDATA[<p>å¼•ï¼šå å‘ï¼ï¼ï¼ï¼ Paxosç®—æ³•åœ¨åˆ†å¸ƒå¼é¢†åŸŸå…·æœ‰éå¸¸é‡è¦çš„åœ°ä½ã€‚Google Chubbyçš„ä½œè€…Mike Burrowsè¯´è¿‡è¿™ä¸ªä¸–ç•Œä¸Šåªæœ‰ä¸€ç§ä¸€è‡´æ€§ç®—æ³•ï¼Œé‚£å°±æ˜¯Paxosï¼Œå…¶å®ƒçš„ç®—æ³•éƒ½æ˜¯æ®‹æ¬¡å“ã€‚è‡ªå·±ç†è§£å¾—è¿˜ä¸é€å½»ï¼Œæ‰€ä»¥ç•™ä¸‹é“¾æ¥ï¼Œå¾…åç»­åŠ æ·±ç†è§£ä¹‹åå†åšæ•´ç†ã€‚<a id="more"></a></p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol>
<li>å€ªè¶…. ä» Paxos åˆ° ZooKeeper : åˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µ [M]. ç”µå­å·¥ä¸šå‡ºç‰ˆç¤¾, 2015.</li>
<li><a href="https://angus.nyc/2012/paxos-by-example/" target="_blank" rel="noopener">Paxos By Example</a></li>
<li><a href="https://www.cnblogs.com/linbingdong/p/6253479.html" target="_blank" rel="noopener">åˆ†å¸ƒå¼ç³»åˆ—æ–‡ç« â€”â€”Paxosç®—æ³•åŸç†ä¸æ¨å¯¼</a></li>
<li><a href="https://github.com/luohaha/MyPaxos" target="_blank" rel="noopener">MyPaxos</a></li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¼•ï¼šå å‘ï¼ï¼ï¼ï¼ Paxosç®—æ³•åœ¨åˆ†å¸ƒå¼é¢†åŸŸå…·æœ‰éå¸¸é‡è¦çš„åœ°ä½ã€‚Google Chubbyçš„ä½œè€…Mike Burrowsè¯´è¿‡è¿™ä¸ªä¸–ç•Œä¸Šåªæœ‰ä¸€ç§ä¸€è‡´æ€§ç®—æ³•ï¼Œé‚£å°±æ˜¯Paxosï¼Œå…¶å®ƒçš„ç®—æ³•éƒ½æ˜¯æ®‹æ¬¡å“ã€‚è‡ªå·±ç†è§£å¾—è¿˜ä¸é€å½»ï¼Œæ‰€ä»¥ç•™ä¸‹é“¾æ¥ï¼Œå¾…åç»­åŠ æ·±ç†è§£ä¹‹åå†åšæ•´ç†ã€‚
    
    </summary>
    
      <category term="åˆ†å¸ƒå¼" scheme="http://bestlixiang.site/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
    
      <category term="Paxos" scheme="http://bestlixiang.site/tags/Paxos/"/>
    
  </entry>
  
  <entry>
    <title>åˆ†å¸ƒå¼ç³»ç»ŸåŸºç¡€</title>
    <link href="http://bestlixiang.site/2018/12/26/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E5%9F%BA%E7%A1%80/"/>
    <id>http://bestlixiang.site/2018/12/26/åˆ†å¸ƒå¼/åˆ†å¸ƒå¼ç³»ç»ŸåŸºç¡€/</id>
    <published>2018-12-26T02:25:37.000Z</published>
    <updated>2018-12-26T06:08:14.367Z</updated>
    
    <content type="html"><![CDATA[<p>å¼•ï¼šè‡ªå·±è¿™ä¸€æ®µæ—¶é—´éƒ½åœ¨å­¦ä¹ åˆ†å¸ƒå¼ç³»ç»Ÿç›¸å…³çš„ä¸œè¥¿ï¼Œä½†æ˜¯éƒ½ä¸æˆç³»ç»Ÿï¼Œæ‰€ä»¥è¿™é‡Œå°†ä¼šæ€»ç»“ç›®å‰å­¦ä¹ çš„åˆ†å¸ƒå¼ç³»ç»Ÿç›¸å…³å†…å®¹ï¼Œè¿™é‡Œè®²ä¼šæ€»ç»“åˆ†å¸ƒå¼ç³»ç»Ÿçš„ç›¸å…³æ¦‚å¿µï¼ŒæŒç»­æ›´æ–°â€¦ã€‚<a id="more"></a></p>
<h1 id="CAPç†è®º"><a href="#CAPç†è®º" class="headerlink" title="CAPç†è®º"></a>CAPç†è®º</h1><p>2000å¹´7æœˆï¼ŒåŠ å·å¤§å­¦ä¼¯å…‹åˆ©åˆ†æ ¡çš„Eric Breweræ•™æˆåœ¨ACM PODCä¼šè®®ä¸Šæå‡ºCAPçŒœæƒ³ã€‚2å¹´åï¼Œéº»çœç†å·¥å­¦é™¢çš„Seth Gilbertå’ŒNancy Lynchä»ç†è®ºä¸Šè¯æ˜äº†CAPã€‚ä¹‹åï¼ŒCAPç†è®ºæ­£å¼æˆä¸ºåˆ†å¸ƒå¼è®¡ç®—é¢†åŸŸçš„å…¬è®¤å®šç†ã€‚</p>
<p>CAPç†è®ºä¸ºï¼šä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿæœ€å¤šåªèƒ½åŒæ—¶æ»¡è¶³ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ã€å¯ç”¨æ€§ï¼ˆAvailabilityï¼‰å’Œåˆ†åŒºå®¹é”™æ€§ï¼ˆPartition toleranceï¼‰è¿™ä¸‰é¡¹ä¸­çš„ä¸¤é¡¹ã€‚</p>
<p>ä¸‹é¢ä¸¾ä¸ªä¾‹å­ï¼š</p>
<p>å‡è®¾æœ‰ä¸¤å°æœºå™¨Aã€Bï¼Œä¸¤è€…ä¹‹é—´äº’ç›¸åŒæ­¥ä¿æŒæ•°æ®çš„ä¸€è‡´æ€§ã€‚ç°åœ¨Bç”±äºç½‘ç»œåŸå› ä¸èƒ½ä¸Aé€šä¿¡(Network Partition)ï¼Œå‡è®¾æŸä¸ªclientå‘Aå†™å…¥æ•°æ®ï¼Œç°åœ¨æœ‰ä¸¤ç§é€‰æ‹©ï¼š</p>
<ul>
<li>Aæ‹’ç»å†™å…¥ï¼Œè¿™æ ·èƒ½ä¿è¯ä¸Bçš„ä¸€è‡´æ€§ï¼Œä½†æ˜¯ç‰ºç‰²äº†å¯ç”¨æ€§</li>
<li>Aå…è®¸å†™å…¥ï¼Œä½†æ˜¯è¿™æ ·å°±ä¸èƒ½ä¿è¯ä¸Bçš„ä¸€è‡´æ€§äº†</li>
</ul>
<p>Network Partitionæ˜¯å¿…ç„¶çš„ï¼Œç½‘ç»œéå¸¸å¯èƒ½å‡ºç°é—®é¢˜ï¼ˆæ–­çº¿ã€è¶…æ—¶ï¼‰ï¼Œå› æ­¤CAPç†è®ºä¸€èˆ¬åªèƒ½APæˆ–CPï¼Œè€ŒCAä¸€èˆ¬è¾ƒéš¾å®ç°ã€‚</p>
<ul>
<li>CP: è¦å®ç°ä¸€è‡´æ€§ï¼Œåˆ™éœ€è¦ä¸€å®šçš„ä¸€è‡´æ€§ç®—æ³•ï¼Œä¸€èˆ¬æ˜¯åŸºäºå¤šæ•°æ´¾è¡¨å†³çš„ï¼Œå¦‚Paxoså’ŒRaft</li>
<li>AP: è¦å®ç°å¯ç”¨æ€§ï¼Œåˆ™è¦æœ‰ä¸€å®šçš„ç­–ç•¥å†³è®®åˆ°åº•ç”¨å“ªä¸ªæ•°æ®ï¼Œå¹¶ä¸”æ•°æ®ä¸€èˆ¬è¦è¿›è¡Œå†—ä½™å¤‡ä»½(replication)</li>
</ul>
<p>å½“ç„¶ï¼Œåœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼ŒAå¯ä»¥å…ˆå…è®¸å†™å…¥ï¼Œç­‰Bçš„ç½‘ç»œæ¢å¤ä»¥åå†åŒæ­¥è‡³Bï¼ˆæ ¹æ®CAPåŸç†è¿™æ ·ä¸èƒ½ä¿è¯å¼ºä¸€è‡´æ€§äº†ï¼Œä½†æ˜¯å¯ä»¥è€ƒè™‘å®ç°<strong>æœ€ç»ˆä¸€è‡´æ€§</strong>ï¼‰ã€‚</p>
<p>ä¸‹å›¾åˆšå¥½å±•ç¤ºäº†CA,CP,APç³»ç»Ÿæ˜¯å¦‚ä½•å®ç°çš„ï¼š</p>
<p><img src="http://book.mixu.net/distsys/images/CAP.png" alt="CAP"></p>
<ul>
<li>åˆ©ç”¨2PCåè®®å±äºCAï¼Œå¦‚ï¼Œmysqlç­‰ï¼Œä»–ä»¬ä¸»è¦é€šè¿‡å¤åˆ¶çš„æ–¹å¼æ¥ä¿è¯æ•°æ®çš„å®‰å…¨æ€§ã€‚</li>
<li>åˆ©ç”¨Gossipåè®®å±äºAPï¼Œå¦‚ï¼Œredis-clusterã€cassandraï¼ŒEurekaä»–ä»¬æ˜¯é€šè¿‡å®ç°â€œæœ€ç»ˆä¸€è‡´æ€§â€æ¥ä¿è¯APã€‚</li>
<li>åˆ©ç”¨Paxosåè®®å±äºCPï¼Œå¦‚redisï¼ˆå¤šmasterï¼‰ï¼Œhbaseï¼Œè¿™äº›æ•°æ®åº“é›†ç¾¤ï¼ŒèŠ‚ç‚¹æœ‰å¯èƒ½ä¼šå› ä¸ºæ— æ³•ç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§è€Œæ‹’ç»æä¾›æœåŠ¡ã€‚</li>
</ul>
<h1 id="BASEç†è®º"><a href="#BASEç†è®º" class="headerlink" title="BASEç†è®º"></a>BASEç†è®º</h1><p>BASEç†è®ºæ˜¯ç”±eBayçš„æ¶æ„å¸ˆDan Pritchettæºäºå¯¹å¤§è§„æ¨¡åˆ†å¸ƒå¼ç³»ç»Ÿçš„å®è·µæ€»ç»“ï¼Œåœ¨ACMä¸Šå‘è¡¨æ–‡ç« æå‡ºBASEç†è®ºï¼ŒBASEç†è®ºæ˜¯å¯¹CAPç†è®ºçš„å»¶ä¼¸ï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯å³ä½¿æ— æ³•åšåˆ°å¼ºä¸€è‡´æ€§ï¼ˆStrong Consistencyï¼ŒCAPçš„ä¸€è‡´æ€§å°±æ˜¯å¼ºä¸€è‡´æ€§ï¼‰ï¼Œä½†åº”ç”¨å¯ä»¥é‡‡ç”¨é€‚åˆçš„æ–¹å¼è¾¾åˆ°æœ€ç»ˆä¸€è‡´æ€§ï¼ˆEventual Consitencyï¼‰ã€‚</p>
<p>BASEç†è®ºä¸ºï¼šåŸºæœ¬å¯ç”¨ï¼ˆBasically Availableï¼‰ã€è½¯çŠ¶æ€ï¼ˆ Soft Stateï¼‰ã€æœ€ç»ˆä¸€è‡´æ€§ï¼ˆ Eventual Consistencyï¼‰ã€‚</p>
<h2 id="åŸºæœ¬å¯ç”¨"><a href="#åŸºæœ¬å¯ç”¨" class="headerlink" title="åŸºæœ¬å¯ç”¨"></a>åŸºæœ¬å¯ç”¨</h2><p>åŸºæœ¬å¯ç”¨æ˜¯æŒ‡åˆ†å¸ƒå¼ç³»ç»Ÿåœ¨å‡ºç°æ•…éšœçš„æ—¶å€™ï¼Œå…è®¸æŸå¤±éƒ¨åˆ†å¯ç”¨æ€§ï¼Œå³ä¿è¯æ ¸å¿ƒå¯ç”¨ã€‚</p>
<p>ç”µå•†å¤§ä¿ƒæ—¶ï¼Œä¸ºäº†åº”å¯¹è®¿é—®é‡æ¿€å¢ï¼Œéƒ¨åˆ†ç”¨æˆ·å¯èƒ½ä¼šè¢«å¼•å¯¼åˆ°é™çº§é¡µé¢ï¼ŒæœåŠ¡å±‚ä¹Ÿå¯èƒ½åªæä¾›é™çº§æœåŠ¡ã€‚è¿™å°±æ˜¯æŸå¤±éƒ¨åˆ†å¯ç”¨æ€§çš„ä½“ç°ã€‚</p>
<h2 id="è½¯çŠ¶æ€"><a href="#è½¯çŠ¶æ€" class="headerlink" title="è½¯çŠ¶æ€"></a>è½¯çŠ¶æ€</h2><p>è½¯çŠ¶æ€æ˜¯æŒ‡å…è®¸ç³»ç»Ÿå­˜åœ¨ä¸­é—´çŠ¶æ€ï¼Œè€Œè¯¥ä¸­é—´çŠ¶æ€ä¸ä¼šå½±å“ç³»ç»Ÿæ•´ä½“å¯ç”¨æ€§ã€‚</p>
<p>åˆ†å¸ƒå¼å­˜å‚¨ä¸­ä¸€èˆ¬ä¸€ä»½æ•°æ®è‡³å°‘ä¼šæœ‰ä¸‰ä¸ªå‰¯æœ¬ï¼Œå…è®¸ä¸åŒèŠ‚ç‚¹é—´å‰¯æœ¬åŒæ­¥çš„å»¶æ—¶å°±æ˜¯è½¯çŠ¶æ€çš„ä½“ç°ã€‚mysql replicationçš„å¼‚æ­¥å¤åˆ¶ä¹Ÿæ˜¯ä¸€ç§ä½“ç°ã€‚</p>
<h2 id="æœ€ç»ˆä¸€è‡´æ€§"><a href="#æœ€ç»ˆä¸€è‡´æ€§" class="headerlink" title="æœ€ç»ˆä¸€è‡´æ€§"></a>æœ€ç»ˆä¸€è‡´æ€§</h2><p>æœ€ç»ˆä¸€è‡´æ€§æ˜¯æŒ‡ç³»ç»Ÿä¸­çš„æ‰€æœ‰æ•°æ®å‰¯æœ¬ç»è¿‡ä¸€å®šæ—¶é—´åï¼Œæœ€ç»ˆèƒ½å¤Ÿè¾¾åˆ°ä¸€è‡´çš„çŠ¶æ€ã€‚å¼±ä¸€è‡´æ€§å’Œå¼ºä¸€è‡´æ€§ç›¸åï¼Œæœ€ç»ˆä¸€è‡´æ€§æ˜¯å¼±ä¸€è‡´æ€§çš„ä¸€ç§ç‰¹æ®Šæƒ…å†µã€‚</p>
<h2 id="ACIDå’ŒBASEçš„åŒºåˆ«ä¸è”ç³»"><a href="#ACIDå’ŒBASEçš„åŒºåˆ«ä¸è”ç³»" class="headerlink" title="ACIDå’ŒBASEçš„åŒºåˆ«ä¸è”ç³»"></a>ACIDå’ŒBASEçš„åŒºåˆ«ä¸è”ç³»</h2><p>ACIDæ˜¯ä¼ ç»Ÿæ•°æ®åº“å¸¸ç”¨çš„è®¾è®¡ç†å¿µï¼Œè¿½æ±‚<strong>å¼ºä¸€è‡´æ€§æ¨¡å‹</strong>ã€‚</p>
<p>BASEæ”¯æŒçš„æ˜¯å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œç‰ºç‰²æ‰å¯¹ä¸€è‡´æ€§çš„çº¦æŸï¼ˆä½†å®ç°<strong>æœ€ç»ˆä¸€è‡´æ€§</strong>ï¼‰ï¼Œæ¥æ¢å–ä¸€å®šçš„å¯ç”¨æ€§ã€‚</p>
<p>ACIDå’ŒBASEä»£è¡¨äº†ä¸¤ç§æˆªç„¶ç›¸åçš„è®¾è®¡å“²å­¦ã€‚</p>
<p>åœ¨è‹±æ–‡ä¸­ï¼ŒACIDå’ŒBASEåˆ†åˆ«æ˜¯â€œé…¸â€å’Œâ€œç¢±â€ï¼Œçœ‹ä¼¼å¯¹ç«‹ï¼Œå®åˆ™æ˜¯åˆ†åˆ«å¯¹CAPä¸‰ç‰¹æ€§çš„ä¸åŒå–èˆã€‚åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡çš„åœºæ™¯ä¸­ï¼Œç³»ç»Ÿç»„ä»¶å¯¹ä¸€è‡´æ€§è¦æ±‚æ˜¯ä¸åŒçš„ï¼Œå› æ­¤ACIDå’ŒBASEåˆä¼šç»“åˆä½¿ç”¨ã€‚</p>
<h1 id="FLP-Impossibility"><a href="#FLP-Impossibility" class="headerlink" title="FLP Impossibility"></a>FLP Impossibility</h1><h1 id="Leaseæœºåˆ¶"><a href="#Leaseæœºåˆ¶" class="headerlink" title="Leaseæœºåˆ¶"></a>Leaseæœºåˆ¶</h1><h1 id="Quorumæœºåˆ¶"><a href="#Quorumæœºåˆ¶" class="headerlink" title="Quorumæœºåˆ¶"></a>Quorumæœºåˆ¶</h1><h1 id="Consensusé—®é¢˜"><a href="#Consensusé—®é¢˜" class="headerlink" title="Consensusé—®é¢˜"></a>Consensusé—®é¢˜</h1><h1 id="æ—¶åºé—®é¢˜"><a href="#æ—¶åºé—®é¢˜" class="headerlink" title="æ—¶åºé—®é¢˜"></a>æ—¶åºé—®é¢˜</h1><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol>
<li><a href="https://www.sczyh30.com/posts/Distributed-System/distributed-system-base/#%E6%8B%9C%E5%8D%A0%E5%BA%AD%E5%B0%86%E5%86%9B%E9%97%AE%E9%A2%98" target="_blank" rel="noopener">åˆ†å¸ƒå¼ç³»ç»ŸåŸºç¡€æ€»ç»“</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/35608244" target="_blank" rel="noopener">åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„FLPä¸å¯èƒ½åŸç†ã€CAPç†è®ºä¸BASEç†è®º</a></li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¼•ï¼šè‡ªå·±è¿™ä¸€æ®µæ—¶é—´éƒ½åœ¨å­¦ä¹ åˆ†å¸ƒå¼ç³»ç»Ÿç›¸å…³çš„ä¸œè¥¿ï¼Œä½†æ˜¯éƒ½ä¸æˆç³»ç»Ÿï¼Œæ‰€ä»¥è¿™é‡Œå°†ä¼šæ€»ç»“ç›®å‰å­¦ä¹ çš„åˆ†å¸ƒå¼ç³»ç»Ÿç›¸å…³å†…å®¹ï¼Œè¿™é‡Œè®²ä¼šæ€»ç»“åˆ†å¸ƒå¼ç³»ç»Ÿçš„ç›¸å…³æ¦‚å¿µï¼ŒæŒç»­æ›´æ–°â€¦ã€‚
    
    </summary>
    
      <category term="åˆ†å¸ƒå¼" scheme="http://bestlixiang.site/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
    
      <category term="åˆ†å¸ƒå¼" scheme="http://bestlixiang.site/tags/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>Macç‰ˆç™¾åº¦ç½‘ç›˜é£é€Ÿä¸‹è½½</title>
    <link href="http://bestlixiang.site/2018/10/31/%E5%B7%A5%E5%85%B7/Mac%E7%89%88%E7%99%BE%E5%BA%A6%E7%BD%91%E7%9B%98%E9%A3%9E%E9%80%9F%E4%B8%8B%E8%BD%BD/"/>
    <id>http://bestlixiang.site/2018/10/31/å·¥å…·/Macç‰ˆç™¾åº¦ç½‘ç›˜é£é€Ÿä¸‹è½½/</id>
    <published>2018-10-31T00:17:46.000Z</published>
    <updated>2018-10-31T00:21:36.636Z</updated>
    
    <content type="html"><![CDATA[<p>å¼•ï¼šç™¾åº¦ç½‘ç›˜ä¸Šæœ‰å¾ˆå¤šèµ„æºï¼Œä¹‹å‰åœ¨Macä¸Šä¸€ç›´æ²¡æœ‰æ‰¾åˆ°å¥½çš„åŠ é€Ÿæ–¹æ³•æˆ–è€…ç ´è§£è½¯ä»¶ï¼Œè¿™æ¬¡ç»ˆäºæ‰¾åˆ°äº†ï¼Œè¯·é€Ÿé€Ÿæˆ³è¿›æ¥ï¼ï¼<a id="more"></a></p>
<h1 id="é¡¹ç›®åœ°å€"><a href="#é¡¹ç›®åœ°å€" class="headerlink" title="é¡¹ç›®åœ°å€"></a>é¡¹ç›®åœ°å€</h1><p><a href="https://github.com/proxyee-down-org/proxyee-down" target="_blank" rel="noopener">Proxyee Down</a></p>
<p>Proxyee Down æ˜¯ä¸€æ¬¾å¼€æºçš„å…è´¹ HTTP é«˜é€Ÿä¸‹è½½å™¨ï¼Œåº•å±‚ä½¿ç”¨<code>netty</code>å¼€å‘ï¼Œæ”¯æŒè‡ªå®šä¹‰ HTTP è¯·æ±‚ä¸‹è½½ä¸”æ”¯æŒæ‰©å±•åŠŸèƒ½ï¼Œå¯ä»¥é€šè¿‡å®‰è£…æ‰©å±•å®ç°ç‰¹æ®Šçš„ä¸‹è½½éœ€æ±‚ã€‚</p>
<h1 id="æœ€è¿‘è§†é¢‘æ•™ç¨‹"><a href="#æœ€è¿‘è§†é¢‘æ•™ç¨‹" class="headerlink" title="æœ€è¿‘è§†é¢‘æ•™ç¨‹"></a>æœ€è¿‘è§†é¢‘æ•™ç¨‹</h1><p>ä»¥åä¹Ÿå¯èƒ½å°±ä¸æ–°äº†ï¼ï¼</p>
<p><a href="https://www.youtube.com/watch?v=ecZqKGaKIck" target="_blank" rel="noopener">å¿«å¿«ä¿å­˜ï¼Œ2018æœ€æ–°ç™¾åº¦äº‘ä¸é™åˆ¶æ–¹æ³•proxyee down-2018.9.19ï¼Œäº²æµ‹é€Ÿåº¦è¾¾10M</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¼•ï¼šç™¾åº¦ç½‘ç›˜ä¸Šæœ‰å¾ˆå¤šèµ„æºï¼Œä¹‹å‰åœ¨Macä¸Šä¸€ç›´æ²¡æœ‰æ‰¾åˆ°å¥½çš„åŠ é€Ÿæ–¹æ³•æˆ–è€…ç ´è§£è½¯ä»¶ï¼Œè¿™æ¬¡ç»ˆäºæ‰¾åˆ°äº†ï¼Œè¯·é€Ÿé€Ÿæˆ³è¿›æ¥ï¼ï¼
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>JDKæºç åˆ†æâ€”â€”ReentrantReadWriteLock</title>
    <link href="http://bestlixiang.site/2018/09/13/JDK%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/JDK%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E2%80%94%E2%80%94ReentrantReadWriteLock/"/>
    <id>http://bestlixiang.site/2018/09/13/JDKæºç åˆ†æ/JDKæºç åˆ†æâ€”â€”ReentrantReadWriteLock/</id>
    <published>2018-09-13T06:51:39.000Z</published>
    <updated>2018-09-13T10:15:06.003Z</updated>
    
    <content type="html"><![CDATA[<p>å¼•ï¼šè¯»å†™åˆ†ç¦»æ˜¯è§£å†³å¹¶å‘ç“¶é¢ˆçš„å¸¸ç”¨ç­–ç•¥ï¼Œåœ¨Javaä¸­ä¹Ÿæœ‰å…¶å®ç°â€”â€”ReentrantReadWriteLockï¼Œå®ƒèƒ½å¤Ÿæœ‰æ•ˆçš„æé«˜è¯»æ¯”å†™å¤šçš„åœºæ™¯ä¸‹çš„ç¨‹åºæ€§èƒ½ã€‚<a id="more"></a></p>
<h1 id="æ¦‚è§ˆ"><a href="#æ¦‚è§ˆ" class="headerlink" title="æ¦‚è§ˆ"></a>æ¦‚è§ˆ</h1><p>ReentrantReadWriteLockæ˜¯é€šè¿‡ä¸¤æŠŠé”å®ç°è¯»å†™åˆ†ç¦»çš„ï¼Œåˆ†åˆ«æ˜¯è¯»é”å’Œå†™é”ã€‚å®ƒçš„æºç å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReentrantReadWriteLock</span> <span class="keyword">implements</span> <span class="title">ReadWriteLock</span>, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯»é”</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReentrantReadWriteLock.ReadLock readerLock;</span><br><span class="line">    <span class="comment">// å†™é”</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReentrantReadWriteLock.WriteLock writerLock;</span><br><span class="line">    <span class="comment">// åŒæ­¥å™¨</span></span><br><span class="line">    <span class="keyword">final</span> Sync sync;</span><br></pre></td></tr></table></figure></p>
<h1 id="å†™é”"><a href="#å†™é”" class="headerlink" title="å†™é”"></a>å†™é”</h1><p>å†™é”ä¸»è¦æ˜¯é€šè¿‡é‡å†™åŒæ­¥å™¨çš„tryAcquireå’ŒtryReleaseå®ç°ï¼Œå…¶ä»–é€»è¾‘éƒ½å¯ä»¥å‚è€ƒAQSçš„è§£æã€‚</p>
<h2 id="tryAcquire"><a href="#tryAcquire" class="headerlink" title="tryAcquire"></a>tryAcquire</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Sync</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SHARED_SHIFT   = <span class="number">16</span>;</span><br><span class="line"><span class="comment">// é‡å…¥æœ€å¤§æ¬¡æ•°</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_COUNT      = (<span class="number">1</span> &lt;&lt; SHARED_SHIFT) - <span class="number">1</span>;</span><br><span class="line"><span class="comment">// ç‹¬å é”ï¼ˆå†™é”ï¼‰æ©ç </span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> EXCLUSIVE_MASK = (<span class="number">1</span> &lt;&lt; SHARED_SHIFT) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    Thread current = Thread.currentThread();</span><br><span class="line">    <span class="keyword">int</span> c = getState();</span><br><span class="line">    <span class="comment">// ç”¨ state &amp; 65535 å¾—åˆ°ä½ 16 ä½çš„å€¼</span></span><br><span class="line">    <span class="keyword">int</span> w = exclusiveCount(c);</span><br><span class="line">    <span class="keyword">if</span> (c != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// (Note: if c != 0 and w == 0 then shared count != 0)</span></span><br><span class="line">        <span class="comment">// å¦‚æœ state ä¸æ˜¯0ï¼Œä¸”ä½16ä½æ˜¯0ï¼Œè¯´æ˜å†™é”æ˜¯ç©ºé—²çš„ï¼Œè¯»é”è¢«éœ¸å äº†ã€‚é‚£ä¹ˆä¹Ÿä¸èƒ½æ‹¿é”ï¼Œè¿”å› fasleã€‚ä¿è¯äº†è¯»çš„æ—¶å€™ä¸èƒ½å†™ã€‚</span></span><br><span class="line">        <span class="comment">// å¦‚æœä½ 16 ä½ä¸æ˜¯0ï¼Œè¯´æ˜å†™é”è¢«éœ¸å äº†ï¼Œæ­¤æ—¶å¦‚æœæŒæœ‰é”çš„ä¸æ˜¯å½“å‰çº¿ç¨‹ï¼Œé‚£ä¹ˆè¿™æ¬¡æ‹¿é”æ˜¯å¤±è´¥çš„ã€‚è¿”å› fasleã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (w == <span class="number">0</span> || current != getExclusiveOwnerThread())</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">// è¿™é‡Œæ—¶å€™åº”è¯¥æ˜¯å†™é‡å…¥é”ï¼Œå¦‚æœå†™é‡å…¥æ¬¡æ•°è¶…è¿‡æœ€å¤§å€¼ 65535ï¼Œå°±ä¼šæº¢å‡º</span></span><br><span class="line">        <span class="keyword">if</span> (w + exclusiveCount(acquires) &gt; MAX_COUNT)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Maximum lock count exceeded"</span>);</span><br><span class="line">        <span class="comment">// Reentrant acquire</span></span><br><span class="line">        setState(c + acquires);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// writerShouldBlock åˆ¤æ–­æ˜¯å¦åº”è¯¥é˜»å¡</span></span><br><span class="line">    <span class="comment">// 1. å…¬å¹³é”æƒ…å†µä¸‹ï¼Œå¦‚æœé˜Ÿåˆ—ä¸­æœ‰ç­‰å¾…é”çš„çº¿ç¨‹ï¼Œåˆ™è¿”å›tureï¼Œåº”è¯¥é˜»å¡</span></span><br><span class="line">    <span class="comment">// 2. éå…¬å¹³é”æƒ…å†µä¸‹ï¼Œè¿”å›falseï¼Œä¸åº”è¯¥é˜»å¡ï¼Œç›´æ¥å‚ä¸ç«äº‰</span></span><br><span class="line">    <span class="keyword">if</span> (writerShouldBlock() ||</span><br><span class="line">        !compareAndSetState(c, c + acquires))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">// ç«äº‰åˆ°é”ï¼Œè®¾ç½®ç‹¬å çº¿ç¨‹</span></span><br><span class="line">    setExclusiveOwnerThread(current);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="tryRelease"><a href="#tryRelease" class="headerlink" title="tryRelease"></a>tryRelease</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryRelease</span><span class="params">(<span class="keyword">int</span> releases)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ˜¯å¦æŒæœ‰é”</span></span><br><span class="line">    <span class="keyword">if</span> (!isHeldExclusively())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</span><br><span class="line">    <span class="comment">// è®¾ç½®stateçŠ¶æ€</span></span><br><span class="line">    <span class="keyword">int</span> nextc = getState() - releases;</span><br><span class="line">    <span class="comment">// è®¡ç®—å†™é”çš„çŠ¶æ€ï¼ˆä½16ä½ï¼‰ï¼Œå¦‚æœæ˜¯0ï¼Œè¯´æ˜æ˜¯å¦æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">boolean</span> free = exclusiveCount(nextc) == <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (free)</span><br><span class="line">        setExclusiveOwnerThread(<span class="keyword">null</span>);</span><br><span class="line">    setState(nextc);</span><br><span class="line">    <span class="keyword">return</span> free;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="è¯»é”"><a href="#è¯»é”" class="headerlink" title="è¯»é”"></a>è¯»é”</h1><p>å†™é”ä¸»è¦æ˜¯é€šè¿‡é‡å†™åŒæ­¥å™¨çš„tryAcquireSharedå’ŒtryReleaseSharedå®ç°ï¼Œå…¶ä»–é€»è¾‘éƒ½å¯ä»¥å‚è€ƒAQSçš„è§£æã€‚</p>
<h2 id="tryAcquireShared"><a href="#tryAcquireShared" class="headerlink" title="tryAcquireShared"></a>tryAcquireShared</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Sync</span></span><br><span class="line"><span class="comment">// å…±äº«ï¼ˆè¯»é”ï¼‰é‡å…¥æ¬¡æ•°åŸºæ•°</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SHARED_UNIT    = (<span class="number">1</span> &lt;&lt; SHARED_SHIFT);</span><br><span class="line"><span class="comment">// ç¬¬ä¸€ä¸ªè·å¾—è¯»é”çš„çº¿ç¨‹</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> Thread firstReader = <span class="keyword">null</span>;</span><br><span class="line"><span class="comment">// ç¬¬ä¸€ä¸ªè·å¾—è¯»é”çš„çº¿ç¨‹çš„é‡å…¥æ¬¡æ•°è®¡æ•°å™¨</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">int</span> firstReaderHoldCount;</span><br><span class="line"><span class="comment">// æœ€åä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹çš„è®¡æ•°å™¨ï¼Œå­˜æ”¾åœ¨ThreadLocalä¸­</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> HoldCounter cachedHoldCounter;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">tryAcquireShared</span><span class="params">(<span class="keyword">int</span> unused)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    Thread current = Thread.currentThread();</span><br><span class="line">    <span class="keyword">int</span> c = getState();</span><br><span class="line">    <span class="comment">// ç”¨ state &amp; 65535 å¾—åˆ°ä½ 16 ä½çš„å€¼ ä¸ç­‰äº0ï¼Œå†™é”è¢«éœ¸å äº†</span></span><br><span class="line">    <span class="comment">// ä¸”</span></span><br><span class="line">    <span class="comment">// æŒæœ‰é”çš„ä¸æ˜¯å½“å‰çº¿ç¨‹</span></span><br><span class="line">    <span class="comment">// ä¿è¯äº†å†™çš„æ—¶å€™ä¸èƒ½è¯»</span></span><br><span class="line">    <span class="keyword">if</span> (exclusiveCount(c) != <span class="number">0</span> &amp;&amp;</span><br><span class="line">        getExclusiveOwnerThread() != current)</span><br><span class="line">        <span class="comment">// è·å–é”å¤±è´¥</span></span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// å¦‚æœå†™é”æ²¡æœ‰è¢«éœ¸å ï¼Œåˆ™å°†é«˜16ä½ç§»åˆ°ä½16ä½</span></span><br><span class="line">    <span class="keyword">int</span> r = sharedCount(c);</span><br><span class="line">    <span class="comment">// readerShouldBlockåˆ¤æ–­æ˜¯å¦åº”è¯¥é˜»å¡ å’Œå†™é”é€»è¾‘ä¸€è‡´</span></span><br><span class="line">    <span class="comment">// å†™é”é‡å…¥æ¬¡æ•°ä¸è¶…è¿‡æœ€å¤§å€¼ 65535</span></span><br><span class="line">    <span class="comment">// è®¾ç½®stateæˆåŠŸ (ç›¸å½“äºé«˜16ä½åŠ 1)</span></span><br><span class="line">    <span class="keyword">if</span> (!readerShouldBlock() &amp;&amp;</span><br><span class="line">        r &lt; MAX_COUNT &amp;&amp;</span><br><span class="line">        compareAndSetState(c, c + SHARED_UNIT)) &#123;</span><br><span class="line">        <span class="comment">// è¯»é”ç©ºé—²</span></span><br><span class="line">        <span class="keyword">if</span> (r == <span class="number">0</span>) &#123;</span><br><span class="line">            firstReader = current;</span><br><span class="line">            <span class="comment">// è®¡æ•°å™¨ä¸º1</span></span><br><span class="line">            firstReaderHoldCount = <span class="number">1</span>;</span><br><span class="line">            <span class="comment">// ç¬¬ä¸€ä¸ªè¯»çº¿ç¨‹æ˜¯å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (firstReader == current) &#123;</span><br><span class="line">            <span class="comment">// è®¡æ•°å™¨åŠ 1</span></span><br><span class="line">            firstReaderHoldCount++;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            HoldCounter rh = cachedHoldCounter;</span><br><span class="line">            <span class="comment">// å¦‚æœæœ€åä¸€ä¸ªçº¿ç¨‹è®¡æ•°å™¨æ˜¯ null æˆ–è€…ä¸æ˜¯å½“å‰çº¿ç¨‹</span></span><br><span class="line">            <span class="keyword">if</span> (rh == <span class="keyword">null</span> || rh.tid != getThreadId(current))</span><br><span class="line">                <span class="comment">// æ–°å»ºä¸€ä¸ª HoldCounter å¯¹è±¡</span></span><br><span class="line">                cachedHoldCounter = rh = readHolds.get();</span><br><span class="line">            <span class="comment">// å¦‚æœä¸æ˜¯ nullï¼Œä¸” count æ˜¯ 0</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (rh.count == <span class="number">0</span>)</span><br><span class="line">                <span class="comment">// å°±å°†ä¸Šä¸ªçº¿ç¨‹çš„ HoldCounter è¦†ç›–æœ¬åœ°çš„ï¼ˆæ€§èƒ½è€ƒè™‘ï¼Œç›¸å½“äºç¼“å­˜ï¼‰</span></span><br><span class="line">                readHolds.set(rh);</span><br><span class="line">            <span class="comment">// è®¡æ•°å™¨åŠ 1</span></span><br><span class="line">            rh.count++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è·å¾—é”æˆåŠŸ</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ­»å¾ªç¯è·å–è¯»é”ï¼Œå’ŒtryReleaseSharedé€»è¾‘ç±»ä¼¼ï¼Œåªæœ‰å¤šäº†æ­»å¾ªç¯</span></span><br><span class="line">    <span class="keyword">return</span> fullTryAcquireShared(current);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="é”é™çº§"><a href="#é”é™çº§" class="headerlink" title="é”é™çº§"></a>é”é™çº§</h2><p>åœ¨tryAcquireSharedè¿˜ä½“ç°äº†é”é™çº§çš„æ¦‚å¿µã€‚æ¦‚å¿µå¦‚ä¸‹ï¼š</p>
<p><strong><br>é‡å…¥è¿˜å…è®¸ä»å†™å…¥é”é™çº§ä¸ºè¯»å–é”ï¼Œå…¶å®ç°æ–¹å¼æ˜¯ï¼šå…ˆè·å–å†™å…¥é”ï¼Œç„¶åè·å–è¯»å–é”ï¼Œæœ€åé‡Šæ”¾å†™å…¥é”ã€‚ä½†æ˜¯ï¼Œä»è¯»å–é”å‡çº§åˆ°å†™å…¥é”æ˜¯ä¸å¯èƒ½çš„ã€‚</strong></p>
<p>ä½“ç°åœ¨ä»£ç ä¸­å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// tryAcquireShared æˆ–è€… fullTryAcquireSharedä¸­</span></span><br><span class="line"><span class="keyword">if</span> (exclusiveCount(c) != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (getExclusiveOwnerThread() != current)</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br></pre></td></tr></table></figure></p>
<p>ä¸Šé¢çš„ä»£ç å°±ä½“ç°å‡ºï¼šå½“å†™é”è¢«æŒæœ‰çš„æ—¶å€™ï¼Œå¦‚æœå½“å‰æ˜¯çº¿ç¨‹æ˜¯æŒæœ‰å†™é”çš„é‚£ä¸ªçº¿ç¨‹ï¼Œå¯ä»¥ç»§ç»­è·å¾—è¯»é”ã€‚</p>
<p>æ€»å¾—æ¥è¯´å°±æé«˜äº†æ€§èƒ½ã€‚</p>
<h2 id="tryReleaseShared"><a href="#tryReleaseShared" class="headerlink" title="tryReleaseShared"></a>tryReleaseShared</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å½“å‰çº¿ç¨‹é‡å…¥æ¬¡æ•°è®¡æ•°å™¨</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> ThreadLocalHoldCounter readHolds;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryReleaseShared</span><span class="params">(<span class="keyword">int</span> unused)</span> </span>&#123;</span><br><span class="line">    Thread current = Thread.currentThread();</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªçº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">if</span> (firstReader == current) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœæ˜¯ 1ï¼Œå°†ç¬¬ä¸€ä¸ªçº¿ç¨‹è®¾ç½®æˆ null</span></span><br><span class="line">        <span class="keyword">if</span> (firstReaderHoldCount == <span class="number">1</span>)</span><br><span class="line">            firstReader = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// å¦‚æœä¸æ˜¯ 1ï¼Œå‡ä¸€æ“ä½œ</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            firstReaderHoldCount--;</span><br><span class="line">    <span class="comment">// å¦‚æœä¸æ˜¯å½“å‰çº¿ç¨‹</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        HoldCounter rh = cachedHoldCounter;</span><br><span class="line">        <span class="comment">// å¦‚æœæœ€åä¸€ä¸ªçº¿ç¨‹è®¡æ•°å™¨æ˜¯ null æˆ–è€…ç¼“å­˜æ‰€å±çº¿ç¨‹ä¸æ˜¯å½“å‰çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">if</span> (rh == <span class="keyword">null</span> || rh.tid != getThreadId(current))</span><br><span class="line">            <span class="comment">// è·å–å½“å‰çº¿ç¨‹çš„è®¡æ•°å™¨</span></span><br><span class="line">            rh = readHolds.get();</span><br><span class="line">        <span class="keyword">int</span> count = rh.count;</span><br><span class="line">        <span class="comment">// å¦‚æœè®¡æ•°å™¨å°äºç­‰äºä¸€ï¼Œå°±ç›´æ¥åˆ é™¤è®¡æ•°å™¨</span></span><br><span class="line">        <span class="keyword">if</span> (count &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">            readHolds.remove();</span><br><span class="line">            <span class="keyword">if</span> (count &lt;= <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">throw</span> unmatchedUnlockException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¯¹è®¡æ•°å™¨å‡ä¸€</span></span><br><span class="line">        --rh.count;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ­»å¾ªç¯ä½¿ç”¨ CAS ä¿®æ”¹çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">int</span> c = getState();</span><br><span class="line">        <span class="keyword">int</span> nextc = c - SHARED_UNIT;</span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(c, nextc))</span><br><span class="line">            <span class="comment">// ä¿®æ”¹æˆåŠŸåï¼Œå¦‚æœæ˜¯ 0ï¼Œè¡¨ç¤ºè¯»é”å’Œå†™é”éƒ½ç©ºé—²ï¼Œåˆ™å¯ä»¥å”¤é†’åé¢çš„ç­‰å¾…çº¿ç¨‹</span></span><br><span class="line">            <span class="keyword">return</span> nextc == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>å…³äºè¯»å†™é”ï¼Œå®ƒå…¶å®å°±æ˜¯ä¸€ä¸ªè¯»é”ä¸€ä¸ªå†™é”ï¼Œè¯»é”æ˜¯å…±äº«çš„ï¼Œå†™é”æ˜¯ç‹¬å çš„ã€‚ç„¶åæˆ‘ä»¬å†ç†è§£é”é™çº§çš„ç›¸å…³æ¦‚å¿µå°±è¡Œäº†ï¼Œå½“ç„¶è¿™ä¸€åˆ‡éƒ½æ˜¯éœ€è¦å»ºç«‹åœ¨è¯»AQSçš„ç†è§£ä¹‹ä¸Šã€‚</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol>
<li><a href="http://todorex.com/2018/09/11/JDK%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/JDK%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E2%80%94%E2%80%94AbstractQueuedSynchronizer/" target="_blank" rel="noopener">JDKæºç åˆ†æâ€”â€”AbstractQueuedSynchronizer</a></li>
<li><a href="https://www.jianshu.com/p/6221746fc777" target="_blank" rel="noopener">å¹¶å‘ç¼–ç¨‹ä¹‹â€”â€”å†™é”æºç åˆ†æ</a></li>
<li><a href="https://www.jianshu.com/p/cd485e16456e" target="_blank" rel="noopener">å¹¶å‘ç¼–ç¨‹ä¹‹â€”â€”è¯»é”æºç åˆ†æ(è§£é‡Šå…³äºé”é™çº§çš„äº‰è®®)</a></li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¼•ï¼šè¯»å†™åˆ†ç¦»æ˜¯è§£å†³å¹¶å‘ç“¶é¢ˆçš„å¸¸ç”¨ç­–ç•¥ï¼Œåœ¨Javaä¸­ä¹Ÿæœ‰å…¶å®ç°â€”â€”ReentrantReadWriteLockï¼Œå®ƒèƒ½å¤Ÿæœ‰æ•ˆçš„æé«˜è¯»æ¯”å†™å¤šçš„åœºæ™¯ä¸‹çš„ç¨‹åºæ€§èƒ½ã€‚
    
    </summary>
    
      <category term="JDKæºç åˆ†æ" scheme="http://bestlixiang.site/categories/JDK%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
    
      <category term="é”" scheme="http://bestlixiang.site/tags/%E9%94%81/"/>
    
  </entry>
  
  <entry>
    <title>JDKæºç åˆ†æâ€”â€”ReentrantLock</title>
    <link href="http://bestlixiang.site/2018/09/13/JDK%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/JDK%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E2%80%94%E2%80%94ReentrantLock/"/>
    <id>http://bestlixiang.site/2018/09/13/JDKæºç åˆ†æ/JDKæºç åˆ†æâ€”â€”ReentrantLock/</id>
    <published>2018-09-13T02:13:39.000Z</published>
    <updated>2018-09-13T06:15:42.266Z</updated>
    
    <content type="html"><![CDATA[<p>å¼•ï¼šè™½ç„¶æœ‰äº†synchronizedè¿™ç§å†…ç½®çš„é”åŠŸèƒ½ï¼Œä½†æ˜¯åœ¨JDK5ä¹‹ååˆæ–°å¢äº†Lockæ¥å£ï¼Œå®ƒçš„å®ç°ç±»å¯æ¯”å†…ç½®çš„é”å¼ºå¤§å¤šäº†ã€‚ä»Šå¤©æˆ‘ä»¬ä¸»è¦çœ‹çœ‹å®ƒçš„å®ç°ç±»ä¹‹ä¸€ReentrantLockã€‚<a id="more"></a></p>
<h1 id="æ¦‚è§ˆ"><a href="#æ¦‚è§ˆ" class="headerlink" title="æ¦‚è§ˆ"></a>æ¦‚è§ˆ</h1><p>åœ¨çœ‹ä¹‹å‰ï¼Œæˆ‘ä»¬ä¸€å®šè¦å¯¹AbstractQueuedSynchronizerç†Ÿæ‚‰ï¼Œä¸ç†Ÿæ‚‰çš„å¯ä»¥å‚è€ƒæˆ‘è¿™ç¯‡æ–‡ç« â€”â€”<a href="http://todorex.com/2018/09/11/JDK%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/JDK%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E2%80%94%E2%80%94AbstractQueuedSynchronizer/" target="_blank" rel="noopener">JDKæºç åˆ†æâ€”â€”AbstractQueuedSynchronizer</a></p>
<p>æˆ‘ä»¬å…ˆçœ‹çœ‹ä»–çš„å®šä¹‰ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReentrantLock</span> <span class="keyword">implements</span> <span class="title">Lock</span>, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="comment">// åŒæ­¥å™¨(å¯é€‰æ‹©å…¬å¹³åŒæ­¥å™¨æˆ–è€…éå…¬å¹³åŒæ­¥å™¨)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Sync sync;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é»˜è®¤éå…¬å¹³é”</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ReentrantLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        sync = <span class="keyword">new</span> NonfairSync();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// fairä¸ºtrueæ—¶ï¼Œé‡‡ç”¨å…¬å¹³é”ç­–ç•¥</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ReentrantLock</span><span class="params">(<span class="keyword">boolean</span> fair)</span> </span>&#123;    </span><br><span class="line">        sync = fair ? <span class="keyword">new</span> FairSync() : <span class="keyword">new</span> NonfairSync();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        sync.lock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span> </span>&#123;    </span><br><span class="line">        sync.release(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>åŒæ­¥å™¨æŠ½è±¡ç±»<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Sync</span> <span class="keyword">extends</span> <span class="title">AbstractQueuedSynchronizer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// éå…¬å¹³çš„TryAcquire</span></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">nonfairTryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Thread current = Thread.currentThread();</span><br><span class="line">        <span class="keyword">int</span> c = getState();</span><br><span class="line">        <span class="comment">// ä¸º0ï¼Œåˆ™å¯è·å¾—é”ï¼Œè¿›è¡ŒCASæ“ä½œè®¾ç½®stateï¼Œå¹¶è®¾ç½®å½“å‰çº¿ç¨‹ä¸ºç‹¬å çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">                setExclusiveOwnerThread(current);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// é‡å…¥é”çš„ä½“ç°</span></span><br><span class="line">        <span class="comment">// å¦‚æœå½“å‰çº¿ç¨‹ä¸ºç‹¬å çº¿ç¨‹ï¼Œåˆ™å¯é‡å…¥</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">            <span class="comment">// é‡å…¥æ¬¡æ•°å¢åŠ </span></span><br><span class="line">            <span class="keyword">int</span> nextc = c + acquires;</span><br><span class="line">            <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Maximum lock count exceeded"</span>);</span><br><span class="line">            setState(nextc);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è·å–å¤±è´¥</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryRelease</span><span class="params">(<span class="keyword">int</span> releases)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// æˆªå–é‡Šæ”¾æ¬¡æ•°</span></span><br><span class="line">        <span class="keyword">int</span> c = getState() - releases;</span><br><span class="line">        <span class="keyword">if</span> (Thread.currentThread() != getExclusiveOwnerThread())</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</span><br><span class="line">        <span class="keyword">boolean</span> free = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">// é‡å…¥æ¬¡æ•°è¦å‡åˆ°0ï¼Œæ‰æ˜¯çœŸæ­£å¾—é‡Šæ”¾äº†é”</span></span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">            free = <span class="keyword">true</span>;</span><br><span class="line">            setExclusiveOwnerThread(<span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        setState(c);</span><br><span class="line">        <span class="keyword">return</span> free;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç»´æŠ¤äº†ä¸€ä¸ªæ¡ä»¶é˜Ÿåˆ—</span></span><br><span class="line">    <span class="function"><span class="keyword">final</span> ConditionObject <span class="title">newCondition</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> ConditionObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="å…¬å¹³é”"><a href="#å…¬å¹³é”" class="headerlink" title="å…¬å¹³é”"></a>å…¬å¹³é”</h1><p>å…¬å¹³é”æ˜¯æŒ‡å¦‚æœåŒæ­¥å™¨çš„é˜Ÿåˆ—ä¸­æœ‰çº¿ç¨‹åœ¨ç­‰å¾…ï¼Œåæ¥çš„çº¿ç¨‹åˆ™ç›´æ¥åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­<br>å…¬å¹³åŒæ­¥å™¨å®ç°ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">FairSync</span> <span class="keyword">extends</span> <span class="title">Sync</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="comment">// AQSåˆ†æé€»è¾‘</span></span><br><span class="line">      acquire(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å…¬å¹³å®ç°</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">final</span> Thread current = Thread.currentThread();</span><br><span class="line">      <span class="keyword">int</span> c = getState();</span><br><span class="line">      <span class="comment">// å¯è·å¾—é”</span></span><br><span class="line">      <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="comment">// å¦‚æœåŒæ­¥å™¨çš„é˜Ÿåˆ—ä¸­æ²¡æœ‰çº¿ç¨‹åœ¨ç­‰å¾… æˆ–è€… CASæˆåŠŸ æˆ–è€…è®¾ç½®ç‹¬å çº¿ç¨‹æˆåŠŸ</span></span><br><span class="line">          <span class="comment">// å…¬å¹³çš„ä½“ç°</span></span><br><span class="line">          <span class="keyword">if</span> (!hasQueuedPredecessors() &amp;&amp;</span><br><span class="line">              compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">              setExclusiveOwnerThread(current);</span><br><span class="line">              <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// å¯é‡å…¥</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">          <span class="keyword">int</span> nextc = c + acquires;</span><br><span class="line">          <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>)</span><br><span class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Maximum lock count exceeded"</span>);</span><br><span class="line">          setState(nextc);</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="éå…¬å¹³é”"><a href="#éå…¬å¹³é”" class="headerlink" title="éå…¬å¹³é”"></a>éå…¬å¹³é”</h1><p>éå…¬å¹³é”æ˜¯æŒ‡åæ¥çš„çº¿ç¨‹ä¹Ÿæœ‰åŒæ ·çš„ä¼˜å…ˆçº§ã€‚</p>
<p>éå…¬å¹³åŒæ­¥å™¨å®ç°ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">NonfairSync</span> <span class="keyword">extends</span> <span class="title">Sync</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// åˆ©ç”¨CASæŠŠstateä»0è®¾ç½®ä¸º1</span></span><br><span class="line">        <span class="comment">// æˆåŠŸåˆ™è·å¾—é”</span></span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">            setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">// è¿›å…¥AQSåˆ†æé€»è¾‘</span></span><br><span class="line">            acquire(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// éå…¬å¹³è·å–</span></span><br><span class="line">        <span class="keyword">return</span> nonfairTryAcquire(acquires);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="æ¡ä»¶å˜é‡Condition"><a href="#æ¡ä»¶å˜é‡Condition" class="headerlink" title="æ¡ä»¶å˜é‡Condition"></a>æ¡ä»¶å˜é‡Condition</h1><p>Synchronizedä¸­ï¼Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½åœ¨åŒä¸€ä¸ªobjectçš„æ¡ä»¶é˜Ÿåˆ—ä¸Šç­‰å¾…ã€‚è€ŒReentrantLockä¸­ï¼Œæ¯ä¸ªconditionéƒ½ç»´æŠ¤äº†ä¸€ä¸ªæ¡ä»¶é˜Ÿåˆ—ã€‚æˆ‘ä»¬å…ˆçœ‹çœ‹åœ¨åŒæ­¥å™¨å®šä¹‰çš„ConditionObjectå¯¹è±¡ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConditionObject</span> <span class="keyword">implements</span> <span class="title">Condition</span>, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ¡ä»¶é˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> Node firstWaiter;</span><br><span class="line">    <span class="comment">// æ¡ä»¶é˜Ÿåˆ—çš„å°¾èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> Node lastWaiter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬å…³æ³¨å®ƒçš„ä¸¤ä¸ªæ ¸å¿ƒæ–¹æ³•(æ¡ä»¶å˜é‡Conditionä¸ºäº†è§£å†³Object.wait/notify/notifyAlléš¾ä»¥ä½¿ç”¨çš„é—®é¢˜)ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">signal</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure></p>
<h2 id="await"><a href="#await" class="headerlink" title="await"></a>await</h2><p>é˜»å¡çº¿ç¨‹<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="comment">// å¦‚æœçº¿ç¨‹è¢«ä¸­æ–­ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</span><br><span class="line">    <span class="comment">// 1. å°†çº¿ç¨‹æ·»åŠ åˆ°æ¡ä»¶ç­‰å¾…é˜Ÿåˆ—</span></span><br><span class="line">    Node node = addConditionWaiter();</span><br><span class="line">    <span class="comment">// 2. é‡Šæ”¾æŒæœ‰çš„é”</span></span><br><span class="line">    <span class="keyword">int</span> savedState = fullyRelease(node);</span><br><span class="line">    <span class="keyword">int</span> interruptMode = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// æ˜¯å¦åœ¨AQSçš„åŒæ­¥é˜Ÿåˆ—ä¸­</span></span><br><span class="line">    <span class="keyword">while</span> (!isOnSyncQueue(node)) &#123;</span><br><span class="line">        <span class="comment">// 3. ä¸æ˜¯åˆ™æŒ‚èµ·è¯¥çº¿ç¨‹</span></span><br><span class="line">        LockSupport.park(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">if</span> ((interruptMode = checkInterruptWhileWaiting(node)) != <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4. è¢«å”¤é†’åï¼Œé€šè¿‡acquireQueuedæ–¹æ³•é‡æ–°ç«äº‰é”ï¼Œå‚è€ƒAQS</span></span><br><span class="line">    <span class="keyword">if</span> (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE)</span><br><span class="line">        interruptMode = REINTERRUPT;</span><br><span class="line">    <span class="comment">// æ¸…ç†å–æ¶ˆèŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (node.nextWaiter != <span class="keyword">null</span>)</span><br><span class="line">        unlinkCancelledWaiters();</span><br><span class="line">    <span class="comment">// æŠ¥å‘Šä¸­æ–­ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">if</span> (interruptMode != <span class="number">0</span>)</span><br><span class="line">        reportInterruptAfterWait(interruptMode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. å°†çº¿ç¨‹æ·»åŠ åˆ°æ¡ä»¶ç­‰å¾…é˜Ÿåˆ—</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">addConditionWaiter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Node t = lastWaiter;</span><br><span class="line">    <span class="comment">// å¦‚æœæœ€åä¸€ä¸ªèŠ‚ç‚¹æ˜¯å–æ¶ˆçŠ¶æ€</span></span><br><span class="line">    <span class="keyword">if</span> (t != <span class="keyword">null</span> &amp;&amp; t.waitStatus != Node.CONDITION) &#123;</span><br><span class="line">        <span class="comment">// ä»é˜Ÿåˆ—åˆ é™¤å–æ¶ˆèŠ‚ç‚¹</span></span><br><span class="line">        unlinkCancelledWaiters();</span><br><span class="line">        t = lastWaiter;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// çº¿ç¨‹åŒ…è£…æˆèŠ‚ç‚¹</span></span><br><span class="line">    Node node = <span class="keyword">new</span> Node(Thread.currentThread(), Node.CONDITION);</span><br><span class="line">    <span class="keyword">if</span> (t == <span class="keyword">null</span>)</span><br><span class="line">        firstWaiter = node;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        t.nextWaiter = node;</span><br><span class="line">    lastWaiter = node;</span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. é‡Šæ”¾æŒæœ‰çš„é”</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">fullyRelease</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ ‡è®°æ˜¯å¦å¤±è´¥ï¼Œå¤±è´¥åˆ™å°†èŠ‚ç‚¹è®¾ä¸ºå–æ¶ˆçŠ¶æ€</span></span><br><span class="line">    <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> savedState = getState();</span><br><span class="line">        <span class="comment">// releaseå¯ä»¥å‚è€ƒAQSçš„è§£æ</span></span><br><span class="line">        <span class="keyword">if</span> (release(savedState)) &#123;</span><br><span class="line">            failed = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">return</span> savedState;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            node.waitStatus = Node.CANCELLED;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="signal"><a href="#signal" class="headerlink" title="signal"></a>signal</h2><p>å”¤é†’çº¿ç¨‹<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">signal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å½“å‰çº¿ç¨‹æ˜¯å¦æŒæœ‰é”</span></span><br><span class="line">    <span class="keyword">if</span> (!isHeldExclusively())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</span><br><span class="line">    Node first = firstWaiter;</span><br><span class="line">    <span class="keyword">if</span> (first != <span class="keyword">null</span>)</span><br><span class="line">        doSignal(first);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doSignal</span><span class="params">(Node first)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ( (firstWaiter = first.nextWaiter) == <span class="keyword">null</span>)</span><br><span class="line">            lastWaiter = <span class="keyword">null</span>;</span><br><span class="line">        first.nextWaiter = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// æ‰¾åˆ°åº•éƒ¨ä¸ªéå–æ¶ˆèŠ‚ç‚¹ï¼Œé‡åˆ°å–æ¶ˆèŠ‚ç‚¹å°±è¿›è¡Œåˆ é™¤</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (!transferForSignal(first) &amp;&amp;</span><br><span class="line">             (first = firstWaiter) != <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">transferForSignal</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å°†çŠ¶æ€è®¾ç½®ä¸º0ï¼Œä¸è¡Œå°±å–æ¶ˆè¯¥èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (!compareAndSetWaitStatus(node, Node.CONDITION, <span class="number">0</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">// å°†èŠ‚ç‚¹æ”¾å…¥åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­</span></span><br><span class="line">    Node p = enq(node);</span><br><span class="line">    <span class="keyword">int</span> ws = p.waitStatus;</span><br><span class="line">    <span class="keyword">if</span> (ws &gt; <span class="number">0</span> || !compareAndSetWaitStatus(p, ws, Node.SIGNAL))</span><br><span class="line">        <span class="comment">// å”¤é†’çº¿ç¨‹</span></span><br><span class="line">        LockSupport.unpark(node.thread);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ReetrantLockè¿˜æä¾›äº†å…¶å®ƒåŠŸèƒ½ï¼ŒåŒ…æ‹¬å®šæ—¶çš„é”ç­‰å¾…ã€å¯ä¸­æ–­çš„é”ç­‰å¾…ã€å…¬å¹³æ€§ã€ä»¥åŠå®ç°éå—ç»“æ„çš„åŠ é”ã€Conditionï¼Œå¯¹çº¿ç¨‹çš„ç­‰å¾…å’Œå”¤é†’ç­‰æ“ä½œæ›´åŠ çµæ´»ã€‚ä½†æ˜¯å†…ç½®é”ï¼ˆSynchronizedï¼‰ä¸ReentrantLockç›¸æ¯”æœ‰ä¾‹å¤–ä¸€ä¸ªä¼˜ç‚¹å°±æ˜¯åœ¨çº¿ç¨‹è½¬å‚¨ä¸­èƒ½ç»™å‡ºåœ¨å“ªäº›è°ƒç”¨å¸§ä¸­è·å¾—äº†å“ªäº›é”ï¼Œå¹¶èƒ½å¤Ÿæ£€æµ‹å’Œè¯†åˆ«å‘ç”Ÿæ­»é”çš„çº¿ç¨‹ã€‚å› ä¸ºReentrantçš„éå—çŠ¶ç‰¹æ€§æ„å‘³ç€è·å–é”çš„æ“ä½œä¸èƒ½ä¸ç‰¹å®šçš„æ ˆå¸§å…³è”èµ·æ¥ã€‚ç›¸æ¯”ä¹‹ä¸‹å†…ç½®é”æ˜¯JVMçš„å†…ç½®å±æ€§ï¼Œæ‰€ä»¥æœªæ¥æ›´å¯èƒ½æå‡synchronizedè€Œä¸æ˜¯ReentrantLockçš„æ€§èƒ½ï¼Œè€Œç…§ç›®å‰çš„è¶‹åŠ¿æ¥çœ‹ç¡®å®å¦‚æ­¤ã€‚</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol>
<li><a href="http://todorex.com/2018/09/11/JDK%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/JDK%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E2%80%94%E2%80%94AbstractQueuedSynchronizer/" target="_blank" rel="noopener">JDKæºç åˆ†æâ€”â€”AbstractQueuedSynchronizer</a></li>
<li><a href="https://www.jianshu.com/p/4358b1466ec9" target="_blank" rel="noopener">æ·±å…¥æµ…å‡ºReentrantLock</a></li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¼•ï¼šè™½ç„¶æœ‰äº†synchronizedè¿™ç§å†…ç½®çš„é”åŠŸèƒ½ï¼Œä½†æ˜¯åœ¨JDK5ä¹‹ååˆæ–°å¢äº†Lockæ¥å£ï¼Œå®ƒçš„å®ç°ç±»å¯æ¯”å†…ç½®çš„é”å¼ºå¤§å¤šäº†ã€‚ä»Šå¤©æˆ‘ä»¬ä¸»è¦çœ‹çœ‹å®ƒçš„å®ç°ç±»ä¹‹ä¸€ReentrantLockã€‚
    
    </summary>
    
      <category term="JDKæºç åˆ†æ" scheme="http://bestlixiang.site/categories/JDK%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
    
      <category term="é”" scheme="http://bestlixiang.site/tags/%E9%94%81/"/>
    
  </entry>
  
  <entry>
    <title>JDKæºç åˆ†æâ€”â€”AbstractQueuedSynchronizer</title>
    <link href="http://bestlixiang.site/2018/09/11/JDK%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/JDK%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E2%80%94%E2%80%94AbstractQueuedSynchronizer/"/>
    <id>http://bestlixiang.site/2018/09/11/JDKæºç åˆ†æ/JDKæºç åˆ†æâ€”â€”AbstractQueuedSynchronizer/</id>
    <published>2018-09-11T01:16:36.000Z</published>
    <updated>2018-09-13T02:42:29.110Z</updated>
    
    <content type="html"><![CDATA[<p>å¼•ï¼šjava.util.concurrent.locksåŒ…ä¸­æœ‰å¾ˆå¤šLockçš„å®ç°ç±»ï¼Œå†…éƒ¨å®ç°éƒ½ä¾èµ–AbstractQueuedSynchronizerï¼ˆAQSï¼‰ç±»ï¼Œä»Šå¤©æˆ‘ä»¬å°±çœ‹çœ‹AQSå¦‚ä½•å®Œæˆä»£ç å—çš„å¹¶å‘è®¿é—®æ§åˆ¶ã€‚<a id="more"></a></p>
<h1 id="æ¦‚è§ˆ"><a href="#æ¦‚è§ˆ" class="headerlink" title="æ¦‚è§ˆ"></a>æ¦‚è§ˆ</h1><p>æŠ½è±¡é˜Ÿåˆ—åŒæ­¥å™¨AQSæ˜¯ç”¨æ¥æ„å»ºé”æˆ–å…¶ä»–åŒæ­¥ç»„ä»¶çš„åŸºç¡€æ¡†æ¶ï¼Œå†…éƒ¨ä½¿ç”¨ä¸€ä¸ªintæˆå‘˜å˜é‡stateè¡¨ç¤ºåŒæ­¥çŠ¶æ€ï¼Œé€šè¿‡å†…ç½®çš„FIFOé˜Ÿåˆ—æ¥å®Œæˆèµ„æºè·å–çº¿ç¨‹çš„æ’é˜Ÿå·¥ä½œï¼Œå…¶ä¸­å†…éƒ¨åŒæ­¥çŠ¶æ€stateï¼Œç­‰å¾…é˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹headå’Œå°¾èŠ‚ç‚¹headï¼Œéƒ½æ˜¯é€šè¿‡volatileä¿®é¥°ï¼Œä¿è¯äº†å¤šçº¿ç¨‹ä¹‹é—´çš„å¯è§ï¼ŒåŒæ—¶è¿™äº›çŠ¶æ€ä¸Šçš„æ“ä½œéƒ½ç”¨é€šè¿‡CASæ“ä½œæ¥ä¿æŒåŒæ­¥ã€‚</p>
<p>æ ¸å¿ƒæˆå‘˜å˜é‡å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç­‰å¾…é˜Ÿåˆ—å¤´èŠ‚ç‚¹ï¼Œæ‡’åŠ è½½</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node head;</span><br><span class="line"><span class="comment">// ç­‰å¾…é˜Ÿåˆ—å°¾èŠ‚ç‚¹ï¼Œæ‡’åŠ è½½</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node tail;</span><br><span class="line"><span class="comment">// åŒæ­¥çŠ¶æ€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> state;</span><br></pre></td></tr></table></figure></p>
<p>æ•´ä¸ªAQSçš„ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="http://o6plzvjf2.bkt.clouddn.com//juc/aqs.png" alt="aqs"></p>
<h1 id="ç­‰å¾…é˜Ÿåˆ—"><a href="#ç­‰å¾…é˜Ÿåˆ—" class="headerlink" title="ç­‰å¾…é˜Ÿåˆ—"></a>ç­‰å¾…é˜Ÿåˆ—</h1><p>ä¸Šé¢è¯´åˆ°AQSæ˜¯é€šè¿‡å†…ç½®çš„é˜Ÿåˆ—(LH lockå®ç°ï¼Œä¸æ‡‚çš„åœ¨åé¢å‚è€ƒä¸­æ‰¾åˆ°è§£é‡Š)æ¥å®ŒæˆåŒæ­¥çš„ï¼Œæˆ‘ä»¬å°±å…ˆçœ‹çœ‹é˜Ÿåˆ—çš„å®šä¹‰ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  *      +------+  prev +-----+       +-----+</span></span><br><span class="line"><span class="comment">  * head |      | &lt;---- |     | &lt;---- |     |  tail</span></span><br><span class="line"><span class="comment">  *      +------+       +-----+       +-----+</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ ‡è®°è¡¨ç¤ºèŠ‚ç‚¹æ­£åœ¨å…±äº«æ¨¡å¼ä¸­ç­‰å¾…</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> Node SHARED = <span class="keyword">new</span> Node();</span><br><span class="line">    <span class="comment">// æ ‡è®°è¡¨ç¤ºèŠ‚ç‚¹æ­£åœ¨ç‹¬å æ¨¡å¼ä¸‹ç­‰å¾…</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> Node EXCLUSIVE = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// waitStatuså€¼è¡¨ç¤ºçº¿ç¨‹å–æ¶ˆ</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CANCELLED =  <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// waitStatuså€¼è¡¨ç¤ºå½“å‰çº¿ç¨‹çš„åç»§çº¿ç¨‹éœ€è¦è¢«å”¤é†’</span></span><br><span class="line">    <span class="comment">// ä¸€èˆ¬å‘ç”Ÿæƒ…å†µæ˜¯ï¼šå½“å‰çº¿ç¨‹çš„åç»§çº¿ç¨‹å¤„äºé˜»å¡çŠ¶æ€ï¼Œè€Œå½“å‰çº¿ç¨‹è¢«releaseæˆ–cancel</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SIGNAL    = -<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// waitStatuså€¼è¡¨ç¤ºçº¿ç¨‹ç­‰å¾…Conditionå”¤é†’</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CONDITION = -<span class="number">2</span>;</span><br><span class="line">    <span class="comment">// waitStatuså€¼è¡¨ç¤ºä¸‹ä¸€ä¸ªacquireSharedåº”è¯¥æ— æ¡ä»¶ä¼ æ’­,éƒ½è·å¾—å…±äº«é”</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROPAGATE = -<span class="number">3</span>;</span><br><span class="line">    <span class="comment">// è¡¨ç¤ºèŠ‚ç‚¹çŠ¶æ€å€¼ï¼ŒSIGNALï¼ŒCANCELLEDï¼ŒCONDITIONï¼ŒPROPAGATEï¼Œ0</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">int</span> waitStatus;</span><br><span class="line">    <span class="comment">// å‰é©±èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">volatile</span> Node prev;</span><br><span class="line">    <span class="comment">// åç»§èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">volatile</span> Node next;</span><br><span class="line">    <span class="comment">// å¯¹åº”çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">volatile</span> Thread thread;</span><br><span class="line">    <span class="comment">// èµ„æºå…±äº«æ–¹å¼ï¼šSHAREDã€ç‹¬å æ¨¡å¼</span></span><br><span class="line">    Node nextWaiter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h1><p>ä¸åŒçš„è‡ªå®šä¹‰åŒæ­¥å™¨(åé¢ä¼šæŒ‘å‡ ç§è¿›è¡Œæºç åˆ†æ)äº‰ç”¨å…±äº«èµ„æºçš„æ–¹å¼ä¹Ÿä¸åŒã€‚è‡ªå®šä¹‰åŒæ­¥å™¨åœ¨å®ç°æ—¶åªéœ€è¦<strong>å®ç°å…±äº«èµ„æºstateçš„è·å–ä¸é‡Šæ”¾æ–¹å¼</strong>å³å¯ï¼Œè‡³äºå…·ä½“çº¿ç¨‹ç­‰å¾…é˜Ÿåˆ—çš„ç»´æŠ¤ï¼ˆå¦‚è·å–èµ„æºå¤±è´¥å…¥é˜Ÿ/å”¤é†’å‡ºé˜Ÿç­‰ï¼‰ï¼ŒAQSå·²ç»åœ¨é¡¶å±‚å®ç°å¥½äº†ã€‚è‡ªå®šä¹‰åŒæ­¥å™¨å®ç°æ—¶ä¸»è¦å®ç°ä»¥ä¸‹å‡ ç§æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¯¥çº¿ç¨‹æ˜¯å¦æ­£åœ¨ç‹¬å èµ„æºã€‚åªæœ‰ç”¨åˆ°conditionæ‰éœ€è¦å»å®ç°å®ƒ</span></span><br><span class="line">isHeldExclusively();</span><br><span class="line"><span class="comment">// ç‹¬å æ–¹å¼ã€‚å°è¯•è·å–èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å›trueï¼Œå¤±è´¥åˆ™è¿”å›falseã€‚</span></span><br><span class="line">tryAcquire(<span class="keyword">int</span> arg);</span><br><span class="line"><span class="comment">// ç‹¬å æ–¹å¼ã€‚å°è¯•é‡Šæ”¾èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å›trueï¼Œå¤±è´¥åˆ™è¿”å›falseã€‚</span></span><br><span class="line">tryRelease(<span class="keyword">int</span> arg);</span><br><span class="line"><span class="comment">// å…±äº«æ–¹å¼ã€‚å°è¯•è·å–èµ„æºã€‚è´Ÿæ•°è¡¨ç¤ºå¤±è´¥ï¼›0è¡¨ç¤ºæˆåŠŸï¼Œä½†æ²¡æœ‰å‰©ä½™å¯ç”¨èµ„æºï¼›æ­£æ•°è¡¨ç¤ºæˆåŠŸï¼Œä¸”æœ‰å‰©ä½™èµ„æº</span></span><br><span class="line">tryAcquireShared(<span class="keyword">int</span> arg);</span><br><span class="line"><span class="comment">// å…±äº«æ–¹å¼ã€‚å°è¯•é‡Šæ”¾èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å›trueï¼Œå¤±è´¥åˆ™è¿”å›falseã€‚</span></span><br><span class="line">tryReleaseShared(<span class="keyword">int</span> arg)</span><br></pre></td></tr></table></figure>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œè‡ªå®šä¹‰åŒæ­¥å™¨è¦ä¹ˆæ˜¯ç‹¬å æ–¹æ³•ï¼Œè¦ä¹ˆæ˜¯å…±äº«æ–¹å¼ï¼Œä»–ä»¬ä¹Ÿåªéœ€å®ç°tryAcquire-tryReleaseã€tryAcquireShared-tryReleaseSharedä¸­çš„ä¸€ç§å³å¯ã€‚ä½†AQSä¹Ÿæ”¯æŒè‡ªå®šä¹‰åŒæ­¥å™¨åŒæ—¶å®ç°ç‹¬å å’Œå…±äº«ä¸¤ç§æ–¹å¼ï¼Œå¦‚ReentrantReadWriteLockã€‚ä¸‹é¢æˆ‘å°†åˆ†åˆ«å¯¹ç‹¬å é”çš„ç®¡ç†æµç¨‹ acquire-release å’Œ å…±äº«é”ç®¡ç†æµç¨‹ acquireShared-releaseShare è¿›è¡Œåˆ†æã€‚</p>
<h1 id="acquire-release"><a href="#acquire-release" class="headerlink" title="acquire-release"></a>acquire-release</h1><h2 id="acquire"><a href="#acquire" class="headerlink" title="acquire"></a>acquire</h2><p>acquireæ–¹æ³•æ˜¯ç‹¬å æ¨¡å¼ä¸‹çº¿ç¨‹è·å–å…±äº«èµ„æºçš„é¡¶å±‚å…¥å£ã€‚å¦‚æœè·å–åˆ°èµ„æºï¼Œçº¿ç¨‹ç›´æ¥è¿”å›ï¼Œå¦åˆ™è¿›å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œç›´åˆ°è·å–åˆ°èµ„æºä¸ºæ­¢ï¼Œä¸”æ•´ä¸ªè¿‡ç¨‹å¿½ç•¥ä¸­æ–­çš„å½±å“ã€‚å®ƒå°†è¢«Lockæ¥å£çš„lockæ–¹æ³•è°ƒç”¨ã€‚æºç å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp;</span><br><span class="line">        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">        selfInterrupt();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. å½“å‰çº¿ç¨‹é€šè¿‡tryAcquire()å°è¯•è·å–é”ã€‚è·å–æˆåŠŸçš„è¯ï¼Œç›´æ¥è¿”å›ï¼›å°è¯•å¤±è´¥çš„è¯ï¼Œè¿›å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—æ’åºç­‰å¾…ã€‚</span></span><br><span class="line"><span class="comment">// äº¤ç”±è‡ªå®šä¹‰åŒæ­¥å™¨å»å®ç°ï¼Œä¸»è¦æ˜¯è®¾ç½®åŒæ­¥Stateï¼Œè·å–æˆåŠŸè¿”å›trueï¼Œå¤±è´¥è¿”å›false</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 2. å½“å‰çº¿ç¨‹åœ¨å°è¯•å¤±è´¥çš„æƒ…å†µä¸‹ï¼Œå…ˆé€šè¿‡addWaiter(Node.EXCLUSIVE)æ¥å°†å½“å‰çº¿ç¨‹åŠ å…¥åˆ°CLHé˜Ÿåˆ—æœ«å°¾ã€‚</span></span><br><span class="line"><span class="comment">// æ ¹æ®å½“å‰çº¿ç¨‹å’Œæ¨¡å¼åˆ›å»ºèŠ‚ç‚¹å¹¶å…¥é˜Ÿ</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">addWaiter</span><span class="params">(Node mode)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ ¹æ®å½“å‰çº¿ç¨‹å’Œæ¨¡å¼åˆ›å»ºèŠ‚ç‚¹</span></span><br><span class="line">    Node node = <span class="keyword">new</span> Node(Thread.currentThread(), mode);</span><br><span class="line">    <span class="comment">// tailèŠ‚ç‚¹ä¸ä¸ºç©ºï¼Œå°è¯•å¿«é€Ÿæ–¹å¼ç›´æ¥æ”¾åˆ°é˜Ÿå°¾</span></span><br><span class="line">    Node pred = tail;</span><br><span class="line">    <span class="keyword">if</span> (pred != <span class="keyword">null</span>) &#123;</span><br><span class="line">        node.prev = pred;</span><br><span class="line">        <span class="comment">// åˆ©ç”¨Unsafeçš„CASæ“ä½œï¼Œä¸‹é¢å°†ä¸å†æ</span></span><br><span class="line">        <span class="keyword">if</span> (compareAndSetTail(pred, node)) &#123;</span><br><span class="line">            pred.next = node;</span><br><span class="line">            <span class="keyword">return</span> node;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// tailèŠ‚ç‚¹ä¸ºç©ºï¼Œè°ƒç”¨enqæ–¹æ³•</span></span><br><span class="line">    enq(node);</span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å°†èŠ‚ç‚¹å…¥é˜Ÿï¼Œå¦‚æœæœ‰å¿…è¦åˆå§‹åŒ–é˜Ÿåˆ—</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">enq</span><span class="params">(<span class="keyword">final</span> Node node)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// CASè‡ªæ—‹ï¼Œç›´åˆ°æˆåŠŸåŠ å…¥é˜Ÿå°¾</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        Node t = tail;</span><br><span class="line">        <span class="comment">// æœ«ç«¯èŠ‚ç‚¹ä¸ºç©º</span></span><br><span class="line">        <span class="keyword">if</span> (t == <span class="keyword">null</span>) &#123; <span class="comment">// Must initialize</span></span><br><span class="line">            <span class="comment">// åˆ›å»ºå¤´èŠ‚ç‚¹ï¼Œå¹¶åˆ©ç”¨CASæ“ä½œè®¾ç½®å¤´èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetHead(<span class="keyword">new</span> Node()))</span><br><span class="line">                <span class="comment">// å°†å°¾èŠ‚ç‚¹æŒ‡é’ˆä¹ŸæŒ‡å‘å¤´èŠ‚ç‚¹</span></span><br><span class="line">                tail = head;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// æ­£å¸¸å…¥é˜Ÿ</span></span><br><span class="line">            node.prev = t;</span><br><span class="line">            <span class="keyword">if</span> (compareAndSetTail(t, node)) &#123;</span><br><span class="line">                t.next = node;</span><br><span class="line">                <span class="keyword">return</span> t;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. å½“å‰çº¿ç¨‹æ‰§è¡Œå®ŒaddWaiter(Node.EXCLUSIVE)ä¹‹åï¼Œè°ƒç”¨acquireQueued()æ¥è·å–é”ï¼Œå› ä¸ºè¿™ä¸ªæ—¶å€™å¯èƒ½å‰é¢çš„çº¿ç¨‹å·²ç»é‡Šæ”¾äº†é”ã€‚</span></span><br><span class="line"><span class="comment">// å¦‚æœå½“å‰çº¿ç¨‹è·å–åˆ°äº†é”ï¼Œåˆ™è¿”å›ï¼›å¦åˆ™ï¼Œå½“å‰çº¿ç¨‹è¢«æŒ‚èµ·ï¼Œç›´åˆ°å”¤é†’å¹¶é‡æ–°è·å–é”äº†æ‰è¿”å›ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//æ ‡è®°æ˜¯å¦æˆåŠŸæ‹¿åˆ°èµ„æº</span></span><br><span class="line">    <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//æ ‡è®°ç­‰å¾…è¿‡ç¨‹ä¸­æ˜¯å¦è¢«ä¸­æ–­è¿‡</span></span><br><span class="line">        <span class="keyword">boolean</span> interrupted = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">// è‡ªæ—‹</span></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">// æ‹¿åˆ°å‰é©±èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">final</span> Node p = node.predecessor();</span><br><span class="line">            <span class="comment">// å¦‚æœå‰é©±èŠ‚ç‚¹æ˜¯headèŠ‚ç‚¹ å¹¶ä¸” è·å–é”æˆåŠŸ</span></span><br><span class="line">            <span class="comment">// è¿™é‡Œæ¶‰åŠåˆ°é”çš„å…¬å¹³æ€§é—®é¢˜ï¼Œä½“ç°äº†éå…¬å¹³æ€§</span></span><br><span class="line">            <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                <span class="comment">// å°†å½“å‰èŠ‚ç‚¹è®¾ç½®ä¸ºheadèŠ‚ç‚¹</span></span><br><span class="line">                <span class="comment">// headæ‰€æŒ‡çš„ç»“ç‚¹ï¼Œå°±æ˜¯å½“å‰è·å–åˆ°é”çš„é‚£ä¸ªç»“ç‚¹æˆ–null(åˆå§‹åŒ–æ—¶)</span></span><br><span class="line">                setHead(node);</span><br><span class="line">                p.next = <span class="keyword">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                failed = <span class="keyword">false</span>;</span><br><span class="line">                <span class="comment">// è¿”å›ç­‰å¾…è¿‡ç¨‹ä¸­æ˜¯å¦è¢«ä¸­æ–­è¿‡</span></span><br><span class="line">                <span class="keyword">return</span> interrupted;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¦‚æœä¸Šé¢çš„æ¡ä»¶ä¸æˆç«‹ï¼Œåˆ™æŒ‚èµ·å½“å‰çº¿ç¨‹ï¼Œç­‰å¾…è¢«å”¤é†’æˆ–è€…ä¸­æ–­</span></span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                parkAndCheckInterrupt())</span><br><span class="line">                interrupted = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœè·å–é”å‡ºé”™ï¼Œåˆ™è®¾ç½®ä¸ºå–æ¶ˆçŠ¶æ€</span></span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨è·å–é”å¤±è´¥ä¹‹åæ£€æŸ¥å’Œæ›´æ–°èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œè¿”å›å½“å‰çº¿ç¨‹æ˜¯å¦åº”è¯¥é˜»å¡(è¢«å”¤é†’)</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">shouldParkAfterFailedAcquire</span><span class="params">(Node pred, Node node)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ‹¿åˆ°å‰é©±èŠ‚ç‚¹çš„ç­‰å¾…çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">int</span> ws = pred.waitStatus;</span><br><span class="line">    <span class="comment">// ç­‰å¾…çŠ¶æ€ä¸ºSIGNALï¼ˆ-1ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (ws == Node.SIGNAL)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    <span class="comment">// ç­‰å¾…çŠ¶æ€ä¸ºCANCELLED(1)</span></span><br><span class="line">    <span class="keyword">if</span> (ws &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// å¾€å‰æ‰¾åˆ°æœ€è¿‘æœ‰æ•ˆçš„èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            node.prev = pred = pred.prev;</span><br><span class="line">        &#125; <span class="keyword">while</span> (pred.waitStatus &gt; <span class="number">0</span>);</span><br><span class="line">        pred.next = node;</span><br><span class="line">    <span class="comment">// ç­‰å¾…çŠ¶æ€ä¸ºå…¶ä»–æƒ…å†µ</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å°†çŠ¶æ€è®¾ç½®ä¸ºSIGNAL</span></span><br><span class="line">        compareAndSetWaitStatus(pred, ws, Node.SIGNAL);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. å½“å‰çº¿ç¨‹åœ¨æ‰§è¡ŒacquireQueued()æ—¶ï¼Œä¼šè¿›å…¥åˆ°CLHé˜Ÿåˆ—ä¸­ä¼‘çœ ç­‰å¾…ï¼Œç›´åˆ°è·å–é”äº†æ‰è¿”å›ï¼</span></span><br><span class="line"><span class="comment">// é˜»å¡å¹¶æ£€æŸ¥æ˜¯å¦ä¸­æ–­ï¼Œç›´åˆ°å½“å‰çº¿ç¨‹è¢«å”¤é†’æ‰ä»parkAndCheckInterrupt()ä¸­è¿”å›</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">parkAndCheckInterrupt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    LockSupport.park(<span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">// è¿”å›ä¸­æ–­çŠ¶æ€ï¼Œå¹¶æ¸…é™¤ä¸­æ–­æ ‡å¿—ï¼Œä¸­æ–­å¹¶ä¸ä¼šå–æ¶ˆé”ï¼Œå¦‚æœä¸­æ–­ä¼šå†æ¬¡è¢«é˜»å¡</span></span><br><span class="line">    <span class="keyword">return</span> Thread.interrupted();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 5. å¦‚æœå½“å‰çº¿ç¨‹åœ¨ä¼‘çœ ç­‰å¾…è¿‡ç¨‹ä¸­è¢«ä¸­æ–­è¿‡ï¼ŒacquireQueuedä¼šè¿”å›trueï¼Œæ­¤æ—¶å½“å‰çº¿ç¨‹ä¼šè°ƒç”¨selfInterrupt()æ¥è‡ªå·±ç»™è‡ªå·±äº§ç”Ÿä¸€ä¸ªä¸­æ–­ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">selfInterrupt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è®°å½•ä¸­æ–­æ ‡å¿—</span></span><br><span class="line">    Thread.currentThread().interrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="release"><a href="#release" class="headerlink" title="release"></a>release</h2><p>releaseæ–¹æ³•æ˜¯ç‹¬å æ¨¡å¼çº¿ç¨‹é‡Šæ”¾èµ„æºçš„å…¥å£ã€‚å®ƒå°†è¢«Lockæ¥å£çš„releaseæ–¹æ³•è°ƒç”¨ã€‚æºç å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">release</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (tryRelease(arg)) &#123;</span><br><span class="line">        <span class="comment">// æ‰¾åˆ°å¤´èŠ‚ç‚¹</span></span><br><span class="line">        Node h = head;</span><br><span class="line">        <span class="comment">// å¤´èŠ‚ç‚¹ä¸ä¸ºç©º ä¸” å¤´èŠ‚ç‚¹ç­‰å¾…çŠ¶æ€ä¸ä¸º0</span></span><br><span class="line">        <span class="keyword">if</span> (h != <span class="keyword">null</span> &amp;&amp; h.waitStatus != <span class="number">0</span>)</span><br><span class="line">            <span class="comment">// å”¤é†’ç­‰å¾…é˜Ÿåˆ—çš„ä¸‹ä¸€ä¸ªçº¿ç¨‹</span></span><br><span class="line">            unparkSuccessor(h);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 1. å½“å‰çº¿ç¨‹é€šè¿‡tryRelease(arg)å°è¯•é‡Šæ”¾é”ï¼ŒæˆåŠŸåˆ™è¿”å›trueï¼Œå¤±è´¥åˆ™è¿”å›falseã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">tryRelease</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 2. å½“å‰çº¿ç¨‹é‡Šæ”¾é”æˆåŠŸåï¼Œå”¤é†’ç­‰å¾…é˜Ÿåˆ—çš„ä¸‹ä¸€ä¸ªçº¿ç¨‹</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unparkSuccessor</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰çº¿ç¨‹çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">int</span> ws = node.waitStatus;</span><br><span class="line">    <span class="comment">// å¦‚æœçŠ¶æ€ &lt; 0ï¼Œåˆ™è®¾ç½®çŠ¶æ€ä¸º0</span></span><br><span class="line">    <span class="keyword">if</span> (ws &lt; <span class="number">0</span>)</span><br><span class="line">        compareAndSetWaitStatus(node, ws, <span class="number">0</span>);</span><br><span class="line">    Node s = node.next;</span><br><span class="line">    <span class="comment">// èŠ‚ç‚¹ä¸ºç©º æˆ–è€… waitStatus &gt; 0 ï¼Œä»æœ€åå¼€å§‹å‘å‰å¯»æ‰¾ï¼Œæ‰¾åˆ°waitStatuså°äºç­‰äº0çš„èŠ‚ç‚¹</span></span><br><span class="line">    <span class="comment">// æ¶‰åŠåˆ°äº†å¼±ä¸€è‡´æ€§çš„é—®é¢˜ï¼ˆnextæŒ‡é’ˆåœ¨æœ‰ä¸ªçŸ­æš‚ç¬é—´ä¸ä¸€å®šå­˜åœ¨ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (s == <span class="keyword">null</span> || s.waitStatus &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        s = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (Node t = tail; t != <span class="keyword">null</span> &amp;&amp; t != node; t = t.prev)</span><br><span class="line">            <span class="keyword">if</span> (t.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">                s = t;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å”¤é†’åç»§èŠ‚ç‚¹å¯¹åº”çš„çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">if</span> (s != <span class="keyword">null</span>)</span><br><span class="line">        LockSupport.unpark(s.thread);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="acquireShared-releaseShare"><a href="#acquireShared-releaseShare" class="headerlink" title="acquireShared-releaseShare"></a>acquireShared-releaseShare</h1><h2 id="acquireShared"><a href="#acquireShared" class="headerlink" title="acquireShared"></a>acquireShared</h2><p>acquireShared(int arg)æ˜¯å…±äº«æ¨¡å¼ä¸‹çº¿ç¨‹è·å–å…±äº«èµ„æºçš„é¡¶å±‚å…¥å£ã€‚å®ƒä¼šè·å–æŒ‡å®šé‡çš„èµ„æºï¼Œè·å–æˆåŠŸåˆ™ç›´æ¥è¿”å›ï¼Œè·å–å¤±è´¥åˆ™è¿›å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œç›´åˆ°è·å–åˆ°èµ„æºä¸ºæ­¢ï¼Œæ•´ä¸ªè¿‡ç¨‹å¿½ç•¥ä¸­æ–­ã€‚æºç å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">acquireShared</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (tryAcquireShared(arg) &lt; <span class="number">0</span>)</span><br><span class="line">        doAcquireShared(arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. å½“å‰çº¿ç¨‹é€šè¿‡tryAcquireShared(int arg)å°è¯•è·å–é”ï¼Œè´Ÿå€¼ä»£è¡¨è·å–å¤±è´¥ï¼›0ä»£è¡¨è·å–æˆåŠŸï¼Œä½†æ²¡æœ‰å‰©ä½™èµ„æºï¼›æ­£æ•°è¡¨ç¤ºè·å–æˆåŠŸï¼Œè¿˜æœ‰å‰©ä½™èµ„æºï¼Œå…¶ä»–çº¿ç¨‹è¿˜å¯ä»¥å»è·å–</span></span><br><span class="line"><span class="comment">// äº¤ç”±è‡ªå®šä¹‰åŒæ­¥å™¨å»å®ç°ï¼Œä¸»è¦æ˜¯è®¾ç½®åŒæ­¥State</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">tryAcquireShared</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. å½“å‰çº¿ç¨‹é€šè¿‡doAcquireShared(int arg)å°†å½“å‰çº¿ç¨‹åŠ å…¥ç­‰å¾…é˜Ÿåˆ—å°¾éƒ¨ä¼‘æ¯ï¼Œç›´åˆ°å…¶ä»–çº¿ç¨‹é‡Šæ”¾èµ„æºå”¤é†’è‡ªå·±ï¼Œè‡ªå·±æˆåŠŸæ‹¿åˆ°ç›¸åº”é‡çš„èµ„æºåæ‰è¿”å›</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doAcquireShared</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// åŠ å…¥é˜Ÿåˆ—å°¾éƒ¨</span></span><br><span class="line">    <span class="keyword">final</span> Node node = addWaiter(Node.SHARED);</span><br><span class="line">    <span class="comment">// æ ‡è®°æ˜¯å¦æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// æ ‡è®°æ˜¯å¦è¢«ä¸­æ–­</span></span><br><span class="line">        <span class="keyword">boolean</span> interrupted = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">// è‡ªæ—‹</span></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">// æ‹¿åˆ°å‰é©±èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">final</span> Node p = node.predecessor();</span><br><span class="line">            <span class="comment">// æ­¤æ—¶nodeèŠ‚ç‚¹è¢«å”¤é†’</span></span><br><span class="line">            <span class="keyword">if</span> (p == head) &#123;</span><br><span class="line">                <span class="comment">// å°è¯•è·å¾—èµ„æº</span></span><br><span class="line">                <span class="keyword">int</span> r = tryAcquireShared(arg);</span><br><span class="line">                <span class="keyword">if</span> (r &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">//å°†headæŒ‡å‘è‡ªå·±ï¼Œè¿˜æœ‰å‰©ä½™èµ„æºå¯ä»¥å†å”¤é†’ä¹‹åçš„çº¿ç¨‹</span></span><br><span class="line">                    setHeadAndPropagate(node, r);</span><br><span class="line">                    p.next = <span class="keyword">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                    <span class="comment">// å¦‚æœç­‰å¾…è¿‡ç¨‹ä¸­è¢«ä¸­æ–­è¿‡ï¼Œè®°å½•ä¸­æ–­æ ‡è®°</span></span><br><span class="line">                    <span class="keyword">if</span> (interrupted)</span><br><span class="line">                        selfInterrupt();</span><br><span class="line">                    failed = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ä¸ç‹¬å æ¨¡å¼ç±»ä¼¼</span></span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                parkAndCheckInterrupt())</span><br><span class="line">                interrupted = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setHeadAndPropagate</span><span class="params">(Node node, <span class="keyword">int</span> propagate)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å°†headæŒ‡é’ˆæŒ‡å‘è‡ªå·±</span></span><br><span class="line">    Node h = head;</span><br><span class="line">    setHead(node);</span><br><span class="line">    <span class="comment">// å”¤é†’åç»§èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (propagate &gt; <span class="number">0</span> || h == <span class="keyword">null</span> || h.waitStatus &lt; <span class="number">0</span> ||</span><br><span class="line">        (h = head) == <span class="keyword">null</span> || h.waitStatus &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        Node s = node.next;</span><br><span class="line">        <span class="keyword">if</span> (s == <span class="keyword">null</span> || s.isShared())</span><br><span class="line">            <span class="comment">// å…³æ³¨è¿™é‡Œ</span></span><br><span class="line">            doReleaseShared();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="releaseShare"><a href="#releaseShare" class="headerlink" title="releaseShare"></a>releaseShare</h2><p>doReleaseShared()æ˜¯å…±äº«æ¨¡å¼ä¸‹çº¿ç¨‹é‡Šæ”¾å…±äº«èµ„æºçš„é¡¶å±‚å…¥å£ã€‚å®ƒä¼šé‡Šæ”¾æŒ‡å®šé‡çš„èµ„æºï¼Œå¦‚æœå½»åº•é‡Šæ”¾äº†ï¼ˆå³state=0ï¼‰,å®ƒä¼šå”¤é†’ç­‰å¾…é˜Ÿåˆ—é‡Œçš„å…¶ä»–çº¿ç¨‹æ¥è·å–èµ„æºã€‚æºç å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">releaseShared</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (tryReleaseShared(arg)) &#123;</span><br><span class="line">        doReleaseShared();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. å½“å‰çº¿ç¨‹é€šè¿‡tryReleaseShared(int arg)å°è¯•é‡Šæ”¾é”ï¼ŒæˆåŠŸè¿”å›trueï¼Œå¤±è´¥è¿”å›false</span></span><br><span class="line"><span class="comment">// äº¤ç”±è‡ªå®šä¹‰åŒæ­¥å™¨å»å®ç°ï¼Œä¸»è¦æ˜¯è®¾ç½®åŒæ­¥State</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">tryReleaseShared</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. å½“å‰çº¿ç¨‹é€šè¿‡doReleaseShared()å”¤é†’åç»§èŠ‚ç‚¹</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doReleaseShared</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        Node h = head;</span><br><span class="line">        <span class="keyword">if</span> (h != <span class="keyword">null</span> &amp;&amp; h != tail) &#123;</span><br><span class="line">            <span class="keyword">int</span> ws = h.waitStatus;</span><br><span class="line">            <span class="keyword">if</span> (ws == Node.SIGNAL) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!compareAndSetWaitStatus(h, Node.SIGNAL, <span class="number">0</span>))</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                <span class="comment">// å”¤é†’çº¿ç¨‹</span></span><br><span class="line">                unparkSuccessor(h);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (ws == <span class="number">0</span> &amp;&amp;</span><br><span class="line">                     !compareAndSetWaitStatus(h, <span class="number">0</span>, Node.PROPAGATE))</span><br><span class="line">                <span class="keyword">continue</span>;                <span class="comment">// loop on failed CAS</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (h == head)                   <span class="comment">// loop if head changed</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>çŸ¥é“äº†AQSçš„åŸç†ï¼Œé”çš„åŸç†åº”è¯¥ä¹Ÿå°±ä¸éš¾äº†ã€‚è¿™æ¬¡æˆ‘ä»¬å†ä¸€æ¬¡è§åˆ°CASçš„å¨åŠ›ã€‚å½“ç„¶è¿™æ¬¡æœ‰äº›è¿˜æ˜¯æœ‰ä¸€ç‚¹è¿·æƒ‘ï¼Œåé¢æœ‰æœºä¼šå†æ¥è¡¥å……ï¼</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol>
<li><a href="https://www.cnblogs.com/yuyutianxia/p/4296220.html" target="_blank" rel="noopener">CLHé” ã€MCSé”</a></li>
<li><a href="https://www.cnblogs.com/2015110615L/p/6754529.html" target="_blank" rel="noopener">Javaå¤šçº¿ç¨‹ï¼šAQSæºç åˆ†æ</a></li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¼•ï¼šjava.util.concurrent.locksåŒ…ä¸­æœ‰å¾ˆå¤šLockçš„å®ç°ç±»ï¼Œå†…éƒ¨å®ç°éƒ½ä¾èµ–AbstractQueuedSynchronizerï¼ˆAQSï¼‰ç±»ï¼Œä»Šå¤©æˆ‘ä»¬å°±çœ‹çœ‹AQSå¦‚ä½•å®Œæˆä»£ç å—çš„å¹¶å‘è®¿é—®æ§åˆ¶ã€‚
    
    </summary>
    
      <category term="JDKæºç åˆ†æ" scheme="http://bestlixiang.site/categories/JDK%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
    
      <category term="é”" scheme="http://bestlixiang.site/tags/%E9%94%81/"/>
    
  </entry>
  
  <entry>
    <title>JDKæºç åˆ†æâ€”â€”ThreadPoolExecutor</title>
    <link href="http://bestlixiang.site/2018/09/07/JDK%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/JDK%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E2%80%94%E2%80%94ThreadPoolExecutor/"/>
    <id>http://bestlixiang.site/2018/09/07/JDKæºç åˆ†æ/JDKæºç åˆ†æâ€”â€”ThreadPoolExecutor/</id>
    <published>2018-09-07T13:23:15.000Z</published>
    <updated>2018-09-08T09:44:01.053Z</updated>
    
    <content type="html"><![CDATA[<p>å¼•ï¼šç›¸ä¿¡å¤§å®¶å·²ç»æ”¶åˆ°äº†Executoræ¡†æ¶ä»¥åŠçº¿ç¨‹æ± å¸¦æ¥çš„å¥½å¤„ï¼Œå®ƒæœ‰ç€ç¥å¥‡çš„èƒ½åŠ›ï¼Œé‚£æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒæ˜¯æ€ä¹ˆå®ç°è¿™ç§ç¥å¥‡çš„èƒ½åŠ›çš„ï¼<a id="more"></a></p>
<p>è¯¦ç»†æ³¨é‡Šï¼š<a href="https://github.com/todorex/JDK" target="_blank" rel="noopener">æºç åˆ†æåœ°å€</a></p>
<h1 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h1><p>ç”¨è¿‡çš„äººåº”è¯¥éƒ½å¾ˆç†Ÿæ‚‰äº†ï¼Œä¸è¿‡è¿˜æƒ³å›é¡¾ä¸€ä¸‹çš„è¿˜æ˜¯å¯ä»¥çœ‹çœ‹è‡ªå·±ä¹‹å‰çœ‹ã€ŠJavaå¹¶å‘å®æˆ˜ç¼–ç¨‹ã€‹æ€»ç»“çš„å‡ ç« ç¬”è®°ï¼š</p>
<ol>
<li><a href="http://todorex.com/2018/01/15/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98/Java%E5%B9%B6%E5%8F%91-5-%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C/" target="_blank" rel="noopener">Javaå¹¶å‘<em>5</em>ä»»åŠ¡æ‰§è¡Œ</a></li>
<li><a href="http://todorex.com/2018/01/22/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98/Java%E5%B9%B6%E5%8F%91-7-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%9A%84%E4%BD%BF%E7%94%A8/" target="_blank" rel="noopener">Javaå¹¶å‘<em>7</em>çº¿ç¨‹æ± çš„ä½¿ç”¨</a></li>
</ol>
<h1 id="ä¾‹å­"><a href="#ä¾‹å­" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h1><p>JDKè‡ªå¸¦çš„å“ªå‡ ç§çº¿ç¨‹æ± ç±»å‹ï¼Œå°±ä¸å¤šå±•ç¤ºäº†ï¼Œè¿™é‡Œæˆ‘ä»¬æ¥çœ‹çœ‹è‡ªå®šä¹‰çº¿ç¨‹æ± ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExecutorTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ExecutorService executorService = <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">5</span>,<span class="number">20</span>, <span class="number">0</span>, TimeUnit.MILLISECONDS</span><br><span class="line">                ,<span class="keyword">new</span> LinkedBlockingDeque&lt;&gt;(<span class="number">1024</span>), Executors.defaultThreadFactory(), <span class="keyword">new</span> ThreadPoolExecutor.AbortPolicy());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            executorService.execute(<span class="keyword">new</span> MyTask());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Thread IDï¼š"</span> + Thread.currentThread().getId());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>è¾“å‡ºï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Thread IDï¼š10</span><br><span class="line">Thread IDï¼š12</span><br><span class="line">Thread IDï¼š11</span><br><span class="line">Thread IDï¼š14</span><br><span class="line">Thread IDï¼š13</span><br><span class="line">Thread IDï¼š10</span><br><span class="line">Thread IDï¼š11</span><br><span class="line">Thread IDï¼š12</span><br><span class="line">Thread IDï¼š14</span><br><span class="line">Thread IDï¼š13</span><br></pre></td></tr></table></figure></p>
<p>ç»“åˆè®¾ç½®çš„å‚æ•°ï¼Œå¤§å®¶æ˜¯ä¸æ˜¯éšéšå‘ç°äº†ä»€ä¹ˆï¼Ÿæ¨¡ç³Šçš„è¯·å¾€ä¸‹çœ‹ã€‚</p>
<h1 id="æ„é€ "><a href="#æ„é€ " class="headerlink" title="æ„é€ "></a>æ„é€ </h1><p>æˆ‘ä»¬ä¸»è¦è¿˜æ˜¯è®°ä½è¿™7ä¸ªå‚æ•°çš„å«ä¹‰ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¿éšœçº¿ç¨‹æ± è¿è¡Œçš„æœ€å°‘çš„çº¿ç¨‹æ•°</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> corePoolSize;</span><br><span class="line"><span class="comment">// æœ€å¤§çº¿ç¨‹æ•°ï¼Œå®ƒæ”¶åˆ°CAPACITY((2^29)-1)çš„é™åˆ¶</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> maximumPoolSize;</span><br><span class="line"><span class="comment">// å½“çº¿ç¨‹æ€»æ•°è¶…å¤šcorePoolSizeæ—¶ï¼Œå¦‚æœçº¿ç¨‹ç©ºé—²è¶…è¿‡è¿™ä¸ªæ—¶é—´(ç»“åˆunitæ—¶é—´å•ä½)ï¼Œå°†è¢«å›æ”¶</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> keepAliveTime;</span><br><span class="line"><span class="comment">// å½“çº¿ç¨‹æ± æ¥ä¸åŠæ‰§è¡Œä»»åŠ¡æ—¶ï¼Œä¼šå°†ä»»åŠ¡æš‚æ—¶æ”¾åœ¨é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…åç»­å¤„ç†</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; workQueue;</span><br><span class="line"><span class="comment">// çº¿ç¨‹å·¥å‚</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> ThreadFactory threadFactory;</span><br><span class="line"><span class="comment">// å½“çº¿ç¨‹æ± é¥±å’Œæˆ–è€…ä¼˜é›…å…³é—­çš„æ—¶å€™è°ƒç”¨</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> RejectedExecutionHandler handler;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ThreadPoolExecutor</span><span class="params">(<span class="keyword">int</span> corePoolSize,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">int</span> maximumPoolSize,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">long</span> keepAliveTime,</span></span></span><br><span class="line"><span class="function"><span class="params">                          TimeUnit unit,</span></span></span><br><span class="line"><span class="function"><span class="params">                          BlockingQueue&lt;Runnable&gt; workQueue,</span></span></span><br><span class="line"><span class="function"><span class="params">                          ThreadFactory threadFactory,</span></span></span><br><span class="line"><span class="function"><span class="params">                          RejectedExecutionHandler handler)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.corePoolSize = corePoolSize;</span><br><span class="line">    <span class="keyword">this</span>.maximumPoolSize = maximumPoolSize;</span><br><span class="line">    <span class="keyword">this</span>.workQueue = workQueue;</span><br><span class="line">    <span class="keyword">this</span>.keepAliveTime = unit.toNanos(keepAliveTime);</span><br><span class="line">    <span class="keyword">this</span>.threadFactory = threadFactory;</span><br><span class="line">    <span class="keyword">this</span>.handler = handler;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="execute"><a href="#execute" class="headerlink" title="execute"></a>execute</h1><p>æœ€ä¸ºä¸€ä¸ªExecutorï¼Œexecuteæ˜¯ä»–æœ€æ ¸å¿ƒçš„æ–¹æ³•ï¼Œæˆ‘ä»¬çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ctlï¼ˆçº¿ç¨‹æ± æ§åˆ¶çŠ¶æ€ï¼‰åŒ…å«äº†ä¸¤ä¸ªæ¦‚å¿µ</span></span><br><span class="line"><span class="comment"> * 1. workerCountï¼šä»£è¡¨æœ‰æ•ˆçš„çº¿ç¨‹æ•°</span></span><br><span class="line"><span class="comment"> * 2. runStateï¼šä»£è¡¨äº†è¿è¡ŒçŠ¶æ€</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger ctl = <span class="keyword">new</span> AtomicInteger(ctlOf(RUNNING, <span class="number">0</span>));</span><br><span class="line"><span class="comment">// ä¿å­˜å·¥ä½œçº¿ç¨‹</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> HashSet&lt;Worker&gt; workers = <span class="keyword">new</span> HashSet&lt;Worker&gt;();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable command)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (command == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * ä¸»è¦æœ‰ä¸‹é¢ä¸‰ä¸ªæ­¥éª¤:</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 1. åˆ¤æ–­å½“å‰çš„çº¿ç¨‹æ•°æ˜¯å¦å°äºcorePoolSize</span></span><br><span class="line"><span class="comment">     *    å¦‚æœæ˜¯ï¼Œä½¿ç”¨ä¼ è¿›æ¥çš„ä»»åŠ¡é€šè¿‡addWordæ–¹æ³•åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹ï¼Œå¦‚æœèƒ½å®Œæˆæ–°çº¿ç¨‹åˆ›å»ºexexuteæ–¹æ³•ç»“æŸï¼ŒæˆåŠŸæäº¤ä»»åŠ¡</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 2. åœ¨ç¬¬ä¸€æ­¥æ²¡æœ‰å®Œæˆä»»åŠ¡æäº¤ï¼›çŠ¶æ€ä¸ºè¿è¡Œå¹¶ä¸”èƒ½å¦æˆåŠŸåŠ å…¥ä»»åŠ¡åˆ°å·¥ä½œé˜Ÿåˆ—åï¼Œå†è¿›è¡Œä¸€æ¬¡check</span></span><br><span class="line"><span class="comment">     * å¦‚æœçŠ¶æ€åœ¨ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—åå˜ä¸ºäº†éè¿è¡Œï¼ˆæœ‰å¯èƒ½æ˜¯åœ¨æ‰§è¡Œåˆ°è¿™é‡Œçº¿ç¨‹æ± shutdownäº†ï¼‰ï¼Œéè¿è¡ŒçŠ¶æ€ä¸‹å½“ç„¶æ˜¯éœ€è¦rejectï¼›ç„¶åå†åˆ¤æ–­å½“å‰çº¿ç¨‹æ•°æ˜¯å¦ä¸º0ï¼ˆæœ‰å¯èƒ½è¿™ä¸ªæ—¶å€™çº¿ç¨‹æ•°å˜ä¸ºäº†0ï¼‰ï¼Œå¦‚æ˜¯ï¼Œæ–°å¢ä¸€ä¸ªçº¿ç¨‹ï¼›</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 3. å¦‚æœä¸èƒ½åŠ å…¥ä»»åŠ¡åˆ°å·¥ä½œé˜Ÿåˆ—ï¼Œå°†å°è¯•ä½¿ç”¨ä»»åŠ¡æ–°å¢ä¸€ä¸ªçº¿ç¨‹</span></span><br><span class="line"><span class="comment">     * å¦‚æœå¤±è´¥ï¼Œåˆ™æ˜¯çº¿ç¨‹æ± å·²ç»shutdownæˆ–è€…çº¿ç¨‹æ± å·²ç»è¾¾åˆ°é¥±å’ŒçŠ¶æ€ï¼Œæ‰€ä»¥rejectè¿™ä¸ªä»–ä»»åŠ¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">    <span class="comment">// å®é™…çº¿ç¨‹æ•°å°äºæ ¸å¿ƒçº¿ç¨‹æ•°</span></span><br><span class="line">    <span class="keyword">if</span> (workerCountOf(c) &lt; corePoolSize) &#123;</span><br><span class="line">        <span class="comment">// å¢åŠ ä¸€ä¸ªçº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">if</span> (addWorker(command, <span class="keyword">true</span>))</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="comment">// æ›´æ–°çº¿ç¨‹æ± çŠ¶æ€</span></span><br><span class="line">        c = ctl.get();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å½“çº¿ç¨‹æ± å¤„äºè¿è¡ŒçŠ¶æ€ ä¸” æ·»åŠ è¿›é˜Ÿåˆ—æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">if</span> (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123;</span><br><span class="line">        <span class="comment">// å†æ¬¡å¯¹çº¿ç¨‹æ± çŠ¶æ€æ£€æŸ¥</span></span><br><span class="line">        <span class="keyword">int</span> recheck = ctl.get();</span><br><span class="line">        <span class="comment">// çº¿ç¨‹æ± çŠ¶æ€ä¸æ˜¯è¿è¡ŒçŠ¶æ€ï¼Œä¸”ä»é˜Ÿåˆ—åˆ é™¤è¯¥ä»»åŠ¡æˆåŠŸ</span></span><br><span class="line">        <span class="keyword">if</span> (! isRunning(recheck) &amp;&amp; remove(command))</span><br><span class="line">            <span class="comment">// æ‹’ç»ä»»åŠ¡</span></span><br><span class="line">            reject(command);</span><br><span class="line">        <span class="comment">// å¦‚æœå½“å‰å·¥ä½œçº¿ç¨‹æ•°é‡ä¸º0ï¼ˆçº¿ç¨‹æ± å·²å…³é—­ï¼‰</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (workerCountOf(recheck) == <span class="number">0</span>)</span><br><span class="line">            <span class="comment">// æ·»åŠ ä¸€ä¸ª null åˆ°é˜Ÿåˆ—ä¸­</span></span><br><span class="line">            addWorker(<span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœæ·»åŠ é˜Ÿåˆ—å¤±è´¥ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªä»»åŠ¡çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!addWorker(command, <span class="keyword">false</span>))</span><br><span class="line">        <span class="comment">// å¦‚æœå¤±è´¥ï¼ˆé¥±å’Œï¼‰ï¼Œåˆ™æ‹’ç»</span></span><br><span class="line">        reject(command);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ–°å¢çº¿ç¨‹</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">addWorker</span><span class="params">(Runnable firstTask, <span class="keyword">boolean</span> core)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Javaæ ‡ç­¾</span></span><br><span class="line">    retry:</span><br><span class="line">    <span class="comment">// æ­»å¾ªç¯</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">        <span class="comment">// è·å–å½“å‰çº¿ç¨‹æ± çŠ¶æ€</span></span><br><span class="line">        <span class="keyword">int</span> rs = runStateOf(c);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check if queue empty only if necessary.</span></span><br><span class="line">        <span class="comment">// ä¸‹é¢çš„é€»è¾‘å¯ä»¥æ”¹ä¸ºè¿™æ ·</span></span><br><span class="line">        <span class="comment">// rs &gt;= shutdown &amp;&amp; (rs != shutdown || firstTask != null || workQueue.isEmpty())</span></span><br><span class="line">        <span class="comment">// è¡¨ç¤ºä¸‹é¢è¿™å‡ ç§æƒ…å†µå‡ä¸æ¥å—æ–°ä»»åŠ¡</span></span><br><span class="line">        <span class="comment">// 1. rs &gt; shutdown</span></span><br><span class="line">        <span class="comment">// 2. rs &gt;= shutdown &amp;&amp; firstTask != null</span></span><br><span class="line">        <span class="comment">// 3. rs &gt;= shutdown &amp;&amp; workQueue.isEmppty</span></span><br><span class="line">        <span class="keyword">if</span> (rs &gt;= SHUTDOWN &amp;&amp;</span><br><span class="line">            ! (rs == SHUTDOWN &amp;&amp;</span><br><span class="line">               firstTask == <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">               ! workQueue.isEmpty()))</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">// è·å–çº¿ç¨‹æ± ä¸­çº¿ç¨‹æ•°é‡</span></span><br><span class="line">            <span class="keyword">int</span> wc = workerCountOf(c);</span><br><span class="line">            <span class="comment">// å¦‚æœè¶…å‡ºå®¹é‡æˆ–è€…è¶…å‡ºæ ¸å¿ƒçº¿ç¨‹æ•°æˆ–æœ€å¤§çº¿ç¨‹æ•°(ç”±coreå†³å®š)</span></span><br><span class="line">            <span class="keyword">if</span> (wc &gt;= CAPACITY ||</span><br><span class="line">                wc &gt;= (core ? corePoolSize : maximumPoolSize))</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            <span class="comment">// çº¿ç¨‹å®‰å…¨å¢åŠ å·¥ä½œçº¿ç¨‹æ•°</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndIncrementWorkerCount(c))</span><br><span class="line">                <span class="comment">// / è·³å‡ºretry</span></span><br><span class="line">                <span class="keyword">break</span> retry;</span><br><span class="line">            c = ctl.get();  <span class="comment">// Re-read ctl</span></span><br><span class="line">            <span class="comment">// å¦‚æœçº¿ç¨‹æ± çŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼Œé‡æ–°å¾ªç¯</span></span><br><span class="line">            <span class="keyword">if</span> (runStateOf(c) != rs)</span><br><span class="line">                <span class="keyword">continue</span> retry;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// çº¿ç¨‹æ·»åŠ æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">boolean</span> workerStarted = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> workerAdded = <span class="keyword">false</span>;</span><br><span class="line">    Worker w = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// Workerä»£ç†äº†ä»»åŠ¡å¯¹è±¡ï¼Œå¯ä»¥çœ‹å…¶æ„é€ æ–¹æ³•</span></span><br><span class="line">        w = <span class="keyword">new</span> Worker(firstTask);</span><br><span class="line">        <span class="keyword">final</span> Thread t = w.thread;</span><br><span class="line">        <span class="keyword">if</span> (t != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> ReentrantLock mainLock = <span class="keyword">this</span>.mainLock;</span><br><span class="line">            mainLock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// æ‹¿åˆ°çº¿ç¨‹æ± çŠ¶æ€</span></span><br><span class="line">                <span class="keyword">int</span> rs = runStateOf(ctl.get());</span><br><span class="line">                <span class="comment">// RUNNINGçŠ¶æ€ || SHUTDONWçŠ¶æ€ä¸‹æ¸…ç†é˜Ÿåˆ—ä¸­å‰©ä½™çš„ä»»åŠ¡</span></span><br><span class="line">                <span class="keyword">if</span> (rs &lt; SHUTDOWN ||</span><br><span class="line">                    (rs == SHUTDOWN &amp;&amp; firstTask == <span class="keyword">null</span>)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (t.isAlive()) <span class="comment">// precheck that t is startable</span></span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalThreadStateException();</span><br><span class="line">                    <span class="comment">// å°†æ–°åˆ›å»ºçš„çº¿ç¨‹æ”¾è¿›çº¿ç¨‹Seté‡Œ</span></span><br><span class="line">                    workers.add(w);</span><br><span class="line">                    <span class="comment">// æ›´æ–°çº¿ç¨‹æ± çº¿ç¨‹æ•°ä¸”ä¸è¶…è¿‡æœ€å¤§å€¼</span></span><br><span class="line">                    <span class="keyword">int</span> s = workers.size();</span><br><span class="line">                    <span class="keyword">if</span> (s &gt; largestPoolSize)</span><br><span class="line">                        largestPoolSize = s;</span><br><span class="line">                    workerAdded = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                mainLock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¯åŠ¨æ–°æ·»åŠ çš„çº¿ç¨‹ï¼Œè¿™ä¸ªçº¿ç¨‹é¦–å…ˆæ‰§è¡ŒfirstTaskï¼Œç„¶åä¸åœçš„ä»é˜Ÿåˆ—ä¸­å–ä»»åŠ¡æ‰§è¡Œ</span></span><br><span class="line">            <span class="keyword">if</span> (workerAdded) &#123;</span><br><span class="line">                <span class="comment">// åœ¨ä¸‹ä¸€èŠ‚workerä¸­åˆ†æ</span></span><br><span class="line">                t.start();</span><br><span class="line">                workerStarted = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// çº¿ç¨‹å¯åŠ¨å¤±è´¥ï¼Œåˆ™ä»wokersä¸­ç§»é™¤wå¹¶é€’å‡wokerCount</span></span><br><span class="line">        <span class="keyword">if</span> (! workerStarted)</span><br><span class="line">            <span class="comment">// é€’å‡wokerCountä¼šè§¦å‘tryTerminateæ–¹æ³•</span></span><br><span class="line">            addWorkerFailed(w);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> workerStarted;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="worker"><a href="#worker" class="headerlink" title="worker"></a>worker</h1><p>workerå¯¹è±¡ä»£ç†äº†ä»»åŠ¡ï¼Œæˆ‘ä»¬çœ‹çœ‹å®ƒçš„å®ç°ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä»£ç†ä»»åŠ¡æ‰§è¡Œçš„çº¿ç¨‹</span></span><br><span class="line"><span class="keyword">final</span> Thread thread;</span><br><span class="line"><span class="comment">// ç¬¬ä¸€ä¸ªä»»åŠ¡</span></span><br><span class="line">Runnable firstTask;</span><br><span class="line">Worker(Runnable firstTask) &#123;</span><br><span class="line">    setState(-<span class="number">1</span>); <span class="comment">// inhibit interrupts until runWorker</span></span><br><span class="line">    <span class="keyword">this</span>.firstTask = firstTask;</span><br><span class="line">    <span class="comment">// è¿™é‡Œå°±ç”¨åˆ°æˆ‘ä»¬åœ¨ä¾‹å­ä¸­çš„ä¼ å…¥çš„å·¥å‚ï¼ˆæ³¨æ„æ˜¯è¿™ä¸ªthisï¼Œå°†workerè‡ªå·±ä½œä¸ºä¸€ä¸ªRunnabelï¼‰</span></span><br><span class="line">    <span class="keyword">this</span>.thread = getThreadFactory().newThread(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DefaultThreadFactory</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable r)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œåé¢å°±æ˜¯çº¿ç¨‹åäº†ï¼Œåœ¨æ„é€ å·¥å‚çš„æ—¶å€™å°±ç¡®å®šäº†</span></span><br><span class="line">    Thread t = <span class="keyword">new</span> Thread(group, r,</span><br><span class="line">                          namePrefix + threadNumber.getAndIncrement(),</span><br><span class="line">                          <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (t.isDaemon())</span><br><span class="line">        t.setDaemon(<span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (t.getPriority() != Thread.NORM_PRIORITY)</span><br><span class="line">        t.setPriority(Thread.NORM_PRIORITY);</span><br><span class="line">    <span class="keyword">return</span> t;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// workæ‰§è¡Œä»»åŠ¡</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è¿™ä¸ªæ–¹æ³•å¤ªæ ¸å¿ƒï¼Œå•ç‹¬æ‹¿å‡ºæ¥</span></span><br><span class="line">    runWorker(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="runWorker"><a href="#runWorker" class="headerlink" title="runWorker"></a>runWorker</h1><p>ä¸»è¦çš„å·¥ä½œå°±æ˜¯ç¬¬ä¸€æ¬¡å¯åŠ¨ä¼šæ‰§è¡Œåˆå§‹åŒ–ä¼ è¿›æ¥çš„ä»»åŠ¡firstTaskï¼›ç„¶åä¼šå¾ªç¯ä»workQueueä¸­å–ä»»åŠ¡æ‰§è¡Œï¼Œå¦‚æœé˜Ÿåˆ—ä¸ºç©ºåˆ™ç­‰å¾…keepAliveTimeè¿™ä¹ˆé•¿æ—¶é—´ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">runWorker</span><span class="params">(Worker w)</span> </span>&#123;</span><br><span class="line">    Thread wt = Thread.currentThread();</span><br><span class="line">    <span class="comment">// æ‹¿åˆ°firstTask</span></span><br><span class="line">    Runnable task = w.firstTask;</span><br><span class="line">    <span class="comment">// ç­‰å¾…gc</span></span><br><span class="line">    w.firstTask = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// å…è®¸ä¸­æ–­</span></span><br><span class="line">    w.unlock(); <span class="comment">// allow interrupts</span></span><br><span class="line">    <span class="keyword">boolean</span> completedAbruptly = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// taskä¸ä¸ºç©º æˆ– é˜Ÿåˆ—ä¸ä¸ºç©º å…³æ³¨getTaskæ–¹æ³•è§£æ</span></span><br><span class="line">        <span class="keyword">while</span> (task != <span class="keyword">null</span> || (task = getTaskæ–¹æ³•è§£æ()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            w.lock();</span><br><span class="line">            <span class="comment">// ä¸­æ–­å¤„ç†</span></span><br><span class="line">            <span class="keyword">if</span> ((runStateAtLeast(ctl.get(), STOP) ||</span><br><span class="line">                 (Thread.interrupted() &amp;&amp;</span><br><span class="line">                  runStateAtLeast(ctl.get(), STOP))) &amp;&amp;</span><br><span class="line">                !wt.isInterrupted())</span><br><span class="line">                wt.interrupt();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// æ‰§è¡Œå‰é’©å­</span></span><br><span class="line">                beforeExecute(wt, task);</span><br><span class="line">                Throwable thrown = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// è°ƒç”¨ä»»åŠ¡çš„runæ–¹æ³•</span></span><br><span class="line">                    task.run();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RuntimeException x) &#123;</span><br><span class="line">                    thrown = x; <span class="keyword">throw</span> x;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Error x) &#123;</span><br><span class="line">                    thrown = x; <span class="keyword">throw</span> x;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable x) &#123;</span><br><span class="line">                    thrown = x; <span class="keyword">throw</span> <span class="keyword">new</span> Error(x);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">// æ‰§è¡Œåé’©å­</span></span><br><span class="line">                    afterExecute(task, thrown);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// ç­‰å¾…gc</span></span><br><span class="line">                task = <span class="keyword">null</span>;</span><br><span class="line">                w.completedTasks++;</span><br><span class="line">                w.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        completedAbruptly = <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// Workerçš„å–„åï¼Œä»çº¿ç¨‹æ± ä¸­ç§»é™¤è¶…æ—¶æˆ–è€…å‡ºç°å¼‚å¸¸çš„çº¿ç¨‹</span></span><br><span class="line">        processWorkerExit(w, completedAbruptly);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å–ä»»åŠ¡ï¼Œè¿™é‡Œå…³æ³¨è¶…æ—¶é—®é¢˜ä»¥åŠkeepAliveTimeèµ·ä½œç”¨çš„ä»£ç æ®µ</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Runnable <span class="title">getTask</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è¶…æ—¶æ ‡å¿—ä½</span></span><br><span class="line">    <span class="keyword">boolean</span> timedOut = <span class="keyword">false</span>; <span class="comment">// Did the last poll() time out?</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// è·å–çº¿ç¨‹æ± çŠ¶æ€</span></span><br><span class="line">        <span class="keyword">int</span> c = ctl.get();</span><br><span class="line">        <span class="keyword">int</span> rs = runStateOf(c);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check if queue empty only if necessary.</span></span><br><span class="line">        <span class="comment">// æœ‰ä¸‹é¢ä¸¤ç§æƒ…å†µæˆç«‹</span></span><br><span class="line">        <span class="comment">// 1. rs &gt; SHUTDOWN æ‰€ä»¥rsè‡³å°‘ç­‰äºSTOP,è¿™æ—¶ä¸å†å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡</span></span><br><span class="line">        <span class="comment">// 2. rs = SHUTDOWN æ‰€ä»¥rs&gt;=STOPè‚¯å®šä¸æˆç«‹ï¼Œè¿™æ—¶è¿˜éœ€è¦å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡é™¤éé˜Ÿåˆ—ä¸ºç©º</span></span><br><span class="line">        <span class="keyword">if</span> (rs &gt;= SHUTDOWN &amp;&amp; (rs &gt;= STOP || workQueue.isEmpty())) &#123;</span><br><span class="line">            <span class="comment">// ä»‹ç»ä¹‹å‰ï¼Œé€’å‡workerCountå€¼</span></span><br><span class="line">            decrementWorkerCount();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> wc = workerCountOf(c);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ ‡è®°ä»é˜Ÿåˆ—ä¸­å–ä»»åŠ¡æ—¶æ˜¯å¦è®¾ç½®è¶…æ—¶æ—¶é—´</span></span><br><span class="line">        <span class="keyword">boolean</span> timed = allowCoreThreadTimeOut || wc &gt; corePoolSize;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. å¦‚æœè¿è¡Œçº¿ç¨‹æ•°è¶…è¿‡äº†æœ€å¤§çº¿ç¨‹æ•°ï¼Œä½†æ˜¯ç¼“å­˜é˜Ÿåˆ—å·²ç»ç©ºäº†ï¼Œè¿™æ—¶é€’å‡workeræ•°é‡</span></span><br><span class="line">        <span class="comment">// 2. å¦‚æœè®¾ç½®æœ‰æ ¸å¿ƒçº¿ç¨‹æœ‰è¶…æ—¶æ—¶é—´è¦æ±‚æˆ–è€…çº¿ç¨‹æ•°è¿œå¤§äºæ ¸å¿ƒçº¿ç¨‹æ•° ä¸” ç¼“å­˜é˜Ÿåˆ—å·²ç»ç©ºäº†è¿™æ—¶é€’å‡workeræ•°é‡</span></span><br><span class="line">        <span class="keyword">if</span> ((wc &gt; maximumPoolSize || (timed &amp;&amp; timedOut))</span><br><span class="line">            &amp;&amp; (wc &gt; <span class="number">1</span> || workQueue.isEmpty())) &#123;</span><br><span class="line">            <span class="keyword">if</span> (compareAndDecrementWorkerCount(c))</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ²¡æœ‰è®¾ç½®æ ¸å¿ƒçº¿ç¨‹æœ‰è¶…æ—¶æ—¶é—´è¦æ±‚æˆ–è€…çº¿ç¨‹æ•°è¿œå°äºæ ¸å¿ƒçº¿ç¨‹æ•°å°±takeï¼Œå¦åˆ™å°±å¸¦keepAliveTimeå¾—poll</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runnable r = timed ?</span><br><span class="line">                workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :</span><br><span class="line">                workQueue.take();</span><br><span class="line">            <span class="keyword">if</span> (r != <span class="keyword">null</span>)</span><br><span class="line">                <span class="keyword">return</span> r;</span><br><span class="line">            <span class="comment">// è¶…æ—¶</span></span><br><span class="line">            timedOut = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException retry) &#123;</span><br><span class="line">            <span class="comment">// çº¿ç¨‹è¢«ä¸­æ–­é‡è¯•</span></span><br><span class="line">            timedOut = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="submit"><a href="#submit" class="headerlink" title="submit"></a>submit</h1><p>å½“æˆ‘ä»¬å¯¹äºçº¿ç¨‹æ‰§è¡Œä¸éœ€è¦è¿”å›ç»“æœæ—¶ï¼Œç›´æ¥è°ƒç”¨çº¿ç¨‹çš„executeæ–¹æ³•æ¥æäº¤ä»»åŠ¡å°±å¥½äº†ã€‚ç„¶è€Œå¾ˆå¤šæ—¶å€™æˆ‘ä»¬éœ€è¦çº¿ç¨‹æ‰§è¡Œçš„è¿”å›ç»“æœï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦è°ƒç”¨submitæ–¹æ³•æ¥æäº¤ä»»åŠ¡ã€‚è™½ç„¶å®ƒæœ€åä¹Ÿä¼šè°ƒç”¨åˆ°executeæ–¹æ³•ï¼Œä½†æ˜¯ä»–ä»¬å…·ä½“ä¸åŒåœ¨å“ªé‡Œï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// submitæ–¹æ³•æ¥è‡ªäºAbstractExecutorService</span></span><br><span class="line"><span class="keyword">public</span> Future&lt;?&gt; submit(Runnable task) &#123;</span><br><span class="line">    <span class="keyword">if</span> (task == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="comment">// å°†taskè¿›è¡Œäº†å°è£…</span></span><br><span class="line">    RunnableFuture&lt;Void&gt; ftask = newTaskFor(task, <span class="keyword">null</span>);</span><br><span class="line">    <span class="comment">// å‰©ä¸‹çš„å°±ä¸€æ ·äº†</span></span><br><span class="line">    execute(ftask);</span><br><span class="line">    <span class="keyword">return</span> ftask;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AbstractExecutorService</span></span><br><span class="line"><span class="keyword">protected</span> &lt;T&gt; <span class="function">RunnableFuture&lt;T&gt; <span class="title">newTaskFor</span><span class="params">(Runnable runnable, T value)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å°†Runnableå°è£…æˆFutureTask</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> FutureTask&lt;T&gt;(runnable, value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// FutureTask</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">FutureTask</span><span class="params">(Runnable runnable, V result)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å°†Runnableå°è£…æˆcallable</span></span><br><span class="line">    <span class="keyword">this</span>.callable = Executors.callable(runnable, result);</span><br><span class="line">    <span class="comment">// ç¡®ä¿callableçš„å¯è§æ€§</span></span><br><span class="line">    <span class="keyword">this</span>.state = NEW;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¹æ®å‰é¢çš„executeæ–¹æ³•çš„åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“æœ€åçš„æ‰§è¡Œä¼šè°ƒç”¨åˆ°FutureTaskçš„runæ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// çŠ¶æ€ä¸ä¸ºNEWæˆ–è€…UNSAFEä¸æˆåŠŸï¼Œåˆ™è¿è¡Œå¤±è´¥</span></span><br><span class="line">    <span class="keyword">if</span> (state != NEW ||</span><br><span class="line">        !UNSAFE.compareAndSwapObject(<span class="keyword">this</span>, runnerOffset,</span><br><span class="line">                                     <span class="keyword">null</span>, Thread.currentThread()))</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// æœ€ç»ˆåˆè°ƒç”¨åˆ°äº†FutureTaskä¿è¯çš„Callableå¯¹è±¡</span></span><br><span class="line">        Callable&lt;V&gt; c = callable;</span><br><span class="line">        <span class="comment">// callableä¸ä¸ºç©ºä¸”çŠ¶æ€ä¸ºNEW</span></span><br><span class="line">        <span class="keyword">if</span> (c != <span class="keyword">null</span> &amp;&amp; state == NEW) &#123;</span><br><span class="line">            V result;</span><br><span class="line">            <span class="keyword">boolean</span> ran;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// å¾—åˆ°è¿”å›å€¼</span></span><br><span class="line">                result = c.call();</span><br><span class="line">                ran = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">                result = <span class="keyword">null</span>;</span><br><span class="line">                ran = <span class="keyword">false</span>;</span><br><span class="line">                <span class="comment">// å¦‚æœæœ‰å¼‚å¸¸ï¼Œè®¾ç½®å¼‚å¸¸</span></span><br><span class="line">                setException(ex);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (ran)</span><br><span class="line">                <span class="comment">// è®¾ç½®è¿”å›å€¼ï¼Œ</span></span><br><span class="line">                set(result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        runner = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">int</span> s = state;</span><br><span class="line">        <span class="keyword">if</span> (s &gt;= INTERRUPTING)</span><br><span class="line">            handlePossibleCancellationInterrupt(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(V v)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è®¾ç½®è¿”å›å€¼ï¼Œä¹Ÿå°†çŠ¶æ€NEWå˜ä¸ºCOMPLETING</span></span><br><span class="line">    <span class="keyword">if</span> (UNSAFE.compareAndSwapInt(<span class="keyword">this</span>, stateOffset, NEW, COMPLETING)) &#123;</span><br><span class="line">        outcome = v;</span><br><span class="line">        <span class="comment">// å®Œæˆä¹‹åå°†çŠ¶æ€è®¾ç½®ä¸ºNORMAl</span></span><br><span class="line">        UNSAFE.putOrderedInt(<span class="keyword">this</span>, stateOffset, NORMAL); <span class="comment">// final state</span></span><br><span class="line">        <span class="comment">// è¿›è¡Œå˜é‡æ¸…ç†å·¥ä½œ</span></span><br><span class="line">        finishCompletion();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>åœ¨æˆ‘ä»¬submitä¹‹åä¼šå¾—åˆ°ä¸€ä¸ªFutureï¼Œæˆ‘ä»¬è¦æƒ³åˆ°è¿”å›å€¼ï¼Œæˆ‘ä»¬åªè¦è°ƒç”¨getæ–¹æ³•ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException </span>&#123;</span><br><span class="line">    <span class="comment">// æ‹¿åˆ°çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">int</span> s = state;</span><br><span class="line">    <span class="comment">// æœªå®Œæˆï¼Œåˆ™é˜»å¡ç­‰å¾…å®Œæˆï¼Œè¿™é‡Œå¯ä»¥è®¾ç½®è¶…æ—¶æ—¶é—´</span></span><br><span class="line">    <span class="keyword">if</span> (s &lt;= COMPLETING)</span><br><span class="line">        s = awaitDone(<span class="keyword">false</span>, <span class="number">0L</span>);</span><br><span class="line">    <span class="comment">// è¿˜éœ€è¦æ ¹æ®çŠ¶æ€åˆ¤æ–­æ˜¯å¦è¿”å›å€¼</span></span><br><span class="line">    <span class="keyword">return</span> report(s);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> V <span class="title">report</span><span class="params">(<span class="keyword">int</span> s)</span> <span class="keyword">throws</span> ExecutionException </span>&#123;</span><br><span class="line">    Object x = outcome;</span><br><span class="line">    <span class="comment">// å¦‚æœçŠ¶æ€ä¸ºNORMALï¼Œåˆ™è¿”å›å€¼</span></span><br><span class="line">    <span class="keyword">if</span> (s == NORMAL)</span><br><span class="line">        <span class="keyword">return</span> (V)x;</span><br><span class="line">    <span class="comment">// å¦‚æœçŠ¶æ€ä¸ºCACELLEDï¼Œåˆ™ä»£è¡¨ä»»åŠ¡å‘—å–æ¶ˆï¼ŒæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (s &gt;= CANCELLED)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> CancellationException();</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ExecutionException((Throwable)x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>è¿™é‡ŒåŸºæœ¬å°±è¦†ç›–äº†è¿è¡Œæ—¶çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾ˆå¥½å¾—ç†è§£æˆ‘ä»¬ï¼Œå½“ä»»åŠ¡æœªå®Œæˆçš„æ—¶å€™ï¼Œä¼šå‘ç”Ÿé˜»å¡ç­‰å¾…çš„æƒ…å†µã€‚</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>é€šè¿‡ä¸Šé¢æˆ‘ä»¬åŸºæœ¬çŸ¥é“äº†çº¿ç¨‹æ± çš„å®ç°åŸç†ã€‚ç„¶åå°±æ˜¯è¿ç”¨è¿™äº›åŸç†å¯¹çº¿ç¨‹æ± è¿›è¡Œè°ƒä¼˜äº†ã€‚è¿™é‡Œå…³é”®è¿˜æ˜¯è°ƒæ•´å“ªäº›æ„é€ æ—¶çš„å‚æ•°ã€‚</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol>
<li><a href="http://todorex.com/2018/01/15/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98/Java%E5%B9%B6%E5%8F%91-5-%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C/" target="_blank" rel="noopener">Javaå¹¶å‘<em>5</em>ä»»åŠ¡æ‰§è¡Œ</a></li>
<li><a href="http://todorex.com/2018/01/22/Java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E5%AE%9E%E6%88%98/Java%E5%B9%B6%E5%8F%91-7-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%9A%84%E4%BD%BF%E7%94%A8/" target="_blank" rel="noopener">Javaå¹¶å‘<em>7</em>çº¿ç¨‹æ± çš„ä½¿ç”¨</a></li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¼•ï¼šç›¸ä¿¡å¤§å®¶å·²ç»æ”¶åˆ°äº†Executoræ¡†æ¶ä»¥åŠçº¿ç¨‹æ± å¸¦æ¥çš„å¥½å¤„ï¼Œå®ƒæœ‰ç€ç¥å¥‡çš„èƒ½åŠ›ï¼Œé‚£æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒæ˜¯æ€ä¹ˆå®ç°è¿™ç§ç¥å¥‡çš„èƒ½åŠ›çš„ï¼
    
    </summary>
    
      <category term="JDKæºç åˆ†æ" scheme="http://bestlixiang.site/categories/JDK%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
    
      <category term="JDK" scheme="http://bestlixiang.site/tags/JDK/"/>
    
  </entry>
  
  <entry>
    <title>JDKæºç åˆ†æâ€”â€”ThreadLocal</title>
    <link href="http://bestlixiang.site/2018/09/07/JDK%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/JDK%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E2%80%94%E2%80%94ThreadLocal/"/>
    <id>http://bestlixiang.site/2018/09/07/JDKæºç åˆ†æ/JDKæºç åˆ†æâ€”â€”ThreadLocal/</id>
    <published>2018-09-07T02:18:38.000Z</published>
    <updated>2018-09-07T13:25:37.434Z</updated>
    
    <content type="html"><![CDATA[<p>å¼•ï¼šå¯èƒ½å¤§å®¶å¯¹ThreadLocalè¿™ä¸ªç±»æ—¢ç†Ÿæ‚‰åˆé™Œç”Ÿï¼Œçœ‹åˆ°å¾—å¤šç”¨åˆ°å¾—å°‘ã€‚<a id="more"></a></p>
<p>è¯¦ç»†æ³¨é‡Šï¼š<a href="https://github.com/todorex/JDK" target="_blank" rel="noopener">æºç åˆ†æåœ°å€</a></p>
<h1 id="æ¦‚è§ˆ"><a href="#æ¦‚è§ˆ" class="headerlink" title="æ¦‚è§ˆ"></a>æ¦‚è§ˆ</h1><p>è¯¥ç±»æä¾›äº†çº¿ç¨‹å±€éƒ¨ (thread-local) å˜é‡ã€‚ThreadLocal å®ä¾‹é€šå¸¸æ˜¯ç±»ä¸­çš„ private static å­—æ®µï¼Œå®ƒä»¬å¸Œæœ›å°†çŠ¶æ€ä¸æŸä¸€ä¸ªçº¿ç¨‹ï¼ˆä¾‹å¦‚ï¼Œç”¨æˆ· ID æˆ–äº‹åŠ¡ IDï¼‰ç›¸å…³è”ã€‚</p>
<p>æ¯ä¸ªçº¿ç¨‹éƒ½ä¿æŒå¯¹å…¶çº¿ç¨‹å±€éƒ¨å˜é‡å‰¯æœ¬çš„éšå¼å¼•ç”¨ï¼Œåªè¦çº¿ç¨‹æ˜¯æ´»åŠ¨çš„å¹¶ä¸” ThreadLocal å®ä¾‹æ˜¯å¯è®¿é—®çš„ï¼›åœ¨çº¿ç¨‹æ¶ˆå¤±ä¹‹åï¼Œå…¶çº¿ç¨‹å±€éƒ¨å®ä¾‹çš„æ‰€æœ‰å‰¯æœ¬éƒ½ä¼šè¢«åƒåœ¾å›æ”¶ï¼ˆé™¤éå­˜åœ¨å¯¹è¿™äº›å‰¯æœ¬çš„å…¶ä»–å¼•ç”¨ï¼‰</p>
<p><strong>åº”ç”¨</strong>ï¼šåœ¨å•çº¿ç¨‹åº”ç”¨ç¨‹åºä¸­å¯èƒ½ä¼šç»´æŒä¸€ä¸ªå…¨å±€çš„æ•°æ®åº“è¿æ¥ï¼Œå¹¶åœ¨ç¨‹åºå¯åŠ¨æ—¶åˆå§‹åŒ–è¿™ä¸ªè¿æ¥å¯¹è±¡ï¼Œä»è€Œé¿å…åœ¨è°ƒç”¨æ¯ä¸ªæ–¹æ³•æ—¶éƒ½è¦ä¼ é€’ä¸€ä¸ªConnectionå¯¹è±¡ã€‚ç”±äºJDBCçš„è¿æ¥å¯¹è±¡ä¸ä¸€å®šæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå› æ­¤ï¼Œå½“å¤šçº¿ç¨‹åº”ç”¨ç¨‹åºåœ¨æ²¡æœ‰ååŒçš„æƒ…å†µä¸‹ä½¿ç”¨å…¨å±€å˜é‡æ—¶ï¼Œå°±ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚é€šè¿‡å°†JDBCçš„è¿æ¥ä¿å­˜åˆ°ThreadLocalå¯¹è±¡ä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ä¼šæ‹¥æœ‰å±äºè‡ªå·±çš„è¿æ¥ã€‚</p>
<h1 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ThreadLocal&lt;String&gt; myThreadLocal = <span class="keyword">new</span> MyThreadLocal&lt;String&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¾“å‡ºleonard</span></span><br><span class="line">        System.out.println(myThreadLocal.get());</span><br><span class="line"></span><br><span class="line">        myThreadLocal.set(<span class="string">"rex"</span>);</span><br><span class="line">        <span class="comment">// è¾“å‡ºrex</span></span><br><span class="line">        System.out.println(myThreadLocal.get());</span><br><span class="line"></span><br><span class="line">        myThreadLocal.remove();</span><br><span class="line">        <span class="comment">// è¾“å‡ºleonard</span></span><br><span class="line">        System.out.println(myThreadLocal.get());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThreadLocal</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">ThreadLocal</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> T <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (T) <span class="string">"leonard"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="get"><a href="#get" class="headerlink" title="get"></a>get</h1><p>è¿”å›çº¿ç¨‹å±€éƒ¨å˜é‡çš„å½“å‰çº¿ç¨‹å‰¯æœ¬ä¸­çš„å€¼ã€‚å¦‚æœå½“å‰çº¿ç¨‹ä¸­ä¿å­˜çš„å˜é‡å‰¯æœ¬æ²¡æœ‰å€¼ï¼Œåˆ™å…ˆå°†è°ƒç”¨ initialValue() æ–¹æ³•åˆå§‹åŒ–ç„¶åè¿”å›å€¼ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ‹¿åˆ°å½“å‰çº¿ç¨‹</span></span><br><span class="line">    Thread t = Thread.currentThread();</span><br><span class="line">    <span class="comment">// æ‹¿åˆ° ThreadLocalMap è¿™ä¸ªMap</span></span><br><span class="line">    ThreadLocalMap map = getMap(t);</span><br><span class="line">    <span class="keyword">if</span> (map != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// æ‹¿åˆ°èŠ‚ç‚¹</span></span><br><span class="line">        ThreadLocalMap.Entry e = map.getEntry(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">            <span class="comment">// è¿”å›ä¿å­˜çš„å€¼</span></span><br><span class="line">            T result = (T)e.value;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä¸å­˜åœ¨è¿™æ ·çš„mapï¼Œåˆ™è®¾ç½®åˆå§‹åŒ–ï¼Œç„¶åè¿”å›å€¼</span></span><br><span class="line">    <span class="keyword">return</span> setInitialValue();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‹¿åˆ°ä¸ThreadLocalå…³è”çš„Map</span></span><br><span class="line"><span class="function">ThreadLocalMap <span class="title">getMap</span><span class="params">(Thread t)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ä¸å½“å‰çº¿ç¨‹ç»‘å®š</span></span><br><span class="line">    <span class="keyword">return</span> t.threadLocals;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ThreadLocalçš„æ•°æ®ç»“æ„æ˜¯ä¸€ä¸ªHashMap</span></span><br><span class="line"><span class="comment">// èŠ‚ç‚¹æ˜¯ç»§æ‰¿äº† WeakReference(å¼±å¼•ç”¨)</span></span><br><span class="line"><span class="comment">// å¦‚æœä¸€ä¸ªå¯¹è±¡å…·æœ‰å¼±å¼•ç”¨ï¼Œåœ¨GCçº¿ç¨‹æ‰«æå†…å­˜åŒºåŸŸçš„è¿‡ç¨‹ä¸­ï¼Œä¸ç®¡å½“å‰å†…å­˜ç©ºé—´è¶³å¤Ÿä¸å¦ï¼Œéƒ½ä¼šå›æ”¶å†…å­˜</span></span><br><span class="line"><span class="comment">// æˆ‘ä»¬å…³æ³¨getEntryæ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Entry <span class="title">getEntry</span><span class="params">(ThreadLocal&lt;?&gt; key)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ‹¿åˆ°æ•°ç»„ä¸‹æ ‡</span></span><br><span class="line">    <span class="keyword">int</span> i = key.threadLocalHashCode &amp; (table.length - <span class="number">1</span>);</span><br><span class="line">    Entry e = table[i];</span><br><span class="line">    <span class="comment">// Hashå€¼æ²¡æœ‰å†²çª</span></span><br><span class="line">    <span class="keyword">if</span> (e != <span class="keyword">null</span> &amp;&amp; e.get() == key)</span><br><span class="line">        <span class="keyword">return</span> e;</span><br><span class="line">    <span class="comment">// Hashå€¼å†²çª</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> getEntryAfterMiss(key, i, e);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> Entry <span class="title">getEntryAfterMiss</span><span class="params">(ThreadLocal&lt;?&gt; key, <span class="keyword">int</span> i, Entry e)</span> </span>&#123;</span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="keyword">int</span> len = tab.length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (e != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// æ‹¿åˆ°èŠ‚ç‚¹å¯¹åº”çš„ThreadLocal(key) å¼±å¼•ç”¨</span></span><br><span class="line">        ThreadLocal&lt;?&gt; k = e.get();</span><br><span class="line">        <span class="keyword">if</span> (k == key)</span><br><span class="line">            <span class="keyword">return</span> e;</span><br><span class="line">        <span class="keyword">if</span> (k == <span class="keyword">null</span>)</span><br><span class="line">            <span class="comment">// æ¸…ç†æ•°ç»„</span></span><br><span class="line">            expungeStaleEntry(i);</span><br><span class="line">        <span class="comment">// å­˜å‚¨åˆ°ä¸‹ä¸€ä¸ªä¸‹æ ‡é‡Œï¼ˆå¤„ç†Hashå†²çªé‡‡ç”¨çš„æ˜¯çº¿æ€§æ¢æµ‹æ³•ï¼‰</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            i = nextIndex(i, len);</span><br><span class="line">        e = tab[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®åˆå§‹åŒ–çš„å€¼ï¼Œç„¶åè¿”å›</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> T <span class="title">setInitialValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ‹¿åˆ°åˆå§‹å€¼</span></span><br><span class="line">    T value = initialValue();</span><br><span class="line">    <span class="comment">// æ‹¿åˆ°å½“å‰çº¿ç¨‹</span></span><br><span class="line">    Thread t = Thread.currentThread();</span><br><span class="line">    <span class="comment">// æ‹¿åˆ°å½“å‰çº¿ç¨‹çš„ThreadLocalMap</span></span><br><span class="line">    ThreadLocalMap map = getMap(t);</span><br><span class="line">    <span class="comment">// Mapå·²ç»å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> (map != <span class="keyword">null</span>)</span><br><span class="line">        <span class="comment">// è®¾ç½®ThreadLocalå¯¹åº”çš„å€¼</span></span><br><span class="line">        map.set(<span class="keyword">this</span>, value);</span><br><span class="line">    <span class="comment">// Mapä¸å­˜åœ¨ï¼Œåˆ›å»ºMap</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        createMap(t, value);</span><br><span class="line">    <span class="comment">// è¿”å›è¯¥å€¼</span></span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="Set"><a href="#Set" class="headerlink" title="Set"></a>Set</h1><p>å°†çº¿ç¨‹å±€éƒ¨å˜é‡åœ¨å½“å‰çº¿ç¨‹å‰¯æœ¬ä¸­çš„å€¼è®¾ç½®ä¸ºæŒ‡å®šå€¼ã€‚å¤§éƒ¨åˆ†å­ç±»ä¸éœ€è¦é‡å†™æ­¤æ–¹æ³•ï¼Œå®ƒä»¬åªä¾é  initialValue() æ–¹æ³•æ¥è®¾ç½®çº¿ç¨‹å±€éƒ¨å˜é‡çš„å€¼ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ‹¿åˆ°å½“å‰çº¿ç¨‹</span></span><br><span class="line">    Thread t = Thread.currentThread();</span><br><span class="line">    <span class="comment">// æ‹¿åˆ°å½“å‰çº¿ç¨‹çš„ThreadLocalMap</span></span><br><span class="line">    ThreadLocalMap map = getMap(t);</span><br><span class="line">    <span class="comment">// å¦‚æœMapä¸ä¸ºç©ºï¼Œåˆ™ç›´æ¥è®¾ç½®å€¼</span></span><br><span class="line">    <span class="keyword">if</span> (map != <span class="keyword">null</span>)</span><br><span class="line">        map.set(<span class="keyword">this</span>, value);</span><br><span class="line">    <span class="comment">// å¦‚æœMapä¸ºç©ºï¼Œåˆ™åˆ›å»ºMapï¼Œç„¶åè®¾ç½®å€¼</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        createMap(t, value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">createMap</span><span class="params">(Thread t, T firstValue)</span> </span>&#123;</span><br><span class="line">    t.threadLocals = <span class="keyword">new</span> ThreadLocalMap(<span class="keyword">this</span>, firstValue);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ThreadLocalMap(ThreadLocal&lt;?&gt; firstKey, Object firstValue) &#123;</span><br><span class="line">    <span class="comment">// è®¾ç½®åˆå§‹å®¹é‡ï¼Œé»˜è®¤16</span></span><br><span class="line">    table = <span class="keyword">new</span> Entry[INITIAL_CAPACITY];</span><br><span class="line">    <span class="comment">// æ‰¾åˆ°ä¸‹æ ‡</span></span><br><span class="line">    <span class="keyword">int</span> i = firstKey.threadLocalHashCode &amp; (INITIAL_CAPACITY - <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// è®¾ç½®å€¼</span></span><br><span class="line">    table[i] = <span class="keyword">new</span> Entry(firstKey, firstValue);</span><br><span class="line">    <span class="comment">// è®¾ç½®size</span></span><br><span class="line">    size = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// è®¾ç½®é˜ˆå€¼</span></span><br><span class="line">    setThreshold(INITIAL_CAPACITY);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setThreshold</span><span class="params">(<span class="keyword">int</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è®¾ç½®é˜ˆå€¼ä¸º 16 * 2 / 3 = 10</span></span><br><span class="line">    threshold = len * <span class="number">2</span> / <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬å†æ¥çœ‹çœ‹Mapçš„setæ–¹æ³•ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(ThreadLocal&lt;?&gt; key, Object value)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="keyword">int</span> len = tab.length;</span><br><span class="line">    <span class="comment">// æ ¹æ® ThreadLocal çš„ HashCode å¾—åˆ°å¯¹åº”çš„ä¸‹æ ‡</span></span><br><span class="line">    <span class="keyword">int</span> i = key.threadLocalHashCode &amp; (len-<span class="number">1</span>);</span><br><span class="line">    <span class="comment">// é¦–å…ˆé€šè¿‡ä¸‹æ ‡æ‰¾å¯¹åº”çš„entryå¯¹è±¡</span></span><br><span class="line">    <span class="keyword">for</span> (Entry e = tab[i];</span><br><span class="line">         e != <span class="keyword">null</span>;</span><br><span class="line">         e = tab[i = nextIndex(i, len)]) &#123;</span><br><span class="line">        ThreadLocal&lt;?&gt; k = e.get();</span><br><span class="line">        <span class="comment">// æ”¹å˜å…¶å€¼</span></span><br><span class="line">        <span class="keyword">if</span> (k == key) &#123;</span><br><span class="line">            e.value = value;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœkeyè¢« GC å›æ”¶äº†ï¼Œå°±ä¼šå˜ä¸ºnullï¼ˆå› ä¸ºæ˜¯è½¯å¼•ç”¨ï¼‰ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„ entry å¯¹è±¡å¡«å……è¯¥æ§½</span></span><br><span class="line">        <span class="keyword">if</span> (k == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// è¿™ä¸ªæ–¹æ³•å¯ä»¥å¥½å¥½çœ‹çœ‹</span></span><br><span class="line">            replaceStaleEntry(key, value, i);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¯¹è±¡ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„ entryå¯¹è±¡</span></span><br><span class="line">    tab[i] = <span class="keyword">new</span> Entry(key, value);</span><br><span class="line">    <span class="comment">// size + 1</span></span><br><span class="line">    <span class="keyword">int</span> sz = ++size;</span><br><span class="line">    <span class="comment">// å¦‚æœæ²¡æœ‰æ¸…é™¤å¤šä½™çš„entry å¹¶ä¸”æ•°ç»„é•¿åº¦è¾¾åˆ°äº†é˜€å€¼ï¼Œåˆ™æ‰©å®¹</span></span><br><span class="line">    <span class="keyword">if</span> (!cleanSomeSlots(i, sz) &amp;&amp; sz &gt;= threshold)</span><br><span class="line">        <span class="comment">// æ‰©å®¹</span></span><br><span class="line">        rehash();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">rehash</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ¸…æ¥šé™ˆæ—§çš„èŠ‚ç‚¹</span></span><br><span class="line">    expungeStaleEntries();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use lower threshold for doubling to avoid hysteresis</span></span><br><span class="line">    <span class="comment">// å¦‚æœsizeå¤§äº0.75å€é˜ˆå€¼ã€‚åŸæ¥æ˜¯2/3ï¼Œ åˆ™è´Ÿè½½å› å­ç›¸å½“äºä¸º0.5ï¼Œè¿™æ˜¯åœ¨ç¬¬ä¸€æ¬¡çš„æ—¶å€™</span></span><br><span class="line">    <span class="comment">// åœ¨é¦–æ¬¡æ‰©å®¹ä¹‹åï¼Œè´Ÿè½½å› å­è¿˜æ˜¯0.75</span></span><br><span class="line">    <span class="keyword">if</span> (size &gt;= threshold - threshold / <span class="number">4</span>)</span><br><span class="line">        resize();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">resize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Entry[] oldTab = table;</span><br><span class="line">    <span class="keyword">int</span> oldLen = oldTab.length;</span><br><span class="line">    <span class="comment">// æ‰©å®¹ä¸ºåŸæ¥çš„ä¸¤å€</span></span><br><span class="line">    <span class="keyword">int</span> newLen = oldLen * <span class="number">2</span>;</span><br><span class="line">    Entry[] newTab = <span class="keyword">new</span> Entry[newLen];</span><br><span class="line">    <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; oldLen; ++j) &#123;</span><br><span class="line">        Entry e = oldTab[j];</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ThreadLocal&lt;?&gt; k = e.get();</span><br><span class="line">            <span class="keyword">if</span> (k == <span class="keyword">null</span>) &#123;</span><br><span class="line">                e.value = <span class="keyword">null</span>; <span class="comment">// Help the GC</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">int</span> h = k.threadLocalHashCode &amp; (newLen - <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">while</span> (newTab[h] != <span class="keyword">null</span>)</span><br><span class="line">                    h = nextIndex(h, newLen);</span><br><span class="line">                newTab[h] = e;</span><br><span class="line">                count++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    setThreshold(newLen);</span><br><span class="line">    size = count;</span><br><span class="line">    table = newTab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="romove"><a href="#romove" class="headerlink" title="romove"></a>romove</h1><p>ç§»é™¤æ­¤çº¿ç¨‹å±€éƒ¨å˜é‡åœ¨å½“å‰çº¿ç¨‹çš„å€¼ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¾—åˆ°å½“å‰çº¿ç¨‹çš„Map</span></span><br><span class="line">    ThreadLocalMap m = getMap(Thread.currentThread());</span><br><span class="line">    <span class="keyword">if</span> (m != <span class="keyword">null</span>)</span><br><span class="line">        m.remove(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è°ƒç”¨ThreadLocalMapçš„removeæ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(ThreadLocal&lt;?&gt; key)</span> </span>&#123;</span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="keyword">int</span> len = tab.length;</span><br><span class="line">    <span class="keyword">int</span> i = key.threadLocalHashCode &amp; (len-<span class="number">1</span>);</span><br><span class="line">    <span class="comment">// é€šè¿‡çº¿æ€§æ¢æµ‹æ³•æ‰¾åˆ° key å¯¹åº”çš„ entry</span></span><br><span class="line">    <span class="keyword">for</span> (Entry e = tab[i];</span><br><span class="line">         e != <span class="keyword">null</span>;</span><br><span class="line">         e = tab[i = nextIndex(i, len)]) &#123;</span><br><span class="line">        <span class="keyword">if</span> (e.get() == key) &#123;</span><br><span class="line">            <span class="comment">// å°†ThreadLocalè®¾ç½®ä¸ºnull</span></span><br><span class="line">            e.clear();</span><br><span class="line">            <span class="comment">// æ¸…ç†æ‰€æœ‰çš„ key ä¸º null çš„ entry</span></span><br><span class="line">            expungeStaleEntry(i);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ThreadLocalæ— é™å¥½ï¼Œä½†æ˜¯ä¹Ÿä¼šæœ‰é—®é¢˜ï¼Œæ¯”å¦‚å†…å­˜æ³„æ¼çš„é—®é¢˜ï¼ˆå¯ä»¥åœ¨åé¢çš„å‚è€ƒç†è§£è¿™ä¸ªé—®é¢˜ï¼‰ï¼Œä¸ºäº†é˜²æ­¢è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦æ¯æ¬¡ä½¿ç”¨å®ŒThreadLocalï¼Œéƒ½è°ƒç”¨å®ƒçš„remove()æ–¹æ³•ï¼Œæ¸…é™¤æ•°æ®ã€‚</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol>
<li><a href="https://www.jianshu.com/p/80284438bb97" target="_blank" rel="noopener">å¹¶å‘ç¼–ç¨‹ä¹‹ ThreadLocal æºç å‰–æ</a></li>
<li><a href="http://blog.xiaohansong.com/2016/08/06/ThreadLocal-memory-leak/" target="_blank" rel="noopener">æ·±å…¥åˆ†æ ThreadLocal å†…å­˜æ³„æ¼é—®é¢˜</a></li>
<li><a href="http://ifeve.com/%E4%BD%BF%E7%94%A8threadlocal%E4%B8%8D%E5%BD%93%E5%8F%AF%E8%83%BD%E4%BC%9A%E5%AF%BC%E8%87%B4%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2/" target="_blank" rel="noopener">ä½¿ç”¨ThreadLocalä¸å½“å¯èƒ½ä¼šå¯¼è‡´å†…å­˜æ³„éœ²</a></li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¼•ï¼šå¯èƒ½å¤§å®¶å¯¹ThreadLocalè¿™ä¸ªç±»æ—¢ç†Ÿæ‚‰åˆé™Œç”Ÿï¼Œçœ‹åˆ°å¾—å¤šç”¨åˆ°å¾—å°‘ã€‚
    
    </summary>
    
      <category term="JDKæºç åˆ†æ" scheme="http://bestlixiang.site/categories/JDK%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
    
      <category term="JDK" scheme="http://bestlixiang.site/tags/JDK/"/>
    
  </entry>
  
  <entry>
    <title>JDKæºç åˆ†æâ€”â€”LinkedHashMap</title>
    <link href="http://bestlixiang.site/2018/09/06/JDK%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/JDK%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E2%80%94%E2%80%94LinkedHashMap/"/>
    <id>http://bestlixiang.site/2018/09/06/JDKæºç åˆ†æ/JDKæºç åˆ†æâ€”â€”LinkedHashMap/</id>
    <published>2018-09-06T01:40:43.000Z</published>
    <updated>2018-09-07T13:25:42.605Z</updated>
    
    <content type="html"><![CDATA[<p>å¼•ï¼šå¦‚æœæœ‰è¿™æ ·ä¸€ç§æƒ…å½¢ï¼Œæˆ‘ä»¬éœ€è¦æŒ‰ç…§å…ƒç´ æ’å…¥çš„é¡ºåºæ¥è®¿é—®å…ƒç´ ï¼Œè¿™ä¸ªæ—¶å€™LinkedHashMapå¤§å±•èº«æ‰‹äº†ï¼Œå®ƒä¿å­˜ç€å…ƒç´ æ’å…¥çš„é¡ºåºï¼Œå¹¶ä¸”å¯ä»¥æŒ‰ç…§æˆ‘ä»¬æ’å…¥çš„é¡ºåºè¿›è¡Œè®¿é—®ã€‚<a id="more"></a></p>
<p>è¯¦ç»†æ³¨é‡Šï¼š<a href="https://github.com/todorex/JDK" target="_blank" rel="noopener">æºç åˆ†æåœ°å€</a></p>
<h1 id="æ¦‚è§ˆ"><a href="#æ¦‚è§ˆ" class="headerlink" title="æ¦‚è§ˆ"></a>æ¦‚è§ˆ</h1><p>LinkedHashMap ç»§æ‰¿è‡ª HashMapï¼Œåœ¨ HashMap åŸºç¡€ä¸Šï¼Œé€šè¿‡ç»´æŠ¤ä¸€æ¡åŒå‘é“¾è¡¨ï¼Œè§£å†³äº† HashMap ä¸èƒ½éšæ—¶ä¿æŒéå†é¡ºåºå’Œæ’å…¥é¡ºåºä¸€è‡´çš„é—®é¢˜ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒLinkedHashMap å¯¹è®¿é—®é¡ºåºä¹Ÿæä¾›äº†ç›¸å…³æ”¯æŒã€‚åœ¨ä¸€äº›åœºæ™¯ä¸‹ï¼Œè¯¥ç‰¹æ€§å¾ˆæœ‰ç”¨ï¼Œæ¯”å¦‚ç¼“å­˜ã€‚åœ¨å®ç°ä¸Šï¼ŒLinkedHashMap å¾ˆå¤šæ–¹æ³•ç›´æ¥ç»§æ‰¿è‡ª HashMapï¼Œä»…ä¸ºç»´æŠ¤åŒå‘é“¾è¡¨è¦†å†™äº†éƒ¨åˆ†æ–¹æ³•ã€‚</p>
<p>å®ƒçš„ç»“æ„ç¤ºæ„å›¾å¦‚ä¸‹ï¼š<br><img src="https://blog-pictures.oss-cn-shanghai.aliyuncs.com/15166338955699.jpg" alt="LinkedHashMap"></p>
<h1 id="æ„é€ "><a href="#æ„é€ " class="headerlink" title="æ„é€ "></a>æ„é€ </h1><p>ä¸»è¦å°±æ˜¯è®¾ç½®åˆå§‹å®¹é‡ã€è´Ÿè½½å› å­å’Œè¿­ä»£é¡ºåº<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŒå‘é“¾è¡¨çš„å¤´ï¼Œæœ€ä¹…è®¿é—®çš„</span></span><br><span class="line"><span class="keyword">transient</span> LinkedHashMap.Entry&lt;K,V&gt; head;</span><br><span class="line"><span class="comment">// åŒå‘é“¾è¡¨çš„å°¾ï¼Œæœ€æ–°è®¿é—®çš„</span></span><br><span class="line"><span class="keyword">transient</span> LinkedHashMap.Entry&lt;K,V&gt; tail;</span><br><span class="line"><span class="comment">// é»˜è®¤ä¸ºfalseï¼Œè¿­ä»£é¡ºåºæ˜¯æŒ‰ç…§æ’å…¥é¡ºåºï¼Œå½“ä¸ºtrueæ—¶ï¼Œè¿­ä»£é¡ºåºæ˜¯æŒ‰ç…§è®¿é—®ä¿¡æ¯ï¼Œæœ€è¿‘è®¿é—®åœ¨å°¾éƒ¨</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">boolean</span> accessOrder;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LinkedHashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">float</span> loadFactor,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">boolean</span> accessOrder)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// åé¢å’ŒHashMapä¸€æ ·</span></span><br><span class="line">    <span class="keyword">super</span>(initialCapacity, loadFactor);</span><br><span class="line">    <span class="keyword">this</span>.accessOrder = accessOrder;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="å¢"><a href="#å¢" class="headerlink" title="å¢"></a>å¢</h1><p>LinkedHashMap æœ¬èº«å¹¶æ²¡æœ‰è¦†å†™çˆ¶ç±»çš„ put æ–¹æ³•ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨äº†çˆ¶ç±»çš„å®ç°ã€‚ä½†åœ¨ HashMap ä¸­ï¼Œput æ–¹æ³•æ’å…¥çš„æ˜¯ HashMap å†…éƒ¨ç±» Node ç±»å‹çš„èŠ‚ç‚¹ï¼Œè¯¥ç±»å‹çš„èŠ‚ç‚¹å¹¶ä¸å…·å¤‡ä¸ LinkedHashMap å†…éƒ¨ç±» Entry åŠå…¶å­ç±»å‹èŠ‚ç‚¹ç»„æˆé“¾è¡¨çš„èƒ½åŠ›ã€‚ä¸‹é¢å°†å±•ç¤ºå»ºç«‹é“¾è¡¨çš„é€»è¾‘ï¼Œå…¶ä¸­å’ŒHashMapç›¸åŒçš„ä»£ç è¿™é‡Œå°±ä¸å¤šè¯´ï¼Œä¸çŸ¥é“çš„å¯ä»¥åœ¨å…ˆé˜…è¯»åœ¨åé¢å‚è€ƒæåˆ°çš„HashMapè§£æã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. è°ƒç”¨HashMapçš„putæ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(hash(key), key, value, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. è°ƒç”¨HashMapçš„putValæ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">boolean</span> onlyIfAbsent,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">boolean</span> evict)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// å…³é”®å°±åœ¨è¿™é‡Œï¼Œè¿™é‡Œä¼šè§¦å‘å¤šæ€ï¼Œå»è°ƒç”¨LinkedHashMapçš„æ–¹æ³•</span></span><br><span class="line">    tab[i] = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. å¤šæ€è°ƒç”¨LinkedHashMapçš„newNodeæ–¹æ³•</span></span><br><span class="line"><span class="function">Node&lt;K,V&gt; <span class="title">newNode</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, Node&lt;K,V&gt; e)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ç”ŸæˆLinkedHashMapéœ€è¦çš„èŠ‚ç‚¹</span></span><br><span class="line">    LinkedHashMap.Entry&lt;K,V&gt; p =</span><br><span class="line">        <span class="keyword">new</span> LinkedHashMap.Entry&lt;K,V&gt;(hash, key, value, e);</span><br><span class="line">    <span class="comment">// å°† Entry æ¥åœ¨åŒå‘é“¾è¡¨çš„å°¾éƒ¨</span></span><br><span class="line">    linkNodeLast(p);</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹è¿™ç§èŠ‚ç‚¹çš„æ•°æ®ç»“æ„</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">HashMap</span>.<span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// æ‹¥æœ‰å‰åæŒ‡é’ˆ</span></span><br><span class="line">    Entry&lt;K,V&gt; before, after;</span><br><span class="line">    Entry(<span class="keyword">int</span> hash, K key, V value, Node&lt;K,V&gt; next) &#123;</span><br><span class="line">        <span class="keyword">super</span>(hash, key, value, next);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. å°†æ–°å»ºçš„èŠ‚ç‚¹æ¥åœ¨åŒå‘é“¾è¡¨çš„å°¾éƒ¨</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">linkNodeLast</span><span class="params">(LinkedHashMap.Entry&lt;K,V&gt; p)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ‹¿åˆ°ä¸ºèŠ‚ç‚¹</span></span><br><span class="line">    LinkedHashMap.Entry&lt;K,V&gt; last = tail;</span><br><span class="line">    tail = p;</span><br><span class="line">    <span class="comment">// å¦‚æœå°¾èŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œåˆ™ä»£è¡¨äº†é“¾è¡¨æœªç”Ÿæˆ</span></span><br><span class="line">    <span class="keyword">if</span> (last == <span class="keyword">null</span>)</span><br><span class="line">        head = p;</span><br><span class="line">    <span class="comment">// è®¾ç½®æŒ‡é’ˆ</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        p.before = last;</span><br><span class="line">        last.after = p;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. åé¢çš„å†…å®¹å°±å’ŒHashMapä¸€æ¯›ä¸€æ ·äº†</span></span><br></pre></td></tr></table></figure></p>
<h1 id="åˆ "><a href="#åˆ " class="headerlink" title="åˆ "></a>åˆ </h1><p>ä¸æ’å…¥æ“ä½œä¸€æ ·ï¼ŒLinkedHashMap åˆ é™¤æ“ä½œç›¸å…³çš„ä»£ç ä¹Ÿæ˜¯ç›´æ¥ç”¨çˆ¶ç±»çš„å®ç°ã€‚åœ¨åˆ é™¤èŠ‚ç‚¹æ—¶ï¼Œçˆ¶ç±»çš„åˆ é™¤é€»è¾‘å¹¶ä¸ä¼šä¿®å¤ LinkedHashMap æ‰€ç»´æŠ¤çš„åŒå‘é“¾è¡¨ã€‚ç»´æŠ¤æ“ä½œéƒ½åœ¨åˆ é™¤åŠèŠ‚ç‚¹åçš„å›è°ƒæ–¹æ³• afterNodeRemoval ä¸­ã€‚LinkedHashMap è¦†å†™è¯¥æ–¹æ³•ï¼Œå¹¶åœ¨è¯¥æ–¹æ³•ä¸­å®Œæˆäº†ç§»é™¤è¢«åˆ é™¤èŠ‚ç‚¹çš„æ“ä½œã€‚åˆ†ææ–¹æ³•åŒä¸Šã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. è°ƒç”¨HashMapçš„removeæ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(Object key, Object value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> removeNode(hash(key), key, value, <span class="keyword">true</span>, <span class="keyword">true</span>) != <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. è°ƒç”¨HashMapçš„removeNodeæ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> Node&lt;K,V&gt; <span class="title">removeNode</span><span class="params">(<span class="keyword">int</span> hash, Object key, Object value,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">boolean</span> matchValue, <span class="keyword">boolean</span> movable)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// å¯¹åº”å„ç§ç±»å‹çš„èŠ‚ç‚¹åˆ é™¤ã€‚è¿™äº›éƒ½ä¸ä¼šæ”¹å˜é“¾è¡¨çš„ç»“æ„</span></span><br><span class="line">    <span class="keyword">if</span> (node != <span class="keyword">null</span> &amp;&amp; (!matchValue || (v = node.value) == value ||</span><br><span class="line">                     (value != <span class="keyword">null</span> &amp;&amp; value.equals(v)))) &#123;</span><br><span class="line">    <span class="keyword">if</span> (node <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">        ((TreeNode&lt;K,V&gt;)node).removeTreeNode(<span class="keyword">this</span>, tab, movable);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (node == p)</span><br><span class="line">        tab[index] = node.next;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        p.next = node.next;</span><br><span class="line">    ++modCount;</span><br><span class="line">    --size;</span><br><span class="line">    <span class="comment">// å…³é”®çš„æ¥äº†ï¼Œè¿™ä¸ªæ“ä½œåœ¨HashMapæ˜¯æ²¡æœ‰å®ç°çš„ï¼Œä½†æ˜¯åœ¨LinkedHashMapä¸­å®ç°äº†</span></span><br><span class="line">    afterNodeRemoval(node);</span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. è°ƒç”¨LinkedHashMapæ–¹æ³•çš„afterNodeRemovalæ“ä½œæ¥è°ƒæ•´é“¾è¡¨ç»“æ„</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">afterNodeRemoval</span><span class="params">(Node&lt;K,V&gt; e)</span> </span>&#123; <span class="comment">// unlink</span></span><br><span class="line">    <span class="comment">// æ‹¿åˆ°åˆ é™¤èŠ‚ç‚¹ä»¥åŠå®ƒçš„å‰é©±èŠ‚ç‚¹å’Œåç»§èŠ‚ç‚¹</span></span><br><span class="line">    LinkedHashMap.Entry&lt;K,V&gt; p =</span><br><span class="line">        (LinkedHashMap.Entry&lt;K,V&gt;)e, b = p.before, a = p.after;</span><br><span class="line">    <span class="comment">// å°†è¿™ä¸¤ä¸ªæŒ‡é’ˆç½®ç©º</span></span><br><span class="line">    p.before = p.after = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// å¦‚æœå‰é©±èŠ‚ç‚¹ä¸ºç©ºï¼Œåˆ™ä¸ºå¤´èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (b == <span class="keyword">null</span>)</span><br><span class="line">        head = a;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment">// è¿æ¥å‰åä¸¤ä¸ªç•Œå®šå•Š</span></span><br><span class="line">        b.after = a;</span><br><span class="line">    <span class="comment">// å¦‚æœå‰é©±èŠ‚ç‚¹ä¸ºç©ºï¼Œåˆ™ä¸ºå°¾èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (a == <span class="keyword">null</span>)</span><br><span class="line">        tail = b;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        a.before = b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="æ”¹"><a href="#æ”¹" class="headerlink" title="æ”¹"></a>æ”¹</h1><p>ä¸æ’å…¥æ“ä½œä¸€æ ·ï¼ŒLinkedHashMap æ”¹æ“ä½œç›¸å…³çš„ä»£ç ä¹Ÿæ˜¯ç›´æ¥ç”¨çˆ¶ç±»çš„å®ç°ã€‚åˆ†ææ–¹æ³•åŒä¸Šã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. è°ƒç”¨HashMapçš„replaceæ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">replace</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt; e;</span><br><span class="line">    <span class="comment">// å‰é¢çš„æ“ä½œéƒ½å’ŒHashMapä¸€è‡´</span></span><br><span class="line">    <span class="keyword">if</span> ((e = getNode(hash(key), key)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        V oldValue = e.value;</span><br><span class="line">        e.value = value;</span><br><span class="line">        <span class="comment">// é‡ç‚¹åœ¨ä¿®æ”¹ä¹‹åä¼šæ‰§è¡Œè¿™æ ·ä¸€ä¸ªå›è°ƒæ“ä½œ</span></span><br><span class="line">        afterNodeAccess(e);</span><br><span class="line">        <span class="keyword">return</span> oldValue;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. è°ƒç”¨LinkedHashMapçš„afterNodeAccessè®¿é—®å›è°ƒæ–¹æ³•æ¥è°ƒæ•´é“¾è¡¨ä½ç½®</span></span><br><span class="line"><span class="comment">// å°†æœ€è¿‘è®¿é—®çš„èŠ‚ç‚¹ï¼Œæ”¾åœ¨é“¾è¡¨æœ€å</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">afterNodeAccess</span><span class="params">(Node&lt;K,V&gt; e)</span> </span>&#123; <span class="comment">// move node to last</span></span><br><span class="line">    LinkedHashMap.Entry&lt;K,V&gt; last;</span><br><span class="line">    <span class="comment">// å½“accessOrderä¸ºture ä¸” è®¿é—®çš„ä¸æ˜¯å°¾éƒ¨èŠ‚ç‚¹æ—¶æ‰è¿›è¡Œä¸‹é¢çš„ä¸€é¡¿æ“ä½œ</span></span><br><span class="line">    <span class="keyword">if</span> (accessOrder &amp;&amp; (last = tail) != e) &#123;</span><br><span class="line">        <span class="comment">// æ‹¿åˆ°è®¿é—®èŠ‚ç‚¹ä»¥åŠå®ƒçš„å‰é©±èŠ‚ç‚¹å’Œåç»§èŠ‚ç‚¹</span></span><br><span class="line">        LinkedHashMap.Entry&lt;K,V&gt; p =</span><br><span class="line">            (LinkedHashMap.Entry&lt;K,V&gt;)e, b = p.before, a = p.after;</span><br><span class="line">        <span class="comment">// åç»§èŠ‚ç‚¹ç½®ç©º</span></span><br><span class="line">        p.after = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// å‰é©±èŠ‚ç‚¹ä¸ºå¤´èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (b == <span class="keyword">null</span>)</span><br><span class="line">            head = a;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            b.after = a;</span><br><span class="line">        <span class="comment">// è¿™é‡Œçš„if/elseæ„Ÿè§‰ä¹Ÿéƒ½æ²¡ç”¨ï¼Œå› ä¸ºéƒ½ç¡®å®šä¸æ˜¯å°¾èŠ‚ç‚¹äº†</span></span><br><span class="line">        <span class="keyword">if</span> (a != <span class="keyword">null</span>)</span><br><span class="line">            a.before = b;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            last = b;</span><br><span class="line">        <span class="comment">// è¡¨ç¤ºä¸ä¼šä¼šç©ºï¼Œå› ä¸ºéƒ½è®¿é—®åˆ°å…ƒç´ äº†</span></span><br><span class="line">        <span class="keyword">if</span> (last == <span class="keyword">null</span>)</span><br><span class="line">            head = p;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            p.before = last;</span><br><span class="line">            last.after = p;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å°†è®¿é—®èŠ‚ç‚¹æ”¾åˆ°å°¾éƒ¨</span></span><br><span class="line">        tail = p;</span><br><span class="line">        ++modCount;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="æŸ¥"><a href="#æŸ¥" class="headerlink" title="æŸ¥"></a>æŸ¥</h1><p>æŸ¥æ“ä½œè¦†ç›–äº†HashMapçš„æ–¹æ³•ï¼Œä½†æ˜¯ä¹Ÿåªæ˜¯æ·»åŠ afterNodeAccessæ“ä½œåˆ¤æ–­ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt; e;</span><br><span class="line">    <span class="keyword">if</span> ((e = getNode(hash(key), key)) == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// å”¯ä¸€ä¸åŒçš„åœ°æ–¹ï¼Œå½“accessOrderä¸ºtrueæ—¶ï¼Œåˆ™è°ƒæ•´é“¾è¡¨ï¼Œå’Œåœ¨æ”¹æ“ä½œçš„åˆ†æä¸€æ ·</span></span><br><span class="line">    <span class="keyword">if</span> (accessOrder)</span><br><span class="line">        afterNodeAccess(e);</span><br><span class="line">    <span class="keyword">return</span> e.value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="å®ç°-LRU-ç¼“å­˜"><a href="#å®ç°-LRU-ç¼“å­˜" class="headerlink" title="å®ç° LRU ç¼“å­˜"></a>å®ç° LRU ç¼“å­˜</h1><p><strong>LRU ç¼“å­˜</strong>ï¼šLRUï¼ˆLeast Recently Usedï¼Œæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰ç®—æ³•æ ¹æ®æ•°æ®çš„å†å²è®¿é—®è®°å½•æ¥è¿›è¡Œæ·˜æ±°æ•°æ®ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯â€œå¦‚æœæ•°æ®æœ€è¿‘è¢«è®¿é—®è¿‡ï¼Œé‚£ä¹ˆå°†æ¥è¢«è®¿é—®çš„å‡ ç‡ä¹Ÿæ›´é«˜â€ã€‚</p>
<p>å¤§å®¶çœ‹åˆ°ä¸Šé¢çš„å®šä¹‰å°±èƒ½æƒ³åˆ°å°±æ˜¯åœ¨ä¸€å®šæ¡ä»¶ä¸‹åˆ é™¤HeadèŠ‚ç‚¹å˜›ï¼Œå› ä¸ºæœ€è¿‘è®¿é—®è¿‡çš„éƒ½ä¼šè¢«æ”¾åœ¨é“¾è¡¨å°¾éƒ¨ï¼Œæœ€è¿‘æœ€å°‘ä½¿ç”¨çš„ä¸€å®šæ˜¯æŠ•èŠ‚ç‚¹ã€‚é‚£ä¹ˆLinkedHashMapåœ¨å“ªé‡Œä¸ºæˆ‘ä»¬ç•™ä¸‹äº†å®ç°çš„æ¥å£ï¼Œæˆ‘ä»¬çœ‹çœ‹ä¸‹é¢çš„æºç ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯ç”¨äºå®ç°LRUç¼“å­˜ï¼Œevictå°±è¡¨ç¤ºåˆ é™¤çš„æ„æ€</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">afterNodeInsertion</span><span class="params">(<span class="keyword">boolean</span> evict)</span> </span>&#123; <span class="comment">// possibly remove eldest</span></span><br><span class="line">    LinkedHashMap.Entry&lt;K,V&gt; first;</span><br><span class="line">    <span class="comment">// æ ¹æ®æ¡ä»¶åˆ¤æ–­æ˜¯å¦ç§»é™¤æœ€è¿‘æœ€å°‘è¢«è®¿é—®çš„èŠ‚ç‚¹ï¼Œä¸»è¦å°±æ˜¯removeEldestEntryæ–¹æ³•</span></span><br><span class="line">    <span class="keyword">if</span> (evict &amp;&amp; (first = head) != <span class="keyword">null</span> &amp;&amp; removeEldestEntry(first)) &#123;</span><br><span class="line">        K key = first.key;</span><br><span class="line">        <span class="comment">// åˆ é™¤èŠ‚ç‚¹</span></span><br><span class="line">        removeNode(hash(key), key, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é»˜è®¤è¿”ä¼šfalseï¼Œå°±æ˜¯ä¸åˆ é™¤</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">removeEldestEntry</span><span class="params">(Map.Entry&lt;K,V&gt; eldest)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å½“ç„¶åœ¨æºç æ³¨é‡Šä¸­ä¹Ÿä¸ºæˆ‘ä»¬é‡å†™æä¾›äº†ä¾‹å­</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_ENTRIES = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">removeEldestEntry</span><span class="params">(Map.Entry eldest)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// å½“å¤§äºæŸä¸ªé˜ˆå€¼ï¼Œå°±ç§»é™¤æœ€è€çš„</span></span><br><span class="line">  <span class="keyword">return</span> size() &gt; MAX_ENTRIES;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol>
<li><a href="https://segmentfault.com/a/1190000012964859" target="_blank" rel="noopener">LinkedHashMap æºç è¯¦ç»†åˆ†æï¼ˆJDK1.8ï¼‰</a></li>
<li><a href="http://todorex.com/2018/09/03/JDK%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/JDK%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E2%80%94%E2%80%94HashMap/" target="_blank" rel="noopener">JDKæºç åˆ†æâ€”â€”HashMap</a></li>
<li><a href="https://www.jianshu.com/p/06a0fd962e0b" target="_blank" rel="noopener">Java ä¸­æœ€å¤§çš„æ•°æ®ç»“æ„ï¼šLinkedHashMap äº†è§£ä¸€ä¸‹ï¼Ÿ</a></li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¼•ï¼šå¦‚æœæœ‰è¿™æ ·ä¸€ç§æƒ…å½¢ï¼Œæˆ‘ä»¬éœ€è¦æŒ‰ç…§å…ƒç´ æ’å…¥çš„é¡ºåºæ¥è®¿é—®å…ƒç´ ï¼Œè¿™ä¸ªæ—¶å€™LinkedHashMapå¤§å±•èº«æ‰‹äº†ï¼Œå®ƒä¿å­˜ç€å…ƒç´ æ’å…¥çš„é¡ºåºï¼Œå¹¶ä¸”å¯ä»¥æŒ‰ç…§æˆ‘ä»¬æ’å…¥çš„é¡ºåºè¿›è¡Œè®¿é—®ã€‚
    
    </summary>
    
      <category term="JDKæºç åˆ†æ" scheme="http://bestlixiang.site/categories/JDK%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
    
      <category term="LinkedHashMap" scheme="http://bestlixiang.site/tags/LinkedHashMap/"/>
    
  </entry>
  
  <entry>
    <title>JDKæºç åˆ†æâ€”â€”TreeMap</title>
    <link href="http://bestlixiang.site/2018/09/06/JDK%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/JDK%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E2%80%94%E2%80%94TreeMap/"/>
    <id>http://bestlixiang.site/2018/09/06/JDKæºç åˆ†æ/JDKæºç åˆ†æâ€”â€”TreeMap/</id>
    <published>2018-09-06T00:32:02.000Z</published>
    <updated>2018-09-07T02:19:19.435Z</updated>
    
    <content type="html"><![CDATA[<p>å¼•ï¼šä½ æƒ³åˆ©ç”¨çš„Mapé«˜æ•ˆçš„æŸ¥æ‰¾æ•ˆç‡ï¼Œåˆæƒ³æ‹¥æœ‰ä¸€ä¸ªæœ‰åºçš„Mapï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦ç”¨åˆ°TreeMapäº†!<a id="more"></a></p>
<p>è¯¦ç»†æ³¨é‡Šï¼š<a href="https://github.com/todorex/JDK" target="_blank" rel="noopener">æºç åˆ†æåœ°å€</a></p>
<h1 id="æ¦‚è§ˆ"><a href="#æ¦‚è§ˆ" class="headerlink" title="æ¦‚è§ˆ"></a>æ¦‚è§ˆ</h1><p>TreeMapé›†åˆæ˜¯åŸºäºçº¢é»‘æ ‘ï¼ˆRed-Black treeï¼‰çš„ NavigableMapå®ç°ã€‚è¯¥Mapæ ¹æ®å…¶é”®çš„è‡ªç„¶é¡ºåºè¿›è¡Œæ’åºï¼Œæˆ–è€…æ ¹æ®åˆ›å»ºMapæ—¶æä¾›çš„ Comparator è¿›è¡Œæ’åºï¼Œå…·ä½“å–å†³äºä½¿ç”¨çš„æ„é€ æ–¹æ³•ã€‚ä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦é€‰æ‹©æ’åºçš„æ–¹å¼ã€‚</p>
<p>å…³äºä¸åŒæ­¥éƒ½å’Œä¹‹å‰è§£æçš„éåŒæ­¥å®¹å™¨ç±»ä¼¼ã€‚</p>
<h1 id="æ„é€ "><a href="#æ„é€ " class="headerlink" title="æ„é€ "></a>æ„é€ </h1><p>åœ¨æ¦‚è§ˆä¸­è¯´åˆ°æˆ‘ä»¬å¯ä»¥åœ¨å®ƒæ„é€ æ—¶ä¼ é€’Comparatoræ¥å†³å®šæ’åºçš„æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±çœ‹çœ‹è¿™ä¸ªæ„é€ æ–¹æ³•ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ¯”è¾ƒå™¨</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Comparator&lt;? <span class="keyword">super</span> K&gt; comparator;</span><br><span class="line"><span class="comment">// æ ¹èŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> Entry&lt;K,V&gt; root;</span><br><span class="line"><span class="comment">// é›†åˆå¤§å°</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">int</span> size = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">TreeMap</span><span class="params">(Comparator&lt;? <span class="keyword">super</span> K&gt; comparator)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.comparator = comparator;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="å¢"><a href="#å¢" class="headerlink" title="å¢"></a>å¢</h1><p>æˆ‘ä»¬çœ‹å‡ºåœ¨æ„é€ æ–¹æ³•ä¸­åªæ˜¯è®¾ç½®äº†å±æ€§ï¼Œå¹¶æ²¡æœ‰çœŸæ­£æ„å»ºçº¢é»‘æ ‘ï¼Œé‚£ä¹ˆå®ƒä¸€å®šåœ¨ç¬¬ä¸€æ¬¡putæ“ä½œé‡Œã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è·å–æ ¹èŠ‚ç‚¹</span></span><br><span class="line">    Entry&lt;K,V&gt; t = root;</span><br><span class="line">    <span class="comment">// å¦‚æœæ ¹èŠ‚ç‚¹ä¸ºç©ºï¼Œåˆ™è¯¥å…ƒç´ ç½®ä¸ºæ ¹èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (t == <span class="keyword">null</span>) &#123;</span><br><span class="line">        compare(key, key); <span class="comment">// type (and possibly null) check</span></span><br><span class="line">        <span class="comment">// æ–°å»ºèŠ‚ç‚¹</span></span><br><span class="line">        root = <span class="keyword">new</span> Entry&lt;&gt;(key, value, <span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">// æ”¹å˜é›†åˆå¤§å°å’Œä¿®æ”¹æ¬¡æ•°</span></span><br><span class="line">        size = <span class="number">1</span>;</span><br><span class="line">        modCount++;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> cmp;</span><br><span class="line">    Entry&lt;K,V&gt; parent;</span><br><span class="line">    <span class="comment">// split comparator and comparable paths</span></span><br><span class="line">    <span class="comment">// è·å¾—keyæ¯”è¾ƒå™¨</span></span><br><span class="line">    Comparator&lt;? <span class="keyword">super</span> K&gt; cpr = comparator;</span><br><span class="line">    <span class="comment">// å¦‚æœæ¯”è¾ƒå™¨å¯¹è±¡ä¸ä¸ºç©ºï¼Œä¹Ÿå°±æ˜¯è‡ªå®šä¹‰äº†æ¯”è¾ƒå™¨</span></span><br><span class="line">    <span class="keyword">if</span> (cpr != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="comment">// å¾ªç¯æ¯”è¾ƒå¹¶ç¡®å®šå…ƒç´ åº”æ’å…¥çš„ä½ç½®(ä¹Ÿå°±æ˜¯æ‰¾åˆ°è¯¥å…ƒç´ çš„çˆ¶èŠ‚ç‚¹)</span></span><br><span class="line">            parent = t;</span><br><span class="line">            cmp = cpr.compare(key, t.key);</span><br><span class="line">            <span class="comment">// å¾…æ’å…¥å…ƒç´ çš„keyå°äºå½“å‰ä½ç½®å…ƒç´ çš„keyï¼Œåˆ™æŸ¥è¯¢å·¦å­æ ‘</span></span><br><span class="line">            <span class="keyword">if</span> (cmp &lt; <span class="number">0</span>)</span><br><span class="line">                t = t.left;</span><br><span class="line">            <span class="comment">// å¾…æ’å…¥å…ƒç´ çš„keyå¤§äºå½“å‰ä½ç½®å…ƒç´ çš„keyï¼Œåˆ™æŸ¥è¯¢å³å­æ ‘</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (cmp &gt; <span class="number">0</span>)</span><br><span class="line">                t = t.right;</span><br><span class="line">            <span class="comment">// ç›¸ç­‰åˆ™æ›¿æ¢å…¶value</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> t.setValue(value);</span><br><span class="line">        &#125; <span class="keyword">while</span> (t != <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœæ¯”è¾ƒå™¨å¯¹è±¡ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤çš„æ¯”è¾ƒæœºåˆ¶</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// é»˜è®¤æœºåˆ¶ä¸‹ä¸å…è®¸è®¾ç½® null key</span></span><br><span class="line">        <span class="keyword">if</span> (key == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">        <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">            Comparable&lt;? <span class="keyword">super</span> K&gt; k = (Comparable&lt;? <span class="keyword">super</span> K&gt;) key;</span><br><span class="line">        <span class="comment">// å’Œä¸Šé¢çš„å¾ªç¯åšåŒæ ·çš„äº‹</span></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            parent = t;</span><br><span class="line">            cmp = k.compareTo(t.key);</span><br><span class="line">            <span class="keyword">if</span> (cmp &lt; <span class="number">0</span>)</span><br><span class="line">                t = t.left;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (cmp &gt; <span class="number">0</span>)</span><br><span class="line">                t = t.right;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> t.setValue(value);</span><br><span class="line">        &#125; <span class="keyword">while</span> (t != <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ ¹æ®keyæ‰¾åˆ°çˆ¶èŠ‚ç‚¹åæ–°å»ºä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    Entry&lt;K,V&gt; e = <span class="keyword">new</span> Entry&lt;&gt;(key, value, parent);</span><br><span class="line">    <span class="keyword">if</span> (cmp &lt; <span class="number">0</span>)</span><br><span class="line">        parent.left = e;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        parent.right = e;</span><br><span class="line">    <span class="comment">// è°ƒæ•´çº¢é»‘æ ‘</span></span><br><span class="line">    fixAfterInsertion(e);</span><br><span class="line">    size++;</span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å¤§æ¦‚çš„æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>åˆ¤æ–­æ ¹èŠ‚ç‚¹æ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºï¼Œåˆ™è¯¥èŠ‚ç‚¹å°±æ˜¯æ ¹èŠ‚ç‚¹</li>
<li>æ ¹æ®æ¯”è¾ƒå™¨(å¯èƒ½æ˜¯å¤–éƒ¨ä¼ è¿›æ¥çš„ï¼Œä¹Ÿå¯èƒ½æ˜¯é»˜è®¤çš„)ï¼Œæ‰¾åˆ°çˆ¶èŠ‚ç‚¹ã€‚</li>
<li>æ’å…¥èŠ‚ç‚¹ä¹‹åï¼Œå°±éœ€è¦ç”¨çº¢é»‘æ ‘çš„ä¿®æ­£äº†ã€‚</li>
</ol>
<h1 id="åˆ "><a href="#åˆ " class="headerlink" title="åˆ "></a>åˆ </h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">remove</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// åˆ©ç”¨æ¯”è¾ƒå™¨äºŒåˆ†æŸ¥æ‰¾</span></span><br><span class="line">    Entry&lt;K,V&gt; p = getEntry(key);</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    V oldValue = p.value;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// çº¢é»‘æ ‘åˆ é™¤</span></span><br><span class="line">    deleteEntry(p);</span><br><span class="line">    <span class="keyword">return</span> oldValue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> Entry&lt;K,V&gt; <span class="title">getEntry</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Offload comparator-based version for sake of performance</span></span><br><span class="line">    <span class="keyword">if</span> (comparator != <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> getEntryUsingComparator(key);</span><br><span class="line">    <span class="keyword">if</span> (key == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">        Comparable&lt;? <span class="keyword">super</span> K&gt; k = (Comparable&lt;? <span class="keyword">super</span> K&gt;) key;</span><br><span class="line">    Entry&lt;K,V&gt; p = root;</span><br><span class="line">    <span class="comment">// æ™®é€šçš„äºŒåˆ†æŸ¥æ‰¾</span></span><br><span class="line">    <span class="keyword">while</span> (p != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> cmp = k.compareTo(p.key);</span><br><span class="line">        <span class="keyword">if</span> (cmp &lt; <span class="number">0</span>)</span><br><span class="line">            p = p.left;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (cmp &gt; <span class="number">0</span>)</span><br><span class="line">            p = p.right;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> Entry&lt;K,V&gt; <span class="title">getEntryUsingComparator</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">        K k = (K) key;</span><br><span class="line">    Comparator&lt;? <span class="keyword">super</span> K&gt; cpr = comparator;</span><br><span class="line">    <span class="comment">// æ™®é€šçš„äºŒåˆ†æŸ¥æ‰¾</span></span><br><span class="line">    <span class="keyword">if</span> (cpr != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Entry&lt;K,V&gt; p = root;</span><br><span class="line">        <span class="keyword">while</span> (p != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> cmp = cpr.compare(k, p.key);</span><br><span class="line">            <span class="keyword">if</span> (cmp &lt; <span class="number">0</span>)</span><br><span class="line">                p = p.left;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (cmp &gt; <span class="number">0</span>)</span><br><span class="line">                p = p.right;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> p;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="æ”¹"><a href="#æ”¹" class="headerlink" title="æ”¹"></a>æ”¹</h1><p>æ‰¾åˆ°è¯¥keyå¯¹åº”çš„èŠ‚ç‚¹ï¼Œç„¶åæ›¿æ¢è¯¥å€¼<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">replace</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ‰¾åˆ°èŠ‚ç‚¹</span></span><br><span class="line">    Entry&lt;K,V&gt; p = getEntry(key);</span><br><span class="line">    <span class="comment">// æ›¿æ¢å€¼</span></span><br><span class="line">    <span class="keyword">if</span> (p!=<span class="keyword">null</span>) &#123;</span><br><span class="line">        V oldValue = p.value;</span><br><span class="line">        p.value = value;</span><br><span class="line">        <span class="keyword">return</span> oldValue;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="æŸ¥"><a href="#æŸ¥" class="headerlink" title="æŸ¥"></a>æŸ¥</h1><p>ä¸€æ‰¹ä»¥getFirstEntry()ï¼ŒgetLastEntry()ä¸ºåŸºç¡€çš„è·å–å¤´å’Œå°¾å…ƒç´ çš„æ–¹æ³•ï¼Œå…¶ä¸­åŒ…æ‹¬ï¼šfirstKey()ï¼ŒlastKey()ï¼›firstEntry()ï¼ŒlastEntry()ï¼›pollFirstEntry()ï¼ŒpollLastEntry()<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  è¿”å›ç¬¬ä¸€ä¸ªèŠ‚ç‚¹(å€¼æœ€å°çš„èŠ‚ç‚¹)</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> Entry&lt;K,V&gt; <span class="title">getFirstEntry</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Entry&lt;K,V&gt; p = root;</span><br><span class="line">    <span class="keyword">if</span> (p != <span class="keyword">null</span>)</span><br><span class="line">        <span class="comment">// ä¸€ç›´éå†å·¦å­æ ‘</span></span><br><span class="line">        <span class="keyword">while</span> (p.left != <span class="keyword">null</span>)</span><br><span class="line">            p = p.left;</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿”å›æœ€åä¸€ä¸ªèŠ‚ç‚¹(å€¼æœ€å¤§çš„èŠ‚ç‚¹)</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> Entry&lt;K,V&gt; <span class="title">getLastEntry</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Entry&lt;K,V&gt; p = root;</span><br><span class="line">    <span class="keyword">if</span> (p != <span class="keyword">null</span>)</span><br><span class="line">        <span class="comment">// ä¸€ç›´éå†å³å­æ ‘</span></span><br><span class="line">        <span class="keyword">while</span> (p.right != <span class="keyword">null</span>)</span><br><span class="line">            p = p.right;</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¼•ï¼šä½ æƒ³åˆ©ç”¨çš„Mapé«˜æ•ˆçš„æŸ¥æ‰¾æ•ˆç‡ï¼Œåˆæƒ³æ‹¥æœ‰ä¸€ä¸ªæœ‰åºçš„Mapï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦ç”¨åˆ°TreeMapäº†!
    
    </summary>
    
      <category term="JDKæºç åˆ†æ" scheme="http://bestlixiang.site/categories/JDK%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
    
      <category term="HashMap" scheme="http://bestlixiang.site/tags/HashMap/"/>
    
  </entry>
  
  <entry>
    <title>JDKæºç åˆ†æâ€”â€”HashSet</title>
    <link href="http://bestlixiang.site/2018/09/06/JDK%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/JDK%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E2%80%94%E2%80%94HashSet/"/>
    <id>http://bestlixiang.site/2018/09/06/JDKæºç åˆ†æ/JDKæºç åˆ†æâ€”â€”HashSet/</id>
    <published>2018-09-06T00:04:49.000Z</published>
    <updated>2018-09-06T00:24:30.281Z</updated>
    
    <content type="html"><![CDATA[<p>å¼•ï¼šå¦‚æœç”¨æ¥æœ‰ä¸ªå»é‡çš„éœ€æ±‚ï¼Œä½ è‚¯å®šä¼šæƒ³åˆ°ç”¨HashSetï¼Œé‚£æˆ‘ä»¬çœ‹çœ‹å®ƒçš„å®ç°ï¼<a id="more"></a></p>
<p>è¯¦ç»†æ³¨é‡Šï¼š<a href="https://github.com/todorex/JDK" target="_blank" rel="noopener">æºç åˆ†æåœ°å€</a></p>
<h1 id="æ¦‚è§ˆ"><a href="#æ¦‚è§ˆ" class="headerlink" title="æ¦‚è§ˆ"></a>æ¦‚è§ˆ</h1><p>å®ƒæ˜¯ç”±å“ˆå¸Œè¡¨ï¼ˆå®é™…ä¸Šæ˜¯ä¸€ä¸ª<strong>HashMap</strong>å®ä¾‹ï¼‰æ”¯æŒï¼Œæ˜¯ä¸æ˜¯æœ‰ç‚¹æ„æ€ï¼Ÿå®ƒä¸ä¿è¯setçš„è¿­ä»£é¡ºåºï¼Œæœ‰ä¸”åªå…è®¸ä¸€ä¸ªnullå…ƒç´ ï¼Œå½“ç„¶å…¶ä»–å…ƒç´ ä¸èƒ½é‡å¤ã€‚</p>
<p>å®ƒä¸æ˜¯åŒæ­¥å®¹å™¨ã€‚å¦‚æœå¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ä¸€ä¸ªå“ˆå¸Œsetï¼Œè€Œå…¶ä¸­è‡³å°‘ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†è¯¥ setï¼Œé‚£ä¹ˆå®ƒå¿…é¡»ä¿æŒå¤–éƒ¨åŒæ­¥ã€‚è¿™é€šå¸¸æ˜¯é€šè¿‡å¯¹è‡ªç„¶å°è£…è¯¥setçš„å¯¹è±¡æ‰§è¡ŒåŒæ­¥æ“ä½œæ¥å®Œæˆçš„ã€‚å¦‚æœä¸å­˜åœ¨è¿™æ ·çš„å¯¹è±¡ï¼Œåˆ™åº”è¯¥ä½¿ç”¨ Collections.synchronizedSet æ–¹æ³•æ¥â€œåŒ…è£…â€ setã€‚æœ€å¥½åœ¨åˆ›å»ºæ—¶å®Œæˆè¿™ä¸€æ“ä½œï¼Œä»¥é˜²æ­¢å¯¹è¯¥setè¿›è¡Œæ„å¤–çš„ä¸åŒæ­¥è®¿é—®ã€‚</p>
<p>æ‰€æœ‰è¿™ä¸ªç±»çš„æ–¹æ³•è¿”å›çš„è¿­ä»£å™¨éƒ½æ˜¯å¿«é€Ÿå¤±è´¥çš„ ï¼šå¦‚æœæ˜ å°„åœ¨è¿­ä»£å™¨åˆ›å»ºä¹‹åçš„ä»»ä½•æ—¶é—´è¢«ç»“æ„åœ°ä¿®æ”¹ï¼Œé™¤äº†é€šè¿‡è¿­ä»£å™¨è‡ªå·±çš„removeæ–¹æ³•ä¹‹å¤–ï¼Œè¿­ä»£å™¨å°†æŠ›å‡ºä¸€ä¸ªConcurrentModificationExceptionã€‚ï¼ˆè€ç”Ÿé•¿è°ˆï¼‰</p>
<h1 id="æ„é€ "><a href="#æ„é€ " class="headerlink" title="æ„é€ "></a>æ„é€ </h1><p>å…³äºHashSetçš„æ“ä½œ(ä¸‹é¢éƒ½æ˜¯)ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯ç›´æ¥è°ƒç”¨åº•å±‚HashMapçš„ç›¸å…³æ–¹æ³•æ¥å®Œæˆã€‚æ‰€ä»¥åœ¨åé¢å‚è€ƒæ‰¾åˆ°è‡ªå·±å…³äºHashMapçš„æ–‡ç« ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// çœŸçš„æ“ä½œçš„æ‰§è¡Œè€…</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> HashMap&lt;E,Object&gt; map;</span><br><span class="line"><span class="comment">// å®šä¹‰ä¸€ä¸ª"è™šæ‹Ÿ"çš„Objectå¯¹è±¡ä½œä¸ºHashMapçš„value</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object PRESENT = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ„é€ HashMap</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashSet</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</span><br><span class="line">    map = <span class="keyword">new</span> HashMap&lt;&gt;(initialCapacity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="å¢"><a href="#å¢" class="headerlink" title="å¢"></a>å¢</h1><p>åœ¨HashMapæ–°å¢ä¸€ä¸ªé”®å€¼å¯¹<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> map.put(e, PRESENT)==<span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="åˆ "><a href="#åˆ " class="headerlink" title="åˆ "></a>åˆ </h1><p>åœ¨HashMapåˆ é™¤ä¸€ä¸ªé”®å€¼å¯¹<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> map.remove(o)==PRESENT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="æŸ¥"><a href="#æŸ¥" class="headerlink" title="æŸ¥"></a>æŸ¥</h1><p>åœ¨HashMapæŸ¥æ‰¾keyæ˜¯å¦å­˜åœ¨<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">contains</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> map.containsKey(o);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æ°´æ–‡ä¸€ç¯‡ï¼Œåªè¦è®°ä½ä¸€ç‚¹ï¼Œå°±æ˜¯åªè¦ç†è§£äº†HashMapï¼ŒHashSet is so easyï¼ï¼</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol>
<li><a href="http://todorex.com/2018/09/03/JDK%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/JDK%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E2%80%94%E2%80%94HashMap/" target="_blank" rel="noopener">JDKæºç åˆ†æâ€”â€”HashMap</a></li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¼•ï¼šå¦‚æœç”¨æ¥æœ‰ä¸ªå»é‡çš„éœ€æ±‚ï¼Œä½ è‚¯å®šä¼šæƒ³åˆ°ç”¨HashSetï¼Œé‚£æˆ‘ä»¬çœ‹çœ‹å®ƒçš„å®ç°ï¼
    
    </summary>
    
      <category term="JDKæºç åˆ†æ" scheme="http://bestlixiang.site/categories/JDK%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
    
      <category term="HashSet" scheme="http://bestlixiang.site/tags/HashSet/"/>
    
  </entry>
  
  <entry>
    <title>JDKæºç åˆ†æâ€”â€”ConcurrentHashMap</title>
    <link href="http://bestlixiang.site/2018/09/04/JDK%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/JDK%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E2%80%94%E2%80%94ConcurrentHashMap/"/>
    <id>http://bestlixiang.site/2018/09/04/JDKæºç åˆ†æ/JDKæºç åˆ†æâ€”â€”ConcurrentHashMap/</id>
    <published>2018-09-04T05:08:53.000Z</published>
    <updated>2018-09-04T13:02:09.721Z</updated>
    
    <content type="html"><![CDATA[<p>å¼•ï¼šHashMapæ˜¯æˆ‘ä»¬å¹³æ—¶å¼€å‘è¿‡ç¨‹ä¸­ç”¨çš„æ¯”è¾ƒå¤šçš„é›†åˆï¼Œä½†å®ƒæ˜¯éçº¿ç¨‹å®‰å…¨çš„ã€‚è§£å†³æ–¹æ¡ˆæœ‰Hashtableå’ŒCollections.synchronizedMap(hashMap)ï¼Œä¸è¿‡è¿™ä¸¤ä¸ªæ–¹æ¡ˆåŸºæœ¬ä¸Šæ˜¯å¯¹è¯»å†™è¿›è¡ŒåŠ é”æ“ä½œï¼Œæ€§èƒ½å¯æƒ³è€ŒçŸ¥ã€‚æ‰€ä»¥æ„Ÿè°¢<strong>Doug Lea</strong>ç»™æˆ‘ä»¬å¸¦æ¥äº†å¹¶å‘å®‰å…¨çš„ConcurrentHashMapã€‚<a id="more"></a></p>
<p>è¯¦ç»†æ³¨é‡Šï¼š<a href="https://github.com/todorex/JDK" target="_blank" rel="noopener">æºç åˆ†æåœ°å€</a></p>
<h1 id="æ¦‚è§ˆ"><a href="#æ¦‚è§ˆ" class="headerlink" title="æ¦‚è§ˆ"></a>æ¦‚è§ˆ</h1><p>ConcurrentHashMap æ˜¯ä¸€ä¸ªå¹¶å‘æ•£åˆ—æ˜ å°„è¡¨çš„å®ç°ï¼Œå®ƒå…è®¸å®Œå…¨å¹¶å‘çš„è¯»å–ï¼Œå¹¶ä¸”æ”¯æŒç»™å®šæ•°é‡çš„å¹¶å‘æ›´æ–°ã€‚å®ƒé‡‡ç”¨CASæ“ä½œå’Œå†…ç½®é”synchronizedæ¥å®ç°åŒæ­¥</p>
<h1 id="æ„é€ "><a href="#æ„é€ " class="headerlink" title="æ„é€ "></a>æ„é€ </h1><p>ä¸»è¦å°±æ˜¯è®¾ç½®åˆå§‹å®¹é‡å’Œè´Ÿè½½å› å­ã€‚ï¼ˆå¾ˆå¤šåœ¨HashMapä¸­ä»‹ç»è¿‡çš„å˜é‡å’Œå¸¸é‡ï¼Œè¿™é‡Œå°±ä¸å†æ¬¡ä»‹ç»äº†ï¼‰<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é»˜è®¤ä¸ºnullï¼Œåˆå§‹åŒ–å‘ç”Ÿåœ¨ç¬¬ä¸€æ¬¡æ’å…¥æ“ä½œï¼Œé»˜è®¤å¤§å°ä¸º16çš„æ•°ç»„ï¼Œç”¨æ¥å­˜å‚¨NodeèŠ‚ç‚¹æ•°æ®ï¼Œæ‰©å®¹æ—¶å¤§å°æ€»æ˜¯2çš„å¹‚æ¬¡æ–¹</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">volatile</span> Node&lt;K,V&gt;[] table;</span><br><span class="line"><span class="comment">// é»˜è®¤ä¸ºnullï¼Œæ‰©å®¹æ—¶æ–°ç”Ÿæˆçš„æ•°ç»„ï¼Œå…¶å¤§å°ä¸ºåŸæ•°ç»„çš„ä¸¤å€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node&lt;K,V&gt;[] nextTable;</span><br><span class="line"><span class="comment">// é»˜è®¤ä¸º0ï¼Œç”¨æ¥æ§åˆ¶tableçš„åˆå§‹åŒ–å’Œæ‰©å®¹æ“ä½œ</span></span><br><span class="line"><span class="comment">// -1ï¼šè¡¨ç¤ºtableæ­£åœ¨åˆå§‹åŒ–</span></span><br><span class="line"><span class="comment">// -Nï¼šè¡¨ç¤ºæœ‰N-1ä¸ªçº¿ç¨‹æ­£åœ¨è¿›è¡Œæ‰©å®¹æ“ä½œ</span></span><br><span class="line"><span class="comment">// éè´Ÿæƒ…å†µ</span></span><br><span class="line"><span class="comment">// å¦‚æœtableæœªåˆå§‹åŒ–ï¼Œè¡¨ç¤ºtableéœ€è¦åˆå§‹åŒ–çš„å¤§å°</span></span><br><span class="line"><span class="comment">// å¦‚æœtableåˆå§‹åŒ–å®Œæˆï¼Œè¡¨ç¤ºtableçš„é˜ˆå€¼ï¼Œé»˜è®¤æ˜¯tableå¤§å°çš„0.75å€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">int</span> sizeCtl;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¹æ®initialCapacityåˆå§‹åŒ–</span></span><br><span class="line"><span class="comment">// initialCapacity + (initialCapacity &gt;&gt;&gt; 1) + 1)æ²¡çœ‹æ‡‚ï¼ŒçŸ¥é“çš„è¯·call meï¼ˆéš¾é“å’Œ0.75æœ‰å…³ç³»ï¼Ÿï¼‰</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConcurrentHashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">int</span> cap = ((initialCapacity &gt;= (MAXIMUM_CAPACITY &gt;&gt;&gt; <span class="number">1</span>)) ?</span><br><span class="line">               MAXIMUM_CAPACITY :</span><br><span class="line">               tableSizeFor(initialCapacity + (initialCapacity &gt;&gt;&gt; <span class="number">1</span>) + <span class="number">1</span>));</span><br><span class="line">    <span class="comment">// å¤åˆ¶ç»™ sizeCtl</span></span><br><span class="line">    <span class="keyword">this</span>.sizeCtl = cap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="å¢"><a href="#å¢" class="headerlink" title="å¢"></a>å¢</h1><p>æ–°å¢èŠ‚ç‚¹ï¼Œå¯èƒ½ä¼šï¼ˆå¹¶å‘ï¼‰æ‰©å®¹<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é€šè¿‡Unsafeæ‹¿åˆ°sizeCtlçš„åœ°å€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> SIZECTL;</span><br><span class="line"><span class="comment">// é€šè¿‡Unsafeæ‹¿åˆ°baseCountçš„åœ°å€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> BASECOUNT;</span><br><span class="line"><span class="comment">// ç§»åŠ¨èŠ‚ç‚¹çš„hashå€¼ï¼Œåªåœ¨transfer(æ‰©å®¹æ–¹æ³•ä¸­)æ–°å»ºForwardingNodeè®¾ç½®</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MOVED     = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(key, value, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(K key, V value, <span class="keyword">boolean</span> onlyIfAbsent)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (key == <span class="keyword">null</span> || value == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="comment">// å¯¹hashCodeè¿›è¡Œå†æ•£åˆ—</span></span><br><span class="line">    <span class="comment">// ç®—æ³•ä¸º(h ^ (h &gt;&gt;&gt; 16)) &amp; HASH_BITS(0x7fffffff)</span></span><br><span class="line">    <span class="keyword">int</span> hash = spread(key.hashCode());</span><br><span class="line">    <span class="comment">// å‡†å¤‡éå†table</span></span><br><span class="line">    <span class="keyword">int</span> binCount = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// è¿™è¾¹åŠ äº†ä¸€ä¸ªå¾ªç¯ï¼Œå°±æ˜¯ä¸æ–­çš„å°è¯•</span></span><br><span class="line">    <span class="keyword">for</span> (Node&lt;K,V&gt;[] tab = table;;) &#123;</span><br><span class="line">        Node&lt;K,V&gt; f; <span class="keyword">int</span> n, i, fh;</span><br><span class="line">        <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">            <span class="comment">// åˆå§‹åŒ–table</span></span><br><span class="line">            tab = initTable();</span><br><span class="line">        <span class="comment">// è·å–å¯¹åº”ä¸‹æ ‡èŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯ç©ºï¼Œç›´æ¥æ’å…¥</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i = (n - <span class="number">1</span>) &amp; hash)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// CAS è¿›è¡Œæ’å…¥</span></span><br><span class="line">            <span class="keyword">if</span> (casTabAt(tab, i, <span class="keyword">null</span>,</span><br><span class="line">                         <span class="keyword">new</span> Node&lt;K,V&gt;(hash, key, value, <span class="keyword">null</span>)))</span><br><span class="line">                <span class="keyword">break</span>;                   <span class="comment">// no lock when adding to empty bin</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœ hash å†²çªäº†</span></span><br><span class="line">        <span class="comment">// ä¸” hash å€¼ä¸º -1(MOVED)ï¼Œè¯´æ˜æ˜¯ ForwardingNode å¯¹è±¡ï¼ˆè¿™æ˜¯ä¸€ä¸ªå ä½ç¬¦å¯¹è±¡ï¼Œä¿å­˜äº†æ‰©å®¹åçš„å®¹å™¨ï¼‰</span></span><br><span class="line">        <span class="comment">// è¡¨ç¤ºäº†æ­£åœ¨æ‰©å®¹ï¼Œéœ€è¦å¸®åŠ© Map è¿›è¡Œæ‰©å®¹ï¼Œä»¥åŠ å¿«é€Ÿåº¦</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">            tab = helpTransfer(tab, f);</span><br><span class="line">        <span class="comment">// å¦‚æœ hash å†²çªäº†ï¼Œä¸” hash å€¼ä¸ä¸º -1</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            V oldVal = <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">// åŒæ­¥ f èŠ‚ç‚¹ï¼Œé˜²æ­¢å¢åŠ é“¾è¡¨çš„æ—¶å€™å¯¼è‡´é“¾è¡¨æˆç¯(ä¼šå‡ºç°æ­»å¾ªç¯)</span></span><br><span class="line">            <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœå¯¹åº”çš„ä¸‹æ ‡ä½ç½® çš„èŠ‚ç‚¹æ²¡æœ‰æ”¹å˜</span></span><br><span class="line">                <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                    <span class="comment">// å¹¶ä¸” f èŠ‚ç‚¹çš„hash å€¼ å¤§äº0</span></span><br><span class="line">                    <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// é“¾è¡¨é•¿åº¦</span></span><br><span class="line">                        binCount = <span class="number">1</span>;</span><br><span class="line">                        <span class="comment">// æ­»å¾ªç¯ï¼Œç›´åˆ°å°†å€¼æ·»åŠ åˆ°é“¾è¡¨å°¾éƒ¨ï¼Œå¹¶è®¡ç®—é“¾è¡¨çš„é•¿åº¦</span></span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; e = f;; ++binCount) &#123;</span><br><span class="line">                            K ek;</span><br><span class="line">                            <span class="comment">// é‡åˆ°é‡å¤çš„keyï¼Œæ ¹æ®æ ‡å¿—ä½è¦†ç›–</span></span><br><span class="line">                            <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                                ((ek = e.key) == key ||</span><br><span class="line">                                 (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek)))) &#123;</span><br><span class="line">                                oldVal = e.val;</span><br><span class="line">                                <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                    e.val = value;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            Node&lt;K,V&gt; pred = e;</span><br><span class="line">                            <span class="comment">// å°¾éƒ¨æ’å…¥</span></span><br><span class="line">                            <span class="keyword">if</span> ((e = e.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                pred.next = <span class="keyword">new</span> Node&lt;K,V&gt;(hash, key,</span><br><span class="line">                                                          value, <span class="keyword">null</span>);</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// å¦‚æœ f èŠ‚ç‚¹çš„ has å°äº0 å¹¶ä¸”f æ˜¯ æ ‘ç±»å‹</span></span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">                        Node&lt;K,V&gt; p;</span><br><span class="line">                        binCount = <span class="number">2</span>;</span><br><span class="line">                        <span class="comment">// æ’å…¥æ ‘ä¸­</span></span><br><span class="line">                        <span class="keyword">if</span> ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key,</span><br><span class="line">                                                       value)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            oldVal = p.val;</span><br><span class="line">                            <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                p.val = value;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (binCount != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// é“¾è¡¨é•¿åº¦å¤§äºç­‰äº8æ—¶ï¼Œå°†è¯¥èŠ‚ç‚¹æ”¹æˆçº¢é»‘æ ‘æ ‘</span></span><br><span class="line">                <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD)</span><br><span class="line">                    treeifyBin(tab, i);</span><br><span class="line">                <span class="keyword">if</span> (oldVal != <span class="keyword">null</span>)</span><br><span class="line">                    <span class="keyword">return</span> oldVal;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹CAS</span></span><br><span class="line">    addCount(<span class="number">1L</span>, binCount);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–table</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Node&lt;K,V&gt;[] initTable() &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; <span class="keyword">int</span> sc;</span><br><span class="line">    <span class="keyword">while</span> ((tab = table) == <span class="keyword">null</span> || tab.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœä¸€ä¸ªçº¿ç¨‹å‘ç°sizeCtl&lt;0ï¼Œæ„å‘³ç€å¦å¤–çš„çº¿ç¨‹æ‰§è¡ŒCASæ“ä½œæˆåŠŸ</span></span><br><span class="line">        <span class="comment">// å½“å‰çº¿ç¨‹åªéœ€è¦è®©å‡ºcpuæ—¶é—´ç‰‡</span></span><br><span class="line">        <span class="keyword">if</span> ((sc = sizeCtl) &lt; <span class="number">0</span>)</span><br><span class="line">            Thread.yield(); <span class="comment">// lost initialization race; just spin</span></span><br><span class="line">        <span class="comment">// CAS ä¿®æ”¹ sizeCtl çš„å€¼ä¸º-1</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, -<span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || tab.length == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// sc åœ¨åˆå§‹åŒ–çš„æ—¶å€™ç”¨æˆ·å¯èƒ½ä¼šè‡ªå®šä¹‰ï¼Œå¦‚æœæ²¡æœ‰è‡ªå®šä¹‰ï¼Œåˆ™æ˜¯é»˜è®¤çš„16</span></span><br><span class="line">                    <span class="keyword">int</span> n = (sc &gt; <span class="number">0</span>) ? sc : DEFAULT_CAPACITY;</span><br><span class="line">                    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">                    Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node&lt;?,?&gt;[n];</span><br><span class="line">                    table = tab = nt;</span><br><span class="line">                    <span class="comment">// è®¡ç®—åä½œä¸ºæ‰©å®¹çš„é˜€å€¼(ç›¸å½“äºä¹˜ä»¥0.75)</span></span><br><span class="line">                    sc = n - (n &gt;&gt;&gt; <span class="number">2</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                sizeCtl = sc;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> tab;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Helps transfer if a resize is in progress.</span></span><br><span class="line"><span class="comment"> * å¦‚æœæ­£åœ¨æ‰©å®¹ï¼Œåˆ™å¸®åŠ©æ‰©å®¹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> Node&lt;K,V&gt;[] helpTransfer(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt; f) &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] nextTab; <span class="keyword">int</span> sc;</span><br><span class="line">    <span class="comment">// å¦‚æœ table ä¸æ˜¯ç©º ä¸” node èŠ‚ç‚¹æ˜¯è½¬ç§»èŠ‚ç‚¹</span></span><br><span class="line">    <span class="comment">// // ä¸” node èŠ‚ç‚¹çš„ nextTableï¼ˆæ–° tableï¼‰ ä¸æ˜¯ç©º</span></span><br><span class="line">    <span class="keyword">if</span> (tab != <span class="keyword">null</span> &amp;&amp; (f <span class="keyword">instanceof</span> ForwardingNode) &amp;&amp;</span><br><span class="line">        (nextTab = ((ForwardingNode&lt;K,V&gt;)f).nextTable) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// æ ¹æ® length å¾—åˆ°ä¸€ä¸ªæ ‡è¯†ç¬¦å·</span></span><br><span class="line">        <span class="keyword">int</span> rs = resizeStamp(tab.length);</span><br><span class="line">        <span class="comment">// å¦‚æœ nextTab æ²¡æœ‰è¢«å¹¶å‘ä¿®æ”¹ ä¸” tab ä¹Ÿæ²¡æœ‰è¢«å¹¶å‘ä¿®æ”¹ ä¸” sizeCtl  &lt; 0 ï¼ˆè¯´æ˜è¿˜åœ¨æ‰©å®¹ï¼‰</span></span><br><span class="line">        <span class="keyword">while</span> (nextTab == nextTable &amp;&amp; table == tab &amp;&amp;</span><br><span class="line">               (sc = sizeCtl) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">             <span class="comment">// å¦‚æœ sizeCtl æ— ç¬¦å·å³ç§»  16 ä¸ç­‰äº rs ï¼ˆ scå‰ 16 ä½å¦‚æœä¸ç­‰äºæ ‡è¯†ç¬¦ï¼Œåˆ™æ ‡è¯†ç¬¦å˜åŒ–äº†ï¼‰</span></span><br><span class="line">             <span class="comment">// æˆ–è€… sizeCtl == rs + 1  ï¼ˆæ‰©å®¹ç»“æŸäº†ï¼Œä¸å†æœ‰çº¿ç¨‹è¿›è¡Œæ‰©å®¹ï¼‰ï¼ˆé»˜è®¤ç¬¬ä¸€ä¸ªçº¿ç¨‹è®¾ç½® sc ==rs å·¦ç§» 16 ä½ + 2ï¼Œå½“ç¬¬ä¸€ä¸ªçº¿ç¨‹ç»“æŸæ‰©å®¹äº†ï¼Œå°±ä¼šå°† sc å‡ä¸€ã€‚è¿™ä¸ªæ—¶å€™ï¼Œsc å°±ç­‰äº rs + 1ï¼‰</span></span><br><span class="line">             <span class="comment">// æˆ–è€… sizeCtl == rs + 65535  ï¼ˆå¦‚æœè¾¾åˆ°æœ€å¤§å¸®åŠ©çº¿ç¨‹çš„æ•°é‡ï¼Œå³ 65535ï¼‰</span></span><br><span class="line">             <span class="comment">// æˆ–è€…è½¬ç§»ä¸‹æ ‡æ­£åœ¨è°ƒæ•´ ï¼ˆæ‰©å®¹ç»“æŸï¼‰</span></span><br><span class="line">             <span class="comment">// ç»“æŸå¾ªç¯ï¼Œè¿”å› table</span></span><br><span class="line">            <span class="keyword">if</span> ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + <span class="number">1</span> ||</span><br><span class="line">                sc == rs + MAX_RESIZERS || transferIndex &lt;= <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// å¦‚æœä»¥ä¸Šéƒ½ä¸æ˜¯, å°† sizeCtl + 1, ï¼ˆè¡¨ç¤ºå¢åŠ äº†ä¸€ä¸ªçº¿ç¨‹å¸®åŠ©å…¶æ‰©å®¹ï¼‰</span></span><br><span class="line">            <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, sc + <span class="number">1</span>)) &#123;</span><br><span class="line">                <span class="comment">// æ‰©å®¹</span></span><br><span class="line">                transfer(tab, nextTab);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> nextTab;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> table;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹ï¼Œéœ€è¦åˆ™è¿›è¡Œæ‰©å®¹</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">addCount</span><span class="params">(<span class="keyword">long</span> x, <span class="keyword">int</span> check)</span> </span>&#123;</span><br><span class="line">    CounterCell[] as; <span class="keyword">long</span> b, s;</span><br><span class="line">    <span class="comment">// å¦‚æœè®¡æ•°ç›’å­ä¸æ˜¯ç©º æˆ–è€… ä¿®æ”¹ baseCount å¤±è´¥</span></span><br><span class="line">    <span class="keyword">if</span> ((as = counterCells) != <span class="keyword">null</span> ||</span><br><span class="line">        !U.compareAndSwapLong(<span class="keyword">this</span>, BASECOUNT, b = baseCount, s = b + x)) &#123;</span><br><span class="line">        CounterCell a; <span class="keyword">long</span> v; <span class="keyword">int</span> m;</span><br><span class="line">        <span class="keyword">boolean</span> uncontended = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">// å¦‚æœè®¡æ•°ç›’å­æ˜¯ç©ºï¼ˆå°šæœªå‡ºç°å¹¶å‘ï¼‰æˆ–è€… éšæœºå–ä½™ä¸€ä¸ªæ•°ç»„ä½ç½®ä¸ºç©º</span></span><br><span class="line">        <span class="comment">// æˆ–è€… ä¿®æ”¹è¿™ä¸ªæ§½ä½çš„å˜é‡å¤±è´¥ï¼ˆå‡ºç°å¹¶å‘äº†ï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> (as == <span class="keyword">null</span> || (m = as.length - <span class="number">1</span>) &lt; <span class="number">0</span> ||</span><br><span class="line">            (a = as[ThreadLocalRandom.getProbe() &amp; m]) == <span class="keyword">null</span> ||</span><br><span class="line">            !(uncontended =</span><br><span class="line">              U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x))) &#123;</span><br><span class="line">            <span class="comment">// CASå¢åŠ </span></span><br><span class="line">            fullAddCount(x, uncontended);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (check &lt;= <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="comment">// ç»Ÿè®¡size</span></span><br><span class="line">        s = sumCount();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœéœ€è¦æ£€æŸ¥,æ£€æŸ¥æ˜¯å¦éœ€è¦æ‰©å®¹ï¼Œåœ¨ putVal æ–¹æ³•è°ƒç”¨æ—¶ï¼Œé»˜è®¤å°±æ˜¯è¦æ£€æŸ¥çš„ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (check &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        Node&lt;K,V&gt;[] tab, nt; <span class="keyword">int</span> n, sc;</span><br><span class="line">        <span class="comment">// å¦‚æœmap.size() å¤§äº sizeCtlï¼ˆè¾¾åˆ°æ‰©å®¹é˜ˆå€¼éœ€è¦æ‰©å®¹ï¼‰</span></span><br><span class="line">        <span class="comment">// ä¸”table ä¸æ˜¯ç©ºï¼›ä¸” table çš„é•¿åº¦å°äº 1 &lt;&lt; 30ã€‚ï¼ˆå¯ä»¥æ‰©å®¹ï¼‰</span></span><br><span class="line">        <span class="keyword">while</span> (s &gt;= (<span class="keyword">long</span>)(sc = sizeCtl) &amp;&amp; (tab = table) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">               (n = tab.length) &lt; MAXIMUM_CAPACITY) &#123;</span><br><span class="line">            <span class="keyword">int</span> rs = resizeStamp(n</span><br><span class="line">            <span class="comment">// å¦‚æœæ­£åœ¨æ‰©å®¹</span></span><br><span class="line">            <span class="keyword">if</span> (sc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœ sc çš„ä½ 16 ä½ä¸ç­‰äº æ ‡è¯†ç¬¦ï¼ˆæ ¡éªŒå¼‚å¸¸ sizeCtl å˜åŒ–äº†ï¼‰</span></span><br><span class="line">                <span class="comment">// å¦‚æœ sc == æ ‡è¯†ç¬¦ + 1 ï¼ˆæ‰©å®¹ç»“æŸäº†ï¼Œä¸å†æœ‰çº¿ç¨‹è¿›è¡Œæ‰©å®¹ï¼‰ï¼ˆé»˜è®¤ç¬¬ä¸€ä¸ªçº¿ç¨‹è®¾ç½® sc ==rs å·¦ç§» 16 ä½ + 2ï¼Œå½“ç¬¬ä¸€ä¸ªçº¿ç¨‹ç»“æŸæ‰©å®¹äº†ï¼Œå°±ä¼šå°† sc å‡ä¸€ã€‚è¿™ä¸ªæ—¶å€™ï¼Œsc å°±ç­‰äº rs + 1ï¼‰</span></span><br><span class="line">                <span class="comment">// å¦‚æœ sc == æ ‡è¯†ç¬¦ + 65535ï¼ˆå¸®åŠ©çº¿ç¨‹æ•°å·²ç»è¾¾åˆ°æœ€å¤§ï¼‰</span></span><br><span class="line">                <span class="comment">// å¦‚æœ nextTable == nullï¼ˆç»“æŸæ‰©å®¹äº†ï¼‰</span></span><br><span class="line">                <span class="comment">// å¦‚æœ transferIndex &lt;= 0 (è½¬ç§»çŠ¶æ€å˜åŒ–äº†)</span></span><br><span class="line">                <span class="comment">// ç»“æŸå¾ªç¯</span></span><br><span class="line">                <span class="keyword">if</span> ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + <span class="number">1</span> ||</span><br><span class="line">                    sc == rs + MAX_RESIZERS || (nt = nextTable) == <span class="keyword">null</span> ||</span><br><span class="line">                    transferIndex &lt;= <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="comment">// å¦‚æœå¯ä»¥å¸®åŠ©æ‰©å®¹ï¼Œé‚£ä¹ˆå°† sc åŠ  1. è¡¨ç¤ºå¤šäº†ä¸€ä¸ªçº¿ç¨‹åœ¨å¸®åŠ©æ‰©å®¹</span></span><br><span class="line">                <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, sc + <span class="number">1</span>))</span><br><span class="line">                    <span class="comment">// æ‰©å®¹(æœ‰ç‚¹å¤æ‚ï¼Œè®¾è®¡åˆ°å¹¶å‘æ‰©å®¹ï¼Œå¯ä»¥åœ¨åé¢çš„å‚è€ƒæ‰¾åˆ°æ–‡ç« ï¼Œè¿™é‡Œå°±ä¸åˆ†æäº†)</span></span><br><span class="line">                    transfer(tab, nt);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¦‚æœä¸åœ¨æ‰©å®¹ï¼Œå°† sc æ›´æ–°ï¼šæ ‡è¯†ç¬¦å·¦ç§» 16 ä½ ç„¶å + 2. ä¹Ÿå°±æ˜¯å˜æˆä¸€ä¸ªè´Ÿæ•°ã€‚é«˜ 16 ä½æ˜¯æ ‡è¯†ç¬¦ï¼Œä½ 16 ä½åˆå§‹æ˜¯ 2.</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc,</span><br><span class="line">                                         (rs &lt;&lt; RESIZE_STAMP_SHIFT) + <span class="number">2</span>))</span><br><span class="line">                <span class="comment">// æ›´æ–° sizeCtl ä¸ºè´Ÿæ•°åï¼Œå¼€å§‹æ‰©å®¹ã€‚</span></span><br><span class="line">                transfer(tab, <span class="keyword">null</span>);</span><br><span class="line">            <span class="comment">// ç»Ÿè®¡size</span></span><br><span class="line">            s = sumCount();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="åˆ "><a href="#åˆ " class="headerlink" title="åˆ "></a>åˆ </h1><p>æ ¹æ®keyåˆ é™¤é”®å€¼å¯¹ï¼Œå¦‚æœkeyä¸å­˜åœ¨ï¼Œä»€ä¹ˆä¹Ÿä¸åš<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">remove</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> replaceNode(key, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¨æ–°cvå–ä»£åŸæ¥çš„valueï¼Œå¦‚æœvalueæ˜¯nullï¼Œå°±ä»£è¡¨åˆ é™¤</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> V <span class="title">replaceNode</span><span class="params">(Object key, V value, Object cv)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è®¡ç®—keyçš„hashå€¼</span></span><br><span class="line">    <span class="keyword">int</span> hash = spread(key.hashCode());</span><br><span class="line">    <span class="keyword">for</span> (Node&lt;K,V&gt;[] tab = table;;) &#123;</span><br><span class="line">        Node&lt;K,V&gt; f; <span class="keyword">int</span> n, i, fh;</span><br><span class="line">        <span class="comment">// tableä¸ºç©º æˆ– å®¹é‡ä¸º0 æˆ– ä¸å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span> ||</span><br><span class="line">            (f = tabAt(tab, i = (n - <span class="number">1</span>) &amp; hash)) == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// æ­£åœ¨æ‰©å®¹</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">            <span class="comment">// ååŠ©æ‰©å®¹</span></span><br><span class="line">            tab = helpTransfer(tab, f);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            V oldVal = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">boolean</span> validated = <span class="keyword">false</span>;</span><br><span class="line">            <span class="comment">// åŒæ­¥åˆ é™¤</span></span><br><span class="line">            <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                <span class="comment">// æ¡¶ä¸­çš„ç¬¬ä¸€ä¸ªç»“ç‚¹æ²¡æœ‰å‘ç”Ÿå˜åŒ–</span></span><br><span class="line">                <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                    <span class="comment">// æ›¿æ¢é“¾è¡¨ä¸­çš„èŠ‚ç‚¹</span></span><br><span class="line">                    <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        validated = <span class="keyword">true</span>;</span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; e = f, pred = <span class="keyword">null</span>;;) &#123;</span><br><span class="line">                            K ek;</span><br><span class="line">                            <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                                ((ek = e.key) == key ||</span><br><span class="line">                                 (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek)))) &#123;</span><br><span class="line">                                V ev = e.val;</span><br><span class="line">                                <span class="keyword">if</span> (cv == <span class="keyword">null</span> || cv == ev ||</span><br><span class="line">                                    (ev != <span class="keyword">null</span> &amp;&amp; cv.equals(ev))) &#123;</span><br><span class="line">                                    oldVal = ev;</span><br><span class="line">                                    <span class="comment">// valueä¸ä¸ºnullï¼Œæ›¿æ¢</span></span><br><span class="line">                                    <span class="keyword">if</span> (value != <span class="keyword">null</span>)</span><br><span class="line">                                        e.val = value;</span><br><span class="line">                                    <span class="comment">// valueä¸ºnullï¼Œåˆ é™¤</span></span><br><span class="line">                                    <span class="keyword">else</span> <span class="keyword">if</span> (pred != <span class="keyword">null</span>)</span><br><span class="line">                                        <span class="comment">// å‰é©±çš„åç»§ä¸ºeçš„åç»§ï¼Œå³åˆ é™¤äº†eç»“ç‚¹</span></span><br><span class="line">                                        pred.next = e.next;</span><br><span class="line">                                    <span class="keyword">else</span></span><br><span class="line">                                        setTabAt(tab, i, e.next);</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            pred = e;</span><br><span class="line">                            <span class="keyword">if</span> ((e = e.next) == <span class="keyword">null</span>)</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// æ›¿æ¢çº¢é»‘æ ‘ä¸­çš„èŠ‚ç‚¹</span></span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">                        validated = <span class="keyword">true</span>;</span><br><span class="line">                        TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)f;</span><br><span class="line">                        TreeNode&lt;K,V&gt; r, p;</span><br><span class="line">                        <span class="keyword">if</span> ((r = t.root) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                            (p = r.findTreeNode(hash, key, <span class="keyword">null</span>)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            V pv = p.val;</span><br><span class="line">                            <span class="keyword">if</span> (cv == <span class="keyword">null</span> || cv == pv ||</span><br><span class="line">                                (pv != <span class="keyword">null</span> &amp;&amp; cv.equals(pv))) &#123;</span><br><span class="line">                                oldVal = pv;</span><br><span class="line">                                <span class="comment">// valueä¸ä¸ºnullï¼Œæ›¿æ¢</span></span><br><span class="line">                                <span class="keyword">if</span> (value != <span class="keyword">null</span>)</span><br><span class="line">                                    p.val = value;</span><br><span class="line">                                <span class="comment">// valueä¸ºnullï¼Œåˆ é™¤</span></span><br><span class="line">                                <span class="keyword">else</span> <span class="keyword">if</span> (t.removeTreeNode(p))</span><br><span class="line">                                    <span class="comment">// è¿”å›ä¸ºtrueï¼Œå»æ ‘åŒ–</span></span><br><span class="line">                                    setTabAt(tab, i, untreeify(t.first));</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (validated) &#123;</span><br><span class="line">                <span class="keyword">if</span> (oldVal != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (value == <span class="keyword">null</span>)</span><br><span class="line">                        <span class="comment">// æ€»æ•°-1</span></span><br><span class="line">                        addCount(-<span class="number">1L</span>, -<span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">return</span> oldVal;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="æ”¹"><a href="#æ”¹" class="headerlink" title="æ”¹"></a>æ”¹</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">replace</span><span class="params">(K key, V oldValue, V newValue)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (key == <span class="keyword">null</span> || oldValue == <span class="keyword">null</span> || newValue == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="comment">// å¯¹äºreplaceNodeæ–¹æ³•åœ¨åˆ é™¤æ“ä½œä¸­å·²ç»è§£æè¿‡äº†</span></span><br><span class="line">    <span class="keyword">return</span> replaceNode(key, newValue, oldValue) != <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="æŸ¥"><a href="#æŸ¥" class="headerlink" title="æŸ¥"></a>æŸ¥</h1><p>æ ¹æ®keyè·å–value<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; e, p; <span class="keyword">int</span> n, eh; K ek;</span><br><span class="line">    <span class="comment">// è®¡ç®—keyçš„hash</span></span><br><span class="line">    <span class="keyword">int</span> h = spread(key.hashCode());</span><br><span class="line">    <span class="comment">// tableä¸ä¸ºç©º</span></span><br><span class="line">    <span class="keyword">if</span> ((tab = table) != <span class="keyword">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">        (e = tabAt(tab, (n - <span class="number">1</span>) &amp; h)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­å¤´èŠ‚ç‚¹æ˜¯å¦ç¬¦åˆ</span></span><br><span class="line">        <span class="keyword">if</span> ((eh = e.hash) == h) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((ek = e.key) == key || (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek)))</span><br><span class="line">                <span class="keyword">return</span> e.val;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åœ¨æ ‘ä¸­æŸ¥æ‰¾ï¼Œå°äº0çš„ä»£è¡¨äº†æ ‘çš„æ ¹èŠ‚ç‚¹ï¼Œå› ä¸ºæ ‘çš„æ ¹èŠ‚ç‚¹çš„å“ˆå¸Œå€¼ä¸ºTREEBINï¼ˆ-2ï¼‰</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (eh &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="comment">// è°ƒç”¨çº¢é»‘æ ‘çš„æŸ¥æ‰¾æ–¹æ³•</span></span><br><span class="line">            <span class="keyword">return</span> (p = e.find(h, key)) != <span class="keyword">null</span> ? p.val : <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// åœ¨é“¾è¡¨ä¸­æŸ¥æ‰¾</span></span><br><span class="line">        <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (e.hash == h &amp;&amp;</span><br><span class="line">                ((ek = e.key) == key || (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek))))</span><br><span class="line">                <span class="keyword">return</span> e.val;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ConcurrentHashMap æ˜¯ Doug Lea çš„ç¥ä½œï¼Œå¯ä»¥è¯´æ˜¯ç²¾å½©ç»ä¼¦ï¼Œæ€»çš„æ¥è¯´ï¼Œä½¿ç”¨äº† CASï¼ˆæ‰©å®¹å¹¶å‘ï¼‰ å’Œ synchronized æ¥ä¿è¯äº† put æ“ä½œå¹¶å‘æ—¶çš„å±é™©ï¼ˆç‰¹åˆ«æ˜¯é“¾è¡¨ï¼Œé˜²æ­¢äº†æ­»å¾ªç¯çš„å‘ç”Ÿï¼‰ï¼Œåœ¨è¯»æ–¹æ³•å®Œå…¨æ²¡æœ‰é”ï¼Œå®Œå…¨å¹¶å‘ï¼Œç›¸æ¯”å…¶ä»–çº¿ç¨‹å®‰å…¨çš„Mapï¼Œå®ƒçš„æ€§èƒ½çœŸæ˜¯æ æ æ»´ã€‚å†™å®Œæ‰å‘ç°è‡ªå·±åªæ˜¯æ‰“äº†æ³¨é‡Šï¼Œè¿˜æ²¡æœ‰æ¦‚æ‹¬æ€§çš„è¯è¯­ï¼Œç¼ºå°‘äº†æ€»ç»“ï¼Œä»¥åéœ€è¦æ³¨æ„ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒConcurrentHashMapè‚¯å®šä¸æ˜¯ä¸€éæ–‡ç« å°±èƒ½è¯´å®Œäº†ï¼Œä»¥åè¿˜éœ€è¦åŸºç¡€å›é¡¾ï¼Œç»§ç»­è¡¥å……ã€‚</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol>
<li><a href="https://www.jianshu.com/p/d3fda02d4cae" target="_blank" rel="noopener">javaå†…å­˜æ¨¡å‹</a></li>
<li><a href="https://www.jianshu.com/p/a16d638bc921" target="_blank" rel="noopener">javaä¸­çš„Unsafe</a></li>
<li><a href="https://www.jianshu.com/p/fb6e91b013cc" target="_blank" rel="noopener">æ·±å…¥æµ…å‡ºCAS</a></li>
<li><a href="https://www.jianshu.com/p/d8eeb31bee5c" target="_blank" rel="noopener">æ·±å…¥æµ…å‡ºjavaåŒæ­¥å™¨AQS</a></li>
<li><a href="https://www.jianshu.com/p/4358b1466ec9" target="_blank" rel="noopener">æ·±å…¥æµ…å‡ºReentrantLock</a></li>
<li><a href="https://blog.csdn.net/u010771890/article/details/73732648" target="_blank" rel="noopener">Javaå¹¶å‘å®¹å™¨ConcurrentHashMapåŸç†åŠHashMapæ­»å¾ªç¯åŸå› çš„åˆ†æ</a></li>
<li><a href="https://www.jianshu.com/p/29d8e66bc3bf" target="_blank" rel="noopener">ConcurrentHashMap æºç é˜…è¯»å°ç»“</a></li>
<li><a href="https://www.jianshu.com/p/c0642afe03e0" target="_blank" rel="noopener">æ·±å…¥æµ…å‡ºConcurrentHashMap1.8</a></li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¼•ï¼šHashMapæ˜¯æˆ‘ä»¬å¹³æ—¶å¼€å‘è¿‡ç¨‹ä¸­ç”¨çš„æ¯”è¾ƒå¤šçš„é›†åˆï¼Œä½†å®ƒæ˜¯éçº¿ç¨‹å®‰å…¨çš„ã€‚è§£å†³æ–¹æ¡ˆæœ‰Hashtableå’ŒCollections.synchronizedMap(hashMap)ï¼Œä¸è¿‡è¿™ä¸¤ä¸ªæ–¹æ¡ˆåŸºæœ¬ä¸Šæ˜¯å¯¹è¯»å†™è¿›è¡ŒåŠ é”æ“ä½œï¼Œæ€§èƒ½å¯æƒ³è€ŒçŸ¥ã€‚æ‰€ä»¥æ„Ÿè°¢&lt;strong&gt;Doug Lea&lt;/strong&gt;ç»™æˆ‘ä»¬å¸¦æ¥äº†å¹¶å‘å®‰å…¨çš„ConcurrentHashMapã€‚
    
    </summary>
    
      <category term="JDKæºç åˆ†æ" scheme="http://bestlixiang.site/categories/JDK%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
    
      <category term="ConcurrentHashMap" scheme="http://bestlixiang.site/tags/ConcurrentHashMap/"/>
    
  </entry>
  
</feed>
