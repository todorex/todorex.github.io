<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>rex note</title>
  <subtitle>é›¨è¿‡ï¼Œäº‘è¿‡</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://bestlixiang.site/"/>
  <updated>2019-06-22T06:23:48.546Z</updated>
  <id>http://bestlixiang.site/</id>
  
  <author>
    <name>rex</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>RocketMQæºç åˆ†æâ€”â€”Brokeræ¶ˆæ¯å­˜å‚¨</title>
    <link href="http://bestlixiang.site/2019/06/22/RocketMQ%E6%BA%90%E7%A0%81/RocketMQ%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E2%80%94%E2%80%94Broker%E6%B6%88%E6%81%AF%E5%AD%98%E5%82%A8/"/>
    <id>http://bestlixiang.site/2019/06/22/RocketMQæºç /RocketMQæºç åˆ†æâ€”â€”Brokeræ¶ˆæ¯å­˜å‚¨/</id>
    <published>2019-06-22T06:23:01.000Z</published>
    <updated>2019-06-22T06:23:48.546Z</updated>
    
    <content type="html"><![CDATA[<p>å¼•ï¼šæ¶ˆæ¯å­˜å‚¨å¯¹äºä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—æ¥è¯´æ˜¯è‚¯å®šè¦æœ‰çš„ï¼Œåœ¨RocketMQä¸­ï¼ŒBrokerå°†æ¶ˆæ¯å­˜å‚¨æŠ½è±¡æˆ<code>MessageStore</code>æ¥å£ï¼Œæˆ‘ä»¬ä¹Ÿå°†ä»è¿™é‡Œå…¥æ‰‹~ <a id="more"></a></p>
<h1 id="æ•°æ®ç»“æ„"><a href="#æ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h1><p>ç¾å›¾ï¼š</p>
<p><img src="https://img-blog.csdn.net/20180322173040972?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMjc1Mjk5MTc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="MessageStore"></p>
<p>ä»ä¸Šé¢æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å‡ ä¸ªæ ¸å¿ƒçš„æ•°æ®ç»“æ„ï¼š</p>
<ul>
<li><strong>CommitLog</strong>ï¼šå­˜å‚¨æ¶ˆæ¯çš„æ•°æ®ç»“æ„ï¼Œç±»ä¼¼ä¸€ä¸ªæ¶ˆæ¯æ•°ç»„ï¼ŒæŒ‰ç…§æ¶ˆæ¯æ”¶åˆ°çš„é¡ºåºï¼Œæ‰€æœ‰æ¶ˆæ¯éƒ½å­˜å‚¨åœ¨ä¸€èµ·ã€‚æ¯ä¸ªæ¶ˆæ¯å­˜å‚¨åéƒ½ä¼šç”Ÿæˆä¸€ä¸ªå¯¹åº”çš„offsetï¼Œä»£è¡¨åœ¨commitLogä¸­çš„å­—èŠ‚åç§»é‡ã€‚æ³¨æ„ï¼šCommitLogå¹¶ä¸æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œè€Œæ˜¯ä¸€ç³»åˆ—æ–‡ä»¶ï¼ˆä¸Šå›¾ä¸­çš„MappedFileï¼‰ã€‚æ¯ä¸ªMappedFileæ–‡ä»¶çš„å¤§å°éƒ½æ˜¯å›ºå®šçš„ï¼ˆé»˜è®¤1Gï¼‰ï¼Œå†™æ»¡ä¸€ä¸ªä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„æ–‡ä»¶ï¼Œæ–°æ–‡ä»¶çš„æ–‡ä»¶åå°±æ˜¯å®ƒå­˜å‚¨çš„ç¬¬ä¸€æ¡æ¶ˆæ¯çš„offsetã€‚</li>
<li><strong>ConsumeQueue</strong>ï¼šä¹‹å‰è¯´äº†æ‰€æœ‰æ¶ˆæ¯éƒ½æ˜¯å­˜å‚¨åœ¨ä¸€ä¸ªcommitLogä¸­çš„ï¼Œä½†æ˜¯consumeræ˜¯æŒ‰ç…§topic+queueçš„ç»´åº¦æ¥æ¶ˆè´¹æ¶ˆæ¯çš„ï¼Œæ²¡æœ‰åŠæ³•ç›´æ¥ä»commitLogä¸­è¯»å–ï¼Œæ‰€ä»¥é’ˆå¯¹æ¯ä¸ªtopicçš„æ¯ä¸ªqueueéƒ½ä¼šç”ŸæˆconsumeQueueï¼ŒConsumeQueueä¸­å­˜å‚¨çš„æ˜¯æ¶ˆæ¯åœ¨commitLogä¸­çš„offsetï¼Œå¯ä»¥ç†è§£æˆä¸€ä¸ªæŒ‰topic+queueå»ºçš„ç´¢å¼•ï¼Œæ¯æ¡æ¶ˆæ¯å ç”¨20å­—èŠ‚ï¼ˆä¸Šå›¾ä¸­çš„ä¸€ä¸ªcqï¼‰ã€‚è·ŸcommitLogä¸€æ ·ï¼Œæ¯ä¸ªQueueæ–‡ä»¶ä¹Ÿæ˜¯ä¸€ç³»åˆ—è¿ç»­çš„æ–‡ä»¶ç»„æˆï¼Œæ¯ä¸ªæ–‡ä»¶é»˜è®¤æ”¾30wä¸ªoffsetç´¢å¼•ã€‚</li>
<li><strong>IndexFile</strong>ï¼šCommitLogçš„å¦å¤–ä¸€ç§å½¢å¼çš„ç´¢å¼•æ–‡ä»¶ï¼Œåªæ˜¯ç´¢å¼•çš„æ˜¯messageKeyï¼Œæ¯ä¸ªMsgKeyç»è¿‡hashåè®¡ç®—å­˜å‚¨çš„slotï¼Œç„¶åå°†offsetå­˜åˆ°IndexFileçš„ç›¸åº”slotä¸Šã€‚æ ¹æ®msgKeyæ¥æŸ¥è¯¢æ¶ˆæ¯æ—¶ï¼Œå¯ä»¥å…ˆåˆ°IndexFileï¼ˆslot+indexç±»ä¼¼ä¸€ä¸ªhashmapï¼‰ä¸­æŸ¥è¯¢offsetï¼Œç„¶åæ ¹æ®offsetå»commitLogä¸­æŸ¥è¯¢å¯¹åº”çš„æ¶ˆæ¯ã€‚</li>
</ul>
<p>å…³äºå›¾ä¸­çš„è¿‡ç¨‹æˆ‘ä»¬åé¢ä¼šå±•å¼€è®²è§£~</p>
<h1 id="MessageStoreå¯åŠ¨"><a href="#MessageStoreå¯åŠ¨" class="headerlink" title="MessageStoreå¯åŠ¨"></a>MessageStoreå¯åŠ¨</h1><p>ä¹‹å‰ï¼Œæˆ‘ä»¬åœ¨BrokerControllerçš„å¯åŠ¨ä¸­çœ‹åˆ°äº†MessageStoreå¯åŠ¨ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿä»é‚£é‡Œå¼€å§‹çœ‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.rocketmq.store.DefaultMessageStore</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      <span class="comment">// æ„é€ æ–‡ä»¶é”ï¼Œä¿è¯ç£ç›˜ä¸Šçš„æ–‡ä»¶åªä¼šè¢«ä¸€ä¸ªmessageStoreè¯»å†™</span></span><br><span class="line">      lock = lockFile.getChannel().tryLock(<span class="number">0</span>, <span class="number">1</span>, <span class="keyword">false</span>);</span><br><span class="line">      <span class="keyword">if</span> (lock == <span class="keyword">null</span> || lock.isShared() || !lock.isValid()) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Lock failed,MQ already started"</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      lockFile.getChannel().write(ByteBuffer.wrap(<span class="string">"lock"</span>.getBytes()));</span><br><span class="line">      lockFile.getChannel().force(<span class="keyword">true</span>);</span><br><span class="line">      <span class="comment">// å¯åŠ¨FlushConsumeQueueService(ç»§æ‰¿ServiceThreadï¼Œæ˜¯ä¸ªå•çº¿ç¨‹)</span></span><br><span class="line">      <span class="comment">// å®šæ—¶å°†consumeQueueæ–‡ä»¶çš„æ•°æ®åˆ·æ–°åˆ°ç£ç›˜ï¼Œå‘¨æœŸç”±å‚æ•°flushIntervalConsumeQueueè®¾ç½®ï¼Œé»˜è®¤1ç§’</span></span><br><span class="line">      <span class="keyword">this</span>.flushConsumeQueueService.start();</span><br><span class="line">      <span class="comment">// å¯åŠ¨CommitLogï¼Œå¯¹åº”äº†flushCommitLogServiceæœåŠ¡</span></span><br><span class="line">    	<span class="comment">// flushCommitLogServiceæœåŠ¡è´Ÿè´£å°†CommitLogçš„æ•°æ®flushåˆ°ç£ç›˜ï¼Œæœ‰åŒæ­¥åˆ·ç›˜å’Œå¼‚æ­¥åˆ·ç›˜ä¸¤ç§æ–¹å¼</span></span><br><span class="line">      <span class="keyword">this</span>.commitLog.start();</span><br><span class="line">      <span class="comment">// æ¶ˆæ¯å­˜å‚¨æŒ‡æ ‡ç»Ÿè®¡æœåŠ¡ï¼ŒRTï¼ŒTPSç­‰æŒ‡æ ‡ï¼Œadminå¯ä»¥ç”¨</span></span><br><span class="line">      <span class="keyword">this</span>.storeStatsService.start();</span><br><span class="line">      <span class="comment">// é’ˆå¯¹masterï¼Œå¯åŠ¨å»¶æ—¶æ¶ˆæ¯è°ƒåº¦æœåŠ¡ï¼ŒçœŸçš„æ¶ˆè´¹å¤±è´¥çš„æƒ…å†µ</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.scheduleMessageService != <span class="keyword">null</span> &amp;&amp; SLAVE != messageStoreConfig.getBrokerRole()) &#123;</span><br><span class="line">          <span class="keyword">this</span>.scheduleMessageService.start();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// å¯åŠ¨ReputMessageServiceï¼Œè¯¥æœåŠ¡è´Ÿè´£å°†CommitLogä¸­çš„æ¶ˆæ¯offsetè®°å½•åˆ°cosumeQueueæ–‡ä»¶ä¸­</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.getMessageStoreConfig().isDuplicationEnable()) &#123;</span><br><span class="line">          <span class="keyword">this</span>.reputMessageService.setReputFromOffset(<span class="keyword">this</span>.commitLog.getConfirmOffset());</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">this</span>.reputMessageService.setReputFromOffset(<span class="keyword">this</span>.commitLog.getMaxOffset());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">this</span>.reputMessageService.start();</span><br><span class="line">      <span class="comment">// å¯åŠ¨HAServiceï¼Œæ•°æ®ä¸»ä»åŒæ­¥çš„æœåŠ¡</span></span><br><span class="line">      <span class="keyword">this</span>.haService.start();</span><br><span class="line">      <span class="comment">// å¯¹äºæ–°çš„brokerï¼Œåˆå§‹åŒ–æ–‡ä»¶å­˜å‚¨çš„ç›®å½•</span></span><br><span class="line">      <span class="keyword">this</span>.createTempFile();</span><br><span class="line">      <span class="comment">// å¯åŠ¨å®šæ—¶ä»»åŠ¡</span></span><br><span class="line">      <span class="keyword">this</span>.addScheduleTask();</span><br><span class="line">      <span class="keyword">this</span>.shutdown = <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶åçœ‹çœ‹å®ƒèµ·äº†å“ªäº›å®šæ—¶ä»»åŠ¡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addScheduleTask</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å®šæ—¶æ¸…ç†è¿‡æœŸçš„commitLogã€cosumeQueueæ•°æ®æ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            DefaultMessageStore.<span class="keyword">this</span>.cleanFilesPeriodically();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="number">1000</span> * <span class="number">60</span>, <span class="keyword">this</span>.messageStoreConfig.getCleanResourceInterval(), TimeUnit.MILLISECONDS);</span><br><span class="line">    <span class="comment">// å®šæ—¶è‡ªæ£€commitLogå’ŒconsumerQueueæ–‡ä»¶ï¼Œæ ¡éªŒæ–‡ä»¶æ˜¯å¦å®Œæ•´ã€‚ä¸»è¦ç”¨äºç›‘æ§ï¼Œä¸ä¼šåšä¿®å¤æ–‡ä»¶çš„åŠ¨ä½œ</span></span><br><span class="line">    <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            DefaultMessageStore.<span class="keyword">this</span>.checkSelf();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="number">1</span>, <span class="number">10</span>, TimeUnit.MINUTES);</span><br><span class="line">    <span class="comment">// å®šæ—¶æ£€æŸ¥commitLogçš„Lockæ—¶é•¿(å› ä¸ºåœ¨writeæˆ–è€…flushæ—¶ä¾¯ä¼šlock)</span></span><br><span class="line">    <span class="comment">// å¦‚æœlockçš„æ—¶é—´è¿‡é•¿ï¼Œåˆ™æ‰“å°jvmå †æ ˆï¼Œç”¨äºç›‘æ§ã€‚</span></span><br><span class="line">    <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (DefaultMessageStore.<span class="keyword">this</span>.getMessageStoreConfig().isDebugLockEnable()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (DefaultMessageStore.<span class="keyword">this</span>.commitLog.getBeginTimeInLock() != <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">long</span> lockTime = System.currentTimeMillis() - DefaultMessageStore.<span class="keyword">this</span>.commitLog.getBeginTimeInLock();</span><br><span class="line">                        <span class="keyword">if</span> (lockTime &gt; <span class="number">1000</span> &amp;&amp; lockTime &lt; <span class="number">10000000</span>) &#123;</span><br><span class="line"></span><br><span class="line">                            String stack = UtilAll.jstack();</span><br><span class="line">                            <span class="keyword">final</span> String fileName = System.getProperty(<span class="string">"user.home"</span>) + File.separator + <span class="string">"debug/lock/stack-"</span></span><br><span class="line">                                + DefaultMessageStore.<span class="keyword">this</span>.commitLog.getBeginTimeInLock() + <span class="string">"-"</span> + lockTime;</span><br><span class="line">                            MixAll.string2FileNotSafe(stack, fileName);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="number">1</span>, <span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="CommitLog"><a href="#CommitLog" class="headerlink" title="CommitLog"></a>CommitLog</h1><p>æˆ‘ä»¬çŸ¥é“å½“Brokeræ¥æ”¶åˆ°æ¶ˆæ¯ä¼šè¿›è¡Œå­˜å‚¨ï¼Œé¦–å…ˆå­˜å‚¨çš„å°±æ˜¯CommitLogï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°<code>org.apache.rocketmq.store.CommitLog#putMessage()</code>æ–¹æ³•ï¼Œè¿™é‡Œå¯èƒ½æœ‰å¤šæ¡æ¶ˆæ¯ä¸€èµ·å­˜å‚¨ï¼Œæˆ‘ä»¬è¿™é‡Œä¸»è¦è¯´ä¸€ä¸‹å•æ¡æ¶ˆæ¯å­˜å‚¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> PutMessageResult <span class="title">putMessage</span><span class="params">(<span class="keyword">final</span> MessageExtBrokerInner msg)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è®¾ç½®å­˜å‚¨æ—¶é—´æˆ³</span></span><br><span class="line">    msg.setStoreTimestamp(System.currentTimeMillis());</span><br><span class="line">    <span class="comment">// å¿½ç•¥åŠ å¯†</span></span><br><span class="line">    msg.setBodyCRC(UtilAll.crc32(msg.getBody()));</span><br><span class="line">    <span class="comment">// æ„é€ è¿”å›ç»“æœ</span></span><br><span class="line">    AppendMessageResult result = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// æ‹¿åˆ°ç»Ÿè®¡çŠ¶æ€æœåŠ¡ï¼Œåé¢ä¼šè®¾ç½®ä¸€äº›å€¼</span></span><br><span class="line">    StoreStatsService storeStatsService = <span class="keyword">this</span>.defaultMessageStore.getStoreStatsService();</span><br><span class="line">    <span class="comment">// æ‹¿åˆ°Topicå’Œqueueä¿¡æ¯</span></span><br><span class="line">    String topic = msg.getTopic();</span><br><span class="line">    <span class="keyword">int</span> queueId = msg.getQueueId();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> tranType = MessageSysFlag.getTransactionValue(msg.getSysFlag());</span><br><span class="line">    <span class="comment">// éäº‹åŠ¡æ¶ˆæ¯</span></span><br><span class="line">    <span class="keyword">if</span> (tranType == MessageSysFlag.TRANSACTION_NOT_TYPE</span><br><span class="line">        || tranType == MessageSysFlag.TRANSACTION_COMMIT_TYPE) &#123;</span><br><span class="line">        <span class="comment">// Delay Delivery</span></span><br><span class="line">        <span class="comment">// å»¶æ—¶æŠ•æ”¾æ¶ˆæ¯ï¼Œå˜æ›´topicä¸ºSCHEDULE_TOPIC_XXXXä»¥åŠé˜Ÿåˆ—</span></span><br><span class="line">      	<span class="comment">// è¢«é‡å‘çš„Scheduleä»»åŠ¡è¯»åˆ°</span></span><br><span class="line">        <span class="keyword">if</span> (msg.getDelayTimeLevel() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (msg.getDelayTimeLevel() &gt; <span class="keyword">this</span>.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel()) &#123;</span><br><span class="line">                msg.setDelayTimeLevel(<span class="keyword">this</span>.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            topic = ScheduleMessageService.SCHEDULE_TOPIC;</span><br><span class="line">            queueId = ScheduleMessageService.delayLevel2QueueId(msg.getDelayTimeLevel());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å¤‡ä»½ä¹‹å‰çš„topicå’ŒqueueId</span></span><br><span class="line">            MessageAccessor.putProperty(msg, MessageConst.PROPERTY_REAL_TOPIC, msg.getTopic());</span><br><span class="line">            MessageAccessor.putProperty(msg, MessageConst.PROPERTY_REAL_QUEUE_ID, String.valueOf(msg.getQueueId()));</span><br><span class="line">            msg.setPropertiesString(MessageDecoder.messageProperties2String(msg.getProperties()));</span><br><span class="line"></span><br><span class="line">            msg.setTopic(topic);</span><br><span class="line">            msg.setQueueId(queueId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> eclipseTimeInLock = <span class="number">0</span>;</span><br><span class="line">    MappedFile unlockMappedFile = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰æ­£åœ¨å†™å…¥æ–‡ä»¶</span></span><br><span class="line">    MappedFile mappedFile = <span class="keyword">this</span>.mappedFileQueue.getLastMappedFile();</span><br><span class="line">    <span class="comment">// è·å–å†™messageçš„é”ï¼Œå¯ä»¥æ˜¯è‡ªæ—‹é”æˆ–è€…å¯é‡å…¥é”ï¼Œçœ‹é…ç½®</span></span><br><span class="line">    putMessageLock.lock(); <span class="comment">//spin or ReentrantLock ,depending on store config</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">long</span> beginLockTimestamp = <span class="keyword">this</span>.defaultMessageStore.getSystemClock().now();</span><br><span class="line">        <span class="keyword">this</span>.beginTimeInLock = beginLockTimestamp;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Here settings are stored timestamp, in order to ensure an orderly</span></span><br><span class="line">        <span class="comment">// global</span></span><br><span class="line">        msg.setStoreTimestamp(beginLockTimestamp);</span><br><span class="line">        <span class="comment">// å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨æˆ–è€…æ–‡ä»¶å·²ç»å†™æ»¡ï¼Œæ–°å»ºä¸€ä¸ªmappedfile</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == mappedFile || mappedFile.isFull()) &#123;</span><br><span class="line">            mappedFile = <span class="keyword">this</span>.mappedFileQueue.getLastMappedFile(<span class="number">0</span>); <span class="comment">// Mark: NewFile may be cause noise</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ–‡ä»¶åˆ›å»ºå¤±è´¥ï¼Œåˆ™è¿”å›é”™è¯¯</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == mappedFile) &#123;</span><br><span class="line">            log.error(<span class="string">"create mapped file1 error, topic: "</span> + msg.getTopic() + <span class="string">" clientAddr: "</span> + msg.getBornHostString());</span><br><span class="line">            beginTimeInLock = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> PutMessageResult(PutMessageStatus.CREATE_MAPEDFILE_FAILED, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ¶ˆæ¯å†™å…¥æ–‡ä»¶ï¼Œæœ‰ä¸€ä¸ªå›è°ƒï¼Œå¾…ä¼šè¯´</span></span><br><span class="line">        result = mappedFile.appendMessage(msg, <span class="keyword">this</span>.appendMessageCallback);</span><br><span class="line">        <span class="keyword">switch</span> (result.getStatus()) &#123;</span><br><span class="line">            <span class="keyword">case</span> PUT_OK:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// å¦‚æœæ–‡ä»¶å·²æ»¡ï¼Œåˆ™æ–°å»ºä¸€ä¸ªæ–‡ä»¶ç»§ç»­</span></span><br><span class="line">            <span class="keyword">case</span> END_OF_FILE:</span><br><span class="line">                unlockMappedFile = mappedFile;</span><br><span class="line">                <span class="comment">// Create a new file, re-write the message</span></span><br><span class="line">                mappedFile = <span class="keyword">this</span>.mappedFileQueue.getLastMappedFile(<span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> == mappedFile) &#123;</span><br><span class="line">                    <span class="comment">// <span class="doctag">XXX:</span> warn and notify me</span></span><br><span class="line">                    log.error(<span class="string">"create mapped file2 error, topic: "</span> + msg.getTopic() + <span class="string">" clientAddr: "</span> + msg.getBornHostString());</span><br><span class="line">                    beginTimeInLock = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> PutMessageResult(PutMessageStatus.CREATE_MAPEDFILE_FAILED, result);</span><br><span class="line">                &#125;</span><br><span class="line">                result = mappedFile.appendMessage(msg, <span class="keyword">this</span>.appendMessageCallback);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MESSAGE_SIZE_EXCEEDED:</span><br><span class="line">            <span class="keyword">case</span> PROPERTIES_SIZE_EXCEEDED:</span><br><span class="line">                beginTimeInLock = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> PutMessageResult(PutMessageStatus.MESSAGE_ILLEGAL, result);</span><br><span class="line">            <span class="keyword">case</span> UNKNOWN_ERROR:</span><br><span class="line">                beginTimeInLock = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> PutMessageResult(PutMessageStatus.UNKNOWN_ERROR, result);</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                beginTimeInLock = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> PutMessageResult(PutMessageStatus.UNKNOWN_ERROR, result);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        eclipseTimeInLock = <span class="keyword">this</span>.defaultMessageStore.getSystemClock().now() - beginLockTimestamp;</span><br><span class="line">        beginTimeInLock = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// é‡Šæ”¾è·å–åˆ°çš„é”</span></span><br><span class="line">        putMessageLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å†™æ¶ˆæ¯æ—¶é—´è¿‡é•¿, è­¦å‘Š</span></span><br><span class="line">    <span class="keyword">if</span> (eclipseTimeInLock &gt; <span class="number">500</span>) &#123;</span><br><span class="line">        log.warn(<span class="string">"[NOTIFYME]putMessage in lock cost time(ms)=&#123;&#125;, bodyLength=&#123;&#125; AppendMessageResult=&#123;&#125;"</span>, eclipseTimeInLock, msg.getBody().length, result);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// unlockå·²ç»å†™æ»¡çš„æ–‡ä»¶ï¼Œé‡Šæ”¾å†…å­˜é”ï¼ˆç³»ç»Ÿé”ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> != unlockMappedFile &amp;&amp; <span class="keyword">this</span>.defaultMessageStore.getMessageStoreConfig().isWarmMapedFileEnable()) &#123;</span><br><span class="line">        <span class="keyword">this</span>.defaultMessageStore.unlockMappedFile(unlockMappedFile);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    PutMessageResult putMessageResult = <span class="keyword">new</span> PutMessageResult(PutMessageStatus.PUT_OK, result);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸€äº›ç»Ÿè®¡ä¿¡æ¯</span></span><br><span class="line">    storeStatsService.getSinglePutMessageTopicTimesTotal(msg.getTopic()).incrementAndGet();</span><br><span class="line">    storeStatsService.getSinglePutMessageTopicSizeTotal(topic).addAndGet(result.getWroteBytes());</span><br><span class="line">    <span class="comment">// flushæ•°æ®åˆ°ç£ç›˜ï¼Œåˆ†åŒæ­¥å’Œå¼‚æ­¥</span></span><br><span class="line">    handleDiskFlush(result, putMessageResult, msg);</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯SYNC_MASTERï¼Œåˆ™Masterä¿å­˜æ¶ˆæ¯åï¼Œéœ€è¦å°†æ¶ˆæ¯åŒæ­¥ç»™slaveåæ‰ä¼šè¿”å›ç»“æœ</span></span><br><span class="line">    <span class="comment">// å¦‚æœASYNC_MASTERï¼Œè¿™é‡Œä¸ä¼šåšä»»ä½•æ“ä½œï¼Œç”±HAServiceçš„åå°çº¿ç¨‹åšæ•°æ®åŒæ­¥</span></span><br><span class="line">    handleHA(result, putMessageResult, msg);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> putMessageResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬åœ¨ä¹‹å‰çš„æ•°æ®ç»“æ„å›¾ä¸­ä»¥åŠä¸Šé¢çš„ä»£ç ä¸­éƒ½çœ‹åˆ°äº†CommitLogæ˜¯å­˜å‚¨åœ¨MappedFileä¸­ï¼Œä¸‹é¢æˆ‘ä»¬å°±çœ‹çœ‹å†™å…¥æ¶ˆæ¯åˆ°MappedFileçš„å®ç°ï¼Œå¯¹åº”äº†<code>org.apache.rocketmq.store.MappedFile#appendMessage()</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> AppendMessageResult <span class="title">appendMessage</span><span class="params">(<span class="keyword">final</span> MessageExtBrokerInner msg, <span class="keyword">final</span> AppendMessageCallback cb)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> appendMessagesInner(msg, cb);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> AppendMessageResult <span class="title">appendMessagesInner</span><span class="params">(<span class="keyword">final</span> MessageExt messageExt, <span class="keyword">final</span> AppendMessageCallback cb)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">assert</span> messageExt != <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">assert</span> cb != <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰çš„write positionï¼Œç”¨äº†åŸå­è®¡æ•°å™¨AtomicInteger</span></span><br><span class="line">    <span class="keyword">int</span> currentPos = <span class="keyword">this</span>.wrotePosition.get();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (currentPos &lt; <span class="keyword">this</span>.fileSize) &#123;</span><br><span class="line">        <span class="comment">// è·å¾—NIOçš„BytBufferï¼Œä»writeBufferæˆ–è€…mappedByteBufferï¼Œè¿™é‡Œå°±åˆ©ç”¨äº†é›¶æ‹·è´</span></span><br><span class="line">        <span class="comment">// å¦‚æœæ˜¯writeBufferï¼Œå±äºå¼‚æ­¥</span></span><br><span class="line">        <span class="comment">// CommitLogå¯åŠ¨çš„æ—¶å€™åˆå§‹åŒ–ä¸€å—å†…å­˜æ± (é€šè¿‡ByteBufferç”³è¯·çš„å †å¤–å†…å­˜)</span></span><br><span class="line">        <span class="comment">// æ¶ˆæ¯æ•°æ®é¦–å…ˆå†™å…¥å†…å­˜æ± ä¸­ï¼Œç„¶ååå°æœ‰ä¸ªçº¿ç¨‹å®šæ—¶å°†å†…å­˜æ± ä¸­çš„æ•°æ®commitåˆ°FileChannelä¸­</span></span><br><span class="line">        <span class="comment">// å¦‚æœæ˜¯mappedByteBufferï¼Œå±äºåŒæ­¥</span></span><br><span class="line">        <span class="comment">// åœ¨å†™å…¥æ–‡ä»¶æ—¶ï¼Œä»FileChannelè·å–ç›´æ¥å†…å­˜æ˜ å°„ï¼Œæ”¶åˆ°æ¶ˆæ¯åï¼Œå°†æ•°æ®å†™å…¥åˆ°è¿™å—å†…å­˜ä¸­ï¼Œå†…å­˜å’Œç‰©ç†æ–‡ä»¶çš„æ•°æ®äº¤äº’ç”±æ“ä½œç³»ç»Ÿè´Ÿè´£</span></span><br><span class="line">        ByteBuffer byteBuffer = writeBuffer != <span class="keyword">null</span> ? writeBuffer.slice() : <span class="keyword">this</span>.mappedByteBuffer.slice();</span><br><span class="line">        byteBuffer.position(currentPos);</span><br><span class="line">        AppendMessageResult result = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (messageExt <span class="keyword">instanceof</span> MessageExtBrokerInner) &#123;</span><br><span class="line">            <span class="comment">// å†™å•æ¡æ¶ˆæ¯åˆ°byteBuffer</span></span><br><span class="line">            result = cb.doAppend(<span class="keyword">this</span>.getFileFromOffset(), byteBuffer, <span class="keyword">this</span>.fileSize - currentPos, (MessageExtBrokerInner) messageExt);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (messageExt <span class="keyword">instanceof</span> MessageExtBatch) &#123;</span><br><span class="line">            <span class="comment">// æ‰¹é‡æ¶ˆæ¯åˆ°byteBuffer</span></span><br><span class="line">            result = cb.doAppend(<span class="keyword">this</span>.getFileFromOffset(), byteBuffer, <span class="keyword">this</span>.fileSize - currentPos, (MessageExtBatch) messageExt);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> AppendMessageResult(AppendMessageStatus.UNKNOWN_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ›´æ–°write positionï¼Œåˆ°æœ€æ–°å€¼</span></span><br><span class="line">        <span class="keyword">this</span>.wrotePosition.addAndGet(result.getWroteBytes());</span><br><span class="line">        <span class="keyword">this</span>.storeTimestamp = result.getStoreTimestamp();</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    log.error(<span class="string">"MappedFile.appendMessage return null, wrotePosition: &#123;&#125; fileSize: &#123;&#125;"</span>, currentPos, <span class="keyword">this</span>.fileSize);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> AppendMessageResult(AppendMessageStatus.UNKNOWN_ERROR);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨å†™å…¥åˆ°MappedZFileçš„å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°æœ‰ä¸ªå›è°ƒå‡½æ•°ï¼Œå¥½åƒä¹Ÿä¸ç®—å›è°ƒğŸ¤£ï¼Œæˆ‘ä»¬è°ƒç”¨äº†è¿™ä¸ªå‡½æ•°çš„<code>#doAppend()</code>æ–¹æ³•ï¼Œæˆ‘ä»¬çœ‹çœ‹å®ƒåšäº†ä»€ä¹ˆï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> AppendMessageResult <span class="title">doAppend</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> fileFromOffset, <span class="keyword">final</span> ByteBuffer byteBuffer, <span class="keyword">final</span> <span class="keyword">int</span> maxBlank,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">final</span> MessageExtBrokerInner msgInner)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// STORETIMESTAMP + STOREHOSTADDRESS + OFFSET &lt;br&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// PHY OFFSET æ¶ˆæ¯åç§» æ–‡ä»¶çš„åçš„offset + bytebufferçš„ä½ç½®å°±æ˜¯è¦å†™çš„offset</span></span><br><span class="line">    <span class="keyword">long</span> wroteOffset = fileFromOffset + byteBuffer.position();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.resetByteBuffer(hostHolder, <span class="number">8</span>);</span><br><span class="line">    <span class="comment">// ç”Ÿæˆmessage ID, å‰8ä½æ˜¯hostï¼Œå8ä½æ˜¯wroteOffset,ç›®çš„æ˜¯ä¾¿äºä½¿ç”¨msgIDæ¥æŸ¥æ‰¾æ¶ˆæ¯</span></span><br><span class="line">    String msgId = MessageDecoder.createMessageId(<span class="keyword">this</span>.msgIdMemory, msgInner.getStoreHostBytes(hostHolder), wroteOffset);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Record ConsumeQueue information</span></span><br><span class="line">    keyBuilder.setLength(<span class="number">0</span>);</span><br><span class="line">    keyBuilder.append(msgInner.getTopic());</span><br><span class="line">    keyBuilder.append(<span class="string">'-'</span>);</span><br><span class="line">    keyBuilder.append(msgInner.getQueueId());</span><br><span class="line">    String key = keyBuilder.toString();</span><br><span class="line">    <span class="comment">// å–å¾—å…·ä½“Queueçš„offsetï¼Œå€¼æ˜¯å½“å‰æ˜¯Queueé‡Œçš„ç¬¬å‡ æ¡æ¶ˆæ¯</span></span><br><span class="line">    Long queueOffset = CommitLog.<span class="keyword">this</span>.topicQueueTable.get(key);</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯è¿™ä¸ªqueueçš„ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼Œéœ€è¦åˆå§‹åŒ–queueOffset</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == queueOffset) &#123;</span><br><span class="line">        queueOffset = <span class="number">0L</span>;</span><br><span class="line">        CommitLog.<span class="keyword">this</span>.topicQueueTable.put(key, queueOffset);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// äº‹åŠ¡æ¶ˆæ¯éœ€è¦ç‰¹åˆ«çš„å¤„ç†ï¼Œç•¥è¿‡</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> tranType = MessageSysFlag.getTransactionValue(msgInner.getSysFlag());</span><br><span class="line">    <span class="keyword">switch</span> (tranType) &#123;</span><br><span class="line">        <span class="comment">// Prepared and Rollback message is not consumed, will not enter the</span></span><br><span class="line">        <span class="comment">// consumer queuec</span></span><br><span class="line">        <span class="keyword">case</span> MessageSysFlag.TRANSACTION_PREPARED_TYPE:</span><br><span class="line">        <span class="keyword">case</span> MessageSysFlag.TRANSACTION_ROLLBACK_TYPE:</span><br><span class="line">            queueOffset = <span class="number">0L</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MessageSysFlag.TRANSACTION_NOT_TYPE:</span><br><span class="line">        <span class="keyword">case</span> MessageSysFlag.TRANSACTION_COMMIT_TYPE:</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åºåˆ—åŒ–æ¶ˆæ¯</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">byte</span>[] propertiesData =</span><br><span class="line">        msgInner.getPropertiesString() == <span class="keyword">null</span> ? <span class="keyword">null</span> : msgInner.getPropertiesString().getBytes(MessageDecoder.CHARSET_UTF8);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> propertiesLength = propertiesData == <span class="keyword">null</span> ? <span class="number">0</span> : propertiesData.length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (propertiesLength &gt; Short.MAX_VALUE) &#123;</span><br><span class="line">        log.warn(<span class="string">"putMessage message properties length too long. length=&#123;&#125;"</span>, propertiesData.length);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AppendMessageResult(AppendMessageStatus.PROPERTIES_SIZE_EXCEEDED);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">byte</span>[] topicData = msgInner.getTopic().getBytes(MessageDecoder.CHARSET_UTF8);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> topicLength = topicData.length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> bodyLength = msgInner.getBody() == <span class="keyword">null</span> ? <span class="number">0</span> : msgInner.getBody().length;</span><br><span class="line">    <span class="comment">// è®¡ç®—æœºåºåˆ—åŒ–æ¶ˆæ¯çš„é•¿åº¦</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> msgLen = calMsgLength(bodyLength, topicLength, propertiesLength);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Exceeds the maximum message</span></span><br><span class="line">    <span class="keyword">if</span> (msgLen &gt; <span class="keyword">this</span>.maxMessageSize) &#123;</span><br><span class="line">        CommitLog.log.warn(<span class="string">"message size exceeded, msg total size: "</span> + msgLen + <span class="string">", msg body size: "</span> + bodyLength</span><br><span class="line">            + <span class="string">", maxMessageSize: "</span> + <span class="keyword">this</span>.maxMessageSize);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AppendMessageResult(AppendMessageStatus.MESSAGE_SIZE_EXCEEDED);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœç©ºé—´ä¸è¶³ï¼Œmagic codeè®¾ç½®æˆ-626843481,ç„¶åå‰©ä½™å­—èŠ‚éšæœºï¼Œä¿è¯æ‰€æœ‰æ–‡ä»¶å¤§å°éƒ½æ˜¯FileSize</span></span><br><span class="line">    <span class="keyword">if</span> ((msgLen + END_FILE_MIN_BLANK_LENGTH) &gt; maxBlank) &#123;</span><br><span class="line">        <span class="keyword">this</span>.resetByteBuffer(<span class="keyword">this</span>.msgStoreItemMemory, maxBlank);</span><br><span class="line">        <span class="comment">// 1 TOTALSIZE</span></span><br><span class="line">        <span class="keyword">this</span>.msgStoreItemMemory.putInt(maxBlank);</span><br><span class="line">        <span class="comment">// 2 MAGICCODE</span></span><br><span class="line">        <span class="keyword">this</span>.msgStoreItemMemory.putInt(CommitLog.BLANK_MAGIC_CODE);</span><br><span class="line">        <span class="comment">// 3 The remaining space may be any value</span></span><br><span class="line">        <span class="comment">// Here the length of the specially set maxBlank</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> beginTimeMills = CommitLog.<span class="keyword">this</span>.defaultMessageStore.now();</span><br><span class="line">        byteBuffer.put(<span class="keyword">this</span>.msgStoreItemMemory.array(), <span class="number">0</span>, maxBlank);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AppendMessageResult(AppendMessageStatus.END_OF_FILE, wroteOffset, maxBlank, msgId, msgInner.getStoreTimestamp(),</span><br><span class="line">            queueOffset, CommitLog.<span class="keyword">this</span>.defaultMessageStore.now() - beginTimeMills);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>çœ‹åˆ°è¿™é‡Œï¼ŒCommitLogå°±å·²ç»è¢«å­˜å…¥åˆ°ByteBufé‡Œå•¦ï¼Œç­‰å¾…è¢«flushåˆ°æ–‡ä»¶é‡Œï¼ï¼ï¼ï¼</p>
<h1 id="ConsumeQueue"><a href="#ConsumeQueue" class="headerlink" title="ConsumeQueue"></a>ConsumeQueue</h1><p>ä¸Šé¢æˆ‘ä»¬çœ‹åˆ°æ¶ˆæ¯è¢«æ”¾åˆ°äº†CommitLogä¸­ï¼Œä½†æ˜¯consumeråœ¨æ¶ˆè´¹æ¶ˆæ¯çš„æ—¶å€™æ˜¯æŒ‰ç…§topic+queueçš„ç»´åº¦æ¥æ‹‰å–æ¶ˆæ¯çš„ã€‚ä¸ºäº†æ–¹ä¾¿è¯»å–ï¼Œ<code>MessageStore</code>å°†<code>CommitLog</code>ä¸­æ¶ˆæ¯çš„offsetæŒ‰ç…§topic+queueIdåˆ’åˆ†åï¼Œå­˜å‚¨åˆ°ä¸åŒçš„æ–‡ä»¶ä¸­ï¼Œè¿™å°±æ˜¯<code>ConsumeQueue</code>ã€‚</p>
<p>åœ¨ä¸Šé¢MessageStoreå¯åŠ¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬çœ‹åˆ°ä»–ä¼šå¯åŠ¨ä¸€ä¸ªæœåŠ¡<code>ReputMessageService</code>å°†CommitLogä¸­çš„æ¶ˆæ¯æŒ‰ç…§topic+queueIdåˆ’åˆ†åï¼Œå­˜å‚¨åˆ°ä¸åŒçš„ConsumerQueueä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿä»<code>org.apache.rocketmq.store.DefaultMessageStore.ReputMessageService</code>å¼€å§‹çœ‹ï¼Œæ—¢ç„¶æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰€ä»¥æˆ‘ä»¬é¦–å…ˆä¼šæ‰¾åˆ°ä»–çš„runæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DefaultMessageStore.log.info(<span class="keyword">this</span>.getServiceName() + <span class="string">" service started"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (!<span class="keyword">this</span>.isStopped()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1</span>);</span><br><span class="line">                <span class="keyword">this</span>.doReput();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                DefaultMessageStore.log.warn(<span class="keyword">this</span>.getServiceName() + <span class="string">" service has exception. "</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        DefaultMessageStore.log.info(<span class="keyword">this</span>.getServiceName() + <span class="string">" service end"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°ä¸»è¦åœ¨æ‰§è¡ŒdoReputæ–¹æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doReput</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­commitLogçš„maxOffsetæ˜¯å¦æ¯”ä¸Šæ¬¡è¯»å–çš„offsetå¤§ï¼Œå¤§å°±ä»£è¡¨äº†æœ‰æ–°çš„æ¶ˆæ¯</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">boolean</span> doNext = <span class="keyword">true</span>; <span class="keyword">this</span>.isCommitLogAvailable() &amp;&amp; doNext; ) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DefaultMessageStore.<span class="keyword">this</span>.getMessageStoreConfig().isDuplicationEnable()</span><br><span class="line">                &amp;&amp; <span class="keyword">this</span>.reputFromOffset &gt;= DefaultMessageStore.<span class="keyword">this</span>.getConfirmOffset()) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ä»ä¸Šæ¬¡çš„ç»“æŸoffsetå¼€å§‹è¯»å–commitLogæ–‡ä»¶ä¸­çš„æ¶ˆæ¯</span></span><br><span class="line">            SelectMappedBufferResult result = DefaultMessageStore.<span class="keyword">this</span>.commitLog.getData(reputFromOffset);</span><br><span class="line">            <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">this</span>.reputFromOffset = result.getStartOffset();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> readSize = <span class="number">0</span>; readSize &lt; result.getSize() &amp;&amp; doNext; ) &#123;</span><br><span class="line">                        <span class="comment">// æ£€æŸ¥messageæ•°æ®å®Œæ•´æ€§å¹¶å°è£…æˆDispatchRequest</span></span><br><span class="line">                        DispatchRequest dispatchRequest =</span><br><span class="line">                            DefaultMessageStore.<span class="keyword">this</span>.commitLog.checkMessageAndReturnSize(result.getByteBuffer(), <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">                        <span class="keyword">int</span> size = dispatchRequest.getMsgSize();</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (dispatchRequest.isSuccess()) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                <span class="comment">// åˆ†å‘æ¶ˆæ¯åˆ°CommitLogDispatcher</span></span><br><span class="line">                                DefaultMessageStore.<span class="keyword">this</span>.doDispatch(dispatchRequest);</span><br><span class="line">                                <span class="comment">// å½“Brokerä¸ºMasterçš„æ—¶å€™ï¼Œåˆ†å‘æ¶ˆæ¯åˆ°MessageArrivingListener,å”¤é†’ç­‰å¾…çš„PullReqeustæ¥æ”¶æ¶ˆæ¯</span></span><br><span class="line">                                <span class="keyword">if</span> (BrokerRole.SLAVE != DefaultMessageStore.<span class="keyword">this</span>.getMessageStoreConfig().getBrokerRole()</span><br><span class="line">                                    &amp;&amp; DefaultMessageStore.<span class="keyword">this</span>.brokerConfig.isLongPollingEnable()) &#123;</span><br><span class="line">                                    DefaultMessageStore.<span class="keyword">this</span>.messageArrivingListener.arriving(dispatchRequest.getTopic(),</span><br><span class="line">                                        dispatchRequest.getQueueId(), dispatchRequest.getConsumeQueueOffset() + <span class="number">1</span>,</span><br><span class="line">                                        dispatchRequest.getTagsCode(), dispatchRequest.getStoreTimestamp(),</span><br><span class="line">                                        dispatchRequest.getBitMap(), dispatchRequest.getPropertiesMap());</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="comment">// æ›´æ–°æœ€æ–°reputçš„offset</span></span><br><span class="line">                                <span class="keyword">this</span>.reputFromOffset += size;</span><br><span class="line">                                readSize += size;</span><br><span class="line">                                <span class="keyword">if</span> (DefaultMessageStore.<span class="keyword">this</span>.getMessageStoreConfig().getBrokerRole() == BrokerRole.SLAVE) &#123;</span><br><span class="line">                                    DefaultMessageStore.<span class="keyword">this</span>.storeStatsService</span><br><span class="line">                                        .getSinglePutMessageTopicTimesTotal(dispatchRequest.getTopic()).incrementAndGet();</span><br><span class="line">                                    DefaultMessageStore.<span class="keyword">this</span>.storeStatsService</span><br><span class="line">                                        .getSinglePutMessageTopicSizeTotal(dispatchRequest.getTopic())</span><br><span class="line">                                        .addAndGet(dispatchRequest.getMsgSize());</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (size == <span class="number">0</span>) &#123;</span><br><span class="line">                                <span class="comment">// å¦‚æœè¯»åˆ°æ–‡ä»¶ç»“å°¾ï¼Œåˆ™åˆ‡æ¢åˆ°æ–°æ–‡ä»¶</span></span><br><span class="line">                                <span class="keyword">this</span>.reputFromOffset = DefaultMessageStore.<span class="keyword">this</span>.commitLog.rollNextFile(<span class="keyword">this</span>.reputFromOffset);</span><br><span class="line">                                readSize = result.getSize();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!dispatchRequest.isSuccess()) &#123;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                log.error(<span class="string">"[BUG]read total count not equals msg total size. reputFromOffset=&#123;&#125;"</span>, reputFromOffset);</span><br><span class="line">                                <span class="keyword">this</span>.reputFromOffset += size;</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                doNext = <span class="keyword">false</span>;</span><br><span class="line">                                <span class="keyword">if</span> (DefaultMessageStore.<span class="keyword">this</span>.brokerConfig.getBrokerId() == MixAll.MASTER_ID) &#123;</span><br><span class="line">                                    log.error(<span class="string">"[BUG]the master dispatch message to consume queue error, COMMITLOG OFFSET: &#123;&#125;"</span>,</span><br><span class="line">                                        <span class="keyword">this</span>.reputFromOffset);</span><br><span class="line"></span><br><span class="line">                                    <span class="keyword">this</span>.reputFromOffset += result.getSize() - readSize;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">// é‡Šæ”¾bytebuffï¼Œé¿å…å†…å­˜æ³„æ¼</span></span><br><span class="line">                    result.release();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                doNext = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢æˆ‘ä»¬çœ‹åˆ°äº†æ¶ˆæ¯è¢«åˆ†å‘åˆ°äº†CommitLogDispatcherï¼Œè¿™ä¸ªæ˜¯å•¥ï¼Ÿæ‰¾åˆ°<code>DefaultMessageStore#doDispatch()</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doDispatch</span><span class="params">(DispatchRequest req)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">for</span> (CommitLogDispatcher dispatcher : <span class="keyword">this</span>.dispatcherList) &#123;</span><br><span class="line">          dispatcher.dispatch(req);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> LinkedList&lt;CommitLogDispatcher&gt; dispatcherList;</span><br></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢çœ‹åˆ°æ˜¯DefaultMessageStoreçš„é›†åˆæˆå‘˜å˜é‡ï¼Œé‚£ä¹ˆè¿™ä¸ªé›†åˆæ˜¯ä»€ä¹ˆæ—¶å€™ç”Ÿæˆçš„å‘¢ï¼Ÿ</p>
<p>æˆ‘ä»¬åœ¨æ„é€ DefaultMessageStoreä¼šå¾€é‡Œé¢æ·»åŠ ä¸¤ä¸ªCommitLogDispatcherï¼Œæˆ‘ä»¬å®šä½åˆ°DefaultMessageStoreçš„æ„é€ å‡½æ•°ï¼Œçœç•¥æ— å…³ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.dispatcherList = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line"><span class="comment">// consumeQueueæ„å»ºDispatcher</span></span><br><span class="line"><span class="keyword">this</span>.dispatcherList.addLast(<span class="keyword">new</span> CommitLogDispatcherBuildConsumeQueue());</span><br><span class="line"><span class="comment">// IndexFileæ„å»ºDispatcher</span></span><br><span class="line"><span class="keyword">this</span>.dispatcherList.addLast(<span class="keyword">new</span> CommitLogDispatcherBuildIndex());</span><br></pre></td></tr></table></figure>
<p>ä¸çŸ¥é“å¤§å®¶è¿˜æœ‰æ²¡æœ‰å°è±¡ï¼Œå…¶å®åœ¨è¯´<a href="[http://todorex.com/2019/06/19/RocketMQ%E6%BA%90%E7%A0%81/RocketMQ%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E2%80%94%E2%80%94Broker%E5%90%AF%E5%8A%A8/](http://todorex.com/2019/06/19/RocketMQæºç /RocketMQæºç åˆ†æâ€”â€”Brokerå¯åŠ¨/">Brokeråˆå§‹åŒ–</a>)çš„æ—¶å€™ä¹Ÿæåˆ°è¿‡ã€‚æˆ‘ä»¬çœç•¥ä¸‹æ— å…³ä»£ç ï¼Œå†çœ‹ä¸€éï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">initialize</span><span class="params">()</span> <span class="keyword">throws</span> CloneNotSupportedException </span>&#123;</span><br><span class="line"> 		<span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (result) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// æ¶ˆæ¯å­˜å–çš„æ ¸å¿ƒæ¥å£åˆå§‹åŒ–</span></span><br><span class="line">            <span class="keyword">this</span>.messageStore =</span><br><span class="line">                <span class="keyword">new</span> DefaultMessageStore(<span class="keyword">this</span>.messageStoreConfig, <span class="keyword">this</span>.brokerStatsManager, <span class="keyword">this</span>.messageArrivingListener,</span><br><span class="line">                    <span class="keyword">this</span>.brokerConfig);</span><br><span class="line">            <span class="comment">// æ·»åŠ æ¶ˆæ¯åˆ†å‘å™¨ï¼Œåˆ†å‘åˆ°å¸ƒéš†è¿‡æ»¤å™¨</span></span><br><span class="line">            <span class="keyword">this</span>.messageStore.getDispatcherList().addFirst(<span class="keyword">new</span> CommitLogDispatcherCalcBitMap(<span class="keyword">this</span>.brokerConfig, <span class="keyword">this</span>.consumerFilterManager));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            result = <span class="keyword">false</span>;</span><br><span class="line">            log.error(<span class="string">"Failed to initialize"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæˆ‘ä»¬åªåˆ†æ<code>org.apache.rocketmq.store.DefaultMessageStore.CommitLogDispatcherBuildConsumeQueue</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">CommitLogDispatcherBuildConsumeQueue</span> <span class="keyword">implements</span> <span class="title">CommitLogDispatcher</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatch</span><span class="params">(DispatchRequest request)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">final</span> <span class="keyword">int</span> tranType = MessageSysFlag.getTransactionValue(request.getSysFlag());</span><br><span class="line">          <span class="keyword">switch</span> (tranType) &#123;</span><br><span class="line">              <span class="comment">// éäº‹åŠ¡æ¶ˆæ¯</span></span><br><span class="line">              <span class="keyword">case</span> MessageSysFlag.TRANSACTION_NOT_TYPE:</span><br><span class="line">              <span class="keyword">case</span> MessageSysFlag.TRANSACTION_COMMIT_TYPE:</span><br><span class="line">                  <span class="comment">// æ”¾ä½ç½®offsetä¿¡æ¯</span></span><br><span class="line">                  DefaultMessageStore.<span class="keyword">this</span>.putMessagePositionInfo(request);</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">              <span class="keyword">case</span> MessageSysFlag.TRANSACTION_PREPARED_TYPE:</span><br><span class="line">              <span class="keyword">case</span> MessageSysFlag.TRANSACTION_ROLLBACK_TYPE:</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">	</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putMessagePositionInfo</span><span class="params">(DispatchRequest dispatchRequest)</span> </span>&#123;</span><br><span class="line">      <span class="comment">// æ‰¾åˆ°å¯¹åº”çš„ConsumeQueueï¼Œæ²¡æœ‰å°±åˆ›å»ºä¸€ä¸ªæ–°çš„MappedFileæ–‡ä»¶</span></span><br><span class="line">      ConsumeQueue cq = <span class="keyword">this</span>.findConsumeQueue(dispatchRequest.getTopic(), dispatchRequest.getQueueId());</span><br><span class="line">      cq.putMessagePositionInfoWrapper(dispatchRequest);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// org.apache.rocketmq.store.ConsumeQueue</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putMessagePositionInfoWrapper</span><span class="params">(DispatchRequest request)</span> </span>&#123;</span><br><span class="line">      <span class="comment">// å†™å…¥é‡è¯•æ¬¡æ•°ï¼Œæœ€å¤š30æ¬¡</span></span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">int</span> maxRetries = <span class="number">30</span>;</span><br><span class="line">      <span class="comment">// åˆ¤æ–­CQæ˜¯å¦æ˜¯å¯å†™çš„</span></span><br><span class="line">      <span class="keyword">boolean</span> canWrite = <span class="keyword">this</span>.defaultMessageStore.getRunningFlags().isCQWriteable();</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; maxRetries &amp;&amp; canWrite; i++) &#123;</span><br><span class="line">          <span class="comment">// æ‹¿åˆ°æ¶ˆæ¯çš„Tag</span></span><br><span class="line">          <span class="keyword">long</span> tagsCode = request.getTagsCode();</span><br><span class="line">          <span class="keyword">if</span> (isExtWriteEnable()) &#123;</span><br><span class="line">              <span class="comment">// å¦‚æœéœ€è¦å†™extæ–‡ä»¶ï¼Œåˆ™å°†æ¶ˆæ¯çš„tagsCodeå†™å…¥ï¼Œç”¨äºæ¶ˆæ¯è¿‡æ»¤ï¼Œåé¢æœ‰æœºä¼šå†è¯´</span></span><br><span class="line">              ConsumeQueueExt.CqExtUnit cqExtUnit = <span class="keyword">new</span> ConsumeQueueExt.CqExtUnit();</span><br><span class="line">              cqExtUnit.setFilterBitMap(request.getBitMap());</span><br><span class="line">              cqExtUnit.setMsgStoreTime(request.getStoreTimestamp());</span><br><span class="line">              cqExtUnit.setTagsCode(request.getTagsCode());</span><br><span class="line"></span><br><span class="line">              <span class="keyword">long</span> extAddr = <span class="keyword">this</span>.consumeQueueExt.put(cqExtUnit);</span><br><span class="line">              <span class="keyword">if</span> (isExtAddr(extAddr)) &#123;</span><br><span class="line">                  tagsCode = extAddr;</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  log.warn(<span class="string">"Save consume queue extend fail, So just save tagsCode! &#123;&#125;, topic:&#123;&#125;, queueId:&#123;&#125;, offset:&#123;&#125;"</span>, cqExtUnit,</span><br><span class="line">                      topic, queueId, request.getCommitLogOffset());</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// å†™å…¥CQæ–‡ä»¶</span></span><br><span class="line">          <span class="keyword">boolean</span> result = <span class="keyword">this</span>.putMessagePositionInfo(request.getCommitLogOffset(),</span><br><span class="line">              request.getMsgSize(), tagsCode, request.getConsumeQueueOffset());</span><br><span class="line">          <span class="keyword">if</span> (result) &#123;</span><br><span class="line">              <span class="keyword">this</span>.defaultMessageStore.getStoreCheckpoint().setLogicsMsgTimestamp(request.getStoreTimestamp());</span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="comment">// <span class="doctag">XXX:</span> warn and notify me</span></span><br><span class="line">              log.warn(<span class="string">"[BUG]put commit log position info to "</span> + topic + <span class="string">":"</span> + queueId + <span class="string">" "</span> + request.getCommitLogOffset()</span><br><span class="line">                  + <span class="string">" failed, retry "</span> + i + <span class="string">" times"</span>);</span><br><span class="line"></span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">                  Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">              &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                  log.warn(<span class="string">""</span>, e);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// <span class="doctag">XXX:</span> warn and notify me</span></span><br><span class="line">      log.error(<span class="string">"[BUG]consume queue can not write, &#123;&#125; &#123;&#125;"</span>, <span class="keyword">this</span>.topic, <span class="keyword">this</span>.queueId);</span><br><span class="line">      <span class="keyword">this</span>.defaultMessageStore.getRunningFlags().makeLogicsQueueError();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">putMessagePositionInfo</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> offset, <span class="keyword">final</span> <span class="keyword">int</span> size, <span class="keyword">final</span> <span class="keyword">long</span> tagsCode,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">final</span> <span class="keyword">long</span> cqOffset)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (offset &lt;= <span class="keyword">this</span>.maxPhysicOffset) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// ç»“æ„å¯ä»¥å‚è€ƒæ•°æ®ç»“æ„ä¸­å›¾</span></span><br><span class="line">      <span class="keyword">this</span>.byteBufferIndex.flip();</span><br><span class="line">      <span class="comment">// ä¸€ä¸ªCQUnitçš„å¤§å°æ˜¯å›ºå®šçš„20å­—èŠ‚</span></span><br><span class="line">      <span class="keyword">this</span>.byteBufferIndex.limit(CQ_STORE_UNIT_SIZE);</span><br><span class="line">      <span class="keyword">this</span>.byteBufferIndex.putLong(offset);</span><br><span class="line">      <span class="keyword">this</span>.byteBufferIndex.putInt(size);</span><br><span class="line">      <span class="keyword">this</span>.byteBufferIndex.putLong(tagsCode);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">long</span> expectLogicOffset = cqOffset * CQ_STORE_UNIT_SIZE;</span><br><span class="line">      <span class="comment">// è·å–æœ€åä¸€ä¸ªMappedFile, æ²¡æœ‰å°±åˆ›å»º</span></span><br><span class="line">      MappedFile mappedFile = <span class="keyword">this</span>.mappedFileQueue.getLastMappedFile(expectLogicOffset);</span><br><span class="line">      <span class="keyword">if</span> (mappedFile != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (mappedFile.isFirstCreateInQueue() &amp;&amp; cqOffset != <span class="number">0</span> &amp;&amp; mappedFile.getWrotePosition() == <span class="number">0</span>) &#123;</span><br><span class="line">              <span class="keyword">this</span>.minLogicOffset = expectLogicOffset;</span><br><span class="line">              <span class="keyword">this</span>.mappedFileQueue.setFlushedWhere(expectLogicOffset);</span><br><span class="line">              <span class="keyword">this</span>.mappedFileQueue.setCommittedWhere(expectLogicOffset);</span><br><span class="line">              <span class="keyword">this</span>.fillPreBlank(mappedFile, expectLogicOffset);</span><br><span class="line">              log.info(<span class="string">"fill pre blank space "</span> + mappedFile.getFileName() + <span class="string">" "</span> + expectLogicOffset + <span class="string">" "</span></span><br><span class="line">                  + mappedFile.getWrotePosition());</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (cqOffset != <span class="number">0</span>) &#123;</span><br><span class="line">              <span class="keyword">long</span> currentLogicOffset = mappedFile.getWrotePosition() + mappedFile.getFileFromOffset();</span><br><span class="line">				<span class="comment">// ...</span></span><br><span class="line">          <span class="keyword">this</span>.maxPhysicOffset = offset;</span><br><span class="line">          <span class="comment">// CQUnitå†™å…¥æ–‡ä»¶ä¸­, ä½¿ç”¨filechannelå†™,åŒæ­¥å†™</span></span><br><span class="line">          <span class="keyword">return</span> mappedFile.appendMessage(<span class="keyword">this</span>.byteBufferIndex.array());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>çœ‹åˆ°è¿™é‡Œï¼ŒConsumeQueueå°±è¢«å†™å…¥åˆ°æ–‡ä»¶ä¸­äº†ï¼ï¼ï¼ï¼</p>
<h1 id="IndexFile"><a href="#IndexFile" class="headerlink" title="IndexFile"></a>IndexFile</h1><p><code>MessageStore</code>ä¸­å­˜å‚¨çš„æ¶ˆæ¯é™¤äº†é€šè¿‡<code>ConsumeQueue</code>æä¾›ç»™consumeræ¶ˆè´¹ä¹‹å¤–ï¼Œè¿˜æ”¯æŒé€šè¿‡MessageIDæˆ–è€…MessageKeyæ¥æŸ¥è¯¢æ¶ˆæ¯ã€‚ä½¿ç”¨IDæŸ¥è¯¢æ—¶ï¼Œå› ä¸ºIDå°±æ˜¯ç”¨broker+offsetç”Ÿæˆçš„ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“å°±æ‰¾åˆ°å¯¹åº”çš„<code>commitLog</code>æ–‡ä»¶æ¥è¯»å–æ¶ˆæ¯ã€‚å¯¹äºç”¨MessageKeyæ¥æŸ¥è¯¢æ¶ˆæ¯ï¼Œ<code>MessageStore</code>é€šè¿‡æ„å»ºä¸€ä¸ªindexæ¥æé«˜è¯»å–é€Ÿåº¦ã€‚</p>
<p>åœ¨ä¸Šé¢çš„CommitLogDispatcheré“¾è¡¨ä¸­ï¼Œæˆ‘ä»¬è¿˜çœ‹åˆ°ä¸€ä¸ªCommitLogDispatcherâ€”â€”<code>CommitLogDispatcherBuildIndex</code></p>
<p>ä»–å°±æ˜¯ç”¨æ¥åˆ›å»ºIndexFileçš„ï¼Œæˆ‘ä»¬ä¹Ÿå°†ä»é‚£é‡Œå…¥æ‰‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">CommitLogDispatcherBuildIndex</span> <span class="keyword">implements</span> <span class="title">CommitLogDispatcher</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatch</span><span class="params">(DispatchRequest request)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (DefaultMessageStore.<span class="keyword">this</span>.messageStoreConfig.isMessageIndexEnable()) &#123;</span><br><span class="line">              DefaultMessageStore.<span class="keyword">this</span>.indexService.buildIndex(request);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// org.apache.rocketmq.store.index.IndexService</span></span><br><span class="line"><span class="comment">// å†™å…¥indexFile</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buildIndex</span><span class="params">(DispatchRequest req)</span> </span>&#123;</span><br><span class="line">      <span class="comment">// è·å–æˆ–è€…æ–°å»ºå½“å‰å¯å†™å…¥çš„index file, é»˜è®¤é‡è¯•3æ¬¡</span></span><br><span class="line">      IndexFile indexFile = retryGetAndCreateIndexFile();</span><br><span class="line">      <span class="keyword">if</span> (indexFile != <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="comment">// è·å–å½“å‰indexFileä¸­è®°å½•çš„æœ€å¤§offset</span></span><br><span class="line">          <span class="keyword">long</span> endPhyOffset = indexFile.getEndPhyOffset();</span><br><span class="line">          DispatchRequest msg = req;</span><br><span class="line">          String topic = msg.getTopic();</span><br><span class="line">          String keys = msg.getKeys();</span><br><span class="line">          <span class="keyword">if</span> (msg.getCommitLogOffset() &lt; endPhyOffset) &#123;</span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// è¿‡æ»¤å›æ»šæ¶ˆæ¯</span></span><br><span class="line">          <span class="keyword">final</span> <span class="keyword">int</span> tranType = MessageSysFlag.getTransactionValue(msg.getSysFlag());</span><br><span class="line">          <span class="keyword">switch</span> (tranType) &#123;</span><br><span class="line">              <span class="keyword">case</span> MessageSysFlag.TRANSACTION_NOT_TYPE:</span><br><span class="line">              <span class="keyword">case</span> MessageSysFlag.TRANSACTION_PREPARED_TYPE:</span><br><span class="line">              <span class="keyword">case</span> MessageSysFlag.TRANSACTION_COMMIT_TYPE:</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">              <span class="keyword">case</span> MessageSysFlag.TRANSACTION_ROLLBACK_TYPE:</span><br><span class="line">                  <span class="keyword">return</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// å•æ¡æ¶ˆæ¯</span></span><br><span class="line">          <span class="keyword">if</span> (req.getUniqKey() != <span class="keyword">null</span>) &#123;</span><br><span class="line">              <span class="comment">// å†™å…¥index</span></span><br><span class="line">              indexFile = putKey(indexFile, msg, buildKey(topic, req.getUniqKey()));</span><br><span class="line">              <span class="keyword">if</span> (indexFile == <span class="keyword">null</span>) &#123;</span><br><span class="line">                  log.error(<span class="string">"putKey error commitlog &#123;&#125; uniqkey &#123;&#125;"</span>, req.getCommitLogOffset(), req.getUniqKey());</span><br><span class="line">                  <span class="keyword">return</span>;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// å¤šæ¡æ¶ˆæ¯ï¼Œå¾ªç¯å†™å…¥index</span></span><br><span class="line">          <span class="keyword">if</span> (keys != <span class="keyword">null</span> &amp;&amp; keys.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">              String[] keyset = keys.split(MessageConst.KEY_SEPARATOR);</span><br><span class="line">              <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; keyset.length; i++) &#123;</span><br><span class="line">                  String key = keyset[i];</span><br><span class="line">                  <span class="keyword">if</span> (key.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                      indexFile = putKey(indexFile, msg, buildKey(topic, key));</span><br><span class="line">                      <span class="keyword">if</span> (indexFile == <span class="keyword">null</span>) &#123;</span><br><span class="line">                          log.error(<span class="string">"putKey error commitlog &#123;&#125; uniqkey &#123;&#125;"</span>, req.getCommitLogOffset(), req.getUniqKey());</span><br><span class="line">                          <span class="keyword">return</span>;</span><br><span class="line">                      &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          log.error(<span class="string">"build index error, stop building index"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// æ¥ç€çœ‹å¦‚ä½•å°†MessageKeyå†™å…¥IndexFile</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> IndexFile <span class="title">putKey</span><span class="params">(IndexFile indexFile, DispatchRequest msg, String idxKey)</span> </span>&#123;</span><br><span class="line">      <span class="comment">// é‡è¯•å†™å…¥</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">boolean</span> ok = indexFile.putKey(idxKey, msg.getCommitLogOffset(), msg.getStoreTimestamp()); !ok; ) &#123;</span><br><span class="line">          log.warn(<span class="string">"Index file ["</span> + indexFile.getFileName() + <span class="string">"] is full, trying to create another one"</span>);</span><br><span class="line"></span><br><span class="line">          indexFile = retryGetAndCreateIndexFile();</span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">null</span> == indexFile) &#123;</span><br><span class="line">              <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          ok = indexFile.putKey(idxKey, msg.getCommitLogOffset(), msg.getStoreTimestamp());</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> indexFile;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// org.apache.rocketmq.store.index.IndexFile</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">putKey</span><span class="params">(<span class="keyword">final</span> String key, <span class="keyword">final</span> <span class="keyword">long</span> phyOffset, <span class="keyword">final</span> <span class="keyword">long</span> storeTimestamp)</span> </span>&#123;</span><br><span class="line">      <span class="comment">// åˆ¤æ–­indexFileæ˜¯å¦å·²æ»¡ï¼Œå·²æ»¡è¿”å›å¤±è´¥</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.indexHeader.getIndexCount() &lt; <span class="keyword">this</span>.indexNum) &#123;</span><br><span class="line">          <span class="comment">// è®¡ç®—keyçš„hashCode(éè´Ÿ)ï¼Œè°ƒç”¨çš„java Stringçš„hashcodeæ–¹æ³•</span></span><br><span class="line">          <span class="keyword">int</span> keyHash = indexKeyHashMethod(key);</span><br><span class="line">          <span class="comment">// è®¡ç®—slotä½ç½®ï¼ˆç¬¬å‡ ä¸ªï¼‰</span></span><br><span class="line">          <span class="keyword">int</span> slotPos = keyHash % <span class="keyword">this</span>.hashSlotNum;</span><br><span class="line">          <span class="comment">// è®¡ç®—slotçš„æ•°æ®å­˜å‚¨ä½ç½®</span></span><br><span class="line">          <span class="keyword">int</span> absSlotPos = IndexHeader.INDEX_HEADER_SIZE + slotPos * hashSlotSize;</span><br><span class="line"></span><br><span class="line">          FileLock fileLock = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="comment">// ä¹‹å‰è¯´è¿‡slot+indexç±»ä¼¼ä¸€ä¸ªhashmapï¼Œslotç±»ä¼¼äºhashmapçš„æ•°ç»„</span></span><br><span class="line">              <span class="comment">// å¦‚æœå­˜åœ¨hashå†²çªï¼Œè·å–è¿™ä¸ªslotå­˜çš„å‰ä¸€ä¸ªindexçš„è®¡æ•°ï¼Œå¦‚æœæ²¡æœ‰åˆ™å€¼ä¸º0</span></span><br><span class="line">              <span class="keyword">int</span> slotValue = <span class="keyword">this</span>.mappedByteBuffer.getInt(absSlotPos);</span><br><span class="line">              <span class="keyword">if</span> (slotValue &lt;= invalidIndex || slotValue &gt; <span class="keyword">this</span>.indexHeader.getIndexCount()) &#123;</span><br><span class="line">                  slotValue = invalidIndex;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="comment">// è®¡ç®—å½“å‰msgçš„å­˜å‚¨æ—¶é—´å’Œç¬¬ä¸€æ¡msgç›¸å·®ç§’æ•°</span></span><br><span class="line">              <span class="keyword">long</span> timeDiff = storeTimestamp - <span class="keyword">this</span>.indexHeader.getBeginTimestamp();</span><br><span class="line"></span><br><span class="line">              timeDiff = timeDiff / <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">              <span class="keyword">if</span> (<span class="keyword">this</span>.indexHeader.getBeginTimestamp() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                  timeDiff = <span class="number">0</span>;</span><br><span class="line">              &#125; <span class="keyword">else</span> <span class="keyword">if</span> (timeDiff &gt; Integer.MAX_VALUE) &#123;</span><br><span class="line">                  timeDiff = Integer.MAX_VALUE;</span><br><span class="line">              &#125; <span class="keyword">else</span> <span class="keyword">if</span> (timeDiff &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                  timeDiff = <span class="number">0</span>;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="comment">// è·å–è¯¥æ¡indexå®é™…å­˜å‚¨position</span></span><br><span class="line">              <span class="keyword">int</span> absIndexPos =</span><br><span class="line">                  IndexHeader.INDEX_HEADER_SIZE + <span class="keyword">this</span>.hashSlotNum * hashSlotSize</span><br><span class="line">                      + <span class="keyword">this</span>.indexHeader.getIndexCount() * indexSize;</span><br><span class="line">              <span class="comment">// ç”Ÿæˆä¸€ä¸ªindexçš„unitå†…å®¹(çœ‹å›¾)</span></span><br><span class="line">              <span class="keyword">this</span>.mappedByteBuffer.putInt(absIndexPos, keyHash);</span><br><span class="line">              <span class="keyword">this</span>.mappedByteBuffer.putLong(absIndexPos + <span class="number">4</span>, phyOffset);</span><br><span class="line">              <span class="keyword">this</span>.mappedByteBuffer.putInt(absIndexPos + <span class="number">4</span> + <span class="number">8</span>, (<span class="keyword">int</span>) timeDiff);</span><br><span class="line">              <span class="keyword">this</span>.mappedByteBuffer.putInt(absIndexPos + <span class="number">4</span> + <span class="number">8</span> + <span class="number">4</span>, slotValue);</span><br><span class="line">              <span class="comment">// æ›´æ–°slotä¸­çš„å€¼ä¸ºæœ¬æ¡æ¶ˆæ¯çš„index(å› ä¸ºrocketmqè§‰å¾—æ–°æ¶ˆæ¯è¢«æŸ¥è¯¢çš„æœºä¼šæ›´å¤§)</span></span><br><span class="line">              <span class="keyword">this</span>.mappedByteBuffer.putInt(absSlotPos, <span class="keyword">this</span>.indexHeader.getIndexCount());</span><br><span class="line">              <span class="comment">// å¦‚æœæ˜¯ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼Œæ›´æ–°headerä¸­çš„èµ·å§‹offsetå’Œèµ·å§‹æ—¶é—´</span></span><br><span class="line">              <span class="keyword">if</span> (<span class="keyword">this</span>.indexHeader.getIndexCount() &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">                  <span class="keyword">this</span>.indexHeader.setBeginPhyOffset(phyOffset);</span><br><span class="line">                  <span class="keyword">this</span>.indexHeader.setBeginTimestamp(storeTimestamp);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="comment">// æ›´æ–°headerä¸­çš„è®¡æ•°</span></span><br><span class="line">              <span class="keyword">this</span>.indexHeader.incHashSlotCount();</span><br><span class="line">              <span class="keyword">this</span>.indexHeader.incIndexCount();</span><br><span class="line">              <span class="keyword">this</span>.indexHeader.setEndPhyOffset(phyOffset);</span><br><span class="line">              <span class="keyword">this</span>.indexHeader.setEndTimestamp(storeTimestamp);</span><br><span class="line"></span><br><span class="line">              <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">          &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">              log.error(<span class="string">"putKey exception, Key: "</span> + key + <span class="string">" KeyHashCode: "</span> + key.hashCode(), e);</span><br><span class="line">          &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">              <span class="keyword">if</span> (fileLock != <span class="keyword">null</span>) &#123;</span><br><span class="line">                  <span class="keyword">try</span> &#123;</span><br><span class="line">                      fileLock.release();</span><br><span class="line">                  &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                      log.error(<span class="string">"Failed to release the lock"</span>, e);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          log.warn(<span class="string">"Over index file capacity: index count = "</span> + <span class="keyword">this</span>.indexHeader.getIndexCount()</span><br><span class="line">              + <span class="string">"; index max num = "</span> + <span class="keyword">this</span>.indexNum);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>çœ‹åˆ°è¿™é‡Œï¼ŒIndexFileå°±å·²ç»è¢«å­˜å…¥åˆ°ByteBufé‡Œå•¦ï¼Œç­‰å¾…è¢«flushåˆ°æ–‡ä»¶é‡Œï¼ï¼ï¼ï¼</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol>
<li><a href="https://blog.csdn.net/qq_27529917/article/details/79595395" target="_blank" rel="noopener">RocketMQæ¶ˆæ¯å­˜å‚¨æµç¨‹å›¾åŠæ•°æ®ç»“æ„å›¾</a></li>
<li><a href="https://www.jianshu.com/p/7833f5c28ec7" target="_blank" rel="noopener">RocketMQæºç è§£æ(ä¹)-Broker#æ¶ˆæ¯å­˜å‚¨ConsumeQueue</a></li>
<li><a href="https://www.jianshu.com/p/606d4b77d504" target="_blank" rel="noopener">RocketMQæºç è§£æ(å)-Broker#æ¶ˆæ¯å­˜å‚¨Index</a></li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¼•ï¼šæ¶ˆæ¯å­˜å‚¨å¯¹äºä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—æ¥è¯´æ˜¯è‚¯å®šè¦æœ‰çš„ï¼Œåœ¨RocketMQä¸­ï¼ŒBrokerå°†æ¶ˆæ¯å­˜å‚¨æŠ½è±¡æˆ&lt;code&gt;MessageStore&lt;/code&gt;æ¥å£ï¼Œæˆ‘ä»¬ä¹Ÿå°†ä»è¿™é‡Œå…¥æ‰‹~
    
    </summary>
    
      <category term="RocketMQæºç " scheme="http://bestlixiang.site/categories/RocketMQ%E6%BA%90%E7%A0%81/"/>
    
    
      <category term="RocketMQ" scheme="http://bestlixiang.site/tags/RocketMQ/"/>
    
  </entry>
  
  <entry>
    <title>RocketMQæºç åˆ†æâ€”â€”Brokerå¯åŠ¨</title>
    <link href="http://bestlixiang.site/2019/06/19/RocketMQ%E6%BA%90%E7%A0%81/RocketMQ%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E2%80%94%E2%80%94Broker%E5%90%AF%E5%8A%A8/"/>
    <id>http://bestlixiang.site/2019/06/19/RocketMQæºç /RocketMQæºç åˆ†æâ€”â€”Brokerå¯åŠ¨/</id>
    <published>2019-06-19T11:46:01.000Z</published>
    <updated>2019-06-19T11:46:10.269Z</updated>
    
    <content type="html"><![CDATA[<p>å¼•ï¼šå‰é¢è®²äº†NameServerï¼ŒProducerï¼ŒConsumerï¼Œç°åœ¨ç»ˆäºè½®åˆ°Brokeräº†ï¼Œå¯¹äºä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—æ¥è¯´ï¼ŒBrokeræ˜¯å½“ä»ä¸è®©çš„æ ¸å¿ƒ~<a id="more"></a></p>
<h1 id="äº”å¤§ä½œç”¨"><a href="#äº”å¤§ä½œç”¨" class="headerlink" title="äº”å¤§ä½œç”¨"></a>äº”å¤§ä½œç”¨</h1><ul>
<li>å­˜å‚¨æ¶ˆæ¯</li>
<li>æ¥æ”¶ç”Ÿäº§è€…æäº¤çš„æ¶ˆæ¯</li>
<li>å›å¤consumerçš„æ¶ˆæ¯æ‹‰å–è¯·æ±‚</li>
<li>ä¸»ä»èŠ‚ç‚¹é—´åŒæ­¥æ•°æ®ä¿è¯é«˜å¯ç”¨</li>
<li>æä¾›ç®€å•çš„apiæ¥æŸ¥è¯¢ç£ç›˜ä¸Šçš„ä¸´æ—¶æ•°æ®</li>
</ul>
<p>ä¹‹åæˆ‘ä»¬ä¹Ÿå°†ä»ä¸Šé¢çš„ä½œç”¨æ¥è¿›è¡Œæºç çš„æ¢ç´¢ï¼</p>
<h1 id="ä½¿ç”¨æ–¹å¼"><a href="#ä½¿ç”¨æ–¹å¼" class="headerlink" title="ä½¿ç”¨æ–¹å¼"></a>ä½¿ç”¨æ–¹å¼</h1><p>çœŸå®ä½¿ç”¨å½“ç„¶æ˜¯ç”¨å‘½ä»¤è¡Œå»éƒ¨ç½²ï¼Œè¿™é‡Œä¸ºäº†çœ‹æºç ï¼Œæˆ‘ä»¬æŠŠ<strong>ç¯å¢ƒæ­å»º</strong>é‚£ç¯‡æ–‡ç« çš„ä¾‹å­æ¬è¿‡æ¥ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      <span class="comment">// è®¾ç½®ç‰ˆæœ¬å·ï¼Œå¾ˆå…³é”®ï¼Œä¸ç„¶topicåˆ›å»ºä¸æˆåŠŸ</span></span><br><span class="line">      System.setProperty(RemotingCommand.REMOTING_VERSION_KEY, Integer.toString(MQVersion.CURRENT_VERSION));</span><br><span class="line">      <span class="keyword">final</span> BrokerConfig brokerConfig = <span class="keyword">new</span> BrokerConfig();</span><br><span class="line">      brokerConfig.setBrokerName(<span class="string">"broker-a"</span>);</span><br><span class="line">      brokerConfig.setNamesrvAddr(<span class="string">"127.0.0.1:9876"</span>);</span><br><span class="line"></span><br><span class="line">      BrokerController brokerController = <span class="keyword">new</span> BrokerController(</span><br><span class="line">              brokerConfig,</span><br><span class="line">              <span class="keyword">new</span> NettyServerConfig(),</span><br><span class="line">              <span class="keyword">new</span> NettyClientConfig(),</span><br><span class="line">              <span class="keyword">new</span> MessageStoreConfig());</span><br><span class="line">      assertThat(brokerController.initialize());</span><br><span class="line">      brokerController.start();</span><br><span class="line">      <span class="comment">// ä¸è®©ä¸»æ–¹æ³•ç»“æŸ</span></span><br><span class="line">      Thread.sleep(DateUtils.MILLIS_PER_DAY);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h1 id="Brokerå¯åŠ¨"><a href="#Brokerå¯åŠ¨" class="headerlink" title="Brokerå¯åŠ¨"></a>Brokerå¯åŠ¨</h1><p>ä»ä¸Šé¢çš„ä¾‹å­å¯ä»¥çœ‹å‡ºBrokerå¯åŠ¨å®è´¨å°±æ˜¯<code>org.apache.rocketmq.broker.BrokerController</code>å®Œæˆåˆå§‹åŒ–å’Œå¯åŠ¨çš„è¿‡ç¨‹ã€‚</p>
<h2 id="BrokerControlleråˆå§‹åŒ–"><a href="#BrokerControlleråˆå§‹åŒ–" class="headerlink" title="BrokerControlleråˆå§‹åŒ–"></a>BrokerControlleråˆå§‹åŒ–</h2><p>æˆ‘ä»¬çœ‹åˆ°<code>org.apache.rocketmq.broker.BrokerController#initialize()</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">initialize</span><span class="params">()</span> <span class="keyword">throws</span> CloneNotSupportedException </span>&#123;</span><br><span class="line">    <span class="comment">// 1. ä»æŒä¹…åŒ–æ–‡ä»¶ä¸­åŠ è½½æ•°æ®åˆ°å†…å­˜ä¸­</span></span><br><span class="line">    <span class="keyword">boolean</span> result = <span class="keyword">this</span>.topicConfigManager.load();</span><br><span class="line"></span><br><span class="line">    result = result &amp;&amp; <span class="keyword">this</span>.consumerOffsetManager.load();</span><br><span class="line">    result = result &amp;&amp; <span class="keyword">this</span>.subscriptionGroupManager.load();</span><br><span class="line">    result = result &amp;&amp; <span class="keyword">this</span>.consumerFilterManager.load();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (result) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 2. æ¶ˆæ¯å­˜å–çš„æ ¸å¿ƒæ¥å£åˆå§‹åŒ–</span></span><br><span class="line">            <span class="keyword">this</span>.messageStore =</span><br><span class="line">                <span class="keyword">new</span> DefaultMessageStore(<span class="keyword">this</span>.messageStoreConfig, <span class="keyword">this</span>.brokerStatsManager, <span class="keyword">this</span>.messageArrivingListener,</span><br><span class="line">                    <span class="keyword">this</span>.brokerConfig);</span><br><span class="line">            <span class="comment">// messageStoreçš„æŒ‡æ ‡ç»Ÿè®¡ç±»ï¼Œæä¾›æœ€è¿‘ä¸€å¤©çš„æ¶ˆæ¯ååé‡çš„ç»Ÿè®¡æ•°æ®</span></span><br><span class="line">            <span class="keyword">this</span>.brokerStats = <span class="keyword">new</span> BrokerStats((DefaultMessageStore) <span class="keyword">this</span>.messageStore);</span><br><span class="line">            <span class="comment">//load plugin</span></span><br><span class="line">            MessageStorePluginContext context = <span class="keyword">new</span> MessageStorePluginContext(messageStoreConfig, brokerStatsManager, messageArrivingListener, brokerConfig);</span><br><span class="line">            <span class="keyword">this</span>.messageStore = MessageStoreFactory.build(context, <span class="keyword">this</span>.messageStore);</span><br><span class="line">            <span class="comment">// æ·»åŠ æ¶ˆæ¯åˆ†å‘å™¨ï¼Œåˆ†å‘åˆ°å¸ƒéš†è¿‡æ»¤å™¨</span></span><br><span class="line">            <span class="keyword">this</span>.messageStore.getDispatcherList().addFirst(<span class="keyword">new</span> CommitLogDispatcherCalcBitMap(<span class="keyword">this</span>.brokerConfig, <span class="keyword">this</span>.consumerFilterManager));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            result = <span class="keyword">false</span>;</span><br><span class="line">            log.error(<span class="string">"Failed to initialize"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// messageStoreåŠ è½½å†…å­˜æ˜ å°„æ–‡ä»¶ï¼Œcommit logæ–‡ä»¶ï¼Œconsumer queueæ–‡ä»¶ï¼Œindexæ–‡ä»¶</span></span><br><span class="line">    result = result &amp;&amp; <span class="keyword">this</span>.messageStore.load();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (result) &#123;</span><br><span class="line">        <span class="comment">// 3. åˆå§‹åŒ–Netty Server</span></span><br><span class="line">        <span class="keyword">this</span>.remotingServer = <span class="keyword">new</span> NettyRemotingServer(<span class="keyword">this</span>.nettyServerConfig, <span class="keyword">this</span>.clientHousekeepingService);</span><br><span class="line">        NettyServerConfig fastConfig = (NettyServerConfig) <span class="keyword">this</span>.nettyServerConfig.clone();</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–VIPé€šé“ Netty Server</span></span><br><span class="line">        fastConfig.setListenPort(nettyServerConfig.getListenPort() - <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">this</span>.fastRemotingServer = <span class="keyword">new</span> NettyRemotingServer(fastConfig, <span class="keyword">this</span>.clientHousekeepingService);</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–ä¸€ç³»åˆ—å®¢æˆ·ç«¯æŒ‡ä»¤æ‰§è¡Œçš„çº¿ç¨‹æ± ï¼ŒNettyå¤„ç†çš„ä¼˜åŒ–</span></span><br><span class="line">        <span class="keyword">this</span>.sendMessageExecutor = <span class="keyword">new</span> BrokerFixedThreadPoolExecutor(</span><br><span class="line">            <span class="keyword">this</span>.brokerConfig.getSendMessageThreadPoolNums(),</span><br><span class="line">            <span class="keyword">this</span>.brokerConfig.getSendMessageThreadPoolNums(),</span><br><span class="line">            <span class="number">1000</span> * <span class="number">60</span>,</span><br><span class="line">            TimeUnit.MILLISECONDS,</span><br><span class="line">            <span class="keyword">this</span>.sendThreadPoolQueue,</span><br><span class="line">            <span class="keyword">new</span> ThreadFactoryImpl(<span class="string">"SendMessageThread_"</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.pullMessageExecutor = <span class="keyword">new</span> BrokerFixedThreadPoolExecutor(</span><br><span class="line">            <span class="keyword">this</span>.brokerConfig.getPullMessageThreadPoolNums(),</span><br><span class="line">            <span class="keyword">this</span>.brokerConfig.getPullMessageThreadPoolNums(),</span><br><span class="line">            <span class="number">1000</span> * <span class="number">60</span>,</span><br><span class="line">            TimeUnit.MILLISECONDS,</span><br><span class="line">            <span class="keyword">this</span>.pullThreadPoolQueue,</span><br><span class="line">            <span class="keyword">new</span> ThreadFactoryImpl(<span class="string">"PullMessageThread_"</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.queryMessageExecutor = <span class="keyword">new</span> BrokerFixedThreadPoolExecutor(</span><br><span class="line">            <span class="keyword">this</span>.brokerConfig.getQueryMessageThreadPoolNums(),</span><br><span class="line">            <span class="keyword">this</span>.brokerConfig.getQueryMessageThreadPoolNums(),</span><br><span class="line">            <span class="number">1000</span> * <span class="number">60</span>,</span><br><span class="line">            TimeUnit.MILLISECONDS,</span><br><span class="line">            <span class="keyword">this</span>.queryThreadPoolQueue,</span><br><span class="line">            <span class="keyword">new</span> ThreadFactoryImpl(<span class="string">"QueryMessageThread_"</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.adminBrokerExecutor =</span><br><span class="line">            Executors.newFixedThreadPool(<span class="keyword">this</span>.brokerConfig.getAdminBrokerThreadPoolNums(), <span class="keyword">new</span> ThreadFactoryImpl(</span><br><span class="line">                <span class="string">"AdminBrokerThread_"</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.clientManageExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">            <span class="keyword">this</span>.brokerConfig.getClientManageThreadPoolNums(),</span><br><span class="line">            <span class="keyword">this</span>.brokerConfig.getClientManageThreadPoolNums(),</span><br><span class="line">            <span class="number">1000</span> * <span class="number">60</span>,</span><br><span class="line">            TimeUnit.MILLISECONDS,</span><br><span class="line">            <span class="keyword">this</span>.clientManagerThreadPoolQueue,</span><br><span class="line">            <span class="keyword">new</span> ThreadFactoryImpl(<span class="string">"ClientManageThread_"</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.heartbeatExecutor = <span class="keyword">new</span> BrokerFixedThreadPoolExecutor(</span><br><span class="line">            <span class="keyword">this</span>.brokerConfig.getHeartbeatThreadPoolNums(),</span><br><span class="line">            <span class="keyword">this</span>.brokerConfig.getHeartbeatThreadPoolNums(),</span><br><span class="line">            <span class="number">1000</span> * <span class="number">60</span>,</span><br><span class="line">            TimeUnit.MILLISECONDS,</span><br><span class="line">            <span class="keyword">this</span>.heartbeatThreadPoolQueue,</span><br><span class="line">            <span class="keyword">new</span> ThreadFactoryImpl(<span class="string">"HeartbeatThread_"</span>, <span class="keyword">true</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.endTransactionExecutor = <span class="keyword">new</span> BrokerFixedThreadPoolExecutor(</span><br><span class="line">            <span class="keyword">this</span>.brokerConfig.getEndTransactionThreadPoolNums(),</span><br><span class="line">            <span class="keyword">this</span>.brokerConfig.getEndTransactionThreadPoolNums(),</span><br><span class="line">            <span class="number">1000</span> * <span class="number">60</span>,</span><br><span class="line">            TimeUnit.MILLISECONDS,</span><br><span class="line">            <span class="keyword">this</span>.endTransactionThreadPoolQueue,</span><br><span class="line">            <span class="keyword">new</span> ThreadFactoryImpl(<span class="string">"EndTransactionThread_"</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.consumerManageExecutor =</span><br><span class="line">            Executors.newFixedThreadPool(<span class="keyword">this</span>.brokerConfig.getConsumerManageThreadPoolNums(), <span class="keyword">new</span> ThreadFactoryImpl(</span><br><span class="line">                <span class="string">"ConsumerManageThread_"</span>));</span><br><span class="line">        <span class="comment">// å°†è¿™äº›çº¿ç¨‹æ± æ·»åŠ åˆ°Netty Pipelineä¸­</span></span><br><span class="line">        <span class="keyword">this</span>.registerProcessor();</span><br><span class="line">        <span class="comment">// 4. æ‰“å°brokerçš„æ¶ˆæ¯ååä¿¡æ¯åˆ°æ—¥å¿—æ–‡ä»¶å®šæ—¶ä»»åŠ¡ï¼Œæ¯å¤©0ç‚¹è®°å½•ä¸€æ¬¡</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> initialDelay = UtilAll.computNextMorningTimeMillis() - System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> period = <span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span>;</span><br><span class="line">        <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    BrokerController.<span class="keyword">this</span>.getBrokerStats().record();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    log.error(<span class="string">"schedule record error."</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, initialDelay, period, TimeUnit.MILLISECONDS);</span><br><span class="line">        <span class="comment">//  è®°å½•consumerOffetåˆ°æ–‡ä»¶å®šæ—¶ä»»åŠ¡,é»˜è®¤5ç§’ä¸€æ¬¡</span></span><br><span class="line">        <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    BrokerController.<span class="keyword">this</span>.consumerOffsetManager.persist();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    log.error(<span class="string">"schedule persist consumerOffset error."</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">1000</span> * <span class="number">10</span>, <span class="keyword">this</span>.brokerConfig.getFlushConsumerOffsetInterval(), TimeUnit.MILLISECONDS);</span><br><span class="line">        <span class="comment">// è®°å½•consumer filteråˆ°æ–‡ä»¶ä¸­å®šæ—¶ä»»åŠ¡,10ç§’ä¸€æ¬¡</span></span><br><span class="line">        <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    BrokerController.<span class="keyword">this</span>.consumerFilterManager.persist();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    log.error(<span class="string">"schedule persist consumer filter error."</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">1000</span> * <span class="number">10</span>, <span class="number">1000</span> * <span class="number">10</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">        <span class="comment">// å®šæ—¶æ£€æŸ¥consumerçš„æ¶ˆè´¹è®°å½•ï¼Œå¦‚æœå»¶æ—¶å¤ªå¤§,åˆ™disable consumer,ä¸å†å¾€è¿™ä¸ªconsumeræŠ•é€’æ¶ˆæ¯</span></span><br><span class="line">        <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    BrokerController.<span class="keyword">this</span>.protectBroker();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    log.error(<span class="string">"protectBroker error."</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">3</span>, <span class="number">3</span>, TimeUnit.MINUTES);</span><br><span class="line">        <span class="comment">// æ‰“å°å½“å‰Queue sizeæ—¥å¿—</span></span><br><span class="line">        <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    BrokerController.<span class="keyword">this</span>.printWaterMark();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    log.error(<span class="string">"printWaterMark error."</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">10</span>, <span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">        <span class="comment">// æ‰“å°dispatchè½åæƒ…å†µ</span></span><br><span class="line">        <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    log.info(<span class="string">"dispatch behind commit log &#123;&#125; bytes"</span>, BrokerController.<span class="keyword">this</span>.getMessageStore().dispatchBehindBytes());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    log.error(<span class="string">"schedule dispatchBehindBytes error."</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">1000</span> * <span class="number">10</span>, <span class="number">1000</span> * <span class="number">60</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">        <span class="comment">// å®šæ—¶æ›´æ–°nameserv addressä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.brokerConfig.getNamesrvAddr() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.brokerOuterAPI.updateNameServerAddressList(<span class="keyword">this</span>.brokerConfig.getNamesrvAddr());</span><br><span class="line">            log.info(<span class="string">"Set user specified name server address: &#123;&#125;"</span>, <span class="keyword">this</span>.brokerConfig.getNamesrvAddr());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.brokerConfig.isFetchNamesrvAddrByAddressServer()) &#123;</span><br><span class="line">            <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        BrokerController.<span class="keyword">this</span>.brokerOuterAPI.fetchNameServerAddr();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                        log.error(<span class="string">"ScheduledTask fetchNameServerAddr exception"</span>, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="number">1000</span> * <span class="number">10</span>, <span class="number">1000</span> * <span class="number">60</span> * <span class="number">2</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœæ˜¯brokeræ˜¯slaveï¼Œå¯åŠ¨å®šæ—¶ä»»åŠ¡ï¼Œæ¯åˆ†é’Ÿä»masteråŒæ­¥é…ç½®å’Œoffset</span></span><br><span class="line">        <span class="keyword">if</span> (BrokerRole.SLAVE == <span class="keyword">this</span>.messageStoreConfig.getBrokerRole()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.messageStoreConfig.getHaMasterAddress() != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.messageStoreConfig.getHaMasterAddress().length() &gt;= <span class="number">6</span>) &#123;</span><br><span class="line">                <span class="keyword">this</span>.messageStore.updateHaMasterAddress(<span class="keyword">this</span>.messageStoreConfig.getHaMasterAddress());</span><br><span class="line">                <span class="keyword">this</span>.updateMasterHAServerAddrPeriodically = <span class="keyword">false</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.updateMasterHAServerAddrPeriodically = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        BrokerController.<span class="keyword">this</span>.slaveSynchronize.syncAll();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                        log.error(<span class="string">"ScheduledTask syncAll slave exception"</span>, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="number">1000</span> * <span class="number">10</span>, <span class="number">1000</span> * <span class="number">60</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//å¦‚æœbrokeræ˜¯masterï¼Œå®šæ—¶æ‰“å°slaveå»¶æ—¶æƒ…å†µ</span></span><br><span class="line">            <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        BrokerController.<span class="keyword">this</span>.printMasterAndSlaveDiff();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                        log.error(<span class="string">"schedule printMasterAndSlaveDiff error."</span>, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="number">1000</span> * <span class="number">10</span>, <span class="number">1000</span> * <span class="number">60</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// çœç•¥...</span></span><br><span class="line">      </span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–äº‹åŠ¡æ¶ˆæ¯service</span></span><br><span class="line">        initialTransaction();</span><br><span class="line">        initialAcl();</span><br><span class="line">        initialRpcHooks();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»£ç é€»è¾‘è¿˜æ˜¯éå¸¸ç®€å•çš„ï¼Œä¸€çœ‹å°±çŸ¥é“ä»–åœ¨å¹²ä»€ä¹ˆ~</p>
<h2 id="BrokerControllerå¯åŠ¨"><a href="#BrokerControllerå¯åŠ¨" class="headerlink" title="BrokerControllerå¯åŠ¨"></a>BrokerControllerå¯åŠ¨</h2><p>å½“BrokerControlleråˆå§‹åŒ–å®Œæˆä¹‹åï¼Œæˆ‘ä»¬çœ‹<code>org.apache.rocketmq.broker.BrokerController#start()</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// å¯åŠ¨æ¶ˆæ¯å­˜å‚¨æœåŠ¡</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.messageStore != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.messageStore.start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¯åŠ¨Netty Serveræ¥æ”¶è¯·æ±‚</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.remotingServer != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.remotingServer.start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¯åŠ¨VIP Channel Netty Server</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.fastRemotingServer != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.fastRemotingServer.start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¯åŠ¨TLSç­¾åæ–‡ä»¶æ£€æµ‹æœåŠ¡</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.fileWatchService != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.fileWatchService.start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¯åŠ¨Brokerçš„Netty Client</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.brokerOuterAPI != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.brokerOuterAPI.start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¯åŠ¨PushConsumerçš„è¯·æ±‚ Hold æœåŠ¡ (åé¢ä¼šå±•å¼€)</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.pullRequestHoldService != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.pullRequestHoldService.start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç›‘æ§å®¢æˆ·ç«¯è¿æ¥ï¼Œå®šæ—¶æ£€æŸ¥Producerï¼ŒConsumerå’ŒFilteræ˜¯å¦é•¿æ—¶é—´æœªæ”¶åˆ°å¿ƒè·³</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.clientHousekeepingService != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.clientHousekeepingService.start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¯åŠ¨Filter Server</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.filterServerManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.filterServerManager.start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ³¨å†ŒBrokeråˆ°Namesrv</span></span><br><span class="line">    <span class="keyword">this</span>.registerBrokerAll(<span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®šæ—¶å‘Namesrvå‘å¿ƒè·³ï¼Œå¦‚æœæœ‰å˜åŒ–åˆ™åŒæ­¥Brokerä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                BrokerController.<span class="keyword">this</span>.registerBrokerAll(<span class="keyword">true</span>, <span class="keyword">false</span>, brokerConfig.isForceRegister());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                log.error(<span class="string">"registerBrokerAll Exception"</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="number">1000</span> * <span class="number">10</span>, Math.max(<span class="number">10000</span>, Math.min(brokerConfig.getRegisterNameServerPeriod(), <span class="number">60000</span>)), TimeUnit.MILLISECONDS);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.brokerStatsManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.brokerStatsManager.start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¯åŠ¨BrokerFastFailureæœåŠ¡ï¼Œå®šæ—¶æ¸…ç†é•¿æ—¶é—´æœªæ‰§è¡Œçš„å®¢æˆ·ç«¯è¯·æ±‚</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.brokerFastFailure != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.brokerFastFailure.start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯Masterï¼Œå¼€å¯äº‹åŠ¡æ¶ˆæ¯æ£€æŸ¥</span></span><br><span class="line">    <span class="keyword">if</span> (BrokerRole.SLAVE != messageStoreConfig.getBrokerRole()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.transactionalMessageCheckService != <span class="keyword">null</span>) &#123;</span><br><span class="line">            log.info(<span class="string">"Start transaction service!"</span>);</span><br><span class="line">            <span class="keyword">this</span>.transactionalMessageCheckService.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»æ•´ä¸ªè¿‡ç¨‹æ¥çœ‹è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œæ°´æ–‡ä¸€ç¯‡ï¼Œä½†æ˜¯åé¢ä¼šç»§ç»­åˆ†æBrokerçš„å„ä¸ªä½œç”¨çš„å®ç°ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¼•ï¼šå‰é¢è®²äº†NameServerï¼ŒProducerï¼ŒConsumerï¼Œç°åœ¨ç»ˆäºè½®åˆ°Brokeräº†ï¼Œå¯¹äºä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—æ¥è¯´ï¼ŒBrokeræ˜¯å½“ä»ä¸è®©çš„æ ¸å¿ƒ~
    
    </summary>
    
      <category term="RocketMQæºç " scheme="http://bestlixiang.site/categories/RocketMQ%E6%BA%90%E7%A0%81/"/>
    
    
      <category term="RocketMQ" scheme="http://bestlixiang.site/tags/RocketMQ/"/>
    
  </entry>
  
  <entry>
    <title>RocketMQæºç åˆ†æâ€”â€”Consumer</title>
    <link href="http://bestlixiang.site/2019/06/18/RocketMQ%E6%BA%90%E7%A0%81/RocketMQ%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E2%80%94%E2%80%94Consumer/"/>
    <id>http://bestlixiang.site/2019/06/18/RocketMQæºç /RocketMQæºç åˆ†æâ€”â€”Consumer/</id>
    <published>2019-06-18T11:43:10.000Z</published>
    <updated>2019-06-18T11:43:32.676Z</updated>
    
    <content type="html"><![CDATA[<p>å¼•ï¼šå½“æ¶ˆæ¯è¾¾åˆ°Brokerä¹‹åï¼Œå°±ç­‰ç€Consumerå»consumeäº†å‘€~<a id="more"></a></p>
<h1 id="æ¶ˆè´¹æ–¹å¼"><a href="#æ¶ˆè´¹æ–¹å¼" class="headerlink" title="æ¶ˆè´¹æ–¹å¼"></a>æ¶ˆè´¹æ–¹å¼</h1><ul>
<li><p>PullConsumerï¼šæ¶ˆè´¹è€…ä¸»åŠ¨è°ƒç”¨pullæ–¹æ³•æ¥è·å–æ¶ˆæ¯ï¼Œæ²¡æœ‰åˆ™è¿”å›</p>
</li>
<li><p>PushConsumerï¼šè™½ç„¶åä¸ºPushï¼Œä½†æ˜¯æ˜¯æ¶ˆè´¹è€…ä¸»åŠ¨å¾ªç¯å‘é€Pullè¯·æ±‚åˆ°brokerï¼Œå¦‚æœæ²¡æœ‰æ¶ˆæ¯ï¼Œbrokerä¼šæŠŠè¯·æ±‚æ”¾å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œæ–°æ¶ˆæ¯åˆ°è¾¾åè¿”å›response</p>
</li>
</ul>
<p>æ‰€ä»¥æœ¬è´¨ä¸Šï¼Œä¸¤ç§æ–¹å¼éƒ½æ˜¯é€šè¿‡æ¶ˆè´¹è€…ä¸»åŠ¨Pullæ¥å®ç°çš„ã€‚</p>
<h1 id="æ¶ˆè´¹æ¨¡å¼"><a href="#æ¶ˆè´¹æ¨¡å¼" class="headerlink" title="æ¶ˆè´¹æ¨¡å¼"></a>æ¶ˆè´¹æ¨¡å¼</h1><p>Consumerçš„æ¶ˆè´¹æ¨¡å¼åœ¨åˆå§‹åŒ–consumeræ—¶è®¾ç½®çš„ï¼Œä¸»è¦æœ‰ä¸‹é¢ä¸¤ç§ï¼š</p>
<ul>
<li>Broadcastæ¨¡å¼ï¼šæ¶ˆæ¯ä¼šå‘é€ç»™groupå†…æ‰€æœ‰consumer</li>
<li>Clusteræ¨¡å¼ï¼šæ¯æ¡æ¶ˆæ¯åªä¼šå‘é€ç»™groupå†…çš„ä¸€ä¸ªconsumerï¼Œä½†æ˜¯Clusteræ¨¡å¼çš„æ”¯æŒæ¶ˆè´¹å¤±è´¥é‡å‘ï¼Œä»è€Œä¿è¯æ¶ˆæ¯ä¸€å®šè¢«æ¶ˆè´¹</li>
</ul>
<h1 id="ä½¿ç”¨æ–¹å¼"><a href="#ä½¿ç”¨æ–¹å¼" class="headerlink" title="ä½¿ç”¨æ–¹å¼"></a>ä½¿ç”¨æ–¹å¼</h1><p>è¿™æ¬¡æˆ‘ä»¬ä¸»è¦çœ‹çœ‹PushConsumerï¼Œä»¥Clusteræ¨¡å¼æ¶ˆè´¹çš„æºç æ˜¯å¦‚ä½•å®ç°çš„ï¼Œå› ä¸ºè¿™ç§æ–¹å¼ç›¸å¯¹æ¥è¯´æ˜¯æœ€å¤æ‚çš„ä¸€ç§ã€‚ä¾‹å­å…¶å®ä¹Ÿæ˜¯åœ¨ä¹‹å‰<strong>ç¯å¢ƒæ­å»º</strong>é‚£è¾¹æ–‡ç« ä¸­ä¾‹å­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Consumer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException, MQClientException </span>&#123;</span><br><span class="line">				<span class="comment">// æŒ‡å®šæ¶ˆè´¹è€…ç»„çš„PushConsumer</span></span><br><span class="line">        DefaultMQPushConsumer consumer = <span class="keyword">new</span> DefaultMQPushConsumer(<span class="string">"please_rename_unique_group_name_4"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æŒ‡æ˜Namesrv</span></span><br><span class="line">        consumer.setNamesrvAddr(<span class="string">"127.0.0.1:9876"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æŒ‡å®šæ¶ˆè´¹å¼€å§‹ä½ç½®</span></span><br><span class="line">        consumer.setConsumeFromWhere(ConsumeFromWhere.CONSUME_FROM_FIRST_OFFSET);</span><br><span class="line"></span><br><span class="line">				<span class="comment">// è®¢é˜…Topic</span></span><br><span class="line">        consumer.subscribe(<span class="string">"TopicTest"</span>, <span class="string">"*"</span>);</span><br><span class="line"></span><br><span class="line">				<span class="comment">// æŒ‡å®šå›è°ƒé€»è¾‘</span></span><br><span class="line">        consumer.registerMessageListener(<span class="keyword">new</span> MessageListenerConcurrently() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> ConsumeConcurrentlyStatus <span class="title">consumeMessage</span><span class="params">(List&lt;MessageExt&gt; msgs,</span></span></span><br><span class="line"><span class="function"><span class="params">                ConsumeConcurrentlyContext context)</span> </span>&#123;</span><br><span class="line">                System.out.printf(<span class="string">"%s Receive New Messages: %s %n"</span>, Thread.currentThread().getName(), msgs);</span><br><span class="line">                <span class="keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">			  <span class="comment">// å¯åŠ¨</span></span><br><span class="line">        consumer.start();</span><br><span class="line"></span><br><span class="line">        System.out.printf(<span class="string">"Consumer Started.%n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Consumerå¯åŠ¨"><a href="#Consumerå¯åŠ¨" class="headerlink" title="Consumerå¯åŠ¨"></a>Consumerå¯åŠ¨</h1><p>ä¹‹å‰å…¶å®åœ¨Produceråˆ†æé‡Œé¢å¸¦è¿‡Consumerï¼Œæ‰€ä»¥é€»è¾‘ä¹Ÿæ˜¯ç±»ä¼¼çš„ã€‚</p>
<h2 id="DefaultMQPushConsumeråˆå§‹åŒ–"><a href="#DefaultMQPushConsumeråˆå§‹åŒ–" class="headerlink" title="DefaultMQPushConsumeråˆå§‹åŒ–"></a>DefaultMQPushConsumeråˆå§‹åŒ–</h2><p>å’ŒProducerä¸€æ ·åŒ…è£…äº†ä¸€ä¸ªDefaultMQPushConsumerImplï¼Œä¸‹é¢ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">// org.apache.rocketmq.client.consumer.DefaultMQPushConsumer</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">DefaultMQPushConsumer</span><span class="params">(<span class="keyword">final</span> String consumerGroup)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>(consumerGroup, <span class="keyword">null</span>, <span class="keyword">new</span> AllocateMessageQueueAveragely());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">DefaultMQPushConsumer</span><span class="params">(<span class="keyword">final</span> String consumerGroup, RPCHook rpcHook,</span></span></span><br><span class="line"><span class="function"><span class="params">      AllocateMessageQueueStrategy allocateMessageQueueStrategy)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.consumerGroup = consumerGroup;</span><br><span class="line">      <span class="comment">// é»˜è®¤å¹³å‡åˆ†é…</span></span><br><span class="line">      <span class="keyword">this</span>.allocateMessageQueueStrategy = allocateMessageQueueStrategy;</span><br><span class="line">      <span class="comment">// æ„é€ å®é™…ç±»</span></span><br><span class="line">      defaultMQPushConsumerImpl = <span class="keyword">new</span> DefaultMQPushConsumerImpl(<span class="keyword">this</span>, rpcHook);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// org.apache.rocketmq.client.impl.consumer.DefaultMQPushConsumerImpl</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">DefaultMQPushConsumerImpl</span><span class="params">(DefaultMQPushConsumer defaultMQPushConsumer, RPCHook rpcHook)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.defaultMQPushConsumer = defaultMQPushConsumer;</span><br><span class="line">      <span class="keyword">this</span>.rpcHook = rpcHook;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h2 id="DefaultMQPushConsumerå¯åŠ¨"><a href="#DefaultMQPushConsumerå¯åŠ¨" class="headerlink" title="DefaultMQPushConsumerå¯åŠ¨"></a>DefaultMQPushConsumerå¯åŠ¨</h2><p>å®è´¨å°±æ˜¯defaultMQPushConsumerImplå¯åŠ¨ï¼Œä¸‹é¢ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"> 	<span class="comment">// org.apache.rocketmq.client.consumer.DefaultMQPushConsumer</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> MQClientException </span>&#123;</span><br><span class="line">      <span class="comment">// å®è´¨defaultMQPushConsumerImplå¯åŠ¨</span></span><br><span class="line">      <span class="keyword">this</span>.defaultMQPushConsumerImpl.start();</span><br><span class="line">		<span class="comment">// çœç•¥...</span></span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// org.apache.rocketmq.client.impl.consumer.DefaultMQPushConsumerImpl</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> MQClientException </span>&#123;</span><br><span class="line">      <span class="keyword">switch</span> (<span class="keyword">this</span>.serviceState) &#123;</span><br><span class="line">          <span class="keyword">case</span> CREATE_JUST:</span><br><span class="line">              log.info(<span class="string">"the consumer [&#123;&#125;] start beginning. messageModel=&#123;&#125;, isUnitMode=&#123;&#125;"</span>, <span class="keyword">this</span>.defaultMQPushConsumer.getConsumerGroup(),</span><br><span class="line">                  <span class="keyword">this</span>.defaultMQPushConsumer.getMessageModel(), <span class="keyword">this</span>.defaultMQPushConsumer.isUnitMode());</span><br><span class="line">              <span class="keyword">this</span>.serviceState = ServiceState.START_FAILED;</span><br><span class="line">              <span class="comment">// åŸºæœ¬å‚æ•°æ£€æŸ¥</span></span><br><span class="line">              <span class="keyword">this</span>.checkConfig();</span><br><span class="line">              <span class="comment">// å°†DefaultMQPushConsumerçš„è®¢é˜…ä¿¡æ¯copyåˆ°RebalanceServiceä¸­</span></span><br><span class="line">              <span class="comment">// å¦‚æœæ˜¯clusteræ¨¡å¼ï¼Œå¦‚æœè®¢é˜…äº†topic,åˆ™è‡ªåŠ¨è®¢é˜…%RETRY%groupnameï¼Œä¹ŸåŠ å…¥åˆ°RebalanceServiceä¸­</span></span><br><span class="line">              <span class="keyword">this</span>.copySubscription();</span><br><span class="line"></span><br><span class="line">              <span class="keyword">if</span> (<span class="keyword">this</span>.defaultMQPushConsumer.getMessageModel() == MessageModel.CLUSTERING) &#123;</span><br><span class="line">                  <span class="comment">// å¦‚æœInstanceNameå‚æ•°å€¼ä¸ºDEFAULTåˆ™ä¿®æ”¹ä¸ºPID</span></span><br><span class="line">                  <span class="keyword">this</span>.defaultMQPushConsumer.changeInstanceNameToPID();</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="comment">// æ–°å»ºä¸€ä¸ªMQClientInstance,å®¢æˆ·ç«¯ç®¡ç†ç±», å•ä¾‹ï¼Œä¸€ä¸ªè¿›ç¨‹ä¸­åªæœ‰ä¸€ä¸ª</span></span><br><span class="line">              <span class="comment">// æ‰€æœ‰çš„i/oç±»æ“ä½œç”±å®ƒç®¡ç†ï¼Œç¼“å­˜å®¢æˆ·ç«¯å’Œtopicä¿¡æ¯ï¼Œå„ç§serviceï¼Œå¾ˆé‡è¦</span></span><br><span class="line">              <span class="keyword">this</span>.mQClientFactory = MQClientManager.getInstance().getAndCreateMQClientInstance(<span class="keyword">this</span>.defaultMQPushConsumer, <span class="keyword">this</span>.rpcHook);</span><br><span class="line"></span><br><span class="line">              <span class="keyword">this</span>.rebalanceImpl.setConsumerGroup(<span class="keyword">this</span>.defaultMQPushConsumer.getConsumerGroup());</span><br><span class="line">              <span class="keyword">this</span>.rebalanceImpl.setMessageModel(<span class="keyword">this</span>.defaultMQPushConsumer.getMessageModel());</span><br><span class="line">              <span class="keyword">this</span>.rebalanceImpl.setAllocateMessageQueueStrategy(<span class="keyword">this</span>.defaultMQPushConsumer.getAllocateMessageQueueStrategy());</span><br><span class="line">              <span class="keyword">this</span>.rebalanceImpl.setmQClientFactory(<span class="keyword">this</span>.mQClientFactory);</span><br><span class="line">              <span class="comment">// PullRequestå°è£…å®ç°ç±»ï¼Œå°è£…äº†å’Œbrokerçš„é€šä¿¡æ¥å£</span></span><br><span class="line">              <span class="keyword">this</span>.pullAPIWrapper = <span class="keyword">new</span> PullAPIWrapper(</span><br><span class="line">                  mQClientFactory,</span><br><span class="line">                  <span class="keyword">this</span>.defaultMQPushConsumer.getConsumerGroup(), isUnitMode());</span><br><span class="line">              <span class="comment">// æ¶ˆæ¯è¢«å®¢æˆ·ç«¯è¿‡æ»¤æ—¶ä¼šå›è°ƒçš„é’©å­</span></span><br><span class="line">              <span class="keyword">this</span>.pullAPIWrapper.registerFilterMessageHook(filterMessageHookList);</span><br><span class="line"></span><br><span class="line">              <span class="comment">// consumerå®¢æˆ·ç«¯æ¶ˆè´¹offsetæŒä¹…åŒ–</span></span><br><span class="line">              <span class="keyword">if</span> (<span class="keyword">this</span>.defaultMQPushConsumer.getOffsetStore() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                  <span class="keyword">this</span>.offsetStore = <span class="keyword">this</span>.defaultMQPushConsumer.getOffsetStore();</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  <span class="keyword">switch</span> (<span class="keyword">this</span>.defaultMQPushConsumer.getMessageModel()) &#123;</span><br><span class="line">                      <span class="comment">// å¹¿æ’­æ¶ˆæ¯æœ¬åœ°æŒä¹…åŒ–offset</span></span><br><span class="line">                      <span class="keyword">case</span> BROADCASTING:</span><br><span class="line">                          <span class="keyword">this</span>.offsetStore = <span class="keyword">new</span> LocalFileOffsetStore(<span class="keyword">this</span>.mQClientFactory, <span class="keyword">this</span>.defaultMQPushConsumer.getConsumerGroup());</span><br><span class="line">                          <span class="keyword">break</span>;</span><br><span class="line">                      <span class="comment">// é›†ç¾¤æ¨¡å¼brokeræŒä¹…åŒ–offset</span></span><br><span class="line">                      <span class="keyword">case</span> CLUSTERING:</span><br><span class="line">                          <span class="keyword">this</span>.offsetStore = <span class="keyword">new</span> RemoteBrokerOffsetStore(<span class="keyword">this</span>.mQClientFactory, <span class="keyword">this</span>.defaultMQPushConsumer.getConsumerGroup());</span><br><span class="line">                          <span class="keyword">break</span>;</span><br><span class="line">                      <span class="keyword">default</span>:</span><br><span class="line">                          <span class="keyword">break</span>;</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="keyword">this</span>.defaultMQPushConsumer.setOffsetStore(<span class="keyword">this</span>.offsetStore);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="comment">// å¦‚æœæ˜¯å¹¿æ’­æ¨¡å¼åˆ™ä»æœ¬åœ°æ–‡ä»¶ä¸­loadï¼Œå¦‚æœæ˜¯é›†ç¾¤æ¨¡å¼ä¸åšæ“ä½œ</span></span><br><span class="line">              <span class="keyword">this</span>.offsetStore.load();</span><br><span class="line">              <span class="comment">// æ¶ˆæ¯æ¶ˆè´¹æœåŠ¡ï¼Œé¡ºåºå’Œå¹¶å‘æ¶ˆæ¯é€»è¾‘ä¸åŒ,æ¥æ”¶æ¶ˆæ¯å¹¶è°ƒç”¨listeneræ¶ˆè´¹ï¼Œå¤„ç†æ¶ˆè´¹ç»“æœ</span></span><br><span class="line">              <span class="keyword">if</span> (<span class="keyword">this</span>.getMessageListenerInner() <span class="keyword">instanceof</span> MessageListenerOrderly) &#123;</span><br><span class="line">                  <span class="keyword">this</span>.consumeOrderly = <span class="keyword">true</span>;</span><br><span class="line">                  <span class="keyword">this</span>.consumeMessageService =</span><br><span class="line">                      <span class="keyword">new</span> ConsumeMessageOrderlyService(<span class="keyword">this</span>, (MessageListenerOrderly) <span class="keyword">this</span>.getMessageListenerInner());</span><br><span class="line">              &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.getMessageListenerInner() <span class="keyword">instanceof</span> MessageListenerConcurrently) &#123;</span><br><span class="line">                  <span class="keyword">this</span>.consumeOrderly = <span class="keyword">false</span>;</span><br><span class="line">                  <span class="keyword">this</span>.consumeMessageService =</span><br><span class="line">                      <span class="keyword">new</span> ConsumeMessageConcurrentlyService(<span class="keyword">this</span>, (MessageListenerConcurrently) <span class="keyword">this</span>.getMessageListenerInner());</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="comment">// å¯åŠ¨ç­‰å¾…å¤„ç†æ¶ˆæ¯æœåŠ¡ï¼ˆå®šæ—¶æœåŠ¡ï¼‰</span></span><br><span class="line">              <span class="keyword">this</span>.consumeMessageService.start();</span><br><span class="line">              <span class="comment">// æ³¨å†ŒConsumer</span></span><br><span class="line">              <span class="keyword">boolean</span> registerOK = mQClientFactory.registerConsumer(<span class="keyword">this</span>.defaultMQPushConsumer.getConsumerGroup(), <span class="keyword">this</span>);</span><br><span class="line">              <span class="keyword">if</span> (!registerOK) &#123;</span><br><span class="line">                  <span class="keyword">this</span>.serviceState = ServiceState.CREATE_JUST;</span><br><span class="line">                  <span class="keyword">this</span>.consumeMessageService.shutdown();</span><br><span class="line">                  <span class="keyword">throw</span> <span class="keyword">new</span> MQClientException(<span class="string">"The consumer group["</span> + <span class="keyword">this</span>.defaultMQPushConsumer.getConsumerGroup()</span><br><span class="line">                      + <span class="string">"] has been created before, specify another name please."</span> + FAQUrl.suggestTodo(FAQUrl.GROUP_NAME_DUPLICATE_URL),</span><br><span class="line">                      <span class="keyword">null</span>);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="comment">// mqClientå¯åŠ¨</span></span><br><span class="line">              mQClientFactory.start();</span><br><span class="line">              log.info(<span class="string">"the consumer [&#123;&#125;] start OK."</span>, <span class="keyword">this</span>.defaultMQPushConsumer.getConsumerGroup());</span><br><span class="line">              <span class="comment">// æ”¹å˜çŠ¶æ€</span></span><br><span class="line">              <span class="keyword">this</span>.serviceState = ServiceState.RUNNING;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> RUNNING:</span><br><span class="line">          <span class="keyword">case</span> START_FAILED:</span><br><span class="line">          <span class="keyword">case</span> SHUTDOWN_ALREADY:</span><br><span class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> MQClientException(<span class="string">"The PushConsumer service state not OK, maybe started once, "</span></span><br><span class="line">                  + <span class="keyword">this</span>.serviceState</span><br><span class="line">                  + FAQUrl.suggestTodo(FAQUrl.CLIENT_SERVICE_NOT_OK),</span><br><span class="line">                  <span class="keyword">null</span>);</span><br><span class="line">          <span class="keyword">default</span>:</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// æ›´æ–°Topicä¿¡æ¯</span></span><br><span class="line">      <span class="keyword">this</span>.updateTopicSubscribeInfoWhenSubscriptionChanged();</span><br><span class="line">      <span class="keyword">this</span>.mQClientFactory.checkClientInBroker();</span><br><span class="line">      <span class="comment">// å‘é€å¿ƒè·³</span></span><br><span class="line">      <span class="keyword">this</span>.mQClientFactory.sendHeartbeatToAllBrokerWithLock();</span><br><span class="line">      <span class="comment">// åšä¸€æ¬¡rebalance</span></span><br><span class="line">      <span class="keyword">this</span>.mQClientFactory.rebalanceImmediately();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæœ‰ä¸¤ä¸ªç‚¹è¯´ä¸€ä¸‹ï¼š</p>
<ul>
<li>%RETRY% +groupnameï¼šå¦‚æœconsumeræ˜¯clusteræ¨¡å¼ï¼Œå¹¶ä¸”è®¢é˜…äº†TopicAçš„æ¶ˆæ¯ï¼Œé‚£å®¢æˆ·ç«¯ä¼šè‡ªåŠ¨è®¢é˜…%RETRY% + +groupnameã€‚æˆ‘ä»¬çŸ¥é“consumeræ¶ˆè´¹æ¶ˆæ¯å¤„ç†å¤±è´¥çš„è¯ï¼Œbrokeræ˜¯ä¼šå»¶æ—¶ä¸€å®šçš„æ—¶é—´é‡æ–°æ¨é€çš„ï¼Œé‡æ–°æ¨é€ä¸æ˜¯è·Ÿå…¶å®ƒæ–°æ¶ˆæ¯ä¸€èµ·è¿‡æ¥ï¼Œè€Œæ˜¯é€šè¿‡å•ç‹¬çš„%RETRY%è¿‡æ¥ã€‚</li>
<li>RebalanceServiceåˆ†é…ç­–ç•¥ï¼šRebalanceæ”¯æŒå¤šç§åˆ†é…ç­–ç•¥ï¼Œæ¯”å¦‚å¹³å‡åˆ†é…ã€ä¸€è‡´æ€§Hashç­‰ï¼Œé»˜è®¤é‡‡ç”¨å¹³å‡åˆ†é…ç­–ç•¥(AVG)ã€‚</li>
</ul>
<h2 id="MQClientInstanceå¯åŠ¨"><a href="#MQClientInstanceå¯åŠ¨" class="headerlink" title="MQClientInstanceå¯åŠ¨"></a>MQClientInstanceå¯åŠ¨</h2><p>åœ¨è®²Producerçš„æ—¶å€™å·²ç»è®²è¿‡<code>MQClientInstance</code>çš„å¯åŠ¨è¿‡ç¨‹ï¼Œå› ä¸ºProducerå’ŒConsumerå…±ç”¨ä¸€ä¸ª<code>MQClientInstance</code>ï¼Œä¸‹é¢æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹Consumerç›¸å…³é€»è¾‘ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">// org.apache.rocketmq.client.impl.factory.MQClientInstance</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> MQClientException </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">          <span class="keyword">switch</span> (<span class="keyword">this</span>.serviceState) &#123;</span><br><span class="line">              <span class="keyword">case</span> CREATE_JUST:</span><br><span class="line">             			<span class="comment">// çœç•¥ä¸ç›¸å…³...</span></span><br><span class="line">                  <span class="comment">// å¼€å¯å„ç§å®šæ—¶ä»»åŠ¡</span></span><br><span class="line">                  <span class="keyword">this</span>.startScheduledTask();</span><br><span class="line">                  <span class="comment">// å¼€å¯æ‹‰æ¶ˆæ¯æœåŠ¡(Consumer)</span></span><br><span class="line">                  <span class="keyword">this</span>.pullMessageService.start();</span><br><span class="line">                  <span class="comment">// å¼€å¯è´Ÿè½½å‡è¡¡æœåŠ¡ï¼Œä¸€ä¸ªçº¿ç¨‹å®šæ—¶è§¦å‘rebalance(20ç§’ä¸€æ¬¡)</span></span><br><span class="line">                  <span class="keyword">this</span>.rebalanceService.start();</span><br><span class="line">                  <span class="comment">// åˆå§‹åŒ–ä¸€ä¸ªè‡ªç”¨çš„producerï¼Œ`CLIENT_INNER_PRODUCER`</span></span><br><span class="line">                  <span class="comment">// ä¸»è¦ç”¨äºåœ¨æ¶ˆè´¹å¤±è´¥æˆ–è€…è¶…æ—¶åå‘é€é‡è¯•çš„æ¶ˆæ¯ç»™broker</span></span><br><span class="line">                  <span class="keyword">this</span>.defaultMQProducer.getDefaultMQProducerImpl().start(<span class="keyword">false</span>);</span><br><span class="line">                  <span class="keyword">this</span>.serviceState = ServiceState.RUNNING;</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">								<span class="comment">// çœç•¥ä¸ç›¸å…³...</span></span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startScheduledTask</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="comment">// çœç•¥ä¸ç›¸å…³...</span></span><br><span class="line">      <span class="comment">// æŒä¹…åŒ–æ¶ˆè´¹è€…çš„Offset</span></span><br><span class="line">    	<span class="comment">// ä¿å­˜æ¶ˆè´¹è¿›åº¦ï¼Œå¹¿æ’­æ¶ˆæ¯å­˜åœ¨æœ¬åœ°ï¼Œé›†ç¾¤æ¶ˆæ¯ä¸Šä¼ åˆ°æ‰€æœ‰çš„broker</span></span><br><span class="line">      <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line"></span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">                  MQClientInstance.<span class="keyword">this</span>.persistAllConsumerOffset();</span><br><span class="line">              &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                  log.error(<span class="string">"ScheduledTask persistAllConsumerOffset exception"</span>, e);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;, <span class="number">1000</span> * <span class="number">10</span>, <span class="keyword">this</span>.clientConfig.getPersistConsumerOffsetInterval(), TimeUnit.MILLISECONDS);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// æ ¹æ®è´Ÿè½½è°ƒæ•´æœ¬åœ°å¤„ç†æ¶ˆæ¯çš„çº¿ç¨‹æ± corePoolå¤§å°</span></span><br><span class="line">      <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line"></span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">                  MQClientInstance.<span class="keyword">this</span>.adjustThreadPool();</span><br><span class="line">              &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                  log.error(<span class="string">"ScheduledTask adjustThreadPool exception"</span>, e);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;, <span class="number">1</span>, <span class="number">1</span>, TimeUnit.MINUTES);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>åˆ°è¿™é‡ŒConsumerçš„ç›¸å…³åˆå§‹åŒ–å·¥ä½œå°±åšå®Œäº†ï¼Œä¸‹é¢å°±ä¼šå»æ¶ˆè´¹æ¶ˆæ¯äº†ã€‚</p>
<h1 id="æ¶ˆæ¯æ¶ˆè´¹"><a href="#æ¶ˆæ¯æ¶ˆè´¹" class="headerlink" title="æ¶ˆæ¯æ¶ˆè´¹"></a>æ¶ˆæ¯æ¶ˆè´¹</h1><p>è¿™å—é€»è¾‘æœ‰ç‚¹å¤æ‚ï¼Œä¸ºäº†å¤§å®¶ä¸è¢«ç»†èŠ‚ç»•æ™•ï¼Œè¿™é‡Œç”»äº†ä¸€ä¸‹æ—¶åºå›¾ï¼Œå¦‚ä¸‹ï¼š<br><img src="https://upload-images.jianshu.io/upload_images/10354196-0b1bee5b4c2bb8b6.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="RocketMqâ€”â€”Consumeræ¶ˆæ¯æ¶ˆè´¹æ—¶åºå›¾.jpg"></p>
<h2 id="RebalanceImplè§¦å‘Pullæ¶ˆæ¯"><a href="#RebalanceImplè§¦å‘Pullæ¶ˆæ¯" class="headerlink" title="RebalanceImplè§¦å‘Pullæ¶ˆæ¯"></a>RebalanceImplè§¦å‘Pullæ¶ˆæ¯</h2><p>è¿˜è®°å¾—<code>defaultMQPushConsumerImpl</code>å¯åŠ¨ä»£ç ä¸­æœ€åä¸€è¡Œæ‰§è¡Œäº†<code>this.mQClientFactory.rebalanceImmediately()</code>ï¼Œå¿˜è®°äº†ï¼Œå¯ä»¥å›å¤´çœ‹çœ‹ï¼Œè¿™é‡Œä¼šç¬¬ä¸€æ¬¡è§¦å‘Pullæ¶ˆæ¯ã€‚æˆ‘ä»¬çœ‹çœ‹ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">// org.apache.rocketmq.client.impl.factory.MQClientInstance</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rebalanceImmediately</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   		<span class="comment">// ä¹‹å‰è¯´è¿‡rebalanceServiceå°±æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œç»§æ‰¿äºServiceThread</span></span><br><span class="line">      <span class="keyword">this</span>.rebalanceService.wakeup();</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// org.apache.rocketmq.common.ServiceThread</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">wakeup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    	<span class="comment">// è¿™é‡Œä¸»è¦æ˜¯å”¤é†’rebalanceServiceï¼Œç”¨æ¥äº†åŸå­ç±»å’Œé—­é”ä¿è¯çº¿ç¨‹å®‰å…¨</span></span><br><span class="line">      <span class="keyword">if</span> (hasNotified.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">          waitPoint.countDown(); <span class="comment">// notify</span></span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// org.apache.rocketmq.client.impl.consumer.rebalanceService</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">while</span> (!<span class="keyword">this</span>.isStopped()) &#123;</span><br><span class="line">        	<span class="comment">// é»˜è®¤20s</span></span><br><span class="line">          <span class="keyword">this</span>.waitForRunning(waitInterval);</span><br><span class="line">          <span class="keyword">this</span>.mqClientFactory.doRebalance();</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// org.apache.rocketmq.client.impl.factory.MQClientInstance</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doRebalance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    	<span class="comment">// æ¯ä¸€ä¸ªConsumeréƒ½è¦åšdoRebalanceæ“ä½œ</span></span><br><span class="line">      <span class="keyword">for</span> (Map.Entry&lt;String, MQConsumerInner&gt; entry : <span class="keyword">this</span>.consumerTable.entrySet()) &#123;</span><br><span class="line">          MQConsumerInner impl = entry.getValue();</span><br><span class="line">          <span class="keyword">if</span> (impl != <span class="keyword">null</span>) &#123;</span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">                  impl.doRebalance();</span><br><span class="line">              &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                  log.error(<span class="string">"doRebalance exception"</span>, e);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> <span class="comment">// org.apache.rocketmq.client.impl.consumer.DefaultMQPushConsumerImpl</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doRebalance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="keyword">this</span>.pause) &#123;</span><br><span class="line">          <span class="keyword">this</span>.rebalanceImpl.doRebalance(<span class="keyword">this</span>.isConsumeOrderly());</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// org.apache.rocketmq.client.impl.consumer.RebalanceImpl</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">rebalanceByTopic</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> <span class="keyword">boolean</span> isOrder)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">switch</span> (messageModel) &#123;</span><br><span class="line">          <span class="keyword">case</span> BROADCASTING: &#123;</span><br><span class="line">              Set&lt;MessageQueue&gt; mqSet = <span class="keyword">this</span>.topicSubscribeInfoTable.get(topic);</span><br><span class="line">              <span class="keyword">if</span> (mqSet != <span class="keyword">null</span>) &#123;</span><br><span class="line">                  <span class="keyword">boolean</span> changed = <span class="keyword">this</span>.updateProcessQueueTableInRebalance(topic, mqSet, isOrder);</span><br><span class="line">                  <span class="keyword">if</span> (changed) &#123;</span><br><span class="line">                      <span class="keyword">this</span>.messageQueueChanged(topic, mqSet, mqSet);</span><br><span class="line">                      log.info(<span class="string">"messageQueueChanged &#123;&#125; &#123;&#125; &#123;&#125; &#123;&#125;"</span>,</span><br><span class="line">                          consumerGroup,</span><br><span class="line">                          topic,</span><br><span class="line">                          mqSet,</span><br><span class="line">                          mqSet);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  log.warn(<span class="string">"doRebalance, &#123;&#125;, but the topic[&#123;&#125;] not exist."</span>, consumerGroup, topic);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">case</span> CLUSTERING: &#123;</span><br><span class="line">              <span class="comment">// ä»è·¯ç”±ä¿¡æ¯ä¸­è·å–topicå¯¹åº”æ‰€æœ‰çš„Queue</span></span><br><span class="line">              Set&lt;MessageQueue&gt; mqSet = <span class="keyword">this</span>.topicSubscribeInfoTable.get(topic);</span><br><span class="line">              <span class="comment">// ä»brokerè·å–æ‰€æœ‰åŒä¸€ä¸ªgroupçš„æ‰€æœ‰Consumer ID(192.168.1.28@83721)</span></span><br><span class="line">              List&lt;String&gt; cidAll = <span class="keyword">this</span>.mQClientFactory.findConsumerIdList(topic, consumerGroup);</span><br><span class="line">              <span class="keyword">if</span> (<span class="keyword">null</span> == mqSet) &#123;</span><br><span class="line">                  <span class="keyword">if</span> (!topic.startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) &#123;</span><br><span class="line">                      log.warn(<span class="string">"doRebalance, &#123;&#125;, but the topic[&#123;&#125;] not exist."</span>, consumerGroup, topic);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              <span class="keyword">if</span> (<span class="keyword">null</span> == cidAll) &#123;</span><br><span class="line">                  log.warn(<span class="string">"doRebalance, &#123;&#125; &#123;&#125;, get consumer id list failed"</span>, consumerGroup, topic);</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              <span class="keyword">if</span> (mqSet != <span class="keyword">null</span> &amp;&amp; cidAll != <span class="keyword">null</span>) &#123;</span><br><span class="line">                  List&lt;MessageQueue&gt; mqAll = <span class="keyword">new</span> ArrayList&lt;MessageQueue&gt;();</span><br><span class="line">                  mqAll.addAll(mqSet);</span><br><span class="line">                  <span class="comment">// å°†mqå’Œcidéƒ½æ’å¥½åº</span></span><br><span class="line">                  Collections.sort(mqAll);</span><br><span class="line">                  Collections.sort(cidAll);</span><br><span class="line">                  <span class="comment">// æŒ‰ç…§åˆå§‹åŒ–æ˜¯æŒ‡å®šçš„åˆ†é…ç­–ç•¥ï¼ˆé»˜è®¤å¹³å‡ï¼‰ï¼Œè·å–Consumeråˆ†é…çš„MQåˆ—è¡¨</span></span><br><span class="line">                  AllocateMessageQueueStrategy strategy = <span class="keyword">this</span>.allocateMessageQueueStrategy;</span><br><span class="line"></span><br><span class="line">                  List&lt;MessageQueue&gt; allocateResult = <span class="keyword">null</span>;</span><br><span class="line">                  <span class="keyword">try</span> &#123;</span><br><span class="line">                      allocateResult = strategy.allocate(</span><br><span class="line">                          <span class="keyword">this</span>.consumerGroup,</span><br><span class="line">                          <span class="keyword">this</span>.mQClientFactory.getClientId(),</span><br><span class="line">                          mqAll,</span><br><span class="line">                          cidAll);</span><br><span class="line">                  &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                      log.error(<span class="string">"AllocateMessageQueueStrategy.allocate Exception. allocateMessageQueueStrategyName=&#123;&#125;"</span>, strategy.getName(),</span><br><span class="line">                          e);</span><br><span class="line">                      <span class="keyword">return</span>;</span><br><span class="line">                  &#125;</span><br><span class="line"></span><br><span class="line">                  Set&lt;MessageQueue&gt; allocateResultSet = <span class="keyword">new</span> HashSet&lt;MessageQueue&gt;();</span><br><span class="line">                  <span class="keyword">if</span> (allocateResult != <span class="keyword">null</span>) &#123;</span><br><span class="line">                      allocateResultSet.addAll(allocateResult);</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="comment">// æ›´æ–°rebalanceImplä¸­çš„processQueueç”¨æ¥ç¼“å­˜æ”¶åˆ°çš„æ¶ˆæ¯</span></span><br><span class="line">                  <span class="comment">// å¯¹äºæ–°åŠ å…¥çš„Queueï¼Œæäº¤ä¸€æ¬¡PullRequest</span></span><br><span class="line">                  <span class="comment">// å¯¹äºæ–°å¯åŠ¨çš„consumeræ¥è¯´ï¼Œæ‰€æœ‰çš„queueéƒ½æ˜¯æ–°æ·»åŠ çš„ï¼Œæ‰€ä»¥æ‰€æœ‰queueéƒ½ä¼šè§¦å‘PullRequest</span></span><br><span class="line">                  <span class="keyword">boolean</span> changed = <span class="keyword">this</span>.updateProcessQueueTableInRebalance(topic, allocateResultSet, isOrder);</span><br><span class="line">                  <span class="keyword">if</span> (changed) &#123;</span><br><span class="line">                      log.info(</span><br><span class="line">                          <span class="string">"rebalanced result changed. allocateMessageQueueStrategyName=&#123;&#125;, group=&#123;&#125;, topic=&#123;&#125;, clientId=&#123;&#125;, mqAllSize=&#123;&#125;, cidAllSize=&#123;&#125;, rebalanceResultSize=&#123;&#125;, rebalanceResultSet=&#123;&#125;"</span>,</span><br><span class="line">                          strategy.getName(), consumerGroup, topic, <span class="keyword">this</span>.mQClientFactory.getClientId(), mqSet.size(), cidAll.size(),</span><br><span class="line">                          allocateResultSet.size(), allocateResultSet);</span><br><span class="line">                      <span class="comment">// å‘é€ä¸€æ¬¡å¿ƒè·³</span></span><br><span class="line">                      <span class="keyword">this</span>.messageQueueChanged(topic, mqSet, allocateResultSet);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">default</span>:</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæœ‰ä¸¤ä¸ªç‚¹é‡ç‚¹çœ‹çœ‹ï¼š</p>
<h3 id="Queueåˆ†é…ç­–ç•¥"><a href="#Queueåˆ†é…ç­–ç•¥" class="headerlink" title="Queueåˆ†é…ç­–ç•¥"></a>Queueåˆ†é…ç­–ç•¥</h3><p>æˆ‘ä»¬çœ‹è¿™ä¸ªæ–¹æ³•<code>AllocateMessageQueueStrategy#allocate()</code>ï¼Œä»–æœ‰ä¸‹é¢å‡ ç§å®ç°ï¼š</p>
<ul>
<li><p>AllocateMessageQueueAveragelyï¼šè¿™æ˜¯é»˜è®¤çš„åˆ†é…æ–¹å¼ï¼Œä¸€ä¸ªconsumeråˆ†åˆ°åœ¨å¹³å‡çš„æƒ…å†µä¸‹åˆ†åˆ°è¿ç»­çš„queueï¼Œå¾…ä¼šæˆ‘ä»¬ä¼šçœ‹çœ‹ä»£ç </p>
</li>
<li><p>AllocateMessageQueueAveragelyByCircleï¼š å’Œä¸Šé¢ç±»ä¼¼ï¼Œä½†æ˜¯åˆ†åˆ°çš„queueä¸æ˜¯è¿ç»­çš„ã€‚æ¯”å¦‚ä¸€å…±12ä¸ªQueueï¼Œ3ä¸ªconsumerï¼Œåˆ™ç¬¬ä¸€ä¸ªconsumeræ¥æ”¶queue1ï¼Œ4ï¼Œ7ï¼Œ9çš„æ¶ˆæ¯</p>
</li>
<li><p>AllocateMachineRoomNearbyï¼šå°†queueå…ˆæŒ‰ç…§brokeråˆ’åˆ†å‡ ä¸ªcomputer roomï¼Œä¸åŒçš„consumeråªæ¶ˆè´¹æŸå‡ ä¸ªbrokerä¸Šçš„æ¶ˆæ¯</p>
</li>
<li><p>AllocateMessageQueueByMachineRoomï¼šæ ¹æ®computer roomè¿›è¡Œhashåˆ†é…é˜Ÿåˆ—</p>
</li>
<li><p>AllocateMessageQueueByConfigï¼šåœ¨ç”¨æˆ·å¯åŠ¨æ—¶æŒ‡å®šæ¶ˆè´¹å“ªäº›Queueçš„æ¶ˆæ¯</p>
</li>
<li><p>AllocateMessageQueueConsistentHashï¼šä½¿ç”¨ä¸€è‡´æ€§hashç®—æ³•æ¥åˆ†é…Queueï¼Œç”¨æˆ·éœ€è‡ªå®šä¹‰è™šæ‹ŸèŠ‚ç‚¹çš„æ•°é‡</p>
</li>
</ul>
<p>ç„¶åä¸‹é¢æˆ‘ä»¬çœ‹çœ‹é»˜è®¤çš„<code>AllocateMessageQueueAveragely</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;MessageQueue&gt; <span class="title">allocate</span><span class="params">(String consumerGroup, String currentCID, List&lt;MessageQueue&gt; mqAll,</span></span></span><br><span class="line"><span class="function"><span class="params">    List&lt;String&gt; cidAll)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// çœç•¥...</span></span><br><span class="line">    <span class="keyword">int</span> index = cidAll.indexOf(currentCID);</span><br><span class="line">    <span class="keyword">int</span> mod = mqAll.size() % cidAll.size();</span><br><span class="line">    <span class="comment">// 1. mqæ•°é‡ &lt;= consumeræ•°é‡ï¼Œsize = 1</span></span><br><span class="line">    <span class="comment">// 2. å¦åˆ™ï¼Œsize = mqæ•°é‡ / consumeræ•°é‡ï¼Œä½™æ•°æ˜¯å‡ åˆ™å‰å‡ ä¸ªconsumerçš„size+1,è¿™æ ·æ‰€æœ‰çš„queueéƒ½ä¼šæœ‰consumeræ¶ˆè´¹</span></span><br><span class="line">    <span class="keyword">int</span> averageSize =</span><br><span class="line">        mqAll.size() &lt;= cidAll.size() ? <span class="number">1</span> : (mod &gt; <span class="number">0</span> &amp;&amp; index &lt; mod ? mqAll.size() / cidAll.size()</span><br><span class="line">            + <span class="number">1</span> : mqAll.size() / cidAll.size());</span><br><span class="line">    <span class="keyword">int</span> startIndex = (mod &gt; <span class="number">0</span> &amp;&amp; index &lt; mod) ? index * averageSize : index * averageSize + mod;</span><br><span class="line">    <span class="keyword">int</span> range = Math.min(averageSize, mqAll.size() - startIndex);</span><br><span class="line">    <span class="comment">// ä»ç¬¬ä¸€ä¸ªconsumerå¼€å§‹åˆ†é…ï¼Œæ¯ä¸ªåˆ†avgSizeä¸ªè¿ç»­çš„Queueï¼Œ</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; range; i++) &#123;</span><br><span class="line">        result.add(mqAll.get((startIndex + i) % mqAll.size()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æäº¤Pullè¯·æ±‚"><a href="#æäº¤Pullè¯·æ±‚" class="headerlink" title="æäº¤Pullè¯·æ±‚"></a>æäº¤Pullè¯·æ±‚</h3><p>ä¸Šé¢æˆ‘ä»¬è¯´è¿‡å¯¹äºæ–°åŠ å…¥çš„Queueï¼Œæäº¤ä¸€æ¬¡PullRequestï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥çœ‹çœ‹<code>org.apache.rocketmq.client.impl.consumer.RebalanceImpl#updateProcessQueueTableInRebalance</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">updateProcessQueueTableInRebalance</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> Set&lt;MessageQueue&gt; mqSet,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">final</span> <span class="keyword">boolean</span> isOrder)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">boolean</span> changed = <span class="keyword">false</span>;</span><br><span class="line">		<span class="comment">// çœç•¥</span></span><br><span class="line">      List&lt;PullRequest&gt; pullRequestList = <span class="keyword">new</span> ArrayList&lt;PullRequest&gt;();</span><br><span class="line">      <span class="keyword">for</span> (MessageQueue mq : mqSet) &#123;</span><br><span class="line">          <span class="comment">// å¦‚æœæ˜¯æ–°åŠ å…¥çš„Queue</span></span><br><span class="line">          <span class="keyword">if</span> (!<span class="keyword">this</span>.processQueueTable.containsKey(mq)) &#123;</span><br><span class="line">              <span class="keyword">if</span> (isOrder &amp;&amp; !<span class="keyword">this</span>.lock(mq)) &#123;</span><br><span class="line">                  log.warn(<span class="string">"doRebalance, &#123;&#125;, add a new mq failed, &#123;&#125;, because lock failed"</span>, consumerGroup, mq);</span><br><span class="line">                  <span class="keyword">continue</span>;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="comment">// ä»offset storeä¸­ç§»é™¤è¿‡æ—¶çš„æ•°æ®</span></span><br><span class="line">              <span class="keyword">this</span>.removeDirtyOffset(mq);</span><br><span class="line">              ProcessQueue pq = <span class="keyword">new</span> ProcessQueue();</span><br><span class="line">              <span class="comment">// è·å–èµ·å§‹æ¶ˆè´¹offset</span></span><br><span class="line">              <span class="keyword">long</span> nextOffset = <span class="keyword">this</span>.computePullFromWhere(mq);</span><br><span class="line">              <span class="keyword">if</span> (nextOffset &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                  <span class="comment">// ä¸ºæ–°çš„Queueåˆå§‹åŒ–ä¸€ä¸ªProcessQueueï¼Œç”¨æ¥ç¼“å­˜æ”¶åˆ°çš„æ¶ˆæ¯</span></span><br><span class="line">                  ProcessQueue pre = <span class="keyword">this</span>.processQueueTable.putIfAbsent(mq, pq);</span><br><span class="line">                  <span class="keyword">if</span> (pre != <span class="keyword">null</span>) &#123;</span><br><span class="line">                      log.info(<span class="string">"doRebalance, &#123;&#125;, mq already exists, &#123;&#125;"</span>, consumerGroup, mq);</span><br><span class="line">                  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                      log.info(<span class="string">"doRebalance, &#123;&#125;, add a new mq, &#123;&#125;"</span>, consumerGroup, mq);</span><br><span class="line">                      <span class="comment">// å¯¹æ–°åŠ çš„queueåˆå§‹åŒ–ä¸€ä¸ªPullRequest</span></span><br><span class="line">                      PullRequest pullRequest = <span class="keyword">new</span> PullRequest();</span><br><span class="line">                      pullRequest.setConsumerGroup(consumerGroup);</span><br><span class="line">                      pullRequest.setNextOffset(nextOffset);</span><br><span class="line">                      pullRequest.setMessageQueue(mq);</span><br><span class="line">                      pullRequest.setProcessQueue(pq);</span><br><span class="line">                      pullRequestList.add(pullRequest);</span><br><span class="line">                      changed = <span class="keyword">true</span>;</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  log.warn(<span class="string">"doRebalance, &#123;&#125;, add new mq failed, &#123;&#125;"</span>, consumerGroup, mq);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// åˆ†å‘pull requeståˆ°PullMessageServiceæ‹‰å–æ¶ˆæ¯</span></span><br><span class="line">      <span class="keyword">this</span>.dispatchPullRequest(pullRequestList);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> changed;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// org.apache.rocketmq.client.impl.consumer.RebalancePushImpl</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatchPullRequest</span><span class="params">(List&lt;PullRequest&gt; pullRequestList)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">for</span> (PullRequest pullRequest : pullRequestList) &#123;</span><br><span class="line">        	<span class="comment">// æ‰§è¡Œæ‹‰å–æ¶ˆæ¯</span></span><br><span class="line">          <span class="keyword">this</span>.defaultMQPushConsumerImpl.executePullRequestImmediately(pullRequest);</span><br><span class="line">          log.info(<span class="string">"doRebalance, &#123;&#125;, add a new pull request &#123;&#125;"</span>, consumerGroup, pullRequest);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// org.apache.rocketmq.client.impl.consumer.DefaultMQPushConsumerImpl</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executePullRequestImmediately</span><span class="params">(<span class="keyword">final</span> PullRequest pullRequest)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.mQClientFactory.getPullMessageService().executePullRequestImmediately(pullRequest);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// org.apache.rocketmq.client.impl.consumer.PullMessageService</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executePullRequestImmediately</span><span class="params">(<span class="keyword">final</span> PullRequest pullRequest)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        	<span class="comment">// å°†pull request æ”¾å…¥åˆ°pullRequestQueueä¸­</span></span><br><span class="line">          <span class="keyword">this</span>.pullRequestQueue.put(pullRequest);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">          log.error(<span class="string">"executePullRequestImmediately pullRequestQueue.put"</span>, e);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h2 id="æ¶ˆæ¯æ‹‰å–æœåŠ¡"><a href="#æ¶ˆæ¯æ‹‰å–æœåŠ¡" class="headerlink" title="æ¶ˆæ¯æ‹‰å–æœåŠ¡"></a>æ¶ˆæ¯æ‹‰å–æœåŠ¡</h2><p>æˆ‘ä»¬åœ¨MQClientInstanceå¯åŠ¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬çœ‹åˆ°æˆ‘ä»¬å¯åŠ¨äº†ä¸€ä¸ªæ¶ˆæ¯æ‹‰å–çš„å®šæ—¶æœåŠ¡ã€‚è¿™é‡Œæˆ‘ä»¬ä¹Ÿå°±çŸ¥é“å…¶å®<code>PullMessageService</code>ä¹Ÿæ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œæˆ‘ä»¬å…ˆçœ‹runæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">// org.apache.rocketmq.client.impl.consumer.PullMessageService</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      log.info(<span class="keyword">this</span>.getServiceName() + <span class="string">" service started"</span>);</span><br><span class="line">      <span class="keyword">while</span> (!<span class="keyword">this</span>.isStopped()) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            	<span class="comment">// å–pull request è¿›è¡Œæ‹‰å–</span></span><br><span class="line">              PullRequest pullRequest = <span class="keyword">this</span>.pullRequestQueue.take();</span><br><span class="line">              <span class="keyword">this</span>.pullMessage(pullRequest);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (InterruptedException ignored) &#123;</span><br><span class="line">          &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">              log.error(<span class="string">"Pull Message Service Run Method exception"</span>, e);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      log.info(<span class="keyword">this</span>.getServiceName() + <span class="string">" service end"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">pullMessage</span><span class="params">(<span class="keyword">final</span> PullRequest pullRequest)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">final</span> MQConsumerInner consumer = <span class="keyword">this</span>.mQClientFactory.selectConsumer(pullRequest.getConsumerGroup());</span><br><span class="line">      <span class="keyword">if</span> (consumer != <span class="keyword">null</span>) &#123;</span><br><span class="line">          DefaultMQPushConsumerImpl impl = (DefaultMQPushConsumerImpl) consumer;</span><br><span class="line">        	<span class="comment">// å®è´¨</span></span><br><span class="line">          impl.pullMessage(pullRequest);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          log.warn(<span class="string">"No matched consumer for the PullRequest &#123;&#125;, drop it"</span>, pullRequest);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.apache.rocketmq.client.impl.consumer.DefaultMQPushConsumerImpl</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pullMessage</span><span class="params">(<span class="keyword">final</span> PullRequest pullRequest)</span> </span>&#123;</span><br><span class="line">      <span class="comment">// æ‹¿åˆ°ç¼“å­˜æ¶ˆæ¯çš„é˜Ÿåˆ—</span></span><br><span class="line">      <span class="keyword">final</span> ProcessQueue processQueue = pullRequest.getProcessQueue();</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">    </span><br><span class="line">      <span class="comment">// è®¾ç½®æ‹‰å–æ—¶é—´æˆ³</span></span><br><span class="line">      pullRequest.getProcessQueue().setLastPullTimestamp(System.currentTimeMillis());</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">    </span><br><span class="line">      <span class="comment">// æŸ¥çœ‹æ¶ˆæ¯ç¼“å­˜é˜Ÿåˆ—çš„æ¶ˆæ¯æ•°é‡ä»¥åŠå¤§å°</span></span><br><span class="line">      <span class="keyword">long</span> cachedMessageCount = processQueue.getMsgCount().get();</span><br><span class="line">      <span class="keyword">long</span> cachedMessageSizeInMiB = processQueue.getMsgSize().get() / (<span class="number">1024</span> * <span class="number">1024</span>);</span><br><span class="line">      <span class="comment">// å¦‚æœå †ç§¯æœªå¤„ç†çš„æ¶ˆæ¯æ•°é‡è¿‡å¤š(å¤§äºé»˜è®¤1000æ¡)ï¼Œåˆ™æ”¾å›pull requesté˜Ÿåˆ—,å»¶æ—¶æ‰§è¡Œï¼ˆé»˜è®¤50msï¼‰</span></span><br><span class="line">      <span class="keyword">if</span> (cachedMessageCount &gt; <span class="keyword">this</span>.defaultMQPushConsumer.getPullThresholdForQueue()) &#123;</span><br><span class="line">          <span class="keyword">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL);</span><br><span class="line">          <span class="comment">// ...</span></span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// å¦‚æœå †ç§¯æœªå¤„ç†çš„æ¶ˆæ¯çš„å¤§å°è¿‡å¤§ï¼ˆå¤§äº100MBï¼‰ï¼ŒåŒä¸Šé¢çš„é€»è¾‘</span></span><br><span class="line">      <span class="keyword">if</span> (cachedMessageSizeInMiB &gt; <span class="keyword">this</span>.defaultMQPushConsumer.getPullThresholdSizeForQueue()) &#123;</span><br><span class="line">          <span class="keyword">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL);</span><br><span class="line">          <span class="comment">// ...</span></span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// æ— åºæ¶ˆæ¯ï¼Œæ¶ˆæ¯offsetè·¨åº¦è¿‡å¤§ï¼ŒåŒä¸Šé¢çš„é€»è¾‘</span></span><br><span class="line">      <span class="keyword">if</span> (!<span class="keyword">this</span>.consumeOrderly) &#123;</span><br><span class="line">          <span class="keyword">if</span> (processQueue.getMaxSpan() &gt; <span class="keyword">this</span>.defaultMQPushConsumer.getConsumeConcurrentlyMaxSpan()) &#123;</span><br><span class="line">              <span class="keyword">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL);</span><br><span class="line">              <span class="comment">// ...</span></span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// ...</span></span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// æ£€æŸ¥è®¢é˜…å…³ç³»æœ‰æ²¡æœ‰å˜åŒ–ï¼Œæœ‰å¯èƒ½åœ¨å»¶æ—¶æœŸé—´ï¼Œtopicæˆ–è€…consumerçš„é…ç½®éƒ½å‘ç”Ÿäº†å˜åŒ–ï¼Œéœ€è¦é‡æ–°å¤„ç†</span></span><br><span class="line">      <span class="keyword">final</span> SubscriptionData subscriptionData = <span class="keyword">this</span>.rebalanceImpl.getSubscriptionInner().get(pullRequest.getMessageQueue().getTopic());</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">null</span> == subscriptionData) &#123;</span><br><span class="line">          <span class="keyword">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);</span><br><span class="line">          log.warn(<span class="string">"find the consumer's subscription failed, &#123;&#125;"</span>, pullRequest);</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">long</span> beginTimestamp = System.currentTimeMillis();</span><br><span class="line">      <span class="comment">// Pull Commandå‘é€åçš„å›è°ƒ</span></span><br><span class="line">      PullCallback pullCallback = <span class="keyword">new</span> PullCallback() &#123;</span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(PullResult pullResult)</span> </span>&#123;</span><br><span class="line">              <span class="keyword">if</span> (pullResult != <span class="keyword">null</span>) &#123;</span><br><span class="line">                  <span class="comment">// æ¶ˆæ¯é¢„å¤„ç†ï¼Œå®¢æˆ·ç«¯å†æ¬¡è¿‡æ»¤ï¼Œè®¾ç½®minOffsetå’ŒmaxOffset</span></span><br><span class="line">                  pullResult = DefaultMQPushConsumerImpl.<span class="keyword">this</span>.pullAPIWrapper.processPullResult(pullRequest.getMessageQueue(), pullResult,</span><br><span class="line">                      subscriptionData);</span><br><span class="line"></span><br><span class="line">                  <span class="keyword">switch</span> (pullResult.getPullStatus()) &#123;</span><br><span class="line">                      <span class="keyword">case</span> FOUND:</span><br><span class="line">                          <span class="keyword">long</span> prevRequestOffset = pullRequest.getNextOffset();</span><br><span class="line">                          pullRequest.setNextOffset(pullResult.getNextBeginOffset());</span><br><span class="line">                          <span class="keyword">long</span> pullRT = System.currentTimeMillis() - beginTimestamp;</span><br><span class="line">                          DefaultMQPushConsumerImpl.<span class="keyword">this</span>.getConsumerStatsManager().incPullRT(pullRequest.getConsumerGroup(),</span><br><span class="line">                              pullRequest.getMessageQueue().getTopic(), pullRT);</span><br><span class="line"></span><br><span class="line">                          <span class="keyword">long</span> firstMsgOffset = Long.MAX_VALUE;</span><br><span class="line">                          <span class="comment">// å¦‚æœè·å–åˆ°çš„æ¶ˆæ¯æ•°ä¸º0ï¼Œåˆ™ç«‹å³å‘èµ·ä¸‹ä¸€æ¬¡pull</span></span><br><span class="line">                          <span class="keyword">if</span> (pullResult.getMsgFoundList() == <span class="keyword">null</span> || pullResult.getMsgFoundList().isEmpty()) &#123;</span><br><span class="line">                              DefaultMQPushConsumerImpl.<span class="keyword">this</span>.executePullRequestImmediately(pullRequest);</span><br><span class="line">                          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                              firstMsgOffset = pullResult.getMsgFoundList().get(<span class="number">0</span>).getQueueOffset();</span><br><span class="line"></span><br><span class="line">                              DefaultMQPushConsumerImpl.<span class="keyword">this</span>.getConsumerStatsManager().incPullTPS(pullRequest.getConsumerGroup(),</span><br><span class="line">                                  pullRequest.getMessageQueue().getTopic(), pullResult.getMsgFoundList().size());</span><br><span class="line">                              <span class="comment">// æ¶ˆæ¯æ”¾å…¥ProcessQueue</span></span><br><span class="line">                              <span class="keyword">boolean</span> dispatchToConsume = processQueue.putMessage(pullResult.getMsgFoundList());</span><br><span class="line">                              <span class="comment">// æ¶ˆè´¹æ¶ˆæ¯æœåŠ¡ï¼ˆçº¿ç¨‹æ± ï¼‰ï¼Œè°ƒç”¨messageListenerå¤„ç†ï¼Œå¤„ç†å®Œæˆä¼šé€šçŸ¥ProcessQueue</span></span><br><span class="line">                              DefaultMQPushConsumerImpl.<span class="keyword">this</span>.consumeMessageService.submitConsumeRequest(</span><br><span class="line">                                  pullResult.getMsgFoundList(),</span><br><span class="line">                                  processQueue,</span><br><span class="line">                                  pullRequest.getMessageQueue(),</span><br><span class="line">                                  dispatchToConsume);</span><br><span class="line">                              <span class="comment">// å†æ¬¡æäº¤pull request</span></span><br><span class="line">                              <span class="keyword">if</span> (DefaultMQPushConsumerImpl.<span class="keyword">this</span>.defaultMQPushConsumer.getPullInterval() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                  DefaultMQPushConsumerImpl.<span class="keyword">this</span>.executePullRequestLater(pullRequest,</span><br><span class="line">                                      DefaultMQPushConsumerImpl.<span class="keyword">this</span>.defaultMQPushConsumer.getPullInterval());</span><br><span class="line">                              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                  DefaultMQPushConsumerImpl.<span class="keyword">this</span>.executePullRequestImmediately(pullRequest);</span><br><span class="line">                              &#125;</span><br><span class="line">                          &#125;</span><br><span class="line"></span><br><span class="line">                          <span class="keyword">if</span> (pullResult.getNextBeginOffset() &lt; prevRequestOffset</span><br><span class="line">                              || firstMsgOffset &lt; prevRequestOffset) &#123;</span><br><span class="line">                              log.warn(</span><br><span class="line">                                  <span class="string">"[BUG] pull message result maybe data wrong, nextBeginOffset: &#123;&#125; firstMsgOffset: &#123;&#125; prevRequestOffset: &#123;&#125;"</span>,</span><br><span class="line">                                  pullResult.getNextBeginOffset(),</span><br><span class="line">                                  firstMsgOffset,</span><br><span class="line">                                  prevRequestOffset);</span><br><span class="line">                          &#125;</span><br><span class="line"></span><br><span class="line">                          <span class="keyword">break</span>;</span><br><span class="line">                      <span class="keyword">case</span> NO_NEW_MSG:</span><br><span class="line">                          <span class="comment">// ...</span></span><br><span class="line">                          <span class="keyword">break</span>;</span><br><span class="line">                      <span class="keyword">case</span> OFFSET_ILLEGAL:</span><br><span class="line">                          <span class="comment">// ...</span></span><br><span class="line">                          <span class="keyword">break</span>;</span><br><span class="line">                      <span class="keyword">default</span>:</span><br><span class="line">                          <span class="keyword">break</span>;</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// ...</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// è°ƒç”¨Nettyå»å‘é€Pull Commandï¼Œå…¶å®è¿™åé¢å°±å’Œç”Ÿäº§è€…å‘é€æ¶ˆæ¯æ˜¯ä¸€æ ·çš„ï¼Œä¸è¿‡è¿™é‡Œæ˜¯å¼‚æ­¥å‘é€æ¶ˆæ¯</span></span><br><span class="line">        	<span class="comment">// å¼‚æ­¥å®Œæˆä¹‹åä¼šæ‰§è¡ŒpullCallback</span></span><br><span class="line">          <span class="keyword">this</span>.pullAPIWrapper.pullKernelImpl(</span><br><span class="line">              pullRequest.getMessageQueue(),</span><br><span class="line">              subExpression,</span><br><span class="line">              subscriptionData.getExpressionType(),</span><br><span class="line">              subscriptionData.getSubVersion(),</span><br><span class="line">              pullRequest.getNextOffset(),</span><br><span class="line">              <span class="keyword">this</span>.defaultMQPushConsumer.getPullBatchSize(),</span><br><span class="line">              sysFlag,</span><br><span class="line">              commitOffsetValue,</span><br><span class="line">              BROKER_SUSPEND_MAX_TIME_MILLIS,</span><br><span class="line">              CONSUMER_TIMEOUT_MILLIS_WHEN_SUSPEND,</span><br><span class="line">              CommunicationMode.ASYNC,</span><br><span class="line">              pullCallback</span><br><span class="line">          );</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">          log.error(<span class="string">"pullKernelImpl exception"</span>, e);</span><br><span class="line">          <span class="keyword">this</span>.executePullRequestLater(pullRequest, PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h2 id="æ¶ˆæ¯æ¶ˆè´¹-1"><a href="#æ¶ˆæ¯æ¶ˆè´¹-1" class="headerlink" title="æ¶ˆæ¯æ¶ˆè´¹"></a>æ¶ˆæ¯æ¶ˆè´¹</h2><p>ä¸Šé¢æˆ‘ä»¬å·²ç»è¯´è¿‡äº†å½“æ¶ˆæ¯æ‹‰å–å®Œä¹‹åä¼šæ‰§è¡ŒPullCallbackï¼Œå…·ä½“ä¸€ç‚¹å°±æ˜¯ä¼šæ‰§è¡Œåˆ°<code>org.apache.rocketmq.client.impl.consumer.ConsumeMessageConcurrentlyService.submitConsumeRequest()</code>ï¼Œæˆ‘ä»¬çœ‹çœ‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">// org.apache.rocketmq.client.impl.consumer.ConsumeMessageConcurrentlyService</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">submitConsumeRequest</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">final</span> List&lt;MessageExt&gt; msgs,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">final</span> ProcessQueue processQueue,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">final</span> MessageQueue messageQueue,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">final</span> <span class="keyword">boolean</span> dispatchToConsume)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">int</span> consumeBatchSize = <span class="keyword">this</span>.defaultMQPushConsumer.getConsumeMessageBatchMaxSize();</span><br><span class="line">      <span class="comment">// çœ‹æ˜¯å¦éœ€è¦æ‰¹é‡æ¶ˆè´¹ï¼Œé»˜è®¤é˜ˆå€¼æ˜¯1</span></span><br><span class="line">      <span class="keyword">if</span> (msgs.size() &lt;= consumeBatchSize) &#123;</span><br><span class="line">          <span class="comment">// åˆ›å»ºä¸€ä¸ªæ¶ˆè´¹ä»»åŠ¡</span></span><br><span class="line">          ConsumeRequest consumeRequest = <span class="keyword">new</span> ConsumeRequest(msgs, processQueue, messageQueue);</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="keyword">this</span>.consumeExecutor.submit(consumeRequest);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (RejectedExecutionException e) &#123;</span><br><span class="line">              <span class="keyword">this</span>.submitConsumeRequestLater(consumeRequest);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// åˆ›å»ºæ‰¹é‡æ¶ˆè´¹ä»»åŠ¡</span></span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">int</span> total = <span class="number">0</span>; total &lt; msgs.size(); ) &#123;</span><br><span class="line">              List&lt;MessageExt&gt; msgThis = <span class="keyword">new</span> ArrayList&lt;MessageExt&gt;(consumeBatchSize);</span><br><span class="line">              <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; consumeBatchSize; i++, total++) &#123;</span><br><span class="line">                  <span class="keyword">if</span> (total &lt; msgs.size()) &#123;</span><br><span class="line">                      msgThis.add(msgs.get(total));</span><br><span class="line">                  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                      <span class="keyword">break</span>;</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              ConsumeRequest consumeRequest = <span class="keyword">new</span> ConsumeRequest(msgThis, processQueue, messageQueue);</span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">                  <span class="keyword">this</span>.consumeExecutor.submit(consumeRequest);</span><br><span class="line">              &#125; <span class="keyword">catch</span> (RejectedExecutionException e) &#123;</span><br><span class="line">                  <span class="keyword">for</span> (; total &lt; msgs.size(); total++) &#123;</span><br><span class="line">                      msgThis.add(msgs.get(total));</span><br><span class="line">                  &#125;</span><br><span class="line"></span><br><span class="line">                  <span class="keyword">this</span>.submitConsumeRequestLater(consumeRequest);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”±äºConsumeRequestæ˜¯ä¸€ä¸ªä»»åŠ¡ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥çœ‹çœ‹å®ƒçš„runæ–¹æ³•</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">				<span class="comment">// ...</span></span><br><span class="line">          <span class="comment">// å¾—åˆ°æ”¹æ¶ˆæ¯çš„Listener</span></span><br><span class="line">          MessageListenerConcurrently listener = ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.messageListener;</span><br><span class="line">          ConsumeConcurrentlyContext context = <span class="keyword">new</span> ConsumeConcurrentlyContext(messageQueue);</span><br><span class="line">          ConsumeConcurrentlyStatus status = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">          ConsumeMessageContext consumeMessageContext = <span class="keyword">null</span>;</span><br><span class="line">          <span class="keyword">if</span> (ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.defaultMQPushConsumerImpl.hasHook()) &#123;</span><br><span class="line">              consumeMessageContext = <span class="keyword">new</span> ConsumeMessageContext();</span><br><span class="line">              consumeMessageContext.setConsumerGroup(defaultMQPushConsumer.getConsumerGroup());</span><br><span class="line">              consumeMessageContext.setProps(<span class="keyword">new</span> HashMap&lt;String, String&gt;());</span><br><span class="line">              consumeMessageContext.setMq(messageQueue);</span><br><span class="line">              consumeMessageContext.setMsgList(msgs);</span><br><span class="line">              consumeMessageContext.setSuccess(<span class="keyword">false</span>);</span><br><span class="line">              ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.defaultMQPushConsumerImpl.executeHookBefore(consumeMessageContext);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">long</span> beginTimestamp = System.currentTimeMillis();</span><br><span class="line">          <span class="keyword">boolean</span> hasException = <span class="keyword">false</span>;</span><br><span class="line">          ConsumeReturnType returnType = ConsumeReturnType.SUCCESS;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.resetRetryTopic(msgs);</span><br><span class="line">              <span class="keyword">if</span> (msgs != <span class="keyword">null</span> &amp;&amp; !msgs.isEmpty()) &#123;</span><br><span class="line">                  <span class="keyword">for</span> (MessageExt msg : msgs) &#123;</span><br><span class="line">                      MessageAccessor.setConsumeStartTimeStamp(msg, String.valueOf(System.currentTimeMillis()));</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="comment">// listeneræ‰§è¡Œå›è°ƒé€»è¾‘</span></span><br><span class="line">              status = listener.consumeMessage(Collections.unmodifiableList(msgs), context);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">              log.warn(<span class="string">"consumeMessage exception: &#123;&#125; Group: &#123;&#125; Msgs: &#123;&#125; MQ: &#123;&#125;"</span>,</span><br><span class="line">                  RemotingHelper.exceptionSimpleDesc(e),</span><br><span class="line">                  ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.consumerGroup,</span><br><span class="line">                  msgs,</span><br><span class="line">                  messageQueue);</span><br><span class="line">              hasException = <span class="keyword">true</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">long</span> consumeRT = System.currentTimeMillis() - beginTimestamp;</span><br><span class="line">        	<span class="comment">// è®¾ç½®æ¶ˆè´¹ç»“æœ</span></span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">null</span> == status) &#123;</span><br><span class="line">              <span class="keyword">if</span> (hasException) &#123;</span><br><span class="line">                  returnType = ConsumeReturnType.EXCEPTION;</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  returnType = ConsumeReturnType.RETURNNULL;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (consumeRT &gt;= defaultMQPushConsumer.getConsumeTimeout() * <span class="number">60</span> * <span class="number">1000</span>) &#123;</span><br><span class="line">              returnType = ConsumeReturnType.TIME_OUT;</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ConsumeConcurrentlyStatus.RECONSUME_LATER == status) &#123;</span><br><span class="line">              returnType = ConsumeReturnType.FAILED;</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ConsumeConcurrentlyStatus.CONSUME_SUCCESS == status) &#123;</span><br><span class="line">              returnType = ConsumeReturnType.SUCCESS;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.defaultMQPushConsumerImpl.hasHook()) &#123;</span><br><span class="line">              consumeMessageContext.getProps().put(MixAll.CONSUME_CONTEXT_TYPE, returnType.name());</span><br><span class="line">          &#125;</span><br><span class="line">				<span class="comment">// ...</span></span><br><span class="line">          <span class="keyword">if</span> (!processQueue.isDropped()) &#123;</span><br><span class="line">              <span class="comment">// å¤„ç†æ¶ˆè´¹ç»“æœ</span></span><br><span class="line">              ConsumeMessageConcurrentlyService.<span class="keyword">this</span>.processConsumeResult(status, context, <span class="keyword">this</span>);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              log.warn(<span class="string">"processQueue is dropped without process consume result. messageQueue=&#123;&#125;, msgs=&#123;&#125;"</span>, messageQueue, msgs);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">// org.apache.rocketmq.client.impl.consumer.ConsumeMessageConcurrentlyService</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processConsumeResult</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">final</span> ConsumeConcurrentlyStatus status,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">final</span> ConsumeConcurrentlyContext context,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">final</span> ConsumeRequest consumeRequest</span></span></span><br><span class="line"><span class="function"><span class="params">  )</span> </span>&#123;</span><br><span class="line">      <span class="keyword">int</span> ackIndex = context.getAckIndex();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (consumeRequest.getMsgs().isEmpty())</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">      <span class="comment">// è®¾ç½®æ¶ˆè´¹çŠ¶æ€</span></span><br><span class="line">      <span class="keyword">switch</span> (status) &#123;</span><br><span class="line">          <span class="comment">// æ¶ˆè´¹æˆåŠŸ</span></span><br><span class="line">          <span class="keyword">case</span> CONSUME_SUCCESS:</span><br><span class="line">              <span class="keyword">if</span> (ackIndex &gt;= consumeRequest.getMsgs().size()) &#123;</span><br><span class="line">                  ackIndex = consumeRequest.getMsgs().size() - <span class="number">1</span>;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">int</span> ok = ackIndex + <span class="number">1</span>;</span><br><span class="line">              <span class="keyword">int</span> failed = consumeRequest.getMsgs().size() - ok;</span><br><span class="line">              <span class="keyword">this</span>.getConsumerStatsManager().incConsumeOKTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), ok);</span><br><span class="line">              <span class="keyword">this</span>.getConsumerStatsManager().incConsumeFailedTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), failed);</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">          <span class="comment">// é‡æ–°æ¶ˆè´¹</span></span><br><span class="line">          <span class="keyword">case</span> RECONSUME_LATER:</span><br><span class="line">              ackIndex = -<span class="number">1</span>;</span><br><span class="line">              <span class="keyword">this</span>.getConsumerStatsManager().incConsumeFailedTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(),</span><br><span class="line">                  consumeRequest.getMsgs().size());</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">default</span>:</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">switch</span> (<span class="keyword">this</span>.defaultMQPushConsumer.getMessageModel()) &#123;</span><br><span class="line">          <span class="comment">// broadcastæ¨¡å¼ï¼Œå¤„ç†å¤±è´¥ï¼Œä¸åšå¤„ç†</span></span><br><span class="line">          <span class="keyword">case</span> BROADCASTING:</span><br><span class="line">              <span class="keyword">for</span> (<span class="keyword">int</span> i = ackIndex + <span class="number">1</span>; i &lt; consumeRequest.getMsgs().size(); i++) &#123;</span><br><span class="line">                  MessageExt msg = consumeRequest.getMsgs().get(i);</span><br><span class="line">                  log.warn(<span class="string">"BROADCASTING, the message consume failed, drop it, &#123;&#125;"</span>, msg.toString());</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> CLUSTERING:</span><br><span class="line">              List&lt;MessageExt&gt; msgBackFailed = <span class="keyword">new</span> ArrayList&lt;MessageExt&gt;(consumeRequest.getMsgs().size());</span><br><span class="line">              <span class="keyword">for</span> (<span class="keyword">int</span> i = ackIndex + <span class="number">1</span>; i &lt; consumeRequest.getMsgs().size(); i++) &#123;</span><br><span class="line">                  MessageExt msg = consumeRequest.getMsgs().get(i);</span><br><span class="line">                  <span class="comment">// Clusteræ¨¡å¼ï¼Œå°†æ¶ˆæ¯å‘å›brokerï¼Œè®©brokeré‡æ–°å‘é€</span></span><br><span class="line">                  <span class="comment">// ä¸€å…±æœ‰ä¸¤ç§æ–¹å¼è®©brokeré‡å‘(æœ‰å…´è¶£è‡ªå·±å»çœ‹çœ‹): </span></span><br><span class="line">                  <span class="comment">// 1. å…ˆå°è¯•ç»™brokerå‘é€send_msg_backçš„å‘½ä»¤ï¼Œ</span></span><br><span class="line">                  <span class="comment">// 2. å¦‚æœå¤±è´¥äº†ï¼Œåˆ™é€šè¿‡consumeré¢„ç•™çš„producerç»™%RETRY%groupnameå‘é€æ¶ˆæ¯ï¼Œç­‰äºæ˜¯è‡ªå·±ç»™è‡ªå·±å‘ä¸€æ¡æ¶ˆæ¯ã€‚</span></span><br><span class="line">                  <span class="keyword">boolean</span> result = <span class="keyword">this</span>.sendMessageBack(msg, context);</span><br><span class="line">                  <span class="keyword">if</span> (!result) &#123;</span><br><span class="line">                      msg.setReconsumeTimes(msg.getReconsumeTimes() + <span class="number">1</span>);</span><br><span class="line">                      msgBackFailed.add(msg);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              <span class="keyword">if</span> (!msgBackFailed.isEmpty()) &#123;</span><br><span class="line">                  consumeRequest.getMsgs().removeAll(msgBackFailed);</span><br><span class="line">                  <span class="comment">// å‘å›brokerå¤±è´¥ï¼Œåˆ™å†æ¬¡å°è¯•æœ¬åœ°æ¶ˆè´¹</span></span><br><span class="line">                  <span class="keyword">this</span>.submitConsumeRequestLater(msgBackFailed, consumeRequest.getProcessQueue(), consumeRequest.getMessageQueue());</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">default</span>:</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// å°†æ¶ˆè´¹å‰ç¼“å­˜çš„æ¶ˆæ¯æ¸…é™¤</span></span><br><span class="line">      <span class="keyword">long</span> offset = consumeRequest.getProcessQueue().removeMessage(consumeRequest.getMsgs());</span><br><span class="line">      <span class="keyword">if</span> (offset &gt;= <span class="number">0</span> &amp;&amp; !consumeRequest.getProcessQueue().isDropped()) &#123;</span><br><span class="line">          <span class="keyword">this</span>.defaultMQPushConsumerImpl.getOffsetStore().updateOffset(consumeRequest.getMessageQueue(), offset, <span class="keyword">true</span>);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬ä¹ŸåŸºæœ¬ä¸Šå§æ¶ˆæ¯æ¶ˆè´¹çš„æµç¨‹èµ°å®Œäº†ï¼Œ ç°åœ¨å¯ä»¥å†å›å¤´çœ‹çœ‹æµç¨‹å›¾ï¼Œå¦‚æœèƒ½å¯¹çš„ä¸Šå°±OKå•¦ï¼</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol>
<li><a href="https://www.jianshu.com/p/dd2202cc22ea" target="_blank" rel="noopener">RocketMQæºç è§£æ(å››)-Consumer</a></li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¼•ï¼šå½“æ¶ˆæ¯è¾¾åˆ°Brokerä¹‹åï¼Œå°±ç­‰ç€Consumerå»consumeäº†å‘€~
    
    </summary>
    
      <category term="RocketMQæºç " scheme="http://bestlixiang.site/categories/RocketMQ%E6%BA%90%E7%A0%81/"/>
    
    
      <category term="RocketMQ" scheme="http://bestlixiang.site/tags/RocketMQ/"/>
    
  </entry>
  
  <entry>
    <title>Seataæºç è§£æâ€”â€”ç¯å¢ƒæ­å»º</title>
    <link href="http://bestlixiang.site/2019/06/16/Seata%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/Seata%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E2%80%94%E2%80%94%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"/>
    <id>http://bestlixiang.site/2019/06/16/Seataæºç åˆ†æ/Seataæºç è§£æâ€”â€”ç¯å¢ƒæ­å»º/</id>
    <published>2019-06-16T02:18:22.000Z</published>
    <updated>2019-06-16T02:22:00.631Z</updated>
    
    <content type="html"><![CDATA[<p>å¼•ï¼š2019 å¹´ 1 æœˆï¼Œé˜¿é‡Œå·´å·´ä¸­é—´ä»¶å›¢é˜Ÿå‘èµ·äº†å¼€æºé¡¹ç›® <strong>Fescarï¼ˆFast &amp; EaSy Commit And Rollbackï¼‰</strong>ï¼Œå’Œç¤¾åŒºä¸€èµ·å…±å»ºå¼€æºåˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆã€‚Fescar çš„æ„¿æ™¯æ˜¯è®©åˆ†å¸ƒå¼äº‹åŠ¡çš„ä½¿ç”¨åƒæœ¬åœ°äº‹åŠ¡çš„ä½¿ç”¨ä¸€æ ·ï¼Œç®€å•å’Œé«˜æ•ˆï¼Œå¹¶é€æ­¥è§£å†³å¼€å‘è€…ä»¬é‡åˆ°çš„åˆ†å¸ƒå¼äº‹åŠ¡æ–¹é¢çš„æ‰€æœ‰éš¾é¢˜ã€‚ä¸ºäº†æ‰“é€ æ›´ä¸­ç«‹ã€æ›´å¼€æ”¾ã€ç”Ÿæ€æ›´åŠ ä¸°å¯Œçš„åˆ†å¸ƒå¼äº‹åŠ¡å¼€æºç¤¾åŒºï¼Œç»è¿‡ç¤¾åŒºæ ¸å¿ƒæˆå‘˜çš„æŠ•ç¥¨ï¼Œå¤§å®¶å†³å®šå¯¹ <strong>Fescar </strong>è¿›è¡Œå“ç‰Œå‡çº§ï¼Œå¹¶æ›´åä¸º <strong>Seata</strong>ï¼Œæ„ä¸ºï¼š<strong>Simple Extensible Autonomous Transaction Architecture</strong>ï¼Œæ˜¯ä¸€å¥—ä¸€ç«™å¼<strong>åˆ†å¸ƒå¼äº‹åŠ¡</strong>è§£å†³æ–¹æ¡ˆã€‚<a id="more"></a></p>
<h1 id="å‰ç½®"><a href="#å‰ç½®" class="headerlink" title="å‰ç½®"></a>å‰ç½®</h1><p>è¿˜æ˜¯é‚£å¥è¯ï¼š<br><strong>æºç ï¼Œæ˜¯åŸç†çš„å…·è±¡åŒ–</strong><br><strong>åŸç†ï¼Œæ˜¯ä»£ç çš„æŠ½è±¡åŒ–</strong></p>
<p>æ‰€ä»¥åœ¨å¼€å§‹çœ‹æºç å‰ä¸€å®šè¦å¥½å¥½äº†è§£Seataçš„ä½¿ç”¨æ–¹å¼ä»¥åŠåŸç†ï¼Œå–œæ¬¢Seataçš„<a href="https://github.com/seata/seata/wiki" target="_blank" rel="noopener">wiki</a>ã€‚</p>
<h1 id="ä¾èµ–å·¥å…·"><a href="#ä¾èµ–å·¥å…·" class="headerlink" title="ä¾èµ–å·¥å…·"></a>ä¾èµ–å·¥å…·</h1><ol>
<li>Git</li>
<li>Maven</li>
<li>JDK1.8</li>
<li>IntelliJ IDEA</li>
<li>Mysql</li>
</ol>
<h1 id="æºç æ‹‰å–"><a href="#æºç æ‹‰å–" class="headerlink" title="æºç æ‹‰å–"></a>æºç æ‹‰å–</h1><p>å¥½åƒæ˜¯åœ¨fescarå‡çº§åˆ°seataçš„æ—¶å€™ï¼Œé¡¹ç›®å°†samplesæŠ½å‡ºæˆä¸€ä¸ªç‹¬ç«‹çš„é¡¹ç›®äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ‹‰ä¸¤ä¸ªå·¥ç¨‹çš„ä»£ç ï¼š</p>
<ol>
<li><a href="https://github.com/seata/seata" target="_blank" rel="noopener">seata</a></li>
<li><a href="https://github.com/seata/seata-samples" target="_blank" rel="noopener">seata-samples</a></li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/seata/seata.git</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/seata/seata-samples.git</span><br></pre></td></tr></table></figure>
<h1 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h1><h2 id="å¯åŠ¨Seata-Server"><a href="#å¯åŠ¨Seata-Server" class="headerlink" title="å¯åŠ¨Seata Server"></a>å¯åŠ¨Seata Server</h2><p>åœ¨seataå·¥ç¨‹ä¸­æ‰¾åˆ°<code>io.seata.server.Server</code>ï¼Œç›´æ¥ç‚¹å‡»è¿è¡Œmainæ–¹æ³•å³å¯ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚ä¸‹è¾“å‡ºæ—¥å¿—ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2019-06-16 09:11:11.542 INFO [main]io.seata.core.rpc.netty.AbstractRpcRemotingServer.start:176 -Server started ...</span><br></pre></td></tr></table></figure>
<h2 id="å¯åŠ¨Seata-samples"><a href="#å¯åŠ¨Seata-samples" class="headerlink" title="å¯åŠ¨Seata-samples"></a>å¯åŠ¨Seata-samples</h2><p>seata-samplesé¡¹ç›®ä¸­æä¾›äº†å„ç§Demoï¼Œæˆ‘ä»¬è¿™é‡Œé€‰æ‹©æœ€ç®€å•çš„ä¸€ç§å¥½äº†â€”â€”dubboã€‚</p>
<h3 id="åˆå§‹åŒ–æ•°æ®åº“"><a href="#åˆå§‹åŒ–æ•°æ®åº“" class="headerlink" title="åˆå§‹åŒ–æ•°æ®åº“"></a>åˆå§‹åŒ–æ•°æ®åº“</h3><p>ä½¿ç”¨mysql</p>
<ol>
<li>åˆ›å»ºæ•°æ®åº“ï¼šfescar_demo</li>
<li>æ‰§è¡Œseata-samples/dubbo/src/main/resources/sql/dubbo_biz.sql</li>
<li>æ‰§è¡Œseata-samples/dubbo/src/main/resources/sql/undo_log.sql</li>
</ol>
<h3 id="å¯åŠ¨åŸºç¡€æœåŠ¡"><a href="#å¯åŠ¨åŸºç¡€æœåŠ¡" class="headerlink" title="å¯åŠ¨åŸºç¡€æœåŠ¡"></a>å¯åŠ¨åŸºç¡€æœåŠ¡</h3><ol>
<li><p>DubboAccountServiceStarter</p>
<p>æ‰¾åˆ°<code>io.seata.samples.dubbo.starter.DubboAccountServiceStarter</code>ï¼Œç›´æ¥ç‚¹å‡»è¿è¡Œmainæ–¹æ³•ï¼Œåœ¨å½“å‰çº¿ç¨‹ä¸‹ï¼Œæˆ‘ä»¬æ²¡æœ‰çœ‹åˆ°æ—¥å¿—ï¼Œä½†æ˜¯åœ¨Serverç«¯ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸‹é¢çš„æ—¥å¿—ï¼Œå°±ä»£ç Rmå·²ç»æ³¨å†ŒæˆåŠŸå•¦ï¼ŒåŒæ—¶åœ¨æ•°æ®åº“<code>account_tbl</code>è¡¨ä¸­æ’å…¥äº†ä¸€æ¡è®°å½•ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2019-06-16 09:32:45.562 INFO [ServerHandlerThread_1_500]io.seata.core.rpc.DefaultServerMessageListenerImpl.onRegRmMessage:112 -rm register success,message:RegisterRMRequest&#123;resourceIds=<span class="string">'jdbc:mysql://127.0.0.1:3306/seata'</span>, applicationId=<span class="string">'dubbo-demo-account-service'</span>, transactionServiceGroup=<span class="string">'my_test_tx_group'</span>&#125;,channel:[id: 0xcbff48be, L:/127.0.0.1:8091 - R:/127.0.0.1:54122]</span><br><span class="line">2019-06-16 09:32:48.139 INFO [NettyServerNIOWorker_2_8]io.seata.core.rpc.DefaultServerMessageListenerImpl.onRegTmMessage:128 -checkAuth <span class="keyword">for</span> client:127.0.0.1:54123 vgroup:my_test_tx_group ok</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><img src="https://upload-images.jianshu.io/upload_images/10354196-10458e4af725f5fe.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="acount.png"></p>
<ol>
<li><p>DubboStorageServiceStarter</p>
<p>æ‰¾åˆ°<code>io.seata.samples.dubbo.starter.DubboStorageServiceStarter</code>ï¼Œç›´æ¥ç‚¹å‡»è¿è¡Œmainæ–¹æ³•ï¼Œåœ¨å½“å‰çº¿ç¨‹ä¸‹ï¼Œæˆ‘ä»¬æ²¡æœ‰çœ‹åˆ°æ—¥å¿—ï¼Œä½†æ˜¯åœ¨Serverç«¯ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸‹é¢çš„æ—¥å¿—ï¼Œå°±ä»£ç Rmå·²ç»æ³¨å†ŒæˆåŠŸå•¦ï¼ŒåŒæ—¶åœ¨æ•°æ®åº“<code>storage_tbl</code>è¡¨ä¸­æ’å…¥äº†ä¸€æ¡è®°å½•ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2019-06-16 09:41:06.227 INFO [ServerHandlerThread_2_500]io.seata.core.rpc.DefaultServerMessageListenerImpl.onRegRmMessage:112 -rm register success,message:RegisterRMRequest&#123;resourceIds=<span class="string">'jdbc:mysql://127.0.0.1:3306/seata'</span>, applicationId=<span class="string">'dubbo-demo-storage-service'</span>, transactionServiceGroup=<span class="string">'my_test_tx_group'</span>&#125;,channel:[id: 0xf37dc389, L:/127.0.0.1:8091 - R:/127.0.0.1:54214]</span><br><span class="line">2019-06-16 09:41:08.969 INFO [NettyServerNIOWorker_4_8]io.seata.core.rpc.DefaultServerMessageListenerImpl.onRegTmMessage:128 -checkAuth <span class="keyword">for</span> client:127.0.0.1:54215 vgroup:my_test_tx_group ok</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><img src="https://upload-images.jianshu.io/upload_images/10354196-a48b6dba285bba5a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="storage.png"></p>
<ol>
<li><p>DubboOrderServiceStarter</p>
<p>æ‰¾åˆ°<code>io.seata.samples.dubbo.DubboOrderServiceStarter</code>ï¼Œç›´æ¥ç‚¹å‡»è¿è¡Œmainæ–¹æ³•ï¼Œåœ¨å½“å‰çº¿ç¨‹ä¸‹ï¼Œæˆ‘ä»¬æ²¡æœ‰çœ‹åˆ°æ—¥å¿—ï¼Œä½†æ˜¯åœ¨Serverç«¯ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸‹é¢çš„æ—¥å¿—ï¼Œå°±ä»£ç Rmå·²ç»æ³¨å†ŒæˆåŠŸå•¦ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2019-06-16 09:44:18.384 INFO [ServerHandlerThread_3_500]io.seata.core.rpc.DefaultServerMessageListenerImpl.onRegRmMessage:112 -rm register success,message:RegisterRMRequest&#123;resourceIds=<span class="string">'jdbc:mysql://127.0.0.1.200:3306/seata'</span>, applicationId=<span class="string">'dubbo-demo-order-service'</span>, transactionServiceGroup=<span class="string">'my_test_tx_group'</span>&#125;,channel:[id: 0xe370a8ab, L:/127.0.0.1:8091 - R:/127.0.0.1:54259]</span><br><span class="line">2019-06-16 09:44:21.333 INFO [NettyServerNIOWorker_6_8]io.seata.core.rpc.DefaultServerMessageListenerImpl.onRegTmMessage:128 -checkAuth <span class="keyword">for</span> client:127.0.0.1:54261 vgroup:my_test_tx_group ok</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="æµ‹è¯•åˆ†å¸ƒå¼äº‹åŠ¡"><a href="#æµ‹è¯•åˆ†å¸ƒå¼äº‹åŠ¡" class="headerlink" title="æµ‹è¯•åˆ†å¸ƒå¼äº‹åŠ¡"></a>æµ‹è¯•åˆ†å¸ƒå¼äº‹åŠ¡</h3><p>æ‰¾åˆ°<code>io.seata.samples.dubbo.DubboBusinessTester</code> è¿™é‡Œæ‰§è¡Œçš„æ˜¯ä¸€ä¸ªè´­ä¹°çš„æ–¹æ³•ï¼Œä¼šå…ˆè°ƒç”¨åº“å­˜æœåŠ¡æ‰£å‡åº“å­˜ï¼Œç„¶åè°ƒç”¨è®¢å•æœåŠ¡ç”Ÿäº§è®¢å•ï¼Œåœ¨ç”Ÿæˆè®¢å•ä¹‹å‰ï¼Œä»–è¿˜ä¼šè°ƒç”¨æ‰£å‡è´¦æˆ·ä½™é¢çš„æœåŠ¡ï¼Œè¿™æ ·ä¼šå½¢æˆä¸€ä¸ªå¾®æœåŠ¡é“¾è·¯ã€‚</p>
<h4 id="æ­£å¸¸æäº¤"><a href="#æ­£å¸¸æäº¤" class="headerlink" title="æ­£å¸¸æäº¤"></a>æ­£å¸¸æäº¤</h4><p>æˆ‘ä»¬å…ˆæŠŠ<code>io.seata.samples.dubbo.service.impl#purchase</code>æ–¹æ³•ä¸­çš„å¼‚å¸¸ç»™æ³¨é‡Šæ‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">purchase</span><span class="params">(String userId, String commodityCode, <span class="keyword">int</span> orderCount)</span> </span>&#123;</span><br><span class="line">    LOGGER.info(<span class="string">"purchase begin ... xid: "</span> + RootContext.getXID());</span><br><span class="line">    storageService.deduct(commodityCode, orderCount);</span><br><span class="line">    orderService.create(userId, commodityCode, orderCount);</span><br><span class="line">    <span class="comment">// throw new RuntimeException("xxx");</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶åç‚¹å‡»è¿è¡Œ<code>io.seata.samples.dubbo.DubboBusinessTester#main</code>æ–¹æ³•ï¼Œæˆ‘ä»¬çœ‹åˆ°æ–¹æ³•æ­£å¸¸ç»“æŸï¼Œå¹¶ä¸”è¡¨ä¸­æ•°æ®å‘é€äº†å¦‚ä¸‹å˜åŒ–ï¼š<br><img src="https://upload-images.jianshu.io/upload_images/10354196-cb3b6179b4da2d8c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="normal-acount.png"></p>
<p><img src="https://upload-images.jianshu.io/upload_images/10354196-42255f8875371e19.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="normal-storage.png"></p>
<p><img src="https://upload-images.jianshu.io/upload_images/10354196-e8586aefc68ed8e0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="normal-order.png"></p>
<h4 id="å¼‚å¸¸å›æ»š"><a href="#å¼‚å¸¸å›æ»š" class="headerlink" title="å¼‚å¸¸å›æ»š"></a>å¼‚å¸¸å›æ»š</h4><p>æˆ‘ä»¬å…ˆæŠŠ<code>io.seata.samples.dubbo.service.impl#purchase</code>æ–¹æ³•ä¸­çš„å¼‚å¸¸çš„æ³¨é‡Šç»™æ”¾å¼€, ä¸ºäº†æ›´å¥½çš„çœ‹åˆ°å›æ»šçš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬åœ¨æŠ›å‡ºå¼‚å¸¸çš„é‚£ä¸€è¡Œä»£ç å‰é¢åŠ ä¸Š<strong>æ–­ç‚¹</strong>ï¼Œç„¶ådebugè¿è¡Œ<code>io.seata.samples.dubbo.DubboBusinessTester#main</code>æ–¹æ³•ï¼Œæ‰§è¡Œåˆ°æ–­ç‚¹ï¼Œæˆ‘ä»¬çœ‹çœ‹æ•°æ®åº“çš„å˜åŒ–ï¼š<br><img src="https://upload-images.jianshu.io/upload_images/10354196-53d207bcb1f6e4f0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="exception-account.png"></p>
<p><img src="https://upload-images.jianshu.io/upload_images/10354196-3ecd332b64ce4500.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="exception-storage.png"></p>
<p><img src="https://upload-images.jianshu.io/upload_images/10354196-d2b1f11253b620e7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="exception-order.png"></p>
<p>æˆ‘ä»¬çœ‹åˆ°æ•°æ®å…¶å®éƒ½å·²ç»æœ‰äº†ä¸€äº›å˜åŒ–ï¼Œç„¶åçœ‹çœ‹å¾ˆé‡è¦çš„  <code>undo_log</code>è¡¨ï¼Œå‘ç°å®ƒä¹Ÿç”Ÿæˆäº†ä¸€äº›è®°å½•ï¼Œä¸è¿‡è¿™é‡Œå…ˆä¸ç®¡ï¼š<br><img src="https://upload-images.jianshu.io/upload_images/10354196-521fd48999566ecc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="undo_log.png"></p>
<p>æˆ‘ä»¬æ”¾å¼€æ–­ç‚¹ä¹‹åçœ‹åˆ°æ–¹æ³•æ‰§è¡ŒæŠ›å‡ºäº†å¼‚å¸¸ï¼ŒåŒæ—¶è¡¨ä¸­æ•°æ®å˜æˆäº†ä¸Šé¢æ­£å¸¸æäº¤çš„æ•°æ®ï¼ŒåŒæ—¶<code>undo_log</code>è¡¨ä¹Ÿè¢«æ¸…ç©ºäº†ï¼Œä»è¿™é‡Œå¯ä»¥çœ‹å‡ºseataç¡®å®æ˜¯å¸®æˆ‘ä»¬å®ç°äº†<strong>åˆ†å¸ƒå¼äº‹åŠ¡</strong>ã€‚</p>
<h1 id="ç»“æŸ"><a href="#ç»“æŸ" class="headerlink" title="ç»“æŸ"></a>ç»“æŸ</h1><p>å¥½äº†ï¼Œç¯å¢ƒåˆ°è¿™é‡Œå°±æ­å»ºç»“æŸäº†ï¼Œå…³äºseataä»£ç ä¸Šæ˜¯å¦‚ä½•å®ç°åˆ†å¸ƒå¼äº‹åŠ¡çš„ï¼Œæˆ‘ä»¬æ…¢æ…¢æ¥åˆ†æ~</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol>
<li><a href="https://github.com/seata/seata/wiki" target="_blank" rel="noopener">Seata Wiki</a></li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¼•ï¼š2019 å¹´ 1 æœˆï¼Œé˜¿é‡Œå·´å·´ä¸­é—´ä»¶å›¢é˜Ÿå‘èµ·äº†å¼€æºé¡¹ç›® &lt;strong&gt;Fescarï¼ˆFast &amp;amp; EaSy Commit And Rollbackï¼‰&lt;/strong&gt;ï¼Œå’Œç¤¾åŒºä¸€èµ·å…±å»ºå¼€æºåˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆã€‚Fescar çš„æ„¿æ™¯æ˜¯è®©åˆ†å¸ƒå¼äº‹åŠ¡çš„ä½¿ç”¨åƒæœ¬åœ°äº‹åŠ¡çš„ä½¿ç”¨ä¸€æ ·ï¼Œç®€å•å’Œé«˜æ•ˆï¼Œå¹¶é€æ­¥è§£å†³å¼€å‘è€…ä»¬é‡åˆ°çš„åˆ†å¸ƒå¼äº‹åŠ¡æ–¹é¢çš„æ‰€æœ‰éš¾é¢˜ã€‚ä¸ºäº†æ‰“é€ æ›´ä¸­ç«‹ã€æ›´å¼€æ”¾ã€ç”Ÿæ€æ›´åŠ ä¸°å¯Œçš„åˆ†å¸ƒå¼äº‹åŠ¡å¼€æºç¤¾åŒºï¼Œç»è¿‡ç¤¾åŒºæ ¸å¿ƒæˆå‘˜çš„æŠ•ç¥¨ï¼Œå¤§å®¶å†³å®šå¯¹ &lt;strong&gt;Fescar &lt;/strong&gt;è¿›è¡Œå“ç‰Œå‡çº§ï¼Œå¹¶æ›´åä¸º &lt;strong&gt;Seata&lt;/strong&gt;ï¼Œæ„ä¸ºï¼š&lt;strong&gt;Simple Extensible Autonomous Transaction Architecture&lt;/strong&gt;ï¼Œæ˜¯ä¸€å¥—ä¸€ç«™å¼&lt;strong&gt;åˆ†å¸ƒå¼äº‹åŠ¡&lt;/strong&gt;è§£å†³æ–¹æ¡ˆã€‚
    
    </summary>
    
      <category term="Seataæºç " scheme="http://bestlixiang.site/categories/Seata%E6%BA%90%E7%A0%81/"/>
    
    
      <category term="Seata" scheme="http://bestlixiang.site/tags/Seata/"/>
    
      <category term="åˆ†å¸ƒå¼äº‹åŠ¡" scheme="http://bestlixiang.site/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/"/>
    
  </entry>
  
  <entry>
    <title>RocketMQæºç åˆ†æâ€”â€”Producer</title>
    <link href="http://bestlixiang.site/2019/06/15/RocketMQ%E6%BA%90%E7%A0%81/RocketMQ%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E2%80%94%E2%80%94Producer/"/>
    <id>http://bestlixiang.site/2019/06/15/RocketMQæºç /RocketMQæºç åˆ†æâ€”â€”Producer/</id>
    <published>2019-06-15T06:46:21.000Z</published>
    <updated>2019-06-15T06:50:11.364Z</updated>
    
    <content type="html"><![CDATA[<p>å¼•ï¼šä½¿ç”¨MQï¼Œç¬¬ä¸€æ­¥æ„é€ Producerï¼Œç„¶åå°±å¯ä»¥å¼€å§‹å‘é€æ¶ˆæ¯å•¦ï¼<a id="more"></a></p>
<h1 id="å‘é€æ–¹å¼"><a href="#å‘é€æ–¹å¼" class="headerlink" title="å‘é€æ–¹å¼"></a>å‘é€æ–¹å¼</h1><p>producerå‘é€æ¶ˆæ¯æ”¯æŒ3ç§æ–¹å¼ï¼ŒåŒæ­¥ã€å¼‚æ­¥å’ŒOnewayã€‚</p>
<ul>
<li>åŒæ­¥å‘é€ï¼šå®¢æˆ·ç«¯æäº¤æ¶ˆæ¯åˆ°brokeråä¼šç­‰å¾…è¿”å›ç»“æœã€‚æœ‰å¯é æ€§ä¿éšœã€‚</li>
<li>å¼‚æ­¥å‘é€ï¼šè°ƒç”¨å‘é€æ¥å£æ—¶ä¼šæ³¨å†Œä¸€ä¸ªcallbackç±»ï¼Œå‘é€çº¿ç¨‹ç»§ç»­å…¶å®ƒä¸šåŠ¡é€»è¾‘ï¼Œproduceråœ¨æ”¶åˆ°brokerç»“æœåå›è°ƒã€‚å½“æ¶ˆæ¯ç»“æœä¸å½±å“æ­£å¸¸ä¸šåŠ¡é€»è¾‘çš„æ—¶å€™ä½¿ç”¨ã€‚</li>
<li>Onewayï¼šProduceræäº¤æ¶ˆæ¯åï¼Œæ— è®ºbrokeræ˜¯å¦æ­£å¸¸æ¥æ”¶æ¶ˆæ¯éƒ½ä¸å…³å¿ƒã€‚é€‚åˆäºè¿½æ±‚é«˜ååã€èƒ½å®¹å¿æ¶ˆæ¯ä¸¢å¤±çš„åœºæ™¯ï¼Œæ¯”å¦‚æ—¥å¿—æ”¶é›†ã€‚</li>
</ul>
<h1 id="ä½¿ç”¨æ–¹å¼"><a href="#ä½¿ç”¨æ–¹å¼" class="headerlink" title="ä½¿ç”¨æ–¹å¼"></a>ä½¿ç”¨æ–¹å¼</h1><p>æˆ‘ä»¬ä¸»è¦è®²åŒæ­¥å‘é€ï¼Œå¼‚æ­¥å‘é€å’ŒOnewayæ–¹å¼å’Œäº‹åŠ¡æ¶ˆæ¯å¸¦è¿‡ï¼ŒåŒæ­¥å‘é€ä¾‹å­å°±æ˜¯ç¯å¢ƒæ­å»ºä¸­Producerçš„ä¾‹å­ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> MQClientException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// å®ä¾‹åŒ–ä¸€ä¸ªProducer</span></span><br><span class="line">        DefaultMQProducer producer = <span class="keyword">new</span> DefaultMQProducer(<span class="string">"please_rename_unique_group_name"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æŒ‡æ˜Namesrv</span></span><br><span class="line">        producer.setNamesrvAddr(<span class="string">"127.0.0.1:9876"</span>);</span><br><span class="line">        producer.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">                Message msg = <span class="keyword">new</span> Message(<span class="string">"TopicTest"</span> <span class="comment">/* Topic */</span>,</span><br><span class="line">                    <span class="string">"TagA"</span> <span class="comment">/* Tag */</span>,</span><br><span class="line">                    (<span class="string">"Hello RocketMQ "</span> + i).getBytes(RemotingHelper.DEFAULT_CHARSET) <span class="comment">/* Message body */</span></span><br><span class="line">                );</span><br><span class="line">                SendResult sendResult = producer.send(msg);</span><br><span class="line">                System.out.printf(<span class="string">"%s%n"</span>, sendResult);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        producer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ä¸Šé¢æˆ‘ä»¬å®ä¾‹åŒ–ä¸€ä¸ªDefaultMQProducerï¼Œè®¾ç½®group nameå’Œnameservçš„åœ°å€ã€‚Producerå¯åŠ¨åå°±å¯ä»¥å¾€æŒ‡å®šçš„topicå‘é€æ¶ˆæ¯å•¦ï¼</p>
<h1 id="Producerå¯åŠ¨"><a href="#Producerå¯åŠ¨" class="headerlink" title="Producerå¯åŠ¨"></a>Producerå¯åŠ¨</h1><h2 id="DefaultMQProduceråˆå§‹åŒ–"><a href="#DefaultMQProduceråˆå§‹åŒ–" class="headerlink" title="DefaultMQProduceråˆå§‹åŒ–"></a>DefaultMQProduceråˆå§‹åŒ–</h2><p>ä¸‹é¢ä»£ç :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.rocketmq.client.producer.DefaultMQProducer</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DefaultMQProducer</span><span class="params">(<span class="keyword">final</span> String producerGroup)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(producerGroup, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DefaultMQProducer</span><span class="params">(<span class="keyword">final</span> String producerGroup, RPCHook rpcHook)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.producerGroup = producerGroup;</span><br><span class="line">        <span class="comment">// DefaultMQProduceråŒ…è£…äº†DefaultMQProducerImpl</span></span><br><span class="line">        defaultMQProducerImpl = <span class="keyword">new</span> DefaultMQProducerImpl(<span class="keyword">this</span>, rpcHook);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DefaultMQProducerImpl</span><span class="params">(<span class="keyword">final</span> DefaultMQProducer defaultMQProducer, RPCHook rpcHook)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.defaultMQProducer = defaultMQProducer;</span><br><span class="line">        <span class="keyword">this</span>.rpcHook = rpcHook;</span><br><span class="line">        <span class="comment">// æ„é€ äº†ä¸€ä¸ªåŒæ­¥å‘é€çº¿ç¨‹æ± </span></span><br><span class="line">        <span class="keyword">this</span>.asyncSenderThreadPoolQueue = <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;(<span class="number">50000</span>);</span><br><span class="line">        <span class="keyword">this</span>.defaultAsyncSenderExecutor = <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">            Runtime.getRuntime().availableProcessors(),</span><br><span class="line">            Runtime.getRuntime().availableProcessors(),</span><br><span class="line">            <span class="number">1000</span> * <span class="number">60</span>,</span><br><span class="line">            TimeUnit.MILLISECONDS,</span><br><span class="line">            <span class="keyword">this</span>.asyncSenderThreadPoolQueue,</span><br><span class="line">            <span class="keyword">new</span> ThreadFactory() &#123;</span><br><span class="line">                <span class="keyword">private</span> AtomicInteger threadIndex = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable r)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> Thread(r, <span class="string">"AsyncSenderExecutor_"</span> + <span class="keyword">this</span>.threadIndex.incrementAndGet());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="DefaultMQProducerå¯åŠ¨"><a href="#DefaultMQProducerå¯åŠ¨" class="headerlink" title="DefaultMQProducerå¯åŠ¨"></a>DefaultMQProducerå¯åŠ¨</h2><p>ä¸‹é¢ä»£ç ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.rocketmq.client.producer.DefaultMQProducer</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> MQClientException </span>&#123;</span><br><span class="line">    <span class="comment">// è°ƒç”¨å®é™…çš„å®ç°ç±»</span></span><br><span class="line">    <span class="keyword">this</span>.defaultMQProducerImpl.start();</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> != traceDispatcher) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            traceDispatcher.start(<span class="keyword">this</span>.getNamesrvAddr());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MQClientException e) &#123;</span><br><span class="line">            log.warn(<span class="string">"trace dispatcher start failed "</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// org.apache.rocketmq.client.impl.producer.DefaultMQProducerImpl</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> MQClientException </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.start(<span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> startFactory)</span> <span class="keyword">throws</span> MQClientException </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (<span class="keyword">this</span>.serviceState) &#123;</span><br><span class="line">        <span class="keyword">case</span> CREATE_JUST:</span><br><span class="line">            <span class="comment">// å¦‚æœä¸‹é¢çš„è¿‡ç¨‹ä¸­å‡ºé”™äº†ï¼Œé‚£ä¹ˆserviceStateå°±ä¸ºSTART_FAILED</span></span><br><span class="line">            <span class="keyword">this</span>.serviceState = ServiceState.START_FAILED;</span><br><span class="line">            <span class="comment">// æ£€æŸ¥group nameæ˜¯å¦åˆé€‚</span></span><br><span class="line">            <span class="keyword">this</span>.checkConfig();</span><br><span class="line">            <span class="comment">// æ›´æ”¹defaultMQProducerçš„åç§°ä¸ºè¿›ç¨‹id</span></span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">this</span>.defaultMQProducer.getProducerGroup().equals(MixAll.CLIENT_INNER_PRODUCER_GROUP)) &#123;</span><br><span class="line">                <span class="keyword">this</span>.defaultMQProducer.changeInstanceNameToPID();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// MQClientManagerä¸ºå•ä¾‹ï¼Œåˆ›å»ºmQClientFactory</span></span><br><span class="line">            <span class="comment">// ä¸€ä¸ªè¿›ç¨‹åªä¼šå­˜åœ¨ä¸€ä¸ªMQClientInstanceï¼Œ è®¾ç½®clientId ï¼ˆIP@PIDï¼‰</span></span><br><span class="line">            <span class="keyword">this</span>.mQClientFactory = MQClientManager.getInstance().getAndCreateMQClientInstance(<span class="keyword">this</span>.defaultMQProducer, rpcHook);</span><br><span class="line">            <span class="comment">// å‘mQClientFactoryæ³¨å†ŒdefaultMQProducer</span></span><br><span class="line">            <span class="keyword">boolean</span> registerOK = mQClientFactory.registerProducer(<span class="keyword">this</span>.defaultMQProducer.getProducerGroup(), <span class="keyword">this</span>);</span><br><span class="line">            <span class="keyword">if</span> (!registerOK) &#123;</span><br><span class="line">                <span class="keyword">this</span>.serviceState = ServiceState.CREATE_JUST;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> MQClientException(<span class="string">"The producer group["</span> + <span class="keyword">this</span>.defaultMQProducer.getProducerGroup()</span><br><span class="line">                    + <span class="string">"] has been created before, specify another name please."</span> + FAQUrl.suggestTodo(FAQUrl.GROUP_NAME_DUPLICATE_URL),</span><br><span class="line">                    <span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æ·»åŠ é»˜è®¤çš„topicPublishInfo</span></span><br><span class="line">            <span class="keyword">this</span>.topicPublishInfoTable.put(<span class="keyword">this</span>.defaultMQProducer.getCreateTopicKey(), <span class="keyword">new</span> TopicPublishInfo());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (startFactory) &#123;</span><br><span class="line">                <span class="comment">// æ ¸å¿ƒ</span></span><br><span class="line">                <span class="comment">// å¯åŠ¨MQClientInstance</span></span><br><span class="line">                mQClientFactory.start();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            log.info(<span class="string">"the producer [&#123;&#125;] start OK. sendMessageWithVIPChannel=&#123;&#125;"</span>, <span class="keyword">this</span>.defaultMQProducer.getProducerGroup(),</span><br><span class="line">                <span class="keyword">this</span>.defaultMQProducer.isSendMessageWithVIPChannel());</span><br><span class="line">            <span class="comment">// å¯åŠ¨å®Œæˆ</span></span><br><span class="line">            <span class="keyword">this</span>.serviceState = ServiceState.RUNNING;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> RUNNING:</span><br><span class="line">        <span class="keyword">case</span> START_FAILED:</span><br><span class="line">        <span class="keyword">case</span> SHUTDOWN_ALREADY:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> MQClientException(<span class="string">"The producer service state not OK, maybe started once, "</span></span><br><span class="line">                + <span class="keyword">this</span>.serviceState</span><br><span class="line">                + FAQUrl.suggestTodo(FAQUrl.CLIENT_SERVICE_NOT_OK),</span><br><span class="line">                <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å‘æ‰€æœ‰brokerå‘é€ä¸€æ¬¡å¿ƒè·³</span></span><br><span class="line">    <span class="keyword">this</span>.mQClientFactory.sendHeartbeatToAllBrokerWithLock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬çœ‹åˆ°DefaultMQProducer çš„startçš„è¿‡ç¨‹ä¸»è¦å°±æ˜¯åˆå§‹åŒ–å’Œå¯åŠ¨ä¸€ä¸ªMQClientInstanceï¼Œå°†produceræ³¨å†Œåˆ°instanceä¸­ã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹MQClientInstanceçš„å¯åŠ¨è¿‡ç¨‹ã€‚</p>
<h2 id="MQClientInstanceå¯åŠ¨"><a href="#MQClientInstanceå¯åŠ¨" class="headerlink" title="MQClientInstanceå¯åŠ¨"></a>MQClientInstanceå¯åŠ¨</h2><p>ä¸‹é¢æ˜¯å¯åŠ¨ä»£ç ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> MQClientException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="keyword">this</span>.serviceState) &#123;</span><br><span class="line">                <span class="keyword">case</span> CREATE_JUST:</span><br><span class="line">                    <span class="keyword">this</span>.serviceState = ServiceState.START_FAILED;</span><br><span class="line">                    <span class="comment">// If not specified,looking address from name server</span></span><br><span class="line">                    <span class="comment">// å¦‚æœNameservAddrä¸ºç©ºï¼Œå°è¯•ä»http serverè·å–nameservçš„åœ°å€</span></span><br><span class="line">                    <span class="comment">// è¿™é‡Œçœ‹å‡ºé€‚åˆäºæœ‰ç»Ÿä¸€é…ç½®ä¸­å¿ƒçš„ç³»ç»Ÿ</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">null</span> == <span class="keyword">this</span>.clientConfig.getNamesrvAddr()) &#123;</span><br><span class="line">                        <span class="keyword">this</span>.mQClientAPIImpl.fetchNameServerAddr();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// Start request-response channel</span></span><br><span class="line">                    <span class="comment">// åˆå§‹åŒ–Nettyå®¢æˆ·ç«¯</span></span><br><span class="line">                    <span class="keyword">this</span>.mQClientAPIImpl.start();</span><br><span class="line">                    <span class="comment">// Start various schedule tasks</span></span><br><span class="line">                    <span class="comment">// å¼€å¯å„ç§å®šæ—¶ä»»åŠ¡</span></span><br><span class="line">                    <span class="keyword">this</span>.startScheduledTask();</span><br><span class="line">                    <span class="comment">// Start pull service</span></span><br><span class="line">                    <span class="comment">// producerå’Œconsumerå…¬ç”¨ä¸€ä¸ªMQClientInstanceçš„å®ç°</span></span><br><span class="line">                    <span class="comment">// å¼€å¯æ‹‰æ¶ˆæ¯æœåŠ¡(Consumer)</span></span><br><span class="line">                    <span class="keyword">this</span>.pullMessageService.start();</span><br><span class="line">                    <span class="comment">// Start rebalance service</span></span><br><span class="line">                    <span class="comment">// å¼€å¯è´Ÿè½½å‡è¡¡æœåŠ¡</span></span><br><span class="line">                    <span class="keyword">this</span>.rebalanceService.start();</span><br><span class="line">                    <span class="comment">// Start push service</span></span><br><span class="line">                    <span class="comment">// å¼€å¯Producer</span></span><br><span class="line">                    <span class="keyword">this</span>.defaultMQProducer.getDefaultMQProducerImpl().start(<span class="keyword">false</span>);</span><br><span class="line">                    log.info(<span class="string">"the client factory [&#123;&#125;] start OK"</span>, <span class="keyword">this</span>.clientId);</span><br><span class="line">                    <span class="comment">// æ›´æ”¹clientçŠ¶æ€</span></span><br><span class="line">                    <span class="keyword">this</span>.serviceState = ServiceState.RUNNING;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> RUNNING:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> SHUTDOWN_ALREADY:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> START_FAILED:</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> MQClientException(<span class="string">"The Factory object["</span> + <span class="keyword">this</span>.getClientId() + <span class="string">"] has been created before, and failed."</span>, <span class="keyword">null</span>);</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹çœ‹å®ƒèµ·äº†å“ªäº›å®šæ—¶ä»»åŠ¡ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startScheduledTask</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == <span class="keyword">this</span>.clientConfig.getNamesrvAddr()) &#123;</span><br><span class="line">        <span class="comment">// è·å–nameservåœ°å€</span></span><br><span class="line">        <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    MQClientInstance.<span class="keyword">this</span>.mQClientAPIImpl.fetchNameServerAddr();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    log.error(<span class="string">"ScheduledTask fetchNameServerAddr exception"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">1000</span> * <span class="number">10</span>, <span class="number">1000</span> * <span class="number">60</span> * <span class="number">2</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»nameservæ›´æ–°topicRouteInfo</span></span><br><span class="line">    <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                MQClientInstance.<span class="keyword">this</span>.updateTopicRouteInfoFromNameServer();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">"ScheduledTask updateTopicRouteInfoFromNameServer exception"</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="number">10</span>, <span class="keyword">this</span>.clientConfig.getPollNameServerInterval(), TimeUnit.MILLISECONDS);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸…é™¤å·²ç»ä¸‹çº¿çš„brokerï¼Œå¹¶å‘é€å¿ƒè·³</span></span><br><span class="line">    <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                MQClientInstance.<span class="keyword">this</span>.cleanOfflineBroker();</span><br><span class="line">                MQClientInstance.<span class="keyword">this</span>.sendHeartbeatToAllBrokerWithLock();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">"ScheduledTask sendHeartbeatToAllBroker exception"</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="number">1000</span>, <span class="keyword">this</span>.clientConfig.getHeartbeatBrokerInterval(), TimeUnit.MILLISECONDS);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŒä¹…åŒ–æ¶ˆè´¹è€…çš„Offset(Consumer)</span></span><br><span class="line">    <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                MQClientInstance.<span class="keyword">this</span>.persistAllConsumerOffset();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">"ScheduledTask persistAllConsumerOffset exception"</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="number">1000</span> * <span class="number">10</span>, <span class="keyword">this</span>.clientConfig.getPersistConsumerOffsetInterval(), TimeUnit.MILLISECONDS);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŠ¨æ€è°ƒæ•´æ¶ˆè´¹è€…çš„çº¿ç¨‹æ± ï¼ˆConsumerï¼‰</span></span><br><span class="line">    <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                MQClientInstance.<span class="keyword">this</span>.adjustThreadPool();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">"ScheduledTask adjustThreadPool exception"</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="number">1</span>, <span class="number">1</span>, TimeUnit.MINUTES);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬çš„Producerå°±å¯åŠ¨å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥çœ‹çœ‹å®ƒæ˜¯æ€ä¹ˆå‘é€æ¶ˆæ¯å•¦ï¼</p>
<h1 id="æ¶ˆæ¯å‘é€"><a href="#æ¶ˆæ¯å‘é€" class="headerlink" title="æ¶ˆæ¯å‘é€"></a>æ¶ˆæ¯å‘é€</h1><p>Produceré»˜è®¤é‡‡ç”¨åŒæ­¥æ–¹å¼å‘é€æ¶ˆæ¯ï¼Œå¦‚æˆ‘ä»¬çš„ç¤ºä¾‹ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹è¿™ä¸ªæ–¹æ³•<code>DefaultMQProducer.send( Message msg)</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.rocketmq.client.producer.DefaultMQProducer</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SendResult <span class="title">send</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    Message msg)</span> <span class="keyword">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.defaultMQProducerImpl.send(msg);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// org.apache.rocketmq.client.producer.defaultMQProducerImpl</span></span><br><span class="line"><span class="comment">// è¶…æ—¶æ—¶é—´3ç§’</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SendResult <span class="title">send</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    Message msg)</span> <span class="keyword">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> send(msg, <span class="keyword">this</span>.defaultMQProducer.getSendMsgTimeout());</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å¯ä»¥çœ‹åˆ°é»˜è®¤é‡‡ç”¨åŒæ­¥æ–¹å¼</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SendResult <span class="title">send</span><span class="params">(Message msg,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">long</span> timeout)</span> <span class="keyword">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.sendDefaultImpl(msg, CommunicationMode.SYNC, <span class="keyword">null</span>, timeout);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å®é™…å‘é€é€»è¾‘</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> SendResult <span class="title">sendDefaultImpl</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    Message msg,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">final</span> CommunicationMode communicationMode,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">final</span> SendCallback sendCallback,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">final</span> <span class="keyword">long</span> timeout</span></span></span><br><span class="line"><span class="function"><span class="params">)</span> <span class="keyword">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException </span>&#123;</span><br><span class="line">    <span class="comment">// æ£€æŸ¥clientçŠ¶æ€æ˜¯å¦æ˜¯runing</span></span><br><span class="line">    <span class="keyword">this</span>.makeSureStateOK();</span><br><span class="line">    <span class="comment">// å‚æ•°æ ¡éªŒï¼Œæ¶ˆæ¯ä¸èƒ½å‘ç»™ç³»ç»Ÿé¢„ç•™çš„topicï¼Œæ¶ˆæ¯ä½“ä¸èƒ½è¶…è¿‡æœ€å¤§é•¿åº¦4Mï¼Œæˆ–è€…æ˜¯ç©ºæ¶ˆæ¯</span></span><br><span class="line">    Validators.checkMessage(msg, <span class="keyword">this</span>.defaultMQProducer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> invokeID = random.nextLong();</span><br><span class="line">    <span class="keyword">long</span> beginTimestampFirst = System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">long</span> beginTimestampPrev = beginTimestampFirst;</span><br><span class="line">    <span class="keyword">long</span> endTimestamp = beginTimestampFirst;</span><br><span class="line">    <span class="comment">// æ ¹æ®æ¶ˆæ¯çš„topicï¼Œè·å–è¯¥topicçš„è·¯ç”±ä¿¡æ¯</span></span><br><span class="line">    TopicPublishInfo topicPublishInfo = <span class="keyword">this</span>.tryToFindTopicPublishInfo(msg.getTopic());</span><br><span class="line">    <span class="keyword">if</span> (topicPublishInfo != <span class="keyword">null</span> &amp;&amp; topicPublishInfo.ok()) &#123;</span><br><span class="line">        <span class="keyword">boolean</span> callTimeout = <span class="keyword">false</span>;</span><br><span class="line">        MessageQueue mq = <span class="keyword">null</span>;</span><br><span class="line">        Exception exception = <span class="keyword">null</span>;</span><br><span class="line">        SendResult sendResult = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// é‡è¯•æ¬¡æ•°ï¼ŒåŒæ­¥æ¨¡å¼ä¸‹é»˜è®¤ä¸º3æ¬¡</span></span><br><span class="line">        <span class="keyword">int</span> timesTotal = communicationMode == CommunicationMode.SYNC ? <span class="number">1</span> + <span class="keyword">this</span>.defaultMQProducer.getRetryTimesWhenSendFailed() : <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">int</span> times = <span class="number">0</span>;</span><br><span class="line">        String[] brokersSent = <span class="keyword">new</span> String[timesTotal];</span><br><span class="line">        <span class="keyword">for</span> (; times &lt; timesTotal; times++) &#123;</span><br><span class="line">            <span class="comment">// è®°å½•ä¸Šæ¬¡çš„å‘é€çš„broker</span></span><br><span class="line">            String lastBrokerName = <span class="keyword">null</span> == mq ? <span class="keyword">null</span> : mq.getBrokerName();</span><br><span class="line">            <span class="comment">// ä»æ‰€æœ‰topicå¯ç”¨queueä¸­é€‰æ‹©ä¸€ä¸ªqueueï¼Œæœ‰ä¸åŒçš„ç­–ç•¥</span></span><br><span class="line">            MessageQueue mqSelected = <span class="keyword">this</span>.selectOneMessageQueue(topicPublishInfo, lastBrokerName);</span><br><span class="line">            <span class="keyword">if</span> (mqSelected != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mq = mqSelected;</span><br><span class="line">                <span class="comment">// è®°å½•ä¸‹å½“å‰çš„broker</span></span><br><span class="line">                brokersSent[times] = mq.getBrokerName();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    beginTimestampPrev = System.currentTimeMillis();</span><br><span class="line">                    <span class="keyword">long</span> costTime = beginTimestampPrev - beginTimestampFirst;</span><br><span class="line">                    <span class="keyword">if</span> (timeout &lt; costTime) &#123;</span><br><span class="line">                        callTimeout = <span class="keyword">true</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// å‘é€æ¶ˆæ¯</span></span><br><span class="line">                    sendResult = <span class="keyword">this</span>.sendKernelImpl(msg, mq, communicationMode, sendCallback, topicPublishInfo, timeout - costTime);</span><br><span class="line">                    endTimestamp = System.currentTimeMillis();</span><br><span class="line">                    <span class="comment">// æ›´æ–°æœ¬æ¬¡è°ƒç”¨æ—¶é—´åˆ°MQFaultStrategyä¸­</span></span><br><span class="line">                    <span class="keyword">this</span>.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, <span class="keyword">false</span>);</span><br><span class="line">                    <span class="keyword">switch</span> (communicationMode) &#123;</span><br><span class="line">                        <span class="comment">// å¼‚æ­¥å’ŒONEWAYæ–¹å¼è°ƒç”¨åå°±ç›´æ¥è¿”å›äº†</span></span><br><span class="line">                        <span class="keyword">case</span> ASYNC:</span><br><span class="line">                            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                        <span class="keyword">case</span> ONEWAY:</span><br><span class="line">                            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                        <span class="keyword">case</span> SYNC:</span><br><span class="line">                            <span class="comment">// å‘é€æ²¡æˆåŠŸ</span></span><br><span class="line">                            <span class="keyword">if</span> (sendResult.getSendStatus() != SendStatus.SEND_OK) &#123;</span><br><span class="line">                                <span class="comment">// å¦‚æœbrokerå­˜å‚¨å¤±è´¥ï¼Œåˆ¤æ–­æ˜¯å¦è¦é‡è¯•</span></span><br><span class="line">                                <span class="keyword">if</span> (<span class="keyword">this</span>.defaultMQProducer.isRetryAnotherBrokerWhenNotStoreOK()) &#123;</span><br><span class="line">                                    <span class="keyword">continue</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">return</span> sendResult;</span><br><span class="line">                        <span class="keyword">default</span>:</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RemotingException e) &#123;</span><br><span class="line">                    <span class="comment">// çœç•¥å¼‚å¸¸</span></span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æˆåŠŸåˆ™è¿”å›ç»“æœ</span></span><br><span class="line">        <span class="keyword">if</span> (sendResult != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> sendResult;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// çœç•¥ä¸é‡è¦é€»è¾‘</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ä¸Šé¢å®Œæ•´çš„å‘é€é€»è¾‘ä¿¡æ¯é‡è¿˜æ˜¯æ¯”è¾ƒå¤§çš„ï¼Œæˆ‘ä»¬å…·ä½“çœ‹çœ‹å‡ ä¸ªé‡è¦çš„éƒ¨åˆ†ã€‚</p>
<h2 id="è·å–topicè·¯ç”±ä¿¡æ¯"><a href="#è·å–topicè·¯ç”±ä¿¡æ¯" class="headerlink" title="è·å–topicè·¯ç”±ä¿¡æ¯"></a>è·å–topicè·¯ç”±ä¿¡æ¯</h2><p>å…³æ³¨<code>DefaultMQProducerImpl#tryToFindTopicPublishInfo()</code>æ–¹æ³•:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> TopicPublishInfo <span class="title">tryToFindTopicPublishInfo</span><span class="params">(<span class="keyword">final</span> String topic)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ä»æœ¬åœ°ç¼“å­˜è·å–ï¼Œä¹‹å‰çœ‹åˆ°è¿‡æœ‰å®šæ—¶ä»»åŠ¡ä¼šå®šæ—¶æ›´æ–°è¿™ä¸ªç¼“å­˜</span></span><br><span class="line">    TopicPublishInfo topicPublishInfo = <span class="keyword">this</span>.topicPublishInfoTable.get(topic);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == topicPublishInfo || !topicPublishInfo.ok()) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™ä»NamesrvåŠ é”æ›´æ–°TopicRouteInfo ï¼Œä½¿ç”¨Netty</span></span><br><span class="line">        <span class="keyword">this</span>.topicPublishInfoTable.putIfAbsent(topic, <span class="keyword">new</span> TopicPublishInfo());</span><br><span class="line">        <span class="keyword">this</span>.mQClientFactory.updateTopicRouteInfoFromNameServer(topic);</span><br><span class="line">        topicPublishInfo = <span class="keyword">this</span>.topicPublishInfoTable.get(topic);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (topicPublishInfo.isHaveTopicRouterInfo() || topicPublishInfo.ok()) &#123;</span><br><span class="line">        <span class="comment">// è‹¥è·å–çš„ Topicå‘å¸ƒä¿¡æ¯æ—¶å€™å¯ç”¨ï¼Œåˆ™è¿”å›</span></span><br><span class="line">        <span class="keyword">return</span> topicPublishInfo;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å½“ä»Namesrvè·å–ä¸åˆ°æ—¶ï¼Œå¦‚æœå…è®¸brokerè‡ªåŠ¨åˆ›å»ºtopicä¿¡æ¯åˆ™è‡ªåŠ¨åˆ›å»ºå¹¶æ›´æ–°</span></span><br><span class="line">        <span class="keyword">this</span>.mQClientFactory.updateTopicRouteInfoFromNameServer(topic, <span class="keyword">true</span>, <span class="keyword">this</span>.defaultMQProducer);</span><br><span class="line">        topicPublishInfo = <span class="keyword">this</span>.topicPublishInfoTable.get(topic);</span><br><span class="line">        <span class="keyword">return</span> topicPublishInfo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Queueé€‰å–ç­–ç•¥"><a href="#Queueé€‰å–ç­–ç•¥" class="headerlink" title="Queueé€‰å–ç­–ç•¥"></a>Queueé€‰å–ç­–ç•¥</h2><p>Queueçš„é€‰å–æ˜¯é‡‡ç”¨è½®è¯¢çš„æ–¹å¼ï¼Œå¦‚æœå®¢æˆ·ç«¯å¼€å¯å»¶è¿Ÿå®¹é”™ï¼Œé‚£ä¹ˆåœ¨è½®è¯¢çš„æ—¶å€™ä¼šåŠ å…¥brokerå¯ç”¨æ€§çš„åˆ¤æ–­ã€‚<br>å…³æ³¨<code>DefaultMQProducerImpl#selectOneMessageQueue()</code>æ–¹æ³•:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> MQFaultStrategy mqFaultStrategy = <span class="keyword">new</span> MQFaultStrategy();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> MessageQueue <span class="title">selectOneMessageQueue</span><span class="params">(<span class="keyword">final</span> TopicPublishInfo tpInfo, <span class="keyword">final</span> String lastBrokerName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.mqFaultStrategy.selectOneMessageQueue(tpInfo, lastBrokerName);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// org.apache.rocketmq.client.latency.MQFaultStrategy</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> MessageQueue <span class="title">selectOneMessageQueue</span><span class="params">(<span class="keyword">final</span> TopicPublishInfo tpInfo, <span class="keyword">final</span> String lastBrokerName)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¦‚æœå¼€å¯äº†å»¶æ—¶å®¹é”™</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.sendLatencyFaultEnable) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// é¦–å…ˆè·å–ä¸Šæ¬¡ä½¿ç”¨çš„Queue index+1ï¼Œè¿™ä¸ªindexæ˜¯æ”¾åœ¨ThreadLocalä¸‹</span></span><br><span class="line">            <span class="comment">// å®ç°äº†è½®è¯¢çš„æ•ˆæœï¼Œä½†æ˜¯åœ¨é‡è¯•çš„æ—¶å€™æ˜¯ä¸ºäº†é€‰æ‹©ä¸Šä¸€æ¬¡å‘é€çš„broker</span></span><br><span class="line">            <span class="keyword">int</span> index = tpInfo.getSendWhichQueue().getAndIncrement();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tpInfo.getMessageQueueList().size(); i++) &#123;</span><br><span class="line">                <span class="keyword">int</span> pos = Math.abs(index++) % tpInfo.getMessageQueueList().size();</span><br><span class="line">                <span class="keyword">if</span> (pos &lt; <span class="number">0</span>)</span><br><span class="line">                    pos = <span class="number">0</span>;</span><br><span class="line">                <span class="comment">// æ‰¾åˆ°indexå¯¹åº”çš„queue</span></span><br><span class="line">                MessageQueue mq = tpInfo.getMessageQueueList().get(pos);</span><br><span class="line">                <span class="comment">// å¦‚æœqueueå¯¹åº”çš„brokerå¯ç”¨ï¼ˆæ ¹æ®faultItemTableåˆ¤æ–­ï¼‰ï¼Œåˆ™ä½¿ç”¨è¯¥broker</span></span><br><span class="line">                <span class="keyword">if</span> (latencyFaultTolerance.isAvailable(mq.getBrokerName())) &#123;</span><br><span class="line">                    <span class="comment">// ç¬¬ä¸€æ¬¡å‘é€æˆ–è€…æ˜¯é‡è¯•ï¼Œç›´æ¥é€‰</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">null</span> == lastBrokerName || mq.getBrokerName().equals(lastBrokerName))</span><br><span class="line">                        <span class="keyword">return</span> mq;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¦‚æœæ²¡æ‰¾ä¸ªåˆé€‚çš„brokerï¼Œåˆ™ä»æ‰€æœ‰çš„brokerä¸­é€‰æ‹©ä¸€ä¸ªç›¸å¯¹åˆé€‚çš„ï¼Œå¹¶ä¸”æ˜¯å¯å†™çš„broker</span></span><br><span class="line">            <span class="comment">// ç›¸å¯¹åˆé€‚æ˜¯æŒ‡ å¯ç”¨/å»¶è¿Ÿä½/ä¸Šæ¬¡ä¸å¯ç”¨æ—¶é—´æ—©</span></span><br><span class="line">            <span class="keyword">final</span> String notBestBroker = latencyFaultTolerance.pickOneAtLeast();</span><br><span class="line">            <span class="keyword">int</span> writeQueueNums = tpInfo.getQueueIdByBroker(notBestBroker);</span><br><span class="line">            <span class="keyword">if</span> (writeQueueNums &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> MessageQueue mq = tpInfo.selectOneMessageQueue();</span><br><span class="line">                <span class="keyword">if</span> (notBestBroker != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mq.setBrokerName(notBestBroker);</span><br><span class="line">                    mq.setQueueId(tpInfo.getSendWhichQueue().getAndIncrement() % writeQueueNums);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> mq;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                latencyFaultTolerance.remove(notBestBroker);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">"Error occurred when selecting message queue"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> tpInfo.selectOneMessageQueue();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æœªå¼€å¯å»¶æ—¶å®¹é”™ï¼Œç›´æ¥æŒ‰é¡ºåºé€‰ä¸‹ä¸€ä¸ª</span></span><br><span class="line">    <span class="keyword">return</span> tpInfo.selectOneMessageQueue(lastBrokerName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å…³äºqueueé€‰æ‹©æœ‰å¾ˆå¤šç»†èŠ‚å¯ä»¥è¯´ï¼Œçœ‹ä»¥åæ˜¯ä¸æ˜¯å•ç‹¬æ‹å‡ºæ¥è¯´ä¸€ä¸‹ï¼Œè¿™é‡Œç»™ä¸ªå»¶è¿Ÿçš„ç»“è®ºï¼šå½“å‘é€æ—¶é•¿ä½äº100msæ—¶ï¼Œè®¾ç½®brokerä¸å¯ç”¨æ—¶é•¿ä¸º0ï¼Œä¹‹åä¾æ¬¡å¢åŠ ï¼Œå¦‚æœè¶…è¿‡15ç§’ï¼Œåˆ™æœ‰10åˆ†é’Ÿä¸å¯ç”¨ã€‚å¯ä»¥çœ‹åˆ°å¦‚æœä¸Šæ¬¡å‘é€å¤±è´¥çš„è¯ï¼Œä¹Ÿæ˜¯10åˆ†é’Ÿä¸å¯ç”¨ï¼Œå¦‚æœé‡è¯•è‚¯å®šä¸ä¼šé€‰æ‹©ç›¸åŒçš„brokerï¼Œå³ä¸ä¼šé€‰æ‹©ä¸å¯ç”¨çš„brokerã€‚</p>
<h2 id="æ¶ˆæ¯å‘é€-1"><a href="#æ¶ˆæ¯å‘é€-1" class="headerlink" title="æ¶ˆæ¯å‘é€"></a>æ¶ˆæ¯å‘é€</h2><p>å…³æ³¨DefaultMQProducerImpl#sendKernelImpl()æ–¹æ³•:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> SendResult <span class="title">sendKernelImpl</span><span class="params">(<span class="keyword">final</span> Message msg,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  <span class="keyword">final</span> MessageQueue mq,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  <span class="keyword">final</span> CommunicationMode communicationMode,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  <span class="keyword">final</span> SendCallback sendCallback,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  <span class="keyword">final</span> TopicPublishInfo topicPublishInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  <span class="keyword">final</span> <span class="keyword">long</span> timeout)</span> <span class="keyword">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> beginStartTime = System.currentTimeMillis();</span><br><span class="line">    <span class="comment">// æ ¹æ®brokerNameä»ç¼“å­˜ä¸­è·å–brokerçš„åœ°å€</span></span><br><span class="line">    String brokerAddr = <span class="keyword">this</span>.mQClientFactory.findBrokerAddressInPublish(mq.getBrokerName());</span><br><span class="line">    <span class="comment">// å¦‚æœåœ°å€ä¸ºç©ºï¼Œåˆ™ä»namesrvä¸­å†è·å–ä¸€æ¬¡</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == brokerAddr) &#123;</span><br><span class="line">        tryToFindTopicPublishInfo(mq.getTopic());</span><br><span class="line">        <span class="comment">// é‡æ–°è·å–</span></span><br><span class="line">        brokerAddr = <span class="keyword">this</span>.mQClientFactory.findBrokerAddressInPublish(mq.getBrokerName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SendMessageContext context = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (brokerAddr != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// åˆ‡æ¢åˆ°VIP channel</span></span><br><span class="line">        <span class="comment">// Brokerå¯åŠ¨æ—¶ä¼šå¼€å¯2ä¸ªç«¯å£æ¥æ”¶å®¢æˆ·ç«¯æ•°æ®ï¼Œå…¶ä¸­ä¸€ä¸ªç«¯å£åªæ¥æ”¶producerçš„æ¶ˆæ¯ï¼Œä¸æ¥å—consumerçš„æ‹‰å–è¯·æ±‚ï¼Œè¢«ç§°ä¸ºVIP channel</span></span><br><span class="line">        brokerAddr = MixAll.brokerVIPChannel(<span class="keyword">this</span>.defaultMQProducer.isSendMessageWithVIPChannel(), brokerAddr);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] prevBody = msg.getBody();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//for MessageBatch,ID has been set in the generating process</span></span><br><span class="line">            <span class="comment">// å¦‚æœä¸æ˜¯æ‰¹é‡å‘é€åˆ™å®¢æˆ·ç«¯è®¾ç½®çš„id</span></span><br><span class="line">            <span class="keyword">if</span> (!(msg <span class="keyword">instanceof</span> MessageBatch)) &#123;</span><br><span class="line">                MessageClientIDSetter.setUniqID(msg);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> sysFlag = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">boolean</span> msgBodyCompressed = <span class="keyword">false</span>;</span><br><span class="line">            <span class="comment">// å¦‚æœæ¶ˆæ¯bodyè¿‡é•¿ï¼Œåˆ™å‹ç¼©å¹¶è®¾ç½®æ ‡è®°ä½</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.tryToCompressMessage(msg)) &#123;</span><br><span class="line">                sysFlag |= MessageSysFlag.COMPRESSED_FLAG;</span><br><span class="line">                msgBodyCompressed = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// äº‹åŠ¡æ¶ˆæ¯æ ‡è®°</span></span><br><span class="line">            <span class="keyword">final</span> String tranMsg = msg.getProperty(MessageConst.PROPERTY_TRANSACTION_PREPARED);</span><br><span class="line">            <span class="keyword">if</span> (tranMsg != <span class="keyword">null</span> &amp;&amp; Boolean.parseBoolean(tranMsg)) &#123;</span><br><span class="line">                sysFlag |= MessageSysFlag.TRANSACTION_PREPARED_TYPE;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// çœç•¥ä¸é‡è¦é€»è¾‘</span></span><br><span class="line">            <span class="comment">// è®¾ç½®æ¶ˆæ¯å¤´</span></span><br><span class="line">            SendMessageRequestHeader requestHeader = <span class="keyword">new</span> SendMessageRequestHeader();</span><br><span class="line">            requestHeader.setProducerGroup(<span class="keyword">this</span>.defaultMQProducer.getProducerGroup());</span><br><span class="line">            requestHeader.setTopic(msg.getTopic());</span><br><span class="line">            requestHeader.setDefaultTopic(<span class="keyword">this</span>.defaultMQProducer.getCreateTopicKey());</span><br><span class="line">            requestHeader.setDefaultTopicQueueNums(<span class="keyword">this</span>.defaultMQProducer.getDefaultTopicQueueNums());</span><br><span class="line">            requestHeader.setQueueId(mq.getQueueId());</span><br><span class="line">            requestHeader.setSysFlag(sysFlag);</span><br><span class="line">            requestHeader.setBornTimestamp(System.currentTimeMillis());</span><br><span class="line">            requestHeader.setFlag(msg.getFlag());</span><br><span class="line">            requestHeader.setProperties(MessageDecoder.messageProperties2String(msg.getProperties()));</span><br><span class="line">            requestHeader.setReconsumeTimes(<span class="number">0</span>);</span><br><span class="line">            requestHeader.setUnitMode(<span class="keyword">this</span>.isUnitMode());</span><br><span class="line">            requestHeader.setBatch(msg <span class="keyword">instanceof</span> MessageBatch);</span><br><span class="line">            <span class="comment">// è¦æ±‚é‡æ–°å‘é€çš„æ¶ˆæ¯ï¼Œè®¾ç½®é‡è¯•æ¬¡æ•°å’Œå»¶æ—¶æ—¶é—´</span></span><br><span class="line">            <span class="keyword">if</span> (requestHeader.getTopic().startsWith(MixAll.RETRY_GROUP_TOPIC_PREFIX)) &#123;</span><br><span class="line">                String reconsumeTimes = MessageAccessor.getReconsumeTime(msg);</span><br><span class="line">                <span class="keyword">if</span> (reconsumeTimes != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    requestHeader.setReconsumeTimes(Integer.valueOf(reconsumeTimes));</span><br><span class="line">                    MessageAccessor.clearProperty(msg, MessageConst.PROPERTY_RECONSUME_TIME);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                String maxReconsumeTimes = MessageAccessor.getMaxReconsumeTimes(msg);</span><br><span class="line">                <span class="keyword">if</span> (maxReconsumeTimes != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    requestHeader.setMaxReconsumeTimes(Integer.valueOf(maxReconsumeTimes));</span><br><span class="line">                    MessageAccessor.clearProperty(msg, MessageConst.PROPERTY_MAX_RECONSUME_TIMES);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            SendResult sendResult = <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">// é€šè¿‡NettyClientå‘é€æ¶ˆæ¯åˆ°Broker</span></span><br><span class="line">            <span class="keyword">switch</span> (communicationMode) &#123;</span><br><span class="line">                <span class="keyword">case</span> ASYNC:</span><br><span class="line">                    Message tmpMessage = msg;</span><br><span class="line">                    <span class="keyword">if</span> (msgBodyCompressed) &#123;</span><br><span class="line">                        <span class="comment">//If msg body was compressed, msgbody should be reset using prevBody.</span></span><br><span class="line">                        <span class="comment">//Clone new message using commpressed message body and recover origin massage.</span></span><br><span class="line">                        <span class="comment">//Fix bug:https://github.com/apache/rocketmq-externals/issues/66</span></span><br><span class="line">                        tmpMessage = MessageAccessor.cloneMessage(msg);</span><br><span class="line">                        msg.setBody(prevBody);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">long</span> costTimeAsync = System.currentTimeMillis() - beginStartTime;</span><br><span class="line">                    <span class="keyword">if</span> (timeout &lt; costTimeAsync) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> RemotingTooMuchRequestException(<span class="string">"sendKernelImpl call timeout"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// å®é™…å‘é€æ¶ˆæ¯çš„ä½ç½®</span></span><br><span class="line">                    sendResult = <span class="keyword">this</span>.mQClientFactory.getMQClientAPIImpl().sendMessage(</span><br><span class="line">                        brokerAddr,</span><br><span class="line">                        mq.getBrokerName(),</span><br><span class="line">                        tmpMessage,</span><br><span class="line">                        requestHeader,</span><br><span class="line">                        timeout - costTimeAsync,</span><br><span class="line">                        communicationMode,</span><br><span class="line">                        sendCallback,</span><br><span class="line">                        topicPublishInfo,</span><br><span class="line">                        <span class="keyword">this</span>.mQClientFactory,</span><br><span class="line">                        <span class="keyword">this</span>.defaultMQProducer.getRetryTimesWhenSendAsyncFailed(),</span><br><span class="line">                        context,</span><br><span class="line">                        <span class="keyword">this</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> ONEWAY:</span><br><span class="line">                <span class="keyword">case</span> SYNC:</span><br><span class="line">                    <span class="keyword">long</span> costTimeSync = System.currentTimeMillis() - beginStartTime;</span><br><span class="line">                    <span class="keyword">if</span> (timeout &lt; costTimeSync) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> RemotingTooMuchRequestException(<span class="string">"sendKernelImpl call timeout"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    sendResult = <span class="keyword">this</span>.mQClientFactory.getMQClientAPIImpl().sendMessage(</span><br><span class="line">                        brokerAddr,</span><br><span class="line">                        mq.getBrokerName(),</span><br><span class="line">                        msg,</span><br><span class="line">                        requestHeader,</span><br><span class="line">                        timeout - costTimeSync,</span><br><span class="line">                        communicationMode,</span><br><span class="line">                        context,</span><br><span class="line">                        <span class="keyword">this</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">assert</span> <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.hasSendMessageHook()) &#123;</span><br><span class="line">                context.setSendResult(sendResult);</span><br><span class="line">                <span class="keyword">this</span>.executeSendMessageHookAfter(context);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> sendResult;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemotingException e) &#123;</span><br><span class="line">           <span class="comment">// ... çœç•¥å¼‚å¸¸å¤„ç†</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            msg.setBody(prevBody);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> MQClientException(<span class="string">"The broker["</span> + mq.getBrokerName() + <span class="string">"] not exist"</span>, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>åˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼é™¤äº†é˜Ÿåˆ—é€‰æ‹©é€»è¾‘æœ‰ç‚¹å¤æ‚ï¼Œå…¶ä»–è¿˜å¥½ï¼Œä½†æ˜¯è¿˜æ˜¯è¦å¥½å¥½å»ä½“ä¼š~</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol>
<li><a href="https://www.jianshu.com/p/02dbc0710f80" target="_blank" rel="noopener">RocketMQæºç è§£æ(ä¸‰)-Producer</a></li>
<li><a href="[http://b.shiwuliang.com/RocketMQ%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB%E2%80%94%E2%80%94%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81%E4%B9%8B%E9%80%89%E6%8B%A9%E9%98%9F%E5%88%97%E5%B9%B6%E5%8F%91%E9%80%81.html](http://b.shiwuliang.com/RocketMQ%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB%E2%80%94%E2%80%94%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81%E4%B9%8B%E9%80%89%E6%8B%A9%E9%98%9F%E5%88%97%E5%B9%B6%E5%8F%91%E9%80%81.html">RocketMQæºç è§£è¯»â€”â€”æ¶ˆæ¯å‘é€ä¹‹é€‰æ‹©é˜Ÿåˆ—å¹¶å‘é€</a></li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¼•ï¼šä½¿ç”¨MQï¼Œç¬¬ä¸€æ­¥æ„é€ Producerï¼Œç„¶åå°±å¯ä»¥å¼€å§‹å‘é€æ¶ˆæ¯å•¦ï¼
    
    </summary>
    
      <category term="RocketMQæºç " scheme="http://bestlixiang.site/categories/RocketMQ%E6%BA%90%E7%A0%81/"/>
    
    
      <category term="RocketMQ" scheme="http://bestlixiang.site/tags/RocketMQ/"/>
    
  </entry>
  
  <entry>
    <title>RocketMQæºç åˆ†æâ€”â€”Namesrv</title>
    <link href="http://bestlixiang.site/2019/06/09/RocketMQ%E6%BA%90%E7%A0%81/RocketMQ%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E2%80%94%E2%80%94Namesrv/"/>
    <id>http://bestlixiang.site/2019/06/09/RocketMQæºç /RocketMQæºç åˆ†æâ€”â€”Namesrv/</id>
    <published>2019-06-09T10:17:12.000Z</published>
    <updated>2019-06-09T10:19:31.294Z</updated>
    
    <content type="html"><![CDATA[<p>å¼•ï¼šNameSrvæ˜¯RocketMQçš„æ³¨å†Œä¸­å¿ƒï¼Œä¿å­˜æ‰€æœ‰Brokerã€Topicçš„å…ƒæ•°æ®ã€‚Brokerå¯åŠ¨åä¼šå‘namesrvå‘é€å¿ƒè·³ï¼Œnamesrvä¹Ÿä¼šå®šæ—¶æ£€æµ‹brokerçš„å¯ç”¨æ€§ï¼Œå¹¶ç§»é™¤ä¸å¯ç”¨çš„brokerã€‚å¯¹äºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ¥è¯´ï¼Œå®ƒæä¾›äº†Brokerçš„æŸ¥è¯¢æœåŠ¡ã€‚<a id="more"></a></p>
<h1 id="NameSrvå¯åŠ¨"><a href="#NameSrvå¯åŠ¨" class="headerlink" title="NameSrvå¯åŠ¨"></a>NameSrvå¯åŠ¨</h1><p>æˆ‘ä»¬æŒ‰ç…§æŒ‰ç…§ä¸Šä¸€ç¯‡ç¯å¢ƒæ­å»ºçš„<code>#org.apache.rocketmq.namesrv.NameServerInstanceTest</code>å‡ºå‘ï¼Œæˆ‘ä»¬çœ‹åˆ°Mainå‡½æ•°ï¼Œå¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    NamesrvConfig namesrvConfig1 = <span class="keyword">new</span> NamesrvConfig();</span><br><span class="line">    NettyServerConfig nettyServerConfig1 = <span class="keyword">new</span> NettyServerConfig();</span><br><span class="line">    nettyServerConfig1.setListenPort(<span class="number">9876</span>);</span><br><span class="line">    NamesrvController nameSrvController1 = <span class="keyword">new</span> NamesrvController(namesrvConfig1, nettyServerConfig1);</span><br><span class="line">    nameSrvController1.initialize();</span><br><span class="line">    nameSrvController1.start();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸è®©ä¸»æ–¹æ³•ç»“æŸ</span></span><br><span class="line">    Thread.sleep(DateUtils.MILLIS_PER_DAY);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬å‘ç°ä¸»è¦æœ‰ä¸‰ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>æ„é€ NamesrvController</li>
<li>åˆå§‹åŒ–NamesrvController</li>
<li>å¯åŠ¨NamesrvController</li>
</ol>
<p>å¯è§NamesrvControlleræ˜¯å…³é”®ï¼Œè´Ÿè´£åˆå§‹åŒ–å’Œåå°ä»»åŠ¡å¯åŠ¨ã€‚</p>
<h2 id="æ„é€ NamesrvController"><a href="#æ„é€ NamesrvController" class="headerlink" title="æ„é€ NamesrvController"></a>æ„é€ NamesrvController</h2><p><code>org.apache.rocketmq.namesrv.NamesrvController</code>çš„æ„é€ å‡½æ•°å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">NamesrvController</span><span class="params">(NamesrvConfig namesrvConfig, NettyServerConfig nettyServerConfig)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// namesrvå‚æ•°é…ç½®</span></span><br><span class="line">    <span class="keyword">this</span>.namesrvConfig = namesrvConfig;</span><br><span class="line">    <span class="comment">// nettyçš„å‚æ•°é…ç½®</span></span><br><span class="line">    <span class="keyword">this</span>.nettyServerConfig = nettyServerConfig;</span><br><span class="line">    <span class="comment">// KVConfigManagerç»‘å®šNamesrvController</span></span><br><span class="line">    <span class="keyword">this</span>.kvConfigManager = <span class="keyword">new</span> KVConfigManager(<span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–RouteInfoManagerï¼Œå¾ˆé‡è¦</span></span><br><span class="line">    <span class="keyword">this</span>.routeInfoManager = <span class="keyword">new</span> RouteInfoManager();</span><br><span class="line">    <span class="comment">// ç›‘å¬å®¢æˆ·ç«¯è¿æ¥(Channel)çš„å˜åŒ–ï¼Œé€šçŸ¥RouteInfoManageræ£€æŸ¥brokeræ˜¯å¦æœ‰å˜åŒ–</span></span><br><span class="line">    <span class="keyword">this</span>.brokerHousekeepingService = <span class="keyword">new</span> BrokerHousekeepingService(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">this</span>.configuration = <span class="keyword">new</span> Configuration(</span><br><span class="line">        log,</span><br><span class="line">        <span class="keyword">this</span>.namesrvConfig, <span class="keyword">this</span>.nettyServerConfig</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// namesrvçš„é…ç½®å‚æ•°ä¼šä¿å­˜åˆ°ç£ç›˜æ–‡ä»¶ä¸­</span></span><br><span class="line">    <span class="keyword">this</span>.configuration.setStorePathFromConfig(<span class="keyword">this</span>.namesrvConfig, <span class="string">"configStorePath"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å…¶ä¸­ä¸»è¦çš„å°±æ˜¯<code>org.apache.rocketmq.namesrv.routeinfo.RouteInfoManager</code> å®ƒè´Ÿè´£ç¼“å­˜æ•´ä¸ªé›†ç¾¤çš„brokerä¿¡æ¯ï¼Œä»¥åŠtopicå’Œqueueçš„é…ç½®ä¿¡æ¯ã€‚æˆ‘ä»¬çœ‹çœ‹çš„å†…éƒ¨æ„é€ ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¯»å†™é”ï¼Œæ§åˆ¶å¹¶å‘è¯»å†™</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReadWriteLock lock = <span class="keyword">new</span> ReentrantReadWriteLock();</span><br><span class="line"><span class="comment">// Topicå’ŒBrokerçš„Queueçš„Mapï¼Œä¿å­˜äº†topicåœ¨æ¯ä¸ªbrokerä¸Šçš„è¯»å†™Queueçš„ä¸ªæ•°</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> HashMap&lt;String<span class="comment">/* topic */</span>, List&lt;QueueData&gt;&gt; topicQueueTable;</span><br><span class="line"><span class="comment">// æ³¨å†Œåˆ°namesrvä¸Šçš„æ‰€æœ‰Brokerï¼ŒæŒ‰ç…§brokernameåˆ†ç»„ï¼ŒBrokerä½¿ç”¨brokerNameæ¥æ ‡è¯†ä¸»ä»å…³ç³»</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> HashMap&lt;String<span class="comment">/* brokerName */</span>, BrokerData&gt; brokerAddrTable;</span><br><span class="line"><span class="comment">// brokerçš„é›†ç¾¤å¯¹åº”å…³ç³»ï¼Œä½¿ç”¨clusterNameæ¥åˆ¤æ–­å¤šä¸ªbrokeræ˜¯ä¸æ˜¯å±äºåŒä¸€ä¸ªé›†ç¾¤ã€‚</span></span><br><span class="line"><span class="comment">// å¯¹äºåŒä¸€ä¸ªclusterä¸‹çš„brokerï¼Œproduceråœ¨å‘é€æ¶ˆæ¯æ—¶åªä¼šé€‰æ‹©å‘é€ç»™å…¶ä¸­ä¸€ä¸ª</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> HashMap&lt;String<span class="comment">/* clusterName */</span>, Set&lt;String<span class="comment">/* brokerName */</span>&gt;&gt; clusterAddrTable;</span><br><span class="line"><span class="comment">// brokeræœ€æ–°çš„å¿ƒè·³æ—¶é—´å’Œé…ç½®ç‰ˆæœ¬å·ï¼Œnameservä¼šè®°å½•brokerAddrçš„æœ€åæ´»è·ƒæ—¶é—´ï¼Œ</span></span><br><span class="line"><span class="comment">// å¦‚æœè¶…è¿‡ä¸€å®šæ—¶é—´æ²¡æœ‰å¿ƒè·³æˆ–å…¶ä»–æ•°æ®äº¤äº’ï¼Œä¼šè®¤ä¸ºbrokerå·²ä¸‹çº¿</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> HashMap&lt;String<span class="comment">/* brokerAddr */</span>, BrokerLiveInfo&gt; brokerLiveTable;</span><br><span class="line"><span class="comment">// brokerå’ŒFilterServerçš„å¯¹åº”å…³ç³»</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> HashMap&lt;String<span class="comment">/* brokerAddr */</span>, List&lt;String&gt;<span class="comment">/* Filter Server */</span>&gt; filterServerTable;</span><br></pre></td></tr></table></figure></p>
<p>RouteInfoManagerçš„æ‰€æœ‰æ•°æ®é€šè¿‡HashMapç¼“å­˜åœ¨å†…å­˜ä¸­ï¼Œé€šè¿‡è¯»å†™é”æ¥æ§åˆ¶å¹¶å‘æ›´æ–°ã€‚è¿™æ ·å¯æœ€å¤§ç¨‹åº¦çš„æé«˜å®¢æˆ·ç«¯æŸ¥è¯¢æ•°æ®çš„é€Ÿåº¦ã€‚</p>
<h2 id="åˆå§‹åŒ–NamesrvController"><a href="#åˆå§‹åŒ–NamesrvController" class="headerlink" title="åˆå§‹åŒ–NamesrvController"></a>åˆå§‹åŒ–NamesrvController</h2><p>æˆ‘ä»¬çœ‹çœ‹å®ƒçš„åˆå§‹åŒ–æ–¹æ³•ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">initialize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–KVConfigManager</span></span><br><span class="line">    <span class="keyword">this</span>.kvConfigManager.load();</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–netty server</span></span><br><span class="line">    <span class="keyword">this</span>.remotingServer = <span class="keyword">new</span> NettyRemotingServer(<span class="keyword">this</span>.nettyServerConfig, <span class="keyword">this</span>.brokerHousekeepingService);</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–å®¢æˆ·ç«¯è¯·æ±‚å¤„ç†çš„çº¿ç¨‹æ± </span></span><br><span class="line">    <span class="keyword">this</span>.remotingExecutor =</span><br><span class="line">        Executors.newFixedThreadPool(nettyServerConfig.getServerWorkerThreads(), <span class="keyword">new</span> ThreadFactoryImpl(<span class="string">"RemotingExecutorThread_"</span>));</span><br><span class="line">    <span class="comment">// æ³¨å†ŒDefaultRequestProcessorï¼Œæ‰€æœ‰çš„å®¢æˆ·ç«¯è¯·æ±‚éƒ½ä¼šè½¬ç»™è¿™ä¸ªProcessoræ¥å¤„ç†</span></span><br><span class="line">    <span class="comment">// å®ƒçš„é€»è¾‘åˆ°æ—¶å€™ä¼šå‡ºç°åœ¨NettyServerHandleré‡Œ</span></span><br><span class="line">    <span class="keyword">this</span>.registerProcessor();</span><br><span class="line">    <span class="comment">// å¯åŠ¨å®šæ—¶è°ƒåº¦ï¼Œæ¯10ç§’é’Ÿæ‰«ææ‰€æœ‰Brokerï¼Œæ£€æŸ¥å­˜æ´»çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            NamesrvController.<span class="keyword">this</span>.routeInfoManager.scanNotActiveBroker();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="number">5</span>, <span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">    <span class="comment">// æ—¥å¿—æ‰“å°çš„è°ƒåº¦å™¨ï¼Œå®šæ—¶æ‰“å°kvConfigManagerçš„å†…å®¹</span></span><br><span class="line">    <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            NamesrvController.<span class="keyword">this</span>.kvConfigManager.printAllPeriodically();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="number">1</span>, <span class="number">10</span>, TimeUnit.MINUTES);</span><br><span class="line">    <span class="comment">// ç›‘å¬sslè¯ä¹¦æ–‡ä»¶å˜åŒ–</span></span><br><span class="line">    <span class="keyword">if</span> (TlsSystemConfig.tlsMode != TlsMode.DISABLED) &#123;</span><br><span class="line">        <span class="comment">// Register a listener to reload SslContext</span></span><br><span class="line">       <span class="comment">// çœç•¥æ— ç”¨é€»è¾‘</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬å¯ä»¥ç¨å¾®çœ‹çœ‹å®ƒæ˜¯æ€æ ·è¸¢å‡ºæ— æ•ˆé“¾æ¥çš„ï¼Œä»£ç åœ¨<code>org.apache.rocketmq.namesrv.routeinfo.RouteInfoManager</code>ä¸­ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scanNotActiveBroker</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Iterator&lt;Entry&lt;String, BrokerLiveInfo&gt;&gt; it = <span class="keyword">this</span>.brokerLiveTable.entrySet().iterator();</span><br><span class="line">    <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">        Entry&lt;String, BrokerLiveInfo&gt; next = it.next();</span><br><span class="line">        <span class="keyword">long</span> last = next.getValue().getLastUpdateTimestamp();</span><br><span class="line">        <span class="comment">// é»˜è®¤120ç§’</span></span><br><span class="line">        <span class="keyword">if</span> ((last + BROKER_CHANNEL_EXPIRED_TIME) &lt; System.currentTimeMillis()) &#123;</span><br><span class="line">            RemotingUtil.closeChannel(next.getValue().getChannel());</span><br><span class="line">            it.remove();</span><br><span class="line">            <span class="keyword">this</span>.onChannelDestroy(next.getKey(), next.getValue().getChannel());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="å¯åŠ¨NamesrvController"><a href="#å¯åŠ¨NamesrvController" class="headerlink" title="å¯åŠ¨NamesrvController"></a>å¯åŠ¨NamesrvController</h2><p>å¯åŠ¨çš„è¿‡ç¨‹å°±æ˜¯å¯åŠ¨netty serverå¼€å§‹æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚ï¼Œä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// å¼€å¯Netty Server</span></span><br><span class="line">    <span class="keyword">this</span>.remotingServer.start();</span><br><span class="line">    <span class="comment">// ç›‘å¬sslæ–‡ä»¶å˜åŒ–ï¼Œå¯ä»¥å®æ—¶æ›´æ–°è¯ä¹¦</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.fileWatchService != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.fileWatchService.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>åˆ°è¿™é‡Œï¼ŒNamesrvå°±å¯åŠ¨å®Œæˆäº†ï¼Œä¸‹é¢æˆ‘ä»¬å°†è®²ä¸€ä¸‹å®ƒæœ€é‡è¦çš„ä¸¤ä¸ªåŠŸèƒ½Brokeræ³¨å†Œï¼ˆç®¡ç†ï¼‰å’ŒBrokeræŸ¥è¯¢ã€‚</p>
<h1 id="DefaultRequestProcessorè¯·æ±‚å¤„ç†"><a href="#DefaultRequestProcessorè¯·æ±‚å¤„ç†" class="headerlink" title="DefaultRequestProcessorè¯·æ±‚å¤„ç†"></a>DefaultRequestProcessorè¯·æ±‚å¤„ç†</h1><p>åœ¨è®²Brokeræ³¨å†Œï¼ˆç®¡ç†ï¼‰å’ŒBrokeræŸ¥è¯¢ä¹‹å‰æˆ‘ä»¬è¦å°†ä¸€ä¸‹DefaultRequestProcessorï¼Œå› ä¸ºæ‰€æœ‰è¯·æ±‚éƒ½ä¼šè¢«å®ƒå¤„ç†ï¼Œåœ¨ä¸Šé¢åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿçœ‹åˆ°äº†å®ƒè¢«æ³¨å†Œåˆ°Nettyçš„Pipelineä¸Šã€‚<br>ä¸‹é¢æˆ‘å°±çœ‹çœ‹<code>org.apache.rocketmq.namesrv.processor.DefaultRequestProcessor #processRequest</code>æ–¹æ³•æ˜¯å¦‚ä½•å¤„ç†è¯·æ±‚çš„ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> RemotingCommand <span class="title">processRequest</span><span class="params">(ChannelHandlerContext ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">    RemotingCommand request)</span> <span class="keyword">throws</span> RemotingCommandException </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// çœç•¥æ— ç”¨é€»è¾‘</span></span><br><span class="line">    <span class="keyword">switch</span> (request.getCode()) &#123;</span><br><span class="line">        <span class="keyword">case</span> RequestCode.PUT_KV_CONFIG:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.putKVConfig(ctx, request);</span><br><span class="line">        <span class="keyword">case</span> RequestCode.GET_KV_CONFIG:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.getKVConfig(ctx, request);</span><br><span class="line">        <span class="keyword">case</span> RequestCode.DELETE_KV_CONFIG:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.deleteKVConfig(ctx, request);</span><br><span class="line">        <span class="keyword">case</span> RequestCode.QUERY_DATA_VERSION:</span><br><span class="line">            <span class="keyword">return</span> queryBrokerTopicConfig(ctx, request);</span><br><span class="line">        <span class="comment">// Brokeræ³¨å†Œ</span></span><br><span class="line">        <span class="keyword">case</span> RequestCode.REGISTER_BROKER:</span><br><span class="line">            Version brokerVersion = MQVersion.value2Version(request.getVersion());</span><br><span class="line">            <span class="keyword">if</span> (brokerVersion.ordinal() &gt;= MQVersion.Version.V3_0_11.ordinal()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.registerBrokerWithFilterServer(ctx, request);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.registerBroker(ctx, request);</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="comment">// Brokeræ³¨é”€</span></span><br><span class="line">        <span class="keyword">case</span> RequestCode.UNREGISTER_BROKER:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.unregisterBroker(ctx, request);</span><br><span class="line">        <span class="comment">// æ ¹æ®Topicæ‹¿åˆ°Brokerè·¯ç”±ä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">case</span> RequestCode.GET_ROUTEINTO_BY_TOPIC:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.getRouteInfoByTopic(ctx, request);</span><br><span class="line">        <span class="comment">// æ‹¿åˆ°Brokeré›†ç¾¤ä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">case</span> RequestCode.GET_BROKER_CLUSTER_INFO:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.getBrokerClusterInfo(ctx, request);</span><br><span class="line">        <span class="keyword">case</span> RequestCode.WIPE_WRITE_PERM_OF_BROKER:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.wipeWritePermOfBroker(ctx, request);</span><br><span class="line">        <span class="keyword">case</span> RequestCode.GET_ALL_TOPIC_LIST_FROM_NAMESERVER:</span><br><span class="line">            <span class="keyword">return</span> getAllTopicListFromNameserver(ctx, request);</span><br><span class="line">        <span class="keyword">case</span> RequestCode.DELETE_TOPIC_IN_NAMESRV:</span><br><span class="line">            <span class="keyword">return</span> deleteTopicInNamesrv(ctx, request);</span><br><span class="line">        <span class="keyword">case</span> RequestCode.GET_KVLIST_BY_NAMESPACE:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.getKVListByNamespace(ctx, request);</span><br><span class="line">        <span class="keyword">case</span> RequestCode.GET_TOPICS_BY_CLUSTER:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.getTopicsByCluster(ctx, request);</span><br><span class="line">        <span class="keyword">case</span> RequestCode.GET_SYSTEM_TOPIC_LIST_FROM_NS:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.getSystemTopicListFromNs(ctx, request);</span><br><span class="line">        <span class="keyword">case</span> RequestCode.GET_UNIT_TOPIC_LIST:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.getUnitTopicList(ctx, request);</span><br><span class="line">        <span class="keyword">case</span> RequestCode.GET_HAS_UNIT_SUB_TOPIC_LIST:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.getHasUnitSubTopicList(ctx, request);</span><br><span class="line">        <span class="keyword">case</span> RequestCode.GET_HAS_UNIT_SUB_UNUNIT_TOPIC_LIST:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.getHasUnitSubUnUnitTopicList(ctx, request);</span><br><span class="line">        <span class="keyword">case</span> RequestCode.UPDATE_NAMESRV_CONFIG:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.updateConfig(ctx, request);</span><br><span class="line">        <span class="keyword">case</span> RequestCode.GET_NAMESRV_CONFIG:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.getConfig(ctx, request);</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å¤„ç†å™¨æ ¹æ®RemotingCommandä¸­çš„è¯·æ±‚ç å°†æ‰§è¡Œå…·ä½“çš„è¯·æ±‚é€»è¾‘ï¼Œä¸‹é¢æˆ‘ä»¬é‡ç‚¹åˆ†æä¸€ä¸‹Brokeræ³¨å†Œå’ŒæŸ¥è¯¢ã€‚</p>
<h1 id="Brokeræ³¨å†Œ"><a href="#Brokeræ³¨å†Œ" class="headerlink" title="Brokeræ³¨å†Œ"></a>Brokeræ³¨å†Œ</h1><p>æ ¹æ®ä¸Šé¢DefaultRequestProcessorçš„å¤„ç†é€»è¾‘ï¼Œæˆ‘ä»¬æ‰¾åˆ°<code>#registerBroker</code>æ–¹æ³•ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> RemotingCommand <span class="title">registerBroker</span><span class="params">(ChannelHandlerContext ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">    RemotingCommand request)</span> <span class="keyword">throws</span> RemotingCommandException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> RemotingCommand response = RemotingCommand.createResponseCommand(RegisterBrokerResponseHeader.class);</span><br><span class="line">    <span class="keyword">final</span> RegisterBrokerResponseHeader responseHeader = (RegisterBrokerResponseHeader) response.readCustomHeader();</span><br><span class="line">    <span class="keyword">final</span> RegisterBrokerRequestHeader requestHeader =</span><br><span class="line">        (RegisterBrokerRequestHeader) request.decodeCommandCustomHeader(RegisterBrokerRequestHeader.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... çœç•¥æ ¡éªŒ</span></span><br><span class="line">    <span class="comment">// topicç›¸å…³é…ç½®</span></span><br><span class="line">    TopicConfigSerializeWrapper topicConfigWrapper;</span><br><span class="line">    <span class="keyword">if</span> (request.getBody() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        topicConfigWrapper = TopicConfigSerializeWrapper.decode(request.getBody(), TopicConfigSerializeWrapper.class);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        topicConfigWrapper = <span class="keyword">new</span> TopicConfigSerializeWrapper();</span><br><span class="line">        topicConfigWrapper.getDataVersion().setCounter(<span class="keyword">new</span> AtomicLong(<span class="number">0</span>));</span><br><span class="line">        topicConfigWrapper.getDataVersion().setTimestamp(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ ¹æ®brokerä¸ŠæŠ¥çš„ä¿¡æ¯æ›´æ–°namesrvçš„RouteInfo</span></span><br><span class="line">    RegisterBrokerResult result = <span class="keyword">this</span>.namesrvController.getRouteInfoManager().registerBroker(</span><br><span class="line">        requestHeader.getClusterName(),</span><br><span class="line">        requestHeader.getBrokerAddr(),</span><br><span class="line">        requestHeader.getBrokerName(),</span><br><span class="line">        requestHeader.getBrokerId(),</span><br><span class="line">        requestHeader.getHaServerAddr(),</span><br><span class="line">        topicConfigWrapper,</span><br><span class="line">        <span class="keyword">null</span>,</span><br><span class="line">        ctx.channel()</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// è¿”å›masterå’Œhaserveråœ°å€</span></span><br><span class="line">    responseHeader.setHaServerAddr(result.getHaServerAddr());</span><br><span class="line">    responseHeader.setMasterAddr(result.getMasterAddr());</span><br><span class="line">    <span class="comment">// å°†topicçš„KVé…ç½®ä¿¡æ¯é€šè¿‡responseè¿”å›</span></span><br><span class="line">    <span class="keyword">byte</span>[] jsonValue = <span class="keyword">this</span>.namesrvController.getKvConfigManager().getKVListByNamespace(NamesrvUtil.NAMESPACE_ORDER_TOPIC_CONFIG);</span><br><span class="line">    response.setBody(jsonValue);</span><br><span class="line">    response.setCode(ResponseCode.SUCCESS);</span><br><span class="line">    response.setRemark(<span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">return</span> response;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ä¸‹é¢æˆ‘ä»¬ç»§ç»­çœ‹çœ‹å¦‚ä½•æ›´æ–°namesrvçš„RouteInfoï¼Œæ‰¾åˆ°<code>org.apache.rocketmq.namesrv.routeinfo.RouteInfoManager#registerBroker</code>ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> RegisterBrokerResult <span class="title">registerBroker</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">final</span> String clusterName,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">final</span> String brokerAddr,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">final</span> String brokerName,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">final</span> <span class="keyword">long</span> brokerId,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">final</span> String haServerAddr,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">final</span> TopicConfigSerializeWrapper topicConfigWrapper,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">final</span> List&lt;String&gt; filterServerList,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">final</span> Channel channel)</span> </span>&#123;</span><br><span class="line">    RegisterBrokerResult result = <span class="keyword">new</span> RegisterBrokerResult();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// æ›´æ–°åŠ é”</span></span><br><span class="line">            <span class="keyword">this</span>.lock.writeLock().lockInterruptibly();</span><br><span class="line">            <span class="comment">// æ›´æ–°clusterå’Œbrokerå¯¹åº”å…³ç³»</span></span><br><span class="line">            Set&lt;String&gt; brokerNames = <span class="keyword">this</span>.clusterAddrTable.get(clusterName);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> == brokerNames) &#123;</span><br><span class="line">                brokerNames = <span class="keyword">new</span> HashSet&lt;String&gt;();</span><br><span class="line">                <span class="keyword">this</span>.clusterAddrTable.put(clusterName, brokerNames);</span><br><span class="line">            &#125;</span><br><span class="line">            brokerNames.add(brokerName);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">boolean</span> registerFirst = <span class="keyword">false</span>;</span><br><span class="line">            <span class="comment">// æ›´æ–°brokernameå’Œbrokerdataçš„åˆ†ç»„</span></span><br><span class="line">            BrokerData brokerData = <span class="keyword">this</span>.brokerAddrTable.get(brokerName);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> == brokerData) &#123;</span><br><span class="line">                registerFirst = <span class="keyword">true</span>;</span><br><span class="line">                brokerData = <span class="keyword">new</span> BrokerData(clusterName, brokerName, <span class="keyword">new</span> HashMap&lt;Long, String&gt;());</span><br><span class="line">                <span class="keyword">this</span>.brokerAddrTable.put(brokerName, brokerData);</span><br><span class="line">            &#125;</span><br><span class="line">            String oldAddr = brokerData.getBrokerAddrs().put(brokerId, brokerAddr);</span><br><span class="line">            registerFirst = registerFirst || (<span class="keyword">null</span> == oldAddr);</span><br><span class="line">            <span class="comment">// å¦‚æœæ˜¯master brokerï¼Œç¬¬ä¸€æ¬¡æ³¨å†Œæˆ–è€…æ˜¯topicä¿¡æ¯å‘ç”Ÿå˜åŒ–äº†ï¼Œæ›´æ–°topicQueueTable</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> != topicConfigWrapper</span><br><span class="line">                &amp;&amp; MixAll.MASTER_ID == brokerId) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.isBrokerTopicConfigChanged(brokerAddr, topicConfigWrapper.getDataVersion())</span><br><span class="line">                    || registerFirst) &#123;</span><br><span class="line">                    ConcurrentMap&lt;String, TopicConfig&gt; tcTable =</span><br><span class="line">                        topicConfigWrapper.getTopicConfigTable();</span><br><span class="line">                    <span class="keyword">if</span> (tcTable != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">for</span> (Map.Entry&lt;String, TopicConfig&gt; entry : tcTable.entrySet()) &#123;</span><br><span class="line">                            <span class="keyword">this</span>.createAndUpdateQueueData(brokerName, entry.getValue());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æ›´æ–°brokerçš„å¿ƒè·³æ—¶é—´</span></span><br><span class="line">            BrokerLiveInfo prevBrokerLiveInfo = <span class="keyword">this</span>.brokerLiveTable.put(brokerAddr,</span><br><span class="line">                <span class="keyword">new</span> BrokerLiveInfo(</span><br><span class="line">                    System.currentTimeMillis(),</span><br><span class="line">                    topicConfigWrapper.getDataVersion(),</span><br><span class="line">                    channel,</span><br><span class="line">                    haServerAddr));</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> == prevBrokerLiveInfo) &#123;</span><br><span class="line">                log.info(<span class="string">"new broker registered, &#123;&#125; HAServer: &#123;&#125;"</span>, brokerAddr, haServerAddr);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æ›´æ–°filter server table</span></span><br><span class="line">            <span class="keyword">if</span> (filterServerList != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (filterServerList.isEmpty()) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.filterServerTable.remove(brokerAddr);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">this</span>.filterServerTable.put(brokerAddr, filterServerList);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¦‚æœæ˜¯slave brokeræ³¨å†Œï¼Œå¦‚æœmasterå­˜åœ¨ï¼Œåˆ™è¿”å›master brokerä¿¡æ¯</span></span><br><span class="line">            <span class="keyword">if</span> (MixAll.MASTER_ID != brokerId) &#123;</span><br><span class="line">                String masterAddr = brokerData.getBrokerAddrs().get(MixAll.MASTER_ID);</span><br><span class="line">                <span class="keyword">if</span> (masterAddr != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    BrokerLiveInfo brokerLiveInfo = <span class="keyword">this</span>.brokerLiveTable.get(masterAddr);</span><br><span class="line">                    <span class="keyword">if</span> (brokerLiveInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        result.setHaServerAddr(brokerLiveInfo.getHaServerAddr());</span><br><span class="line">                        result.setMasterAddr(masterAddr);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.lock.writeLock().unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">"registerBroker Exception"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="BrokeræŸ¥è¯¢"><a href="#BrokeræŸ¥è¯¢" class="headerlink" title="BrokeræŸ¥è¯¢"></a>BrokeræŸ¥è¯¢</h1><p>æ ¹æ®ä¸Šé¢DefaultRequestProcessorçš„å¤„ç†é€»è¾‘ï¼Œæˆ‘ä»¬æ‰¾åˆ°<code>#getRouteInfoByTopic</code>æ–¹æ³•ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> RemotingCommand <span class="title">getRouteInfoByTopic</span><span class="params">(ChannelHandlerContext ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">    RemotingCommand request)</span> <span class="keyword">throws</span> RemotingCommandException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> RemotingCommand response = RemotingCommand.createResponseCommand(<span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">final</span> GetRouteInfoRequestHeader requestHeader =</span><br><span class="line">        (GetRouteInfoRequestHeader) request.decodeCommandCustomHeader(GetRouteInfoRequestHeader.class);</span><br><span class="line">    <span class="comment">// ä»RouteInfoManagerä¸­è·å–topicçš„Brokerä¿¡æ¯</span></span><br><span class="line">    TopicRouteData topicRouteData = <span class="keyword">this</span>.namesrvController.getRouteInfoManager().pickupTopicRouteData(requestHeader.getTopic());</span><br><span class="line">    <span class="comment">// å¦‚æœæ”¯æŒé¡ºåºæ¶ˆæ¯ï¼Œåˆ™å¡«å……KVConfigä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">if</span> (topicRouteData != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.namesrvController.getNamesrvConfig().isOrderMessageEnable()) &#123;</span><br><span class="line">            String orderTopicConf =</span><br><span class="line">                <span class="keyword">this</span>.namesrvController.getKvConfigManager().getKVConfig(NamesrvUtil.NAMESPACE_ORDER_TOPIC_CONFIG,</span><br><span class="line">                    requestHeader.getTopic());</span><br><span class="line">            topicRouteData.setOrderTopicConf(orderTopicConf);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] content = topicRouteData.encode();</span><br><span class="line">        response.setBody(content);</span><br><span class="line">        response.setCode(ResponseCode.SUCCESS);</span><br><span class="line">        response.setRemark(<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    response.setCode(ResponseCode.TOPIC_NOT_EXIST);</span><br><span class="line">    response.setRemark(<span class="string">"No topic route info in name server for the topic: "</span> + requestHeader.getTopic()</span><br><span class="line">        + FAQUrl.suggestTodo(FAQUrl.APPLY_TOPIC_URL));</span><br><span class="line">    <span class="keyword">return</span> response;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ä¸‹é¢æˆ‘ä»¬ç»§ç»­çœ‹çœ‹å¦‚ä½•æŸ¥æ‰¾namesrvçš„RouteInfoï¼Œæ‰¾åˆ°<code>org.apache.rocketmq.namesrv.routeinfo.RouteInfoManager#pickupTopicRouteData</code>ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> TopicRouteData <span class="title">pickupTopicRouteData</span><span class="params">(<span class="keyword">final</span> String topic)</span> </span>&#123;</span><br><span class="line">    TopicRouteData topicRouteData = <span class="keyword">new</span> TopicRouteData();</span><br><span class="line">    <span class="keyword">boolean</span> foundQueueData = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">boolean</span> foundBrokerData = <span class="keyword">false</span>;</span><br><span class="line">    Set&lt;String&gt; brokerNameSet = <span class="keyword">new</span> HashSet&lt;String&gt;();</span><br><span class="line">    List&lt;BrokerData&gt; brokerDataList = <span class="keyword">new</span> LinkedList&lt;BrokerData&gt;();</span><br><span class="line">    topicRouteData.setBrokerDatas(brokerDataList);</span><br><span class="line"></span><br><span class="line">    HashMap&lt;String, List&lt;String&gt;&gt; filterServerMap = <span class="keyword">new</span> HashMap&lt;String, List&lt;String&gt;&gt;();</span><br><span class="line">    topicRouteData.setFilterServerTable(filterServerMap);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// è·å–è¯»é”</span></span><br><span class="line">            <span class="keyword">this</span>.lock.readLock().lockInterruptibly();</span><br><span class="line">            <span class="comment">// è·å–æ‰€æœ‰æ”¯æŒè¯¥topicçš„brokerçš„queueé…ç½®</span></span><br><span class="line">            List&lt;QueueData&gt; queueDataList = <span class="keyword">this</span>.topicQueueTable.get(topic);</span><br><span class="line">            <span class="keyword">if</span> (queueDataList != <span class="keyword">null</span>) &#123;</span><br><span class="line">                topicRouteData.setQueueDatas(queueDataList);</span><br><span class="line">                foundQueueData = <span class="keyword">true</span>;</span><br><span class="line">                <span class="comment">// è·å–BrokerName Set</span></span><br><span class="line">                Iterator&lt;QueueData&gt; it = queueDataList.iterator();</span><br><span class="line">                <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">                    QueueData qd = it.next();</span><br><span class="line">                    brokerNameSet.add(qd.getBrokerName());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// æ ¹æ®brokerNameè·å–brokerä¸»ä»åœ°å€ä»¥åŠè¿‡æ»¤å™¨ä¿¡æ¯</span></span><br><span class="line">                <span class="keyword">for</span> (String brokerName : brokerNameSet) &#123;</span><br><span class="line">                    BrokerData brokerData = <span class="keyword">this</span>.brokerAddrTable.get(brokerName);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">null</span> != brokerData) &#123;</span><br><span class="line">                        BrokerData brokerDataClone = <span class="keyword">new</span> BrokerData(brokerData.getCluster(), brokerData.getBrokerName(), (HashMap&lt;Long, String&gt;) brokerData</span><br><span class="line">                            .getBrokerAddrs().clone());</span><br><span class="line">                        brokerDataList.add(brokerDataClone);</span><br><span class="line">                        foundBrokerData = <span class="keyword">true</span>;</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">final</span> String brokerAddr : brokerDataClone.getBrokerAddrs().values()) &#123;</span><br><span class="line">                            List&lt;String&gt; filterServerList = <span class="keyword">this</span>.filterServerTable.get(brokerAddr);</span><br><span class="line">                            filterServerMap.put(brokerAddr, filterServerList);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.lock.readLock().unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">"pickupTopicRouteData Exception"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (foundBrokerData &amp;&amp; foundQueueData) &#123;</span><br><span class="line">        <span class="keyword">return</span> topicRouteData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>åˆ°æ­¤ï¼Œæˆ‘ä»¬å°±ä»‹ç»å®Œå•¦ï¼å…¶å®ç®€å•æ¥çœ‹ï¼ŒNamesrvå…¶å®ä¸€ä¸ªç”¨Nettyå†™çš„ä¸€ä¸ª<code>NettyRemotingServer</code>ï¼Œåœ¨Namesrvå®šä¹‰äº†ä¸€ä¸ªé»˜è®¤å¤„ç†å™¨<code>DefaultRequestProcessor</code>ï¼Œåœ¨è¿™ä¸ªå¤„ç†å™¨ä¸­ä¼šæ ¹ç»å…·ä½“çš„è¯·æ±‚ç å»åšä¸€äº›æ›´æ–°<code>RouteInfoManager</code>çš„æ“ä½œï¼Œåœ¨<code>RouteInfoManager</code>ä¸­åˆ©ç”¨HashMapä¿å­˜äº†å„ç§å…³ç³»æ˜ å°„ï¼Œå°±è¿™ä¹ˆç®€å•ï¼Œé‚£ä¹ˆåˆ°è¿™é‡Œç»“æŸå•¦ï¼</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol>
<li><a href="https://www.jianshu.com/p/1686fdfc409b" target="_blank" rel="noopener">RocketMQæºç è§£æ(äºŒ)-nameserv</a></li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¼•ï¼šNameSrvæ˜¯RocketMQçš„æ³¨å†Œä¸­å¿ƒï¼Œä¿å­˜æ‰€æœ‰Brokerã€Topicçš„å…ƒæ•°æ®ã€‚Brokerå¯åŠ¨åä¼šå‘namesrvå‘é€å¿ƒè·³ï¼Œnamesrvä¹Ÿä¼šå®šæ—¶æ£€æµ‹brokerçš„å¯ç”¨æ€§ï¼Œå¹¶ç§»é™¤ä¸å¯ç”¨çš„brokerã€‚å¯¹äºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ¥è¯´ï¼Œå®ƒæä¾›äº†Brokerçš„æŸ¥è¯¢æœåŠ¡ã€‚
    
    </summary>
    
      <category term="RocketMQæºç " scheme="http://bestlixiang.site/categories/RocketMQ%E6%BA%90%E7%A0%81/"/>
    
    
      <category term="RocketMQ" scheme="http://bestlixiang.site/tags/RocketMQ/"/>
    
  </entry>
  
  <entry>
    <title>DDD Flag</title>
    <link href="http://bestlixiang.site/2019/06/09/DDD/DDD%20Flag/"/>
    <id>http://bestlixiang.site/2019/06/09/DDD/DDD Flag/</id>
    <published>2019-06-09T05:52:42.000Z</published>
    <updated>2019-06-09T05:02:49.015Z</updated>
    
    <content type="html"><![CDATA[<p>å¼•ï¼šä¸Šå‘¨çœ‹å®Œäº†Eric Evans çš„ã€Šé¢†åŸŸé©±åŠ¨è®¾è®¡â€”è½¯ä»¶æ ¸å¿ƒå¤æ‚æ€§åº”å¯¹ä¹‹é“ã€‹ï¼Œå½±å“æ¯”è¾ƒæ·±çš„å°±æ˜¯æ˜¯è¿™æ ·ä¸€å¥è¯â€”â€”è½¯ä»¶çš„æ ¸å¿ƒæ˜¯å…¶ä¸ºç”¨æˆ·è§£å†³é¢†åŸŸç›¸å…³é—®é¢˜çš„èƒ½åŠ›ã€‚<a id="more"></a></p>
<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>çœ‹èŠ±æ˜¯èŠ±ï¼Œçœ‹èŠ±ä¸æ˜¯èŠ±ï¼Œçœ‹èŠ±æ˜¯èŠ±ã€‚è¿™æ˜¯ä¸€ä¸ªè¿‡ç¨‹ã€‚æˆ‘æƒ³æ‰€æœ‰äººåœ¨å­¦ä¹ ä¸€ä¸ªä¸œè¥¿éƒ½æ˜¯è¿™æ ·ä¸€ä¸ªè¿‡ç¨‹ã€‚åœ¨å¿™äºCRUDçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘æœ€åˆçœ‹å¾…ä¸šåŠ¡åªæ˜¯è§‰å¾—ä»–å°±æ˜¯ä¸€ä¸ªè‡ªç„¶çš„ä¸šåŠ¡é€»è¾‘ï¼Œç…§ç€å†™å°±å®Œäº‹äº†ï¼Œè¿™å¤„äºç¬¬ä¸€æ­¥ï¼›å½“çœ‹å®Œã€Šé¢†åŸŸé©±åŠ¨è®¾è®¡â€”è½¯ä»¶æ ¸å¿ƒå¤æ‚æ€§åº”å¯¹ä¹‹é“ã€‹ä¹‹åï¼Œå‘ç°åœ¨è¿›è¡Œä¸šåŠ¡ç¼–ç çš„æ—¶å€™æˆ‘ä»¬æ›´åº”è¯¥å¾€é¢†åŸŸä¸Šé è¿‘ï¼Œæœ€å¥½èƒ½å½¢æˆä¸€å¥—é¢†åŸŸæ¨¡å¼ï¼Œä½†æ˜¯åŸæ¥çš„ä¸šåŠ¡é€»è¾‘å·²ç»ä¸æ˜¯ç®€å•çš„ä¸šåŠ¡é€»è¾‘äº†ï¼Œè¿™æ˜¯ç¬¬äºŒæ­¥ï¼Œè€Œæˆ‘å¥½åƒå°±å¤„äºè¿™ä¸€æ­¥ï¼›ä½†æ˜¯æˆ‘ç›¸ä¿¡ä»¥åèƒ½ç†Ÿç»ƒçš„ä½¿ç”¨é¢†åŸŸé©±åŠ¨è®¾è®¡çš„æ—¶å€™ï¼Œé‚£æ—¶å€™ä¸šåŠ¡åˆæ˜¯ä¸šåŠ¡äº†ï¼Œè¾¾åˆ°ç¬¬ä¸‰æ­¥ã€‚Flag hereï¼</p>
<h1 id="æ¡ˆä¾‹"><a href="#æ¡ˆä¾‹" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h1><ol>
<li><a href="https://tech.meituan.com/2017/12/22/ddd-in-practice.html" target="_blank" rel="noopener">é¢†åŸŸé©±åŠ¨è®¾è®¡åœ¨äº’è”ç½‘ä¸šåŠ¡å¼€å‘ä¸­çš„å®è·µ</a></li>
<li><a href="http://www.sohu.com/a/191769788_748431" target="_blank" rel="noopener">äº¤æ˜“ç³»ç»Ÿ - é¢†åŸŸé©±åŠ¨è®¾è®¡æµ…æ </a></li>
</ol>
<p>ç¬¬äºŒä¸ªæ˜¯è‡ªå·±ç›®å‰çš„é‡ç‚¹ï¼Œå¸Œæœ›æ¥ä¸‹æ¥èƒ½å¥½å¥½ç†è§£å¹¶ä¸”å®è·µï¼ï¼ï¼</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¼•ï¼šä¸Šå‘¨çœ‹å®Œäº†Eric Evans çš„ã€Šé¢†åŸŸé©±åŠ¨è®¾è®¡â€”è½¯ä»¶æ ¸å¿ƒå¤æ‚æ€§åº”å¯¹ä¹‹é“ã€‹ï¼Œå½±å“æ¯”è¾ƒæ·±çš„å°±æ˜¯æ˜¯è¿™æ ·ä¸€å¥è¯â€”â€”è½¯ä»¶çš„æ ¸å¿ƒæ˜¯å…¶ä¸ºç”¨æˆ·è§£å†³é¢†åŸŸç›¸å…³é—®é¢˜çš„èƒ½åŠ›ã€‚
    
    </summary>
    
      <category term="DDD" scheme="http://bestlixiang.site/categories/DDD/"/>
    
    
      <category term="DDD" scheme="http://bestlixiang.site/tags/DDD/"/>
    
  </entry>
  
  <entry>
    <title>å†çœ‹å•å…ƒæµ‹è¯•</title>
    <link href="http://bestlixiang.site/2019/06/09/%E8%B5%9E/%E5%86%8D%E7%9C%8B%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/"/>
    <id>http://bestlixiang.site/2019/06/09/èµ/å†çœ‹å•å…ƒæµ‹è¯•/</id>
    <published>2019-06-09T03:18:46.000Z</published>
    <updated>2019-06-09T03:23:59.594Z</updated>
    
    <content type="html"><![CDATA[<p>å¼•ï¼šå¯¹äºå¤§éƒ¨åˆ†å¼€å‘æ¥è¯´ï¼Œå†™å•å…ƒæµ‹è¯•æ—¶ä¸€ä»¶å¤šä¹ˆç—›è‹¦çš„äº‹å‘€ï¼<a id="more"></a></p>
<h1 id="å•å…ƒæµ‹è¯•ä»‹ç»"><a href="#å•å…ƒæµ‹è¯•ä»‹ç»" class="headerlink" title="å•å…ƒæµ‹è¯•ä»‹ç»"></a>å•å…ƒæµ‹è¯•ä»‹ç»</h1><h2 id="ä»€ä¹ˆæ˜¯å•å…ƒæµ‹è¯•"><a href="#ä»€ä¹ˆæ˜¯å•å…ƒæµ‹è¯•" class="headerlink" title="ä»€ä¹ˆæ˜¯å•å…ƒæµ‹è¯•"></a>ä»€ä¹ˆæ˜¯å•å…ƒæµ‹è¯•</h2><p><img src="https://upload-images.jianshu.io/upload_images/10354196-e61d89f061b4de52.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="æµ‹è¯•æ¶æ„.png"><br>å•å…ƒæµ‹è¯•æ˜¯æŒ‡å¯¹è½¯ä»¶ä¸­çš„æœ€å°å¯æµ‹è¯•å•å…ƒè¿›è¡Œæ£€æŸ¥å’ŒéªŒè¯ã€‚ç›¸ä¿¡å¤§å¤šæ•°éƒ½çœ‹è§è¿‡è¿™å¹…æµ‹è¯•æ¨¡å‹å›¾ï¼Œæ ¹æ®æµ‹è¯•é‡‘å­—å¡”åŸç†ï¼Œè¶Šå¾€ä¸Šå±‚çš„æµ‹è¯•ï¼Œæ‰€éœ€çš„æµ‹è¯•æŠ•å…¥æ¯”ä¾‹è¶Šå¤§ï¼Œæ•ˆæœä¹Ÿè¶Šå·®ï¼Œè€Œå•å…ƒæµ‹è¯•çš„æˆæœ¬è¦å°çš„å¤šï¼Œä¹Ÿæ›´å®¹æ˜“å‘ç°é—®é¢˜ã€‚è¯è™½ç„¶è¿™ä¹ˆè¯´ï¼Œä½†æ˜¯å†™å•å…ƒæµ‹è¯•å¯¹äºå¤§éƒ¨åˆ†å¼€å‘æ¥è¯´ä¾ç„¶æ˜¯ä¸€ä»¶å¾ˆè›‹ç–¼çš„äº‹ã€‚åœ¨ä»¥å‰æ²¡æœ‰QAçš„å¹´ä»£ï¼ŒTDDå•å…ƒæµ‹è¯•é©±åŠ¨å¼€å‘ä»¥å‰è¿˜æ˜¯å¾ˆç«çš„ï¼Œç°åœ¨å°±ä¸çŸ¥é“äº†ã€‚å› ä¸ºé‚£ä¸ªæ—¶å€™æ²¡æœ‰QAï¼Œå¼€å‘éƒ½å¾—é è‡ªå·±æµ‹è¯•ï¼Œåœ¨é‡æ„é¡¹ç›®æ—¶ï¼Œé€šè¿‡å•å…ƒæµ‹è¯•å¯ä»¥å¿«é€Ÿçš„äº†è§£åˆ°è‡ªå·±é‡æ„æ—¶å‘ç”Ÿçš„ä¿®æ”¹ï¼Œç„¶åé‡æ–°ä¿®æ­£ã€‚ä½†æ˜¯ç°åœ¨æœ‰ä¸“ä¸šçš„QAåŒå­¦ï¼Œä»–ä»¬ä¼šå†™é›†æˆæµ‹è¯•ï¼Œå¯¼è‡´äº†å¼€å‘æ›´åŠ ä¸æƒ³å†™å•å…ƒæµ‹è¯•äº†ã€‚ä½†æ˜¯å¾ˆå¤šå…¬å¸éƒ½ä¼šæœ‰å•å…ƒæµ‹è¯•çš„ç¡¬æ€§è¦æ±‚åŠ ä¸Šè°çŸ¥é“QAæ˜¯ä¸æ˜¯ä¸€ä¸ªå’Œè”¼å¯äº²çš„å°å§å§ï¼Œæ‰€ä»¥å•å…ƒæµ‹è¯•è¿˜æ˜¯å¾—å†™ï¼Œä¸ç®¡ç”¨ä¸ç”¨å¾—ä¸Šï¼Œä¸‡ä¸€ç”¨å¾—ä¸Šå‘¢ï¼Ÿ</p>
<h2 id="å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•"><a href="#å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•" class="headerlink" title="å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•"></a>å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•</h2><p>å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•çš„ç•Œçº¿æˆ‘ç›¸ä¿¡å¤§éƒ¨åˆ†å¼€å‘ä¹Ÿæ˜¯ä¸æ¸…æ™°çš„ã€‚æˆ‘ä¹Ÿä¸æ˜¯ç‰¹åˆ«æ¸…æ¥šã€‚ä¸ªäººç†è§£å•å…ƒæµ‹è¯•é’ˆå¯¹äºä¸€å—ä¸šåŠ¡é€»è¾‘æœ€å°çš„å•å…ƒï¼Œå¯ä»¥ç®€å•ç†è§£ä¸ºä¸€ä¸ªç±»çš„æ–¹æ³•ã€‚ä¸€ä¸ªå•å…ƒæµ‹è¯•ä¸åº”è¯¥åŒ…å«å¤–éƒ¨ä¾èµ–çš„é€»è¾‘ï¼Œåä¹‹å°±æ˜¯é›†æˆæµ‹è¯•äº†ã€‚ ä½†æ˜¯ä¸€ä¸ªserviceçš„ä¸€ä¸ªæ¥å£å®ç°ä¸€èˆ¬éƒ½ä¼šä¾èµ–å¾ˆå¤šç¬¬ä¸‰æ–¹ï¼š1.æœ¬åœ°å…¶å®ƒçš„service 2.daoè°ƒç”¨ 3.rpcè°ƒç”¨ 4.å¾®æœåŠ¡è°ƒç”¨ï¼Œç­‰ç­‰ã€‚ç›¸ä¿¡å¤§å®¶ä¸€å®šèº«æœ‰æ„Ÿå—ã€‚</p>
<p>ä½†æ˜¯æˆ‘ä»¬é‡åˆ°çš„å°±æ˜¯è¿™æ ·çš„æƒ…å†µï¼Œé‚£æˆ‘ä»¬è¿˜æ€ä¹ˆå†™å•å…ƒæµ‹è¯•å‘€ï¼Ÿç­”æ¡ˆæ˜¯<strong>MOCK</strong>ã€‚ç°åœ¨æœ‰å¾ˆå¤šMockçš„å¼€æºæ¡†æ¶æ¯”å¦‚ï¼šmockitoï¼Œeasymockï¼Œè¿˜æœ‰æ›´å¼ºå¤§çš„powermockï¼Œæœ€åæ”¾äº†ä½¿ç”¨å‚è€ƒé“¾æ¥ã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œæ—¢ç„¶æˆ‘ä»¬å¯ä»¥mockç¬¬ä¸‰æ–¹è¿œç¨‹ä¾èµ–ï¼Œä¸ºä½•ä¸mock daoã€local serviceå‘¢ï¼Ÿæ²¡é”™å¤–éƒ¨ä¾èµ–å…¨éƒ¨mockæ‰ï¼Œå°±æ˜¯å•å…ƒæµ‹è¯•äº†ã€‚å› ä¸ºæˆ‘ä»¬åªå…³å¿ƒæ‰€æµ‹è¯•çš„æ–¹æ³•çš„ä¸šåŠ¡é€»è¾‘ï¼Œä¹Ÿå°±æ˜¯çœŸæ­£é«˜å†…èšçš„é€»è¾‘å•å…ƒäº†ã€‚</p>
<p>æœ‰äº†Mockï¼Œæˆ‘ä»¬å‘ç°ï¼šæ²¡æœ‰ä»€ä¹ˆæ•°æ®æ˜¯é€ ä¸å‡ºæ¥çš„ï¼Œè€Œä¸”è¿˜ä¸äº§ç”Ÿä»»ä½•è„æ•°æ®ï¼Œ è·‘caseæ›´å¿«äº†ï¼Œå› ä¸ºä¸ç”¨å¯åŠ¨æ•´ä¸ªé¡¹ç›®ã€‚æ˜¯ä¸æ˜¯æ•´ä¸ªä¸–ç•Œéƒ½æ¸…æ™°äº†ï¼Œä½†æ˜¯ä¸€æƒ³åˆæœ‰ç‚¹å®³æ€•ï¼Œæ¯•ç«Ÿéƒ½mockäº†è¿˜æµ‹è¯•ä¸ªé¸¡å„¿ã€‚è¿˜æ˜¯å›åˆ°å¯¹å•å…ƒæµ‹è¯•å¾—ç†è§£ï¼Œå•å…ƒæµ‹è¯•åº”è¯¥åªé’ˆå¯¹äºç›®æ ‡æ–¹æ³•çš„ä¸šåŠ¡é€»è¾‘æµ‹è¯•ï¼Œdaoã€å…¶å®ƒserviceåº”è¯¥åœ¨å®ƒä»¬è‡ªèº«çš„å•å…ƒæµ‹è¯•å»æµ‹è¯•ã€‚å¯¹äºä¾èµ–çš„ç¬¬ä¸‰æ–¹ï¼Œæˆ‘ä»¬åº”è¯¥ä¿¡ä»»å®ƒä»¬èƒ½æ­£ç¡®çš„å®Œæˆæˆ‘ä»¬æ‰€é¢„æœŸçš„ã€‚æˆ‘ä»¬åº”è¯¥éªŒè¯çš„å†…å®¹æ˜¯ï¼šæ–¹æ³•æ˜¯å¦è¢«è°ƒç”¨ï¼Œè°ƒç”¨çš„æ¬¡æ•°å¯¹ä¸å¯¹ï¼Œè°ƒç”¨å‚æ•°å¯¹ä¸å¯¹ï¼Œåªè¦è¿™ä¸‰ä¸ªéªŒè¯é€šè¿‡ï¼Œå°±OKäº†ã€‚Mockitoæ¡†æ¶çš„verifyæ¥å£å°±æ˜¯åšè¿™ä»¶äº‹æƒ…çš„ã€‚å¦‚æœä½ ç†è§£äº†ä¸Šè¿°å†…å®¹ï¼Œé‚£ä¹ˆä½ å°±å¼€çªäº†ï¼ŒUTä¸åœ¨å˜å¾—è¿™ä¹ˆéš¾å†™ã€‚</p>
<h1 id="å•å…ƒæµ‹è¯•è§„èŒƒ"><a href="#å•å…ƒæµ‹è¯•è§„èŒƒ" class="headerlink" title="å•å…ƒæµ‹è¯•è§„èŒƒ"></a>å•å…ƒæµ‹è¯•è§„èŒƒ</h1><p>å¥½çš„å•å…ƒæµ‹è¯•å¿…é¡»éµå®ˆAIR åŸåˆ™<br>Aï¼šAutomaticï¼ˆè‡ªåŠ¨åŒ–ï¼‰<br>I:    Independentï¼ˆç‹¬ç«‹æ€§ï¼‰<br>R:   Repeatableï¼ˆå¯é‡å¤ï¼‰ </p>
<ol>
<li>å•å…ƒæµ‹è¯•å¿…é¡»æ˜¯å…¨è‡ªåŠ¨çš„ï¼Œéäº¤äº’å¼çš„ï¼Œå¿…é¡»ä½¿ç”¨assert éªŒè¯ï¼Œä¸èƒ½ä½¿ç”¨ System.out.println  è‚‰çœ¼è§‚å¯Ÿæ‰§è¡Œç»“æœï¼Œæ— å‚æ–¹æ³•æµ‹è¯•åï¼Œéœ€è¦ä½¿ç”¨verify è¿›è¡ŒéªŒè¯</li>
<li>ä¿æŒå•å…ƒæµ‹è¯•çš„ç‹¬ç«‹æ€§ã€‚å•å…ƒæµ‹è¯•ç”¨ä¾‹ä¹‹é—´ä¸èƒ½ç›¸äº’è°ƒç”¨ï¼Œä¸èƒ½ä¾èµ–æ‰§è¡Œçš„å…ˆåé¡ºåº</li>
<li><p>å•å…ƒæµ‹è¯•æ˜¯å¯ä»¥é‡å¤æ‰§è¡Œçš„ï¼Œä¸èƒ½å—åˆ°å¤–ç•Œç¯å¢ƒçš„å½±å“</p>
<ul>
<li>ä¸šåŠ¡ä¸­ä½¿ç”¨äº†localcacheã€redis ç¼“å­˜çš„ï¼Œæ‰§è¡Œæµ‹è¯•ç”¨ä¾‹å‰ï¼Œå…ˆæ¸…ç†ç¼“å­˜</li>
<li>DB çš„æµ‹è¯•ï¼Œä¸å¯ä»¥ä¾èµ–çœŸå®çš„DBï¼Œéœ€è¦ç”¨ H2 æµ‹è¯•æ¡†æ¶mock æ•°æ®å±‚ï¼Œä½¿ç”¨æ–¹å¼ï¼š<a href="http://www.h2database.com/html/main.html" target="_blank" rel="noopener">http://www.h2database.com/html/main.html</a></li>
<li>æ‰€æœ‰çš„ç¬¬ä¸‰æ–¹ dubbo è°ƒç”¨ï¼Œä¹Ÿéœ€è¦mock è°ƒï¼Œä¸å¯ä»¥çœŸå®è°ƒç”¨ã€‚</li>
<li>æ‰€æœ‰çš„ä¸­é—´ä»¶mock æ‰ã€‚</li>
</ul>
</li>
<li><p>å•å…ƒæµ‹è¯•å¿…é¡»å†™åœ¨å¦‚ä¸‹å·¥ç¨‹ç›®å½•ä¸­: src/test/javaï¼Œä¸å…è®¸å†™åœ¨ä¸šåŠ¡ä»£ç ç›®å½•ä¸‹ã€‚ç¦æ­¢é€šè¿‡åœ¨ä¸šåŠ¡ä»£ç ç±»ä¸­å†™ main å‡½æ•°è¿›è¡Œæµ‹è¯•</p>
</li>
<li>å•å…ƒæµ‹è¯•çš„BCDE åŸåˆ™ï¼Œä¿è¯è¢«æµ‹æ¨¡å—çš„äº¤ä»˜è´¨é‡<ul>
<li>B: Borderï¼Œè¾¹ç•Œå€¼æµ‹è¯•ï¼ŒåŒ…æ‹¬å¾ªç¯è¾¹ç•Œã€ç‰¹æ®Šå–å€¼ã€ç‰¹æ®Šæ—¶é—´ç‚¹ã€æ•°æ®é¡ºåºç­‰ã€‚</li>
<li>Cï¼šCorrectï¼Œæ­£ç¡®çš„è¾“å…¥ï¼Œå¹¶å¾—åˆ°é¢„æœŸç»“æœã€‚</li>
<li>D:  Designï¼Œä¸è®¾è®¡æ–‡æ¡£ç»“åˆï¼Œç¼–å†™æµ‹è¯•ç”¨ä¾‹</li>
<li>E:  Errorï¼Œé”™è¯¯çš„ä¿¡æ¯è¾“å…¥ï¼Œå¾—åˆ°é¢„æœŸç»“æœ</li>
</ul>
</li>
</ol>
<h1 id="å•å…ƒæµ‹è¯•å®è·µ"><a href="#å•å…ƒæµ‹è¯•å®è·µ" class="headerlink" title="å•å…ƒæµ‹è¯•å®è·µ"></a>å•å…ƒæµ‹è¯•å®è·µ</h1><h2 id="å•å…ƒæµ‹è¯•çš„è¿‡ç¨‹"><a href="#å•å…ƒæµ‹è¯•çš„è¿‡ç¨‹" class="headerlink" title="å•å…ƒæµ‹è¯•çš„è¿‡ç¨‹"></a>å•å…ƒæµ‹è¯•çš„è¿‡ç¨‹</h2><p><img src="https://upload-images.jianshu.io/upload_images/10354196-1e92c9bd81100ef5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="å•å…ƒæµ‹è¯•æµç¨‹.png"></p>
<p>å•å…ƒæµ‹è¯•çš„ç¼–å†™ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹å‡ ä¸ªé˜¶æ®µï¼š</p>
<ol>
<li>æ•°æ®å‡†å¤‡ï¼šåœ¨ç¼–å†™æµ‹è¯•ç”¨ä¾‹å‰ï¼Œå°¤å…¶æ˜¯Daoå±‚ï¼Œéœ€è¦ä¾èµ–åˆ°ä¸€äº›æ•°æ®ï¼Œæ•°æ®æ¥æºä¸€èˆ¬æ˜¯æ•°æ®åº“ï¼Œè€Œæ„é€ æ•°æ®ï¼Œåˆä¸èƒ½ä¾èµ– DAO å±‚çš„ä»£ç ï¼Œéœ€è¦ä½¿ç”¨åŸç”Ÿjdbc å»æ’å…¥æ•°æ®ï¼Œæµ‹è¯•ä»£ç ç¼–å†™æ•ˆç‡ä½ã€‚</li>
<li>æ„é€ å‚æ•°åŠæ‰“æ¡©ï¼ˆstubï¼‰ï¼šè°ƒç”¨æ–¹æ³•éœ€è¦ä¼ é€’å…¥å‚ï¼Œæœ‰æ—¶å€™ä¸€ä¸ªå…¥å‚åå‡ ä¸ªå‚æ•°éœ€è¦ setï¼Œset æ–¹æ³•å†™å®Œï¼Œä»£ç å·²ç»å†™äº†åæ¥è¡Œäº†ã€‚</li>
<li>æ‰§è¡Œæµ‹è¯•ï¼šè¿™ä¸€æ­¥æ¯”è¾ƒç®€å•ï¼Œç›´æ¥è°ƒç”¨è¢«æµ‹æ–¹æ³•å³å¯ã€‚</li>
<li>ç»“æœéªŒè¯ï¼šè¿™é‡Œé™¤äº†éªŒè¯è¢«æµ‹æ–¹æ³•çš„è¿”å›å€¼å¤–ï¼Œè¿˜éœ€è¦éªŒè¯æ’å…¥åˆ°æ•°æ®åº“ä¸­çš„ æ•°æ®æ˜¯å¦æ­£ç¡®ï¼ŒæŸå¤–éƒ¨æ–¹æ³•è¢«è°ƒç”¨è¿‡næ¬¡æˆ–æœªè°ƒç”¨è¿‡ã€‚</li>
<li>å¿…è¦çš„æ¸…ç†ï¼šå¯¹æ‰“æ¡©è¿›è¡Œæ¸…ç†ï¼Œå¯¹æ•°æ®åº“è„æ•°æ®è¿›è¡Œæ¸…ç†ã€‚</li>
</ol>
<h2 id="æœ€ä½³å®è·µ"><a href="#æœ€ä½³å®è·µ" class="headerlink" title="æœ€ä½³å®è·µ"></a>æœ€ä½³å®è·µ</h2><p>åŸºäºä¸Šé¢çš„é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨å¦‚ä¸‹çš„è§£å†³æ–¹æ¡ˆï¼š<br><strong>spring-test+powermock +h2æ•°æ®åº“ çš„æµ‹è¯•æ¡†æ¶</strong></p>
<ol>
<li>H2æ•°æ®åº“<br>H2æ•°æ®åº“éå¸¸é€‚åˆåœ¨æµ‹è¯•ç¨‹åºä¸­ä½¿ç”¨ï¼Œç¨‹åºå…³é—­æ—¶è‡ªåŠ¨æ¸…ç†æ•°æ®ï¼ŒH2 æ•°æ®åº“çš„è¡¨ç»“æ„åˆå§‹åŒ–æ˜¯é€šè¿‡ jdbc:initialize-database æ ‡ç­¾å®ç°çš„ï¼Œå•å…ƒæµ‹è¯•ä¸­ä½¿ç”¨ H2 æ•°æ®åº“éå¸¸ç®€å•ï¼Œä»…éœ€ä¿®æ”¹ jdbc è¿æ¥å³å¯ã€‚</li>
<li>powermock<br>powermockæ”¯æŒé™æ€æ–¹æ³• mockï¼ŒåŒæ—¶å…¼å®¹ mockitoï¼Œpowermock ç¤ºä¾‹ï¼š<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(PowerMockRunner.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XXXXTest</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@InjectMocks</span></span><br><span class="line">    <span class="keyword">private</span> YourTestService yourTestService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    <span class="keyword">private</span> YourRPCClient yourRPCClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">test_method</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="comment">// æ„é€ å‚æ•°ï¼Œè¿™é‡Œå¯ä»¥ä½¿ç”¨jsonæ„é€ </span></span><br><span class="line">     </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol>
<li><a href="https://juejin.im/post/5be7eaf26fb9a049d4415278" target="_blank" rel="noopener">Mockitoä¸PowerMockçš„ä½¿ç”¨åŸºç¡€æ•™ç¨‹</a></li>
<li><a href="https://mp.weixin.qq.com/s?__biz=MzAxOTY5MDMxNA==&amp;mid=2455759766&amp;idx=1&amp;sn=536939d467bf2f09525809f74b20860e" target="_blank" rel="noopener">æœ‰èµå•å…ƒæµ‹è¯•å®è·µ</a></li>
<li><a href="http://www.h2database.com/html/quickstart.html" target="_blank" rel="noopener">H2æ•°æ®åº“</a></li>
<li><a href="https://github.com/powermock/powermock" target="_blank" rel="noopener">powermock</a></li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¼•ï¼šå¯¹äºå¤§éƒ¨åˆ†å¼€å‘æ¥è¯´ï¼Œå†™å•å…ƒæµ‹è¯•æ—¶ä¸€ä»¶å¤šä¹ˆç—›è‹¦çš„äº‹å‘€ï¼
    
    </summary>
    
      <category term="èµ" scheme="http://bestlixiang.site/categories/%E8%B5%9E/"/>
    
    
      <category term="å•å…ƒæµ‹è¯•" scheme="http://bestlixiang.site/tags/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/"/>
    
  </entry>
  
  <entry>
    <title>RocketMQæºç åˆ†æâ€”â€”ç¯å¢ƒæ­å»º</title>
    <link href="http://bestlixiang.site/2019/06/08/RocketMQ%E6%BA%90%E7%A0%81/RocketMQ%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E2%80%94%E2%80%94%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"/>
    <id>http://bestlixiang.site/2019/06/08/RocketMQæºç /RocketMQæºç åˆ†æâ€”â€”ç¯å¢ƒæ­å»º/</id>
    <published>2019-06-08T07:32:37.000Z</published>
    <updated>2019-06-08T07:38:45.257Z</updated>
    
    <content type="html"><![CDATA[<p>å¼•ï¼šç»ˆäºè¦å¼€å§‹äº†å—ï¼Œä¸€ç›´æƒ³å¥½å¥½å¼„æ¸…æ¥šä¸€æ¬¾MQï¼Œä½œä¸ºä¸€åJavaerï¼Œè‚¯å®šé€‰æ‹©RocketMQï¼Œå¸Œæœ›ä»Šå¤©æ˜¯ä¸€ä¸ªå¥½å¼€å§‹ï¼<a id="more"></a></p>
<h1 id="å‰ç½®"><a href="#å‰ç½®" class="headerlink" title="å‰ç½®"></a>å‰ç½®</h1><p>åœ¨çœ‹æºç å‰å¤§å®¶éƒ½è‡³å°‘åº”è¯¥ä½¿ç”¨è¿‡RocketMQï¼Œå¹¶ä¸”äº†è§£å®ƒçš„ç›¸å…³åŸç†ï¼Œæ‰€ä»¥è¿™é‡Œä¸¢å‡ºä¸¤ä¸ªé“¾æ¥ï¼Œè™½ç„¶æœ‰ç‚¹è€~</p>
<ol>
<li><a href="[http://gd-rus-public.cn-hangzhou.oss-pub.aliyun-inc.com/attachment/201604/08/20160408164726/RocketMQ_userguide.pdf](http://gd-rus-public.cn-hangzhou.oss-pub.aliyun-inc.com/attachment/201604/08/20160408164726/RocketMQ_userguide.pdf">RocketMQ ç”¨æˆ·æŒ‡å—</a></li>
<li><a href="[http://gd-rus-public.cn-hangzhou.oss-pub.aliyun-inc.com/attachment/201604/08/20160408165024/RocketMQ_design.pdf](http://gd-rus-public.cn-hangzhou.oss-pub.aliyun-inc.com/attachment/201604/08/20160408165024/RocketMQ_design.pdf">RocketMQ åŸç†ç®€ä»‹</a></li>
</ol>
<h1 id="ä¾èµ–å·¥å…·"><a href="#ä¾èµ–å·¥å…·" class="headerlink" title="ä¾èµ–å·¥å…·"></a>ä¾èµ–å·¥å…·</h1><ol>
<li>Git</li>
<li>Maven</li>
<li>JDK1.8</li>
<li>IntelliJ IDEA</li>
</ol>
<h1 id="æºç æ‹‰å–"><a href="#æºç æ‹‰å–" class="headerlink" title="æºç æ‹‰å–"></a>æºç æ‹‰å–</h1><p>ä»å®˜æ–¹ä»“åº“ <a href="https://github.com/apache/rocketmq" target="_blank" rel="noopener">https://github.com/apache/rocketmq</a> é€šè¿‡Gitæ‹‰å–ä»£ç åˆ°æœ¬åœ°ï¼Œåœ¨2019.6.8çœ‹åˆ°æœ€æ–°çš„releaseç‰ˆæœ¬æ˜¯4.5.1ï¼Œä½†æ˜¯ä¸ºäº†å’ŒèŠ‹è‰¿å¤§ä½¬ä¿æŒä¸€è‡´ï¼Œæˆ‘ä¹Ÿé€‰æ‹©äº†4.4.0ç‰ˆæœ¬ï¼Œæ‰€ä»¥å°†ä»£ç æ‹‰å–åˆ°æœ¬åœ°ä¹‹åï¼Œæˆ‘ä»¬åˆ‡æ¢åˆ°4.4.0åˆ†æ”¯ã€‚</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/apache/rocketmq.git</span><br><span class="line">git checkout -b release-4.4.0 origin/release-4.4.0</span><br></pre></td></tr></table></figure>
<p>ç„¶åæˆ‘ä»¬å°±å¯ä»¥çœ‹æ˜¯æ­å»ºè°ƒè¯•ç¯å¢ƒå•¦~</p>
<h1 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h1><h2 id="å¯åŠ¨-RocketMQ-Namesrv"><a href="#å¯åŠ¨-RocketMQ-Namesrv" class="headerlink" title="å¯åŠ¨ RocketMQ Namesrv"></a>å¯åŠ¨ RocketMQ Namesrv</h2><p>æ‰“å¼€ <code>org.apache.rocketmq.namesrv.NameServerInstanceTest</code> å•å…ƒæµ‹è¯•ç±»ï¼Œå‚è€ƒ <code>#startup()</code> æ–¹æ³•ï¼Œæˆ‘ä»¬ç¼–å†™ <code>#main(String[] args)</code> é™æ€æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    NamesrvConfig namesrvConfig1 = <span class="keyword">new</span> NamesrvConfig();</span><br><span class="line">    NettyServerConfig nettyServerConfig1 = <span class="keyword">new</span> NettyServerConfig();</span><br><span class="line">    nettyServerConfig1.setListenPort(<span class="number">9876</span>);</span><br><span class="line">    NamesrvController nameSrvController1 = <span class="keyword">new</span> NamesrvController(namesrvConfig1, nettyServerConfig1);</span><br><span class="line">    nameSrvController1.initialize();</span><br><span class="line">    nameSrvController1.start();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸è®©ä¸»æ–¹æ³•ç»“æŸ</span></span><br><span class="line">    Thread.sleep(DateUtils.MILLIS_PER_DAY);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œä¹‹åï¼Œè¾“å‡ºå¦‚ä¸‹æ—¥å¿—å°±ä»£è¡¨OKå•¦~</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">14:41:41.202 [NettyEventExecutor] INFO  RocketmqRemoting - NettyEventExecutor service started</span><br><span class="line">14:41:41.203 [FileWatchService] INFO  RocketmqCommon - FileWatchService service started</span><br></pre></td></tr></table></figure>
<h2 id="å¯åŠ¨-RocketMQ-Broker"><a href="#å¯åŠ¨-RocketMQ-Broker" class="headerlink" title="å¯åŠ¨ RocketMQ Broker"></a>å¯åŠ¨ RocketMQ Broker</h2><p>æ‰“å¼€ <code>org.apache.rocketmq.broker.BrokerControllerTest</code> å•å…ƒæµ‹è¯•ç±»ï¼Œå‚è€ƒ <code>#testBrokerRestart()</code> æ–¹æ³•ï¼Œæˆ‘ä»¬ç¼–å†™ <code>#main(String[] args)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      <span class="comment">// è®¾ç½®ç‰ˆæœ¬å·ï¼Œå¾ˆå…³é”®ï¼Œä¸ç„¶topicåˆ›å»ºä¸æˆåŠŸ</span></span><br><span class="line">      System.setProperty(RemotingCommand.REMOTING_VERSION_KEY, Integer.toString(MQVersion.CURRENT_VERSION));</span><br><span class="line">      <span class="keyword">final</span> BrokerConfig brokerConfig = <span class="keyword">new</span> BrokerConfig();</span><br><span class="line">      brokerConfig.setBrokerName(<span class="string">"broker-a"</span>);</span><br><span class="line">      brokerConfig.setNamesrvAddr(<span class="string">"127.0.0.1:9876"</span>);</span><br><span class="line"></span><br><span class="line">      BrokerController brokerController = <span class="keyword">new</span> BrokerController(</span><br><span class="line">              brokerConfig,</span><br><span class="line">              <span class="keyword">new</span> NettyServerConfig(),</span><br><span class="line">              <span class="keyword">new</span> NettyClientConfig(),</span><br><span class="line">              <span class="keyword">new</span> MessageStoreConfig());</span><br><span class="line">      assertThat(brokerController.initialize());</span><br><span class="line">      brokerController.start();</span><br><span class="line">      <span class="comment">// ä¸è®©ä¸»æ–¹æ³•ç»“æŸ</span></span><br><span class="line">      Thread.sleep(DateUtils.MILLIS_PER_DAY);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œä¹‹åï¼Œè™½ç„¶åœ¨brokerä¸‹é¢ä»€ä¹ˆæ—¥å¿—éƒ½æ²¡æœ‰ï¼Œä½†æ˜¯åœ¨Namesrvå·²ç»çœ‹åˆ°äº†brokerçš„æ³¨å†Œæ—¥å¿—ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">15:19:21.437 [NettyServerCodecThread_4] INFO  RocketmqRemoting - NETTY SERVER PIPELINE: channelRegistered 127.0.0.1:58887</span><br><span class="line">15:19:21.437 [NettyServerCodecThread_4] INFO  RocketmqRemoting - NETTY SERVER PIPELINE: channelActive, the channel[127.0.0.1:58887]</span><br><span class="line">15:19:21.460 [RemotingExecutorThread_7] DEBUG RocketmqNamesrv - receive request, 103 127.0.0.1:58887 RemotingCommand [code=103, language=JAVA, version=293, opaque=0, flag(B)=0, remark=null, extFields=&#123;brokerId=0, bodyCrc32=2135245619, clusterName=DefaultCluster, brokerAddr=192.168.1.28:8888, haServerAddr=192.168.1.28:10912, compressed=<span class="literal">false</span>, brokerName=broker<span class="_">-a</span>&#125;, serializeTypeCurrentRPC=JSON]</span><br><span class="line">15:19:21.461 [RemotingExecutorThread_7] INFO  RocketmqNamesrv - new topic registered, RMQ_SYS_TRANS_HALF_TOPIC QueueData [brokerName=broker<span class="_">-a</span>, <span class="built_in">read</span>QueueNums=1, writeQueueNums=1, perm=6, topicSynFlag=0]</span><br><span class="line">15:19:21.461 [RemotingExecutorThread_7] INFO  RocketmqNamesrv - new broker registered, 192.168.1.28:8888 HAServer: 192.168.1.28:10912</span><br></pre></td></tr></table></figure>
<h2 id="å¯åŠ¨-RocketMQ-Producer"><a href="#å¯åŠ¨-RocketMQ-Producer" class="headerlink" title="å¯åŠ¨ RocketMQ Producer"></a>å¯åŠ¨ RocketMQ Producer</h2><p>æ‰“å¼€ <code>org.apache.rocketmq.example.quickstart.Producer</code> ç¤ºä¾‹ç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> MQClientException, InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Instantiate with a producer group name.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        DefaultMQProducer producer = <span class="keyword">new</span> DefaultMQProducer(<span class="string">"please_rename_unique_group_name"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Specify name server addresses.</span></span><br><span class="line"><span class="comment">         * &lt;p/&gt;</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Alternatively, you may specify name server addresses via exporting environmental variable: NAMESRV_ADDR</span></span><br><span class="line"><span class="comment">         * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">         * &#123;@code</span></span><br><span class="line"><span class="comment">         * producer.setNamesrvAddr("name-server1-ip:9876;name-server2-ip:9876");</span></span><br><span class="line"><span class="comment">         * &#125;</span></span><br><span class="line"><span class="comment">         * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Launch the instance.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// æŒ‡æ˜Namesrv</span></span><br><span class="line">        producer.setNamesrvAddr(<span class="string">"127.0.0.1:9876"</span>);</span><br><span class="line">        producer.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * Create a message instance, specifying topic, tag and message body.</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                Message msg = <span class="keyword">new</span> Message(<span class="string">"TopicTest"</span> <span class="comment">/* Topic */</span>,</span><br><span class="line">                    <span class="string">"TagA"</span> <span class="comment">/* Tag */</span>,</span><br><span class="line">                    (<span class="string">"Hello RocketMQ "</span> + i).getBytes(RemotingHelper.DEFAULT_CHARSET) <span class="comment">/* Message body */</span></span><br><span class="line">                );</span><br><span class="line"></span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * Call send message to deliver message to one of brokers.</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                SendResult sendResult = producer.send(msg);</span><br><span class="line"></span><br><span class="line">                System.out.printf(<span class="string">"%s%n"</span>, sendResult);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Shut down once the producer instance is not longer in use.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        producer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ ¹æ®æ³¨é‡Šï¼Œæˆ‘ä»¬éœ€è¦æŒ‡æ˜Namesrvåœ°å€:<code>producer.setNamesrvAddr(&quot;127.0.0.1:9876&quot;);</code></p>
<p>è¿è¡Œä¹‹åå°±ä¼šå‘é€1000æ¡æ¶ˆæ¯å•¦ï¼Œç„¶åå°±ä¼šæ–­å¼€ä¸Namesrvï¼Œbrokerçš„è¿æ¥ï¼Œæ—¥å¿—å¦‚ä¸‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SendResult [sendStatus=SEND_OK, msgId=C0A8011C69E618B4AAC22757459803E7, offsetMsgId=C0A8011C000022B80000000000057CB0, messageQueue=MessageQueue [topic=TopicTest, brokerName=broker<span class="_">-a</span>, queueId=0], queueOffset=499]</span><br><span class="line">15:20:30.889 [NettyClientSelector_1] INFO  RocketmqRemoting - closeChannel: close the connection to remote address[192.168.1.28:8888] result: <span class="literal">true</span></span><br><span class="line">15:20:30.890 [NettyClientSelector_1] INFO  RocketmqRemoting - closeChannel: close the connection to remote address[192.168.1.28:8886] result: <span class="literal">true</span></span><br><span class="line">15:20:30.891 [NettyClientSelector_1] INFO  RocketmqRemoting - closeChannel: close the connection to remote address[127.0.0.1:9876] result: <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h2 id="å¯åŠ¨-RocketMQ-Producer-1"><a href="#å¯åŠ¨-RocketMQ-Producer-1" class="headerlink" title="å¯åŠ¨ RocketMQ Producer"></a>å¯åŠ¨ RocketMQ Producer</h2><p>æ‰“å¼€ <code>org.apache.rocketmq.example.quickstart.Consumer</code> ç¤ºä¾‹ç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Consumer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException, MQClientException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Instantiate with specified consumer group name.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        DefaultMQPushConsumer consumer = <span class="keyword">new</span> DefaultMQPushConsumer(<span class="string">"please_rename_unique_group_name_4"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Specify name server addresses.</span></span><br><span class="line"><span class="comment">         * &lt;p/&gt;</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Alternatively, you may specify name server addresses via exporting environmental variable: NAMESRV_ADDR</span></span><br><span class="line"><span class="comment">         * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">         * &#123;@code</span></span><br><span class="line"><span class="comment">         * consumer.setNamesrvAddr("name-server1-ip:9876;name-server2-ip:9876");</span></span><br><span class="line"><span class="comment">         * &#125;</span></span><br><span class="line"><span class="comment">         * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">// æŒ‡æ˜Namesrv</span></span><br><span class="line">        consumer.setNamesrvAddr(<span class="string">"127.0.0.1:9876"</span>);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Specify where to start in case the specified consumer group is a brand new one.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        consumer.setConsumeFromWhere(ConsumeFromWhere.CONSUME_FROM_FIRST_OFFSET);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Subscribe one more more topics to consume.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        consumer.subscribe(<span class="string">"TopicTest"</span>, <span class="string">"*"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         *  Register callback to execute on arrival of messages fetched from brokers.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        consumer.registerMessageListener(<span class="keyword">new</span> MessageListenerConcurrently() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> ConsumeConcurrentlyStatus <span class="title">consumeMessage</span><span class="params">(List&lt;MessageExt&gt; msgs,</span></span></span><br><span class="line"><span class="function"><span class="params">                ConsumeConcurrentlyContext context)</span> </span>&#123;</span><br><span class="line">                System.out.printf(<span class="string">"%s Receive New Messages: %s %n"</span>, Thread.currentThread().getName(), msgs);</span><br><span class="line">                <span class="keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         *  Launch the consumer instance.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        consumer.start();</span><br><span class="line"></span><br><span class="line">        System.out.printf(<span class="string">"Consumer Started.%n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ ¹æ®æ³¨é‡Šï¼Œæˆ‘ä»¬è¿™é‡Œä¹Ÿéœ€è¦æŒ‡æ˜Namesrvåœ°å€:<code>consumer.setNamesrvAddr(&quot;127.0.0.1:9876&quot;);</code></p>
<p>ç–¯ç‹‚æ¶ˆè´¹çš„æ—¥å¿—å¦‚ä¸‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Consumer Started.</span><br><span class="line">ConsumeMessageThread_3 Receive New Messages: [MessageExt [queueId=1, storeSize=178, queueOffset=250, sysFlag=0, bornTimestamp=1559978428786, bornHost=/192.168.1.28:58898, storeTimestamp=1559978428830, storeHost=/192.168.1.28:8888, msgId=C0A8011C000022B8000000000002BEB2, commitLogOffset=179890, bodyCRC=613185359, reconsumeTimes=0, preparedTransactionOffset=0, toString()=Message&#123;topic=<span class="string">'TopicTest'</span>, flag=0, properties=&#123;MIN_OFFSET=0, MAX_OFFSET=500, CONSUME_START_TIME=1559978752764, UNIQ_KEY=C0A8011C69E618B4AAC227573D700000, WAIT=<span class="literal">true</span>, TAGS=TagA&#125;, body=[72, 101, 108, 108, 111, 32, 82, 111, 99, 107, 101, 116, 77, 81, 32, 48], transactionId=<span class="string">'null'</span>&#125;]] </span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>It`s over !!</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>å¾ˆå–œæ¬¢ä¸‹é¢çš„è¯ï¼š</p>
<p><strong>æºç ï¼Œæ˜¯åŸç†çš„å…·è±¡åŒ–</strong><br><strong>åŸç†ï¼Œæ˜¯ä»£ç çš„æŠ½è±¡åŒ–</strong></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¼•ï¼šç»ˆäºè¦å¼€å§‹äº†å—ï¼Œä¸€ç›´æƒ³å¥½å¥½å¼„æ¸…æ¥šä¸€æ¬¾MQï¼Œä½œä¸ºä¸€åJavaerï¼Œè‚¯å®šé€‰æ‹©RocketMQï¼Œå¸Œæœ›ä»Šå¤©æ˜¯ä¸€ä¸ªå¥½å¼€å§‹ï¼
    
    </summary>
    
      <category term="RocketMQæºç " scheme="http://bestlixiang.site/categories/RocketMQ%E6%BA%90%E7%A0%81/"/>
    
    
      <category term="RocketMQ" scheme="http://bestlixiang.site/tags/RocketMQ/"/>
    
  </entry>
  
  <entry>
    <title>CSAPPè¯»åæ„Ÿ</title>
    <link href="http://bestlixiang.site/2019/05/26/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/CSAPP%E8%AF%BB%E5%90%8E%E6%84%9F/"/>
    <id>http://bestlixiang.site/2019/05/26/è®¡ç®—æœºåŸºç¡€/CSAPPè¯»åæ„Ÿ/</id>
    <published>2019-05-26T13:57:48.000Z</published>
    <updated>2019-05-26T14:31:29.356Z</updated>
    
    <content type="html"><![CDATA[<p>å¼•ï¼šå¯¹äºä¸€ä¸ªéç§‘ç­çš„ç¨‹åºå‘˜ï¼Œè®¡ç®—æœºåŸºç¡€å¯èƒ½æ°¸è¿œéƒ½æ˜¯ä»–çš„æ¢¦é­‡ã€‚æˆ‘ä¹Ÿä¸ä¾‹å¤–ï¼Œè™½ç„¶ä¹‹å‰ä¹Ÿçœ‹è¿‡è®¡ç®—æœºç»„æˆï¼Œæ“ä½œç³»ç»Ÿï¼Œè®¡ç®—æœºç½‘ç»œï¼Œæ•°æ®ç»“æ„ä¸ç®—æ³•ï¼Œä½†æ˜¯å¯èƒ½éƒ½æ˜¯è‡ªå­¦ï¼Œç„¶åæœ‰ç‚¹æµ®äºè¡¨é¢ï¼Œè®©è‡ªå·±çš„å¿ƒé‡Œä¸€ç›´éƒ½ä¸å¤ªè¸å®ã€‚CSAPPæ˜¯è‡ªå·±ä¸€ç›´æƒ³è¯»çš„ä¹¦ï¼Œä½†æ˜¯å¾ˆå¤šæ—¶å€™çœ‹äº†ä¸¤ç« å°±æ”¾å¼ƒäº†ï¼Œè¿™æ¬¡ç®—æ˜¯åšæŒäº†3ä¸ªæ˜ŸæœŸçœ‹å®Œäº†å®ƒï¼Œç„¶åå‘è¡¨æ°´æ–‡ä¸€ç¯‡ï¼è¯æ˜è‡ªå·±æ¥è¿‡ğŸ¤£<a id="more"></a></p>
<h1 id="å†…å®¹ä»‹ç»"><a href="#å†…å®¹ä»‹ç»" class="headerlink" title="å†…å®¹ä»‹ç»"></a>å†…å®¹ä»‹ç»</h1><p>åœ¨ç¨‹åºçš„ä¸–ç•Œï¼Œä¸‡äº‹ç¦»ä¸å¼€HelloWorldï¼Œæœ¬ä¹¦ä¹Ÿè¿˜æ˜¯ä»ä¸€ä¸ªhelloworldå‘æˆ‘ä»¬ä»‹ç»äº†ä¸€ä¸ªhelloworldç¨‹åºæ˜¯æ€ä¹ˆè¿è¡Œçš„ï¼Œä»ç¼–è¯‘åˆ°æ¶‰åŠçš„ç¡¬ä»¶ä»¥åŠæ“ä½œç³»ç»Ÿï¼Œç½‘ç»œé€šä¿¡ï¼Œå…ˆæŠŠå¤§æ¦‚çš„æ¦‚å¿µæ¥äº†ä¸€å¥—ï¼Œç„¶åå°±å¼€å§‹æ­£æ–‡å•¦ï¼ï¼å…ˆä»æ•°æ®çš„è¡¨ç¤ºå¼€å§‹ï¼ˆç‰›é€¼ï¼‰ï¼Œè‡ªç„¶è€Œç„¶å¼•å‡ºç¨‹åºçš„è¡¨ç¤ºï¼ˆé‡ç‚¹åœ¨äºæ±‡ç¼–ï¼‰ï¼Œæ¥ç€è®²è§£äº†å¤„ç†å™¨æ˜¯å¦‚ä½•æ‰§è¡Œæ±‡ç¼–æŒ‡ä»¤çš„ï¼ˆå¤„ç†å™¨æ˜¯æ€ä¹ˆå·¥ä½œçš„ï¼‰ï¼Œè¿™é‡Œåˆæ¶‰åŠåˆ°äº†å­˜å‚¨å™¨ç›¸å…³å†…å®¹ï¼ˆå­˜å‚¨å™¨å±±ï¼‰ï¼›æ¥ç€ä»‹ç»æ§åˆ¶æµï¼ˆæ¶‰åŠåˆ°è¿›ç¨‹ï¼Œä¿¡å·ï¼‰ã€è™šæ‹Ÿå†…å­˜ï¼ˆåŠ¨æ€åˆ†é…ï¼Œåƒåœ¾æœé›†ï¼‰ç­‰é«˜çº§è¯é¢˜ï¼Œè¿™ä¹‹åå¼€å§‹æ¶‰åŠè¯¸å¦‚I/Oã€ç½‘ç»œç¼–ç¨‹ã€å¹¶å‘ç¼–ç¨‹ç­‰çŸ¥è¯†ã€‚æ€»ä¹‹ï¼Œå¹²è´§æ»¡æ»¡ï¼Œä½†æ˜¯éœ€è¦æŒºèŠ±æ—¶é—´çš„ï¼Œå“ï¼Œæ‡’äº†æ‡’äº†ï¼ï¼ï¼</p>
<h1 id="æ•´ä½“æ„Ÿå—"><a href="#æ•´ä½“æ„Ÿå—" class="headerlink" title="æ•´ä½“æ„Ÿå—"></a>æ•´ä½“æ„Ÿå—</h1><p>è¿™æœ¬ä¹¦æ¶‰åŠçš„ç‚¹è¿˜æ˜¯è›®å¤šçš„ï¼Œåƒæ˜¯ä¸€æœ¬è®¡ç®—æœºç»„æˆå’Œæ“ä½œç³»ç»Ÿçš„ç»„åˆä¹¦ç±ï¼Œä½†æ˜¯å¯èƒ½ä¹Ÿæ˜¯å› ä¸ºç»„åˆï¼Œæœ‰äº›ç‚¹å°±è®²å¾—æ²¡æœ‰é‚£ä¹ˆç»†äº†ï¼Œä½†æ˜¯åœ¨ä¹¦é‡Œéƒ½å¯ä»¥ç»™å‡ºç›¸åº”çš„å­¦ä¹ å»ºè®®å’Œå‚è€ƒæ–‡çŒ®ï¼Œæˆ‘è§‰å¾—å¾ˆä¸é”™ã€‚å…¶å®è¿™æœ¬ä¹¦è¿˜é…å¥—äº†ç›¸åº”çš„<a href="http://csapp.cs.cmu.edu/3e/labs.html" target="_blank" rel="noopener">å®éªŒ</a>ï¼Œè¿™ä¸ªå®éªŒè¿˜æ˜¯æœ‰ä¸€å®šéš¾åº¦çš„ï¼Œæ‰€ä»¥è‡ªå·±å°±ä¸äº†äº†ä¹‹äº†ï¼Œå¸Œæœ›ä»¥åæœ‰æœºä¼šå†æ¥æä¸€éï¼Œç›¸ä¿¡æ”¶è·ä¸€å®šæŒºå¤§ã€‚æ€»çš„æ¥è¯´ï¼Œè¿™æœ¬ä¹¦è¿˜æ˜¯ç»™æˆ‘è§£ç­”äº†ä¸€äº›ç–‘æƒ‘å’ŒåŠ æ·±ä¸€äº›å°è±¡ï¼Œå°¤å…¶æ˜¯åœ¨æ“ä½œç³»ç»Ÿæ–¹é¢ã€‚åˆšå¥½å€Ÿç”¨ä¹‹å‰åŒäº‹è¯´çš„ä¸€å¥è¯ï¼š<strong>ä¸åŒçš„æ—¶å€™ï¼Œè¯»ç›¸åŒçš„ä¸œè¥¿ï¼Œä»–çš„æ„Ÿå—å’Œæ”¶è·ä¸€å®šæ˜¯ä¸åŒçš„</strong>ã€‚</p>
<h1 id="ç–‘é—®"><a href="#ç–‘é—®" class="headerlink" title="ç–‘é—®"></a>ç–‘é—®</h1><p>è™½è¯´çœ‹å®Œäº†è¿™æœ¬ä¹¦ï¼Œä½†æ˜¯è‡ªå·±è¿˜æ˜¯æœ‰å¾ˆå¤šåœ°æ–¹æ²¡æœ‰ç†è§£ï¼Œä»¥åä¸€å®šä¼šå†çœ‹ä¸€æ¬¡çš„ã€‚è¿™é‡Œæƒ³ç•™ç»™è‡ªå·±ä¸€ä¸ªé—®é¢˜ï¼Œè®©è‡ªå·±è¶Šæ¥è¶Šè¿·ç³Šçš„é—®é¢˜ï¼ˆå¸Œæœ›æ¸…æ¥šçš„äººä¹Ÿèƒ½å‘Šè¯‰æˆ‘è¿™ä¸ªå°èœé¸¡ï¼Œå“ˆå“ˆï¼‰ï¼š<strong>è®¡ç®—æœºä»æ‰“å¼€ç”µæºåæ˜¯æ€ä¹ˆè¿è¡Œçš„ï¼Ÿï¼ˆä»ç¡¬ä»¶åˆ°è½¯ä»¶ï¼‰</strong></p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol>
<li><a href="https://wdxtub.com/work/" target="_blank" rel="noopener">ä¸å‘¨å±±ä½œå“é›†</a></li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¼•ï¼šå¯¹äºä¸€ä¸ªéç§‘ç­çš„ç¨‹åºå‘˜ï¼Œè®¡ç®—æœºåŸºç¡€å¯èƒ½æ°¸è¿œéƒ½æ˜¯ä»–çš„æ¢¦é­‡ã€‚æˆ‘ä¹Ÿä¸ä¾‹å¤–ï¼Œè™½ç„¶ä¹‹å‰ä¹Ÿçœ‹è¿‡è®¡ç®—æœºç»„æˆï¼Œæ“ä½œç³»ç»Ÿï¼Œè®¡ç®—æœºç½‘ç»œï¼Œæ•°æ®ç»“æ„ä¸ç®—æ³•ï¼Œä½†æ˜¯å¯èƒ½éƒ½æ˜¯è‡ªå­¦ï¼Œç„¶åæœ‰ç‚¹æµ®äºè¡¨é¢ï¼Œè®©è‡ªå·±çš„å¿ƒé‡Œä¸€ç›´éƒ½ä¸å¤ªè¸å®ã€‚CSAPPæ˜¯è‡ªå·±ä¸€ç›´æƒ³è¯»çš„ä¹¦ï¼Œä½†æ˜¯å¾ˆå¤šæ—¶å€™çœ‹äº†ä¸¤ç« å°±æ”¾å¼ƒäº†ï¼Œè¿™æ¬¡ç®—æ˜¯åšæŒäº†3ä¸ªæ˜ŸæœŸçœ‹å®Œäº†å®ƒï¼Œç„¶åå‘è¡¨æ°´æ–‡ä¸€ç¯‡ï¼è¯æ˜è‡ªå·±æ¥è¿‡ğŸ¤£
    
    </summary>
    
      <category term="è®¡ç®—æœºåŸºç¡€" scheme="http://bestlixiang.site/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="è®¡ç®—æœºç»„æˆ" scheme="http://bestlixiang.site/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90/"/>
    
      <category term="æ“ä½œç³»ç»Ÿ" scheme="http://bestlixiang.site/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"/>
    
  </entry>
  
  <entry>
    <title>JVMæºç â€”â€”åŠé€€å¾…èµ·èˆª</title>
    <link href="http://bestlixiang.site/2019/04/26/JVM%E6%BA%90%E7%A0%81/JVM%E6%BA%90%E7%A0%81%E2%80%94%E2%80%94%E5%8A%9D%E9%80%80%E5%BE%85%E8%B5%B7%E8%88%AA/"/>
    <id>http://bestlixiang.site/2019/04/26/JVMæºç /JVMæºç â€”â€”åŠé€€å¾…èµ·èˆª/</id>
    <published>2019-04-26T12:15:14.000Z</published>
    <updated>2019-04-26T12:25:06.543Z</updated>
    
    <content type="html"><![CDATA[<p>åŸä»¥ä¸ºå¯ä»¥å¹³ç»“è‡ªå·±ç•¥æ‡‚çš„C++å»çœ‹JVMæºç ï¼Œä½†æ˜¯ç­‰åˆ°è‡ªå·±çœŸæ­£å»æ‰“å¼€æºç ï¼Œå°±ç®—æ˜¯å¯¹ç€åšå®¢çœ‹ï¼Œä¹Ÿæ˜¯ååˆ†åƒåŠ›ï¼Œè¿˜çœ‹äº†çŸ¥ä¹Rå¤§å¯¹çœ‹JVMæºç çš„çœ‹æ³•ã€‚SOï¼Œæˆ‘è¢«è‡ªå·±å’ŒRå¤§åŠé€€äº†ï¼Œå¯èƒ½ç›®å‰çš„è‡ªå·±è¿˜ä¸é€‚åˆå»çœ‹ï¼Œå¸Œæœ›è‡ªå·±ä»¥å<strong>æœ‰éœ€è¦æœ‰æ¢¦æƒ³</strong>å†æ¥çœ‹ï¼<a id="more"></a><br><img src="https://upload-images.jianshu.io/upload_images/10354196-a3eeb7ecd08d51cf.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="åŠé€€.jpeg"></p>
<h1 id="åŠé€€"><a href="#åŠé€€" class="headerlink" title="åŠé€€"></a>åŠé€€</h1><p><a href="https://www.zhihu.com/question/20097631" target="_blank" rel="noopener">Rå¤§å…³äº <strong>Java JVMæ€ä¹ˆå­¦ä¹ å•Šï¼Ÿä»å“ªæ–¹é¢å…¥æ‰‹ï¼Ÿ</strong>çš„å›ç­”</a></p>
<p>è¿™å®Œå…¨å–å†³äºé¢˜ä¸»æ˜¯ä¸ºä»€ä¹ˆè¦å­¦ä¹ JVMï¼Œæƒ³å­¦åˆ°å¤šæ·±ã€‚å‰é¢ <a href="//www.zhihu.com/people/05f661615136170935175f54719ff0a0">@æ›¹æ—­ä¸œ</a> å’Œ <a href="//www.zhihu.com/people/7a082a33732215bdd02df94467fe6b1f">@Scott</a> è¯´å¾—å¾ˆå¯¹ã€‚<br>å¦‚æœæ„Ÿè§‰æ‘¸ä¸æ¸…ä¸œå—è¥¿åŒ—çš„è¯è¯·è¯•è¯•ä»æˆ‘åœ¨è±†ç“£ä¸Šå‘çš„è±†å•å¼€å§‹å§ï¼š<a href="https://link.zhihu.com/?target=http%3A//book.douban.com/doulist/2545443/" target="_blank" rel="noopener">ä»è¡¨åˆ°é‡Œå­¦ä¹ JVMå®ç°</a><br>å¦‚æœä¸€ä¸Šæ¥å°±æƒ³é€šè¿‡é˜…è¯»OpenJDKé‡Œçš„HotSpot VMçš„æºç æ¥å…¥æ‰‹å­¦ä¹ JVMï¼Œé‚£ä¹ˆæˆ‘æ¨èå…ˆè¯»è¯»æˆ‘ä¹‹å‰å†™çš„ä¸€ä¸ªæ¼”ç¤ºç¨¿ï¼š<a href="https://link.zhihu.com/?target=http%3A//rednaxelafx.iteye.com/blog/1426530" target="_blank" rel="noopener">ä¸ºå•¥åˆ«è¯»HotSpot VMçš„æºç </a></p>
<p>è™½ç„¶è¯´ç°åœ¨ä¸çœ‹äº†ï¼Œä½†æ˜¯è‡ªå·±è¿˜æ˜¯ç•™åœ¨å‡ ä¸ªJVMè§£æç›¸å…³åšå®¢ï¼š</p>
<ol>
<li><a href="https://www.jianshu.com/nb/12554212" target="_blank" rel="noopener">JVMæºç åˆ†æ</a></li>
<li><a href="https://hunterzhao.io/categories/#" target="_blank" rel="noopener">JVMæºç æ­ç§˜</a></li>
</ol>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ä½†è¡Œå¥½äº‹ï¼Œè«é—®å‰ç¨‹</p>
<p>çŠ¶æ€ï¼šæ„Ÿè§‰ä»€ä¹ˆéƒ½æ‡‚ä¸€ç‚¹ï¼Œåˆæ„Ÿè§‰ä»€ä¹ˆéƒ½ä¸æ‡‚ â€”â€” ä¸å¤Ÿæ·±å…¥</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åŸä»¥ä¸ºå¯ä»¥å¹³ç»“è‡ªå·±ç•¥æ‡‚çš„C++å»çœ‹JVMæºç ï¼Œä½†æ˜¯ç­‰åˆ°è‡ªå·±çœŸæ­£å»æ‰“å¼€æºç ï¼Œå°±ç®—æ˜¯å¯¹ç€åšå®¢çœ‹ï¼Œä¹Ÿæ˜¯ååˆ†åƒåŠ›ï¼Œè¿˜çœ‹äº†çŸ¥ä¹Rå¤§å¯¹çœ‹JVMæºç çš„çœ‹æ³•ã€‚SOï¼Œæˆ‘è¢«è‡ªå·±å’ŒRå¤§åŠé€€äº†ï¼Œå¯èƒ½ç›®å‰çš„è‡ªå·±è¿˜ä¸é€‚åˆå»çœ‹ï¼Œå¸Œæœ›è‡ªå·±ä»¥å&lt;strong&gt;æœ‰éœ€è¦æœ‰æ¢¦æƒ³&lt;/strong&gt;å†æ¥çœ‹ï¼
    
    </summary>
    
      <category term="JVMæºç " scheme="http://bestlixiang.site/categories/JVM%E6%BA%90%E7%A0%81/"/>
    
    
      <category term="JVM" scheme="http://bestlixiang.site/tags/JVM/"/>
    
  </entry>
  
  <entry>
    <title>JVMæºç â€”â€”Macä¸‹ç¼–è¯‘JDK</title>
    <link href="http://bestlixiang.site/2019/04/25/JVM%E6%BA%90%E7%A0%81/JVM%E6%BA%90%E7%A0%81%E2%80%94%E2%80%94Mac%E4%B8%8B%E7%BC%96%E8%AF%91JDK/"/>
    <id>http://bestlixiang.site/2019/04/25/JVMæºç /JVMæºç â€”â€”Macä¸‹ç¼–è¯‘JDK/</id>
    <published>2019-04-25T13:07:14.000Z</published>
    <updated>2019-04-25T12:57:43.140Z</updated>
    
    <content type="html"><![CDATA[<p>å¼•ï¼šå¥½åƒæ˜¯åœ¨å¤§å››çš„æ—¶å€™ï¼Œè‡ªå·±æŒ‰ç…§ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹å»ç¼–è¯‘JDKæ²¡æœ‰æˆåŠŸï¼ä½†æ˜¯åœ¨æœ€è¿‘ç»å†ä¸€äº›é¢è¯•ä¹‹åï¼Œæ„Ÿåˆ°JVMç»å¯¹æ˜¯é¢è¯•çš„ä¸€å—é‡ç‚¹ï¼Œè€Œçœ‹æºç ç»å¯¹æ˜¯ä½ æ·±å…¥ç†è§£JVMçš„ä¸€ä¸ªå¾ˆé‡è¦çš„ç‚¹ï¼åœ¨çœ‹æºç ï¼Œå°±éœ€è¦è°ƒè¯•ï¼Œé‚£ä¹ˆç¼–è¯‘è‡ªå·±JDKè¶Šæ˜¯å¿…ç„¶çš„ã€‚è¿™æ¬¡æˆ‘ä»¬åœ¨Macä¸‹å»ç¼–è¯‘OpenJDK9ï¼ï¼ï¼<a id="more"></a><br><img src="https://upload-images.jianshu.io/upload_images/10354196-14707d615dd58eed.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="å¤è”4.jpeg"></p>
<p>4.24çœ‹å®Œå¤è”4ï¼Œè„‘å­å¤ªå¤šçš„ç‚¹åŒ–ä¸º<strong>çˆ±ä½ ä¸‰åƒé</strong>ï¼</p>
<p>è¿›å…¥ä»Šå¤©çš„æ­£é¢˜ï¼ï¼ï¼</p>
<h1 id="å‡†å¤‡"><a href="#å‡†å¤‡" class="headerlink" title="å‡†å¤‡"></a>å‡†å¤‡</h1><p>å…³äºç¼–è¯‘JDKï¼Œå…¶å®åœ¨å®˜æ–¹çš„æºç åŒ…ä¸‹æœ‰ä¸ªå¸®åŠ©æ–‡ä»¶ï¼ˆopenjdk/common/building.html/mdï¼‰ã€‚è¿™ä¸ªæ–‡ä»¶ä¼šå‘Šè¯‰æˆ‘ä»¬åœ¨ç¼–è¯‘JDKä¹‹å‰éœ€è¦åšçš„å‡†å¤‡ä»¥åŠç¼–è¯‘çš„æ­¥éª¤ã€‚å…·ä½“çš„å¤§å®¶å¯ä»¥ä»”ç»†é˜…è¯»çœ‹çœ‹ã€‚ä¸‹æ¬¡åªè®²è¿°è‡ªå·±è¿™æ¬¡æ‰€ç¼–è¯‘çš„è¿‡ç¨‹ï¼</p>
<p>æˆ‘ä»¬éœ€è¦å‡†å¤‡ä¸€äº›ä¸œè¥¿ï¼Œé¦–å…ˆä½ éœ€è¦å‡†å¤‡ homebrewï¼Œhomwbrewæ˜¯macä¸‹çš„åŒ…ç®¡ç†å™¨ï¼Œå¦‚æœä½ çš„macä¸Šæ²¡æœ‰å®‰è£…ï¼Œå¯ä»¥æŒ‰ç…§ä¸‹é¢çš„æ–¹å¼æ¥å®‰è£…ï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/ruby <span class="_">-e</span> <span class="string">"<span class="variable">$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)</span>"</span></span><br></pre></td></tr></table></figure></p>
<p>homwbrewä¸‹è½½å®Œæˆä¹‹åï¼Œæ¥ä¸‹æ¥å‡†å¤‡ç¼–è¯‘ç¯å¢ƒï¼š</p>
<ul>
<li>å®‰è£…openjdkçš„ç‰ˆæœ¬ç®¡ç†å·¥å…·mercurialï¼ˆhgï¼‰</li>
<li>å®‰è£…ccacheå’Œfreetypeï¼Œccacheç”¨æ¥åŠ é€Ÿç¼–è¯‘ï¼Œfreetypeåœ¨ç¼–è¯‘è¿‡ç¨‹ä¹Ÿä¼šä¾èµ–åˆ°</li>
</ul>
<p>å®‰è£…è„šæœ¬ä¸ºï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">brew install mercurial</span><br><span class="line">brew install ccache</span><br><span class="line">brew install freetype</span><br></pre></td></tr></table></figure></p>
<p>å‡†å¤‡å¥½ä¹‹åå°±å¯ä»¥å¼€å§‹å…·ä½“çš„æ“ä½œäº†ï¼</p>
<h1 id="ä¸‹è½½æºç "><a href="#ä¸‹è½½æºç " class="headerlink" title="ä¸‹è½½æºç "></a>ä¸‹è½½æºç </h1><h2 id="å®˜æ–¹æ¨èhg"><a href="#å®˜æ–¹æ¨èhg" class="headerlink" title="å®˜æ–¹æ¨èhg"></a>å®˜æ–¹æ¨èhg</h2><p>hgï¼šMercurial source code management system<br>æˆ‘ä¸ºæºç ä¸“é—¨åˆ›å»ºäº†ä¸€ä¸ªç›®å½• <code>~/jvm</code> ï¼Œç„¶åè¿è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/jvm</span><br><span class="line">hg <span class="built_in">clone</span> http://hg.openjdk.java.net/jdk9/jdk9 jdk9</span><br></pre></td></tr></table></figure></p>
<p>è¿™æ¡å‘½ä»¤è¿è¡Œä¹‹åï¼Œopenjdkçš„æºç å¹¶æ²¡æœ‰ä¸‹è½½ä¸‹æ¥ï¼Œæˆ‘ä»¬éšåè¿›å…¥åˆ°<code>~/jvm/jdk9</code>ç›®å½•ï¼Œä¼šå‘ç°æœ‰ä¸€ä¸ª <code>get_source.sh</code> çš„æ–‡ä»¶ï¼Œè°ƒç”¨è¿™ä¸ªè„šæœ¬ä¸‹è½½å®Œæ•´çš„æºç ä¹‹å‰ï¼Œéœ€è¦åšä¸€ä¸‹ç®€å•çš„ä¿®æ”¹ï¼Œä¸ç„¶å¯èƒ½ä½ åœ¨ä¸‹è½½æºç çš„è¿‡ç¨‹ä¸­ä¼šæ•°æ¬¡ä¸­æ–­ã€‚<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Get clones of all absent nested repositories (harmless if already exist)</span></span><br><span class="line">sh ./common/bin/hgforest.sh <span class="built_in">clone</span> <span class="string">"<span class="variable">$@</span>"</span> || <span class="built_in">exit</span> $?</span><br><span class="line"></span><br><span class="line"><span class="comment"># Update all existing repositories to the latest sources</span></span><br><span class="line">sh ./common/bin/hgforest.sh pull -u</span><br></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬æŠŠä¸Šé¢å‡ è¡Œçš„è„šæœ¬åˆ æ‰ï¼Œæ›¿æ¢æˆä¸‹é¢çš„è„šæœ¬ï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Get clones of all absent nested repositories (harmless if already exist)</span></span><br><span class="line">sh ./common/bin/hgforest.sh <span class="built_in">clone</span> <span class="string">"<span class="variable">$@</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> [ $? <span class="_">-ne</span> 0 ]</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    sh ./common/bin/hgforest.sh <span class="built_in">clone</span> <span class="string">"<span class="variable">$@</span>"</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Update all existing repositories to the latest sources</span></span><br><span class="line">sh ./common/bin/hgforest.sh pull -u</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> [ $? <span class="_">-ne</span> 0 ]</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    sh ./common/bin/hgforest.sh pull -u</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure></p>
<p>ç„¶åï¼Œæ„‰å¿«åœ°è°ƒç”¨ï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash ./get_source.sh</span><br></pre></td></tr></table></figure></p>
<p>æœ¬äººè¡¨ç¤ºè¿™ä¸ªè¿™ä¸ªæ–¹æ³•æˆ‘æ²¡æœ‰æˆåŠŸï¼Œhhhã€‚æˆ‘åœ¨æ‰§è¡Œ<code>hg clone</code> çš„æ—¶å€™å°±ä¸€ç›´æŠ¥ç½‘ç»œé”™è¯¯ï¼Œå¯èƒ½æ˜¯ç”±äºthe great wallå§ï¼Œè¿˜å¥½æœ‰ä¸‹é¢çš„æ–¹æ³•ã€‚</p>
<h2 id="github"><a href="#github" class="headerlink" title="github"></a>github</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. https://github.com/unofficial-openjdk/openjdk/</span><br><span class="line">2. https://github.com/dmlloyd/openjdk</span><br></pre></td></tr></table></figure>
<p>æˆ‘é€‰æ‹©äº†ç¬¬äºŒä¸ªï¼Œåˆ‡æ¢åˆ°äº†jdk/jdk9åˆ†æ”¯ï¼Œå› ä¸ºæˆ‘ä»¬è¿™æ¬¡è¦ç¼–è¯‘jdk9ã€‚æ“ä½œå¦‚ä¸‹ï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/jvm</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/dmlloyd/openjdk.git</span><br><span class="line"><span class="built_in">cd</span> openjdk</span><br><span class="line">git checkout -b jdk9 origin/jdk9/jdk9</span><br></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªè¿˜æ˜¯æŒºé¡ºåˆ©çš„ï¼Œå“ˆå“ˆï¼</p>
<h1 id="configure"><a href="#configure" class="headerlink" title="configure"></a>configure</h1><p>æˆ‘ä»¬å…ˆè¿›è¡Œç¼–è¯‘å‰çš„é…ç½®ï¼ˆæ£€æŸ¥ï¼‰ï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --with-target-bits=64 --with-freetype=/usr/<span class="built_in">local</span>/Cellar/freetype/2.8.1 --enable-ccache --with-jvm-variants=server,client --with-boot-jdk-jvmargs=<span class="string">"-Xlint:deprecation -Xlint:unchecked"</span> --disable-zip-debug-info --disable-warnings-as-errors --with-debug-level=slowdebug 2&gt;&amp;1 | tee configure_mac_x64.log</span><br></pre></td></tr></table></figure></p>
<p>æœ‰æ—¥å¿—ï¼Œå‡ºé—®é¢˜æŸ¥é—®é¢˜ä¹Ÿå¾ˆæ–¹ä¾¿ï¼<br><strong>æ³¨æ„</strong>ï¼Œä¸Šé¢çš„freetypeï¼Œéœ€è¦æ›¿æ¢æˆæœ¬æœºå®é™…å®‰è£…çš„ç‰ˆæœ¬</p>
<p>å¦‚æœå‡ºç°å¦‚ä¸‹çš„æç¤ºï¼Œé‚£ä¹ˆæ­å–œä½ ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥æ‰§è¡Œç¼–è¯‘äº†ï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">====================================================</span><br><span class="line">The existing configuration has been successfully updated <span class="keyword">in</span></span><br><span class="line">/Users/rex/jvm/openjdk/build/macosx-x86_64-normal-serverANDclient-slowdebug</span><br><span class="line">using configure arguments <span class="string">'--with-target-bits=64 --with-freetype=/usr/local/Cellar/freetype/2.10.0 --enable-ccache --with-jvm-variants=server,client --with-boot-jdk-jvmargs='</span>-Xlint:deprecation -Xlint:unchecked<span class="string">' --disable-warnings-as-errors --with-debug-level=slowdebug'</span>.</span><br><span class="line"></span><br><span class="line">Configuration summary:</span><br><span class="line">* Debug level:    slowdebug</span><br><span class="line">* HS debug level: debug</span><br><span class="line">* JDK variant:    normal</span><br><span class="line">* JVM variants:   server client</span><br><span class="line">* OpenJDK target: OS: macosx, CPU architecture: x86, address length: 64</span><br><span class="line">* Version string: 9-internal+0-adhoc.rex.openjdk (9-internal)</span><br><span class="line"></span><br><span class="line">Tools summary:</span><br><span class="line">* Boot JDK:       java version <span class="string">"9"</span> Java(TM) SE Runtime Environment (build 9+181) Java HotSpot(TM) 64-Bit Server VM (build 9+181, mixed mode)  (at /Library/Java/JavaVirtualMachines/jdk-9.jdk/Contents/Home)</span><br><span class="line">* Toolchain:      clang (clang/LLVM from Xcode 9.4.1)</span><br><span class="line">* C Compiler:     Version 9.1.0 (at /usr/bin/clang)</span><br><span class="line">* C++ Compiler:   Version 9.1.0 (at /usr/bin/clang++)</span><br><span class="line"></span><br><span class="line">Build performance summary:</span><br><span class="line">* Cores to use:   4</span><br><span class="line">* Memory <span class="built_in">limit</span>:   8192 MB</span><br><span class="line">* ccache status:  Active (3.6)</span><br><span class="line"></span><br><span class="line">NOTE: You have requested to build more than one version of the JVM, <span class="built_in">which</span></span><br><span class="line">will result <span class="keyword">in</span> longer build times.</span><br><span class="line"></span><br><span class="line">WARNING: The result of this configuration has overridden an older</span><br><span class="line">configuration. You *should* run <span class="string">'make clean'</span> to make sure you get a</span><br><span class="line">proper build. Failure to <span class="keyword">do</span> so might result <span class="keyword">in</span> strange build problems.</span><br></pre></td></tr></table></figure></p>
<h1 id="make"><a href="#make" class="headerlink" title="make"></a>make</h1><p>æˆ‘ä»¬æ‰§è¡Œä¸‹é¢çš„æ“ä½œï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> LANG=C</span><br><span class="line">make all LOG=debug  2&gt;&amp;1 | tee make_mac_x64.log</span><br></pre></td></tr></table></figure></p>
<p>å¦‚æœå‡ºç°å¦‚ä¸‹çš„æç¤ºï¼Œé‚£ä¹ˆæ­å–œä½ ï¼Œä½ çš„è¿æ°”å¤ªå¥½äº†ï¼ï¼ï¼<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">----- Build <span class="built_in">times</span> -------</span><br><span class="line">Start 2019-04-25 18:55:19</span><br><span class="line">End   2019-04-25 19:00:57</span><br><span class="line"></span><br><span class="line">00:05:38 TOTAL</span><br><span class="line">-------------------------</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">test</span> <span class="_">-f</span> /Users/rex/jvm/openjdk/build/macosx-x86_64-normal-serverANDclient-slowdebug/make-support/<span class="built_in">exit</span>-with-error ; <span class="keyword">then</span> \</span><br><span class="line">	    <span class="built_in">exit</span> 1 ; \</span><br><span class="line">	  <span class="keyword">fi</span></span><br><span class="line">/usr/bin/<span class="built_in">printf</span> <span class="string">"Finished building target 'all' in configuration 'macosx-x86_64-normal-serverANDclient-slowdebug'\n"</span> &gt; &gt;(/usr/bin/tee <span class="_">-a</span> /Users/rex/jvm/openjdk/build/macosx-x86_64-normal-serverANDclient-slowdebug/build.log) 2&gt; &gt;(/usr/bin/tee <span class="_">-a</span> /Users/rex/jvm/openjdk/build/macosx-x86_64-normal-serverANDclient-slowdebug/build.log &gt;&amp;2) &amp;&amp; <span class="built_in">wait</span></span><br><span class="line">Finished building target <span class="string">'all'</span> <span class="keyword">in</span> configuration <span class="string">'macosx-x86_64-normal-serverANDclient-slowdebug'</span></span><br></pre></td></tr></table></figure></p>
<p>æœ€åï¼ŒéªŒè¯ä¸€ä¸‹<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> build/macosx-x86_64-normal-serverANDclient-slowdebug/jdk/bin</span><br><span class="line">./java -version</span><br></pre></td></tr></table></figure></p>
<p>å‡ºç°ä¸‹é¢çš„æç¤ºå°±å®Œç¾äº†ï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openjdk version <span class="string">"9-internal"</span></span><br><span class="line">OpenJDK Runtime Environment (slowdebug build 9-internal+0-adhoc.rex.openjdk)</span><br><span class="line">OpenJDK 64-Bit Server VM (slowdebug build 9-internal+0-adhoc.rex.openjdk, mixed mode)</span><br></pre></td></tr></table></figure></p>
<h1 id="ç¼–è¯‘è¿‡ç¨‹ä¸­çš„é—®é¢˜"><a href="#ç¼–è¯‘è¿‡ç¨‹ä¸­çš„é—®é¢˜" class="headerlink" title="ç¼–è¯‘è¿‡ç¨‹ä¸­çš„é—®é¢˜"></a>ç¼–è¯‘è¿‡ç¨‹ä¸­çš„é—®é¢˜</h1><p>æ ¹æ®<strong>å¢¨è²å®šå¾‹</strong>ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ä¸€ã€ä»»ä½•äº‹éƒ½æ²¡æœ‰è¡¨é¢çœ‹èµ·æ¥é‚£ä¹ˆç®€å•ï¼›</span><br><span class="line">äºŒã€æ‰€æœ‰çš„äº‹éƒ½ä¼šæ¯”ä½ é¢„è®¡çš„æ—¶é—´é•¿ï¼›</span><br><span class="line">ä¸‰ã€ä¼šå‡ºé”™çš„äº‹æ€»ä¼šå‡ºé”™ï¼›</span><br><span class="line">å››ã€å¦‚æœä½ æ‹…å¿ƒæŸç§æƒ…å†µå‘ç”Ÿï¼Œé‚£ä¹ˆå®ƒå°±æ›´æœ‰å¯èƒ½å‘ç”Ÿã€‚</span><br></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªæ—¶é—´ä¼šæ¯”è¾ƒé•¿ï¼Œå‡ºé”™æ˜¯å¤§æ¦‚ç‡äº‹ä»¶ï¼Œè€Œæˆ‘å°±ç¢°åˆ°ç½‘ä¸Šè¯¥æœ‰çš„æ‰€æœ‰é”™ï¼ï¼ï¼ï¼</p>
<h2 id="Xcodeç‰ˆæœ¬é—®é¢˜"><a href="#Xcodeç‰ˆæœ¬é—®é¢˜" class="headerlink" title="Xcodeç‰ˆæœ¬é—®é¢˜"></a>Xcodeç‰ˆæœ¬é—®é¢˜</h2><p>æˆ‘çš„Xcodeç‰ˆæœ¬åŸæ¥ä¸º10+ï¼ŒXCodeå‡çº§åˆ°10ä¹‹å, åˆ é™¤äº†åº•å±‚ç›®å½•ä¸‹çš„libstdc++æ–‡ä»¶ã€‚å¯¼è‡´åœ¨JDKçš„Makeæ—¶ä¼šæŠ¥é”™, æ— æ³•è¯†åˆ«<new>ç±»ä¼¼è¿™æ ·çš„C++è¯­æ³•ã€‚è€Œåœ¨XCode9æ—¶å¯¹åº”æ–‡ä»¶è¿˜æ˜¯å­˜åœ¨çš„ã€‚å®˜æ–¹ç»™å‡ºçš„æ„æ€æ˜¯libstdc++å·²ç»è¢«æ ‡è®°ä¸ºè¿‡æœŸ5å¹´äº†, ç°åœ¨ç»Ÿä¸€ä½¿ç”¨è‡ªå·±libc++ã€‚è¿™ä¸ªé—®é¢˜æœ€ç®€å•çš„é—®é¢˜å°±æ˜¯XCodeç‰ˆæœ¬å›é€€åˆ°9ä¹‹å‰å³å¯ã€‚<a href="https://developer.apple.com/download/more/" target="_blank" rel="noopener">é‡æ–°ä¸‹è½½åœ°å€</a></new></p>
<h2 id="ä¸‰ä¸ªç©ºæŒ‡é’ˆè½¬æ¢"><a href="#ä¸‰ä¸ªç©ºæŒ‡é’ˆè½¬æ¢" class="headerlink" title="ä¸‰ä¸ªç©ºæŒ‡é’ˆè½¬æ¢"></a>ä¸‰ä¸ªç©ºæŒ‡é’ˆè½¬æ¢</h2><p>æ—¥å¿—è¢«è¦†ç›–äº†ï¼Œå¿˜è®°å­˜äº†ï¼Œä½†æ˜¯å¯èƒ½ä¼šå‡ºç°è¿™æ ·çš„é—®é¢˜ï¼Œä¸‹é¢çš„æ›´æ”¹çš„ç­”æ¡ˆï¼š<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1\. src/hotspot/share/memory/virtualspace.cpp # l585</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (base() != NULL) &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">#2\. src/hotspot/share/opto/lcm.cpp # l42</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (Universe::narrow_oop_base() != NULL) &#123; // Implies UseCompressedOops.</span><br><span class="line"></span><br><span class="line"><span class="comment">#3\. src/hotspot/share/opto/loopPredicate.cpp # l915</span></span><br><span class="line"></span><br><span class="line">assert(rng-&gt;Opcode() == Op_LoadRange || iff-&gt;is_RangeCheck() || _igvn.type(rng)-&gt;is_int()-&gt;_lo &gt;= 0, <span class="string">"must be"</span>);</span><br></pre></td></tr></table></figure></p>
<h2 id="JVM-crash"><a href="#JVM-crash" class="headerlink" title="JVM crash"></a>JVM crash</h2><p>  è‡ªå·±ä¹Ÿå¿˜è®°æˆªå›¾ï¼Œæ‰€ä»¥ä¹Ÿç›—å›¾äº†ï¼š<br>  <img src="https://upload-images.jianshu.io/upload_images/10354196-b5e7dae0682e7541.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="jvm crash.png"></p>
<p>è§£å†³æ–¹æ³•ï¼š<a href="https://stackoverflow.com/questions/50678467/building-openjdk-9-on-mac-os" target="_blank" rel="noopener">Building OpenJDK 9 on Mac os</a></p>
<p>ä¸Šé¢ä¸‰ä¸ªé—®é¢˜å…¨è¢«è‡ªå·±é‡åˆ°äº†ï¼Œè¿æ°”çœŸå¥½ï¼Œä¸è¿‡èµ°åˆ°è¿™é‡Œï¼Œç»ˆäºæ˜¯æŠŠJDKç¼–è¯‘å¥½äº†ï¼</p>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>ä½†è¡Œå¥½äº‹ï¼Œè«é—®å‰ç¨‹</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol>
<li><a href="https://www.jianshu.com/p/ee7e9176632c" target="_blank" rel="noopener">macä¸‹ç¼–è¯‘openjdk1.9åŠé›†æˆclionåŠ¨æ€è°ƒè¯•</a></li>
<li><a href="https://www.jianshu.com/p/38e697dcbaa5" target="_blank" rel="noopener">MacOS Mojave(10.14)ç¼–è¯‘openjdk9</a></li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¼•ï¼šå¥½åƒæ˜¯åœ¨å¤§å››çš„æ—¶å€™ï¼Œè‡ªå·±æŒ‰ç…§ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹å»ç¼–è¯‘JDKæ²¡æœ‰æˆåŠŸï¼ä½†æ˜¯åœ¨æœ€è¿‘ç»å†ä¸€äº›é¢è¯•ä¹‹åï¼Œæ„Ÿåˆ°JVMç»å¯¹æ˜¯é¢è¯•çš„ä¸€å—é‡ç‚¹ï¼Œè€Œçœ‹æºç ç»å¯¹æ˜¯ä½ æ·±å…¥ç†è§£JVMçš„ä¸€ä¸ªå¾ˆé‡è¦çš„ç‚¹ï¼åœ¨çœ‹æºç ï¼Œå°±éœ€è¦è°ƒè¯•ï¼Œé‚£ä¹ˆç¼–è¯‘è‡ªå·±JDKè¶Šæ˜¯å¿…ç„¶çš„ã€‚è¿™æ¬¡æˆ‘ä»¬åœ¨Macä¸‹å»ç¼–è¯‘OpenJDK9ï¼ï¼ï¼
    
    </summary>
    
      <category term="JVMæºç " scheme="http://bestlixiang.site/categories/JVM%E6%BA%90%E7%A0%81/"/>
    
    
      <category term="JVM" scheme="http://bestlixiang.site/tags/JVM/"/>
    
  </entry>
  
  <entry>
    <title>åˆ†å¸ƒå¼äº‹åŠ¡</title>
    <link href="http://bestlixiang.site/2018/12/28/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/"/>
    <id>http://bestlixiang.site/2018/12/28/åˆ†å¸ƒå¼/åˆ†å¸ƒå¼äº‹åŠ¡/</id>
    <published>2018-12-28T01:15:43.000Z</published>
    <updated>2018-12-27T11:59:10.751Z</updated>
    
    <content type="html"><![CDATA[<p>ä¼—æ‰€å‘¨çŸ¥ï¼Œäº‹åŠ¡å¯ä»¥ä¿è¯ä¸€ç»„æ“ä½œè¦ä¹ˆå…¨éƒ½æ­£ç¡®æ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ½ä¸æ‰§è¡Œã€‚ç›®å‰çš„æ•°æ®åº“åªèƒ½æ”¯æŒåŒä¸€ä¸ªæ•°æ®åº“ä¸­çš„äº‹åŠ¡ã€‚ä½†ç°åœ¨çš„ç³»ç»Ÿå¾€å¾€é‡‡ç”¨å¾®æœåŠ¡æ¶æ„ï¼Œä¸šåŠ¡ç³»ç»Ÿæ‹¥æœ‰ç‹¬ç«‹çš„æ•°æ®åº“ï¼Œå› æ­¤å°±å‡ºç°äº†è·¨å¤šä¸ªæ•°æ®åº“çš„äº‹åŠ¡éœ€æ±‚ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼äº‹åŠ¡å•¦ï¼<a id="more"></a></p>
<p><img src="https://res.cloudinary.com/cytim/image/upload/v1501433754/simcept/transaction.jpg" alt="tranaction"></p>
<h1 id="ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼äº‹åŠ¡ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼äº‹åŠ¡ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼äº‹åŠ¡ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼äº‹åŠ¡ï¼Ÿ</h1><p>éšç€å¾®æœåŠ¡æ¶æ„çš„æ™®åŠï¼Œä¸€ä¸ªå¤§å‹ä¸šåŠ¡ç³»ç»Ÿå¾€å¾€ç”±è‹¥å¹²ä¸ªå­ç³»ç»Ÿæ„æˆï¼Œè¿™äº›å­ç³»ç»Ÿåˆæ‹¥æœ‰å„è‡ªç‹¬ç«‹çš„æ•°æ®åº“ã€‚å¾€å¾€ä¸€ä¸ªä¸šåŠ¡æµç¨‹éœ€è¦ç”±å¤šä¸ªå­ç³»ç»Ÿå…±åŒå®Œæˆï¼Œè€Œä¸”è¿™äº›æ“ä½œå¯èƒ½éœ€è¦åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­å®Œæˆã€‚åœ¨å¾®æœåŠ¡ç³»ç»Ÿä¸­ï¼Œè¿™äº›ä¸šåŠ¡åœºæ™¯æ˜¯æ™®éå­˜åœ¨çš„ã€‚æ­¤æ—¶ï¼Œæˆ‘ä»¬å°±éœ€è¦åœ¨æ•°æ®åº“ä¹‹ä¸Šé€šè¿‡æŸç§æ‰‹æ®µï¼Œå®ç°æ”¯æŒè·¨æ•°æ®åº“çš„äº‹åŠ¡æ”¯æŒï¼Œè¿™å°±æ˜¯<strong>åˆ†å¸ƒå¼äº‹åŠ¡</strong>ã€‚</p>
<p>æœ€å…¸å‹çš„åˆ†å¸ƒå¼äº‹åŠ¡ä¾‹å­å°±æ˜¯ç”¨æˆ·ä¸‹å•è¿‡ç¨‹ï¼Œæˆ‘ä»¬æŒ‰æœ€ç®€å•çš„æ¥è¯´ï¼Œè‚¯å®šä¼šæœ‰ä¸‹é¢ä¸¤ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>ç”¨æˆ·ä¸‹å•ï¼Œè®¢å•ç³»ç»Ÿä¼šç”Ÿæˆä¸€æ¡è®¢å•</li>
<li>è®¢å•åˆ›å»ºæˆåŠŸåï¼Œæ”¯ä»˜ç³»ç»Ÿè¿›è¡Œæ”¯ä»˜</li>
</ol>
<p>ä¸Šé¢ä¸¤ä¸ªæ­¥éª¤åˆ†åˆ«æ˜¯åœ¨è®¢å•ç³»ç»Ÿå’Œæ”¯ä»˜ç³»ç»Ÿä¸­å®Œæˆã€‚ä»¥å‰æˆ‘ä»¬åœ¨å•æœºè¿è¡Œçš„æƒ…å†µä¸‹å¾ˆå®¹æ˜“å°±è§£å†³ã€‚ä½†æ˜¯åœ¨ç°åœ¨è¿™ä¸ªå¾®æœåŠ¡æ¶æ„ä¸­ï¼Œè¿™ä¸¤ä¸ªæ­¥éª¤æ¶‰åŠä¸¤ä¸ªç³»ç»Ÿï¼Œæ¶‰åŠä¸¤ä¸ªæ•°æ®åº“ï¼Œæ­¤æ—¶æˆ‘ä»¬å¿…é¡»åœ¨æ•°æ®åº“å’Œåº”ç”¨ç³»ç»Ÿä¹‹é—´ï¼Œé€šè¿‡æŸé¡¹æ‰‹æ®µï¼Œå®ç°åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œè¦ä¹ˆå…¨éƒ½æ­£ç¡®æ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ½ä¸æ‰§è¡Œã€‚</p>
<h1 id="åˆ†å¸ƒå¼äº‹åŠ¡åè®®"><a href="#åˆ†å¸ƒå¼äº‹åŠ¡åè®®" class="headerlink" title="åˆ†å¸ƒå¼äº‹åŠ¡åè®®"></a>åˆ†å¸ƒå¼äº‹åŠ¡åè®®</h1><h2 id="ä¸¤é˜¶æ®µæäº¤åè®®-2PC"><a href="#ä¸¤é˜¶æ®µæäº¤åè®®-2PC" class="headerlink" title="ä¸¤é˜¶æ®µæäº¤åè®® 2PC"></a>ä¸¤é˜¶æ®µæäº¤åè®® 2PC</h2><p>åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹è™½ç„¶å¯ä»¥çŸ¥æ™“è‡ªå·±çš„æ“ä½œæ—¶æˆåŠŸæˆ–è€…å¤±è´¥ï¼Œå´æ— æ³•çŸ¥é“å…¶ä»–èŠ‚ç‚¹çš„æ“ä½œçš„æˆåŠŸæˆ–å¤±è´¥ã€‚å½“ä¸€ä¸ªäº‹åŠ¡è·¨è¶Šå¤šä¸ªèŠ‚ç‚¹æ—¶ï¼Œä¸ºäº†ä¿æŒäº‹åŠ¡çš„ACIDç‰¹æ€§ï¼Œéœ€è¦å¼•å…¥ä¸€ä¸ªä½œä¸ºåè°ƒè€…çš„ç»„ä»¶æ¥ç»Ÿä¸€æŒæ§æ‰€æœ‰èŠ‚ç‚¹(ç§°ä½œå‚ä¸è€…)çš„æ“ä½œç»“æœå¹¶æœ€ç»ˆæŒ‡ç¤ºè¿™äº›èŠ‚ç‚¹æ˜¯å¦è¦æŠŠæ“ä½œç»“æœè¿›è¡ŒçœŸæ­£çš„æäº¤(æ¯”å¦‚å°†æ›´æ–°åçš„æ•°æ®å†™å…¥ç£ç›˜ç­‰ç­‰)ã€‚å› æ­¤ï¼ŒäºŒé˜¶æ®µæäº¤çš„ç®—æ³•æ€è·¯å¯ä»¥æ¦‚æ‹¬ä¸ºï¼šå‚ä¸è€…å°†æ“ä½œæˆè´¥é€šçŸ¥åè°ƒè€…ï¼Œå†ç”±åè°ƒè€…æ ¹æ®æ‰€æœ‰å‚ä¸è€…çš„åé¦ˆæƒ…æŠ¥å†³å®šå„å‚ä¸è€…æ˜¯å¦è¦æäº¤æ“ä½œè¿˜æ˜¯ä¸­æ­¢æ“ä½œã€‚</p>
<h3 id="ä¸¤é˜¶æ®µ"><a href="#ä¸¤é˜¶æ®µ" class="headerlink" title="ä¸¤é˜¶æ®µ"></a>ä¸¤é˜¶æ®µ</h3><h4 id="å‡†å¤‡é˜¶æ®µï¼ˆæŠ•ç¥¨é˜¶æ®µï¼‰"><a href="#å‡†å¤‡é˜¶æ®µï¼ˆæŠ•ç¥¨é˜¶æ®µï¼‰" class="headerlink" title="å‡†å¤‡é˜¶æ®µï¼ˆæŠ•ç¥¨é˜¶æ®µï¼‰"></a>å‡†å¤‡é˜¶æ®µï¼ˆæŠ•ç¥¨é˜¶æ®µï¼‰</h4><p>äº‹åŠ¡åè°ƒè€…(äº‹åŠ¡ç®¡ç†å™¨)ç»™æ¯ä¸ªå‚ä¸è€…(èµ„æºç®¡ç†å™¨)å‘é€Prepareæ¶ˆæ¯ï¼Œæ¯ä¸ªå‚ä¸è€…è¦ä¹ˆç›´æ¥è¿”å›å¤±è´¥(å¦‚æƒé™éªŒè¯å¤±è´¥)ï¼Œè¦ä¹ˆåœ¨æœ¬åœ°æ‰§è¡Œäº‹åŠ¡ï¼Œå†™æœ¬åœ°çš„redoå’Œundoæ—¥å¿—ï¼Œä½†ä¸æäº¤ï¼Œåˆ°è¾¾ä¸€ç§â€œä¸‡äº‹ä¿±å¤‡ï¼Œåªæ¬ ä¸œé£â€çš„çŠ¶æ€ã€‚</p>
<h4 id="æäº¤é˜¶æ®µï¼ˆæ‰§è¡Œé˜¶æ®µï¼‰"><a href="#æäº¤é˜¶æ®µï¼ˆæ‰§è¡Œé˜¶æ®µï¼‰" class="headerlink" title="æäº¤é˜¶æ®µï¼ˆæ‰§è¡Œé˜¶æ®µï¼‰"></a>æäº¤é˜¶æ®µï¼ˆæ‰§è¡Œé˜¶æ®µï¼‰</h4><p>å¦‚æœåè°ƒè€…æ”¶åˆ°äº†å‚ä¸è€…çš„å¤±è´¥æ¶ˆæ¯æˆ–è€…è¶…æ—¶ï¼Œç›´æ¥ç»™æ¯ä¸ªå‚ä¸è€…å‘é€å›æ»š(Rollback)æ¶ˆæ¯ï¼›å¦åˆ™ï¼Œå‘é€æäº¤(Commit)æ¶ˆæ¯ï¼›å‚ä¸è€…æ ¹æ®åè°ƒè€…çš„æŒ‡ä»¤æ‰§è¡Œæäº¤æˆ–è€…å›æ»šæ“ä½œï¼Œé‡Šæ”¾æ‰€æœ‰äº‹åŠ¡å¤„ç†è¿‡ç¨‹ä¸­ä½¿ç”¨çš„é”èµ„æºã€‚(æ³¨æ„:å¿…é¡»åœ¨æœ€åé˜¶æ®µé‡Šæ”¾é”èµ„æº)</p>
<h3 id="ç¼ºç‚¹"><a href="#ç¼ºç‚¹" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h3><ol>
<li>åŒæ­¥é˜»å¡é—®é¢˜ã€‚æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæ‰€æœ‰å‚ä¸èŠ‚ç‚¹éƒ½æ˜¯äº‹åŠ¡é˜»å¡å‹çš„ã€‚å½“å‚ä¸è€…å æœ‰å…¬å…±èµ„æºæ—¶ï¼Œå…¶ä»–ç¬¬ä¸‰æ–¹èŠ‚ç‚¹è®¿é—®å…¬å…±èµ„æºä¸å¾—ä¸å¤„äºé˜»å¡çŠ¶æ€ã€‚</li>
<li>å•ç‚¹æ•…éšœã€‚ç”±äºåè°ƒè€…çš„é‡è¦æ€§ï¼Œä¸€æ—¦åè°ƒè€…å‘ç”Ÿæ•…éšœã€‚å‚ä¸è€…ä¼šä¸€ç›´é˜»å¡ä¸‹å»ã€‚å°¤å…¶åœ¨ç¬¬äºŒé˜¶æ®µï¼Œåè°ƒè€…å‘ç”Ÿæ•…éšœï¼Œé‚£ä¹ˆæ‰€æœ‰çš„å‚ä¸è€…è¿˜éƒ½å¤„äºé”å®šäº‹åŠ¡èµ„æºçš„çŠ¶æ€ä¸­ï¼Œè€Œæ— æ³•ç»§ç»­å®Œæˆäº‹åŠ¡æ“ä½œã€‚ï¼ˆå¦‚æœæ˜¯åè°ƒè€…æŒ‚æ‰ï¼Œå¯ä»¥é‡æ–°é€‰ä¸¾ä¸€ä¸ªåè°ƒè€…ï¼Œä½†æ˜¯æ— æ³•è§£å†³å› ä¸ºåè°ƒè€…å®•æœºå¯¼è‡´çš„å‚ä¸è€…å¤„äºé˜»å¡çŠ¶æ€çš„é—®é¢˜ï¼‰</li>
<li>æ•°æ®ä¸ä¸€è‡´ã€‚åœ¨äºŒé˜¶æ®µæäº¤çš„é˜¶æ®µäºŒä¸­ï¼Œå½“åè°ƒè€…å‘å‚ä¸è€…å‘é€commitè¯·æ±‚ä¹‹åï¼Œå‘ç”Ÿäº†å±€éƒ¨ç½‘ç»œå¼‚å¸¸æˆ–è€…åœ¨å‘é€commitè¯·æ±‚è¿‡ç¨‹ä¸­åè°ƒè€…å‘ç”Ÿäº†æ•…éšœï¼Œè¿™å›å¯¼è‡´åªæœ‰ä¸€éƒ¨åˆ†å‚ä¸è€…æ¥å—åˆ°äº†commitè¯·æ±‚ã€‚è€Œåœ¨è¿™éƒ¨åˆ†å‚ä¸è€…æ¥åˆ°commitè¯·æ±‚ä¹‹åå°±ä¼šæ‰§è¡Œcommitæ“ä½œã€‚ä½†æ˜¯å…¶ä»–éƒ¨åˆ†æœªæ¥åˆ°commitè¯·æ±‚çš„æœºå™¨åˆ™æ— æ³•æ‰§è¡Œäº‹åŠ¡æäº¤ã€‚äºæ˜¯æ•´ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¾¿å‡ºç°äº†æ•°æ®éƒ¨ä¸€è‡´æ€§çš„ç°è±¡ã€‚</li>
<li>äºŒé˜¶æ®µæ— æ³•è§£å†³çš„é—®é¢˜ï¼šåè°ƒè€…å†å‘å‡ºcommitæ¶ˆæ¯ä¹‹åå®•æœºï¼Œè€Œå”¯ä¸€æ¥æ”¶åˆ°è¿™æ¡æ¶ˆæ¯çš„å‚ä¸è€…åŒæ—¶ä¹Ÿå®•æœºäº†ã€‚é‚£ä¹ˆå³ä½¿åè°ƒè€…é€šè¿‡é€‰ä¸¾</li>
</ol>
<p>ç”±äºäºŒé˜¶æ®µæäº¤å­˜åœ¨ç€è¯¸å¦‚åŒæ­¥é˜»å¡ã€å•ç‚¹é—®é¢˜ã€è„‘è£‚ç­‰ç¼ºé™·ï¼Œæ‰€ä»¥ï¼Œç ”ç©¶è€…ä»¬åœ¨äºŒé˜¶æ®µæäº¤çš„åŸºç¡€ä¸Šåšäº†æ”¹è¿›ï¼Œæå‡ºäº†ä¸‰é˜¶æ®µæäº¤ã€‚</p>
<h2 id="ä¸‰é˜¶æ®µæäº¤åè®®-3PC"><a href="#ä¸‰é˜¶æ®µæäº¤åè®®-3PC" class="headerlink" title="ä¸‰é˜¶æ®µæäº¤åè®® 3PC"></a>ä¸‰é˜¶æ®µæäº¤åè®® 3PC</h2><p>ä¸ä¸¤é˜¶æ®µæäº¤ä¸åŒçš„æ˜¯ï¼Œä¸‰é˜¶æ®µæäº¤æœ‰ä¸¤ä¸ªæ”¹åŠ¨ç‚¹ï¼š</p>
<ol>
<li>å¼•å…¥è¶…æ—¶æœºåˆ¶ã€‚åŒæ—¶åœ¨åè°ƒè€…å’Œå‚ä¸è€…ä¸­éƒ½å¼•å…¥è¶…æ—¶æœºåˆ¶ã€‚</li>
<li>åœ¨ç¬¬ä¸€é˜¶æ®µå’Œç¬¬äºŒé˜¶æ®µä¸­æ’å…¥ä¸€ä¸ªå‡†å¤‡é˜¶æ®µã€‚ä¿è¯äº†åœ¨æœ€åæäº¤é˜¶æ®µä¹‹å‰å„å‚ä¸èŠ‚ç‚¹çš„çŠ¶æ€æ˜¯ä¸€è‡´çš„ã€‚</li>
</ol>
<h3 id="ä¸‰é˜¶æ®µ"><a href="#ä¸‰é˜¶æ®µ" class="headerlink" title="ä¸‰é˜¶æ®µ"></a>ä¸‰é˜¶æ®µ</h3><h4 id="CanCommité˜¶æ®µ"><a href="#CanCommité˜¶æ®µ" class="headerlink" title="CanCommité˜¶æ®µ"></a>CanCommité˜¶æ®µ</h4><ol>
<li>äº‹åŠ¡è¯¢é—® åè°ƒè€…å‘å‚ä¸è€…å‘é€CanCommitè¯·æ±‚ã€‚è¯¢é—®æ˜¯å¦å¯ä»¥æ‰§è¡Œäº‹åŠ¡æäº¤æ“ä½œã€‚ç„¶åå¼€å§‹ç­‰å¾…å‚ä¸è€…çš„å“åº”ã€‚</li>
<li>å“åº”åé¦ˆ å‚ä¸è€…æ¥åˆ°CanCommitè¯·æ±‚ä¹‹åï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼Œå¦‚æœå…¶è‡ªèº«è®¤ä¸ºå¯ä»¥é¡ºåˆ©æ‰§è¡Œäº‹åŠ¡ï¼Œåˆ™è¿”å›Yeså“åº”ï¼Œå¹¶è¿›å…¥é¢„å¤‡çŠ¶æ€ã€‚å¦åˆ™åé¦ˆNo</li>
</ol>
<h4 id="PreCommité˜¶æ®µ"><a href="#PreCommité˜¶æ®µ" class="headerlink" title="PreCommité˜¶æ®µ"></a>PreCommité˜¶æ®µ</h4><p>ä¸¤ç§æƒ…å†µï¼š<br><strong>å‡å¦‚åè°ƒè€…ä»æ‰€æœ‰çš„å‚ä¸è€…è·å¾—çš„åé¦ˆéƒ½æ˜¯Yeså“åº”ï¼š</strong></p>
<ol>
<li>å‘é€é¢„æäº¤è¯·æ±‚ åè°ƒè€…å‘å‚ä¸è€…å‘é€PreCommitè¯·æ±‚ï¼Œå¹¶è¿›å…¥Preparedé˜¶æ®µã€‚</li>
<li>äº‹åŠ¡é¢„æäº¤ å‚ä¸è€…æ¥æ”¶åˆ°PreCommitè¯·æ±‚åï¼Œä¼šæ‰§è¡Œäº‹åŠ¡æ“ä½œï¼Œå¹¶å°†undoå’Œredoä¿¡æ¯è®°å½•åˆ°äº‹åŠ¡æ—¥å¿—ä¸­ã€‚</li>
<li>å“åº”åé¦ˆ å¦‚æœå‚ä¸è€…æˆåŠŸçš„æ‰§è¡Œäº†äº‹åŠ¡æ“ä½œï¼Œåˆ™è¿”å›ACKå“åº”ï¼ŒåŒæ—¶å¼€å§‹ç­‰å¾…æœ€ç»ˆæŒ‡ä»¤ã€‚</li>
</ol>
<p><strong>å‡å¦‚æœ‰ä»»ä½•ä¸€ä¸ªå‚ä¸è€…å‘åè°ƒè€…å‘é€äº†Noå“åº”ï¼Œæˆ–è€…ç­‰å¾…è¶…æ—¶ä¹‹åï¼š</strong></p>
<ol>
<li>å‘é€ä¸­æ–­è¯·æ±‚ åè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘é€abortè¯·æ±‚ã€‚</li>
<li>ä¸­æ–­äº‹åŠ¡ å‚ä¸è€…æ”¶åˆ°æ¥è‡ªåè°ƒè€…çš„abortè¯·æ±‚ä¹‹åï¼ˆæˆ–è¶…æ—¶ä¹‹åï¼Œä»æœªæ”¶åˆ°åè°ƒè€…çš„è¯·æ±‚ï¼‰ï¼Œæ‰§è¡Œäº‹åŠ¡çš„ä¸­æ–­ã€‚</li>
</ol>
<h4 id="doCommité˜¶æ®µ"><a href="#doCommité˜¶æ®µ" class="headerlink" title="doCommité˜¶æ®µ"></a>doCommité˜¶æ®µ</h4><p>ä¸¤ç§æƒ…å†µï¼š<br><strong>åè°ƒè€…æ¥æ”¶åˆ°å‚ä¸è€…å‘é€çš„ACKå“åº”ï¼š</strong></p>
<ol>
<li>å‘é€æäº¤è¯·æ±‚ åè°ƒæ¥æ”¶åˆ°å‚ä¸è€…å‘é€çš„ACKå“åº”ï¼Œé‚£ä¹ˆä»–å°†ä»é¢„æäº¤çŠ¶æ€è¿›å…¥åˆ°æäº¤çŠ¶æ€ã€‚å¹¶å‘æ‰€æœ‰å‚ä¸è€…å‘é€doCommitè¯·æ±‚ã€‚</li>
<li>äº‹åŠ¡æäº¤ å‚ä¸è€…æ¥æ”¶åˆ°doCommitè¯·æ±‚ä¹‹åï¼Œæ‰§è¡Œæ­£å¼çš„äº‹åŠ¡æäº¤ã€‚å¹¶åœ¨å®Œæˆäº‹åŠ¡æäº¤ä¹‹åé‡Šæ”¾æ‰€æœ‰äº‹åŠ¡èµ„æºã€‚</li>
<li>å“åº”åé¦ˆ äº‹åŠ¡æäº¤å®Œä¹‹åï¼Œå‘åè°ƒè€…å‘é€Ackå“åº”ã€‚</li>
<li>å®Œæˆäº‹åŠ¡ åè°ƒè€…æ¥æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…çš„ackå“åº”ä¹‹åï¼Œå®Œæˆäº‹åŠ¡ã€‚</li>
</ol>
<p><strong>åè°ƒè€…æ²¡æœ‰æ¥æ”¶åˆ°å‚ä¸è€…å‘é€çš„ACKå“åº”ï¼Œæˆ–è€…å“åº”è¶…æ—¶ï¼š</strong></p>
<ol>
<li>å‘é€ä¸­æ–­è¯·æ±‚ åè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘é€abortè¯·æ±‚</li>
<li>äº‹åŠ¡å›æ»š å‚ä¸è€…æ¥æ”¶åˆ°abortè¯·æ±‚ä¹‹åï¼Œåˆ©ç”¨å…¶åœ¨é˜¶æ®µäºŒè®°å½•çš„undoä¿¡æ¯æ¥æ‰§è¡Œäº‹åŠ¡çš„å›æ»šæ“ä½œï¼Œå¹¶åœ¨å®Œæˆå›æ»šä¹‹åé‡Šæ”¾æ‰€æœ‰çš„äº‹åŠ¡èµ„æºã€‚</li>
<li>åé¦ˆç»“æœ å‚ä¸è€…å®Œæˆäº‹åŠ¡å›æ»šä¹‹åï¼Œå‘åè°ƒè€…å‘é€ACKæ¶ˆæ¯</li>
<li>ä¸­æ–­äº‹åŠ¡ åè°ƒè€…æ¥æ”¶åˆ°å‚ä¸è€…åé¦ˆçš„ACKæ¶ˆæ¯ä¹‹åï¼Œæ‰§è¡Œäº‹åŠ¡çš„ä¸­æ–­ã€‚</li>
</ol>
<h2 id="2PCä¸3PCçš„åŒºåˆ«"><a href="#2PCä¸3PCçš„åŒºåˆ«" class="headerlink" title="2PCä¸3PCçš„åŒºåˆ«"></a>2PCä¸3PCçš„åŒºåˆ«</h2><p>ç›¸å¯¹äº2PCï¼Œ3PCä¸»è¦è§£å†³çš„å•ç‚¹æ•…éšœé—®é¢˜ï¼Œå¹¶å‡å°‘é˜»å¡ï¼Œ<strong>å› ä¸ºä¸€æ—¦å‚ä¸è€…æ— æ³•åŠæ—¶æ”¶åˆ°æ¥è‡ªåè°ƒè€…çš„ä¿¡æ¯ä¹‹åï¼Œä»–ä¼šé»˜è®¤æ‰§è¡Œcommitã€‚</strong> è€Œä¸ä¼šä¸€ç›´æŒæœ‰äº‹åŠ¡èµ„æºå¹¶å¤„äºé˜»å¡çŠ¶æ€ã€‚ä½†æ˜¯è¿™ç§æœºåˆ¶ä¹Ÿä¼šå¯¼è‡´æ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼Œå› ä¸ºï¼Œç”±äºç½‘ç»œåŸå› ï¼Œåè°ƒè€…å‘é€çš„abortå“åº”æ²¡æœ‰åŠæ—¶è¢«å‚ä¸è€…æ¥æ”¶åˆ°ï¼Œé‚£ä¹ˆå‚ä¸è€…åœ¨ç­‰å¾…è¶…æ—¶ä¹‹åæ‰§è¡Œäº†commitæ“ä½œã€‚è¿™æ ·å°±å’Œå…¶ä»–æ¥åˆ°abortå‘½ä»¤å¹¶æ‰§è¡Œå›æ»šçš„å‚ä¸è€…ä¹‹é—´å­˜åœ¨æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µã€‚</p>
<h1 id="åˆ†å¸ƒå¼è§£å†³æ–¹æ¡ˆ"><a href="#åˆ†å¸ƒå¼è§£å†³æ–¹æ¡ˆ" class="headerlink" title="åˆ†å¸ƒå¼è§£å†³æ–¹æ¡ˆ"></a>åˆ†å¸ƒå¼è§£å†³æ–¹æ¡ˆ</h1><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å½“ä½ è§‰å¾—ä½ çš„ç³»ç»Ÿä¸­ä½¿ç”¨<strong>åˆ†å¸ƒå¼äº‹åŠ¡</strong>çš„æ—¶å€™ï¼Œ<strong>ä½ ä¸€å®šè¦é—®é—®è‡ªå·±çœŸçš„éœ€è¦å—</strong>?å¾ˆå¤šæ—¶å€™æˆ‘ä»¬å¹¶ä¸éœ€è¦ï¼Œä¹Ÿè®¸æˆ‘ä»¬åªè¦å°†ä¸¤ä¸ªå¾®æœåŠ¡èšåˆæˆä¸€ä¸ªå•æœºæœåŠ¡ï¼Œä»è€Œå¯ä»¥ä½¿ç”¨æ•°æ®åº“çš„æœ¬åœ°äº‹åŠ¡ã€‚<strong>å› ä¸ºä½ åªè¦ä½¿ç”¨äº†åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œå¿…ç„¶ä¼šå¢åŠ ç³»ç»Ÿçš„å¤æ‚åº¦ã€‚</strong> å½“ç„¶æœ‰æ—¶å€™æˆ‘ä»¬æ˜¯çœŸçš„éœ€è¦ï¼Œä¸‹é¢æˆ‘ä»¬ä»‹ç»å‡ ç§å¸¸è§çš„æ–¹æ¡ˆï¼</p>
<h2 id="åŸºäºXAçš„åˆ†å¸ƒå¼äº‹åŠ¡"><a href="#åŸºäºXAçš„åˆ†å¸ƒå¼äº‹åŠ¡" class="headerlink" title="åŸºäºXAçš„åˆ†å¸ƒå¼äº‹åŠ¡"></a>åŸºäºXAçš„åˆ†å¸ƒå¼äº‹åŠ¡</h2><p><img src="https://pic1.zhimg.com/80/v2-1eb94800ac7dbaa86f103dc9bc7f93a8_hd.jpg" alt="xa"></p>
<p>åŸºäºXAçš„åˆ†å¸ƒå¼äº‹åŠ¡å…¶å®å°±æ˜¯2PCåè®®çš„å®ç°ã€‚æ‰€ä»¥å®ƒæ¯”è¾ƒç®€å•ï¼Œæˆæœ¬è¾ƒä½ï¼Œä½†æ˜¯å…¶å•ç‚¹é—®é¢˜ï¼Œä»¥åŠä¸èƒ½æ”¯æŒé«˜å¹¶å‘(ç”±äºåŒæ­¥é˜»å¡)ä¾ç„¶æ˜¯å…¶æœ€å¤§çš„å¼±ç‚¹ã€‚ä½†æ˜¯Mysqlã€Oracleéƒ½åœ¨ä½¿ç”¨è¿™ç§æ–¹æ¡ˆã€‚</p>
<h2 id="åŸºäºæ¶ˆæ¯çš„æœ€ç»ˆä¸€è‡´æ€§æ–¹æ¡ˆ"><a href="#åŸºäºæ¶ˆæ¯çš„æœ€ç»ˆä¸€è‡´æ€§æ–¹æ¡ˆ" class="headerlink" title="åŸºäºæ¶ˆæ¯çš„æœ€ç»ˆä¸€è‡´æ€§æ–¹æ¡ˆ"></a>åŸºäºæ¶ˆæ¯çš„æœ€ç»ˆä¸€è‡´æ€§æ–¹æ¡ˆ</h2><p>è¿™ç§å®ç°åˆ†å¸ƒå¼äº‹åŠ¡çš„æ–¹å¼éœ€è¦é€šè¿‡æ¶ˆæ¯ä¸­é—´ä»¶æ¥å®ç°ã€‚å‡è®¾æœ‰Aå’ŒBä¸¤ä¸ªç³»ç»Ÿï¼Œåˆ†åˆ«å¯ä»¥å¤„ç†ä»»åŠ¡Aå’Œä»»åŠ¡Bã€‚æ­¤æ—¶ç³»ç»ŸAä¸­å­˜åœ¨ä¸€ä¸ªä¸šåŠ¡æµç¨‹ï¼Œéœ€è¦å°†ä»»åŠ¡Aå’Œä»»åŠ¡Båœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­å¤„ç†ã€‚ä¸‹é¢æ¥ä»‹ç»åŸºäºæ¶ˆæ¯ä¸­é—´ä»¶æ¥å®ç°è¿™ç§åˆ†å¸ƒå¼äº‹åŠ¡ã€‚</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/3/10/1620fc30782107d1?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="message-commit"></p>
<ol>
<li>åœ¨ç³»ç»ŸAå¤„ç†ä»»åŠ¡Aå‰ï¼Œé¦–å…ˆå‘æ¶ˆæ¯ä¸­é—´ä»¶å‘é€ä¸€æ¡æ¶ˆæ¯</li>
<li>æ¶ˆæ¯ä¸­é—´ä»¶æ”¶åˆ°åå°†è¯¥æ¡æ¶ˆæ¯æŒä¹…åŒ–ï¼Œä½†å¹¶ä¸æŠ•é€’ã€‚æ­¤æ—¶ä¸‹æ¸¸ç³»ç»ŸBä»ç„¶ä¸çŸ¥é“è¯¥æ¡æ¶ˆæ¯çš„å­˜åœ¨ã€‚</li>
<li>æ¶ˆæ¯ä¸­é—´ä»¶æŒä¹…åŒ–æˆåŠŸåï¼Œä¾¿å‘ç³»ç»ŸAè¿”å›ä¸€ä¸ªç¡®è®¤åº”ç­”ï¼›</li>
<li>ç³»ç»ŸAæ”¶åˆ°ç¡®è®¤åº”ç­”åï¼Œåˆ™å¯ä»¥å¼€å§‹å¤„ç†ä»»åŠ¡Aï¼›</li>
<li>ä»»åŠ¡Aå¤„ç†å®Œæˆåï¼Œå‘æ¶ˆæ¯ä¸­é—´ä»¶å‘é€Commitè¯·æ±‚ã€‚è¯¥è¯·æ±‚å‘é€å®Œæˆåï¼Œå¯¹ç³»ç»ŸAè€Œè¨€ï¼Œè¯¥äº‹åŠ¡çš„å¤„ç†è¿‡ç¨‹å°±ç»“æŸäº†ï¼Œæ­¤æ—¶å®ƒå¯ä»¥å¤„ç†åˆ«çš„ä»»åŠ¡äº†ã€‚</li>
<li>ä½†commitæ¶ˆæ¯å¯èƒ½ä¼šåœ¨ä¼ è¾“é€”ä¸­ä¸¢å¤±ï¼Œä»è€Œæ¶ˆæ¯ä¸­é—´ä»¶å¹¶ä¸ä¼šå‘ç³»ç»ŸBæŠ•é€’è¿™æ¡æ¶ˆæ¯ï¼Œä»è€Œç³»ç»Ÿå°±ä¼šå‡ºç°ä¸ä¸€è‡´æ€§ã€‚è¿™ä¸ªé—®é¢˜ç”±æ¶ˆæ¯ä¸­é—´ä»¶çš„äº‹åŠ¡å›æŸ¥æœºåˆ¶å®Œæˆï¼Œä¸‹æ–‡ä¼šä»‹ç»ã€‚</li>
<li>æ¶ˆæ¯ä¸­é—´ä»¶æ”¶åˆ°CommitæŒ‡ä»¤åï¼Œä¾¿å‘ç³»ç»ŸBæŠ•é€’è¯¥æ¶ˆæ¯ï¼Œä»è€Œè§¦å‘ä»»åŠ¡Bçš„æ‰§è¡Œï¼›</li>
<li>å½“ä»»åŠ¡Bæ‰§è¡Œå®Œæˆåï¼Œç³»ç»ŸBå‘æ¶ˆæ¯ä¸­é—´ä»¶è¿”å›ä¸€ä¸ªç¡®è®¤åº”ç­”ï¼Œå‘Šè¯‰æ¶ˆæ¯ä¸­é—´ä»¶è¯¥æ¶ˆæ¯å·²ç»æˆåŠŸæ¶ˆè´¹ï¼Œæ­¤æ—¶ï¼Œè¿™ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡å®Œæˆã€‚</li>
</ol>
<p>ä»ä¸Šé¢çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼š</p>
<ol>
<li>æ¶ˆæ¯ä¸­é—´ä»¶æ‰®æ¼”è€…åˆ†å¸ƒå¼äº‹åŠ¡åè°ƒè€…çš„è§’è‰²ã€‚</li>
<li>ç³»ç»ŸAå®Œæˆä»»åŠ¡Aåï¼Œåˆ°ä»»åŠ¡Bæ‰§è¡Œå®Œæˆä¹‹é—´ï¼Œä¼šå­˜åœ¨ä¸€å®šçš„æ—¶é—´å·®ã€‚åœ¨è¿™ä¸ªæ—¶é—´å·®å†…ï¼Œæ•´ä¸ªç³»ç»Ÿå¤„äºæ•°æ®ä¸ä¸€è‡´çš„çŠ¶æ€ï¼Œä½†è¿™çŸ­æš‚çš„ä¸ä¸€è‡´æ€§æ˜¯å¯ä»¥æ¥å—çš„ï¼Œå› ä¸ºç»è¿‡çŸ­æš‚çš„æ—¶é—´åï¼Œç³»ç»Ÿåˆå¯ä»¥ä¿æŒæ•°æ®ä¸€è‡´æ€§ï¼Œ<strong>æ»¡è¶³BASEç†è®º</strong>ã€‚</li>
</ol>
<p>ä¸Šè¿°è¿‡ç¨‹ä¸­ï¼Œå¦‚æœä»»åŠ¡Aå¤„ç†å¤±è´¥ï¼Œé‚£ä¹ˆéœ€è¦è¿›å…¥å›æ»šæµç¨‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="https://user-gold-cdn.xitu.io/2018/3/10/1620fc307be6c55d?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="message-a-rollback"></p>
<ol>
<li>è‹¥ç³»ç»ŸAåœ¨å¤„ç†ä»»åŠ¡Aæ—¶å¤±è´¥ï¼Œé‚£ä¹ˆå°±ä¼šå‘æ¶ˆæ¯ä¸­é—´ä»¶å‘é€Rollbackè¯·æ±‚ã€‚å’Œå‘é€Commitè¯·æ±‚ä¸€æ ·ï¼Œç³»ç»ŸAå‘å®Œä¹‹åä¾¿å¯ä»¥è®¤ä¸ºå›æ»šå·²ç»å®Œæˆï¼Œå®ƒä¾¿å¯ä»¥å»åšå…¶ä»–çš„äº‹æƒ…ã€‚</li>
<li>æ¶ˆæ¯ä¸­é—´ä»¶æ”¶åˆ°å›æ»šè¯·æ±‚åï¼Œç›´æ¥å°†è¯¥æ¶ˆæ¯ä¸¢å¼ƒï¼Œè€Œä¸æŠ•é€’ç»™ç³»ç»ŸBï¼Œä»è€Œä¸ä¼šè§¦å‘ç³»ç»ŸBçš„ä»»åŠ¡Bã€‚</li>
</ol>
<p>ä¸Šé¢æ‰€ä»‹ç»çš„Commitå’ŒRollbackéƒ½å±äºç†æƒ³æƒ…å†µï¼Œä½†åœ¨å®é™…ç³»ç»Ÿä¸­ï¼ŒCommitå’ŒRollbackæŒ‡ä»¤éƒ½æœ‰å¯èƒ½åœ¨ä¼ è¾“é€”ä¸­ä¸¢å¤±ã€‚é‚£ä¹ˆå½“å‡ºç°è¿™ç§æƒ…å†µçš„æ—¶å€™ï¼Œæ¶ˆæ¯ä¸­é—´ä»¶æ˜¯å¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§å‘¢ï¼Ÿâ€”â€”ç­”æ¡ˆå°±æ˜¯è¶…æ—¶è¯¢é—®æœºåˆ¶ã€‚<br><img src="https://user-gold-cdn.xitu.io/2018/3/10/1620fc307c2d185e?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="message-b-rollback"></p>
<p>æ‰€ä»¥ç³»ç»ŸAé™¤äº†å®ç°æ­£å¸¸çš„ä¸šåŠ¡æµç¨‹å¤–ï¼Œè¿˜éœ€æä¾›ä¸€ä¸ªäº‹åŠ¡è¯¢é—®çš„æ¥å£ï¼Œä¾›æ¶ˆæ¯ä¸­é—´ä»¶è°ƒç”¨ã€‚å½“æ¶ˆæ¯ä¸­é—´ä»¶æ”¶åˆ°ä¸€æ¡äº‹åŠ¡å‹æ¶ˆæ¯åä¾¿å¼€å§‹è®¡æ—¶ï¼Œå¦‚æœåˆ°äº†è¶…æ—¶æ—¶é—´ä¹Ÿæ²¡æ”¶åˆ°ç³»ç»ŸAå‘æ¥çš„Commitæˆ–RollbackæŒ‡ä»¤çš„è¯ï¼Œå°±ä¼šä¸»åŠ¨è°ƒç”¨ç³»ç»ŸAæä¾›çš„äº‹åŠ¡è¯¢é—®æ¥å£è¯¢é—®è¯¥ç³»ç»Ÿç›®å‰çš„çŠ¶æ€ã€‚è¯¥æ¥å£ä¼šè¿”å›ä¸‰ç§ç»“æœï¼š</p>
<ul>
<li>æäº¤ è‹¥è·å¾—çš„çŠ¶æ€æ˜¯â€œæäº¤â€ï¼Œåˆ™å°†è¯¥æ¶ˆæ¯æŠ•é€’ç»™ç³»ç»ŸBã€‚</li>
<li>å›æ»š è‹¥è·å¾—çš„çŠ¶æ€æ˜¯â€œå›æ»šâ€ï¼Œåˆ™ç›´æ¥å°†æ¡æ¶ˆæ¯ä¸¢å¼ƒã€‚</li>
<li>å¤„ç†ä¸­ è‹¥è·å¾—çš„çŠ¶æ€æ˜¯â€œå¤„ç†ä¸­â€ï¼Œåˆ™ç»§ç»­ç­‰å¾…ã€‚</li>
</ul>
<p>ä¸Šæ¸¸çš„çš„æ¶ˆæ¯æŠ•é€’ä¿è¯äº†ï¼Œé‚£ä¹ˆä¸‹æ¸¸çš„æ¶ˆæ¯æŠ•é€’çš„å¯é æ€§ä¿è¯æ€ä¹ˆè§£å†³å‘¢ï¼Ÿ</p>
<p>å½“ä¸Šæ¸¸ç³»ç»Ÿæ‰§è¡Œå®Œä»»åŠ¡å¹¶å‘æ¶ˆæ¯ä¸­é—´ä»¶æäº¤äº†CommitæŒ‡ä»¤åï¼Œä¾¿å¯ä»¥å¤„ç†å…¶ä»–ä»»åŠ¡äº†ï¼Œæ­¤æ—¶å®ƒå¯ä»¥è®¤ä¸ºäº‹åŠ¡å·²ç»å®Œæˆï¼Œæ¥ä¸‹æ¥æ¶ˆæ¯ä¸­é—´ä»¶<strong>ä¸€å®šä¼šä¿è¯æ¶ˆæ¯è¢«ä¸‹æ¸¸ç³»ç»ŸæˆåŠŸæ¶ˆè´¹æ‰ï¼</strong>é‚£ä¹ˆè¿™æ˜¯æ€ä¹ˆåšåˆ°çš„å‘¢ï¼Ÿè¿™ç”±æ¶ˆæ¯ä¸­é—´ä»¶çš„æŠ•é€’æµç¨‹æ¥ä¿è¯ã€‚<br>æ¶ˆæ¯ä¸­é—´ä»¶å‘ä¸‹æ¸¸ç³»ç»ŸæŠ•é€’å®Œæ¶ˆæ¯åä¾¿è¿›å…¥é˜»å¡ç­‰å¾…çŠ¶æ€ï¼Œä¸‹æ¸¸ç³»ç»Ÿä¾¿ç«‹å³è¿›è¡Œä»»åŠ¡çš„å¤„ç†ï¼Œä»»åŠ¡å¤„ç†å®Œæˆåä¾¿å‘æ¶ˆæ¯ä¸­é—´ä»¶è¿”å›åº”ç­”ã€‚æ¶ˆæ¯ä¸­é—´ä»¶æ”¶åˆ°ç¡®è®¤åº”ç­”åä¾¿è®¤ä¸ºè¯¥äº‹åŠ¡å¤„ç†å®Œæ¯•ï¼<br>å¦‚æœæ¶ˆæ¯åœ¨æŠ•é€’è¿‡ç¨‹ä¸­ä¸¢å¤±ï¼Œæˆ–æ¶ˆæ¯çš„ç¡®è®¤åº”ç­”åœ¨è¿”å›é€”ä¸­ä¸¢å¤±ï¼Œé‚£ä¹ˆæ¶ˆæ¯ä¸­é—´ä»¶åœ¨ç­‰å¾…ç¡®è®¤åº”ç­”è¶…æ—¶ä¹‹åå°±ä¼šé‡æ–°æŠ•é€’ï¼Œç›´åˆ°ä¸‹æ¸¸æ¶ˆè´¹è€…è¿”å›æ¶ˆè´¹æˆåŠŸå“åº”ä¸ºæ­¢ã€‚å½“ç„¶ï¼Œä¸€èˆ¬æ¶ˆæ¯ä¸­é—´ä»¶å¯ä»¥è®¾ç½®æ¶ˆæ¯é‡è¯•çš„æ¬¡æ•°å’Œæ—¶é—´é—´éš”ï¼Œå¦‚æœé‡è¯•å¤šæ¬¡ä¹‹åä»ç„¶æŠ•é€’å¤±è´¥ï¼Œé‚£ä¹ˆè¿™æ¡æ¶ˆæ¯å°±éœ€è¦äººå·¥å¹²é¢„ã€‚<br><img src="https://user-gold-cdn.xitu.io/2018/3/10/1620fc3078194980?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="message-0-rollback"><br><img src="https://user-gold-cdn.xitu.io/2018/3/10/1620fc308ece8d2a?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="message-1-rollback"></p>
<p>å¦‚æœæ¶ˆè´¹è¶…æ—¶ï¼Œåˆ™éœ€è¦ä¸€ç›´é‡è¯•ï¼Œè¿™é‡Œå°±ä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜ï¼š<strong>æ¶ˆæ¯æ¥æ”¶ç«¯éœ€è¦ä¿è¯å¹‚ç­‰</strong>ã€‚è¿™åˆæ˜¯å¦å¤–ä¸€ä¸ªé—®é¢˜ï¼Œæ¯”å¦‚ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶ã€‚</p>
<p>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œä¸Šæ¸¸ç³»ç»ŸAå‘æ¶ˆæ¯ä¸­é—´ä»¶æäº¤Commit/Rollbackæ¶ˆæ¯é‡‡ç”¨çš„æ˜¯å¼‚æ­¥æ–¹å¼ï¼Œæ¶ˆæ¯ä¸­é—´ä»¶å’Œä¸‹æ¸¸ç³»ç»Ÿä¹‹é—´ä¸ºä»€ä¹ˆè¦é‡‡ç”¨åŒæ­¥é€šä¿¡å‘¢ï¼Ÿ</p>
<ol>
<li>æ¸¸ç³»ç»Ÿå’Œæ¶ˆæ¯ä¸­é—´ä»¶ä¹‹é—´é‡‡ç”¨å¼‚æ­¥é€šä¿¡æ˜¯ä¸ºäº†æé«˜ç³»ç»Ÿå¹¶å‘åº¦ã€‚ä¸šåŠ¡ç³»ç»Ÿç›´æ¥å’Œç”¨æˆ·æ‰“äº¤é“ï¼Œç”¨æˆ·ä½“éªŒå°¤ä¸ºé‡è¦ï¼Œå› æ­¤è¿™ç§å¼‚æ­¥é€šä¿¡æ–¹å¼èƒ½å¤Ÿæå¤§ç¨‹åº¦åœ°é™ä½ç”¨æˆ·ç­‰å¾…æ—¶é—´ã€‚æ­¤å¤–ï¼Œå¼‚æ­¥é€šä¿¡ç›¸å¯¹äºåŒæ­¥é€šä¿¡è€Œè¨€ï¼Œæ²¡æœ‰äº†é•¿æ—¶é—´çš„é˜»å¡ç­‰å¾…ï¼Œå› æ­¤ç³»ç»Ÿçš„å¹¶å‘æ€§ä¹Ÿå¤§å¤§å¢åŠ ã€‚ä½†å¼‚æ­¥é€šä¿¡å¯èƒ½ä¼šå¼•èµ·Commit/RollbackæŒ‡ä»¤ä¸¢å¤±çš„é—®é¢˜ï¼Œè¿™å°±ç”±æ¶ˆæ¯ä¸­é—´ä»¶çš„è¶…æ—¶è¯¢é—®æœºåˆ¶æ¥å¼¥è¡¥ã€‚</li>
<li>æ¶ˆæ¯æ¯ä¸­é—´ä»¶å’Œä¸‹æ¸¸ç³»ç»Ÿä¹‹é—´é‡‡ç”¨åŒæ­¥é€šä¿¡æ˜¯å› ä¸ºåŒæ­¥è™½ç„¶é™ä½ç³»ç»Ÿå¹¶å‘åº¦ï¼Œä½†å®ç°æˆæœ¬è¾ƒä½ã€‚å› æ­¤ï¼Œåœ¨å¯¹å¹¶å‘åº¦è¦æ±‚ä¸æ˜¯å¾ˆé«˜çš„æƒ…å†µä¸‹ï¼Œæˆ–è€…æœåŠ¡å™¨èµ„æºè¾ƒä¸ºå……è£•çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©åŒæ­¥æ¥é™ä½ç³»ç»Ÿçš„å¤æ‚åº¦ã€‚</li>
</ol>
<h2 id="TCCç¼–ç¨‹å¼è¡¥å¿æ€§äº‹åŠ¡"><a href="#TCCç¼–ç¨‹å¼è¡¥å¿æ€§äº‹åŠ¡" class="headerlink" title="TCCç¼–ç¨‹å¼è¡¥å¿æ€§äº‹åŠ¡"></a>TCCç¼–ç¨‹å¼è¡¥å¿æ€§äº‹åŠ¡</h2><p><img src="https://img.alicdn.com/tfs/TB1CdK1dKOSBuNjy0FdXXbDnVXa-856-417.png" alt="tcc"></p>
<p>TCCå³ä¸º<strong>Try Confirm Cancel</strong>ï¼Œå®ƒå±äºè¡¥å¿å‹åˆ†å¸ƒå¼äº‹åŠ¡ã€‚é¡¾åæ€ä¹‰ï¼ŒTCCå®ç°åˆ†å¸ƒå¼äº‹åŠ¡ä¸€å…±æœ‰ä¸‰ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>Tryï¼šå°è¯•å¾…æ‰§è¡Œçš„ä¸šåŠ¡<br> è¿™ä¸ªè¿‡ç¨‹å¹¶æœªæ‰§è¡Œä¸šåŠ¡ï¼Œåªæ˜¯å®Œæˆæ‰€æœ‰ä¸šåŠ¡çš„ä¸€è‡´æ€§æ£€æŸ¥ï¼Œå¹¶<strong>é¢„ç•™å¥½æ‰§è¡Œæ‰€éœ€çš„å…¨éƒ¨èµ„æº</strong></li>
<li>Confirmï¼šæ‰§è¡Œä¸šåŠ¡<br> è¿™ä¸ªè¿‡ç¨‹çœŸæ­£å¼€å§‹æ‰§è¡Œä¸šåŠ¡ï¼Œç”±äºTryé˜¶æ®µå·²ç»å®Œæˆäº†ä¸€è‡´æ€§æ£€æŸ¥ï¼Œå› æ­¤æœ¬è¿‡ç¨‹ç›´æ¥æ‰§è¡Œï¼Œè€Œä¸åšä»»ä½•æ£€æŸ¥ã€‚å¹¶ä¸”åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œä¼šä½¿ç”¨åˆ°Tryé˜¶æ®µé¢„ç•™çš„ä¸šåŠ¡èµ„æºã€‚</li>
<li>Cancelï¼šå–æ¶ˆæ‰§è¡Œçš„ä¸šåŠ¡<br> è‹¥ä¸šåŠ¡æ‰§è¡Œå¤±è´¥ï¼Œåˆ™è¿›å…¥Cancelé˜¶æ®µï¼Œå®ƒä¼šé‡Šæ”¾æ‰€æœ‰å ç”¨çš„ä¸šåŠ¡èµ„æºï¼Œå¹¶å›æ»šConfirmé˜¶æ®µæ‰§è¡Œçš„æ“ä½œã€‚</li>
</ol>
<p>å°±ä¸¾ä¸‹å•æ”¯ä»˜çš„ä¾‹å­ï¼š<br>Tryï¼š</p>
<ul>
<li>ä»ç”¨æˆ·è´¦æˆ·æ‰£é™¤100å…ƒï¼ˆé¢„ç•™ä¸šåŠ¡èµ„æºï¼‰</li>
</ul>
<p>Confirmï¼š</p>
<ul>
<li>è®¢å•ç”Ÿæˆ</li>
<li>å•†æˆ·è´¦æˆ·å¢åŠ 100å…ƒ</li>
</ul>
<p>Concelï¼š</p>
<ul>
<li>å°†ç”¨æˆ·è´¦æˆ·å¢åŠ 100å…ƒ</li>
<li>å°†å•†æˆ·è´¦æˆ·å‡å»100å…ƒ</li>
<li>å‡ºç°ä»»ä½•å¼‚å¸¸ï¼Œé‡Šæ”¾æ‰€æœ‰å ç”¨çš„ä¸šåŠ¡èµ„æºï¼Œå¹¶å›æ»šConfirmé˜¶æ®µæ‰§è¡Œçš„æ“ä½œã€‚</li>
</ul>
<p>å¯¹äºTCCæ¥è¯´é€‚åˆä¸€äº›:</p>
<ul>
<li>å¼ºéš”ç¦»æ€§ï¼Œä¸¥æ ¼ä¸€è‡´æ€§è¦æ±‚çš„æ´»åŠ¨ä¸šåŠ¡ã€‚</li>
<li>æ‰§è¡Œæ—¶é—´è¾ƒçŸ­çš„ä¸šåŠ¡</li>
</ul>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol>
<li><a href="https://juejin.im/post/5aa3c7736fb9a028bb189bca" target="_blank" rel="noopener">å¸¸ç”¨çš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ</a></li>
<li><a href="https://juejin.im/post/5b5a0bf9f265da0f6523913b" target="_blank" rel="noopener">å†æœ‰äººé—®ä½ åˆ†å¸ƒå¼äº‹åŠ¡ï¼ŒæŠŠè¿™ç¯‡æ‰”ç»™ä»–</a></li>
<li><a href="http://www.hollischuang.com/archives/681" target="_blank" rel="noopener">å…³äºåˆ†å¸ƒå¼äº‹åŠ¡ã€ä¸¤é˜¶æ®µæäº¤åè®®ã€ä¸‰é˜¶æäº¤åè®®</a></li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä¼—æ‰€å‘¨çŸ¥ï¼Œäº‹åŠ¡å¯ä»¥ä¿è¯ä¸€ç»„æ“ä½œè¦ä¹ˆå…¨éƒ½æ­£ç¡®æ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ½ä¸æ‰§è¡Œã€‚ç›®å‰çš„æ•°æ®åº“åªèƒ½æ”¯æŒåŒä¸€ä¸ªæ•°æ®åº“ä¸­çš„äº‹åŠ¡ã€‚ä½†ç°åœ¨çš„ç³»ç»Ÿå¾€å¾€é‡‡ç”¨å¾®æœåŠ¡æ¶æ„ï¼Œä¸šåŠ¡ç³»ç»Ÿæ‹¥æœ‰ç‹¬ç«‹çš„æ•°æ®åº“ï¼Œå› æ­¤å°±å‡ºç°äº†è·¨å¤šä¸ªæ•°æ®åº“çš„äº‹åŠ¡éœ€æ±‚ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼äº‹åŠ¡å•¦ï¼
    
    </summary>
    
      <category term="åˆ†å¸ƒå¼" scheme="http://bestlixiang.site/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
    
      <category term="åˆ†å¸ƒå¼äº‹åŠ¡" scheme="http://bestlixiang.site/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/"/>
    
  </entry>
  
  <entry>
    <title>åˆ†å¸ƒå¼é”</title>
    <link href="http://bestlixiang.site/2018/12/27/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/"/>
    <id>http://bestlixiang.site/2018/12/27/åˆ†å¸ƒå¼/åˆ†å¸ƒå¼é”/</id>
    <published>2018-12-27T05:15:43.000Z</published>
    <updated>2018-12-27T05:16:46.141Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨å•æœºåœºæ™¯ä¸‹ï¼Œå¯ä»¥ä½¿ç”¨è¯­è¨€çš„å†…ç½®é”ï¼ˆå¦‚JDKä¸­çš„ReentrantLcokæˆ–è€…synchronizedï¼‰æ¥å®ç°è¿›ç¨‹åŒæ­¥ã€‚ä½†æ˜¯åœ¨åˆ†å¸ƒå¼åœºæ™¯ä¸‹ï¼Œéœ€è¦åŒæ­¥çš„è¿›ç¨‹å¯èƒ½ä½äºä¸åŒçš„èŠ‚ç‚¹ä¸Šï¼Œé‚£ä¹ˆå°±éœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼é”ã€‚<a id="more"></a></p>
<p><img src="https://cdn.masterlock.com/masterlock/resources/img/home-sliders/1588D-combinationlock.jpg" alt="lock"></p>
<h1 id="åˆ†å¸ƒå¼é”æ€§è´¨"><a href="#åˆ†å¸ƒå¼é”æ€§è´¨" class="headerlink" title="åˆ†å¸ƒå¼é”æ€§è´¨"></a>åˆ†å¸ƒå¼é”æ€§è´¨</h1><ol>
<li>è·å–é”å’Œé‡Šæ”¾é”çš„æ€§èƒ½è¦å¥½</li>
<li>åˆ¤æ–­æ˜¯å¦è·å¾—é”å¿…é¡»æ˜¯åŸå­æ€§çš„ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´å¤šä¸ªè¯·æ±‚éƒ½è·å–åˆ°é”</li>
<li>ç½‘ç»œä¸­æ–­æˆ–å®•æœºæ— æ³•é‡Šæ”¾é”æ—¶ï¼Œé”å¿…é¡»è¢«æ¸…é™¤ï¼Œä¸ç„¶ä¼šå‘ç”Ÿæ­»é”</li>
<li>å¯é‡å…¥è·å–é”</li>
<li>å¯ä»¥ä¸ºé˜»å¡é”å’Œéé˜»å¡é”ï¼Œé˜»å¡é”å³æ²¡æœ‰è·å–åˆ°é”ï¼Œåˆ™ç»§ç»­ç­‰å¾…è·å–é”ï¼›éé˜»å¡é”å³æ²¡æœ‰è·å–åˆ°é”åï¼Œä¸ç»§ç»­ç­‰å¾…ï¼Œç›´æ¥è¿”å›é”å¤±è´¥ã€‚</li>
</ol>
<h1 id="åˆ†å¸ƒå¼é”å®ç°æ–¹å¼"><a href="#åˆ†å¸ƒå¼é”å®ç°æ–¹å¼" class="headerlink" title="åˆ†å¸ƒå¼é”å®ç°æ–¹å¼"></a>åˆ†å¸ƒå¼é”å®ç°æ–¹å¼</h1><h2 id="æ•°æ®åº“é”"><a href="#æ•°æ®åº“é”" class="headerlink" title="æ•°æ®åº“é”"></a>æ•°æ®åº“é”</h2><h3 id="åŸºäºMySQLé”è¡¨"><a href="#åŸºäºMySQLé”è¡¨" class="headerlink" title="åŸºäºMySQLé”è¡¨"></a>åŸºäºMySQLé”è¡¨</h3><p>è¯¥å®ç°æ–¹å¼å®Œå…¨ä¾é <strong>æ•°æ®åº“å”¯ä¸€ç´¢å¼•</strong>æ¥å®ç°ã€‚å½“æƒ³è¦è·å¾—é”æ—¶ï¼Œå³å‘æ•°æ®åº“ä¸­æ’å…¥ä¸€æ¡è®°å½•ï¼Œé‡Šæ”¾é”æ—¶å°±åˆ é™¤è¿™æ¡è®°å½•ã€‚è¿™ç§æ–¹å¼å­˜åœ¨ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š</p>
<ol>
<li>é”æ²¡æœ‰å¤±æ•ˆæ—¶é—´ï¼Œè§£é”å¤±è´¥ä¼šå¯¼è‡´æ­»é”ï¼Œå…¶ä»–çº¿ç¨‹æ— æ³•å†è·å–åˆ°é”ï¼Œå› ä¸ºå”¯ä¸€ç´¢å¼•insertéƒ½ä¼šè¿”å›å¤±è´¥ã€‚</li>
<li>åªèƒ½æ˜¯éé˜»å¡é”ï¼Œinsertå¤±è´¥ç›´æ¥å°±æŠ¥é”™äº†ï¼Œæ— æ³•è¿›å…¥é˜Ÿåˆ—è¿›è¡Œé‡è¯•ã€‚</li>
<li>ä¸å¯é‡å…¥ï¼ŒåŒä¸€çº¿ç¨‹åœ¨æ²¡æœ‰é‡Šæ”¾é”ä¹‹å‰æ— æ³•å†è·å–åˆ°é”ã€‚</li>
</ol>
<h3 id="é‡‡ç”¨ä¹è§‚é”å¢åŠ ç‰ˆæœ¬å·"><a href="#é‡‡ç”¨ä¹è§‚é”å¢åŠ ç‰ˆæœ¬å·" class="headerlink" title="é‡‡ç”¨ä¹è§‚é”å¢åŠ ç‰ˆæœ¬å·"></a>é‡‡ç”¨ä¹è§‚é”å¢åŠ ç‰ˆæœ¬å·</h3><p>æ ¹æ®<strong>ç‰ˆæœ¬å·å­—æ®µ</strong>æ¥åˆ¤æ–­æ›´æ–°ä¹‹å‰æœ‰æ²¡æœ‰å…¶ä»–çº¿ç¨‹æ›´æ–°è¿‡ï¼Œå¦‚æœè¢«æ›´æ–°è¿‡ï¼Œåˆ™è·å–é”å¤±è´¥ã€‚</p>
<h2 id="ç¼“å­˜é”"><a href="#ç¼“å­˜é”" class="headerlink" title="ç¼“å­˜é”"></a>ç¼“å­˜é”</h2><p>å¹³æ—¶ä½¿ç”¨çš„æœ€å¤šçš„å°±æ˜¯redisï¼Œè¿™é‡Œä»‹ç»ä¸¤ç§redisçš„åˆ†å¸ƒå¼é”ã€‚</p>
<h3 id="åŸºäºsetnxã€expireä¸¤ä¸ªå‘½ä»¤æ¥å®ç°"><a href="#åŸºäºsetnxã€expireä¸¤ä¸ªå‘½ä»¤æ¥å®ç°" class="headerlink" title="åŸºäºsetnxã€expireä¸¤ä¸ªå‘½ä»¤æ¥å®ç°"></a>åŸºäºsetnxã€expireä¸¤ä¸ªå‘½ä»¤æ¥å®ç°</h3><p>åŸºäºsetnxï¼ˆset if not existï¼‰çš„ç‰¹ç‚¹ï¼Œå½“ç¼“å­˜é‡Œkeyä¸å­˜åœ¨æ—¶ï¼Œæ‰ä¼šå»setï¼Œå¦åˆ™ç›´æ¥è¿”å›falseã€‚å¦‚æœè¿”å›trueåˆ™è·å–åˆ°é”ï¼Œå¦åˆ™è·å–é”å¤±è´¥ï¼Œä¸ºäº†é˜²æ­¢æ­»é”ï¼Œæˆ‘ä»¬å†ç”¨expireå‘½ä»¤å¯¹è¿™ä¸ªkeyè®¾ç½®ä¸€ä¸ªè¶…æ—¶æ—¶é—´æ¥é¿å…ã€‚</p>
<p>ä½†æ˜¯è¿™é‡Œçœ‹ä¼¼å®Œç¾ï¼Œå®åˆ™æœ‰ç¼ºé™·ï¼Œå½“æˆ‘ä»¬setnxæˆåŠŸåï¼Œçº¿ç¨‹å‘ç”Ÿå¼‚å¸¸ä¸­æ–­ï¼Œexpireè¿˜æ²¡æ¥çš„åŠè®¾ç½®ï¼Œé‚£ä¹ˆå°±ä¼šäº§ç”Ÿæ­»é”ã€‚</p>
<p>ä¸ºäº†è§£å†³ä¸Šè¯‰é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨redis2.6.12ç‰ˆæœ¬ä»¥åçš„setï¼Œå®ƒæä¾›äº†ä¸€ç³»åˆ—é€‰é¡¹ï¼š</p>
<ul>
<li>EX seconds â€“ è®¾ç½®é”®keyçš„è¿‡æœŸæ—¶é—´ï¼Œå•ä½æ—¶ç§’</li>
<li>PX milliseconds â€“ è®¾ç½®é”®keyçš„è¿‡æœŸæ—¶é—´ï¼Œå•ä½æ—¶æ¯«ç§’</li>
<li>NX â€“ åªæœ‰é”®keyä¸å­˜åœ¨çš„æ—¶å€™æ‰ä¼šè®¾ç½®keyçš„å€¼</li>
<li>XX â€“ åªæœ‰é”®keyå­˜åœ¨çš„æ—¶å€™æ‰ä¼šè®¾ç½®keyçš„å€¼</li>
</ul>
<h3 id="RedLockç®—æ³•"><a href="#RedLockç®—æ³•" class="headerlink" title="RedLockç®—æ³•"></a>RedLockç®—æ³•</h3><p>redlockç®—æ³•æ˜¯<strong>redisä½œè€…æ¨è</strong>çš„ä¸€ç§åˆ†å¸ƒå¼é”å®ç°æ–¹å¼ï¼Œç®—æ³•çš„å†…å®¹å¦‚ä¸‹ï¼š</p>
<ol>
<li>è·å–å½“å‰æ—¶é—´ï¼›</li>
<li>å°è¯•ä»Nä¸ªç›¸äº’ç‹¬ç«‹rediså®¢æˆ·ç«¯è·å–é”ï¼›</li>
<li>è®¡ç®—è·å–æ‰€æœ‰é”æ¶ˆè€—çš„æ—¶é—´ï¼Œå½“ä¸”ä»…å½“å®¢æˆ·ç«¯ä»å¤šæ•°èŠ‚ç‚¹(N/2+1)è·å–é”ï¼Œå¹¶ä¸”è·å–é”çš„æ—¶é—´å°äºé”çš„æœ‰æ•ˆæ—¶é—´ï¼Œè®¤ä¸ºè·å¾—é”ï¼›</li>
<li>é‡æ–°è®¡ç®—æœ‰æ•ˆæœŸæ—¶é—´ï¼ŒåŸæœ‰æ•ˆæ—¶é—´å‡å»è·å–é”æ¶ˆè€—çš„æ—¶é—´ï¼›</li>
<li>åˆ é™¤æ‰€æœ‰å®ä¾‹çš„é”</li>
</ol>
<p>redlockç®—æ³•ç›¸å¯¹äºå•èŠ‚ç‚¹redisé”å¯é æ€§è¦æ›´é«˜ï¼Œä½†æ˜¯å®ç°èµ·æ¥æ¡ä»¶ä¹Ÿè¾ƒä¸ºè‹›åˆ»ã€‚</p>
<ol>
<li>å¿…é¡»éƒ¨ç½²5ä¸ªèŠ‚ç‚¹æ‰èƒ½è®©Redlockçš„å¯é æ€§æ›´å¼ºã€‚</li>
<li>éœ€è¦è¯·æ±‚5ä¸ªèŠ‚ç‚¹æ‰èƒ½è·å–åˆ°é”ï¼Œé€šè¿‡Futureçš„æ–¹å¼ï¼Œå…ˆå¹¶å‘å‘5ä¸ªèŠ‚ç‚¹è¯·æ±‚ï¼Œå†ä¸€èµ·è·å¾—å“åº”ç»“æœï¼Œèƒ½ç¼©çŸ­å“åº”æ—¶é—´ï¼Œä¸è¿‡è¿˜æ˜¯æ¯”å•èŠ‚ç‚¹redisé”è¦è€—è´¹æ›´å¤šæ—¶é—´ã€‚</li>
</ol>
<p>ç„¶åç”±äºå¿…é¡»è·å–åˆ°5ä¸ªèŠ‚ç‚¹ä¸­çš„3ä¸ªä»¥ä¸Šï¼Œæ‰€ä»¥å¯èƒ½å‡ºç°è·å–é”å†²çªï¼Œå³å¤§å®¶éƒ½è·å¾—äº†1-2æŠŠé”ï¼Œç»“æœè°ä¹Ÿä¸èƒ½è·å–åˆ°é”ï¼Œè¿™ä¸ªé—®é¢˜ï¼Œredisä½œè€…å€Ÿé‰´äº†raftç®—æ³•çš„ç²¾é«“ï¼Œé€šè¿‡å†²çªååœ¨éšæœºæ—¶é—´å¼€å§‹ï¼Œå¯ä»¥å¤§å¤§é™ä½å†²çªæ—¶é—´ï¼Œä½†æ˜¯è¿™é—®é¢˜å¹¶ä¸èƒ½å¾ˆå¥½çš„é¿å…ï¼Œç‰¹åˆ«æ˜¯åœ¨ç¬¬ä¸€æ¬¡è·å–é”çš„æ—¶å€™ï¼Œæ‰€ä»¥è·å–é”çš„æ—¶é—´æˆæœ¬å¢åŠ äº†ã€‚</p>
<p>å¦‚æœ5ä¸ªèŠ‚ç‚¹æœ‰2ä¸ªå®•æœºï¼Œæ­¤æ—¶é”çš„å¯ç”¨æ€§ä¼šæå¤§é™ä½ï¼Œé¦–å…ˆå¿…é¡»ç­‰å¾…è¿™ä¸¤ä¸ªå®•æœºèŠ‚ç‚¹çš„ç»“æœè¶…æ—¶æ‰èƒ½è¿”å›ï¼Œå¦å¤–åªæœ‰3ä¸ªèŠ‚ç‚¹ï¼Œå®¢æˆ·ç«¯å¿…é¡»è·å–åˆ°è¿™å…¨éƒ¨3ä¸ªèŠ‚ç‚¹çš„é”æ‰èƒ½æ‹¥æœ‰é”ï¼Œéš¾åº¦ä¹ŸåŠ å¤§äº†ã€‚</p>
<p>å¦‚æœå‡ºç°ç½‘ç»œåˆ†åŒºï¼Œé‚£ä¹ˆå¯èƒ½å‡ºç°å®¢æˆ·ç«¯æ°¸è¿œä¹Ÿæ— æ³•è·å–é”çš„æƒ…å†µï¼Œä»‹äºè¿™ç§æƒ…å†µï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ç§æ›´å¯é çš„åˆ†å¸ƒå¼é”zookeeperé”ã€‚</p>
<h2 id="zookeeperé”"><a href="#zookeeperé”" class="headerlink" title="zookeeperé”"></a>zookeeperé”</h2><h3 id="ZookeeperæŠ½è±¡æ¨¡å‹"><a href="#ZookeeperæŠ½è±¡æ¨¡å‹" class="headerlink" title="ZookeeperæŠ½è±¡æ¨¡å‹"></a>ZookeeperæŠ½è±¡æ¨¡å‹</h3><p>Zookeeper æä¾›äº†ä¸€ç§æ ‘å½¢ç»“æ„çº§çš„å‘½åç©ºé—´ï¼Œ/app1/p_1 èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ä¸º /app1ã€‚<br><img src="http://s1.51cto.com/oss/201809/12/08308a2ed38371a6fef72f281598b3df.jpg" alt="zookeeper"></p>
<h3 id="èŠ‚ç‚¹ç±»å‹"><a href="#èŠ‚ç‚¹ç±»å‹" class="headerlink" title="èŠ‚ç‚¹ç±»å‹"></a>èŠ‚ç‚¹ç±»å‹</h3><ul>
<li>æ°¸ä¹…èŠ‚ç‚¹ï¼šä¸ä¼šå› ä¸ºä¼šè¯ç»“æŸæˆ–è€…è¶…æ—¶è€Œæ¶ˆå¤±;</li>
<li>ä¸´æ—¶èŠ‚ç‚¹ï¼šå¦‚ä½•ä¼šè¯ç»“æŸæˆ–è€…è¶…æ—¶å°±ä¼šæ¶ˆå¤±;</li>
<li>æœ‰åºèŠ‚ç‚¹ï¼šä¼šåœ¨èŠ‚ç‚¹åçš„åé¢åŠ ä¸€ä¸ªæ•°å­—åç¼€ï¼Œå¹¶ä¸”æ˜¯æœ‰åºçš„ï¼Œä¾‹å¦‚ç”Ÿæˆçš„æœ‰åºèŠ‚ç‚¹ä¸º /lock/node-0000000000ï¼Œå®ƒçš„ä¸‹ä¸€ä¸ªæœ‰åºèŠ‚ç‚¹åˆ™ä¸º /lock/node-0000000001ï¼Œä»¥æ­¤ç±»æ¨ã€‚</li>
</ul>
<h3 id="ç›‘å¬å™¨"><a href="#ç›‘å¬å™¨" class="headerlink" title="ç›‘å¬å™¨"></a>ç›‘å¬å™¨</h3><p>ä¸ºä¸€ä¸ªèŠ‚ç‚¹æ³¨å†Œç›‘å¬å™¨ï¼Œåœ¨èŠ‚ç‚¹çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼Œä¼šç»™å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ã€‚å½“å‰zookeeperæœ‰å¦‚ä¸‹å››ç§äº‹ä»¶ï¼š1ï¼‰èŠ‚ç‚¹åˆ›å»ºï¼›2ï¼‰èŠ‚ç‚¹åˆ é™¤ï¼›3ï¼‰èŠ‚ç‚¹æ•°æ®ä¿®æ”¹ï¼›4ï¼‰å­èŠ‚ç‚¹å˜æ›´ã€‚</p>
<h3 id="åˆ†å¸ƒå¼é”å®ç°"><a href="#åˆ†å¸ƒå¼é”å®ç°" class="headerlink" title="åˆ†å¸ƒå¼é”å®ç°"></a>åˆ†å¸ƒå¼é”å®ç°</h3><ol>
<li>åˆ›å»ºä¸€ä¸ªé”ç›®å½• /lockï¼›</li>
<li>å½“ä¸€ä¸ªå®¢æˆ·ç«¯éœ€è¦è·å–é”æ—¶ï¼Œåœ¨ /lock ä¸‹åˆ›å»º<strong>ä¸´æ—¶çš„ä¸”æœ‰åºçš„</strong>å­èŠ‚ç‚¹ï¼›<br>å®¢æˆ·ç«¯è·å– /lock ä¸‹çš„å­èŠ‚ç‚¹åˆ—è¡¨ï¼Œåˆ¤æ–­è‡ªå·±åˆ›å»ºçš„å­èŠ‚ç‚¹æ˜¯å¦ä¸ºå½“å‰å­èŠ‚ç‚¹åˆ—è¡¨ä¸­åºå·æœ€å°çš„å­èŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯åˆ™è®¤ä¸ºè·å¾—é”ï¼›å¦åˆ™ç›‘å¬è‡ªå·±çš„å‰ä¸€ä¸ªå­èŠ‚ç‚¹ï¼Œè·å¾—å­èŠ‚ç‚¹çš„å˜æ›´é€šçŸ¥åé‡å¤æ­¤æ­¥éª¤ç›´è‡³è·å¾—é”ï¼›</li>
<li>æ‰§è¡Œä¸šåŠ¡ä»£ç </li>
<li>ä¸šåŠ¡ä»£ç æ‰§è¡Œå®Œæˆåï¼Œåˆ é™¤å¯¹åº”çš„å­èŠ‚ç‚¹ã€‚</li>
</ol>
<p>æœ‰äº›äººä¼šåœ¨<strong>æ­¥éª¤2ä¸­è·å–å­èŠ‚ç‚¹åˆ—è¡¨ä¸è®¾ç½®ç›‘å¬è¿™ä¸¤æ­¥æ“ä½œçš„å­˜åœ¨åŸå­æ€§é—®é¢˜</strong>ï¼Œè€ƒè™‘è¿™ä¹ˆä¸ªåœºæ™¯ï¼šå®¢æˆ·ç«¯aå¯¹åº”å­èŠ‚ç‚¹ä¸º/lock/lock-0000000000ï¼Œå®¢æˆ·ç«¯bå¯¹åº”å­èŠ‚ç‚¹ä¸º/lock/lock-0000000001ï¼Œå®¢æˆ·ç«¯bè·å–å­èŠ‚ç‚¹åˆ—è¡¨æ—¶å‘ç°è‡ªå·±ä¸æ˜¯åºå·æœ€å°çš„ï¼Œä½†æ˜¯åœ¨è®¾ç½®ç›‘å¬å™¨å‰å®¢æˆ·ç«¯aå®Œæˆä¸šåŠ¡æµç¨‹åˆ é™¤äº†å­èŠ‚ç‚¹/lock/lock-0000000000ï¼Œå®¢æˆ·ç«¯bè®¾ç½®çš„ç›‘å¬å™¨å²‚ä¸æ˜¯ä¸¢å¤±äº†è¿™ä¸ªäº‹ä»¶ä»è€Œå¯¼è‡´æ°¸è¿œç­‰å¾…äº†ï¼Ÿè¿™ä¸ªé—®é¢˜ä¸å­˜åœ¨çš„ã€‚<strong>å› ä¸ºzookeeperæä¾›çš„APIä¸­è®¾ç½®ç›‘å¬å™¨çš„æ“ä½œä¸è¯»æ“ä½œæ˜¯åŸå­æ‰§è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨è¯»å­èŠ‚ç‚¹åˆ—è¡¨æ—¶åŒæ—¶è®¾ç½®ç›‘å¬å™¨ï¼Œä¿è¯ä¸ä¼šä¸¢å¤±äº‹ä»¶ã€‚</strong></p>
<h3 id="ç¾Šç¾¤æ•ˆåº”"><a href="#ç¾Šç¾¤æ•ˆåº”" class="headerlink" title="ç¾Šç¾¤æ•ˆåº”"></a>ç¾Šç¾¤æ•ˆåº”</h3><p>ä¸€ä¸ªèŠ‚ç‚¹æœªè·å¾—é”ï¼Œåªéœ€è¦ç›‘å¬è‡ªå·±çš„å‰ä¸€ä¸ªå­èŠ‚ç‚¹ï¼Œè¿™æ˜¯å› ä¸ºå¦‚æœç›‘å¬æ‰€æœ‰çš„å­èŠ‚ç‚¹ï¼Œé‚£ä¹ˆä»»æ„ä¸€ä¸ªå­èŠ‚ç‚¹çŠ¶æ€æ”¹å˜ï¼Œå…¶å®ƒæ‰€æœ‰å­èŠ‚ç‚¹éƒ½ä¼šæ”¶åˆ°é€šçŸ¥ï¼ˆç¾Šç¾¤æ•ˆåº”ï¼‰ï¼Œè€Œæˆ‘ä»¬åªå¸Œæœ›å®ƒçš„åä¸€ä¸ªå­èŠ‚ç‚¹æ”¶åˆ°é€šçŸ¥ã€‚</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol>
<li><a href="http://www.linkedkeeper.com/detail/blog.action?bid=1023" target="_blank" rel="noopener">æµ…è°ˆåˆ†å¸ƒå¼é”</a></li>
<li><a href="http://www.dengshenyu.com/java/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/2017/10/23/zookeeper-distributed-lock.html" target="_blank" rel="noopener">åŸºäºZookeeperçš„åˆ†å¸ƒå¼é”</a></li>
<li><a href="https://segmentfault.com/a/1190000012919740#articleHeader5" target="_blank" rel="noopener">åŸºäºredisçš„åˆ†å¸ƒå¼é”å®ç°</a></li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨å•æœºåœºæ™¯ä¸‹ï¼Œå¯ä»¥ä½¿ç”¨è¯­è¨€çš„å†…ç½®é”ï¼ˆå¦‚JDKä¸­çš„ReentrantLcokæˆ–è€…synchronizedï¼‰æ¥å®ç°è¿›ç¨‹åŒæ­¥ã€‚ä½†æ˜¯åœ¨åˆ†å¸ƒå¼åœºæ™¯ä¸‹ï¼Œéœ€è¦åŒæ­¥çš„è¿›ç¨‹å¯èƒ½ä½äºä¸åŒçš„èŠ‚ç‚¹ä¸Šï¼Œé‚£ä¹ˆå°±éœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼é”ã€‚
    
    </summary>
    
      <category term="åˆ†å¸ƒå¼" scheme="http://bestlixiang.site/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
    
      <category term="åˆ†å¸ƒå¼é”" scheme="http://bestlixiang.site/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/"/>
    
  </entry>
  
  <entry>
    <title>consistent hashing algorithm</title>
    <link href="http://bestlixiang.site/2018/12/27/%E5%88%86%E5%B8%83%E5%BC%8F/consistent%20hashing%20algorithm%20/"/>
    <id>http://bestlixiang.site/2018/12/27/åˆ†å¸ƒå¼/consistent hashing algorithm /</id>
    <published>2018-12-26T23:14:13.000Z</published>
    <updated>2018-12-26T12:04:02.312Z</updated>
    
    <content type="html"><![CDATA[<p>å¼•ï¼šåœ¨åˆ†å¸ƒå¼é›†ç¾¤ä¸­ï¼Œå¯¹æœºå™¨çš„æ·»åŠ åˆ é™¤ï¼Œæˆ–è€…æœºå™¨æ•…éšœåè‡ªåŠ¨è„±ç¦»é›†ç¾¤è¿™äº›æ“ä½œæ˜¯åˆ†å¸ƒå¼é›†ç¾¤ç®¡ç†æœ€åŸºæœ¬çš„åŠŸèƒ½ã€‚å¦‚æœé‡‡ç”¨å¸¸ç”¨çš„hash(object)%Nç®—æ³•ï¼Œé‚£ä¹ˆåœ¨æœ‰æœºå™¨æ·»åŠ æˆ–è€…åˆ é™¤åï¼Œå¾ˆå¤šåŸæœ‰çš„æ•°æ®å°±æ— æ³•æ‰¾åˆ°äº†ï¼Œè¿™æ—¶å€™ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•å°±ç«™å‡ºæ¥äº†ï¼<a id="more"></a></p>
<p><img src="https://ss0.bdstatic.com/94oJfD_bAAcT8t7mm9GUKT-xh_/timg?image&amp;quality=100&amp;size=b4000_4000&amp;sec=1545823709&amp;di=7aa416e5d990fbc2bf752ec187f3932a&amp;src=http://b-ssl.duitang.com/uploads/item/201702/26/20170226001149_Jxmeh.jpeg" alt="curry"></p>
<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>ä¸€è‡´æ€§hashç®—æ³•åœ¨1997å¹´ç”±éº»çœç†å·¥å­¦é™¢æå‡ºçš„ä¸€ç§åˆ†å¸ƒå¼å“ˆå¸Œï¼ˆDHTï¼‰å®ç°ç®—æ³•ï¼Œè®¾è®¡ç›®æ ‡æ˜¯ä¸ºäº†è§£å†³å› ç‰¹ç½‘ä¸­çš„çƒ­ç‚¹(Hot spot)é—®é¢˜ï¼Œåˆè¡·å’ŒCARPååˆ†ç±»ä¼¼ã€‚ä¸€è‡´æ€§hashä¿®æ­£äº†CARPä½¿ç”¨çš„ç®€ å•å“ˆå¸Œç®—æ³•å¸¦æ¥çš„é—®é¢˜ï¼Œä½¿å¾—åˆ†å¸ƒå¼å“ˆå¸Œï¼ˆDHTï¼‰å¯ä»¥åœ¨P2Pç¯å¢ƒä¸­çœŸæ­£å¾—åˆ°åº”ç”¨ã€‚ </p>
<h1 id="å››ä¸ªå®šä¹‰"><a href="#å››ä¸ªå®šä¹‰" class="headerlink" title="å››ä¸ªå®šä¹‰"></a>å››ä¸ªå®šä¹‰</h1><p>äº†åœ¨åŠ¨æ€å˜åŒ–çš„Cacheç¯å¢ƒä¸­ï¼Œåˆ¤å®šå“ˆå¸Œç®—æ³•å¥½åçš„å››ä¸ªå®šä¹‰ï¼š</p>
<h2 id="å¹³è¡¡æ€§-Balance"><a href="#å¹³è¡¡æ€§-Balance" class="headerlink" title="å¹³è¡¡æ€§(Balance)"></a>å¹³è¡¡æ€§(Balance)</h2><p>å¹³è¡¡æ€§æ˜¯æŒ‡å“ˆå¸Œçš„ç»“æœèƒ½å¤Ÿå°½å¯èƒ½åˆ†å¸ƒåˆ°æ‰€æœ‰çš„ç¼“å†²ä¸­å»ï¼Œè¿™æ ·å¯ä»¥ä½¿å¾—æ‰€æœ‰çš„ç¼“å†²ç©ºé—´éƒ½å¾—åˆ°åˆ©ç”¨ã€‚å¾ˆå¤šå“ˆå¸Œç®—æ³•éƒ½èƒ½å¤Ÿæ»¡è¶³è¿™ä¸€æ¡ä»¶ã€‚</p>
<h2 id="å•è°ƒæ€§-Monotonicity"><a href="#å•è°ƒæ€§-Monotonicity" class="headerlink" title="å•è°ƒæ€§(Monotonicity)"></a>å•è°ƒæ€§(Monotonicity)</h2><p><strong>å•è°ƒæ€§æ˜¯æŒ‡å¦‚æœå·²ç»æœ‰ä¸€äº›å†…å®¹é€šè¿‡å“ˆå¸Œåˆ†æ´¾åˆ°äº†ç›¸åº”çš„ç¼“å†²ä¸­ï¼Œåˆæœ‰æ–°çš„ç¼“å†²åŠ å…¥åˆ°ç³»ç»Ÿä¸­ï¼Œå“ˆå¸Œçš„ç»“æœåº”èƒ½å¤Ÿä¿è¯åŸæœ‰å·²åˆ†é…çš„å†…å®¹å¯ä»¥è¢«æ˜ å°„åˆ°åŸæœ‰çš„æˆ–è€…æ–°çš„ç¼“å†²ä¸­å»ï¼Œè€Œä¸ä¼šè¢«æ˜ å°„åˆ°æ—§çš„ç¼“å†²é›†åˆä¸­çš„å…¶ä»–ç¼“å†²åŒºã€‚</strong></p>
<h2 id="åˆ†æ•£æ€§-Spread"><a href="#åˆ†æ•£æ€§-Spread" class="headerlink" title="åˆ†æ•£æ€§(Spread)"></a>åˆ†æ•£æ€§(Spread)</h2><p>åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼Œå½“ç»ˆç«¯å¸Œæœ›é€šè¿‡å“ˆå¸Œè¿‡ç¨‹å°†å†…å®¹æ˜ å°„åˆ°ç¼“å†²ä¸Šæ—¶ï¼Œç”±äºä¸åŒç»ˆç«¯æ‰€è§çš„ç¼“å†²èŒƒå›´æœ‰å¯èƒ½ä¸åŒï¼Œä»è€Œå¯¼è‡´å“ˆå¸Œçš„ç»“æœä¸ä¸€è‡´ï¼Œæœ€ç»ˆçš„ç»“æœæ˜¯ç›¸åŒçš„å†…å®¹è¢«ä¸åŒçš„ç»ˆç«¯æ˜ å°„åˆ°ä¸åŒçš„ç¼“å†²åŒºä¸­ã€‚è¿™ç§æƒ…å†µæ˜¾ç„¶æ˜¯åº”è¯¥é¿å…çš„ã€‚</p>
<h2 id="è´Ÿè½½å‡è¡¡-Load"><a href="#è´Ÿè½½å‡è¡¡-Load" class="headerlink" title="è´Ÿè½½å‡è¡¡(Load)"></a>è´Ÿè½½å‡è¡¡(Load)</h2><p>è´Ÿè½½å‡è¡¡å®é™…ä¸Šæ˜¯ä»å¦ä¸€ä¸ªè§’åº¦çœ‹å¾…åˆ†æ•£æ€§é—®é¢˜ã€‚æ—¢ç„¶ä¸åŒçš„ç»ˆç«¯å¯èƒ½å°†ç›¸åŒçš„å†…å®¹æ˜ å°„åˆ°ä¸åŒçš„ç¼“å†²åŒºä¸­ï¼Œé‚£ä¹ˆå¯¹äºä¸€ä¸ªç‰¹å®šçš„ç¼“å†²åŒºè€Œè¨€ï¼Œä¹Ÿå¯èƒ½è¢«ä¸åŒçš„ç”¨æˆ·æ˜ å°„ä¸ºä¸åŒ çš„å†…å®¹ã€‚ä¸åˆ†æ•£æ€§ä¸€æ ·ï¼Œè¿™ç§æƒ…å†µä¹Ÿæ˜¯åº”å½“é¿å…çš„ã€‚</p>
<h1 id="ç»“æ„è®¾è®¡"><a href="#ç»“æ„è®¾è®¡" class="headerlink" title="ç»“æ„è®¾è®¡"></a>ç»“æ„è®¾è®¡</h1><h2 id="ç¯å½¢Hashç©ºé—´"><a href="#ç¯å½¢Hashç©ºé—´" class="headerlink" title="ç¯å½¢Hashç©ºé—´"></a>ç¯å½¢Hashç©ºé—´</h2><p>æŒ‰ç…§å¸¸ç”¨çš„hashç®—æ³•æ¥å°†å¯¹åº”çš„keyå“ˆå¸Œåˆ°ä¸€ä¸ªå…·æœ‰2^32æ¬¡æ–¹ä¸ªæ¡¶çš„ç©ºé—´ä¸­ï¼Œå³0~(2\^32)-1çš„æ•°å­—ç©ºé—´ä¸­ã€‚ç°åœ¨æˆ‘ä»¬å¯ä»¥å°†è¿™äº›æ•°å­—å¤´å°¾ç›¸è¿ï¼Œæƒ³è±¡æˆä¸€ä¸ªé—­åˆçš„ç¯å½¢ã€‚å¦‚ä¸‹å›¾ï¼š<br><img src="https://img-blog.csdn.net/20140411000507734?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvY3l3b3Nw/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="ring"></p>
<h2 id="æ•°æ®æ˜ å°„åˆ°ç¯ä¸Š"><a href="#æ•°æ®æ˜ å°„åˆ°ç¯ä¸Š" class="headerlink" title="æ•°æ®æ˜ å°„åˆ°ç¯ä¸Š"></a>æ•°æ®æ˜ å°„åˆ°ç¯ä¸Š</h2><p>ç°åœ¨æˆ‘ä»¬å°†object1ã€object2ã€object3ã€object4å››ä¸ªå¯¹è±¡é€šè¿‡ç‰¹å®šçš„Hashå‡½æ•°è®¡ç®—å‡ºå¯¹åº”çš„keyå€¼ï¼Œç„¶åæ•£åˆ—åˆ°Hashç¯ä¸Šã€‚å¦‚ä¸‹å›¾:<br><img src="https://img-blog.csdn.net/20140411000620656?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvY3l3b3Nw/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="data-ring"></p>
<h2 id="æœºå™¨æ˜ å°„åˆ°ç¯ä¸Š"><a href="#æœºå™¨æ˜ å°„åˆ°ç¯ä¸Š" class="headerlink" title="æœºå™¨æ˜ å°„åˆ°ç¯ä¸Š"></a>æœºå™¨æ˜ å°„åˆ°ç¯ä¸Š</h2><p>ç°åœ¨æˆ‘ä»¬å°†NODE1ï¼ŒNODE2ï¼ŒNODE3ä¸‰å°æœºå™¨ï¼Œé€šè¿‡Hashç®—æ³•å¾—åˆ°å¯¹åº”çš„KEYå€¼ï¼Œæ˜ å°„åˆ°ç¯ä¸­ï¼Œå¦‚ä¸‹å›¾ï¼š<br><img src="https://img-blog.csdn.net/20140411000853609?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvY3l3b3Nw/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="mechine-ring"></p>
<h1 id="æ€§è´¨ç»´æŠ¤"><a href="#æ€§è´¨ç»´æŠ¤" class="headerlink" title="æ€§è´¨ç»´æŠ¤"></a>æ€§è´¨ç»´æŠ¤</h1><p>é€šè¿‡hashå‡½æ•°æ»¡è¶³åˆ†æ•£æ€§å’Œè´Ÿè½½å‡è¡¡æ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œä¸‹é¢æˆ‘ä»¬é‡ç‚¹åˆ†æå•è°ƒæ€§å’Œå¹³è¡¡æ€§ã€‚</p>
<h2 id="å•è°ƒæ€§"><a href="#å•è°ƒæ€§" class="headerlink" title="å•è°ƒæ€§"></a>å•è°ƒæ€§</h2><p>æˆ‘ä»¬çœ‹ä¸‹é¢ä¸¤ç§æƒ…å†µï¼š</p>
<h3 id="æœºå™¨çš„æ·»åŠ "><a href="#æœºå™¨çš„æ·»åŠ " class="headerlink" title="æœºå™¨çš„æ·»åŠ "></a>æœºå™¨çš„æ·»åŠ </h3><p>å¦‚æœå¾€é›†ç¾¤ä¸­æ·»åŠ ä¸€ä¸ªæ–°çš„èŠ‚ç‚¹NODE4ï¼Œé€šè¿‡å¯¹åº”çš„å“ˆå¸Œç®—æ³•å¾—åˆ°KEY4ï¼Œå¹¶æ˜ å°„åˆ°ç¯ä¸­ï¼Œå¦‚ä¸‹å›¾<br><img src="https://img-blog.csdn.net/20140411001211062?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvY3l3b3Nw/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="machine-add"><br>æŒ‰ç…§å¾€é¡ºæ—¶é’ˆè¿ç§»çš„è§„åˆ™ï¼Œé‚£ä¹ˆobject2å°†è¢«è¿ç§»åˆ°äº†NODE4ä¸­ï¼Œå…¶å®ƒå¯¹è±¡è¿˜ä¿æŒè¿™åŸæœ‰çš„å­˜å‚¨ä½ç½®ã€‚</p>
<h3 id="æœºå™¨çš„åˆ é™¤"><a href="#æœºå™¨çš„åˆ é™¤" class="headerlink" title="æœºå™¨çš„åˆ é™¤"></a>æœºå™¨çš„åˆ é™¤</h3><p>å¦‚æœNODE2å› ä¸ºæ•…éšœè¢«åˆ é™¤äº†ï¼Œå¦‚ä¸‹å›¾ï¼š<br><img src="https://img-blog.csdn.net/20140411001033656?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvY3l3b3Nw/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="machine-remove"><br>æŒ‰ç…§å¾€é¡ºæ—¶é’ˆè¿ç§»çš„è§„åˆ™ï¼Œobject3å°†ä¼šè¢«è¿ç§»åˆ°NODE3ä¸­ï¼Œè¿™æ ·ä»…ä»…æ˜¯object3çš„æ˜ å°„ä½ç½®å‘ç”Ÿäº†å˜åŒ–ï¼Œå…¶å®ƒçš„å¯¹è±¡æ²¡æœ‰ä»»ä½•çš„æ”¹åŠ¨ã€‚</p>
<p>é€šè¿‡å¯¹èŠ‚ç‚¹çš„æ·»åŠ å’Œåˆ é™¤çš„åˆ†æï¼Œä¸€è‡´æ€§å“ˆå¸Œç®—æ³•åœ¨ä¿æŒäº†å•è°ƒæ€§çš„åŒæ—¶ï¼Œæ•°æ®çš„è¿ç§»é‡è¾¾åˆ°äº†æœ€å°ï¼Œè¿™æ ·çš„ç®—æ³•å¯¹åˆ†å¸ƒå¼é›†ç¾¤æ¥è¯´æ˜¯éå¸¸åˆé€‚çš„ï¼Œé¿å…äº†å¤§é‡æ•°æ®è¿ç§»ï¼Œå‡å°äº†æœåŠ¡å™¨çš„çš„å‹åŠ›ã€‚</p>
<h2 id="å¹³è¡¡æ€§"><a href="#å¹³è¡¡æ€§" class="headerlink" title="å¹³è¡¡æ€§"></a>å¹³è¡¡æ€§</h2><p>å¦‚æœä¸Šé¢åªéƒ¨ç½²äº†NODE1å’ŒNODE3ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œobject1å­˜å‚¨åˆ°äº†NODE1ä¸­ï¼Œè€Œobject2ã€object3ã€object4éƒ½å­˜å‚¨åˆ°äº†NODE3ä¸­ï¼Œè¿™æ ·å°±ç…§æˆäº†<strong>éå¸¸ä¸å¹³è¡¡</strong>çš„çŠ¶æ€ã€‚åœ¨ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•ä¸­ï¼Œä¸ºäº†å°½å¯èƒ½çš„æ»¡è¶³å¹³è¡¡æ€§ï¼Œå…¶å¼•å…¥äº†è™šæ‹ŸèŠ‚ç‚¹ã€‚</p>
<p><strong>è™šæ‹ŸèŠ‚ç‚¹ï¼š</strong> æ˜¯å®é™…èŠ‚ç‚¹ï¼ˆæœºå™¨ï¼‰åœ¨ hash ç©ºé—´çš„å¤åˆ¶å“ï¼ˆ replica ï¼‰ï¼Œä¸€å®é™…ä¸ªèŠ‚ç‚¹ï¼ˆæœºå™¨ï¼‰å¯¹åº”äº†è‹¥å¹²ä¸ªâ€œè™šæ‹ŸèŠ‚ç‚¹â€ï¼Œè¿™ä¸ªå¯¹åº”ä¸ªæ•°ä¹Ÿæˆä¸ºâ€œå¤åˆ¶ä¸ªæ•°â€ï¼Œâ€œè™šæ‹ŸèŠ‚ç‚¹â€åœ¨ hash ç©ºé—´ä¸­ä»¥hashå€¼å‡åŒ€æ’åˆ—ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬ä»¥2ä¸ªå‰¯æœ¬ï¼ˆå¤åˆ¶ä¸ªæ•°ï¼‰ä¸ºä¾‹ï¼Œè¿™æ ·æ•´ä¸ªhashç¯ä¸­å°±å­˜åœ¨äº†4ä¸ªè™šæ‹ŸèŠ‚ç‚¹ï¼Œæœ€åå¯¹è±¡æ˜ å°„çš„å…³ç³»å›¾å¦‚ä¸‹ï¼š<br><img src="https://img-blog.csdn.net/20140411001433375?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvY3l3b3Nw/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="machine-replica"></p>
<p>æ ¹æ®ä¸Šå›¾å¯çŸ¥å¯¹è±¡çš„æ˜ å°„å…³ç³»ï¼šobject1-&gt;NODE1-1ï¼Œobject2-&gt;NODE1-2ï¼Œobject3-&gt;NODE3-2ï¼Œobject4-&gt;NODE3-1ã€‚é€šè¿‡è™šæ‹ŸèŠ‚ç‚¹çš„å¼•å…¥ï¼Œå¯¹è±¡çš„åˆ†å¸ƒå°±æ¯”è¾ƒå‡è¡¡äº†ã€‚é‚£ä¹ˆåœ¨å®é™…æ“ä½œä¸­ï¼Œæ­£çœŸçš„å¯¹è±¡æŸ¥è¯¢æ˜¯å¦‚ä½•å·¥ä½œçš„å‘¢ï¼Ÿå¯¹è±¡ä»hashåˆ°è™šæ‹ŸèŠ‚ç‚¹åˆ°å®é™…èŠ‚ç‚¹çš„è½¬æ¢å¦‚ä¸‹å›¾ï¼š<br><img src="https://img-blog.csdn.net/20140411001540656?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvY3l3b3Nw/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="vitualNode-mapping"></p>
<h1 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h1><p>å¯ä»¥çœ‹ä¸€ä¸‹å‚è€ƒ2ã€‚</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol>
<li><a href="https://blog.csdn.net/cywosp/article/details/23397179" target="_blank" rel="noopener">æ¯å¤©è¿›æ­¥ä¸€ç‚¹ç‚¹â€”â€”äº”åˆ†é’Ÿç†è§£ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•(consistent hashing)</a> åŸå›¾æˆ³ç€ï¼ï¼ï¼</li>
<li><a href="https://www.cnblogs.com/xrq730/p/5186728.html" target="_blank" rel="noopener">å¯¹ä¸€è‡´æ€§Hashç®—æ³•ï¼ŒJavaä»£ç å®ç°çš„æ·±å…¥ç ”ç©¶</a></li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¼•ï¼šåœ¨åˆ†å¸ƒå¼é›†ç¾¤ä¸­ï¼Œå¯¹æœºå™¨çš„æ·»åŠ åˆ é™¤ï¼Œæˆ–è€…æœºå™¨æ•…éšœåè‡ªåŠ¨è„±ç¦»é›†ç¾¤è¿™äº›æ“ä½œæ˜¯åˆ†å¸ƒå¼é›†ç¾¤ç®¡ç†æœ€åŸºæœ¬çš„åŠŸèƒ½ã€‚å¦‚æœé‡‡ç”¨å¸¸ç”¨çš„hash(object)%Nç®—æ³•ï¼Œé‚£ä¹ˆåœ¨æœ‰æœºå™¨æ·»åŠ æˆ–è€…åˆ é™¤åï¼Œå¾ˆå¤šåŸæœ‰çš„æ•°æ®å°±æ— æ³•æ‰¾åˆ°äº†ï¼Œè¿™æ—¶å€™ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•å°±ç«™å‡ºæ¥äº†ï¼
    
    </summary>
    
      <category term="åˆ†å¸ƒå¼" scheme="http://bestlixiang.site/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
    
      <category term="consistent hashing algorithm" scheme="http://bestlixiang.site/tags/consistent-hashing-algorithm/"/>
    
  </entry>
  
  <entry>
    <title>Raftç®—æ³•</title>
    <link href="http://bestlixiang.site/2018/12/26/%E5%88%86%E5%B8%83%E5%BC%8F/Raft%E7%AE%97%E6%B3%95/"/>
    <id>http://bestlixiang.site/2018/12/26/åˆ†å¸ƒå¼/Raftç®—æ³•/</id>
    <published>2018-12-26T13:14:13.000Z</published>
    <updated>2018-12-26T11:31:52.151Z</updated>
    
    <content type="html"><![CDATA[<p>å¼•ï¼šå å‘ï¼ï¼ï¼ï¼ ä¸åŒäºPaxosç®—æ³•ç›´æ¥ä»åˆ†å¸ƒå¼ä¸€è‡´æ€§é—®é¢˜å‡ºå‘æ¨å¯¼å‡ºæ¥ï¼ŒRaftç®—æ³•åˆ™æ˜¯ä»å¤šå‰¯æœ¬çŠ¶æ€æœºçš„è§’åº¦æå‡ºï¼Œç”¨äºç®¡ç†å¤šå‰¯æœ¬çŠ¶æ€æœºçš„æ—¥å¿—å¤åˆ¶ã€‚è‡ªå·±ç›®å‰ä¹Ÿç†è§£å¾—è¿˜ä¸é€å½»ï¼Œæ‰€ä»¥ç•™ä¸‹é“¾æ¥ï¼Œå¾…åç»­åŠ æ·±ç†è§£ä¹‹åå†åšæ•´ç†ã€‚<a id="more"></a></p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol>
<li><a href="http://thesecretlivesofdata.com/raft/" target="_blank" rel="noopener">Raft: Understandable Distributed Consensus</a></li>
<li><a href="https://www.jianshu.com/p/096ae57d1fe0" target="_blank" rel="noopener">Raftä¸€è‡´æ€§ç®—æ³•ç¬”è®°</a></li>
<li><a href="https://www.jianshu.com/p/1f5cb602dc71" target="_blank" rel="noopener">åˆ†å¸ƒå¼ç³»ç»Ÿå­¦ä¹ 2-Raftç®—æ³•åˆ†æä¸å®ç°</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/32052223" target="_blank" rel="noopener">Raftç®—æ³•è¯¦è§£</a> [å¯ä»¥ç»§ç»­çœ‹ä»–çš„ç›¸å…³åšå®¢]</li>
<li><a href="https://github.com/wenweihu86/raft-java" target="_blank" rel="noopener">raft-java</a></li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¼•ï¼šå å‘ï¼ï¼ï¼ï¼ ä¸åŒäºPaxosç®—æ³•ç›´æ¥ä»åˆ†å¸ƒå¼ä¸€è‡´æ€§é—®é¢˜å‡ºå‘æ¨å¯¼å‡ºæ¥ï¼ŒRaftç®—æ³•åˆ™æ˜¯ä»å¤šå‰¯æœ¬çŠ¶æ€æœºçš„è§’åº¦æå‡ºï¼Œç”¨äºç®¡ç†å¤šå‰¯æœ¬çŠ¶æ€æœºçš„æ—¥å¿—å¤åˆ¶ã€‚è‡ªå·±ç›®å‰ä¹Ÿç†è§£å¾—è¿˜ä¸é€å½»ï¼Œæ‰€ä»¥ç•™ä¸‹é“¾æ¥ï¼Œå¾…åç»­åŠ æ·±ç†è§£ä¹‹åå†åšæ•´ç†ã€‚
    
    </summary>
    
      <category term="åˆ†å¸ƒå¼" scheme="http://bestlixiang.site/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
    
      <category term="Raft" scheme="http://bestlixiang.site/tags/Raft/"/>
    
  </entry>
  
  <entry>
    <title>Paxosç®—æ³•</title>
    <link href="http://bestlixiang.site/2018/12/26/%E5%88%86%E5%B8%83%E5%BC%8F/Paxos%E7%AE%97%E6%B3%95/"/>
    <id>http://bestlixiang.site/2018/12/26/åˆ†å¸ƒå¼/Paxosç®—æ³•/</id>
    <published>2018-12-26T10:14:13.000Z</published>
    <updated>2018-12-26T10:17:51.929Z</updated>
    
    <content type="html"><![CDATA[<p>å¼•ï¼šå å‘ï¼ï¼ï¼ï¼ Paxosç®—æ³•åœ¨åˆ†å¸ƒå¼é¢†åŸŸå…·æœ‰éå¸¸é‡è¦çš„åœ°ä½ã€‚Google Chubbyçš„ä½œè€…Mike Burrowsè¯´è¿‡è¿™ä¸ªä¸–ç•Œä¸Šåªæœ‰ä¸€ç§ä¸€è‡´æ€§ç®—æ³•ï¼Œé‚£å°±æ˜¯Paxosï¼Œå…¶å®ƒçš„ç®—æ³•éƒ½æ˜¯æ®‹æ¬¡å“ã€‚è‡ªå·±ç†è§£å¾—è¿˜ä¸é€å½»ï¼Œæ‰€ä»¥ç•™ä¸‹é“¾æ¥ï¼Œå¾…åç»­åŠ æ·±ç†è§£ä¹‹åå†åšæ•´ç†ã€‚<a id="more"></a></p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol>
<li>å€ªè¶…. ä» Paxos åˆ° ZooKeeper : åˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µ [M]. ç”µå­å·¥ä¸šå‡ºç‰ˆç¤¾, 2015.</li>
<li><a href="https://angus.nyc/2012/paxos-by-example/" target="_blank" rel="noopener">Paxos By Example</a></li>
<li><a href="https://www.cnblogs.com/linbingdong/p/6253479.html" target="_blank" rel="noopener">åˆ†å¸ƒå¼ç³»åˆ—æ–‡ç« â€”â€”Paxosç®—æ³•åŸç†ä¸æ¨å¯¼</a></li>
<li><a href="https://github.com/luohaha/MyPaxos" target="_blank" rel="noopener">MyPaxos</a></li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¼•ï¼šå å‘ï¼ï¼ï¼ï¼ Paxosç®—æ³•åœ¨åˆ†å¸ƒå¼é¢†åŸŸå…·æœ‰éå¸¸é‡è¦çš„åœ°ä½ã€‚Google Chubbyçš„ä½œè€…Mike Burrowsè¯´è¿‡è¿™ä¸ªä¸–ç•Œä¸Šåªæœ‰ä¸€ç§ä¸€è‡´æ€§ç®—æ³•ï¼Œé‚£å°±æ˜¯Paxosï¼Œå…¶å®ƒçš„ç®—æ³•éƒ½æ˜¯æ®‹æ¬¡å“ã€‚è‡ªå·±ç†è§£å¾—è¿˜ä¸é€å½»ï¼Œæ‰€ä»¥ç•™ä¸‹é“¾æ¥ï¼Œå¾…åç»­åŠ æ·±ç†è§£ä¹‹åå†åšæ•´ç†ã€‚
    
    </summary>
    
      <category term="åˆ†å¸ƒå¼" scheme="http://bestlixiang.site/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
    
      <category term="Paxos" scheme="http://bestlixiang.site/tags/Paxos/"/>
    
  </entry>
  
  <entry>
    <title>åˆ†å¸ƒå¼ç³»ç»ŸåŸºç¡€</title>
    <link href="http://bestlixiang.site/2018/12/26/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E5%9F%BA%E7%A1%80/"/>
    <id>http://bestlixiang.site/2018/12/26/åˆ†å¸ƒå¼/åˆ†å¸ƒå¼ç³»ç»ŸåŸºç¡€/</id>
    <published>2018-12-26T02:25:37.000Z</published>
    <updated>2018-12-26T06:08:14.367Z</updated>
    
    <content type="html"><![CDATA[<p>å¼•ï¼šè‡ªå·±è¿™ä¸€æ®µæ—¶é—´éƒ½åœ¨å­¦ä¹ åˆ†å¸ƒå¼ç³»ç»Ÿç›¸å…³çš„ä¸œè¥¿ï¼Œä½†æ˜¯éƒ½ä¸æˆç³»ç»Ÿï¼Œæ‰€ä»¥è¿™é‡Œå°†ä¼šæ€»ç»“ç›®å‰å­¦ä¹ çš„åˆ†å¸ƒå¼ç³»ç»Ÿç›¸å…³å†…å®¹ï¼Œè¿™é‡Œè®²ä¼šæ€»ç»“åˆ†å¸ƒå¼ç³»ç»Ÿçš„ç›¸å…³æ¦‚å¿µï¼ŒæŒç»­æ›´æ–°â€¦ã€‚<a id="more"></a></p>
<h1 id="CAPç†è®º"><a href="#CAPç†è®º" class="headerlink" title="CAPç†è®º"></a>CAPç†è®º</h1><p>2000å¹´7æœˆï¼ŒåŠ å·å¤§å­¦ä¼¯å…‹åˆ©åˆ†æ ¡çš„Eric Breweræ•™æˆåœ¨ACM PODCä¼šè®®ä¸Šæå‡ºCAPçŒœæƒ³ã€‚2å¹´åï¼Œéº»çœç†å·¥å­¦é™¢çš„Seth Gilbertå’ŒNancy Lynchä»ç†è®ºä¸Šè¯æ˜äº†CAPã€‚ä¹‹åï¼ŒCAPç†è®ºæ­£å¼æˆä¸ºåˆ†å¸ƒå¼è®¡ç®—é¢†åŸŸçš„å…¬è®¤å®šç†ã€‚</p>
<p>CAPç†è®ºä¸ºï¼šä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿæœ€å¤šåªèƒ½åŒæ—¶æ»¡è¶³ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ã€å¯ç”¨æ€§ï¼ˆAvailabilityï¼‰å’Œåˆ†åŒºå®¹é”™æ€§ï¼ˆPartition toleranceï¼‰è¿™ä¸‰é¡¹ä¸­çš„ä¸¤é¡¹ã€‚</p>
<p>ä¸‹é¢ä¸¾ä¸ªä¾‹å­ï¼š</p>
<p>å‡è®¾æœ‰ä¸¤å°æœºå™¨Aã€Bï¼Œä¸¤è€…ä¹‹é—´äº’ç›¸åŒæ­¥ä¿æŒæ•°æ®çš„ä¸€è‡´æ€§ã€‚ç°åœ¨Bç”±äºç½‘ç»œåŸå› ä¸èƒ½ä¸Aé€šä¿¡(Network Partition)ï¼Œå‡è®¾æŸä¸ªclientå‘Aå†™å…¥æ•°æ®ï¼Œç°åœ¨æœ‰ä¸¤ç§é€‰æ‹©ï¼š</p>
<ul>
<li>Aæ‹’ç»å†™å…¥ï¼Œè¿™æ ·èƒ½ä¿è¯ä¸Bçš„ä¸€è‡´æ€§ï¼Œä½†æ˜¯ç‰ºç‰²äº†å¯ç”¨æ€§</li>
<li>Aå…è®¸å†™å…¥ï¼Œä½†æ˜¯è¿™æ ·å°±ä¸èƒ½ä¿è¯ä¸Bçš„ä¸€è‡´æ€§äº†</li>
</ul>
<p>Network Partitionæ˜¯å¿…ç„¶çš„ï¼Œç½‘ç»œéå¸¸å¯èƒ½å‡ºç°é—®é¢˜ï¼ˆæ–­çº¿ã€è¶…æ—¶ï¼‰ï¼Œå› æ­¤CAPç†è®ºä¸€èˆ¬åªèƒ½APæˆ–CPï¼Œè€ŒCAä¸€èˆ¬è¾ƒéš¾å®ç°ã€‚</p>
<ul>
<li>CP: è¦å®ç°ä¸€è‡´æ€§ï¼Œåˆ™éœ€è¦ä¸€å®šçš„ä¸€è‡´æ€§ç®—æ³•ï¼Œä¸€èˆ¬æ˜¯åŸºäºå¤šæ•°æ´¾è¡¨å†³çš„ï¼Œå¦‚Paxoså’ŒRaft</li>
<li>AP: è¦å®ç°å¯ç”¨æ€§ï¼Œåˆ™è¦æœ‰ä¸€å®šçš„ç­–ç•¥å†³è®®åˆ°åº•ç”¨å“ªä¸ªæ•°æ®ï¼Œå¹¶ä¸”æ•°æ®ä¸€èˆ¬è¦è¿›è¡Œå†—ä½™å¤‡ä»½(replication)</li>
</ul>
<p>å½“ç„¶ï¼Œåœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼ŒAå¯ä»¥å…ˆå…è®¸å†™å…¥ï¼Œç­‰Bçš„ç½‘ç»œæ¢å¤ä»¥åå†åŒæ­¥è‡³Bï¼ˆæ ¹æ®CAPåŸç†è¿™æ ·ä¸èƒ½ä¿è¯å¼ºä¸€è‡´æ€§äº†ï¼Œä½†æ˜¯å¯ä»¥è€ƒè™‘å®ç°<strong>æœ€ç»ˆä¸€è‡´æ€§</strong>ï¼‰ã€‚</p>
<p>ä¸‹å›¾åˆšå¥½å±•ç¤ºäº†CA,CP,APç³»ç»Ÿæ˜¯å¦‚ä½•å®ç°çš„ï¼š</p>
<p><img src="http://book.mixu.net/distsys/images/CAP.png" alt="CAP"></p>
<ul>
<li>åˆ©ç”¨2PCåè®®å±äºCAï¼Œå¦‚ï¼Œmysqlç­‰ï¼Œä»–ä»¬ä¸»è¦é€šè¿‡å¤åˆ¶çš„æ–¹å¼æ¥ä¿è¯æ•°æ®çš„å®‰å…¨æ€§ã€‚</li>
<li>åˆ©ç”¨Gossipåè®®å±äºAPï¼Œå¦‚ï¼Œredis-clusterã€cassandraï¼ŒEurekaä»–ä»¬æ˜¯é€šè¿‡å®ç°â€œæœ€ç»ˆä¸€è‡´æ€§â€æ¥ä¿è¯APã€‚</li>
<li>åˆ©ç”¨Paxosåè®®å±äºCPï¼Œå¦‚redisï¼ˆå¤šmasterï¼‰ï¼Œhbaseï¼Œè¿™äº›æ•°æ®åº“é›†ç¾¤ï¼ŒèŠ‚ç‚¹æœ‰å¯èƒ½ä¼šå› ä¸ºæ— æ³•ç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§è€Œæ‹’ç»æä¾›æœåŠ¡ã€‚</li>
</ul>
<h1 id="BASEç†è®º"><a href="#BASEç†è®º" class="headerlink" title="BASEç†è®º"></a>BASEç†è®º</h1><p>BASEç†è®ºæ˜¯ç”±eBayçš„æ¶æ„å¸ˆDan Pritchettæºäºå¯¹å¤§è§„æ¨¡åˆ†å¸ƒå¼ç³»ç»Ÿçš„å®è·µæ€»ç»“ï¼Œåœ¨ACMä¸Šå‘è¡¨æ–‡ç« æå‡ºBASEç†è®ºï¼ŒBASEç†è®ºæ˜¯å¯¹CAPç†è®ºçš„å»¶ä¼¸ï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯å³ä½¿æ— æ³•åšåˆ°å¼ºä¸€è‡´æ€§ï¼ˆStrong Consistencyï¼ŒCAPçš„ä¸€è‡´æ€§å°±æ˜¯å¼ºä¸€è‡´æ€§ï¼‰ï¼Œä½†åº”ç”¨å¯ä»¥é‡‡ç”¨é€‚åˆçš„æ–¹å¼è¾¾åˆ°æœ€ç»ˆä¸€è‡´æ€§ï¼ˆEventual Consitencyï¼‰ã€‚</p>
<p>BASEç†è®ºä¸ºï¼šåŸºæœ¬å¯ç”¨ï¼ˆBasically Availableï¼‰ã€è½¯çŠ¶æ€ï¼ˆ Soft Stateï¼‰ã€æœ€ç»ˆä¸€è‡´æ€§ï¼ˆ Eventual Consistencyï¼‰ã€‚</p>
<h2 id="åŸºæœ¬å¯ç”¨"><a href="#åŸºæœ¬å¯ç”¨" class="headerlink" title="åŸºæœ¬å¯ç”¨"></a>åŸºæœ¬å¯ç”¨</h2><p>åŸºæœ¬å¯ç”¨æ˜¯æŒ‡åˆ†å¸ƒå¼ç³»ç»Ÿåœ¨å‡ºç°æ•…éšœçš„æ—¶å€™ï¼Œå…è®¸æŸå¤±éƒ¨åˆ†å¯ç”¨æ€§ï¼Œå³ä¿è¯æ ¸å¿ƒå¯ç”¨ã€‚</p>
<p>ç”µå•†å¤§ä¿ƒæ—¶ï¼Œä¸ºäº†åº”å¯¹è®¿é—®é‡æ¿€å¢ï¼Œéƒ¨åˆ†ç”¨æˆ·å¯èƒ½ä¼šè¢«å¼•å¯¼åˆ°é™çº§é¡µé¢ï¼ŒæœåŠ¡å±‚ä¹Ÿå¯èƒ½åªæä¾›é™çº§æœåŠ¡ã€‚è¿™å°±æ˜¯æŸå¤±éƒ¨åˆ†å¯ç”¨æ€§çš„ä½“ç°ã€‚</p>
<h2 id="è½¯çŠ¶æ€"><a href="#è½¯çŠ¶æ€" class="headerlink" title="è½¯çŠ¶æ€"></a>è½¯çŠ¶æ€</h2><p>è½¯çŠ¶æ€æ˜¯æŒ‡å…è®¸ç³»ç»Ÿå­˜åœ¨ä¸­é—´çŠ¶æ€ï¼Œè€Œè¯¥ä¸­é—´çŠ¶æ€ä¸ä¼šå½±å“ç³»ç»Ÿæ•´ä½“å¯ç”¨æ€§ã€‚</p>
<p>åˆ†å¸ƒå¼å­˜å‚¨ä¸­ä¸€èˆ¬ä¸€ä»½æ•°æ®è‡³å°‘ä¼šæœ‰ä¸‰ä¸ªå‰¯æœ¬ï¼Œå…è®¸ä¸åŒèŠ‚ç‚¹é—´å‰¯æœ¬åŒæ­¥çš„å»¶æ—¶å°±æ˜¯è½¯çŠ¶æ€çš„ä½“ç°ã€‚mysql replicationçš„å¼‚æ­¥å¤åˆ¶ä¹Ÿæ˜¯ä¸€ç§ä½“ç°ã€‚</p>
<h2 id="æœ€ç»ˆä¸€è‡´æ€§"><a href="#æœ€ç»ˆä¸€è‡´æ€§" class="headerlink" title="æœ€ç»ˆä¸€è‡´æ€§"></a>æœ€ç»ˆä¸€è‡´æ€§</h2><p>æœ€ç»ˆä¸€è‡´æ€§æ˜¯æŒ‡ç³»ç»Ÿä¸­çš„æ‰€æœ‰æ•°æ®å‰¯æœ¬ç»è¿‡ä¸€å®šæ—¶é—´åï¼Œæœ€ç»ˆèƒ½å¤Ÿè¾¾åˆ°ä¸€è‡´çš„çŠ¶æ€ã€‚å¼±ä¸€è‡´æ€§å’Œå¼ºä¸€è‡´æ€§ç›¸åï¼Œæœ€ç»ˆä¸€è‡´æ€§æ˜¯å¼±ä¸€è‡´æ€§çš„ä¸€ç§ç‰¹æ®Šæƒ…å†µã€‚</p>
<h2 id="ACIDå’ŒBASEçš„åŒºåˆ«ä¸è”ç³»"><a href="#ACIDå’ŒBASEçš„åŒºåˆ«ä¸è”ç³»" class="headerlink" title="ACIDå’ŒBASEçš„åŒºåˆ«ä¸è”ç³»"></a>ACIDå’ŒBASEçš„åŒºåˆ«ä¸è”ç³»</h2><p>ACIDæ˜¯ä¼ ç»Ÿæ•°æ®åº“å¸¸ç”¨çš„è®¾è®¡ç†å¿µï¼Œè¿½æ±‚<strong>å¼ºä¸€è‡´æ€§æ¨¡å‹</strong>ã€‚</p>
<p>BASEæ”¯æŒçš„æ˜¯å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œç‰ºç‰²æ‰å¯¹ä¸€è‡´æ€§çš„çº¦æŸï¼ˆä½†å®ç°<strong>æœ€ç»ˆä¸€è‡´æ€§</strong>ï¼‰ï¼Œæ¥æ¢å–ä¸€å®šçš„å¯ç”¨æ€§ã€‚</p>
<p>ACIDå’ŒBASEä»£è¡¨äº†ä¸¤ç§æˆªç„¶ç›¸åçš„è®¾è®¡å“²å­¦ã€‚</p>
<p>åœ¨è‹±æ–‡ä¸­ï¼ŒACIDå’ŒBASEåˆ†åˆ«æ˜¯â€œé…¸â€å’Œâ€œç¢±â€ï¼Œçœ‹ä¼¼å¯¹ç«‹ï¼Œå®åˆ™æ˜¯åˆ†åˆ«å¯¹CAPä¸‰ç‰¹æ€§çš„ä¸åŒå–èˆã€‚åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡çš„åœºæ™¯ä¸­ï¼Œç³»ç»Ÿç»„ä»¶å¯¹ä¸€è‡´æ€§è¦æ±‚æ˜¯ä¸åŒçš„ï¼Œå› æ­¤ACIDå’ŒBASEåˆä¼šç»“åˆä½¿ç”¨ã€‚</p>
<h1 id="FLP-Impossibility"><a href="#FLP-Impossibility" class="headerlink" title="FLP Impossibility"></a>FLP Impossibility</h1><h1 id="Leaseæœºåˆ¶"><a href="#Leaseæœºåˆ¶" class="headerlink" title="Leaseæœºåˆ¶"></a>Leaseæœºåˆ¶</h1><h1 id="Quorumæœºåˆ¶"><a href="#Quorumæœºåˆ¶" class="headerlink" title="Quorumæœºåˆ¶"></a>Quorumæœºåˆ¶</h1><h1 id="Consensusé—®é¢˜"><a href="#Consensusé—®é¢˜" class="headerlink" title="Consensusé—®é¢˜"></a>Consensusé—®é¢˜</h1><h1 id="æ—¶åºé—®é¢˜"><a href="#æ—¶åºé—®é¢˜" class="headerlink" title="æ—¶åºé—®é¢˜"></a>æ—¶åºé—®é¢˜</h1><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol>
<li><a href="https://www.sczyh30.com/posts/Distributed-System/distributed-system-base/#%E6%8B%9C%E5%8D%A0%E5%BA%AD%E5%B0%86%E5%86%9B%E9%97%AE%E9%A2%98" target="_blank" rel="noopener">åˆ†å¸ƒå¼ç³»ç»ŸåŸºç¡€æ€»ç»“</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/35608244" target="_blank" rel="noopener">åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„FLPä¸å¯èƒ½åŸç†ã€CAPç†è®ºä¸BASEç†è®º</a></li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¼•ï¼šè‡ªå·±è¿™ä¸€æ®µæ—¶é—´éƒ½åœ¨å­¦ä¹ åˆ†å¸ƒå¼ç³»ç»Ÿç›¸å…³çš„ä¸œè¥¿ï¼Œä½†æ˜¯éƒ½ä¸æˆç³»ç»Ÿï¼Œæ‰€ä»¥è¿™é‡Œå°†ä¼šæ€»ç»“ç›®å‰å­¦ä¹ çš„åˆ†å¸ƒå¼ç³»ç»Ÿç›¸å…³å†…å®¹ï¼Œè¿™é‡Œè®²ä¼šæ€»ç»“åˆ†å¸ƒå¼ç³»ç»Ÿçš„ç›¸å…³æ¦‚å¿µï¼ŒæŒç»­æ›´æ–°â€¦ã€‚
    
    </summary>
    
      <category term="åˆ†å¸ƒå¼" scheme="http://bestlixiang.site/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
    
      <category term="åˆ†å¸ƒå¼" scheme="http://bestlixiang.site/tags/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>Macç‰ˆç™¾åº¦ç½‘ç›˜é£é€Ÿä¸‹è½½</title>
    <link href="http://bestlixiang.site/2018/10/31/%E5%B7%A5%E5%85%B7/Mac%E7%89%88%E7%99%BE%E5%BA%A6%E7%BD%91%E7%9B%98%E9%A3%9E%E9%80%9F%E4%B8%8B%E8%BD%BD/"/>
    <id>http://bestlixiang.site/2018/10/31/å·¥å…·/Macç‰ˆç™¾åº¦ç½‘ç›˜é£é€Ÿä¸‹è½½/</id>
    <published>2018-10-31T00:17:46.000Z</published>
    <updated>2018-10-31T00:21:36.636Z</updated>
    
    <content type="html"><![CDATA[<p>å¼•ï¼šç™¾åº¦ç½‘ç›˜ä¸Šæœ‰å¾ˆå¤šèµ„æºï¼Œä¹‹å‰åœ¨Macä¸Šä¸€ç›´æ²¡æœ‰æ‰¾åˆ°å¥½çš„åŠ é€Ÿæ–¹æ³•æˆ–è€…ç ´è§£è½¯ä»¶ï¼Œè¿™æ¬¡ç»ˆäºæ‰¾åˆ°äº†ï¼Œè¯·é€Ÿé€Ÿæˆ³è¿›æ¥ï¼ï¼<a id="more"></a></p>
<h1 id="é¡¹ç›®åœ°å€"><a href="#é¡¹ç›®åœ°å€" class="headerlink" title="é¡¹ç›®åœ°å€"></a>é¡¹ç›®åœ°å€</h1><p><a href="https://github.com/proxyee-down-org/proxyee-down" target="_blank" rel="noopener">Proxyee Down</a></p>
<p>Proxyee Down æ˜¯ä¸€æ¬¾å¼€æºçš„å…è´¹ HTTP é«˜é€Ÿä¸‹è½½å™¨ï¼Œåº•å±‚ä½¿ç”¨<code>netty</code>å¼€å‘ï¼Œæ”¯æŒè‡ªå®šä¹‰ HTTP è¯·æ±‚ä¸‹è½½ä¸”æ”¯æŒæ‰©å±•åŠŸèƒ½ï¼Œå¯ä»¥é€šè¿‡å®‰è£…æ‰©å±•å®ç°ç‰¹æ®Šçš„ä¸‹è½½éœ€æ±‚ã€‚</p>
<h1 id="æœ€è¿‘è§†é¢‘æ•™ç¨‹"><a href="#æœ€è¿‘è§†é¢‘æ•™ç¨‹" class="headerlink" title="æœ€è¿‘è§†é¢‘æ•™ç¨‹"></a>æœ€è¿‘è§†é¢‘æ•™ç¨‹</h1><p>ä»¥åä¹Ÿå¯èƒ½å°±ä¸æ–°äº†ï¼ï¼</p>
<p><a href="https://www.youtube.com/watch?v=ecZqKGaKIck" target="_blank" rel="noopener">å¿«å¿«ä¿å­˜ï¼Œ2018æœ€æ–°ç™¾åº¦äº‘ä¸é™åˆ¶æ–¹æ³•proxyee down-2018.9.19ï¼Œäº²æµ‹é€Ÿåº¦è¾¾10M</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¼•ï¼šç™¾åº¦ç½‘ç›˜ä¸Šæœ‰å¾ˆå¤šèµ„æºï¼Œä¹‹å‰åœ¨Macä¸Šä¸€ç›´æ²¡æœ‰æ‰¾åˆ°å¥½çš„åŠ é€Ÿæ–¹æ³•æˆ–è€…ç ´è§£è½¯ä»¶ï¼Œè¿™æ¬¡ç»ˆäºæ‰¾åˆ°äº†ï¼Œè¯·é€Ÿé€Ÿæˆ³è¿›æ¥ï¼ï¼
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>JDKæºç åˆ†æâ€”â€”ReentrantReadWriteLock</title>
    <link href="http://bestlixiang.site/2018/09/13/JDK%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/JDK%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E2%80%94%E2%80%94ReentrantReadWriteLock/"/>
    <id>http://bestlixiang.site/2018/09/13/JDKæºç åˆ†æ/JDKæºç åˆ†æâ€”â€”ReentrantReadWriteLock/</id>
    <published>2018-09-13T06:51:39.000Z</published>
    <updated>2018-09-13T10:15:06.003Z</updated>
    
    <content type="html"><![CDATA[<p>å¼•ï¼šè¯»å†™åˆ†ç¦»æ˜¯è§£å†³å¹¶å‘ç“¶é¢ˆçš„å¸¸ç”¨ç­–ç•¥ï¼Œåœ¨Javaä¸­ä¹Ÿæœ‰å…¶å®ç°â€”â€”ReentrantReadWriteLockï¼Œå®ƒèƒ½å¤Ÿæœ‰æ•ˆçš„æé«˜è¯»æ¯”å†™å¤šçš„åœºæ™¯ä¸‹çš„ç¨‹åºæ€§èƒ½ã€‚<a id="more"></a></p>
<h1 id="æ¦‚è§ˆ"><a href="#æ¦‚è§ˆ" class="headerlink" title="æ¦‚è§ˆ"></a>æ¦‚è§ˆ</h1><p>ReentrantReadWriteLockæ˜¯é€šè¿‡ä¸¤æŠŠé”å®ç°è¯»å†™åˆ†ç¦»çš„ï¼Œåˆ†åˆ«æ˜¯è¯»é”å’Œå†™é”ã€‚å®ƒçš„æºç å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReentrantReadWriteLock</span> <span class="keyword">implements</span> <span class="title">ReadWriteLock</span>, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯»é”</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReentrantReadWriteLock.ReadLock readerLock;</span><br><span class="line">    <span class="comment">// å†™é”</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReentrantReadWriteLock.WriteLock writerLock;</span><br><span class="line">    <span class="comment">// åŒæ­¥å™¨</span></span><br><span class="line">    <span class="keyword">final</span> Sync sync;</span><br></pre></td></tr></table></figure></p>
<h1 id="å†™é”"><a href="#å†™é”" class="headerlink" title="å†™é”"></a>å†™é”</h1><p>å†™é”ä¸»è¦æ˜¯é€šè¿‡é‡å†™åŒæ­¥å™¨çš„tryAcquireå’ŒtryReleaseå®ç°ï¼Œå…¶ä»–é€»è¾‘éƒ½å¯ä»¥å‚è€ƒAQSçš„è§£æã€‚</p>
<h2 id="tryAcquire"><a href="#tryAcquire" class="headerlink" title="tryAcquire"></a>tryAcquire</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Sync</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SHARED_SHIFT   = <span class="number">16</span>;</span><br><span class="line"><span class="comment">// é‡å…¥æœ€å¤§æ¬¡æ•°</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_COUNT      = (<span class="number">1</span> &lt;&lt; SHARED_SHIFT) - <span class="number">1</span>;</span><br><span class="line"><span class="comment">// ç‹¬å é”ï¼ˆå†™é”ï¼‰æ©ç </span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> EXCLUSIVE_MASK = (<span class="number">1</span> &lt;&lt; SHARED_SHIFT) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> acquires)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    Thread current = Thread.currentThread();</span><br><span class="line">    <span class="keyword">int</span> c = getState();</span><br><span class="line">    <span class="comment">// ç”¨ state &amp; 65535 å¾—åˆ°ä½ 16 ä½çš„å€¼</span></span><br><span class="line">    <span class="keyword">int</span> w = exclusiveCount(c);</span><br><span class="line">    <span class="keyword">if</span> (c != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// (Note: if c != 0 and w == 0 then shared count != 0)</span></span><br><span class="line">        <span class="comment">// å¦‚æœ state ä¸æ˜¯0ï¼Œä¸”ä½16ä½æ˜¯0ï¼Œè¯´æ˜å†™é”æ˜¯ç©ºé—²çš„ï¼Œè¯»é”è¢«éœ¸å äº†ã€‚é‚£ä¹ˆä¹Ÿä¸èƒ½æ‹¿é”ï¼Œè¿”å› fasleã€‚ä¿è¯äº†è¯»çš„æ—¶å€™ä¸èƒ½å†™ã€‚</span></span><br><span class="line">        <span class="comment">// å¦‚æœä½ 16 ä½ä¸æ˜¯0ï¼Œè¯´æ˜å†™é”è¢«éœ¸å äº†ï¼Œæ­¤æ—¶å¦‚æœæŒæœ‰é”çš„ä¸æ˜¯å½“å‰çº¿ç¨‹ï¼Œé‚£ä¹ˆè¿™æ¬¡æ‹¿é”æ˜¯å¤±è´¥çš„ã€‚è¿”å› fasleã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (w == <span class="number">0</span> || current != getExclusiveOwnerThread())</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">// è¿™é‡Œæ—¶å€™åº”è¯¥æ˜¯å†™é‡å…¥é”ï¼Œå¦‚æœå†™é‡å…¥æ¬¡æ•°è¶…è¿‡æœ€å¤§å€¼ 65535ï¼Œå°±ä¼šæº¢å‡º</span></span><br><span class="line">        <span class="keyword">if</span> (w + exclusiveCount(acquires) &gt; MAX_COUNT)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Maximum lock count exceeded"</span>);</span><br><span class="line">        <span class="comment">// Reentrant acquire</span></span><br><span class="line">        setState(c + acquires);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// writerShouldBlock åˆ¤æ–­æ˜¯å¦åº”è¯¥é˜»å¡</span></span><br><span class="line">    <span class="comment">// 1. å…¬å¹³é”æƒ…å†µä¸‹ï¼Œå¦‚æœé˜Ÿåˆ—ä¸­æœ‰ç­‰å¾…é”çš„çº¿ç¨‹ï¼Œåˆ™è¿”å›tureï¼Œåº”è¯¥é˜»å¡</span></span><br><span class="line">    <span class="comment">// 2. éå…¬å¹³é”æƒ…å†µä¸‹ï¼Œè¿”å›falseï¼Œä¸åº”è¯¥é˜»å¡ï¼Œç›´æ¥å‚ä¸ç«äº‰</span></span><br><span class="line">    <span class="keyword">if</span> (writerShouldBlock() ||</span><br><span class="line">        !compareAndSetState(c, c + acquires))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">// ç«äº‰åˆ°é”ï¼Œè®¾ç½®ç‹¬å çº¿ç¨‹</span></span><br><span class="line">    setExclusiveOwnerThread(current);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="tryRelease"><a href="#tryRelease" class="headerlink" title="tryRelease"></a>tryRelease</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryRelease</span><span class="params">(<span class="keyword">int</span> releases)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ˜¯å¦æŒæœ‰é”</span></span><br><span class="line">    <span class="keyword">if</span> (!isHeldExclusively())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalMonitorStateException();</span><br><span class="line">    <span class="comment">// è®¾ç½®stateçŠ¶æ€</span></span><br><span class="line">    <span class="keyword">int</span> nextc = getState() - releases;</span><br><span class="line">    <span class="comment">// è®¡ç®—å†™é”çš„çŠ¶æ€ï¼ˆä½16ä½ï¼‰ï¼Œå¦‚æœæ˜¯0ï¼Œè¯´æ˜æ˜¯å¦æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">boolean</span> free = exclusiveCount(nextc) == <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (free)</span><br><span class="line">        setExclusiveOwnerThread(<span class="keyword">null</span>);</span><br><span class="line">    setState(nextc);</span><br><span class="line">    <span class="keyword">return</span> free;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="è¯»é”"><a href="#è¯»é”" class="headerlink" title="è¯»é”"></a>è¯»é”</h1><p>å†™é”ä¸»è¦æ˜¯é€šè¿‡é‡å†™åŒæ­¥å™¨çš„tryAcquireSharedå’ŒtryReleaseSharedå®ç°ï¼Œå…¶ä»–é€»è¾‘éƒ½å¯ä»¥å‚è€ƒAQSçš„è§£æã€‚</p>
<h2 id="tryAcquireShared"><a href="#tryAcquireShared" class="headerlink" title="tryAcquireShared"></a>tryAcquireShared</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Sync</span></span><br><span class="line"><span class="comment">// å…±äº«ï¼ˆè¯»é”ï¼‰é‡å…¥æ¬¡æ•°åŸºæ•°</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SHARED_UNIT    = (<span class="number">1</span> &lt;&lt; SHARED_SHIFT);</span><br><span class="line"><span class="comment">// ç¬¬ä¸€ä¸ªè·å¾—è¯»é”çš„çº¿ç¨‹</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> Thread firstReader = <span class="keyword">null</span>;</span><br><span class="line"><span class="comment">// ç¬¬ä¸€ä¸ªè·å¾—è¯»é”çš„çº¿ç¨‹çš„é‡å…¥æ¬¡æ•°è®¡æ•°å™¨</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">int</span> firstReaderHoldCount;</span><br><span class="line"><span class="comment">// æœ€åä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹çš„è®¡æ•°å™¨ï¼Œå­˜æ”¾åœ¨ThreadLocalä¸­</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> HoldCounter cachedHoldCounter;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">tryAcquireShared</span><span class="params">(<span class="keyword">int</span> unused)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    Thread current = Thread.currentThread();</span><br><span class="line">    <span class="keyword">int</span> c = getState();</span><br><span class="line">    <span class="comment">// ç”¨ state &amp; 65535 å¾—åˆ°ä½ 16 ä½çš„å€¼ ä¸ç­‰äº0ï¼Œå†™é”è¢«éœ¸å äº†</span></span><br><span class="line">    <span class="comment">// ä¸”</span></span><br><span class="line">    <span class="comment">// æŒæœ‰é”çš„ä¸æ˜¯å½“å‰çº¿ç¨‹</span></span><br><span class="line">    <span class="comment">// ä¿è¯äº†å†™çš„æ—¶å€™ä¸èƒ½è¯»</span></span><br><span class="line">    <span class="keyword">if</span> (exclusiveCount(c) != <span class="number">0</span> &amp;&amp;</span><br><span class="line">        getExclusiveOwnerThread() != current)</span><br><span class="line">        <span class="comment">// è·å–é”å¤±è´¥</span></span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// å¦‚æœå†™é”æ²¡æœ‰è¢«éœ¸å ï¼Œåˆ™å°†é«˜16ä½ç§»åˆ°ä½16ä½</span></span><br><span class="line">    <span class="keyword">int</span> r = sharedCount(c);</span><br><span class="line">    <span class="comment">// readerShouldBlockåˆ¤æ–­æ˜¯å¦åº”è¯¥é˜»å¡ å’Œå†™é”é€»è¾‘ä¸€è‡´</span></span><br><span class="line">    <span class="comment">// å†™é”é‡å…¥æ¬¡æ•°ä¸è¶…è¿‡æœ€å¤§å€¼ 65535</span></span><br><span class="line">    <span class="comment">// è®¾ç½®stateæˆåŠŸ (ç›¸å½“äºé«˜16ä½åŠ 1)</span></span><br><span class="line">    <span class="keyword">if</span> (!readerShouldBlock() &amp;&amp;</span><br><span class="line">        r &lt; MAX_COUNT &amp;&amp;</span><br><span class="line">        compareAndSetState(c, c + SHARED_UNIT)) &#123;</span><br><span class="line">        <span class="comment">// è¯»é”ç©ºé—²</span></span><br><span class="line">        <span class="keyword">if</span> (r == <span class="number">0</span>) &#123;</span><br><span class="line">            firstReader = current;</span><br><span class="line">            <span class="comment">// è®¡æ•°å™¨ä¸º1</span></span><br><span class="line">            firstReaderHoldCount = <span class="number">1</span>;</span><br><span class="line">            <span class="comment">// ç¬¬ä¸€ä¸ªè¯»çº¿ç¨‹æ˜¯å½“å‰çº¿ç¨‹</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (firstReader == current) &#123;</span><br><span class="line">            <span class="comment">// è®¡æ•°å™¨åŠ 1</span></span><br><span class="line">            firstReaderHoldCount++;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            HoldCounter rh = cachedHoldCounter;</span><br><span class="line">            <span class="comment">// å¦‚æœæœ€åä¸€ä¸ªçº¿ç¨‹è®¡æ•°å™¨æ˜¯ null æˆ–è€…ä¸æ˜¯å½“å‰çº¿ç¨‹</span></span><br><span class="line">            <span class="keyword">if</span> (rh == <span class="keyword">null</span> || rh.tid != getThreadId(current))</span><br><span class="line">                <span class="comment">// æ–°å»ºä¸€ä¸ª HoldCounter å¯¹è±¡</span></span><br><span class="line">                cachedHoldCounter = rh = readHolds.get();</span><br><span class="line">            <span class="comment">// å¦‚æœä¸æ˜¯ nullï¼Œä¸” count æ˜¯ 0</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (rh.count == <span class="number">0</span>)</span><br><span class="line">                <span class="comment">// å°±å°†ä¸Šä¸ªçº¿ç¨‹çš„ HoldCounter è¦†ç›–æœ¬åœ°çš„ï¼ˆæ€§èƒ½è€ƒè™‘ï¼Œç›¸å½“äºç¼“å­˜ï¼‰</span></span><br><span class="line">                readHolds.set(rh);</span><br><span class="line">            <span class="comment">// è®¡æ•°å™¨åŠ 1</span></span><br><span class="line">            rh.count++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è·å¾—é”æˆåŠŸ</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ­»å¾ªç¯è·å–è¯»é”ï¼Œå’ŒtryReleaseSharedé€»è¾‘ç±»ä¼¼ï¼Œåªæœ‰å¤šäº†æ­»å¾ªç¯</span></span><br><span class="line">    <span class="keyword">return</span> fullTryAcquireShared(current);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="é”é™çº§"><a href="#é”é™çº§" class="headerlink" title="é”é™çº§"></a>é”é™çº§</h2><p>åœ¨tryAcquireSharedè¿˜ä½“ç°äº†é”é™çº§çš„æ¦‚å¿µã€‚æ¦‚å¿µå¦‚ä¸‹ï¼š</p>
<p><strong><br>é‡å…¥è¿˜å…è®¸ä»å†™å…¥é”é™çº§ä¸ºè¯»å–é”ï¼Œå…¶å®ç°æ–¹å¼æ˜¯ï¼šå…ˆè·å–å†™å…¥é”ï¼Œç„¶åè·å–è¯»å–é”ï¼Œæœ€åé‡Šæ”¾å†™å…¥é”ã€‚ä½†æ˜¯ï¼Œä»è¯»å–é”å‡çº§åˆ°å†™å…¥é”æ˜¯ä¸å¯èƒ½çš„ã€‚</strong></p>
<p>ä½“ç°åœ¨ä»£ç ä¸­å¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// tryAcquireShared æˆ–è€… fullTryAcquireSharedä¸­</span></span><br><span class="line"><span class="keyword">if</span> (exclusiveCount(c) != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (getExclusiveOwnerThread() != current)</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br></pre></td></tr></table></figure></p>
<p>ä¸Šé¢çš„ä»£ç å°±ä½“ç°å‡ºï¼šå½“å†™é”è¢«æŒæœ‰çš„æ—¶å€™ï¼Œå¦‚æœå½“å‰æ˜¯çº¿ç¨‹æ˜¯æŒæœ‰å†™é”çš„é‚£ä¸ªçº¿ç¨‹ï¼Œå¯ä»¥ç»§ç»­è·å¾—è¯»é”ã€‚</p>
<p>æ€»å¾—æ¥è¯´å°±æé«˜äº†æ€§èƒ½ã€‚</p>
<h2 id="tryReleaseShared"><a href="#tryReleaseShared" class="headerlink" title="tryReleaseShared"></a>tryReleaseShared</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å½“å‰çº¿ç¨‹é‡å…¥æ¬¡æ•°è®¡æ•°å™¨</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> ThreadLocalHoldCounter readHolds;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">tryReleaseShared</span><span class="params">(<span class="keyword">int</span> unused)</span> </span>&#123;</span><br><span class="line">    Thread current = Thread.currentThread();</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªçº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">if</span> (firstReader == current) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœæ˜¯ 1ï¼Œå°†ç¬¬ä¸€ä¸ªçº¿ç¨‹è®¾ç½®æˆ null</span></span><br><span class="line">        <span class="keyword">if</span> (firstReaderHoldCount == <span class="number">1</span>)</span><br><span class="line">            firstReader = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// å¦‚æœä¸æ˜¯ 1ï¼Œå‡ä¸€æ“ä½œ</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            firstReaderHoldCount--;</span><br><span class="line">    <span class="comment">// å¦‚æœä¸æ˜¯å½“å‰çº¿ç¨‹</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        HoldCounter rh = cachedHoldCounter;</span><br><span class="line">        <span class="comment">// å¦‚æœæœ€åä¸€ä¸ªçº¿ç¨‹è®¡æ•°å™¨æ˜¯ null æˆ–è€…ç¼“å­˜æ‰€å±çº¿ç¨‹ä¸æ˜¯å½“å‰çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">if</span> (rh == <span class="keyword">null</span> || rh.tid != getThreadId(current))</span><br><span class="line">            <span class="comment">// è·å–å½“å‰çº¿ç¨‹çš„è®¡æ•°å™¨</span></span><br><span class="line">            rh = readHolds.get();</span><br><span class="line">        <span class="keyword">int</span> count = rh.count;</span><br><span class="line">        <span class="comment">// å¦‚æœè®¡æ•°å™¨å°äºç­‰äºä¸€ï¼Œå°±ç›´æ¥åˆ é™¤è®¡æ•°å™¨</span></span><br><span class="line">        <span class="keyword">if</span> (count &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">            readHolds.remove();</span><br><span class="line">            <span class="keyword">if</span> (count &lt;= <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">throw</span> unmatchedUnlockException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¯¹è®¡æ•°å™¨å‡ä¸€</span></span><br><span class="line">        --rh.count;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ­»å¾ªç¯ä½¿ç”¨ CAS ä¿®æ”¹çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">int</span> c = getState();</span><br><span class="line">        <span class="keyword">int</span> nextc = c - SHARED_UNIT;</span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(c, nextc))</span><br><span class="line">            <span class="comment">// ä¿®æ”¹æˆåŠŸåï¼Œå¦‚æœæ˜¯ 0ï¼Œè¡¨ç¤ºè¯»é”å’Œå†™é”éƒ½ç©ºé—²ï¼Œåˆ™å¯ä»¥å”¤é†’åé¢çš„ç­‰å¾…çº¿ç¨‹</span></span><br><span class="line">            <span class="keyword">return</span> nextc == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>å…³äºè¯»å†™é”ï¼Œå®ƒå…¶å®å°±æ˜¯ä¸€ä¸ªè¯»é”ä¸€ä¸ªå†™é”ï¼Œè¯»é”æ˜¯å…±äº«çš„ï¼Œå†™é”æ˜¯ç‹¬å çš„ã€‚ç„¶åæˆ‘ä»¬å†ç†è§£é”é™çº§çš„ç›¸å…³æ¦‚å¿µå°±è¡Œäº†ï¼Œå½“ç„¶è¿™ä¸€åˆ‡éƒ½æ˜¯éœ€è¦å»ºç«‹åœ¨è¯»AQSçš„ç†è§£ä¹‹ä¸Šã€‚</p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol>
<li><a href="http://todorex.com/2018/09/11/JDK%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/JDK%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E2%80%94%E2%80%94AbstractQueuedSynchronizer/" target="_blank" rel="noopener">JDKæºç åˆ†æâ€”â€”AbstractQueuedSynchronizer</a></li>
<li><a href="https://www.jianshu.com/p/6221746fc777" target="_blank" rel="noopener">å¹¶å‘ç¼–ç¨‹ä¹‹â€”â€”å†™é”æºç åˆ†æ</a></li>
<li><a href="https://www.jianshu.com/p/cd485e16456e" target="_blank" rel="noopener">å¹¶å‘ç¼–ç¨‹ä¹‹â€”â€”è¯»é”æºç åˆ†æ(è§£é‡Šå…³äºé”é™çº§çš„äº‰è®®)</a></li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¼•ï¼šè¯»å†™åˆ†ç¦»æ˜¯è§£å†³å¹¶å‘ç“¶é¢ˆçš„å¸¸ç”¨ç­–ç•¥ï¼Œåœ¨Javaä¸­ä¹Ÿæœ‰å…¶å®ç°â€”â€”ReentrantReadWriteLockï¼Œå®ƒèƒ½å¤Ÿæœ‰æ•ˆçš„æé«˜è¯»æ¯”å†™å¤šçš„åœºæ™¯ä¸‹çš„ç¨‹åºæ€§èƒ½ã€‚
    
    </summary>
    
      <category term="JDKæºç åˆ†æ" scheme="http://bestlixiang.site/categories/JDK%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
    
      <category term="é”" scheme="http://bestlixiang.site/tags/%E9%94%81/"/>
    
  </entry>
  
</feed>
